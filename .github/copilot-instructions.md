# ThesisAppRework AI Configuration

## Project Context
You are working on **ThesisAppRework**, a comprehensive platform for analyzing AI-generated applications. The system automates the generation, container deployment, and multi-faceted analysis (Security, Performance, Code Quality, AI Review) of web applications generated by various LLMs.

---

## Tech Stack & Architecture

### Backend Core
- **Framework**: Flask (Factory Pattern)
- **Database**: SQLite (Development) with SQLAlchemy ORM
- **Task Queue**: Celery with Redis (Pipeline Orchestration)
- **Containerization**: Docker & Docker Compose (handling dynamic app environments)
- **Analysis**: Microservice architecture communicating via WebSockets
- **Template Engine**: Jinja2 + HTMX for dynamic frontend interactions

### Service Layer Pattern (`src/app/services/`)
- Strict separation of concerns using the **Service Locator** pattern.
- Access services via `ServiceLocator.get_<service_name>()`.
- **Key Services**:
    - `PipelineExecutionService`: Orchestrates the flow from Generation -> Analysis.
    - `TaskExecutionService`: Manages individual analysis tasks.
    - `DockerManager`: Handles lifecycle of generated app containers.
    - `GenerationService`: Interfaces with LLMs to create code.

---

## Development Guidelines

### 1. Code Style & Standards
- **Python Version**: Target Python 3.12+.
- **Type Hinting**: MANDATORY. Use `typing` module (e.g., `list[str]`, `dict[str, Any]`, `Optional[int]`).
- **Docstrings**: Google-style docstrings for all functions and classes.
- **Imports**: Use absolute imports starting from `src` or `app` (e.g., `from app.services.service_locator import ServiceLocator`).
- **Path Handling**: ALWAYS use `app.utils.paths` or `pathlib.Path`. NEVER use os.path.join with hardcoded slashes.

### 2. Error Handling & Logging
- **Exceptions**: Use custom exceptions from `src.app.utils.errors` (e.g., `AppError`, `NotFoundHTTPError`).
- **Logging**: Use the centralized logger.
  ```python
  import logging
  logger = logging.getLogger(__name__)
  logger.info("Functionality executed", extra={'context': 'value'})
  ```

### 3. Testing Paradigm (`pytest`)
- **Strict Markers**: Respect markers to optimize test runs.
    - `unit`: Fast, no I/O.
    - `integration`: database/service interaction.
    - `slow`: Long running processes.
    - `analyzer`: Real docker analysis steps.
- **Fixtures**: Use `conftest.py` fixtures for app context (`app_context`, `db_session`).

### 4. Database Mutations
- ALWAYS commit transactions explicitly in service methods.
- ALWAYS rollback in `except` blocks.
- Use `db.session` from `src.app.extensions`.

---

## Critical Workflows

### The Analysis Pipeline
1.  **Generation**: LLMs generate code -> stored in `generated/{model_slug}/app{N}/`.
2.  **Container Build**: `DockerManager` builds `backend` and `frontend` images.
3.  **Analysis**:
    - `AnalyzerManager` dispatches tasks via WebSocket to `loopback:8765`.
    - Four analyzer types run in parallel: `static`, `dynamic`, `performance`, `ai`.
4.  **Results**: Aggregated JSONs stored in `results/`.

### Docker & Networking
- **Host Mode**: Performance tester runs on host network to bombard apps.
- **Internal Network**: `thesis-apps-network` connects Dynamic Analyzer to generated apps.
- **Port Ranges**:
    - Backend: 5001-5050
    - Frontend: 8001-8050
    - Analyzers: 2001-2004

---

## Operational Commands

- **Start Stack**: `./start.ps1 -Mode Start` (Windows) / `./start.sh` (Linux)
- **Dev Mode**: `./start.ps1 -Mode Dev` (Flask only, no background analyzers)
- **Run Tests**: `pytest -m "not integration"`
- **Lint**: `ruff check src/`

## Contextual Awareness
- **File Edits**: When editing configuration, check `src/app/config/` and `src/app/constants.py`.
- **UI Changes**: HTMX partials are in `src/app/templates/partials/`.
- **Analyzer Protocol**: `analyzer/shared/protocol.py` defines the WebSocket contract. DO NOT BREAK THIS CONTRACT.

---

## Agent Behavior Rules
1.  **Assumptions**: detailed in `docs/ARCHITECTURE.md`. Verify before changing core logic.
2.  **Completeness**: When refactoring, update type hints and tests.
3.  **Safety**: Never commit hardcoded secrets. Use environment variables (`os.getenv`).
4.  **Consistency**: Follow existing patterns in `src/app/services/` when adding new logic.
