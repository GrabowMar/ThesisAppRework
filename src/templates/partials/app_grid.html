<!-- HTMX Partial: Application Grid -->
<div class="app-grid-container" id="app-grid">
    {% if apps %}
    <div class="grid-header">
        <div class="grid-stats">
            <span class="stat-item">
                <strong>{{ apps|length }}</strong> 
                {% if apps|length == 1 %}app{% else %}apps{% endif %}
            </span>
            {% if filters.models %}
            <span class="stat-item">
                <strong>{{ filters.models|length }}</strong> 
                {% if filters.models|length == 1 %}model{% else %}models{% endif %}
            </span>
            {% endif %}
        </div>
        
        <div class="view-controls">
            <div class="view-toggle" role="radiogroup" aria-label="View type">
                <button class="view-btn {{ 'active' if view_type == 'grid' else '' }}" 
                        hx-post="{{ url_for('main.set_view_type', view_type='grid') }}"
                        hx-target="#app-grid"
                        hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked"
                        role="radio" 
                        aria-checked="{{ 'true' if view_type == 'grid' else 'false' }}"
                        title="Grid view">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="1" y="1" width="6" height="6" rx="1"/>
                        <rect x="9" y="1" width="6" height="6" rx="1"/>
                        <rect x="1" y="9" width="6" height="6" rx="1"/>
                        <rect x="9" y="9" width="6" height="6" rx="1"/>
                    </svg>
                </button>
                <button class="view-btn {{ 'active' if view_type == 'list' else '' }}" 
                        hx-post="{{ url_for('main.set_view_type', view_type='list') }}"
                        hx-target="#app-grid"
                        hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked"
                        role="radio" 
                        aria-checked="{{ 'true' if view_type == 'list' else 'false' }}"
                        title="List view">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="1" y="2" width="14" height="2" rx="1"/>
                        <rect x="1" y="7" width="14" height="2" rx="1"/>
                        <rect x="1" y="12" width="14" height="2" rx="1"/>
                    </svg>
                </button>
            </div>
            
            <div class="sort-controls">
                <select name="sort_by" 
                        hx-post="{{ url_for('main.update_sorting') }}"
                        hx-target="#app-grid"
                        hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked"
                        aria-label="Sort by">
                    <option value="model" {{ 'selected' if sort_by == 'model' else '' }}>Model</option>
                    <option value="app_num" {{ 'selected' if sort_by == 'app_num' else '' }}>App Number</option>
                    <option value="status" {{ 'selected' if sort_by == 'status' else '' }}>Status</option>
                    <option value="last_updated" {{ 'selected' if sort_by == 'last_updated' else '' }}>Last Updated</option>
                </select>
                
                <button class="sort-direction-btn" 
                        hx-post="{{ url_for('main.toggle_sort_direction') }}"
                        hx-target="#app-grid"
                        hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked, [name='sort_by']"
                        title="{{ 'Ascending' if sort_direction == 'asc' else 'Descending' }}"
                        aria-label="Toggle sort direction">
                    {% if sort_direction == 'asc' %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 3l4 4H4l4-4z"/>
                        <path d="M8 13l-4-4h8l-4 4z"/>
                    </svg>
                    {% else %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 13l4-4H4l4 4z"/>
                        <path d="M8 3l-4 4h8L8 3z"/>
                    </svg>
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    
    <div class="app-grid {{ 'list-view' if view_type == 'list' else 'grid-view' }}" 
         role="grid" 
         aria-label="Applications">
        {% for app in apps %}
        <div class="app-grid-item" 
             role="gridcell"
             data-model="{{ app.model }}"
             data-app-num="{{ app.app_num }}"
             data-status="{{ app.status }}">
            {% include 'components/app_card.html' with context %}
        </div>
        {% endfor %}
    </div>
    
    {% if pagination and pagination.pages > 1 %}
    <div class="grid-pagination">
        <div class="pagination-info">
            Showing {{ pagination.start_item }}-{{ pagination.end_item }} of {{ pagination.total }} apps
        </div>
        
        <div class="pagination-controls" role="navigation" aria-label="Pagination">
            {% if pagination.has_prev %}
            <button class="page-btn" 
                    hx-post="{{ url_for('main.change_page', page=pagination.prev_num) }}"
                    hx-target="#app-grid"
                    hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked, [name='sort_by'], [name='sort_direction']"
                    aria-label="Previous page">
                ‚Üê Previous
            </button>
            {% endif %}
            
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    {% if page_num != pagination.page %}
                    <button class="page-btn" 
                            hx-post="{{ url_for('main.change_page', page=page_num) }}"
                            hx-target="#app-grid"
                            hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked, [name='sort_by'], [name='sort_direction']"
                            aria-label="Go to page {{ page_num }}">
                        {{ page_num }}
                    </button>
                    {% else %}
                    <span class="page-current" aria-current="page">{{ page_num }}</span>
                    {% endif %}
                {% else %}
                <span class="page-ellipsis">‚Ä¶</span>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <button class="page-btn" 
                    hx-post="{{ url_for('main.change_page', page=pagination.next_num) }}"
                    hx-target="#app-grid"
                    hx-include="[name='models']:checked, [name='status']:checked, [name='app_types']:checked, [name='sort_by'], [name='sort_direction']"
                    aria-label="Next page">
                Next ‚Üí
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="no-apps">
        <div class="no-apps-icon">üì±</div>
        <h3>No applications found</h3>
        <p>Try adjusting your filters or search terms.</p>
        
        {% if filters.models or filters.status or filters.app_types %}
        <button class="btn btn-outline" 
                hx-post="{{ url_for('main.clear_filters') }}"
                hx-target="#dashboard-content">
            Clear All Filters
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.app-grid-container {
    width: 100%;
}

.grid-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing);
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--border-color);
}

.grid-stats {
    display: flex;
    gap: var(--spacing);
    font-size: 0.875rem;
    color: var(--text-muted);
}

.stat-item strong {
    color: var(--text-color);
}

.view-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing);
}

.view-toggle {
    display: flex;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.view-btn {
    padding: var(--spacing-sm);
    border: none;
    background: var(--background-color);
    color: var(--text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-btn:hover {
    background: var(--surface-color);
    color: var(--text-color);
}

.view-btn.active {
    background: var(--accent-color);
    color: white;
}

.view-btn:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: -2px;
    z-index: 1;
}

.sort-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.sort-controls select {
    padding: var(--spacing-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-color);
    font-size: 0.875rem;
}

.sort-direction-btn {
    padding: var(--spacing-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.sort-direction-btn:hover {
    background: var(--surface-color);
}

/* Grid view */
.app-grid.grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing);
    margin-bottom: var(--spacing);
}

/* List view */
.app-grid.list-view {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing);
}

.app-grid.list-view .app-grid-item {
    width: 100%;
}

.app-grid.list-view .app-card {
    display: flex;
    align-items: center;
    padding: var(--spacing);
}

.app-grid.list-view .app-card-header {
    flex: 1;
    margin: 0;
}

.app-grid.list-view .app-card-content {
    display: flex;
    align-items: center;
    gap: var(--spacing);
    margin: 0;
}

.app-grid.list-view .app-card-meta {
    margin: 0;
    flex-shrink: 0;
}

.app-grid.list-view .app-card-actions {
    margin: 0;
    flex-shrink: 0;
}

/* Pagination */
.grid-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing) 0;
    border-top: 1px solid var(--border-color);
    margin-top: var(--spacing);
}

.pagination-info {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.page-btn {
    padding: var(--spacing-sm) var(--spacing);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-color);
    color: var(--text-color);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
}

.page-btn:hover {
    background: var(--surface-color);
}

.page-btn:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 1px;
}

.page-current {
    padding: var(--spacing-sm) var(--spacing);
    background: var(--accent-color);
    color: white;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
}

.page-ellipsis {
    padding: var(--spacing-sm);
    color: var(--text-muted);
}

/* No apps state */
.no-apps {
    text-align: center;
    padding: var(--spacing-xl) var(--spacing);
    color: var(--text-muted);
}

.no-apps-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing);
    opacity: 0.5;
}

.no-apps h3 {
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--text-color);
    font-size: 1.25rem;
}

.no-apps p {
    margin: 0 0 var(--spacing) 0;
    font-size: 0.875rem;
}

/* Loading state */
.app-grid-container[aria-busy="true"] {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.app-grid-container[aria-busy="true"]::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 32px;
    height: 32px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    transform: translate(-50%, -50%);
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .grid-header {
        flex-direction: column;
        gap: var(--spacing);
        align-items: stretch;
    }
    
    .view-controls {
        justify-content: space-between;
    }
    
    .app-grid.grid-view {
        grid-template-columns: 1fr;
    }
    
    .grid-pagination {
        flex-direction: column;
        gap: var(--spacing-sm);
        align-items: center;
    }
    
    .pagination-controls {
        flex-wrap: wrap;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .grid-stats {
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    .sort-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .sort-controls select {
        width: 100%;
    }
}
</style>

<script>
// Grid interaction enhancements
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'app-grid') {
        // Initialize any grid-specific functionality
        ThesisApp.ui.initializeGrid();
    }
});

// Handle grid item interactions
document.addEventListener('click', function(event) {
    const gridItem = event.target.closest('.app-grid-item');
    if (gridItem && !event.target.closest('button') && !event.target.closest('a')) {
        // Click on grid item (but not on buttons/links) - navigate to app details
        const model = gridItem.dataset.model;
        const appNum = gridItem.dataset.appNum;
        if (model && appNum) {
            htmx.ajax('GET', `/app/${model}/${appNum}`, {
                target: '#main-content',
                pushUrl: true
            });
        }
    }
});

// Keyboard navigation for grid
document.addEventListener('keydown', function(event) {
    if (event.target.closest('.app-grid')) {
        const grid = event.target.closest('.app-grid');
        const items = Array.from(grid.querySelectorAll('.app-grid-item'));
        const currentIndex = items.indexOf(document.activeElement.closest('.app-grid-item'));
        
        let nextIndex = -1;
        
        switch (event.key) {
            case 'ArrowRight':
            case 'ArrowDown':
                nextIndex = (currentIndex + 1) % items.length;
                break;
            case 'ArrowLeft':
            case 'ArrowUp':
                nextIndex = (currentIndex - 1 + items.length) % items.length;
                break;
            case 'Home':
                nextIndex = 0;
                break;
            case 'End':
                nextIndex = items.length - 1;
                break;
        }
        
        if (nextIndex >= 0) {
            event.preventDefault();
            items[nextIndex].focus();
        }
    }
});
</script>
