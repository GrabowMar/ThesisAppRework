<!-- Test Files List Partial -->
<div class="table-responsive">
    <table class="table table-hover table-sm mb-0">
        <thead class="thead-light">
            <tr>
                <th width="40">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               id="select-all-tests" 
                               onchange="toggleAllTests(this)">
                    </div>
                </th>
                <th>File Name</th>
                <th>Category</th>
                <th>Size</th>
                <th>Modified</th>
                <th>Functions</th>
                <th width="100">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for test_file in test_files %}
            <tr class="test-file-item" data-file-name="{{ test_file.name }}">
                <td>
                    <div class="form-check">
                        <input class="form-check-input test-file-checkbox" 
                               type="checkbox" 
                               value="{{ test_file.path }}"
                               id="test-{{ loop.index }}">
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-code text-primary mr-2"></i>
                        <div>
                            <div class="font-weight-medium">{{ test_file.name }}</div>
                            <small class="text-muted">{{ test_file.relative_path }}</small>
                        </div>
                    </div>
                </td>
                <td>
                    {% if test_file.category == 'root' %}
                        <span class="badge badge-primary">Root</span>
                    {% elif test_file.category == 'tests' %}
                        <span class="badge badge-secondary">Tests</span>
                    {% else %}
                        <span class="badge badge-light">{{ test_file.category|title }}</span>
                    {% endif %}
                </td>
                <td>
                    <small class="text-muted">
                        {% if test_file.size < 1024 %}
                            {{ test_file.size }} B
                        {% elif test_file.size < 1048576 %}
                            {{ "%.1f"|format(test_file.size / 1024) }} KB
                        {% else %}
                            {{ "%.1f"|format(test_file.size / 1048576) }} MB
                        {% endif %}
                    </small>
                </td>
                <td>
                    <small class="text-muted">
                        {{ test_file.modified.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                </td>
                <td>
                    {% if test_file.test_functions is defined %}
                        <small class="text-info">
                            <i class="fas fa-function mr-1"></i>
                            {{ test_file.test_functions }}
                        </small>
                        {% if test_file.test_classes > 0 %}
                            <br>
                            <small class="text-secondary">
                                <i class="fas fa-cube mr-1"></i>
                                {{ test_file.test_classes }}
                            </small>
                        {% endif %}
                    {% else %}
                        <small class="text-muted">-</small>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" 
                                class="btn btn-outline-primary btn-sm"
                                onclick="runSingleTest('{{ test_file.path }}')"
                                title="Run Test">
                            <i class="fas fa-play"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-secondary btn-sm"
                                onclick="viewTestFile('{{ test_file.path }}')"
                                title="View File">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not test_files %}
<div class="text-center p-4">
    <i class="fas fa-search fa-3x text-muted mb-3"></i>
    <h5 class="text-muted">No Test Files Found</h5>
    <p class="text-muted">
        No test files were found in the project directories.<br>
        Make sure your test files follow the naming convention: <code>test_*.py</code> or <code>*_test.py</code>
    </p>
    <button type="button" class="btn btn-primary" onclick="discoverTests()">
        <i class="fas fa-search mr-1"></i>
        Discover Tests
    </button>
</div>
{% endif %}

<script>
function toggleAllTests(checkbox) {
    const testCheckboxes = document.querySelectorAll('.test-file-checkbox');
    testCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}

function viewTestFile(filePath) {
    // Open test file in a modal or new window
    const fileName = filePath.split('/').pop();
    
    // Create modal to show file content
    const modal = `
        <div class="modal fade" id="testFileModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-file-code mr-2"></i>
                            ${fileName}
                        </h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-center align-items-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="runSingleTest('${filePath}')">
                            <i class="fas fa-play mr-1"></i>
                            Run Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal
    const existingModal = document.getElementById('testFileModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Show modal
    $('#testFileModal').modal('show');
    
    // Load file content
    fetch(`/api/app/file-content?file=${encodeURIComponent(filePath)}`)
        .then(response => response.text())
        .then(content => {
            const modalBody = document.querySelector('#testFileModal .modal-body');
            modalBody.innerHTML = `
                <pre><code class="language-python">${escapeHtml(content)}</code></pre>
            `;
            
            // Apply syntax highlighting if available
            if (typeof hljs !== 'undefined') {
                hljs.highlightAll();
            }
        })
        .catch(error => {
            const modalBody = document.querySelector('#testFileModal .modal-body');
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Failed to load file content: ${error.message}
                </div>
            `;
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
