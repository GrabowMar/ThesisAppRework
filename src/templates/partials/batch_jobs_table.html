<!-- Batch Jobs Table Partial for HTMX -->
<div class="table-responsive" id="batch-jobs-table">
    {% if jobs %}
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Job ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Progress</th>
                <th>Tasks</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr data-job-id="{{ job.id }}">
                <td>
                    <code class="text-muted">{{ job.id[:8] }}...</code>
                </td>
                <td>
                    <strong>{{ job.name }}</strong>
                    {% if job.description %}
                    <br><small class="text-muted">{{ job.description[:50] }}{% if job.description|length > 50 %}...{% endif %}</small>
                    {% endif %}
                </td>
                <td>
                    {% if job.status == 'pending' %}
                        <span class="badge badge-warning">
                            <i class="fas fa-clock"></i> Pending
                        </span>
                    {% elif job.status == 'running' %}
                        <span class="badge badge-success">
                            <i class="fas fa-play"></i> Running
                        </span>
                    {% elif job.status == 'completed' %}
                        <span class="badge badge-info">
                            <i class="fas fa-check"></i> Completed
                        </span>
                    {% elif job.status == 'failed' %}
                        <span class="badge badge-danger">
                            <i class="fas fa-times"></i> Failed
                        </span>
                    {% elif job.status == 'cancelled' %}
                        <span class="badge badge-secondary">
                            <i class="fas fa-stop"></i> Cancelled
                        </span>
                    {% else %}
                        <span class="badge badge-light">{{ job.status|title }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if job.priority == 'low' %}
                        <span class="badge badge-light">Low</span>
                    {% elif job.priority == 'normal' %}
                        <span class="badge badge-primary">Normal</span>
                    {% elif job.priority == 'high' %}
                        <span class="badge badge-warning">High</span>
                    {% elif job.priority == 'urgent' %}
                        <span class="badge badge-danger">Urgent</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ job.priority|title }}</span>
                    {% endif %}
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar 
                            {% if job.progress == 100 %}bg-success
                            {% elif job.progress > 75 %}bg-info
                            {% elif job.progress > 50 %}bg-warning
                            {% else %}bg-primary{% endif %}" 
                            role="progressbar" 
                            style="width: {{ job.progress }}%;" 
                            aria-valuenow="{{ job.progress }}" 
                            aria-valuemin="0" 
                            aria-valuemax="100">
                            {{ job.progress }}%
                        </div>
                    </div>
                </td>
                <td>
                    <small>
                        <strong>{{ job.completed_tasks }}/{{ job.total_tasks }}</strong>
                        {% if job.failed_tasks > 0 %}
                        <br><span class="text-danger">{{ job.failed_tasks }} failed</span>
                        {% endif %}
                    </small>
                </td>
                <td>
                    <small class="text-muted">
                        {{ moment(job.created_at).fromNow() if job.created_at else 'Unknown' }}
                    </small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if job.status == 'pending' %}
                        <button class="btn btn-success btn-sm" 
                                hx-post="/api/batch/jobs/{{ job.id }}/start"
                                hx-trigger="click"
                                hx-swap="none"
                                hx-on="htmx:afterRequest: refreshJobsTable()"
                                title="Start Job">
                            <i class="fas fa-play"></i>
                        </button>
                        {% endif %}
                        
                        {% if job.status == 'running' %}
                        <button class="btn btn-warning btn-sm" 
                                hx-post="/api/batch/jobs/{{ job.id }}/stop"
                                hx-trigger="click"
                                hx-swap="none"
                                hx-on="htmx:afterRequest: refreshJobsTable()"
                                title="Stop Job">
                            <i class="fas fa-stop"></i>
                        </button>
                        {% endif %}
                        
                        <button class="btn btn-info btn-sm" 
                                onclick="viewJobDetails('{{ job.id }}')"
                                title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        
                        {% if job.status in ['completed', 'failed', 'cancelled'] %}
                        <button class="btn btn-danger btn-sm" 
                                hx-delete="/api/batch/jobs/{{ job.id }}"
                                hx-trigger="click"
                                hx-swap="none"
                                hx-confirm="Are you sure you want to delete this job?"
                                hx-on="htmx:afterRequest: refreshJobsTable()"
                                title="Delete Job">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav aria-label="Job pagination">
        <ul class="pagination justify-content-center">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" 
                   hx-get="/api/batch/jobs?page={{ page - 1 }}&limit={{ limit }}"
                   hx-target="#batch-jobs-table"
                   hx-swap="outerHTML">Previous</a>
            </li>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <li class="page-item active">
                    <span class="page-link">{{ p }}</span>
                </li>
                {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                <li class="page-item">
                    <a class="page-link" 
                       hx-get="/api/batch/jobs?page={{ p }}&limit={{ limit }}"
                       hx-target="#batch-jobs-table"
                       hx-swap="outerHTML">{{ p }}</a>
                </li>
                {% elif p == 4 and page > 5 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% elif p == total_pages - 3 and page < total_pages - 4 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link" 
                   hx-get="/api/batch/jobs?page={{ page + 1 }}&limit={{ limit }}"
                   hx-target="#batch-jobs-table"
                   hx-swap="outerHTML">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No batch jobs found</h5>
        <p class="text-muted">Create your first batch job to get started with automated analysis.</p>
        <button class="btn btn-primary" data-toggle="modal" data-target="#createJobModal">
            <i class="fas fa-plus"></i> Create New Job
        </button>
    </div>
    {% endif %}
</div>

<script>
function refreshJobsTable() {
    // Refresh the jobs table after actions
    htmx.ajax('GET', '/api/batch/jobs', {target: '#batch-jobs-table', swap: 'outerHTML'});
}

function viewJobDetails(jobId) {
    // TODO: Implement job details modal
    alert('Job details for: ' + jobId);
}
</script>
