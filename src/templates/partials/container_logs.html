<div class="modal-overlay" _="on click from outside .modal remove me">
    <div class="modal logs-modal">
        <header class="modal-header">
            <h3>Container Logs - {{ model|replace('_', ' ')|title }} App {{ app_num }}</h3>
            <div class="header-controls">
                <button hx-get="/docker/logs/{{ model }}/{{ app_num }}/download"
                        class="btn-secondary btn-sm">
                    üíæ Download
                </button>
                <button _="on click remove closest .modal-overlay" class="close-btn">√ó</button>
            </div>
        </header>
        
        <div class="modal-body">
            <!-- Log Controls -->
            <div class="log-controls">
                <div class="control-group">
                    <label>Service:</label>
                    <select hx-get="/docker/logs/{{ model }}/{{ app_num }}"
                            hx-trigger="change"
                            hx-target=".logs-content"
                            hx-include="[name='lines'], [name='follow']"
                            name="service">
                        <option value="all" selected>All Services</option>
                        <option value="frontend">Frontend Only</option>
                        <option value="backend">Backend Only</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Lines:</label>
                    <select hx-get="/docker/logs/{{ model }}/{{ app_num }}"
                            hx-trigger="change"
                            hx-target=".logs-content"
                            hx-include="[name='service'], [name='follow']"
                            name="lines">
                        <option value="100">Last 100</option>
                        <option value="500" selected>Last 500</option>
                        <option value="1000">Last 1000</option>
                        <option value="all">All Lines</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" 
                               name="follow"
                               value="true"
                               hx-get="/docker/logs/{{ model }}/{{ app_num }}"
                               hx-trigger="change"
                               hx-target=".logs-content"
                               hx-include="[name='service'], [name='lines']">
                        Follow (Live)
                    </label>
                </div>
                
                <div class="control-group">
                    <button hx-get="/docker/logs/{{ model }}/{{ app_num }}/clear"
                            hx-confirm="Clear all logs for this application?"
                            hx-target=".logs-content"
                            class="btn-warning btn-sm">
                        üóëÔ∏è Clear Logs
                    </button>
                </div>
            </div>
            
            <!-- Search -->
            <div class="log-search">
                <input type="search" 
                       placeholder="Search logs..."
                       _="on keyup
                          set query to my value
                          if query is not empty
                            hide all .log-line
                            show .log-line containing query
                          else
                            show all .log-line
                          end">
                
                <div class="search-info">
                    <span id="search-results"></span>
                </div>
            </div>
            
            <!-- Logs Content -->
            <div class="logs-content">
                
                {% if backend_logs or frontend_logs %}
                <div class="logs-container">
                    {% if backend_logs %}
                    <div class="log-section">
                        <h4 class="log-section-title">Backend Logs</h4>
                        <div class="log-lines">
                            {% for line in backend_logs.split('\n') %}
                            {% if line.strip() %}
                            <div class="log-line log-backend">
                                <span class="log-service service-backend">BACKEND</span>
                                <span class="log-message">{{ line }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if frontend_logs %}
                    <div class="log-section">
                        <h4 class="log-section-title">Frontend Logs</h4>
                        <div class="log-lines">
                            {% for line in frontend_logs.split('\n') %}
                            {% if line.strip() %}
                            <div class="log-line log-frontend">
                                <span class="log-service service-frontend">FRONTEND</span>
                                <span class="log-message">{{ line }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% else %}
                <div class="no-logs">
                    <div class="no-logs-icon">üìã</div>
                    <div class="no-logs-text">No logs available</div>
                    <div class="no-logs-subtitle">
                        Container may not be running or logs not generated yet
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-scroll to bottom when new logs arrive (if user is already at bottom)
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.classList.contains('logs-content')) {
        const container = evt.detail.target.querySelector('.logs-container');
        if (container) {
            const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
    }
});

// Update search results count
document.addEventListener('input', function(evt) {
    if (evt.target.type === 'search' && evt.target.placeholder.includes('Search logs')) {
        setTimeout(() => {
            const visibleLines = document.querySelectorAll('.log-line:not([style*="display: none"])').length;
            const totalLines = document.querySelectorAll('.log-line').length;
            const resultsElement = document.getElementById('search-results');
            
            if (resultsElement) {
                if (evt.target.value) {
                    resultsElement.textContent = `${visibleLines} of ${totalLines} lines match`;
                } else {
                    resultsElement.textContent = `${totalLines} total lines`;
                }
            }
        }, 100);
    }
});

// Initial scroll to bottom
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const container = document.querySelector('.logs-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }, 100);
});
</script>
