<!-- Batch Job Results Partial -->
<div class="row">
    <div class="col-md-8">
        <!-- Results Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Security Analysis Results - {{ results.job_name }}
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-3">
                        <div class="stat-box">
                            <div class="stat-value">{{ results.total_applications }}</div>
                            <div class="stat-label">Applications Tested</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-box">
                            <div class="stat-value text-{{ 'danger' if results.total_issues > 0 else 'success' }}">
                                {{ results.total_issues }}
                            </div>
                            <div class="stat-label">Total Issues</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-box">
                            <div class="stat-value text-success">{{ results.summary.clean_applications }}</div>
                            <div class="stat-label">Clean Apps</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-box">
                            <div class="stat-value text-warning">{{ results.summary.vulnerable_applications }}</div>
                            <div class="stat-label">Vulnerable Apps</div>
                        </div>
                    </div>
                </div>

                <!-- Severity Breakdown Chart -->
                {% if results.issues_by_severity %}
                <div class="mb-4">
                    <h6>Issues by Severity</h6>
                    <div class="row">
                        {% for severity, count in results.issues_by_severity.items() %}
                        <div class="col-md-3 mb-2">
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                <span class="badge 
                                    {% if severity == 'critical' %}badge-danger
                                    {% elif severity == 'high' %}badge-warning
                                    {% elif severity == 'medium' %}badge-info
                                    {% else %}badge-secondary{% endif %}">
                                    {{ severity|title }}
                                </span>
                                <strong>{{ count }}</strong>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Tools Usage -->
                {% if results.issues_by_tool %}
                <div class="mb-4">
                    <h6>Issues by Tool</h6>
                    <div class="row">
                        {% for tool, count in results.issues_by_tool.items() %}
                        <div class="col-md-3 mb-2">
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                <span class="badge badge-primary">{{ tool }}</span>
                                <strong>{{ count }}</strong>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Application Results -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-list mr-2"></i>
                    Application Results
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Application</th>
                                <th>Status</th>
                                <th>Issues</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in results.applications %}
                            <tr class="{% if app.issues_count > 0 %}table-warning{% endif %}">
                                <td>
                                    <strong>{{ app.model }}</strong>
                                    <br><small class="text-muted">App {{ app.app_num }}</small>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if app.status == 'completed' %}badge-success
                                        {% elif app.status == 'failed' %}badge-danger
                                        {% else %}badge-secondary{% endif %}">
                                        {{ app.status|title }}
                                    </span>
                                </td>
                                <td>
                                    {% if app.issues_count > 0 %}
                                    <span class="badge badge-warning" data-toggle="collapse" 
                                          data-target="#issues-{{ loop.index }}" style="cursor: pointer;">
                                        {{ app.issues_count }} issues
                                    </span>
                                    {% else %}
                                    <span class="badge badge-success">No issues</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if app.duration %}
                                            {{ "%.2f"|format(app.duration) }}s
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% if app.issues_count > 0 %}
                                    <button class="btn btn-outline-primary btn-sm" 
                                            data-toggle="collapse" 
                                            data-target="#issues-{{ loop.index }}">
                                        <i class="fas fa-eye"></i> View Issues
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if app.issues_count > 0 %}
                            <tr class="collapse" id="issues-{{ loop.index }}">
                                <td colspan="5" class="p-0">
                                    <div class="card m-2">
                                        <div class="card-body">
                                            <h6>Security Issues for {{ app.model }} App {{ app.app_num }}</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Tool</th>
                                                            <th>Severity</th>
                                                            <th>File</th>
                                                            <th>Line</th>
                                                            <th>Issue</th>
                                                            <th>Solution</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for issue in app.issues %}
                                                        <tr>
                                                            <td>
                                                                <span class="badge badge-primary">{{ issue.tool }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge 
                                                                    {% if issue.severity == 'critical' %}badge-danger
                                                                    {% elif issue.severity == 'high' %}badge-warning
                                                                    {% elif issue.severity == 'medium' %}badge-info
                                                                    {% else %}badge-secondary{% endif %}">
                                                                    {{ issue.severity }}
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <small class="text-muted">
                                                                    {{ issue.file_path.split('/')[-1] if issue.file_path else 'N/A' }}
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <small class="text-muted">{{ issue.line_number or 'N/A' }}</small>
                                                            </td>
                                                            <td>
                                                                <strong>{{ issue.message }}</strong>
                                                                {% if issue.description %}
                                                                <br><small class="text-muted">{{ issue.description }}</small>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <small class="text-success">{{ issue.solution or 'No solution provided' }}</small>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Export Options -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-download mr-2"></i>
                    Export Results
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" 
                            onclick="exportResults('{{ results.job_id }}', 'json')">
                        <i class="fas fa-file-code mr-1"></i> Export as JSON
                    </button>
                    <button type="button" class="btn btn-outline-success" 
                            onclick="exportResults('{{ results.job_id }}', 'csv')">
                        <i class="fas fa-file-csv mr-1"></i> Export as CSV
                    </button>
                    <button type="button" class="btn btn-outline-danger" 
                            onclick="exportResults('{{ results.job_id }}', 'pdf')">
                        <i class="fas fa-file-pdf mr-1"></i> Export as PDF
                    </button>
                    <button type="button" class="btn btn-outline-info" 
                            onclick="exportResults('{{ results.job_id }}', 'html')">
                        <i class="fas fa-file-alt mr-1"></i> Export as HTML
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie mr-2"></i>
                    Quick Stats
                </h6>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-8">Success Rate:</dt>
                    <dd class="col-sm-4">
                        {% set success_rate = (results.summary.clean_applications + results.summary.vulnerable_applications) / results.total_applications * 100 %}
                        <span class="badge badge-{{ 'success' if success_rate > 90 else 'warning' if success_rate > 70 else 'danger' }}">
                            {{ "%.1f"|format(success_rate) }}%
                        </span>
                    </dd>
                    
                    <dt class="col-sm-8">Vulnerability Rate:</dt>
                    <dd class="col-sm-4">
                        {% set vuln_rate = results.summary.vulnerable_applications / results.total_applications * 100 %}
                        <span class="badge badge-{{ 'success' if vuln_rate < 10 else 'warning' if vuln_rate < 30 else 'danger' }}">
                            {{ "%.1f"|format(vuln_rate) }}%
                        </span>
                    </dd>
                    
                    <dt class="col-sm-8">Failed Tests:</dt>
                    <dd class="col-sm-4">
                        <span class="badge badge-{{ 'success' if results.summary.failed_applications == 0 else 'danger' }}">
                            {{ results.summary.failed_applications }}
                        </span>
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Recommendations -->
        {% if results.total_issues > 0 %}
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb mr-2"></i>
                    Recommendations
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    {% if results.issues_by_severity.get('critical', 0) > 0 %}
                    <li class="mb-2">
                        <i class="fas fa-exclamation-triangle text-danger mr-2"></i>
                        <strong>Priority:</strong> Address {{ results.issues_by_severity.critical }} critical issues immediately
                    </li>
                    {% endif %}
                    
                    {% if results.issues_by_severity.get('high', 0) > 0 %}
                    <li class="mb-2">
                        <i class="fas fa-exclamation text-warning mr-2"></i>
                        <strong>High:</strong> Review {{ results.issues_by_severity.high }} high-severity issues
                    </li>
                    {% endif %}
                    
                    <li class="mb-2">
                        <i class="fas fa-shield-alt text-info mr-2"></i>
                        Consider implementing automated security scanning in CI/CD
                    </li>
                    
                    <li class="mb-2">
                        <i class="fas fa-book text-primary mr-2"></i>
                        Review security best practices for development teams
                    </li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function exportResults(jobId, format) {
    window.open(`/batch-testing/api/job/${jobId}/export?format=${format}`, '_blank');
}
</script>

<style>
.stat-box {
    text-align: center;
    padding: 1rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.1);
}
</style>
