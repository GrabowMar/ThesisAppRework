{% if recent_analyses %}
<table class="table table-hover">
    <thead class="thead-light">
        <tr>
            <th>Model</th>
            <th>App</th>
            <th>Type</th>
            <th>Status</th>
            <th>Issues Found</th>
            <th>Duration</th>
            <th>Completed</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for analysis in recent_analyses %}
        <tr class="analysis-row" data-analysis-id="{{ analysis.id }}">
            <td>
                <span class="font-weight-bold">{{ analysis.model_name }}</span>
                <br>
                <small class="text-muted">{{ analysis.model_slug }}</small>
            </td>
            <td>
                <span class="badge badge-primary">App {{ analysis.app_number }}</span>
                <br>
                <small class="text-muted">{{ analysis.app_type }}</small>
            </td>
            <td>
                <span class="badge badge-info">{{ analysis.analysis_type|title }}</span>
                {% if analysis.tools_used %}
                <br>
                <small class="text-muted">{{ analysis.tools_used|join(', ') }}</small>
                {% endif %}
            </td>
            <td>
                {% if analysis.status == 'completed' %}
                    <span class="badge badge-success">
                        <i class="fas fa-check"></i> Completed
                    </span>
                {% elif analysis.status == 'running' %}
                    <span class="badge badge-warning">
                        <i class="fas fa-cog fa-spin"></i> Running
                    </span>
                {% elif analysis.status == 'failed' %}
                    <span class="badge badge-danger">
                        <i class="fas fa-times"></i> Failed
                    </span>
                {% else %}
                    <span class="badge badge-secondary">
                        <i class="fas fa-clock"></i> {{ analysis.status|title }}
                    </span>
                {% endif %}
            </td>
            <td>
                {% if analysis.status == 'completed' %}
                    <div class="issue-summary">
                        {% if analysis.critical_issues > 0 %}
                            <span class="badge badge-danger mr-1">
                                {{ analysis.critical_issues }} Critical
                            </span>
                        {% endif %}
                        {% if analysis.high_issues > 0 %}
                            <span class="badge badge-warning mr-1">
                                {{ analysis.high_issues }} High
                            </span>
                        {% endif %}
                        {% if analysis.medium_issues > 0 %}
                            <span class="badge badge-info mr-1">
                                {{ analysis.medium_issues }} Medium
                            </span>
                        {% endif %}
                        {% if analysis.low_issues > 0 %}
                            <span class="badge badge-secondary mr-1">
                                {{ analysis.low_issues }} Low
                            </span>
                        {% endif %}
                        {% if analysis.total_issues == 0 %}
                            <span class="text-success">
                                <i class="fas fa-shield-alt"></i> No Issues
                            </span>
                        {% endif %}
                    </div>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if analysis.duration %}
                    {{ analysis.duration|format_duration }}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if analysis.completed_at %}
                    {{ analysis.completed_at|format_datetime }}
                {% else %}
                    <span class="text-muted">In Progress</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    {% if analysis.status == 'completed' %}
                        <button type="button" class="btn btn-outline-primary"
                                hx-get="/analysis/{{ analysis.analysis_type }}/{{ analysis.model_slug }}/{{ analysis.app_number }}/results"
                                hx-target="#analysis-results-modal-body"
                                data-toggle="modal" data-target="#analysisResultsModal"
                                title="View Results">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success"
                                onclick="downloadAnalysisReport('{{ analysis.id }}')"
                                title="Download Report">
                            <i class="fas fa-download"></i>
                        </button>
                    {% endif %}
                    
                    {% if analysis.status == 'running' %}
                        <button type="button" class="btn btn-outline-warning"
                                hx-post="/analysis/{{ analysis.id }}/cancel"
                                hx-target="closest tr"
                                hx-confirm="Are you sure you want to cancel this analysis?"
                                title="Cancel Analysis">
                            <i class="fas fa-stop"></i>
                        </button>
                    {% endif %}
                    
                    {% if analysis.status in ['completed', 'failed'] %}
                        <button type="button" class="btn btn-outline-danger"
                                hx-delete="/analysis/{{ analysis.id }}"
                                hx-target="closest tr"
                                hx-confirm="Are you sure you want to delete this analysis?"
                                title="Delete Analysis">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Analysis results pagination">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
            <li class="page-item">
                <button class="page-link" 
                        hx-get="/analysis/recent?page={{ pagination.prev_num }}"
                        hx-target="#recent-results-table">
                    Previous
                </button>
            </li>
        {% endif %}
        
        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                    <li class="page-item">
                        <button class="page-link"
                                hx-get="/analysis/recent?page={{ page_num }}"
                                hx-target="#recent-results-table">
                            {{ page_num }}
                        </button>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">â€¦</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <li class="page-item">
                <button class="page-link"
                        hx-get="/analysis/recent?page={{ pagination.next_num }}"
                        hx-target="#recent-results-table">
                    Next
                </button>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <div class="mb-3">
        <i class="fas fa-search fa-3x text-muted"></i>
    </div>
    <h5 class="text-muted">No Analysis Results Found</h5>
    <p class="text-muted">No security analyses have been performed yet.</p>
    <button type="button" class="btn btn-primary"
            hx-get="/analysis/quick"
            hx-target="#main-content">
        <i class="fas fa-rocket"></i> Run Your First Analysis
    </button>
</div>
{% endif %}

<!-- Analysis Results Modal -->
<div class="modal fade" id="analysisResultsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-alt"></i> Analysis Results
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="analysis-results-modal-body">
                    <!-- Results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="download-report-btn">
                    <i class="fas fa-download"></i> Download Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function downloadAnalysisReport(analysisId) {
    window.open(`/analysis/${analysisId}/report/download`, '_blank');
}
</script>
