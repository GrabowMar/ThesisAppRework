<!-- Test Results Content -->
<div class="container-fluid">
    {% if test.status == 'completed' %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6>Test Results Summary</h6>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="downloadTestResults('{{ test.id }}')">
                        <i class="fas fa-download"></i> Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">{{ test.total_issues or 0 }}</h5>
                    <p class="card-text">Total Issues Found</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">{{ test.critical_issues or 0 }}</h5>
                    <p class="card-text">Critical Issues</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">{{ test.warning_issues or 0 }}</h5>
                    <p class="card-text">Warnings</p>
                </div>
            </div>
        </div>
    </div>

    {% if test.results %}
    <div class="row mt-4">
        <div class="col-12">
            <h6>Detailed Results</h6>
            <div class="accordion" id="resultsAccordion">
                {% for tool, result in test.results.items() %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ loop.index }}">
                        <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ loop.index }}"
                                aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" 
                                aria-controls="collapse{{ loop.index }}">
                            <i class="fas fa-tools me-2"></i>
                            {{ tool|title }} Results
                            {% if result.issues %}
                                <span class="badge bg-danger ms-2">{{ result.issues|length }} issues</span>
                            {% else %}
                                <span class="badge bg-success ms-2">No issues</span>
                            {% endif %}
                        </button>
                    </h2>
                    <div id="collapse{{ loop.index }}" 
                         class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                         aria-labelledby="heading{{ loop.index }}" 
                         data-bs-parent="#resultsAccordion">
                        <div class="accordion-body">
                            {% if result.issues %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Severity</th>
                                                <th>Issue</th>
                                                <th>File</th>
                                                <th>Line</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for issue in result.issues %}
                                            <tr>
                                                <td>
                                                    <span class="badge 
                                                        {% if issue.severity == 'critical' %}bg-danger
                                                        {% elif issue.severity == 'high' %}bg-warning
                                                        {% elif issue.severity == 'medium' %}bg-info
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ issue.severity|title }}
                                                    </span>
                                                </td>
                                                <td><code>{{ issue.type or issue.rule_id or 'Unknown' }}</code></td>
                                                <td>
                                                    {% if issue.filename %}
                                                        <small class="text-monospace">{{ issue.filename }}</small>
                                                    {% else %}
                                                        <small class="text-muted">N/A</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if issue.line_number %}
                                                        <small class="text-muted">{{ issue.line_number }}</small>
                                                    {% else %}
                                                        <small class="text-muted">N/A</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <small>{{ issue.description or issue.message or 'No description available' }}</small>
                                                    {% if issue.recommendation %}
                                                        <br><small class="text-info"><strong>Fix:</strong> {{ issue.recommendation }}</small>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                    <p class="text-muted">No issues found by {{ tool|title }}</p>
                                </div>
                            {% endif %}
                            
                            {% if result.metrics %}
                            <div class="mt-3">
                                <h6>Metrics</h6>
                                <div class="row">
                                    {% for metric, value in result.metrics.items() %}
                                    <div class="col-md-3">
                                        <small class="text-muted">{{ metric|title }}:</small><br>
                                        <strong>{{ value }}</strong>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if test.recommendations %}
    <div class="row mt-4">
        <div class="col-12">
            <h6>Recommendations</h6>
            <div class="alert alert-info">
                <ul class="mb-0">
                    {% for recommendation in test.recommendations %}
                        <li>{{ recommendation }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% elif test.status == 'failed' %}
    <div class="alert alert-danger">
        <h6><i class="fas fa-exclamation-triangle"></i> Test Failed</h6>
        <p>This test failed to complete successfully. Please check the logs for more details.</p>
        {% if test.error_message %}
            <p><strong>Error:</strong> {{ test.error_message }}</p>
        {% endif %}
    </div>

    {% elif test.status == 'running' %}
    <div class="text-center py-4">
        <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
        <h6>Test is still running...</h6>
        <p class="text-muted">Results will be available when the test completes.</p>
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: {{ test.progress_percentage or 0 }}%">
                {{ test.progress_percentage or 0 }}%
            </div>
        </div>
    </div>

    {% else %}
    <div class="text-center py-4">
        <i class="fas fa-clock fa-2x text-muted mb-3"></i>
        <h6>No results available yet</h6>
        <p class="text-muted">Test has not completed yet or no results were generated.</p>
    </div>
    {% endif %}
</div>

<script>
function downloadTestResults(testId) {
    window.open(`/testing/api/test/${testId}/download`, '_blank');
}
</script>
