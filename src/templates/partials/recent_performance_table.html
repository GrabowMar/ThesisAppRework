{% if recent_tests %}
<table class="table table-hover">
    <thead class="thead-light">
        <tr>
            <th>Model</th>
            <th>App</th>
            <th>Test Type</th>
            <th>Status</th>
            <th>Performance Metrics</th>
            <th>Duration</th>
            <th>Completed</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for test in recent_tests %}
        <tr class="test-row" data-test-id="{{ test.id }}">
            <td>
                <span class="font-weight-bold">{{ test.model_name }}</span>
                <br>
                <small class="text-muted">{{ test.model_slug }}</small>
            </td>
            <td>
                <span class="badge badge-primary">App {{ test.app_number }}</span>
                <br>
                <small class="text-muted">{{ test.app_type }}</small>
            </td>
            <td>
                <span class="badge badge-success">{{ test.test_type|title }}</span>
                <br>
                <small class="text-muted">
                    {{ test.users }} users, {{ test.duration }}s
                </small>
            </td>
            <td>
                {% if test.status == 'completed' %}
                    <span class="badge badge-success">
                        <i class="fas fa-check"></i> Completed
                    </span>
                {% elif test.status == 'running' %}
                    <span class="badge badge-warning">
                        <i class="fas fa-cog fa-spin"></i> Running
                    </span>
                    <br>
                    <small class="text-muted">{{ test.progress or 0 }}% complete</small>
                {% elif test.status == 'failed' %}
                    <span class="badge badge-danger">
                        <i class="fas fa-times"></i> Failed
                    </span>
                {% else %}
                    <span class="badge badge-secondary">
                        <i class="fas fa-clock"></i> {{ test.status|title }}
                    </span>
                {% endif %}
            </td>
            <td>
                {% if test.status == 'completed' %}
                    <div class="performance-metrics">
                        {% if test.avg_response_time %}
                            <div>
                                <strong>Avg Response:</strong> 
                                <span class="{% if test.avg_response_time > 2000 %}text-danger{% elif test.avg_response_time > 1000 %}text-warning{% else %}text-success{% endif %}">
                                    {{ test.avg_response_time }}ms
                                </span>
                            </div>
                        {% endif %}
                        {% if test.requests_per_second %}
                            <div>
                                <strong>RPS:</strong> 
                                <span class="text-info">{{ test.requests_per_second }}</span>
                            </div>
                        {% endif %}
                        {% if test.failure_rate is defined %}
                            <div>
                                <strong>Failure Rate:</strong> 
                                <span class="{% if test.failure_rate > 5 %}text-danger{% elif test.failure_rate > 1 %}text-warning{% else %}text-success{% endif %}">
                                    {{ test.failure_rate }}%
                                </span>
                            </div>
                        {% endif %}
                    </div>
                {% elif test.status == 'running' %}
                    <div class="running-metrics">
                        {% if test.current_rps %}
                            <div><strong>Current RPS:</strong> {{ test.current_rps }}</div>
                        {% endif %}
                        {% if test.active_users %}
                            <div><strong>Active Users:</strong> {{ test.active_users }}</div>
                        {% endif %}
                    </div>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if test.duration %}
                    {{ test.duration|format_duration }}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if test.completed_at %}
                    {{ test.completed_at|format_datetime }}
                {% else %}
                    <span class="text-muted">In Progress</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    {% if test.status == 'completed' %}
                        <button type="button" class="btn btn-outline-primary"
                                hx-get="/performance/test/{{ test.id }}/results"
                                hx-target="#performance-results-modal-body"
                                data-toggle="modal" data-target="#performanceResultsModal"
                                title="View Results">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success"
                                onclick="downloadPerformanceReport('{{ test.id }}')"
                                title="Download Report">
                            <i class="fas fa-download"></i>
                        </button>
                    {% endif %}
                    
                    {% if test.status == 'running' %}
                        <button type="button" class="btn btn-outline-info"
                                hx-get="/performance/test/{{ test.id }}/progress"
                                hx-target="#test-progress-modal-body"
                                data-toggle="modal" data-target="#testProgressModal"
                                title="View Progress">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-warning"
                                hx-post="/performance/test/{{ test.id }}/stop"
                                hx-target="closest tr"
                                hx-confirm="Are you sure you want to stop this test?"
                                title="Stop Test">
                            <i class="fas fa-stop"></i>
                        </button>
                    {% endif %}
                    
                    {% if test.status in ['completed', 'failed'] %}
                        <button type="button" class="btn btn-outline-danger"
                                hx-delete="/performance/test/{{ test.id }}"
                                hx-target="closest tr"
                                hx-confirm="Are you sure you want to delete this test?"
                                title="Delete Test">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Performance tests pagination">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
            <li class="page-item">
                <button class="page-link" 
                        hx-get="/performance/recent?page={{ pagination.prev_num }}"
                        hx-target="#recent-tests-table">
                    Previous
                </button>
            </li>
        {% endif %}
        
        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                    <li class="page-item">
                        <button class="page-link"
                                hx-get="/performance/recent?page={{ page_num }}"
                                hx-target="#recent-tests-table">
                            {{ page_num }}
                        </button>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">â€¦</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <li class="page-item">
                <button class="page-link"
                        hx-get="/performance/recent?page={{ pagination.next_num }}"
                        hx-target="#recent-tests-table">
                    Next
                </button>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <div class="mb-3">
        <i class="fas fa-tachometer-alt fa-3x text-muted"></i>
    </div>
    <h5 class="text-muted">No Performance Tests Found</h5>
    <p class="text-muted">No performance tests have been run yet.</p>
    <button type="button" class="btn btn-success"
            hx-get="/performance/quick_test"
            hx-target="#main-content">
        <i class="fas fa-rocket"></i> Run Your First Performance Test
    </button>
</div>
{% endif %}

<!-- Performance Results Modal -->
<div class="modal fade" id="performanceResultsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line"></i> Performance Test Results
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="performance-results-modal-body">
                    <!-- Results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="download-performance-report-btn">
                    <i class="fas fa-download"></i> Download Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Progress Modal -->
<div class="modal fade" id="testProgressModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> Test Progress
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="test-progress-modal-body">
                    <!-- Progress will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="stop-test-btn">
                    <i class="fas fa-stop"></i> Stop Test
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function downloadPerformanceReport(testId) {
    window.open(`/performance/test/${testId}/report/download`, '_blank');
}
</script>
