{% if recent_scans %}
<table class="table table-hover">
    <thead class="thead-light">
        <tr>
            <th>Model</th>
            <th>App</th>
            <th>Scan Type</th>
            <th>Status</th>
            <th>Security Issues</th>
            <th>Duration</th>
            <th>Completed</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for scan in recent_scans %}
        <tr class="scan-row" data-scan-id="{{ scan.id }}">
            <td>
                <span class="font-weight-bold">{{ scan.model_name }}</span>
                <br>
                <small class="text-muted">{{ scan.model_slug }}</small>
            </td>
            <td>
                <span class="badge badge-primary">App {{ scan.app_number }}</span>
                <br>
                <small class="text-muted">{{ scan.app_type }}</small>
            </td>
            <td>
                <span class="badge badge-danger">{{ scan.scan_type|title }}</span>
                <br>
                <small class="text-muted">
                    {% if scan.scan_policy %}{{ scan.scan_policy|title }}{% endif %}
                </small>
            </td>
            <td>
                {% if scan.status == 'completed' %}
                    <span class="badge badge-success">
                        <i class="fas fa-check"></i> Completed
                    </span>
                {% elif scan.status == 'running' %}
                    <span class="badge badge-warning">
                        <i class="fas fa-cog fa-spin"></i> Running
                    </span>
                    {% if scan.progress %}
                        <br>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ scan.progress }}%"></div>
                        </div>
                        <small class="text-muted">{{ scan.progress }}%</small>
                    {% endif %}
                {% elif scan.status == 'failed' %}
                    <span class="badge badge-danger">
                        <i class="fas fa-times"></i> Failed
                    </span>
                {% else %}
                    <span class="badge badge-secondary">
                        <i class="fas fa-clock"></i> {{ scan.status|title }}
                    </span>
                {% endif %}
            </td>
            <td>
                {% if scan.status == 'completed' %}
                    <div class="security-issues">
                        {% if scan.high_risk_count > 0 %}
                            <span class="badge badge-danger mr-1">
                                {{ scan.high_risk_count }} High
                            </span>
                        {% endif %}
                        {% if scan.medium_risk_count > 0 %}
                            <span class="badge badge-warning mr-1">
                                {{ scan.medium_risk_count }} Medium
                            </span>
                        {% endif %}
                        {% if scan.low_risk_count > 0 %}
                            <span class="badge badge-info mr-1">
                                {{ scan.low_risk_count }} Low
                            </span>
                        {% endif %}
                        {% if scan.info_risk_count > 0 %}
                            <span class="badge badge-secondary mr-1">
                                {{ scan.info_risk_count }} Info
                            </span>
                        {% endif %}
                        {% if scan.total_alerts == 0 %}
                            <span class="text-success">
                                <i class="fas fa-shield-alt"></i> No Issues
                            </span>
                        {% endif %}
                    </div>
                    {% if scan.urls_found %}
                        <br>
                        <small class="text-muted">{{ scan.urls_found }} URLs scanned</small>
                    {% endif %}
                {% elif scan.status == 'running' %}
                    <div class="running-info">
                        {% if scan.current_phase %}
                            <div><strong>Phase:</strong> {{ scan.current_phase }}</div>
                        {% endif %}
                        {% if scan.urls_found %}
                            <div><strong>URLs Found:</strong> {{ scan.urls_found }}</div>
                        {% endif %}
                        {% if scan.alerts_found %}
                            <div><strong>Alerts:</strong> {{ scan.alerts_found }}</div>
                        {% endif %}
                    </div>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if scan.duration %}
                    {{ scan.duration|format_duration }}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if scan.completed_at %}
                    {{ scan.completed_at|format_datetime }}
                {% else %}
                    <span class="text-muted">In Progress</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    {% if scan.status == 'completed' %}
                        <button type="button" class="btn btn-outline-primary"
                                hx-get="/zap/scan/{{ scan.id }}/results"
                                hx-target="#zap-results-modal-body"
                                data-toggle="modal" data-target="#zapResultsModal"
                                title="View Results">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% if scan.report_available %}
                            <button type="button" class="btn btn-outline-success"
                                    onclick="downloadZapReport('{{ scan.id }}')"
                                    title="Download HTML Report">
                                <i class="fas fa-download"></i>
                            </button>
                        {% endif %}
                    {% endif %}
                    
                    {% if scan.status == 'running' %}
                        <button type="button" class="btn btn-outline-info"
                                hx-get="/zap/scan/{{ scan.id }}/progress"
                                hx-target="#scan-progress-modal-body"
                                data-toggle="modal" data-target="#scanProgressModal"
                                title="View Progress">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-warning"
                                hx-post="/zap/scan/{{ scan.id }}/stop"
                                hx-target="closest tr"
                                hx-confirm="Are you sure you want to stop this scan?"
                                title="Stop Scan">
                            <i class="fas fa-stop"></i>
                        </button>
                    {% endif %}
                    
                    {% if scan.status in ['completed', 'failed'] %}
                        <button type="button" class="btn btn-outline-danger"
                                hx-delete="/zap/scan/{{ scan.id }}"
                                hx-target="closest tr"
                                hx-confirm="Are you sure you want to delete this scan?"
                                title="Delete Scan">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="ZAP scans pagination">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
            <li class="page-item">
                <button class="page-link" 
                        hx-get="/zap/recent?page={{ pagination.prev_num }}"
                        hx-target="#recent-scans-table">
                    Previous
                </button>
            </li>
        {% endif %}
        
        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                    <li class="page-item">
                        <button class="page-link"
                                hx-get="/zap/recent?page={{ page_num }}"
                                hx-target="#recent-scans-table">
                            {{ page_num }}
                        </button>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">â€¦</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <li class="page-item">
                <button class="page-link"
                        hx-get="/zap/recent?page={{ pagination.next_num }}"
                        hx-target="#recent-scans-table">
                    Next
                </button>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <div class="mb-3">
        <i class="fas fa-shield-virus fa-3x text-muted"></i>
    </div>
    <h5 class="text-muted">No Security Scans Found</h5>
    <p class="text-muted">No ZAP security scans have been performed yet.</p>
    <button type="button" class="btn btn-danger"
            hx-get="/zap/quick_scan"
            hx-target="#main-content">
        <i class="fas fa-rocket"></i> Run Your First Security Scan
    </button>
</div>
{% endif %}

<!-- ZAP Results Modal -->
<div class="modal fade" id="zapResultsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-virus"></i> ZAP Security Scan Results
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="zap-results-modal-body">
                    <!-- Results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="download-zap-report-btn">
                    <i class="fas fa-download"></i> Download HTML Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scan Progress Modal -->
<div class="modal fade" id="scanProgressModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> Scan Progress
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="scan-progress-modal-body">
                    <!-- Progress will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="stop-scan-btn">
                    <i class="fas fa-stop"></i> Stop Scan
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function downloadZapReport(scanId) {
    window.open(`/zap/scan/${scanId}/report/download`, '_blank');
}
</script>
