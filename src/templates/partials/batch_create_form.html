<!-- Batch Job Creation Form Partial -->
<form id="batchJobForm" method="POST" action="/batch/create">
    <!-- Basic Information -->
    <div class="form-section">
        <h5>
            <i class="fas fa-info-circle mr-2"></i>Basic Information
            <span class="text-danger">*</span>
        </h5>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="jobName" class="font-weight-bold">
                        Job Name <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="jobName" name="name" 
                           placeholder="Enter a descriptive name for this job" required>
                    <div class="invalid-feedback" id="jobNameError"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="jobPriority" class="font-weight-bold">Priority</label>
                    <select class="form-control" id="jobPriority" name="priority">
                        <option value="normal">Normal</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="jobDescription" class="font-weight-bold">Description</label>
            <textarea class="form-control" id="jobDescription" name="description" rows="3"
                      placeholder="Optional description of what this job will accomplish"></textarea>
        </div>
    </div>

    <!-- Analysis Types -->
    <div class="form-section">
        <h5>
            <i class="fas fa-shield-alt mr-2"></i>Analysis Types
            <span class="text-danger">*</span>
        </h5>
        <p class="text-muted mb-3">Select one or more analysis types to run on the selected applications.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="analysis-type-card p-3 border rounded mb-3" data-type="frontend_security">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="frontendSecurity" 
                               name="analysis_types" value="frontend_security">
                        <label class="custom-control-label font-weight-bold" for="frontendSecurity">
                            <i class="fas fa-globe text-primary mr-2"></i>Frontend Security Analysis
                        </label>
                    </div>
                    <p class="text-muted small mt-2 mb-0">
                        Analyzes client-side security vulnerabilities using ESLint security rules
                    </p>
                    <div class="text-muted small">
                        <strong>Tools:</strong> ESLint Security, npm audit
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="analysis-type-card p-3 border rounded mb-3" data-type="backend_security">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="backendSecurity" 
                               name="analysis_types" value="backend_security">
                        <label class="custom-control-label font-weight-bold" for="backendSecurity">
                            <i class="fas fa-server text-success mr-2"></i>Backend Security Analysis
                        </label>
                    </div>
                    <p class="text-muted small mt-2 mb-0">
                        Scans server-side code for security vulnerabilities and best practices
                    </p>
                    <div class="text-muted small">
                        <strong>Tools:</strong> Bandit, Safety, Semgrep
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="analysis-type-card p-3 border rounded mb-3" data-type="code_quality">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="codeQuality" 
                               name="analysis_types" value="code_quality">
                        <label class="custom-control-label font-weight-bold" for="codeQuality">
                            <i class="fas fa-code text-info mr-2"></i>Code Quality Analysis
                        </label>
                    </div>
                    <p class="text-muted small mt-2 mb-0">
                        Evaluates code quality, maintainability, and adherence to best practices
                    </p>
                    <div class="text-muted small">
                        <strong>Tools:</strong> Pylint, Flake8, SonarJS
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="analysis-type-card p-3 border rounded mb-3" data-type="performance">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="performance" 
                               name="analysis_types" value="performance">
                        <label class="custom-control-label font-weight-bold" for="performance">
                            <i class="fas fa-tachometer-alt text-warning mr-2"></i>Performance Analysis
                        </label>
                    </div>
                    <p class="text-muted small mt-2 mb-0">
                        Tests application performance, load handling, and response times
                    </p>
                    <div class="text-muted small">
                        <strong>Tools:</strong> Locust, Lighthouse, WebPageTest
                    </div>
                </div>
            </div>
        </div>
        <div class="validation-error" id="analysisTypesError"></div>
    </div>

    <!-- Model Selection -->
    <div class="form-section">
        <h5>
            <i class="fas fa-robot mr-2"></i>AI Models
            <span class="text-danger">*</span>
        </h5>
        <p class="text-muted mb-3">Select which AI models' generated applications to analyze.</p>
        
        <div class="row">
            {% for model in available_models %}
            <div class="col-md-4 col-sm-6 mb-3">
                <div class="model-card p-3 border rounded">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" 
                               id="model_{{ model.id }}" name="models" value="{{ model.canonical_slug }}">
                        <label class="custom-control-label" for="model_{{ model.id }}">
                            <div class="font-weight-bold">{{ model.display_name }}</div>
                            <div class="text-muted small">{{ model.provider }}</div>
                            <div class="text-muted small">
                                Context: {{ model.context_window | default('N/A') }}
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="validation-error" id="modelsError"></div>
    </div>

    <!-- Application Range -->
    <div class="form-section">
        <h5>
            <i class="fas fa-layer-group mr-2"></i>Application Range
            <span class="text-danger">*</span>
        </h5>
        <p class="text-muted mb-3">Specify which generated applications to include in the analysis.</p>
        
        <div class="form-group">
            <label for="appRange" class="font-weight-bold">
                Application Range <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" id="appRange" name="app_range" 
                   placeholder="e.g., 1-5, 1,3,5, all" required>
            <div class="form-text text-muted">
                Examples: <code>1-10</code> (apps 1 to 10), <code>1,5,10</code> (specific apps), <code>all</code> (all 30 apps)
            </div>
            <div class="validation-error" id="appRangeError"></div>
        </div>
    </div>

    <!-- Job Options -->
    <div class="form-section">
        <h5>
            <i class="fas fa-cog mr-2"></i>Job Options
        </h5>
        
        <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="autoStart" name="auto_start" checked>
            <label class="custom-control-label" for="autoStart">
                <strong>Auto-start job after creation</strong>
            </label>
            <div class="form-text text-muted">
                If unchecked, the job will be created but not started automatically
            </div>
        </div>
    </div>

    <!-- Submit Section -->
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">Ready to create batch job?</h6>
                <p class="text-muted small mb-0">This will create a new batch analysis job with the selected configuration.</p>
            </div>
            <div>
                <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Create Job
                </button>
            </div>
        </div>
    </div>
</form>

<script>
// Form validation and submission for modal
document.getElementById('batchJobForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    
    // Validate form
    let isValid = true;
    
    // Job name validation
    const jobName = document.getElementById('jobName').value.trim();
    if (!jobName) {
        document.getElementById('jobNameError').textContent = 'Job name is required';
        document.getElementById('jobName').classList.add('is-invalid');
        isValid = false;
    }
    
    // Analysis types validation
    const analysisTypes = document.querySelectorAll('input[name="analysis_types"]:checked');
    if (analysisTypes.length === 0) {
        document.getElementById('analysisTypesError').textContent = 'At least one analysis type must be selected';
        isValid = false;
    }
    
    // Models validation
    const models = document.querySelectorAll('input[name="models"]:checked');
    if (models.length === 0) {
        document.getElementById('modelsError').textContent = 'At least one model must be selected';
        isValid = false;
    }
    
    // App range validation
    const appRange = document.getElementById('appRange').value.trim();
    if (!appRange) {
        document.getElementById('appRangeError').textContent = 'Application range is required';
        document.getElementById('appRange').classList.add('is-invalid');
        isValid = false;
    }
    
    if (!isValid) {
        return;
    }
    
    // Submit the form via AJAX
    const formData = new FormData(this);
    
    fetch('/batch/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            if (window.showToast) {
                window.showToast(data.message || 'Batch job created successfully!', 'success');
            }
            
            // Close modal
            $('#createJobModal').modal('hide');
            
            // Redirect to job detail page or refresh the overview
            if (data.data && data.data.job_id) {
                setTimeout(() => {
                    window.location.href = '/batch/job/' + data.data.job_id;
                }, 1500);
            } else {
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        } else {
            // Show error message
            if (window.showToast) {
                window.showToast(data.error || 'Failed to create batch job', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error creating batch job:', error);
        if (window.showToast) {
            window.showToast('An error occurred while creating the batch job', 'error');
        }
    });
});

// Enhanced styling for analysis type cards
document.querySelectorAll('.analysis-type-card').forEach(card => {
    const checkbox = card.querySelector('input[type="checkbox"]');
    
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            card.classList.add('border-primary', 'bg-light');
        } else {
            card.classList.remove('border-primary', 'bg-light');
        }
    });
});

// Enhanced styling for model cards
document.querySelectorAll('.model-card').forEach(card => {
    const checkbox = card.querySelector('input[type="checkbox"]');
    
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            card.classList.add('border-success', 'bg-light');
        } else {
            card.classList.remove('border-success', 'bg-light');
        }
    });
});
</script>

<style>
.form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.analysis-type-card,
.model-card {
    transition: all 0.2s ease;
    cursor: pointer;
}

.analysis-type-card:hover,
.model-card:hover {
    border-color: #007bff !important;
    box-shadow: 0 2px 4px rgba(0,123,255,0.1);
}

.validation-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.required-indicator {
    color: #dc3545;
}

.step-progress {
    margin-bottom: 2rem;
}

.step-progress .step {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
    position: relative;
}

.step-progress .step.active {
    color: #007bff;
    font-weight: bold;
}

.step-progress .step.completed {
    color: #28a745;
}

.step-progress .step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -50%;
    width: 100%;
    height: 2px;
    background-color: #e9ecef;
    z-index: -1;
}

.step-progress .step.completed:not(:last-child)::after {
    background-color: #28a745;
}
</style>
