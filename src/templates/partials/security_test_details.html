<!-- Security Test Details Partial -->
<div class="modal-header">
    <h5 class="modal-title">
        <i class="fas fa-shield-alt mr-2"></i>
        Test Details: {{ test.name or test.id }}
    </h5>
    <button type="button" class="close" data-dismiss="modal">
        <span>&times;</span>
    </button>
</div>

<div class="modal-body">
    <!-- Test Overview -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Test Information</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Test ID:</strong></td>
                            <td>{{ test.id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Type:</strong></td>
                            <td>
                                {% if test.type == 'security' %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-shield-alt"></i> Security
                                    </span>
                                {% elif test.type == 'performance' %}
                                    <span class="badge badge-info">
                                        <i class="fas fa-tachometer-alt"></i> Performance
                                    </span>
                                {% elif test.type == 'zap' %}
                                    <span class="badge badge-warning">
                                        <i class="fas fa-spider"></i> ZAP Scan
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ test.type|title }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                {% if test.status == 'running' %}
                                    <span class="badge badge-primary">
                                        <i class="fas fa-spinner fa-spin"></i> Running
                                    </span>
                                {% elif test.status == 'completed' %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-check"></i> Completed
                                    </span>
                                {% elif test.status == 'failed' %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-times"></i> Failed
                                    </span>
                                {% elif test.status == 'pending' %}
                                    <span class="badge badge-warning">
                                        <i class="fas fa-clock"></i> Pending
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ test.status|title }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>{{ test.created_at.strftime('%Y-%m-%d %H:%M:%S') if test.created_at else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Duration:</strong></td>
                            <td>
                                {% if test.runtime_seconds %}
                                    {{ (test.runtime_seconds / 60)|round(2) }} minutes
                                {% elif test.started_at and test.completed_at %}
                                    {% set duration_seconds = (test.completed_at - test.started_at).total_seconds() %}
                                    {{ (duration_seconds / 60)|round(2) }} minutes
                                {% elif test.started_at %}
                                    Calculating...
                                {% else %}
                                    Not started
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line mr-2"></i>
                        Real-time Progress
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary"
                            hx-get="/testing/api/test/{{ test.job_id }}/details"
                            hx-target="#test-details-content"
                            hx-swap="innerHTML"
                            title="Refresh Progress">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if test.progress %}
                        <!-- Main Progress Bar -->
                        <div class="progress mb-3" style="height: 25px;">
                            {% if test.progress.estimated %}
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                     role="progressbar" 
                                     style="width: {{ test.progress.percentage or 0 }}%"
                                     aria-valuenow="{{ test.progress.percentage or 0 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ~{{ test.progress.percentage or 0 }}%
                                </div>
                            {% else %}
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: {{ test.progress.percentage or 0 }}%"
                                     aria-valuenow="{{ test.progress.percentage or 0 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ test.progress.percentage or 0 }}%
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Current Stage -->
                        {% if test.progress.current_stage %}
                        <div class="mb-3">
                            <strong>Current Stage:</strong>
                            <span class="badge badge-primary">
                                <i class="fas fa-cog fa-spin mr-1"></i>
                                {{ test.progress.current_stage }}
                            </span>
                        </div>
                        {% endif %}
                        
                        <!-- Time Information -->
                        <div class="row mb-3">
                            {% if test.runtime_seconds %}
                            <div class="col-6">
                                <small class="text-muted">Runtime:</small><br>
                                <strong>{{ (test.runtime_seconds / 60)|round(1) }} min</strong>
                            </div>
                            {% endif %}
                            {% if test.progress.eta_seconds and test.progress.eta_seconds > 0 %}
                            <div class="col-6">
                                <small class="text-muted">ETA:</small><br>
                                <strong>{{ (test.progress.eta_seconds / 60)|round(1) }} min</strong>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Progress Details -->
                        {% if test.progress.items_processed or test.progress.total_items %}
                        <div class="mb-3">
                            <small class="text-muted">Items Processed:</small><br>
                            <strong>{{ test.progress.items_processed or 0 }} / {{ test.progress.total_items or 0 }}</strong>
                        </div>
                        {% endif %}
                        
                        {% if test.progress.current_file %}
                        <div class="mb-3">
                            <small class="text-muted">Current File:</small><br>
                            <code class="small">{{ test.progress.current_file }}</code>
                        </div>
                        {% endif %}
                        
                        <!-- Detailed Stages -->
                        {% if test.progress.stages %}
                        <div class="stages-container">
                            <h6 class="mb-2">Analysis Stages:</h6>
                            <div class="list-group list-group-flush">
                                {% for stage in test.progress.stages %}
                                <div class="list-group-item d-flex justify-content-between align-items-center p-2 
                                     {{ 'border-success' if stage.completed else 'border-primary' if stage.active else '' }}">
                                    <div class="d-flex align-items-center">
                                        {% if stage.completed %}
                                            <i class="fas fa-check-circle text-success mr-2"></i>
                                        {% elif stage.active %}
                                            <i class="fas fa-spinner fa-spin text-primary mr-2"></i>
                                        {% else %}
                                            <i class="fas fa-circle text-muted mr-2"></i>
                                        {% endif %}
                                        <div>
                                            <div class="font-weight-bold small">{{ stage.name }}</div>
                                            {% if stage.description %}
                                            <div class="text-muted" style="font-size: 0.75rem;">{{ stage.description }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if stage.progress and stage.progress > 0 and not stage.completed %}
                                    <div class="progress ml-2" style="width: 60px; height: 8px;">
                                        <div class="progress-bar" 
                                             style="width: {{ stage.progress }}%"></div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle"></i>
                            No progress information available
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Resource Usage Card -->
            {% if test.resource_usage %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-server mr-2"></i>
                        Container Resources
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span class="small">CPU:</span>
                                <strong>{{ test.resource_usage.cpu_percent }}%</strong>
                            </div>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar bg-info" 
                                     style="width: {{ test.resource_usage.cpu_percent }}%"></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span class="small">Memory:</span>
                                <strong>{{ test.resource_usage.memory_usage_mb }}MB</strong>
                            </div>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar bg-warning" 
                                     style="width: {{ (test.resource_usage.memory_usage_mb / 512 * 100)|round }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <span class="small text-muted">Disk I/O: {{ test.resource_usage.disk_io_mb }}MB</span>
                        </div>
                        <div class="col-6">
                            <span class="small text-muted">Network: {{ test.resource_usage.network_io_kb }}KB</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Configuration Details -->
    {% if test.config %}
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-cog mr-2"></i>
                Test Configuration
            </h6>
        </div>
        <div class="card-body">
            {% if test.type == 'security' %}
                <!-- Security Test Config -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Backend Tools</h6>
                        {% if test.config.backend_tools %}
                            <ul class="list-unstyled">
                                {% for tool in test.config.backend_tools %}
                                <li class="mb-1">
                                    <i class="fas fa-check text-success"></i>
                                    <strong>{{ tool.tool_name|title }}</strong>
                                    {% if tool.options %}
                                        <div class="ml-3 text-muted small">
                                            {% for key, value in tool.options.items() %}
                                                {{ key }}: {{ value }}<br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No backend tools selected</p>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-info">Frontend Tools</h6>
                        {% if test.config.frontend_tools %}
                            <ul class="list-unstyled">
                                {% for tool in test.config.frontend_tools %}
                                <li class="mb-1">
                                    <i class="fas fa-check text-success"></i>
                                    <strong>{{ tool.tool_name|title }}</strong>
                                    {% if tool.options %}
                                        <div class="ml-3 text-muted small">
                                            {% for key, value in tool.options.items() %}
                                                {{ key }}: {{ value }}<br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No frontend tools selected</p>
                        {% endif %}
                    </div>
                </div>
                
            {% elif test.type == 'zap' %}
                <!-- ZAP Test Config -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Scan Type:</strong> {{ test.config.scan_type|title }}</p>
                        <p><strong>Target URL:</strong> {{ test.config.target_url }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if test.config.options %}
                        <p><strong>Options:</strong></p>
                        <ul class="list-unstyled">
                            {% for key, value in test.config.options.items() %}
                            <li><strong>{{ key }}:</strong> {{ value }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                
            {% elif test.type == 'performance' %}
                <!-- Performance Test Config -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Target URL:</strong> {{ test.config.target_url }}</p>
                        <p><strong>Users:</strong> {{ test.config.users or 'Default' }}</p>
                        <p><strong>Duration:</strong> {{ test.config.duration or 'Default' }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if test.config.scenarios %}
                        <p><strong>Test Scenarios:</strong></p>
                        <ul>
                            {% for scenario in test.config.scenarios %}
                            <li>{{ scenario }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            
            <!-- Common Config -->
            {% if test.config.target_models or test.config.target_apps %}
            <div class="mt-3">
                <h6>Target Selection</h6>
                <div class="row">
                    {% if test.config.target_models %}
                    <div class="col-md-6">
                        <p><strong>Models:</strong> {{ test.config.target_models|length }} selected</p>
                        <div class="small text-muted">
                            {% for model in test.config.target_models[:5] %}
                                {{ model }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if test.config.target_models|length > 5 %}
                                ... and {{ test.config.target_models|length - 5 }} more
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if test.config.target_apps %}
                    <div class="col-md-6">
                        <p><strong>Apps:</strong> {{ test.config.target_apps|length }} selected</p>
                        <div class="small text-muted">
                            {% for app in test.config.target_apps[:10] %}
                                app{{ app }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if test.config.target_apps|length > 10 %}
                                ... and {{ test.config.target_apps|length - 10 }} more
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Live Output/Logs -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-terminal mr-2"></i>
                Live Container Output
            </h6>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" 
                        hx-get="/testing/api/test/{{ test.job_id }}/logs"
                        hx-target="#live-logs-container"
                        hx-swap="innerHTML"
                        title="Refresh Logs">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="auto-refresh-logs" 
                           onchange="toggleAutoRefresh(this.checked)">
                    <label class="form-check-label small" for="auto-refresh-logs">
                        Auto-refresh
                    </label>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="live-logs-container" style="max-height: 400px; overflow-y: auto;">
                {% if test.live_logs %}
                    <div class="logs-output bg-dark text-light p-3">
                        {% for log_entry in test.live_logs %}
                        <div class="log-entry mb-1">
                            <span class="text-muted small">{{ log_entry.timestamp[:19] }}</span>
                            <span class="badge badge-{{ 'danger' if log_entry.level == 'ERROR' else 'warning' if log_entry.level == 'WARN' else 'info' if log_entry.level == 'INFO' else 'secondary' }}">
                                {{ log_entry.level }}
                            </span>
                            <span class="text-primary small">[{{ log_entry.source }}]</span>
                            <span class="log-message">{{ log_entry.message }}</span>
                            {% if log_entry.details %}
                            <div class="text-muted small ml-4">{{ log_entry.details }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% elif test.output or test.logs %}
                    <pre class="bg-dark text-light p-3 m-0">{{ test.output or test.logs }}</pre>
                {% else %}
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-clock mr-2"></i>
                        Waiting for container output...
                        <div class="spinner-border spinner-border-sm mt-2" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Advanced Metrics (if available) -->
    {% if test.status == 'running' %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-area mr-2"></i>
                        Live Analysis Metrics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="metric-box text-center">
                                <div class="metric-value text-primary">
                                    {{ test.progress.items_processed or 0 }}
                                </div>
                                <div class="metric-label small text-muted">Files Scanned</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box text-center">
                                <div class="metric-value text-warning">
                                    {{ test.findings_count or 0 }}
                                </div>
                                <div class="metric-label small text-muted">Issues Found</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box text-center">
                                <div class="metric-value text-info">
                                    {{ test.tools|length if test.tools else 0 }}
                                </div>
                                <div class="metric-label small text-muted">Tools Running</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box text-center">
                                <div class="metric-value text-success">
                                    {{ ((test.runtime_seconds or 0) / 60)|round(1) }}m
                                </div>
                                <div class="metric-label small text-muted">Runtime</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal-footer">
    <div class="btn-group" role="group">
        {% if test.status == 'running' %}
        <button type="button" class="btn btn-warning"
                hx-post="/testing/test/{{ test.id }}/cancel"
                hx-target="#testDetailsModal .modal-content"
                hx-confirm="Are you sure you want to cancel this test?">
            <i class="fas fa-stop"></i> Cancel Test
        </button>
        {% endif %}
        
        {% if test.status in ['completed', 'failed'] %}
        <button type="button" class="btn btn-primary"
                hx-get="/testing/test/{{ test.id }}/results"
                hx-target="#testResultsModal .modal-content"
                data-toggle="modal" data-target="#testResultsModal"
                data-dismiss="modal">
            <i class="fas fa-chart-bar"></i> View Results
        </button>
        {% endif %}
        
        <button type="button" class="btn btn-info"
                hx-get="/testing/test/{{ test.id }}/download"
                hx-target="_blank">
            <i class="fas fa-download"></i> Download Report
        </button>
        
        <button type="button" class="btn btn-danger"
                hx-delete="/testing/test/{{ test.id }}"
                hx-target="#security-testing-jobs"
                hx-swap="outerHTML"
                hx-confirm="Are you sure you want to delete this test?"
                data-dismiss="modal">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
    
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
</div>
