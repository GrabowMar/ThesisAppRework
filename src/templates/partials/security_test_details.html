<!-- Security Test Details Partial -->
<div class="modal-header">
    <h5 class="modal-title">
        <i class="fas fa-shield-alt mr-2"></i>
        Test Details: {{ test.name or test.id }}
    </h5>
    <button type="button" class="close" data-dismiss="modal">
        <span>&times;</span>
    </button>
</div>

<div class="modal-body">
    <!-- Test Overview -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Test Information</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Test ID:</strong></td>
                            <td>{{ test.id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Type:</strong></td>
                            <td>
                                {% if test.type == 'security' %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-shield-alt"></i> Security
                                    </span>
                                {% elif test.type == 'performance' %}
                                    <span class="badge badge-info">
                                        <i class="fas fa-tachometer-alt"></i> Performance
                                    </span>
                                {% elif test.type == 'zap' %}
                                    <span class="badge badge-warning">
                                        <i class="fas fa-spider"></i> ZAP Scan
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ test.type|title }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                {% if test.status == 'running' %}
                                    <span class="badge badge-primary">
                                        <i class="fas fa-spinner fa-spin"></i> Running
                                    </span>
                                {% elif test.status == 'completed' %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-check"></i> Completed
                                    </span>
                                {% elif test.status == 'failed' %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-times"></i> Failed
                                    </span>
                                {% elif test.status == 'pending' %}
                                    <span class="badge badge-warning">
                                        <i class="fas fa-clock"></i> Pending
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ test.status|title }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>{{ test.created_at.strftime('%Y-%m-%d %H:%M:%S') if test.created_at else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Duration:</strong></td>
                            <td>
                                {% if test.started_at and test.completed_at %}
                                    {{ ((test.completed_at - test.started_at).total_seconds() / 60)|round(2) }} minutes
                                {% elif test.started_at %}
                                    {{ ((moment.utcnow() - test.started_at).total_seconds() / 60)|round(2) }} minutes (ongoing)
                                {% else %}
                                    Not started
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Progress</h6>
                </div>
                <div class="card-body">
                    {% if test.progress %}
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ test.progress.percentage or 0 }}%"
                                 aria-valuenow="{{ test.progress.percentage or 0 }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ test.progress.percentage or 0 }}%
                            </div>
                        </div>
                        
                        {% if test.progress.current_stage %}
                        <p class="mb-2">
                            <strong>Current Stage:</strong> {{ test.progress.current_stage }}
                        </p>
                        {% endif %}
                        
                        {% if test.progress.stages %}
                        <div class="small">
                            <strong>Stages:</strong>
                            <ul class="mb-0">
                                {% for stage in test.progress.stages %}
                                <li class="{{ 'text-success' if stage.completed else 'text-muted' }}">
                                    {% if stage.completed %}
                                        <i class="fas fa-check text-success"></i>
                                    {% else %}
                                        <i class="fas fa-circle text-muted"></i>
                                    {% endif %}
                                    {{ stage.name }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle"></i>
                            No progress information available
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration Details -->
    {% if test.config %}
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-cog mr-2"></i>
                Test Configuration
            </h6>
        </div>
        <div class="card-body">
            {% if test.type == 'security' %}
                <!-- Security Test Config -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Backend Tools</h6>
                        {% if test.config.backend_tools %}
                            <ul class="list-unstyled">
                                {% for tool in test.config.backend_tools %}
                                <li class="mb-1">
                                    <i class="fas fa-check text-success"></i>
                                    <strong>{{ tool.tool_name|title }}</strong>
                                    {% if tool.options %}
                                        <div class="ml-3 text-muted small">
                                            {% for key, value in tool.options.items() %}
                                                {{ key }}: {{ value }}<br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No backend tools selected</p>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-info">Frontend Tools</h6>
                        {% if test.config.frontend_tools %}
                            <ul class="list-unstyled">
                                {% for tool in test.config.frontend_tools %}
                                <li class="mb-1">
                                    <i class="fas fa-check text-success"></i>
                                    <strong>{{ tool.tool_name|title }}</strong>
                                    {% if tool.options %}
                                        <div class="ml-3 text-muted small">
                                            {% for key, value in tool.options.items() %}
                                                {{ key }}: {{ value }}<br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No frontend tools selected</p>
                        {% endif %}
                    </div>
                </div>
                
            {% elif test.type == 'zap' %}
                <!-- ZAP Test Config -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Scan Type:</strong> {{ test.config.scan_type|title }}</p>
                        <p><strong>Target URL:</strong> {{ test.config.target_url }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if test.config.options %}
                        <p><strong>Options:</strong></p>
                        <ul class="list-unstyled">
                            {% for key, value in test.config.options.items() %}
                            <li><strong>{{ key }}:</strong> {{ value }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                
            {% elif test.type == 'performance' %}
                <!-- Performance Test Config -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Target URL:</strong> {{ test.config.target_url }}</p>
                        <p><strong>Users:</strong> {{ test.config.users or 'Default' }}</p>
                        <p><strong>Duration:</strong> {{ test.config.duration or 'Default' }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if test.config.scenarios %}
                        <p><strong>Test Scenarios:</strong></p>
                        <ul>
                            {% for scenario in test.config.scenarios %}
                            <li>{{ scenario }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            
            <!-- Common Config -->
            {% if test.config.target_models or test.config.target_apps %}
            <div class="mt-3">
                <h6>Target Selection</h6>
                <div class="row">
                    {% if test.config.target_models %}
                    <div class="col-md-6">
                        <p><strong>Models:</strong> {{ test.config.target_models|length }} selected</p>
                        <div class="small text-muted">
                            {% for model in test.config.target_models[:5] %}
                                {{ model }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if test.config.target_models|length > 5 %}
                                ... and {{ test.config.target_models|length - 5 }} more
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if test.config.target_apps %}
                    <div class="col-md-6">
                        <p><strong>Apps:</strong> {{ test.config.target_apps|length }} selected</p>
                        <div class="small text-muted">
                            {% for app in test.config.target_apps[:10] %}
                                app{{ app }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if test.config.target_apps|length > 10 %}
                                ... and {{ test.config.target_apps|length - 10 }} more
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Live Output/Logs -->
    {% if test.output or test.logs %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-terminal mr-2"></i>
                Live Output
            </h6>
            <button class="btn btn-sm btn-outline-secondary" 
                    hx-get="/testing/test/{{ test.id }}/logs"
                    hx-target="#test-output"
                    hx-swap="innerHTML">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="card-body">
            <div id="test-output" style="max-height: 300px; overflow-y: auto;">
                <pre class="bg-dark text-light p-3 rounded">{% if test.output %}{{ test.output }}{% elif test.logs %}{{ test.logs }}{% else %}No output available{% endif %}</pre>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal-footer">
    <div class="btn-group" role="group">
        {% if test.status == 'running' %}
        <button type="button" class="btn btn-warning"
                hx-post="/testing/test/{{ test.id }}/cancel"
                hx-target="#testDetailsModal .modal-content"
                hx-confirm="Are you sure you want to cancel this test?">
            <i class="fas fa-stop"></i> Cancel Test
        </button>
        {% endif %}
        
        {% if test.status in ['completed', 'failed'] %}
        <button type="button" class="btn btn-primary"
                hx-get="/testing/test/{{ test.id }}/results"
                hx-target="#testResultsModal .modal-content"
                data-toggle="modal" data-target="#testResultsModal"
                data-dismiss="modal">
            <i class="fas fa-chart-bar"></i> View Results
        </button>
        {% endif %}
        
        <button type="button" class="btn btn-info"
                hx-get="/testing/test/{{ test.id }}/download"
                hx-target="_blank">
            <i class="fas fa-download"></i> Download Report
        </button>
        
        <button type="button" class="btn btn-danger"
                hx-delete="/testing/test/{{ test.id }}"
                hx-target="#security-testing-jobs"
                hx-swap="outerHTML"
                hx-confirm="Are you sure you want to delete this test?"
                data-dismiss="modal">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
    
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
</div>
