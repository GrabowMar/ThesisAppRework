<!-- Enhanced Analysis Results Partial -->
<div class="analysis-results-container">
    {% if analysis_running %}
    <div class="analysis-progress-card card border-primary">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-cog fa-spin text-primary"></i>
                    Analysis In Progress
                </h5>
                <span class="badge badge-primary">{{ progress_percentage }}%</span>
            </div>
            
            <div class="progress mb-3" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     style="width: {{ progress_percentage }}%"></div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">Current Phase:</small>
                    <div class="font-weight-bold">{{ current_phase or 'Initializing...' }}</div>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">Elapsed Time:</small>
                    <div class="font-weight-bold">{{ elapsed_time or '0s' }}</div>
                </div>
            </div>
            
            {% if current_tool %}
            <div class="mt-2">
                <small class="text-muted">Running Tool:</small>
                <span class="badge badge-info">{{ current_tool }}</span>
            </div>
            {% endif %}
            
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        hx-post="/analysis/stop/{{ model }}/{{ app_num }}"
                        hx-target="#analysis-results"
                        onclick="return confirm('Are you sure you want to stop the analysis?')">
                    <i class="fas fa-stop"></i> Stop Analysis
                </button>
            </div>
        </div>
    </div>
    {% elif results %}
    
    <!-- Analysis Results -->
    <div class="analysis-results">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-left-danger">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                    Critical Issues
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {{ results.summary.critical_count or 0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-left-warning">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    High Issues
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {{ results.summary.high_count or 0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-left-info">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-info-circle fa-2x text-info"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Medium Issues
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {{ results.summary.medium_count or 0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-left-success">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-clock fa-2x text-success"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Duration
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {{ "%.1f"|format(results.duration_seconds or 0) }}s
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tool Results Tabs -->
        <div class="card shadow">
            <div class="card-header py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-search"></i> Analysis Results
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary"
                                hx-get="/analysis/export/{{ model }}/{{ app_num }}?format=json"
                                hx-target="#download-trigger">
                            <i class="fas fa-download"></i> JSON
                        </button>
                        <button type="button" class="btn btn-outline-secondary"
                                hx-get="/analysis/export/{{ model }}/{{ app_num }}?format=csv"
                                hx-target="#download-trigger">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                                hx-get="/analysis/report/{{ model }}/{{ app_num }}"
                                hx-target="#modal-container">
                            <i class="fas fa-chart-bar"></i> Report
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                {% if results.by_tool %}
                <!-- Tool Navigation -->
                <ul class="nav nav-tabs" role="tablist">
                    {% for tool_name, tool_results in results.by_tool.items() %}
                    <li class="nav-item">
                        <a class="nav-link {% if loop.first %}active{% endif %}" 
                           data-toggle="tab" 
                           href="#{{ tool_name }}-results" 
                           role="tab">
                            <span class="mr-2">{{ tool_name|title }}</span>
                            {% set issue_count = tool_results.issues|length %}
                            {% if issue_count > 0 %}
                                {% set max_severity = tool_results.issues|map(attribute='severity')|list|max %}
                                {% if max_severity == 'HIGH' %}
                                    <span class="badge badge-danger">{{ issue_count }}</span>
                                {% elif max_severity == 'MEDIUM' %}
                                    <span class="badge badge-warning">{{ issue_count }}</span>
                                {% else %}
                                    <span class="badge badge-info">{{ issue_count }}</span>
                                {% endif %}
                            {% else %}
                                <span class="badge badge-success">âœ“</span>
                            {% endif %}
                        </a>
                    </li>
                    {% endfor %}
                </ul>

                <!-- Tool Results Content -->
                <div class="tab-content">
                    {% for tool_name, tool_results in results.by_tool.items() %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                         id="{{ tool_name }}-results" 
                         role="tabpanel">
                        
                        <div class="p-3">
                            {% if tool_results.issues %}
                            <!-- Issues Table -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Severity</th>
                                            <th>File</th>
                                            <th>Line</th>
                                            <th>Issue</th>
                                            <th>Rule</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for issue in tool_results.issues %}
                                        <tr class="issue-row" data-severity="{{ issue.severity }}">
                                            <td>
                                                {% if issue.severity == 'HIGH' %}
                                                    <span class="badge badge-danger">{{ issue.severity }}</span>
                                                {% elif issue.severity == 'MEDIUM' %}
                                                    <span class="badge badge-warning">{{ issue.severity }}</span>
                                                {% elif issue.severity == 'LOW' %}
                                                    <span class="badge badge-info">{{ issue.severity }}</span>
                                                {% else %}
                                                    <span class="badge badge-secondary">{{ issue.severity }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <code class="text-muted">{{ issue.filename }}</code>
                                            </td>
                                            <td>
                                                {% if issue.line_number %}
                                                    <span class="badge badge-light">{{ issue.line_number }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="issue-description">
                                                    <strong>{{ issue.issue_text }}</strong>
                                                    {% if issue.fix_suggestion %}
                                                    <br><small class="text-muted">
                                                        <i class="fas fa-lightbulb"></i> {{ issue.fix_suggestion }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if issue.rule_id %}
                                                    <code class="small">{{ issue.rule_id }}</code>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    {% if issue.code %}
                                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                                            data-toggle="modal" 
                                                            data-target="#code-modal"
                                                            data-code="{{ issue.code }}"
                                                            data-file="{{ issue.filename }}"
                                                            data-line="{{ issue.line_number }}">
                                                        <i class="fas fa-code"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                                            data-toggle="tooltip"
                                                            title="Mark as reviewed">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <!-- No Issues Found -->
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-success">No Issues Found</h5>
                                <p class="text-muted">
                                    {{ tool_name|title }} analysis completed successfully with no issues detected.
                                </p>
                            </div>
                            {% endif %}
                            
                            {% if tool_results.output %}
                            <!-- Tool Output -->
                            <div class="mt-4">
                                <h6 class="text-muted">Tool Output</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <pre class="mb-0"><code>{{ tool_results.output }}</code></pre>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- No Results -->
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Analysis Results</h5>
                    <p class="text-muted">Analysis has not been run or no tools produced results.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Analysis Run Yet -->
    <div class="text-center py-5">
        <i class="fas fa-play-circle fa-3x text-primary mb-3"></i>
        <h5>Ready to Analyze</h5>
        <p class="text-muted mb-4">
            Start an analysis to see security and quality insights for this application.
        </p>
        <button type="button" class="btn btn-primary" 
                hx-post="/analysis/quick" 
                hx-vals='{"model": "{{ model }}", "app_number": "{{ app_num }}", "analysis_types": ["backend_security", "frontend_security"]}'
                hx-target="#analysis-results"
                hx-indicator="#quick-analysis-loading">
            <i class="fas fa-play"></i> Start Quick Analysis
            <div id="quick-analysis-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
        </button>
    </div>
    {% endif %}
</div>

<!-- Code Viewer Modal -->
<div class="modal fade" id="code-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-code"></i> Code Context
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="code-content">
                    <p class="text-muted">Loading code context...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Download trigger (hidden) -->
<div id="download-trigger" style="display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Code modal handler
    $('#code-modal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const code = button.data('code');
        const file = button.data('file');
        const line = button.data('line');
        
        const modal = $(this);
        modal.find('.modal-title').html(`<i class="fas fa-code"></i> ${file}:${line}`);
        modal.find('#code-content').html(`<pre><code>${code}</code></pre>`);
    });
    
    // Auto-refresh if analysis is running
    {% if analysis_running %}
    setTimeout(function() {
        htmx.trigger('#analysis-results', 'refresh');
    }, 5000);
    {% endif %}
    
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
});
</script>

<style>
.issue-row:hover {
    background-color: #f8f9fa;
}

.issue-description {
    max-width: 300px;
}

.nav-tabs .nav-link {
    border-bottom: 3px solid transparent;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #007bff;
}

.analysis-progress-card {
    border-left: 4px solid #007bff;
}
</style>
