{% if jobs %}
<div class="table-responsive">
    <table class="table table-striped table-hover mb-0">
        <thead class="thead-light">
            <tr>
                <th style="width: 40px;">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" 
                               id="select-all-jobs" onchange="selectAllJobs()">
                        <label class="custom-control-label" for="select-all-jobs"></label>
                    </div>
                </th>
                <th>Job Name</th>
                <th>Status</th>
                <th>Analysis Type</th>
                <th>Progress</th>
                <th>Duration</th>
                <th>Created</th>
                <th style="width: 200px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr class="job-row" 
                data-job-id="{{ job.id }}"
                data-status="{{ job.status }}"
                data-analysis-types="{{ job.analysis_types|join(',') if job.analysis_types else '' }}"
                data-job-name="{{ job.name }}">
                
                <!-- Selection Checkbox -->
                <td>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input job-checkbox" 
                               id="job-{{ job.id }}" value="{{ job.id }}"
                               onchange="toggleJobSelection()">
                        <label class="custom-control-label" for="job-{{ job.id }}"></label>
                    </div>
                </td>
                
                <!-- Job Name -->
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="font-weight-bold">
                                {{ job.name|truncate(50) }}
                            </div>
                            {% if job.description %}
                            <small class="text-muted">
                                {{ job.description|truncate(80) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </td>
                
                <!-- Status -->
                <td>
                    {% set status = job.status %}
                    {% if status == 'completed' %}
                        <span class="badge badge-success">{{ status|title }}</span>
                    {% elif status == 'running' %}
                        <span class="badge badge-primary">
                            <i class="fas fa-spinner fa-spin mr-1"></i>{{ status|title }}
                        </span>
                    {% elif status == 'failed' %}
                        <span class="badge badge-danger">{{ status|title }}</span>
                    {% elif status == 'cancelled' %}
                        <span class="badge badge-warning">{{ status|title }}</span>
                    {% elif status == 'pending' %}
                        <span class="badge badge-secondary">{{ status|title }}</span>
                    {% else %}
                        <span class="badge badge-light">{{ status|title }}</span>
                    {% endif %}
                </td>
                
                <!-- Analysis Type -->
                <td>
                    {% if job.analysis_types %}
                        {% for analysis_type in job.analysis_types[:2] %}
                            <span class="badge badge-outline-primary mr-1">
                                {{ analysis_type|replace('_', ' ')|title }}
                            </span>
                        {% endfor %}
                        {% if job.analysis_types|length > 2 %}
                            <span class="badge badge-outline-secondary">
                                +{{ job.analysis_types|length - 2 }} more
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Progress -->
                <td>
                    {% if job.total_tasks and job.total_tasks > 0 %}
                        <div class="progress" style="height: 20px;" id="progress-{{ job.id }}">
                            {% set percent = job.progress_percentage|default(0) %}
                            <div class="progress-bar bg-info" 
                                 role="progressbar" 
                                 style="width: {{ percent }}%"
                                 aria-valuenow="{{ job.completed_tasks|default(0) }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ job.total_tasks }}">
                                {{ job.completed_tasks|default(0) }}/{{ job.total_tasks }}
                            </div>
                        </div>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Duration -->
                <td>
                    {% if job.actual_duration_seconds %}
                        <span class="text-muted">
                            {% set duration = job.actual_duration_seconds %}
                            {% set hours = (duration // 3600)|int %}
                            {% set minutes = ((duration % 3600) // 60)|int %}
                            {% set seconds = (duration % 60)|int %}
                            
                            {% if hours > 0 %}
                                {{ hours }}h {{ minutes }}m
                            {% elif minutes > 0 %}
                                {{ minutes }}m {{ seconds }}s
                            {% else %}
                                {{ seconds }}s
                            {% endif %}
                        </span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Created Date -->
                <td>
                    {% if job.created_at_formatted %}
                        <span class="text-muted" title="{{ job.created_at_full|default('') }}">
                            {{ job.created_at_formatted }}
                        </span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Actions -->
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-info btn-sm"
                                onclick="viewJobDetails('{{ job.id }}')" 
                                title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        
                        {% if job.status == 'pending' %}
                            <button type="button" class="btn btn-outline-success btn-sm"
                                    onclick="startJob('{{ job.id }}')" 
                                    title="Start Job">
                                <i class="fas fa-play"></i>
                            </button>
                        {% endif %}
                        
                        {% if job.status in ['running', 'pending'] %}
                            <button type="button" class="btn btn-outline-warning btn-sm"
                                    onclick="cancelJob('{{ job.id }}')" 
                                    title="Cancel Job">
                                <i class="fas fa-stop"></i>
                            </button>
                        {% endif %}
                        
                        {% if job.status in ['completed', 'failed', 'cancelled'] %}
                            <button type="button" class="btn btn-outline-danger btn-sm"
                                    onclick="deleteJob('{{ job.id }}')" 
                                    title="Delete Job">
                                <i class="fas fa-trash"></i>
                            </button>
                        {% endif %}
                        
                        <!-- Dropdown for more actions -->
                        <div class="btn-group" role="group">
                            <button id="job-actions-{{ job.id }}" 
                                    type="button" 
                                    class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                    data-toggle="dropdown" 
                                    aria-haspopup="true" 
                                    aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" 
                                 aria-labelledby="job-actions-{{ job.id }}">
                                <a class="dropdown-item" href="#" 
                                   onclick="viewJobDetails('{{ job.id }}')">
                                    <i class="fas fa-eye mr-2"></i>View Details
                                </a>
                                {% if job.status == 'completed' %}
                                <a class="dropdown-item" href="/batch/job/{{ job.id }}/results">
                                    <i class="fas fa-download mr-2"></i>Download Results
                                </a>
                                <a class="dropdown-item" href="/batch/job/{{ job.id }}/logs">
                                    <i class="fas fa-file-alt mr-2"></i>View Logs
                                </a>
                                {% endif %}
                                <a class="dropdown-item" href="#" 
                                   onclick="duplicateJob('{{ job.id }}')">
                                    <i class="fas fa-copy mr-2"></i>Duplicate Job
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#" 
                                   onclick="deleteJob('{{ job.id }}')">
                                    <i class="fas fa-trash mr-2"></i>Delete Job
                                </a>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_count > 10 %}
<div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3">
    <div class="text-muted">
        Showing {{ jobs|length }} of {{ total_count }} jobs
    </div>
    <nav aria-label="Jobs pagination">
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">Previous</a>
            </li>
            <li class="page-item active">
                <a class="page-link" href="#">1</a>
            </li>
            <li class="page-item disabled">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="text-center py-5">
    <div class="mb-3">
        <i class="fas fa-tasks fa-3x text-muted"></i>
    </div>
    <h5 class="text-muted">No batch jobs found</h5>
    <p class="text-muted mb-4">
        Create your first batch job to start analyzing applications
    </p>
    <button type="button" class="btn btn-primary" onclick="createNewJob()">
        <i class="fas fa-plus mr-2"></i>
        Create First Job
    </button>
</div>
{% endif %}

<script>
// Additional JavaScript functions for the jobs table

function duplicateJob(jobId) {
    if (!confirm('Create a duplicate of this job?')) {
        return;
    }
    
    fetch(`/api/batch/job/${jobId}/duplicate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            refreshJobs();
            alert('Job duplicated successfully!');
        } else {
            alert('Failed to duplicate job: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error duplicating job:', error);
        alert('Error duplicating job: ' + error.message);
    });
}

// Auto-update job statuses
function updateJobStatuses() {
    const runningJobs = document.querySelectorAll('.job-row[data-status="running"]');
    
    runningJobs.forEach(row => {
        const jobId = row.dataset.jobId;
        
        fetch(`/api/batch/job/${jobId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'running') {
                    // Job status changed, refresh the entire table
                    refreshJobs();
                } else if (data.progress) {
                    // Update progress bar
                    updateProgressBar(jobId, data.progress);
                }
            })
            .catch(error => {
                console.error(`Error updating job ${jobId} status:`, error);
            });
    });
}

// Update running jobs every 5 seconds
setInterval(updateJobStatuses, 5000);
</script>
