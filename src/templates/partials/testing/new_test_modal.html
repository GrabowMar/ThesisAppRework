<div class="modal fade" id="newTestModal" tabindex="-1" aria-labelledby="newTestModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen-lg-down modal-xl" style="max-width: 95vw;">
        <div class="modal-content" style="height: 90vh; overflow-y: auto;">
            <div class="modal-header bg-primary text-white">
                <h4 class="modal-title" id="newTestModalLabel">
                    <i class="fas fa-shield-alt me-2"></i>Create Security Test
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="comprehensiveTestForm" hx-post="/testing/api/create" 
                  hx-target="#test-results-container"
                  hx-swap="innerHTML"
                  hx-indicator="#test-loading"
                  hx-on::before-request="handleTestStart(event)"
                  hx-on::after-request="handleTestResponse(event)">
                <div class="modal-body p-3" style="max-height: calc(90vh - 140px); overflow-y: auto;">
                    <div class="container-fluid">
                        <div class="row g-3">
                        <!-- Left Column: Application & Configuration -->
                        <div class="col-lg-6 col-md-12">
                            <!-- Application Selection -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-light py-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-laptop-code text-primary me-2"></i>Target Application
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-2">
                                        <label class="form-label fw-semibold small">Select Application</label>
                                        <select class="form-select" name="app_id" id="appSelect" required
                                                onchange="loadAppDetails(this.value)">
                                            <option value="">Choose target application...</option>
                                            {% for app in applications %}
                                            <option value="{{ app.id }}" 
                                                    data-model="{{ app.model_slug }}" 
                                                    data-app-number="{{ app.app_number }}"
                                                    data-provider="{{ app.provider or 'unknown' }}"
                                                    data-backend-port="{{ app.backend_port or 'N/A' }}"
                                                    data-frontend-port="{{ app.frontend_port or 'N/A' }}">
                                                {{ app.provider | title if app.provider else 'Unknown' }} - 
                                                {{ app.model_slug.split('_')[1] if '_' in app.model_slug else app.model_slug }} 
                                                (App #{{ app.app_number }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- App Details Display -->
                                    <div id="selected-app-details" class="d-none">
                                        <div class="row g-1">
                                            <div class="col-6">
                                                <div class="bg-light p-2 rounded text-center">
                                                    <small class="text-muted d-block">Provider</small>
                                                    <small class="fw-bold" id="app-provider">-</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="bg-light p-2 rounded text-center">
                                                    <small class="text-muted d-block">Model</small>
                                                    <small class="fw-bold" id="app-model">-</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="bg-light p-2 rounded text-center">
                                                    <small class="text-muted d-block">Backend</small>
                                                    <small class="fw-bold" id="app-backend-port">-</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="bg-light p-2 rounded text-center">
                                                    <small class="text-muted d-block">Frontend</small>
                                                    <small class="fw-bold" id="app-frontend-port">-</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Configuration -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-light py-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-cog text-secondary me-2"></i>Configuration
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label fw-semibold small">Priority</label>
                                            <select class="form-select form-select-sm" name="priority">
                                                <option value="normal">Normal</option>
                                                <option value="high">High</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label fw-semibold small">Timeout (min)</label>
                                            <input type="number" class="form-control form-control-sm" name="timeout" value="30" min="5" max="120">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Test Types -->
                        <div class="col-lg-6 col-md-12">
                            <!-- Test Types Selection -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-light py-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-tasks text-info me-2"></i>Analysis Types
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="form-check p-2 border rounded">
                                                <input class="form-check-input" type="checkbox" name="test_types" 
                                                       id="securityAnalysis" value="security" checked
                                                       onchange="toggleTestOptions('security', this.checked)">
                                                <label class="form-check-label w-100" for="securityAnalysis">
                                                    <i class="fas fa-shield-alt text-danger me-2"></i>
                                                    <strong>Security</strong>
                                                    <small class="d-block text-muted">SAST tools</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check p-2 border rounded">
                                                <input class="form-check-input" type="checkbox" name="test_types" 
                                                       id="performanceAnalysis" value="performance"
                                                       onchange="toggleTestOptions('performance', this.checked)">
                                                <label class="form-check-label w-100" for="performanceAnalysis">
                                                    <i class="fas fa-tachometer-alt text-success me-2"></i>
                                                    <strong>Performance</strong>
                                                    <small class="d-block text-muted">Load testing</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check p-2 border rounded">
                                                <input class="form-check-input" type="checkbox" name="test_types" 
                                                       id="zapAnalysis" value="zap"
                                                       onchange="toggleTestOptions('zap', this.checked)">
                                                <label class="form-check-label w-100" for="zapAnalysis">
                                                    <i class="fas fa-search text-warning me-2"></i>
                                                    <strong>ZAP Scanner</strong>
                                                    <small class="d-block text-muted">Dynamic scan</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check p-2 border rounded">
                                                <input class="form-check-input" type="checkbox" name="test_types" 
                                                       id="aiAnalysis" value="ai"
                                                       onchange="toggleTestOptions('ai', this.checked)">
                                                <label class="form-check-label w-100" for="aiAnalysis">
                                                    <i class="fas fa-brain text-info me-2"></i>
                                                    <strong>AI Analysis</strong>
                                                    <small class="d-block text-muted">AI review</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tool Configuration Sections -->
                    <div class="row">
                        <div class="col-12">
                            <!-- Security Tools Options -->
                            <div id="security-options" class="test-options-section">
                                <div class="card shadow-sm mb-3">
                                    <div class="card-header bg-danger text-white py-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-shield-alt me-2"></i>Security Tools
                                        </h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <h6 class="text-primary small">Backend Security</h6>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="bandit" id="tool-bandit" checked>
                                                    <label class="form-check-label small" for="tool-bandit">
                                                        <strong>Bandit</strong> - Python security
                                                    </label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="safety" id="tool-safety" checked>
                                                    <label class="form-check-label small" for="tool-safety">
                                                        <strong>Safety</strong> - Dependencies
                                                    </label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="pylint" id="tool-pylint" checked>
                                                    <label class="form-check-label small" for="tool-pylint">
                                                        <strong>Pylint</strong> - Code quality
                                                    </label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="semgrep" id="tool-semgrep">
                                                    <label class="form-check-label small" for="tool-semgrep">
                                                        <strong>Semgrep</strong> - Pattern matching
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-primary small">Frontend Security</h6>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="eslint" id="tool-eslint" checked>
                                                    <label class="form-check-label small" for="tool-eslint">
                                                        <strong>ESLint</strong> - JavaScript
                                                    </label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="retire" id="tool-retire" checked>
                                                    <label class="form-check-label small" for="tool-retire">
                                                        <strong>Retire.js</strong> - Vulnerable libs
                                                    </label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="npm-audit" id="tool-npm-audit" checked>
                                                    <label class="form-check-label small" for="tool-npm-audit">
                                                        <strong>NPM Audit</strong> - Packages
                                                    </label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="security_tools" 
                                                           value="secrets" id="tool-secrets">
                                                    <label class="form-check-label small" for="tool-secrets">
                                                        <strong>Secrets</strong> - API keys
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Test Options -->
                            <div id="performance-options" class="test-options-section d-none">
                                <div class="card shadow-sm mb-3">
                                    <div class="card-header bg-success text-white py-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-tachometer-alt me-2"></i>Performance Configuration
                                        </h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <label class="form-label fw-semibold small">Users</label>
                                                <input type="number" class="form-control form-control-sm" name="perf_users" value="10" min="1" max="1000">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label fw-semibold small">Spawn Rate</label>
                                                <input type="number" class="form-control form-control-sm" name="perf_spawn_rate" value="2" min="1" max="100">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label fw-semibold small">Duration (s)</label>
                                                <input type="number" class="form-control form-control-sm" name="perf_duration" value="60" min="10" max="3600">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ZAP Scanner Options -->
                            <div id="zap-options" class="test-options-section d-none">
                                <div class="card shadow-sm mb-3">
                                    <div class="card-header bg-warning text-dark py-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-search me-2"></i>ZAP Configuration
                                        </h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <label class="form-label fw-semibold small">Scan Type</label>
                                                <select class="form-select form-select-sm" name="zap_scan_type">
                                                    <option value="spider">Spider</option>
                                                    <option value="active">Active</option>
                                                    <option value="passive">Passive</option>
                                                </select>
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label fw-semibold small">Max Depth</label>
                                                <input type="number" class="form-control form-control-sm" name="zap_max_depth" value="5" min="1" max="20">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label fw-semibold small">Max Children</label>
                                                <input type="number" class="form-control form-control-sm" name="zap_max_children" value="50" min="10" max="500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Analysis Options -->
                            <div id="ai-options" class="test-options-section d-none">
                                <div class="card shadow-sm mb-3">
                                    <div class="card-header bg-info text-white py-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-brain me-2"></i>AI Configuration
                                        </h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <label class="form-label fw-semibold small">AI Model</label>
                                                <select class="form-select form-select-sm" name="ai_model">
                                                    <option value="gpt-4">GPT-4</option>
                                                    <option value="claude-3-sonnet">Claude-3</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label fw-semibold small">Focus</label>
                                                <select class="form-select form-select-sm" name="ai_focus">
                                                    <option value="security">Security</option>
                                                    <option value="performance">Performance</option>
                                                    <option value="code_quality">Quality</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer bg-light py-2">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="text-muted">
                            <small><i class="fas fa-info-circle me-1"></i>Tests run by priority</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" id="startTestBtn">
                                <i class="fas fa-rocket me-1"></i>Launch Test
                                <span class="spinner-border spinner-border-sm d-none ms-2" id="test-loading"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
