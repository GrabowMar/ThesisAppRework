<!-- Bandit Security Analysis Results -->
<div class="bandit-results" data-tool="bandit">
    <div class="row">
        <!-- Summary Statistics -->
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Bandit Security Analysis Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-danger">{{ bandit_results.total_issues or 0 }}</h3>
                                <p class="mb-0">Total Issues</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-warning">{{ bandit_results.high_severity or 0 }}</h3>
                                <p class="mb-0">High Severity</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-info">{{ bandit_results.medium_severity or 0 }}</h3>
                                <p class="mb-0">Medium Severity</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-success">{{ bandit_results.low_severity or 0 }}</h3>
                                <p class="mb-0">Low Severity</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="progress-group">
                                <label>Security Score</label>
                                <div class="progress">
                                    <div class="progress-bar {% if bandit_results.security_score >= 80 %}bg-success{% elif bandit_results.security_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         style="width: {{ bandit_results.security_score or 0 }}%">
                                        {{ bandit_results.security_score or 0 }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="progress-group">
                                <label>Files Scanned</label>
                                <p class="mb-0"><strong>{{ bandit_results.files_scanned or 0 }}</strong> files processed</p>
                                <small class="text-muted">Completed in {{ bandit_results.scan_duration or 'N/A' }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Issue Categories Chart -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Issues by Category</h6>
                </div>
                <div class="card-body">
                    <canvas id="banditCategoryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Severity Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="banditSeverityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Issues -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Detailed Security Issues</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="filterByseverity('all')">All</button>
                        <button class="btn btn-outline-danger" onclick="filterByseverity('high')">High</button>
                        <button class="btn btn-outline-warning" onclick="filterByseverity('medium')">Medium</button>
                        <button class="btn btn-outline-info" onclick="filterByseverity('low')">Low</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="banditIssuesTable">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>Test ID</th>
                                    <th>Issue Type</th>
                                    <th>File</th>
                                    <th>Line</th>
                                    <th>Confidence</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in bandit_results.issues %}
                                <tr class="issue-row" data-severity="{{ issue.severity.lower() }}">
                                    <td>
                                        <span class="badge bg-{% if issue.severity == 'HIGH' %}danger{% elif issue.severity == 'MEDIUM' %}warning{% else %}info{% endif %}">
                                            {{ issue.severity }}
                                        </span>
                                    </td>
                                    <td><code>{{ issue.test_id }}</code></td>
                                    <td>{{ issue.issue_type }}</td>
                                    <td>
                                        <a href="#" onclick="showFileContext('{{ issue.filename }}', {{ issue.line_number }})">
                                            {{ issue.filename | basename }}
                                        </a>
                                    </td>
                                    <td>{{ issue.line_number }}</td>
                                    <td>
                                        <span class="badge bg-{% if issue.confidence == 'HIGH' %}success{% elif issue.confidence == 'MEDIUM' %}warning{% else %}secondary{% endif %}">
                                            {{ issue.confidence }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="showIssueDetails('{{ loop.index0 }}')">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Code Context Modal -->
    <div class="modal fade" id="codeContextModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Code Context</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="codeContextContent">
                        <!-- Code will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Issue Details Modal -->
    <div class="modal fade" id="issueDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Issue Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="issueDetailsContent">
                        <!-- Issue details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Bandit results specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    if (typeof banditResults !== 'undefined') {
        initializeBanditCharts();
    }
});

function initializeBanditCharts() {
    // Category Chart
    const categoryCtx = document.getElementById('banditCategoryChart');
    if (categoryCtx && banditResults.categories) {
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(banditResults.categories),
                datasets: [{
                    data: Object.values(banditResults.categories),
                    backgroundColor: [
                        '#dc3545', '#fd7e14', '#ffc107', '#20c997', 
                        '#0dcaf0', '#6f42c1', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Severity Chart
    const severityCtx = document.getElementById('banditSeverityChart');
    if (severityCtx && banditResults.severity_distribution) {
        new Chart(severityCtx, {
            type: 'bar',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: [
                        banditResults.severity_distribution.high || 0,
                        banditResults.severity_distribution.medium || 0,
                        banditResults.severity_distribution.low || 0
                    ],
                    backgroundColor: ['#dc3545', '#ffc107', '#17a2b8']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

function filterByseverity(severity) {
    const rows = document.querySelectorAll('#banditIssuesTable .issue-row');
    rows.forEach(row => {
        if (severity === 'all' || row.dataset.severity === severity) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function showFileContext(filename, lineNumber) {
    // Load file context via AJAX
    fetch(`/api/testing/file-context?file=${encodeURIComponent(filename)}&line=${lineNumber}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('codeContextContent').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('codeContextModal')).show();
        })
        .catch(error => {
            console.error('Error loading file context:', error);
        });
}

function showIssueDetails(issueIndex) {
    if (typeof banditResults !== 'undefined' && banditResults.issues[issueIndex]) {
        const issue = banditResults.issues[issueIndex];
        const detailsHtml = `
            <div class="issue-details">
                <h6>Issue: ${issue.issue_type}</h6>
                <p><strong>Description:</strong> ${issue.issue_text}</p>
                <p><strong>Test ID:</strong> <code>${issue.test_id}</code></p>
                <p><strong>File:</strong> ${issue.filename}</p>
                <p><strong>Line:</strong> ${issue.line_number}</p>
                <p><strong>Confidence:</strong> <span class="badge bg-secondary">${issue.confidence}</span></p>
                <div class="mt-3">
                    <h6>Affected Code:</h6>
                    <pre><code class="language-python">${issue.code}</code></pre>
                </div>
                ${issue.more_info ? `<div class="mt-3">
                    <h6>More Information:</h6>
                    <p>${issue.more_info}</p>
                </div>` : ''}
            </div>
        `;
        
        document.getElementById('issueDetailsContent').innerHTML = detailsHtml;
        
        // Highlight code
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }
        
        new bootstrap.Modal(document.getElementById('issueDetailsModal')).show();
    }
}
</script>
