<!-- ZAP Web Security Analysis Results -->
<div class="zap-results" data-tool="zap">
    <div class="row">
        <!-- Summary Statistics -->
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-globe me-2"></i>ZAP Web Security Analysis Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-danger">{{ zap_results.total_alerts or 0 }}</h3>
                                <p class="mb-0">Total Alerts</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-warning">{{ zap_results.high_risk or 0 }}</h3>
                                <p class="mb-0">High Risk</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-info">{{ zap_results.pages_scanned or 0 }}</h3>
                                <p class="mb-0">Pages Scanned</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h3 class="text-success">{{ zap_results.scan_coverage or 0 }}%</h3>
                                <p class="mb-0">Coverage</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="progress-group">
                                <label>Security Rating</label>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: {{ zap_results.security_rating or 0 }}%">
                                        {{ zap_results.security_rating or 0 }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="progress-group">
                                <label>Scan Information</label>
                                <p class="mb-0"><strong>Duration:</strong> {{ zap_results.scan_duration or 'N/A' }}</p>
                                <small class="text-muted">Target: {{ zap_results.target_url or 'N/A' }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Risk and Category Charts -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Risk Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="zapRiskChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Alert Categories</h6>
                </div>
                <div class="card-body">
                    <canvas id="zapCategoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scan Coverage Map -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Scan Coverage Map</h6>
                </div>
                <div class="card-body">
                    <div class="coverage-map">
                        {% for url in zap_results.scanned_urls %}
                        <div class="url-item d-flex justify-content-between align-items-center p-2 border-bottom">
                            <div>
                                <strong>{{ url.path }}</strong>
                                <small class="text-muted d-block">{{ url.method }} - {{ url.status_code }}</small>
                            </div>
                            <div>
                                <span class="badge bg-{{ 'danger' if url.alerts > 0 else 'success' }}">
                                    {{ url.alerts }} alerts
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Alerts -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Security Alerts</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" onclick="filterAlerts('all')">All</button>
                        <button class="btn btn-outline-danger" onclick="filterAlerts('high')">High</button>
                        <button class="btn btn-outline-warning" onclick="filterAlerts('medium')">Medium</button>
                        <button class="btn btn-outline-info" onclick="filterAlerts('low')">Low</button>
                        <button class="btn btn-outline-secondary" onclick="filterAlerts('informational')">Info</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if zap_results.alerts %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="zapAlertsTable">
                            <thead>
                                <tr>
                                    <th>Risk</th>
                                    <th>Alert</th>
                                    <th>URL</th>
                                    <th>Confidence</th>
                                    <th>Instances</th>
                                    <th>Solution</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in zap_results.alerts %}
                                <tr class="alert-row" data-risk="{{ alert.risk.lower() }}">
                                    <td>
                                        <span class="badge bg-{{ 'danger' if alert.risk == 'High' else ('warning' if alert.risk == 'Medium' else ('info' if alert.risk == 'Low' else 'secondary')) }}">
                                            {{ alert.risk }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ alert.name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ alert.description[:50] }}...</small>
                                    </td>
                                    <td>
                                        <a href="{{ alert.url }}" target="_blank" rel="noopener">
                                            {{ alert.url | truncate(40) }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if alert.confidence == 'High' else ('warning' if alert.confidence == 'Medium' else 'secondary') }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td>{{ alert.instances | length }}</td>
                                    <td>
                                        {% if alert.solution %}
                                        <button class="btn btn-sm btn-outline-success" onclick="showSolution('{{ loop.index0 }}')">
                                            <i class="fas fa-lightbulb"></i> View
                                        </button>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="showAlertDetails('{{ loop.index0 }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-info" onclick="showInstances('{{ loop.index0 }}')">
                                                <i class="fas fa-list"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>No security alerts found!</strong> The web application appears to be secure.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- OWASP Top 10 Compliance -->
    {% if zap_results.owasp_compliance %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">OWASP Top 10 Compliance</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for item in zap_results.owasp_compliance %}
                        <div class="col-md-6 mb-3">
                            <div class="compliance-item d-flex justify-content-between align-items-center p-3 border rounded">
                                <div>
                                    <strong>{{ item.category }}</strong>
                                    <br>
                                    <small class="text-muted">{{ item.description }}</small>
                                </div>
                                <div class="compliance-status">
                                    {% if item.status == 'pass' %}
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                    {% elif item.status == 'warning' %}
                                    <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                                    {% else %}
                                    <i class="fas fa-times-circle text-danger fa-2x"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Alert Details Modal -->
    <div class="modal fade" id="alertDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alert Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="alertDetailsContent">
                        <!-- Alert details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Solution Modal -->
    <div class="modal fade" id="solutionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Solution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="solutionContent">
                        <!-- Solution will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instances Modal -->
    <div class="modal fade" id="instancesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alert Instances</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="instancesContent">
                        <!-- Instances will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ZAP results specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    if (typeof zapResults !== 'undefined') {
        initializeZapCharts();
    }
});

function initializeZapCharts() {
    // Risk Chart
    const riskCtx = document.getElementById('zapRiskChart');
    if (riskCtx && zapResults.risk_distribution) {
        new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['High', 'Medium', 'Low', 'Informational'],
                datasets: [{
                    data: [
                        zapResults.risk_distribution.high || 0,
                        zapResults.risk_distribution.medium || 0,
                        zapResults.risk_distribution.low || 0,
                        zapResults.risk_distribution.informational || 0
                    ],
                    backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Category Chart
    const categoryCtx = document.getElementById('zapCategoryChart');
    if (categoryCtx && zapResults.categories) {
        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(zapResults.categories),
                datasets: [{
                    data: Object.values(zapResults.categories),
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

function filterAlerts(risk) {
    const rows = document.querySelectorAll('#zapAlertsTable .alert-row');
    rows.forEach(row => {
        if (risk === 'all' || row.dataset.risk === risk) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function showAlertDetails(alertIndex) {
    if (typeof zapResults !== 'undefined' && zapResults.alerts[alertIndex]) {
        const alert = zapResults.alerts[alertIndex];
        const detailsHtml = `
            <div class="alert-details">
                <h6>${alert.name} - ${alert.risk} Risk</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Risk:</strong> <span class="badge bg-danger">${alert.risk}</span></p>
                        <p><strong>Confidence:</strong> <span class="badge bg-success">${alert.confidence}</span></p>
                        <p><strong>URL:</strong> <a href="${alert.url}" target="_blank">${alert.url}</a></p>
                        <p><strong>Parameter:</strong> ${alert.param || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>CWE ID:</strong> ${alert.cweid || 'N/A'}</p>
                        <p><strong>WASC ID:</strong> ${alert.wascid || 'N/A'}</p>
                        <p><strong>Plugin ID:</strong> ${alert.pluginid}</p>
                        <p><strong>Source:</strong> ${alert.sourceid || 'N/A'}</p>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Description:</h6>
                    <p>${alert.description}</p>
                </div>
                ${alert.evidence ? `<div class="mt-3">
                    <h6>Evidence:</h6>
                    <pre><code>${alert.evidence}</code></pre>
                </div>` : ''}
                ${alert.reference ? `<div class="mt-3">
                    <h6>References:</h6>
                    <p>${alert.reference}</p>
                </div>` : ''}
            </div>
        `;
        
        document.getElementById('alertDetailsContent').innerHTML = detailsHtml;
        new bootstrap.Modal(document.getElementById('alertDetailsModal')).show();
    }
}

function showSolution(alertIndex) {
    if (typeof zapResults !== 'undefined' && zapResults.alerts[alertIndex]) {
        const alert = zapResults.alerts[alertIndex];
        const solutionHtml = `
            <div class="solution-details">
                <h6>Solution for: ${alert.name}</h6>
                <p>${alert.solution}</p>
                ${alert.other ? `<div class="mt-3">
                    <h6>Additional Information:</h6>
                    <p>${alert.other}</p>
                </div>` : ''}
            </div>
        `;
        
        document.getElementById('solutionContent').innerHTML = solutionHtml;
        new bootstrap.Modal(document.getElementById('solutionModal')).show();
    }
}

function showInstances(alertIndex) {
    if (typeof zapResults !== 'undefined' && zapResults.alerts[alertIndex]) {
        const alert = zapResults.alerts[alertIndex];
        let instancesHtml = `<h6>Instances for: ${alert.name}</h6>`;
        
        if (alert.instances && alert.instances.length > 0) {
            instancesHtml += '<div class="instances-list">';
            alert.instances.forEach((instance, index) => {
                instancesHtml += `
                    <div class="instance-item p-3 border-bottom">
                        <p><strong>URL:</strong> <a href="${instance.uri}" target="_blank">${instance.uri}</a></p>
                        <p><strong>Method:</strong> ${instance.method || 'GET'}</p>
                        ${instance.param ? `<p><strong>Parameter:</strong> ${instance.param}</p>` : ''}
                        ${instance.evidence ? `<p><strong>Evidence:</strong> <code>${instance.evidence}</code></p>` : ''}
                    </div>
                `;
            });
            instancesHtml += '</div>';
        } else {
            instancesHtml += '<p>No specific instances available.</p>';
        }
        
        document.getElementById('instancesContent').innerHTML = instancesHtml;
        new bootstrap.Modal(document.getElementById('instancesModal')).show();
    }
}
</script>
