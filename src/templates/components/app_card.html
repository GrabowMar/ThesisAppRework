<!-- Application Status Card Component -->
{% set app = app or {} %}
{% set model = model or app.get('model', 'unknown') %}
{% set app_num = app_num or app.get('app_num', 0) %}
{% set status = status or app.get('status', 'unknown') %}
{% set container_statuses = container_statuses or app.get('container_statuses', {}) %}

<article class="app-card" 
         data-model="{{ model }}" 
         data-app-num="{{ app_num }}"
         role="article"
         aria-labelledby="app-title-{{ model }}-{{ app_num }}">
    
    <!-- Card Header -->
    <header class="app-card-header">
        <div class="app-card-title-section">
            <h3 class="app-card-title" id="app-title-{{ model }}-{{ app_num }}">
                <a href="{{ url_for('main.app_details', model=model, app_num=app_num) }}"
                   class="app-link"
                   hx-get="{{ url_for('main.app_details', model=model, app_num=app_num) }}"
                   hx-target="#main-content"
                   hx-push-url="true">
                    {{ app.get('title', f'{model} App {app_num}') }}
                </a>
            </h3>
            <p class="app-card-subtitle">
                {{ app.get('description', f'Application #{app_num}') }}
            </p>
        </div>
        
        <!-- Overall Status Badge -->
        {% include 'components/status_badge.html' %}
    </header>
    
    <!-- Card Meta Information -->
    <div class="app-card-meta">
        <div class="meta-row">
            <span class="meta-label">Model:</span>
            <span class="meta-value">{{ model.replace('_', ' ').title() }}</span>
        </div>
        <div class="meta-row">
            <span class="meta-label">Type:</span>
            <span class="meta-value">{{ app.get('type_name', f'App {app_num}') }}</span>
        </div>
        <div class="meta-row">
            <span class="meta-label">Ports:</span>
            <span class="meta-value">
                {% if app.get('frontend_port') %}
                    <a href="http://localhost:{{ app.frontend_port }}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="port-link"
                       title="Open frontend">
                        {{ app.frontend_port }}
                    </a>
                {% endif %}
                {% if app.get('backend_port') %}
                    / <a href="http://localhost:{{ app.backend_port }}" 
                         target="_blank" 
                         rel="noopener noreferrer"
                         class="port-link"
                         title="Open backend API">
                        {{ app.backend_port }}
                    </a>
                {% endif %}
            </span>
        </div>
        {% if app.get('last_analysis') %}
        <div class="meta-row">
            <span class="meta-label">Last Analysis:</span>
            <span class="meta-value">{{ app.last_analysis | format_datetime }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Container Status Details -->
    <div class="container-status-section">
        <div class="container-statuses" 
             hx-get="{{ url_for('api.get_app_status', model=model, app_num=app_num) }}"
             hx-trigger="load, every 30s"
             hx-swap="outerHTML">
            
            {% if container_statuses %}
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Frontend:</span>
                        <span class="status-badge {{ container_statuses.get('frontend', {}).get('status', 'unknown') }}">
                            {{ container_statuses.get('frontend', {}).get('status', 'Unknown') }}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Backend:</span>
                        <span class="status-badge {{ container_statuses.get('backend', {}).get('status', 'unknown') }}">
                            {{ container_statuses.get('backend', {}).get('status', 'Unknown') }}
                        </span>
                    </div>
                </div>
            {% else %}
                <div class="status-loading">
                    <div class="loading-spinner"></div>
                    <span>Loading status...</span>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Analysis Summary -->
    {% if app.get('analysis_summary') %}
    <div class="analysis-summary">
        <div class="analysis-stats">
            {% for analysis_type, count in app.analysis_summary.items() %}
            <span class="analysis-stat">
                <span class="stat-icon">{{ get_analysis_icon(analysis_type) }}</span>
                <span class="stat-count">{{ count }}</span>
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Card Actions -->
    <footer class="app-card-actions">
        <!-- Container Controls -->
        <div class="action-group">
            <button class="btn btn-success btn-sm" 
                    hx-post="{{ url_for('docker.docker_action', action='start', model=model, app_num=app_num) }}"
                    hx-target=".container-statuses"
                    hx-swap="outerHTML"
                    hx-confirm="Start containers for {{ model }} app {{ app_num }}?"
                    title="Start containers">
                <span class="btn-icon">‚ñ∂Ô∏è</span>
                <span class="btn-text">Start</span>
            </button>
            
            <button class="btn btn-warning btn-sm" 
                    hx-post="{{ url_for('docker.docker_action', action='stop', model=model, app_num=app_num) }}"
                    hx-target=".container-statuses"
                    hx-swap="outerHTML"
                    hx-confirm="Stop containers for {{ model }} app {{ app_num }}?"
                    title="Stop containers">
                <span class="btn-icon">‚èπÔ∏è</span>
                <span class="btn-text">Stop</span>
            </button>
            
            <button class="btn btn-secondary btn-sm" 
                    hx-post="{{ url_for('docker.docker_action', action='restart', model=model, app_num=app_num) }}"
                    hx-target=".container-statuses"
                    hx-swap="outerHTML"
                    hx-confirm="Restart containers for {{ model }} app {{ app_num }}?"
                    title="Restart containers">
                <span class="btn-icon">üîÑ</span>
                <span class="btn-text">Restart</span>
            </button>
        </div>
        
        <!-- Analysis Actions -->
        <div class="action-group">
            <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" 
                        type="button" 
                        data-dropdown="analysis-{{ model }}-{{ app_num }}"
                        title="Run analysis">
                    <span class="btn-icon">üîç</span>
                    <span class="btn-text">Analyze</span>
                </button>
                <div class="dropdown-menu" id="analysis-{{ model }}-{{ app_num }}">
                    <a href="#" 
                       class="dropdown-item"
                       hx-post="{{ url_for('analysis.run_analysis', analysis_type='security', model=model, app_num=app_num) }}"
                       hx-target="#analysis-results-modal"
                       onclick="showAnalysisModal()">
                        Security Scan
                    </a>
                    <a href="#" 
                       class="dropdown-item"
                       hx-post="{{ url_for('performance.run_performance_test', model=model, app_num=app_num) }}"
                       hx-target="#analysis-results-modal"
                       onclick="showAnalysisModal()">
                        Performance Test
                    </a>
                    <a href="#" 
                       class="dropdown-item"
                       hx-post="{{ url_for('zap.start_zap_scan', model=model, app_num=app_num) }}"
                       hx-target="#analysis-results-modal"
                       onclick="showAnalysisModal()">
                        ZAP Scan
                    </a>
                    <a href="#" 
                       class="dropdown-item"
                       hx-post="{{ url_for('openrouter.run_openrouter_analysis', model=model, app_num=app_num) }}"
                       hx-target="#analysis-results-modal"
                       onclick="showAnalysisModal()">
                        AI Analysis
                    </a>
                </div>
            </div>
            
            <button class="btn btn-secondary btn-sm" 
                    hx-get="{{ url_for('docker.view_logs', model=model, app_num=app_num) }}"
                    hx-target="#logs-modal-content"
                    onclick="showLogsModal()"
                    title="View logs">
                <span class="btn-icon">üìã</span>
                <span class="btn-text">Logs</span>
            </button>
        </div>
    </footer>
</article>

<!-- Analysis Results Modal -->
<div id="analysis-results-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Analysis Results</h3>
            <button onclick="hideAnalysisModal()" class="btn btn-secondary btn-sm">√ó</button>
        </div>
        <div class="modal-body">
            <div class="loading">
                <div class="loading-spinner"></div>
                <span>Running analysis...</span>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="hideAnalysisModal()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div id="logs-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Container Logs</h3>
            <button onclick="hideLogsModal()" class="btn btn-secondary btn-sm">√ó</button>
        </div>
        <div class="modal-body" id="logs-modal-content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <span>Loading logs...</span>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="hideLogsModal()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- App Card Styles -->
<style>
.app-link {
    text-decoration: none;
    color: inherit;
    transition: color var(--transition-fast);
}

.app-link:hover {
    color: var(--accent-color);
}

.app-card-title-section {
    flex: 1;
}

.app-card-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0.25rem 0 0 0;
}

.meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
}

.meta-label {
    color: var(--text-muted);
    font-weight: 500;
}

.meta-value {
    color: var(--text-color);
}

.port-link {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 500;
    transition: color var(--transition-fast);
}

.port-link:hover {
    color: var(--accent-dark);
    text-decoration: underline;
}

.container-status-section {
    margin: var(--spacing) 0;
    padding: var(--spacing-sm) 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.status-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-sm);
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
}

.status-label {
    color: var(--text-muted);
    font-weight: 500;
}

.status-loading {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.8rem;
    color: var(--text-muted);
    justify-content: center;
    padding: var(--spacing-sm);
}

.analysis-summary {
    margin: var(--spacing-sm) 0;
}

.analysis-stats {
    display: flex;
    gap: var(--spacing);
    justify-content: center;
}

.analysis-stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
}

.stat-icon {
    font-size: 0.9rem;
}

.stat-count {
    font-weight: 600;
    color: var(--accent-color);
}

.app-card-actions {
    display: flex;
    justify-content: space-between;
    gap: var(--spacing);
    margin-top: var(--spacing);
    padding-top: var(--spacing);
    border-top: 1px solid var(--border-color);
}

.action-group {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.btn-icon {
    font-size: 0.8rem;
}

.btn-text {
    font-size: 0.75rem;
}

/* Dropdown Styles */
.dropdown {
    position: relative;
}

.dropdown-toggle::after {
    content: '‚ñº';
    margin-left: 0.25rem;
    font-size: 0.6rem;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 150px;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    display: none;
    padding: var(--spacing-sm) 0;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    display: block;
    padding: var(--spacing-sm) var(--spacing);
    text-decoration: none;
    color: var(--text-color);
    font-size: 0.8rem;
    transition: background var(--transition-fast);
}

.dropdown-item:hover {
    background: var(--surface-color);
}

/* Mobile responsive */
@media (max-width: 480px) {
    .app-card-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-group {
        justify-content: center;
    }
    
    .btn {
        min-width: 60px;
    }
    
    .btn-text {
        display: none;
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
}

/* Loading states */
.app-card.htmx-request {
    opacity: 0.8;
}

.btn.htmx-request {
    pointer-events: none;
    opacity: 0.6;
}

.btn.htmx-request .btn-icon::after {
    content: ' ‚Üª';
    animation: spin 1s linear infinite;
}
</style>

<!-- App Card JavaScript -->
<script>
// Dropdown functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('dropdown-toggle') || e.target.closest('.dropdown-toggle')) {
        e.preventDefault();
        const btn = e.target.classList.contains('dropdown-toggle') ? e.target : e.target.closest('.dropdown-toggle');
        const dropdown = btn.nextElementSibling;
        
        // Close all other dropdowns
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            if (menu !== dropdown) menu.classList.remove('show');
        });
        
        // Toggle current dropdown
        dropdown.classList.toggle('show');
    } else {
        // Close all dropdowns when clicking outside
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// Modal functions
function showAnalysisModal() {
    document.getElementById('analysis-results-modal').style.display = 'flex';
}

function hideAnalysisModal() {
    document.getElementById('analysis-results-modal').style.display = 'none';
}

function showLogsModal() {
    document.getElementById('logs-modal').style.display = 'flex';
}

function hideLogsModal() {
    document.getElementById('logs-modal').style.display = 'none';
}

// Analysis icon helper
function getAnalysisIcon(type) {
    const icons = {
        'security': 'üîí',
        'performance': '‚ö°',
        'zap': 'üï∑Ô∏è',
        'openrouter': 'üß†',
        'quality': '‚úÖ'
    };
    return icons[type] || 'üìä';
}

// Auto-refresh status every 30 seconds
document.addEventListener('DOMContentLoaded', function() {
    // This is handled by HTMX triggers in the template
});

// Handle HTMX errors in card actions
document.body.addEventListener('htmx:responseError', function(e) {
    if (e.detail.elt.closest('.app-card')) {
        showToast('Action failed. Please try again.', 'error');
    }
});

// Handle successful actions
document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.classList.contains('container-statuses')) {
        showToast('Container status updated', 'success');
    }
});
</script>

<!-- Template Functions -->
{% macro get_analysis_icon(analysis_type) %}
    {% if analysis_type == 'security' %}üîí
    {% elif analysis_type == 'performance' %}‚ö°
    {% elif analysis_type == 'zap' %}üï∑Ô∏è
    {% elif analysis_type == 'openrouter' %}üß†
    {% elif analysis_type == 'quality' %}‚úÖ
    {% else %}üìä
    {% endif %}
{% endmacro %}
