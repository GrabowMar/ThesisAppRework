<!-- Modal Dialog Component -->
{% set modal_id = modal_id or 'modal' %}
{% set modal_title = modal_title or 'Modal' %}
{% set modal_size = modal_size or 'normal' %}
{% set dismissible = dismissible if dismissible is defined else true %}

<div id="{{ modal_id }}" 
     class="modal-overlay {{ 'modal-lg' if modal_size == 'large' else 'modal-sm' if modal_size == 'small' else '' }}" 
     style="display: none;"
     role="dialog" 
     aria-labelledby="{{ modal_id }}-title"
     aria-modal="true"
     tabindex="-1">
    
    <div class="modal" role="document">
        <!-- Modal Header -->
        <header class="modal-header">
            <h3 id="{{ modal_id }}-title" class="modal-title">{{ modal_title }}</h3>
            {% if dismissible %}
            <button type="button" 
                    class="modal-close btn btn-secondary btn-sm" 
                    onclick="hideModal('{{ modal_id }}')"
                    aria-label="Close modal">
                <span aria-hidden="true">Ã—</span>
            </button>
            {% endif %}
        </header>
        
        <!-- Modal Body -->
        <div class="modal-body" id="{{ modal_id }}-content">
            {% block modal_content %}
            <div class="loading">
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            </div>
            {% endblock %}
        </div>
        
        <!-- Modal Footer -->
        {% block modal_footer %}
        <footer class="modal-footer">
            {% if dismissible %}
            <button type="button" 
                    class="btn btn-secondary" 
                    onclick="hideModal('{{ modal_id }}')">
                Close
            </button>
            {% endif %}
        </footer>
        {% endblock %}
    </div>
</div>

<!-- Modal Component Styles -->
<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
    padding: var(--spacing);
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--background-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    max-width: 90vw;
    max-height: 90vh;
    width: 500px;
    overflow: hidden;
    transform: scale(0.9) translateY(-20px);
    transition: transform var(--transition-normal);
    display: flex;
    flex-direction: column;
}

.modal-overlay.show .modal {
    transform: scale(1) translateY(0);
}

/* Modal Sizes */
.modal-overlay.modal-sm .modal {
    width: 300px;
}

.modal-overlay.modal-lg .modal {
    width: 800px;
    max-width: 95vw;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
    background: var(--surface-color);
    flex-shrink: 0;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
}

.modal-close {
    padding: 0.25rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1.5rem;
    line-height: 1;
}

.modal-body {
    padding: var(--spacing-lg);
    overflow-y: auto;
    flex: 1;
    min-height: 0;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing);
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
    background: var(--surface-color);
    flex-shrink: 0;
}

/* Modal Animations */
@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes modalFadeOut {
    from {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
    to {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
}

.modal-overlay.animating-in .modal {
    animation: modalFadeIn var(--transition-normal) ease-out;
}

.modal-overlay.animating-out .modal {
    animation: modalFadeOut var(--transition-normal) ease-in;
}

/* Responsive Design */
@media (max-width: 768px) {
    .modal-overlay {
        padding: var(--spacing-sm);
    }
    
    .modal {
        width: 100%;
        max-width: none;
        max-height: 95vh;
    }
    
    .modal-overlay.modal-lg .modal {
        width: 100%;
    }
    
    .modal-header,
    .modal-body,
    .modal-footer {
        padding: var(--spacing);
    }
    
    .modal-footer {
        flex-direction: column-reverse;
    }
    
    .modal-footer .btn {
        width: 100%;
    }
}

/* Accessibility: Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    .modal-overlay,
    .modal {
        transition: none;
    }
    
    .modal-overlay.animating-in .modal,
    .modal-overlay.animating-out .modal {
        animation: none;
    }
}

/* Dark Theme Support */
@media (prefers-color-scheme: dark) {
    .modal-overlay {
        background: rgba(0, 0, 0, 0.7);
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .modal {
        border: 2px solid var(--text-color);
    }
    
    .modal-header,
    .modal-footer {
        border-color: var(--text-color);
    }
}

/* Focus Trap Styles */
.modal-overlay[aria-modal="true"] {
    /* Focus will be trapped within this element */
}

/* Loading State in Modal */
.modal-body .loading {
    justify-content: center;
    padding: var(--spacing-xl);
}

/* Modal Content Variations */
.modal-body.modal-form {
    padding: var(--spacing-lg) var(--spacing-xl);
}

.modal-body.modal-content {
    padding: var(--spacing-xl);
}

.modal-body.modal-alert {
    text-align: center;
    padding: var(--spacing-xl);
}

.modal-body.modal-alert .alert-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing);
}

/* Scrollable Modal Body */
.modal-body.scrollable {
    max-height: 60vh;
    overflow-y: auto;
}

/* Modal Backdrop Blur Effect */
.modal-overlay.backdrop-blur {
    backdrop-filter: blur(4px);
}

@supports not (backdrop-filter: blur(4px)) {
    .modal-overlay.backdrop-blur {
        background: rgba(0, 0, 0, 0.6);
    }
}
</style>

<!-- Modal Component JavaScript -->
<script>
// Modal Management
window.ModalUtils = {
    openModals: new Set(),
    
    /**
     * Show modal with optional animation
     */
    show: function(modalId, options = {}) {
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.error(`Modal with id "${modalId}" not found`);
            return;
        }
        
        const { animate = true, focus = true } = options;
        
        // Add to open modals set
        this.openModals.add(modalId);
        
        // Show modal
        modal.style.display = 'flex';
        
        if (animate) {
            modal.classList.add('animating-in');
            setTimeout(() => {
                modal.classList.remove('animating-in');
                modal.classList.add('show');
            }, 10);
        } else {
            modal.classList.add('show');
        }
        
        // Focus management
        if (focus) {
            setTimeout(() => {
                this.trapFocus(modal);
                const firstFocusable = this.getFocusableElements(modal)[0];
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }, animate ? 300 : 0);
        }
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        
        // Add escape key listener
        document.addEventListener('keydown', this.handleEscapeKey);
        
        // Dispatch custom event
        modal.dispatchEvent(new CustomEvent('modal:show', {
            detail: { modalId, options }
        }));
        
        // Announce to screen readers
        this.announceToScreenReader(`Modal ${modalId} opened`);
    },
    
    /**
     * Hide modal with optional animation
     */
    hide: function(modalId, options = {}) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const { animate = true } = options;
        
        // Remove from open modals set
        this.openModals.delete(modalId);
        
        if (animate) {
            modal.classList.add('animating-out');
            setTimeout(() => {
                modal.classList.remove('show', 'animating-out');
                modal.style.display = 'none';
                
                // Restore body scroll if no other modals
                if (this.openModals.size === 0) {
                    document.body.style.overflow = '';
                    document.removeEventListener('keydown', this.handleEscapeKey);
                }
            }, 300);
        } else {
            modal.classList.remove('show');
            modal.style.display = 'none';
            
            if (this.openModals.size === 0) {
                document.body.style.overflow = '';
                document.removeEventListener('keydown', this.handleEscapeKey);
            }
        }
        
        // Dispatch custom event
        modal.dispatchEvent(new CustomEvent('modal:hide', {
            detail: { modalId, options }
        }));
        
        // Announce to screen readers
        this.announceToScreenReader(`Modal ${modalId} closed`);
    },
    
    /**
     * Handle escape key press
     */
    handleEscapeKey: function(e) {
        if (e.key === 'Escape') {
            const topModal = Array.from(window.ModalUtils.openModals).pop();
            if (topModal) {
                window.ModalUtils.hide(topModal);
            }
        }
    },
    
    /**
     * Trap focus within modal
     */
    trapFocus: function(modal) {
        const focusableElements = this.getFocusableElements(modal);
        
        if (focusableElements.length === 0) return;
        
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        modal.addEventListener('keydown', function(e) {
            if (e.key !== 'Tab') return;
            
            if (e.shiftKey) {
                if (document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                }
            } else {
                if (document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        });
    },
    
    /**
     * Get focusable elements within modal
     */
    getFocusableElements: function(modal) {
        const selector = [
            'button:not([disabled])',
            '[href]',
            'input:not([disabled]):not([type="hidden"])',
            'select:not([disabled])',
            'textarea:not([disabled])',
            '[tabindex]:not([tabindex="-1"])'
        ].join(', ');
        
        return Array.from(modal.querySelectorAll(selector));
    },
    
    /**
     * Announce to screen readers
     */
    announceToScreenReader: function(message) {
        if (window.ThesisApp?.accessibility?.announce) {
            window.ThesisApp.accessibility.announce(message);
        }
    }
};

// Global functions for template use
function showModal(modalId, options = {}) {
    window.ModalUtils.show(modalId, options);
}

function hideModal(modalId, options = {}) {
    window.ModalUtils.hide(modalId, options);
}

// Auto-setup modal triggers
document.addEventListener('click', function(e) {
    // Handle modal triggers
    if (e.target.matches('[data-modal]') || e.target.closest('[data-modal]')) {
        const trigger = e.target.matches('[data-modal]') ? e.target : e.target.closest('[data-modal]');
        const modalId = trigger.dataset.modal;
        
        e.preventDefault();
        showModal(modalId);
    }
    
    // Handle modal overlay clicks
    if (e.target.classList.contains('modal-overlay')) {
        const modalId = e.target.id;
        const dismissible = !e.target.hasAttribute('data-no-dismiss');
        
        if (dismissible) {
            hideModal(modalId);
        }
    }
});

// HTMX integration
document.body.addEventListener('htmx:afterSwap', function(e) {
    // If content was swapped into a modal, announce it
    if (e.detail.target.closest('.modal-body')) {
        const modal = e.detail.target.closest('.modal-overlay');
        if (modal) {
            window.ModalUtils.announceToScreenReader('Modal content updated');
        }
    }
});

// Handle modal cleanup on page unload
window.addEventListener('beforeunload', function() {
    document.body.style.overflow = '';
});
</script>
