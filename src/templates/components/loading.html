<!-- Loading Indicator Component -->
{% set size = size or 'normal' %}
{% set text = text or 'Loading...' %}
{% set show_text = show_text if show_text is defined else true %}

<div class="loading {{ 'loading-sm' if size == 'small' else 'loading-lg' if size == 'large' else '' }}"
     role="status" 
     aria-live="polite"
     aria-label="{{ text }}">
    
    <!-- Spinner -->
    <div class="loading-spinner" aria-hidden="true"></div>
    
    <!-- Loading Text -->
    {% if show_text %}
    <span class="loading-text">{{ text }}</span>
    {% endif %}
</div>

<!-- Loading Component Styles -->
<style>
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: var(--spacing);
    color: var(--text-muted);
    font-size: 0.875rem;
}

.loading.loading-sm {
    gap: 0.25rem;
    padding: var(--spacing-sm);
    font-size: 0.75rem;
}

.loading.loading-lg {
    gap: var(--spacing);
    padding: var(--spacing-lg);
    font-size: 1rem;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    border-top-color: var(--accent-color);
    animation: spin 1s linear infinite;
    flex-shrink: 0;
}

.loading.loading-sm .loading-spinner {
    width: 16px;
    height: 16px;
    border-width: 1.5px;
}

.loading.loading-lg .loading-spinner {
    width: 24px;
    height: 24px;
    border-width: 3px;
}

.loading-text {
    color: inherit;
    white-space: nowrap;
}

/* Accessibility: Reduce motion */
@media (prefers-reduced-motion: reduce) {
    .loading-spinner {
        animation: none;
        border-top-color: var(--accent-color);
        border-right-color: var(--accent-color);
    }
}

/* Dark theme support */
@media (prefers-color-scheme: dark) {
    .loading-spinner {
        border-color: rgba(255, 255, 255, 0.3);
        border-top-color: var(--accent-color);
    }
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .loading-spinner {
        border-width: 3px;
        border-color: currentColor;
        border-top-color: var(--accent-color);
    }
}

/* Inline loading variant */
.loading.loading-inline {
    display: inline-flex;
    padding: 0;
    vertical-align: middle;
}

.loading.loading-inline .loading-spinner {
    width: 1em;
    height: 1em;
    border-width: 1px;
}

/* Overlay loading variant */
.loading.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 100;
    border-radius: inherit;
}

@media (prefers-color-scheme: dark) {
    .loading.loading-overlay {
        background: rgba(0, 0, 0, 0.9);
    }
}

/* Pulse animation variant */
.loading.loading-pulse .loading-spinner {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(0.95);
    }
}

/* Dots loading variant */
.loading.loading-dots .loading-spinner {
    display: none;
}

.loading.loading-dots::after {
    content: '';
    display: inline-block;
    width: 1em;
    text-align: left;
    animation: dots 2s steps(4, end) infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}

/* Skeleton loading variant */
.loading.loading-skeleton {
    background: linear-gradient(90deg, 
        var(--border-color) 25%, 
        rgba(255, 255, 255, 0.8) 50%, 
        var(--border-color) 75%);
    background-size: 200% 100%;
    animation: skeleton 2s infinite;
    border-radius: var(--border-radius);
    height: 1em;
    min-width: 100px;
}

.loading.loading-skeleton .loading-spinner,
.loading.loading-skeleton .loading-text {
    display: none;
}

@keyframes skeleton {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

@media (prefers-color-scheme: dark) {
    .loading.loading-skeleton {
        background: linear-gradient(90deg, 
            #333 25%, 
            rgba(255, 255, 255, 0.1) 50%, 
            #333 75%);
    }
}
</style>

<!-- Loading Component JavaScript -->
<script>
// Utility functions for loading states
window.LoadingUtils = {
    /**
     * Show loading indicator in element
     */
    show: function(element, options = {}) {
        if (!element) return;
        
        const {
            text = 'Loading...',
            size = 'normal',
            variant = 'spinner',
            overlay = false
        } = options;
        
        const loadingHtml = this.createLoading(text, size, variant, overlay);
        
        if (overlay) {
            element.style.position = 'relative';
            element.insertAdjacentHTML('beforeend', loadingHtml);
        } else {
            element.innerHTML = loadingHtml;
        }
    },
    
    /**
     * Hide loading indicator in element
     */
    hide: function(element) {
        if (!element) return;
        
        const loadingElements = element.querySelectorAll('.loading');
        loadingElements.forEach(loading => loading.remove());
    },
    
    /**
     * Create loading HTML
     */
    createLoading: function(text = 'Loading...', size = 'normal', variant = 'spinner', overlay = false) {
        const sizeClass = size === 'small' ? 'loading-sm' : size === 'large' ? 'loading-lg' : '';
        const variantClass = variant !== 'spinner' ? `loading-${variant}` : '';
        const overlayClass = overlay ? 'loading-overlay' : '';
        
        let spinnerHtml = '';
        if (variant === 'spinner' || variant === 'pulse') {
            spinnerHtml = '<div class="loading-spinner" aria-hidden="true"></div>';
        }
        
        return `
            <div class="loading ${sizeClass} ${variantClass} ${overlayClass}" 
                 role="status" 
                 aria-live="polite"
                 aria-label="${text}">
                ${spinnerHtml}
                <span class="loading-text">${text}</span>
            </div>
        `;
    },
    
    /**
     * Show skeleton loading for content
     */
    skeleton: function(element, count = 3) {
        if (!element) return;
        
        const skeletons = Array.from({ length: count }, () => 
            '<div class="loading loading-skeleton" style="margin-bottom: 0.5rem;"></div>'
        ).join('');
        
        element.innerHTML = skeletons;
    },
    
    /**
     * Create button loading state
     */
    buttonLoading: function(button, loading = true) {
        if (!button) return;
        
        if (loading) {
            button.disabled = true;
            button.classList.add('loading-state');
            
            const originalContent = button.innerHTML;
            button.dataset.originalContent = originalContent;
            
            button.innerHTML = `
                <span class="loading loading-inline loading-sm">
                    <div class="loading-spinner" aria-hidden="true"></div>
                </span>
                <span>Loading...</span>
            `;
        } else {
            button.disabled = false;
            button.classList.remove('loading-state');
            
            if (button.dataset.originalContent) {
                button.innerHTML = button.dataset.originalContent;
                delete button.dataset.originalContent;
            }
        }
    }
};

// Auto-apply loading states to HTMX requests
document.body.addEventListener('htmx:beforeRequest', function(e) {
    const element = e.detail.elt;
    
    // Add loading class to trigger element
    if (element) {
        element.classList.add('htmx-loading');
        
        // If it's a button, show loading state
        if (element.tagName === 'BUTTON') {
            window.LoadingUtils.buttonLoading(element, true);
        }
    }
    
    // Show loading in target if it has indicator
    const target = document.querySelector(e.detail.requestConfig.target || 'body');
    const indicator = target?.querySelector('.htmx-indicator');
    if (indicator) {
        indicator.style.display = 'flex';
    }
});

document.body.addEventListener('htmx:afterRequest', function(e) {
    const element = e.detail.elt;
    
    // Remove loading class from trigger element
    if (element) {
        element.classList.remove('htmx-loading');
        
        // If it's a button, hide loading state
        if (element.tagName === 'BUTTON') {
            window.LoadingUtils.buttonLoading(element, false);
        }
    }
    
    // Hide loading in target
    const target = document.querySelector(e.detail.requestConfig.target || 'body');
    const indicator = target?.querySelector('.htmx-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
});
</script>
