<!-- Error Page: 500 Internal Server Error -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Error - Thesis Research App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/missing.css@1.1.3/dist/missing.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <style>
        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-xl);
            text-align: center;
            background: linear-gradient(135deg, var(--background-color) 0%, var(--surface-color) 100%);
        }
        
        .error-content {
            max-width: 600px;
            width: 100%;
        }
        
        .error-code {
            font-size: 6rem;
            font-weight: 700;
            color: var(--danger-color);
            margin: 0;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .error-title {
            font-size: 2rem;
            font-weight: 600;
            margin: var(--spacing) 0;
            color: var(--text-color);
        }
        
        .error-message {
            font-size: 1.125rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
        }
        
        .error-actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing);
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }
        
        .error-actions .btn {
            min-width: 200px;
        }
        
        .error-details {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
            text-align: left;
        }
        
        .error-details summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: var(--spacing-sm);
            user-select: none;
        }
        
        .error-details summary:hover {
            color: var(--accent-color);
        }
        
        .error-details[open] summary {
            margin-bottom: var(--spacing);
        }
        
        .error-info {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--text-muted);
            background: var(--surface-color);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .error-suggestions {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing);
            text-align: left;
        }
        
        .error-suggestions h4 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .error-suggestions ul {
            margin: 0;
            padding-left: var(--spacing);
        }
        
        .error-suggestions li {
            margin-bottom: var(--spacing-sm);
            color: var(--text-muted);
        }
        
        .error-suggestions a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .error-suggestions a:hover {
            text-decoration: underline;
        }
        
        .error-illustration {
            font-size: 4rem;
            margin-bottom: var(--spacing);
            opacity: 0.6;
            animation: shake 0.5s ease-in-out;
        }
        
        .retry-countdown {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: var(--spacing-sm);
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--surface-color);
            border-radius: var(--border-radius);
            margin-top: var(--spacing);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger-color);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.checking {
            background: var(--warning-color);
        }
        
        .status-indicator.healthy {
            background: var(--success-color);
            animation: none;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @media (max-width: 768px) {
            .error-code {
                font-size: 4rem;
            }
            
            .error-title {
                font-size: 1.5rem;
            }
            
            .error-message {
                font-size: 1rem;
            }
            
            .error-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-content">
            <div class="error-illustration">‚ö†Ô∏è</div>
            <h1 class="error-code">500</h1>
            <h2 class="error-title">Internal Server Error</h2>
            <p class="error-message">
                Something went wrong on our end. Our team has been notified and is working to fix the issue.
                Please try again in a few moments.
            </p>
            
            <div class="error-actions">
                <button onclick="location.reload()" class="btn btn-primary" id="retry-btn">
                    üîÑ Try Again
                </button>
                <div class="retry-countdown" id="retry-countdown"></div>
                
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline">
                    üè† Go to Dashboard
                </a>
                
                <button onclick="history.back()" class="btn btn-link">
                    ‚Üê Go Back
                </button>
            </div>
            
            {% if config.DEBUG and error_info %}
            <details class="error-details">
                <summary>üîß Technical Details (Debug Mode)</summary>
                <div class="error-info">{{ error_info }}</div>
            </details>
            {% endif %}
            
            <div class="system-status">
                <div class="status-indicator" id="status-indicator"></div>
                <span id="status-text">Checking system status...</span>
            </div>
            
            <div class="error-suggestions">
                <h4>What happened?</h4>
                <ul>
                    <li>The server encountered an unexpected condition</li>
                    <li>This could be due to high traffic, maintenance, or a temporary glitch</li>
                    <li>The issue has been automatically logged and reported to our team</li>
                    <li>No data has been lost - your applications and analyses are safe</li>
                </ul>
                
                <h4>What you can do:</h4>
                <ul>
                    <li>Wait a moment and try refreshing the page</li>
                    <li>
                        <a href="{{ url_for('main.dashboard') }}">Return to the dashboard</a>
                        and try a different action
                    </li>
                    <li>
                        Check our <a href="{{ url_for('main.system_status') }}">system status page</a>
                        for known issues
                    </li>
                    <li>
                        If the problem persists, please 
                        <a href="mailto:support@thesisapp.com?subject=Error 500 - {{ request.url }}">
                            contact support
                        </a> with details about what you were doing
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // Error tracking and retry logic
        (function() {
            let retryCount = 0;
            const maxRetries = 3;
            const retryInterval = 10; // seconds
            let countdownInterval;
            
            // Track the error
            if (window.ThesisApp && window.ThesisApp.analytics) {
                window.ThesisApp.analytics.trackError('500', {
                    url: window.location.href,
                    referrer: document.referrer,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    retryCount: retryCount
                });
            }
            
            // Auto-retry functionality
            function startRetryCountdown() {
                let secondsLeft = retryInterval;
                const countdownEl = document.getElementById('retry-countdown');
                const retryBtn = document.getElementById('retry-btn');
                
                if (retryCount < maxRetries) {
                    countdownEl.textContent = `Auto-retry in ${secondsLeft} seconds...`;
                    
                    countdownInterval = setInterval(() => {
                        secondsLeft--;
                        if (secondsLeft > 0) {
                            countdownEl.textContent = `Auto-retry in ${secondsLeft} seconds...`;
                        } else {
                            clearInterval(countdownInterval);
                            retryCount++;
                            location.reload();
        }
                    }, 1000);
                } else {
                    countdownEl.textContent = 'Maximum retries reached. Please try manually.';
                    retryBtn.textContent = 'üîÑ Manual Retry';
                }
            }
            
            // System status check
            function checkSystemStatus() {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                statusIndicator.className = 'status-indicator checking';
                statusText.textContent = 'Checking system status...';
                
                // Simulate status check (in real app, this would be an API call)
                setTimeout(() => {
                    const isHealthy = Math.random() > 0.3; // 70% chance of being healthy
                    
                    if (isHealthy) {
                        statusIndicator.className = 'status-indicator healthy';
                        statusText.textContent = 'System appears to be recovering';
                        
                        // If system is healthy, encourage retry
                        const retryBtn = document.getElementById('retry-btn');
                        retryBtn.textContent = 'üîÑ Try Again Now';
                        retryBtn.classList.remove('btn-primary');
                        retryBtn.classList.add('btn-success');
                    } else {
                        statusIndicator.className = 'status-indicator';
                        statusText.textContent = 'System issues detected - please wait';
                    }
                }, 2000);
            }
            
            // Enhanced retry button
            document.getElementById('retry-btn').addEventListener('click', function() {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                retryCount++;
                
                // Track retry attempt  
                if (window.ThesisApp && window.ThesisApp.analytics) {
                    window.ThesisApp.analytics.trackEvent('error_retry', {
                        error_code: '500',
                        retry_count: retryCount,
                        manual: true
                    });
                }
                
                location.reload();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(event) {
                switch(event.key) {
                    case 'r':
                    case 'R':
                        if (!event.ctrlKey && !event.altKey) {
                            event.preventDefault();
                            document.getElementById('retry-btn').click();
                        }
                        break;
                    case 'h':
                    case 'H':
                        if (!event.ctrlKey && !event.altKey) {
                            window.location.href = '{{ url_for("main.dashboard") }}';
                        }
                        break;
                    case 'b':
                    case 'B':
                        if (!event.ctrlKey && !event.altKey) {
                            history.back();
                        }
                        break;
                }
            });
            
            // Initialize
            checkSystemStatus();
            
            // Only start auto-retry if not in debug mode
            {% if not config.DEBUG %}
            setTimeout(startRetryCountdown, 3000); // Wait 3 seconds before starting countdown
            {% endif %}
            
            // Prevent the retry countdown if user becomes active
            ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, function() {
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        document.getElementById('retry-countdown').textContent = 'Auto-retry cancelled - user active';
                    }
                }, { once: true });
            });
        })();
    </script>
</body>
</html>
