{% extends "base.html" %}

{% block title %}Enhanced Security Testing & Analysis Platform - AI Research Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">Enhanced Security Testing Platform</h1>
                <p class="page-subtitle">Comprehensive security analysis with advanced tool configurations</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="showCreateTestModal()">
                    <i class="fas fa-plus"></i> Create Security Test
                </button>
            </div>
        </div>
    </div>

    <!-- Testing Infrastructure Status -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Infrastructure Status</h5>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="showInfrastructureStatus()">
                            View Details
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="infrastructure-status" 
                         hx-get="/testing/api/infrastructure-status" 
                         hx-trigger="load, every 30s"
                         hx-swap="innerHTML">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading infrastructure status...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="total-tests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class="fas fa-play"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="running-tests">0</div>
                <div class="stat-label">Running</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="queued-tests">0</div>
                <div class="stat-label">Queued</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-danger">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="failed-tests">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
    </div>

    <!-- Security Testing Management -->
    <div class="card">
        <div class="card-header">
            <h5>Security Tests</h5>
            <div class="card-actions">
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleAutoRefresh(true)">
                        <i class="fas fa-sync"></i> Auto Refresh
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshJobsList()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="jobs-list" 
                 hx-get="/testing/api/jobs" 
                 hx-trigger="load, every 15s[data-auto-refresh='true']"
                 hx-swap="innerHTML">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2">Loading security tests...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Create Security Test Modal -->
<div class="modal fade" id="createTestModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Enhanced Security Test</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="securityTestForm" onsubmit="submitSecurityTestForm(); return false;">
                <div class="modal-body">
                    <!-- Basic Test Configuration -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="job_name">Test Name *</label>
                                <input type="text" class="form-control" id="job_name" name="job_name" required
                                       placeholder="e.g., Security Audit - Banking App">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test_type">Test Type *</label>
                                <select class="form-control" id="test_type" name="test_type" required onchange="handleTestTypeChange(this.value)">
                                    <option value="">Select Test Type</option>
                                    <option value="security_backend">Backend Security Analysis</option>
                                    <option value="security_frontend">Frontend Security Analysis</option>
                                    <option value="security_full_stack">Full Stack Security Analysis</option>
                                    <option value="zap_scan">ZAP Security Scanning</option>
                                    <option value="performance_test">Performance Testing</option>
                                    <option value="ai_analysis">AI Code Analysis</option>
                                    <option value="comprehensive">Comprehensive Analysis</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"
                                          placeholder="Describe the security test objectives and scope..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Tool Selection -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6>Security Tools Configuration</h6>
                        </div>
                        <div class="card-body">
                            <!-- Backend Security Tools -->
                            <div id="backend-tools" class="tool-category">
                                <h6 class="tool-category-title">Backend Security Tools</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="bandit" id="tool_bandit">
                                            <label class="form-check-label" for="tool_bandit">
                                                <strong>Bandit</strong>
                                                <small class="text-muted d-block">Python security linter</small>
                                            </label>
                                        </div>
                                        <div class="tool-options" id="bandit-options" style="display: none;">
                                            <div class="form-group mt-2">
                                                <label class="small">Severity Level</label>
                                                <select class="form-control form-control-sm" name="bandit_severity">
                                                    <option value="low">Low (-l)</option>
                                                    <option value="medium" selected>Medium (-ll)</option>
                                                    <option value="high">High (-lll)</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="small">Confidence Level</label>
                                                <select class="form-control form-control-sm" name="bandit_confidence">
                                                    <option value="low">Low (-i)</option>
                                                    <option value="medium" selected>Medium (-ii)</option>
                                                    <option value="high">High (-iii)</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="small">Output Format</label>
                                                <select class="form-control form-control-sm" name="bandit_format">
                                                    <option value="json" selected>JSON</option>
                                                    <option value="yaml">YAML</option>
                                                    <option value="xml">XML</option>
                                                    <option value="csv">CSV</option>
                                                    <option value="html">HTML</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="bandit_verbose" id="bandit_verbose">
                                                <label class="form-check-label small" for="bandit_verbose">Verbose output (-v)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="bandit_ignore_nosec" id="bandit_ignore_nosec">
                                                <label class="form-check-label small" for="bandit_ignore_nosec">Ignore # nosec comments</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="safety" id="tool_safety">
                                            <label class="form-check-label" for="tool_safety">
                                                <strong>Safety</strong>
                                                <small class="text-muted d-block">Python dependency scanner</small>
                                            </label>
                                        </div>
                                        <div class="tool-options" id="safety-options" style="display: none;">
                                            <div class="form-group mt-2">
                                                <label class="small">Output Format</label>
                                                <select class="form-control form-control-sm" name="safety_format">
                                                    <option value="json" selected>JSON</option>
                                                    <option value="text">Text</option>
                                                    <option value="bare">Bare</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="safety_full_report" id="safety_full_report">
                                                <label class="form-check-label small" for="safety_full_report">Full report (--full-report)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="safety_continue_on_error" id="safety_continue_on_error">
                                                <label class="form-check-label small" for="safety_continue_on_error">Continue on error</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="semgrep" id="tool_semgrep">
                                            <label class="form-check-label" for="tool_semgrep">
                                                <strong>Semgrep</strong>
                                                <small class="text-muted d-block">Multi-language static analysis</small>
                                            </label>
                                        </div>
                                        <div class="tool-options" id="semgrep-options" style="display: none;">
                                            <div class="form-group mt-2">
                                                <label class="small">Ruleset</label>
                                                <select class="form-control form-control-sm" name="semgrep_config">
                                                    <option value="auto" selected>Auto (--config=auto)</option>
                                                    <option value="p/security-audit">Security Audit</option>
                                                    <option value="p/owasp-top-ten">OWASP Top 10</option>
                                                    <option value="p/bandit">Bandit Rules</option>
                                                    <option value="p/python">Python Rules</option>
                                                    <option value="p/javascript">JavaScript Rules</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="small">Output Format</label>
                                                <select class="form-control form-control-sm" name="semgrep_format">
                                                    <option value="json" selected>JSON</option>
                                                    <option value="text">Text</option>
                                                    <option value="sarif">SARIF</option>
                                                    <option value="emacs">Emacs</option>
                                                    <option value="vim">Vim</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="semgrep_verbose" id="semgrep_verbose">
                                                <label class="form-check-label small" for="semgrep_verbose">Verbose output</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="pylint" id="tool_pylint">
                                            <label class="form-check-label" for="tool_pylint">
                                                <strong>Pylint</strong>
                                                <small class="text-muted d-block">Python code quality checker</small>
                                            </label>
                                        </div>
                                        <div class="tool-options" id="pylint-options" style="display: none;">
                                            <div class="form-group mt-2">
                                                <label class="small">Output Format</label>
                                                <select class="form-control form-control-sm" name="pylint_format">
                                                    <option value="json" selected>JSON</option>
                                                    <option value="text">Text</option>
                                                    <option value="parseable">Parseable</option>
                                                    <option value="colorized">Colorized</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pylint_disable_warnings" id="pylint_disable_warnings">
                                                <label class="form-check-label small" for="pylint_disable_warnings">Disable warnings</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Frontend Security Tools -->
                            <div id="frontend-tools" class="tool-category mt-4">
                                <h6 class="tool-category-title">Frontend Security Tools</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="eslint" id="tool_eslint">
                                            <label class="form-check-label" for="tool_eslint">
                                                <strong>ESLint</strong>
                                                <small class="text-muted d-block">JavaScript/TypeScript linter</small>
                                            </label>
                                        </div>
                                        <div class="tool-options" id="eslint-options" style="display: none;">
                                            <div class="form-group mt-2">
                                                <label class="small">Configuration</label>
                                                <select class="form-control form-control-sm" name="eslint_config">
                                                    <option value="recommended" selected>Recommended</option>
                                                    <option value="@eslint/js">Standard JS</option>
                                                    <option value="security">Security Plugin</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="small">Output Format</label>
                                                <select class="form-control form-control-sm" name="eslint_format">
                                                    <option value="json" selected>JSON</option>
                                                    <option value="stylish">Stylish</option>
                                                    <option value="compact">Compact</option>
                                                    <option value="unix">Unix</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="npm-audit" id="tool_npm_audit">
                                            <label class="form-check-label" for="tool_npm_audit">
                                                <strong>npm audit</strong>
                                                <small class="text-muted d-block">Node.js dependency scanner</small>
                                            </label>
                                        </div>
                                        <div class="tool-options" id="npm-audit-options" style="display: none;">
                                            <div class="form-group mt-2">
                                                <label class="small">Audit Level</label>
                                                <select class="form-control form-control-sm" name="npm_audit_level">
                                                    <option value="low">Low</option>
                                                    <option value="moderate" selected>Moderate</option>
                                                    <option value="high">High</option>
                                                    <option value="critical">Critical</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="npm_audit_json" id="npm_audit_json">
                                                <label class="form-check-label small" for="npm_audit_json">JSON output</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="retire-js" id="tool_retire_js">
                                            <label class="form-check-label" for="tool_retire_js">
                                                <strong>RetireJS</strong>
                                                <small class="text-muted d-block">JavaScript vulnerability scanner</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="jshint" id="tool_jshint">
                                            <label class="form-check-label" for="tool_jshint">
                                                <strong>JSHint</strong>
                                                <small class="text-muted d-block">JavaScript code quality</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Web Application Security Tools -->
                            <div id="web-app-tools" class="tool-category mt-4">
                                <h6 class="tool-category-title">Web Application Security Tools</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="nikto" id="tool_nikto">
                                            <label class="form-check-label" for="tool_nikto">
                                                <strong>Nikto</strong>
                                                <small class="text-muted d-block">Web server scanner</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="nmap" id="tool_nmap">
                                            <label class="form-check-label" for="tool_nmap">
                                                <strong>Nmap</strong>
                                                <small class="text-muted d-block">Network security scanner</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="sqlmap" id="tool_sqlmap">
                                            <label class="form-check-label" for="tool_sqlmap">
                                                <strong>SQLMap</strong>
                                                <small class="text-muted d-block">SQL injection scanner</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="wfuzz" id="tool_wfuzz">
                                            <label class="form-check-label" for="tool_wfuzz">
                                                <strong>Wfuzz</strong>
                                                <small class="text-muted d-block">Web fuzzing tool</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ZAP Configuration (shown when ZAP scan is selected) -->
                    <div class="card mb-3" id="zap-config" style="display: none;">
                        <div class="card-header">
                            <h6>ZAP Security Scanning Configuration</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="zap_scan_type">Scan Type</label>
                                        <select class="form-control" id="zap_scan_type" name="zap_scan_type" onchange="handleZapScanTypeChange(this.value)">
                                            <option value="baseline">Baseline Scan</option>
                                            <option value="full">Full Active Scan</option>
                                            <option value="api">API Scan</option>
                                            <option value="spider">Spider Only</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="zap_target_url">Target URL</label>
                                        <input type="url" class="form-control" id="zap_target_url" name="zap_target_url" 
                                               placeholder="http://localhost:8001">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="zap_passive_scan" id="zap_passive_scan" checked>
                                        <label class="form-check-label" for="zap_passive_scan">Enable passive scanning</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="zap_ajax_spider" id="zap_ajax_spider">
                                        <label class="form-check-label" for="zap_ajax_spider">Enable AJAX spider</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="zap_generate_report" id="zap_generate_report" checked>
                                        <label class="form-check-label" for="zap_generate_report">Generate HTML report</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Target Selection -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6>Target Selection</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="target_selection">Selection Method</label>
                                        <select class="form-control" id="target_selection" name="target_selection">
                                            <option value="models">Select specific models</option>
                                            <option value="running_containers">Only running containers</option>
                                            <option value="custom">Custom selection</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="priority">Priority</label>
                                        <select class="form-control" id="priority" name="priority">
                                            <option value="low">Low</option>
                                            <option value="normal" selected>Normal</option>
                                            <option value="high">High</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="selected_models">Models to Test</label>
                                <select multiple class="form-control" id="selected_models" name="selected_models" size="8">
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                    <option value="claude-3-haiku">Claude 3 Haiku</option>
                                    <option value="gemini-pro">Gemini Pro</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    <option value="test_model">Test Model</option>
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple models</small>
                            </div>

                            <div class="form-group">
                                <label for="selected_apps">App Numbers</label>
                                <input type="text" class="form-control" id="selected_apps" name="selected_apps" 
                                       value="1,2,3,4,5" placeholder="1,2,3,4,5 or 1-30">
                                <small class="text-muted">Comma-separated list or range (e.g., 1-5, 10, 15-20)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Execution Options -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="concurrency">Concurrency</label>
                                <select class="form-control" id="concurrency" name="concurrency">
                                    <option value="1">1 (Sequential)</option>
                                    <option value="2" selected>2 (Recommended)</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Maximum)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="timeout">Timeout (seconds)</label>
                                <input type="number" class="form-control" id="timeout" name="timeout" 
                                       value="600" min="60" max="3600">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="fail_fast" id="fail_fast">
                                    <label class="form-check-label" for="fail_fast">
                                        Stop on first failure
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="auto_start" id="auto_start" checked>
                                    <label class="form-check-label" for="auto_start">
                                        Start immediately
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Requirements and Instructions -->
                    <div class="form-group">
                        <label for="security_requirements">Security Testing Requirements</label>
                        <textarea class="form-control" id="security_requirements" name="security_requirements" rows="4"
                                  placeholder="Enter specific security requirements, one per line:
Example:
- Check for SQL injection vulnerabilities
- Verify input validation on all forms
- Test authentication and authorization mechanisms
- Scan for XSS vulnerabilities
- Assess password security policies
- Check for sensitive data exposure
- Verify HTTPS implementation
- Test session management"></textarea>
                        <small class="text-muted">Each line will be treated as a separate requirement</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Security Test</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Infrastructure Status Modal -->
<div class="modal fade" id="infrastructureStatusModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Testing Infrastructure Status</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="infrastructure-details">
                <!-- Infrastructure details loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="test-details-content">
                <!-- Test details loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Results</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="test-results-content">
                <!-- Test results loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Security Testing Platform JavaScript
class EnhancedSecurityTestingPlatform {
    constructor() {
        this.autoRefresh = false;
        this.selectedTools = new Set();
    }

    init() {
        this.setupEventListeners();
        this.setupAutoRefresh();
        this.loadInitialData();
    }

    setupEventListeners() {
        // Tool selection event listeners
        document.querySelectorAll('input[name="tools"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                this.handleToolSelection(e.target);
            });
        });

        // Form validation
        document.getElementById('securityTestForm').addEventListener('submit', (e) => {
            if (!this.validateForm()) {
                e.preventDefault();
            }
        });
    }

    setupAutoRefresh() {
        document.querySelectorAll('[hx-trigger*="every"]').forEach(element => {
            element.setAttribute('data-auto-refresh', 'false');
        });
    }

    loadInitialData() {
        // Load available models from API
        this.loadAvailableModels();
        
        // Update stats
        this.updateStats();
    }

    handleToolSelection(checkbox) {
        const toolName = checkbox.value;
        const optionsDiv = document.getElementById(`${toolName}-options`);
        
        if (checkbox.checked) {
            this.selectedTools.add(toolName);
            if (optionsDiv) {
                optionsDiv.style.display = 'block';
            }
        } else {
            this.selectedTools.delete(toolName);
            if (optionsDiv) {
                optionsDiv.style.display = 'none';
            }
        }
    }

    validateForm() {
        const testType = document.getElementById('test_type').value;
        const jobName = document.getElementById('job_name').value;
        const selectedModels = document.getElementById('selected_models').selectedOptions;

        if (!testType) {
            alert('Please select a test type');
            return false;
        }

        if (!jobName.trim()) {
            alert('Please enter a test name');
            return false;
        }

        if (selectedModels.length === 0) {
            alert('Please select at least one model to test');
            return false;
        }

        if (this.selectedTools.size === 0 && testType.startsWith('security_')) {
            alert('Please select at least one security tool');
            return false;
        }

        return true;
    }

    async loadAvailableModels() {
        try {
            const response = await fetch('/testing/api/models');
            const data = await response.json();
            
            if (data.success) {
                this.updateModelSelect(data.data);
            }
        } catch (error) {
            console.error('Failed to load models:', error);
        }
    }

    updateModelSelect(models) {
        const select = document.getElementById('selected_models');
        select.innerHTML = '';
        
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.slug;
            option.textContent = model.name;
            select.appendChild(option);
        });
    }

    async updateStats() {
        try {
            const response = await fetch('/testing/api/jobs');
            const data = await response.json();
            
            if (data.success) {
                this.updateStatsDisplay(data.data);
            }
        } catch (error) {
            console.error('Failed to update stats:', error);
        }
    }

    updateStatsDisplay(jobs) {
        const stats = {
            total: jobs.length,
            running: jobs.filter(j => j.status === 'running').length,
            queued: jobs.filter(j => j.status === 'queued').length,
            failed: jobs.filter(j => j.status === 'failed').length
        };

        document.getElementById('total-tests').textContent = stats.total;
        document.getElementById('running-tests').textContent = stats.running;
        document.getElementById('queued-tests').textContent = stats.queued;
        document.getElementById('failed-tests').textContent = stats.failed;
    }
}

// Global functions
window.showCreateTestModal = function() {
    $('#createTestModal').modal('show');
};

window.showInfrastructureStatus = function() {
    $('#infrastructureStatusModal').modal('show');
    // Load infrastructure details
    htmx.ajax('GET', '/testing/api/infrastructure-status', {target: '#infrastructure-details'});
};

window.showTestDetails = function(testId) {
    $('#testDetailsModal').modal('show');
    htmx.ajax('GET', `/testing/api/test/${testId}/details`, {target: '#test-details-content'});
};

window.showTestResults = function(testId) {
    $('#testResultsModal').modal('show');
    htmx.ajax('GET', `/testing/api/test/${testId}/results`, {target: '#test-results-content'});
};

window.toggleAutoRefresh = function(enabled) {
    document.querySelectorAll('[hx-trigger*="every"]').forEach(element => {
        element.setAttribute('data-auto-refresh', enabled ? 'true' : 'false');
    });
    
    if (enabled) {
        htmx.trigger(document.getElementById('jobs-list'), 'load');
    }
};

window.refreshJobsList = function() {
    htmx.trigger(document.getElementById('jobs-list'), 'load');
    window.securityTestingPlatform.updateStats();
};

window.handleTestTypeChange = function(testType) {
    const zapConfig = document.getElementById('zap-config');
    const backendTools = document.getElementById('backend-tools');
    const frontendTools = document.getElementById('frontend-tools');
    const webAppTools = document.getElementById('web-app-tools');

    // Show/hide relevant tool categories
    if (testType === 'zap_scan') {
        zapConfig.style.display = 'block';
        backendTools.style.display = 'none';
        frontendTools.style.display = 'none';
    } else if (testType === 'security_backend') {
        zapConfig.style.display = 'none';
        backendTools.style.display = 'block';
        frontendTools.style.display = 'none';
        webAppTools.style.display = 'block';
    } else if (testType === 'security_frontend') {
        zapConfig.style.display = 'none';
        backendTools.style.display = 'none';
        frontendTools.style.display = 'block';
        webAppTools.style.display = 'block';
    } else if (testType === 'security_full_stack' || testType === 'comprehensive') {
        zapConfig.style.display = 'none';
        backendTools.style.display = 'block';
        frontendTools.style.display = 'block';
        webAppTools.style.display = 'block';
    } else {
        zapConfig.style.display = 'none';
        backendTools.style.display = 'block';
        frontendTools.style.display = 'block';
        webAppTools.style.display = 'block';
    }
};

window.handleZapScanTypeChange = function(scanType) {
    // Could add scan type specific options here
    console.log('ZAP scan type changed to:', scanType);
};

window.submitSecurityTestForm = function() {
    const form = document.getElementById('securityTestForm');
    const formData = new FormData(form);
    
    // Convert FormData to JSON for better handling
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (data[key]) {
            if (Array.isArray(data[key])) {
                data[key].push(value);
            } else {
                data[key] = [data[key], value];
            }
        } else {
            data[key] = value;
        }
    }

    // Submit via HTMX
    htmx.ajax('POST', '/testing/api/create', {
        headers: {
            'Content-Type': 'application/json',
        },
        values: data,
        swap: 'none'
    }).then(function(response) {
        $('#createTestModal').modal('hide');
        window.refreshJobsList();
        
        // Show success message
        const result = JSON.parse(response.xhr.responseText);
        if (result.success) {
            alert('Security test created successfully!');
        } else {
            alert('Error creating test: ' + result.error);
        }
    });
};

window.handleTestCreated = function(event) {
    const result = JSON.parse(event.detail.xhr.responseText);
    if (result.success) {
        $('#createTestModal').modal('hide');
        window.refreshJobsList();
        alert('Security test created successfully!');
    } else {
        alert('Error creating test: ' + result.error);
    }
};

window.restartTest = function(testId, button) {
    if (confirm('Are you sure you want to restart this test?')) {
        htmx.ajax('POST', `/testing/api/test/${testId}/restart`, {target: button.closest('.job-card')});
    }
};

window.cancelTest = function(testId, button) {
    if (confirm('Are you sure you want to cancel this test?')) {
        htmx.ajax('POST', `/testing/api/test/${testId}/cancel`, {target: button.closest('.job-card')});
    }
};

window.deleteTest = function(testId, button) {
    if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
        htmx.ajax('DELETE', `/testing/api/test/${testId}`, {target: button.closest('.job-card'), swap: 'delete'});
    }
};

// Initialize
let securityTestingPlatform;
document.addEventListener('DOMContentLoaded', function() {
    securityTestingPlatform = new EnhancedSecurityTestingPlatform();
    securityTestingPlatform.init();
    window.securityTestingPlatform = securityTestingPlatform;
});
</script>
{% endblock %}
