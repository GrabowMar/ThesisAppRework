{# Sample Generator Wizard - analysis-style layout #}
<div id="sample-generator-wizard">
  <div class="row row-cards g-3">
    <div class="col-xxl-8 col-xl-7 col-lg-7">
      <div class="row row-cards g-3">
        <input type="hidden" id="input-scaffolding-id" value="default">
        <input type="hidden" id="input-rerun-on-failure" value="false">
        <input type="hidden" id="input-max-retries" value="1">
        <div class="col-12 wizard-panel active" data-panel="1">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 1</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-cube text-primary"></i>
                    <span>Select Scaffolding</span>
                  </h3>
                  <div class="text-muted small">Choose the base project scaffold for generated apps.</div>
                </div>
              </div>
            </div>
            <div class="card-body border-top">
              <div class="row g-4">
                <div class="col-12 col-lg-7">
                  <div class="card border-dashed h-100">
                    <div class="card-body">
                      <h3 class="h5">Choose scaffolding</h3>
                      <p class="text-muted small">Select the project scaffolding that defines Docker setup, frontend/backed folders, and baseline configuration.</p>
                      <div id="scaffolding-selection-list" class="row g-3">
                        <div class="col-12">
                          <div class="card selectable-card" role="button" onclick="selectScaffolding('default')">
                            <div class="card-body d-flex align-items-center gap-3">
                              <div class="avatar bg-primary-lt text-primary rounded"><i class="fa-solid fa-cube"></i></div>
                              <div class="flex-fill">
                                <h4 class="h6 mb-1">Default React + Flask stack</h4>
                                <p class="text-muted small mb-0">Includes Docker Compose, Celery worker, Vite frontend, Flask API, and analyzer integration hooks.</p>
                              </div>
                              <div>
                                <span class="badge bg-success-lt" id="scaffolding-selected-indicator">Selected</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-5">
                  <div id="scaffolding-preview" class="card h-100">
                    <div class="card-header d-flex align-items-center justify-content-between">
                      <h3 class="h6 mb-0">Scaffolding overview</h3>
                      <button type="button" class="btn btn-sm btn-ghost-primary" onclick="viewScaffoldingDetails('default')">Details</button>
                    </div>
                    <div class="card-body">
                      <ul class="list-unstyled small text-muted mb-0 d-grid gap-1">
                        <li><i class="fa-solid fa-box-open me-2 text-primary"></i>Pre-configured Docker + docker-compose</li>
                        <li><i class="fa-solid fa-plug me-2 text-primary"></i>Port allocation via PortAllocationService</li>
                        <li><i class="fa-solid fa-layer-group me-2 text-primary"></i>React (Vite) frontend scaffold</li>
                        <li><i class="fa-solid fa-server me-2 text-primary"></i>Flask backend with Celery integration</li>
                        <li><i class="fa-solid fa-file-code me-2 text-primary"></i>Analyzer wiring + configuration templates</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="help-content active" data-help="1"></div>

              {# Advanced Options Section #}
              <div class="card mt-4" id="advanced-options-section">
                <div class="card-header d-flex align-items-center justify-content-between" data-bs-toggle="collapse" data-bs-target="#advanced-options-collapse" role="button" aria-expanded="false" aria-controls="advanced-options-collapse">
                  <h3 class="h6 mb-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-cogs text-primary"></i>
                    <span>Advanced Options</span>
                  </h3>
                  <span class="collapse-indicator text-muted small" id="advanced-options-indicator">Show</span>
                </div>
                <div id="advanced-options-collapse" class="collapse">
                  <div class="card-body">
                    <p class="text-muted small mb-3">Configure retry behavior for failed generations.</p>
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="form-check form-switch mb-2">
                          <input class="form-check-input" type="checkbox" id="option-rerun-on-failure" onchange="updateAdvancedOption('rerun-on-failure', this.checked)">
                          <label class="form-check-label" for="option-rerun-on-failure">
                            <strong>Rerun failed generations</strong>
                          </label>
                        </div>
                        <small class="text-muted d-block ms-4">Automatically retry generation if it fails</small>
                        <div class="ms-4 mt-2" id="max-retries-container" style="display: none;">
                          <label class="form-label small text-muted" for="option-max-retries">Max retry attempts:</label>
                          <select class="form-select form-select-sm w-auto" id="option-max-retries" onchange="updateAdvancedOption('max-retries', this.value)">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>

              {# Past Generations Table - inside Step 1 panel #}
              <div class="card card-table-compact mt-4" id="past-generations-section">
                <div class="card-header d-flex flex-wrap align-items-center gap-3">
                  <div class="d-flex flex-wrap align-items-center gap-2">
                    <h3 class="card-title d-flex align-items-center gap-2 mb-0">
                      <i class="fa-solid fa-history text-primary"></i>
                      <span>Past Generations</span>
                    </h3>
                    <div class="d-flex flex-wrap align-items-center gap-2 status-indicators">
                      <span class="badge bg-primary-lt d-inline-flex align-items-center gap-2">
                        <i class="fa-solid fa-code"></i>
                        <span id="past-generations-count">{{ recent|length if recent else 0 }}</span>
                      </span>
                    </div>
                  </div>
                  <div class="card-actions d-flex flex-wrap align-items-center gap-2 ms-auto">
                    <label class="d-flex align-items-center gap-2 mb-0">
                      <span class="text-muted small">Limit:</span>
                      <select id="past-generations-per-page" class="form-select form-select-sm w-auto" onchange="loadPastGenerations(this.value)">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                      </select>
                    </label>
                    <div class="btn-list">
                      <button class="btn btn-sm btn-primary" onclick="loadPastGenerations()" title="Refresh past generations" type="button">
                        <i class="fa-solid fa-sync me-1" aria-hidden="true"></i>Refresh
                      </button>
                    </div>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-striped table-vcenter table-hover table-sm card-table mb-0">
                    <thead>
                      <tr>
                        <th scope="col">Timestamp</th>
                        <th scope="col">Application</th>
                        <th scope="col">Model</th>
                        <th scope="col" class="text-center">Status</th>
                        <th scope="col">Log Message</th>
                        <th scope="col" class="text-end">Duration</th>
                        <th scope="col" class="w-1"><span class="visually-hidden">Actions</span></th>
                      </tr>
                    </thead>
                    <tbody id="past-generations-tbody">
                      {% if recent and recent|length %}
                        {% for r in recent %}
                          {% set ts = r.timestamp %}
                          {% if ts is string %}
                            {% set timestamp = ts %}
                          {% elif ts and ts.strftime is defined %}
                            {% set timestamp = ts.strftime('%Y-%m-%d %H:%M:%S') %}
                          {% else %}
                            {% set timestamp = '—' %}
                          {% endif %}
                          <tr>
                            <td class="text-muted small text-nowrap">{{ timestamp }}</td>
                            <td>
                              <strong>{{ r.app_name or ('App #' ~ (r.app_num or '?')) }}</strong>
                            </td>
                            <td>
                              <span class="badge bg-azure-lt text-azure">{{ r.model or '—' }}</span>
                            </td>
                            <td class="text-center">
                              {% if r.status == 'completed' %}
                                <span class="badge bg-success-lt text-success">
                                  <i class="fa-solid fa-check me-1"></i>Success
                                </span>
                              {% elif r.status == 'failed' %}
                                <span class="badge bg-danger-lt text-danger">
                                  <i class="fa-solid fa-times me-1"></i>Failed
                                </span>
                              {% elif r.status == 'running' %}
                                <span class="badge bg-info-lt text-info">
                                  <i class="fa-solid fa-spinner fa-spin me-1"></i>Running
                                </span>
                              {% else %}
                                <span class="badge bg-warning-lt text-warning">
                                  <i class="fa-solid fa-clock me-1"></i>Pending
                                </span>
                              {% endif %}
                            </td>
                            <td class="text-muted small" style="max-width: 250px;">
                              {% if r.error_message %}
                                <span class="text-truncate d-inline-block" style="max-width: 240px;" title="{{ r.error_message }}">
                                  {{ r.error_message }}
                                </span>
                              {% else %}
                                <span class="text-muted">—</span>
                              {% endif %}
                            </td>
                            <td class="text-end text-muted small">
                              {{ '%.1fs'|format(r.duration) if r.duration else '—' }}
                            </td>
                            <td>
                              <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-ghost-primary btn-icon"
                                        onclick="viewGenerationResult('{{ r.result_id or (r.model ~ '_app' ~ r.app_num) }}')"
                                        title="View details">
                                  <i class="fa-solid fa-eye"></i>
                                </button>
                              </div>
                            </td>
                          </tr>
                        {% endfor %}
                      {% else %}
                        <tr id="past-generations-empty">
                          <td colspan="7" class="text-center py-5">
                            <div class="empty py-4">
                              <div class="empty-icon">
                                <i class="fa-solid fa-history fa-3x text-muted"></i>
                              </div>
                              <p class="empty-title h5">No past generations</p>
                              <p class="empty-subtitle text-muted">Generated applications will appear here</p>
                            </div>
                          </td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 wizard-panel" data-panel="2">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 2</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-layer-group text-primary"></i>
                    <span>Select Templates &amp; Models</span>
                  </h3>
                  <div class="text-muted small">Pick the requirements and AI models to combine.</div>
                </div>
              </div>
            </div>
            <div class="card-body border-top">
              <div class="row g-4">
                <div class="col-12 col-xl-6">
                  <div class="card card-table-compact h-100">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                      <h3 class="h6 mb-0"><i class="fa-solid fa-file-code text-primary me-2"></i>Templates</h3>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-ghost-primary" onclick="selectAllTemplates()">Select all</button>
                        <button type="button" class="btn btn-ghost-secondary" onclick="clearAllTemplates()">Clear</button>
                      </div>
                    </div>
                    <div class="card-body border-top p-0">
                      <div class="p-3 border-bottom">
                        <div class="input-group input-group-sm">
                          <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                          <input type="search" class="form-control" placeholder="Search templates..." id="template-search-input" oninput="filterTemplates(this.value)">
                        </div>
                      </div>
                      <div id="template-selection-list" class="table-responsive" style="max-height: calc(100vh - 380px); min-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted py-5">
                          <div class="spinner-border text-primary"></div>
                          <p class="small mb-0 mt-3">Loading templates...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-xl-6">
                  <div class="card card-table-compact h-100">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                      <h3 class="h6 mb-0"><i class="fa-solid fa-brain text-primary me-2"></i>Models</h3>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-ghost-primary" onclick="selectAllModels()">Select all</button>
                        <button type="button" class="btn btn-ghost-secondary" onclick="clearAllModels()">Clear</button>
                      </div>
                    </div>
                    <div class="card-body border-top p-0">
                      <div class="p-3 border-bottom">
                        <div class="input-group input-group-sm">
                          <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                          <input type="search" class="form-control" placeholder="Search models..." id="model-search-input" oninput="filterModels(this.value)">
                        </div>
                      </div>
                      <div id="model-selection-list" class="table-responsive" style="max-height: calc(100vh - 380px); min-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted py-5">
                          <div class="spinner-border text-primary"></div>
                          <p class="small mb-0 mt-3">Loading models...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="help-content" data-help="2"></div>
            </div>
          </div>
        </div>

        <div class="col-12 wizard-panel" data-panel="3">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 3</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-primary"></i>
                    <span>Review &amp; Generate</span>
                  </h3>
                  <div class="text-muted small">Confirm selections, launch generation, and track results.</div>
                </div>
              </div>
            </div>
            <div class="card-body border-top">
              <div class="row g-3">
                {# Compact inline summary bar #}
                <div class="col-12">
                  <div class="d-flex align-items-center gap-3 flex-wrap small">
                    <span class="text-muted">Combinations: <strong id="summary-total-generations" class="text-primary">0</strong></span>
                    <span class="text-muted">Scaffolding: <strong id="status-scaffolding">Default React + Flask</strong></span>
                    <span class="text-muted">Templates: <strong id="status-templates">0</strong></span>
                    <span class="text-muted">Models: <strong id="status-models">0</strong></span>
                    <span class="text-muted">Avg $/1K: <strong id="status-cost">–</strong></span>
                  </div>
                </div>

                {# Progress bar + counters #}
                <div class="col-12">
                  <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="flex-fill">
                      <div class="progress" style="height: 6px;">
                        <div id="overall-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%;"></div>
                      </div>
                    </div>
                    <span class="small text-muted"><strong id="progress-completed">0</strong>/<strong id="progress-total">0</strong></span>
                  </div>
                  <div class="d-flex gap-3 small">
                    <span class="text-success"><i class="fa-solid fa-check me-1"></i><strong id="status-completed">0</strong> Succeeded</span>
                    <span class="text-danger"><i class="fa-solid fa-times me-1"></i><strong id="status-failed">0</strong> Failed</span>
                    <span class="text-muted"><i class="fa-solid fa-spinner me-1"></i><strong id="status-in-progress">0</strong> In progress</span>
                    <span class="text-muted ms-auto" id="status-total" style="display:none;">0</span>
                  </div>
                </div>

                {# Results table #}
                <div class="col-12">
                  <div class="card card-sm">
                    <div class="card-header d-flex align-items-center justify-content-between py-2">
                      <h3 class="h6 mb-0">Generation results</h3>
                      <span class="badge bg-secondary-lt" id="results-count-badge">0 rows</span>
                    </div>
                    <div class="card-body p-0 table-responsive" style="max-height: calc(100vh - 400px); min-height: 150px; overflow-y: auto;">
                      <table class="table table-sm align-middle mb-0">
                        <thead class="text-muted small">
                          <tr>
                            <th style="width: 40px;">#</th>
                            <th>Template</th>
                            <th>Model</th>
                            <th>Status</th>
                            <th>Message</th>
                          </tr>
                        </thead>
                        <tbody id="generation-results-body">
                          <tr id="generation-empty-state">
                            <td colspan="5" class="text-center text-muted py-4">
                              <i class="fa-solid fa-robot fa-2x mb-3 opacity-50"></i>
                              <p class="mb-0">No generation results yet. Configure selections and press <strong>Start generation</strong>.</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="help-content" data-help="3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-4 col-xl-5 col-lg-5">
      <div class="analysis-sidebar right-sticky-sidebar sticky-top">
        {# Unified wizard navigation card #}
        <div class="card card-sm mb-2" id="wizard-nav-card">
          <div class="card-body p-0">
            {# Step indicators as clickable bar #}
            <div class="d-flex border-bottom" style="font-size: 0.8rem;">
              <button class="btn btn-ghost-primary flex-fill py-2 rounded-0 border-end step-nav-btn active"
                      data-step="1" _="on click call goToStep(1)" style="border-top-left-radius: var(--tblr-card-border-radius) !important;">
                <i class="fa-solid fa-cube me-1"></i>Scaffold
              </button>
              <button class="btn btn-ghost-primary flex-fill py-2 rounded-0 border-end step-nav-btn"
                      data-step="2" _="on click call goToStep(2)">
                <i class="fa-solid fa-layer-group me-1"></i>Selections
              </button>
              <button class="btn btn-ghost-primary flex-fill py-2 rounded-0 step-nav-btn"
                      data-step="3" _="on click call goToStep(3)" style="border-top-right-radius: var(--tblr-card-border-radius) !important;">
                <i class="fa-solid fa-clipboard-check me-1"></i>Review
              </button>
            </div>
            {# Progress bar #}
            <div class="progress rounded-0" style="height: 3px;">
              <div class="progress-bar bg-primary" role="progressbar" id="wizard-progress-bar"
                aria-label="Sample generator progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            {# Actions row #}
            <div class="d-flex align-items-center gap-2 px-3 py-2">
              <button type="button" class="btn btn-ghost-secondary btn-sm py-1 px-2" id="prev-btn" _="on click call previousStep()" disabled>
                <i class="fa-solid fa-chevron-left"></i> Back
              </button>
              <div class="d-flex align-items-center gap-2 small text-muted flex-fill justify-content-center">
                <span><strong id="sidebar-template-count">0</strong>T × <strong id="sidebar-model-count">0</strong>M = <strong id="sidebar-total-pairs">0</strong> pairs</span>
              </div>
              <button type="button" class="btn btn-primary btn-sm py-1 px-2" id="next-btn" _="on click call nextStep()">
                Next <i class="fa-solid fa-chevron-right ms-1"></i>
              </button>
              <button type="button" class="btn btn-success btn-sm py-1 px-2 d-none" id="start-btn">
                <i class="fa-solid fa-play me-1"></i>Start
              </button>
              <button type="button" class="btn btn-success btn-sm py-1 px-2 d-none" id="start-btn-loading" disabled>
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>Generating...
              </button>
            </div>
          </div>
        </div>

        {# Hidden compat elements #}
        <span id="current-step" style="display:none;">1</span>
        <span id="progress-percentage" style="display:none;">0%</span>
        <span id="selection-total-pairs" style="display:none;">0</span>
        <span id="selection-template-count" style="display:none;">0</span>
        <span id="selection-model-count" style="display:none;">0</span>
        <span id="selection-average-cost" style="display:none;">–</span>
        <span id="selection-cost-note" style="display:none;"></span>

        {# Summary card - compact #}
        <div class="card card-sm mb-2">
          <div class="card-body p-2">
            <div class="mb-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-muted">Scaffolding</span>
                <span id="sidebar-scaffolding-badge" class="badge bg-success-lt" style="font-size: 0.65em;">Selected</span>
              </div>
              <div id="sidebar-scaffolding-name" class="small fw-semibold">Default React + Flask stack</div>
            </div>
            <div class="border-top pt-2 mt-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-muted">Templates</span>
                <div class="d-flex align-items-center gap-2">
                  <button type="button" class="btn btn-link p-0 small text-danger d-none" id="clear-templates-btn" onclick="clearAllTemplates()" style="font-size: 0.75em;">clear</button>
                </div>
              </div>
              <ul id="sidebar-template-list" class="list-unstyled small text-muted mb-0" style="max-height: calc(100vh - 500px); min-height: 60px; overflow-y: auto;">
                <li class="text-muted">No templates selected</li>
              </ul>
            </div>
            <div class="border-top pt-2 mt-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-muted">Models</span>
                <div class="d-flex align-items-center gap-2">
                  <button type="button" class="btn btn-link p-0 small text-danger d-none" id="clear-models-btn" onclick="clearAllModels()" style="font-size: 0.75em;">clear</button>
                </div>
              </div>
              <ul id="sidebar-model-list" class="list-unstyled small text-muted mb-0" style="max-height: calc(100vh - 500px); min-height: 60px; overflow-y: auto;">
                <li class="text-muted">No models selected</li>
              </ul>
            </div>
            <div class="d-flex align-items-center gap-3 border-top pt-2 mt-2 small">
              <span class="text-muted">Avg $/1K: <strong id="sidebar-average-cost">–</strong></span>
              <span id="sidebar-cost-note" class="text-muted ms-auto" style="font-size: 0.8em;"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .step-nav-btn.active { font-weight: 600; color: var(--tblr-primary) !important; border-bottom: 2px solid var(--tblr-primary) !important; background: transparent !important; }
  .step-nav-btn { font-weight: 400; color: var(--tblr-muted) !important; transition: all 0.15s; background: transparent !important; }
  .step-nav-btn:hover { color: var(--tblr-primary) !important; background: rgba(var(--tblr-primary-rgb), 0.04) !important; }
</style>
