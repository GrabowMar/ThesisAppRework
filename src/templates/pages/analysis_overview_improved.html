{% extends "layouts/base_layout.html" %}

{% block title %}Security Analysis Center{% endblock %}

{% block head %}
<style>
    .analysis-card {
        transition: all 0.3s ease;
        border: 1px solid #e3e6f0;
    }
    
    .analysis-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: #5a5c69;
    }
    
    .tool-status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .severity-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
    
    .analysis-progress {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .results-container {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .filter-tabs .nav-link {
        border-radius: 20px;
        margin-right: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .filter-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
    }
    
    .quick-action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: scale(1.02);
    }
    
    .analysis-type-selector {
        border-radius: 10px;
        border: 2px solid #e3e6f0;
        transition: all 0.3s ease;
    }
    
    .analysis-type-selector:hover {
        border-color: #5a5c69;
        background-color: #f8f9fa;
    }
    
    .analysis-type-selector.selected {
        border-color: #4e73df;
        background-color: #eef2ff;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">
            <i class="fas fa-shield-alt text-primary"></i>
            Security Analysis Center
        </h1>
        <p class="text-muted mb-0">Comprehensive security and quality analysis of AI-generated applications</p>
    </div>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary" 
                data-toggle="modal" 
                data-target="#batchAnalysisModal">
            <i class="fas fa-tasks"></i> Batch Analysis
        </button>
        <button type="button" class="btn btn-outline-secondary" 
                hx-get="/analysis/reports"
                hx-target="#main-content"
                hx-push-url="true">
            <i class="fas fa-chart-bar"></i> Analysis Reports
        </button>
        <button type="button" class="btn btn-outline-info"
                hx-get="/analysis/history"
                hx-target="#main-content"
                hx-push-url="true">
            <i class="fas fa-history"></i> History
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Enhanced Analysis Statistics -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card card border-left-primary">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total Analyses
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" 
                                     id="total-analyses"
                                     hx-get="/api/analysis/stats/total"
                                     hx-trigger="load, every 30s">
                                    {{ analysis_stats.total_analyses or 0 }}
                                </div>
                                <div class="text-xs text-muted">
                                    <span class="text-success">
                                        <i class="fas fa-arrow-up"></i> {{ analysis_stats.growth_rate or 0 }}%
                                    </span>
                                    vs last week
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-search fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card card border-left-success">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Completed Today
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     id="completed-today"
                                     hx-get="/api/analysis/stats/today"
                                     hx-trigger="load, every 30s">
                                    {{ analysis_stats.completed_today or 0 }}
                                </div>
                                <div class="text-xs text-muted">
                                    Success rate: <span class="text-success">{{ analysis_stats.success_rate or 95 }}%</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card card border-left-warning">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Running Analyses
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     id="running-analyses"
                                     hx-get="/api/analysis/stats/running"
                                     hx-trigger="load, every 5s">
                                    {{ analysis_stats.running_analyses or 0 }}
                                </div>
                                <div class="analysis-progress progress">
                                    <div class="progress-bar bg-warning" 
                                         style="width: {{ analysis_stats.avg_progress or 0 }}%">
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-cog fa-spin fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card card border-left-danger">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                    Critical Issues
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     id="critical-issues"
                                     hx-get="/api/analysis/stats/critical"
                                     hx-trigger="load, every 30s">
                                    {{ analysis_stats.critical_issues or 0 }}
                                </div>
                                <div class="text-xs text-muted">
                                    <span class="text-warning">{{ analysis_stats.medium_issues or 0 }}</span> medium,
                                    <span class="text-info">{{ analysis_stats.low_issues or 0 }}</span> low
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Quick Analysis Panel -->
    <div class="col-lg-8 mb-4">
        <div class="analysis-card card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-rocket"></i> Quick Analysis
                </h6>
            </div>
            <div class="card-body">
                <form id="quick-analysis-form" 
                      hx-post="/analysis/quick" 
                      hx-target="#quick-analysis-results"
                      hx-indicator="#quick-analysis-loading">
                    
                    <!-- Model and App Selection -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="model-select" class="font-weight-bold">Select Model</label>
                            <select class="form-control" id="model-select" name="model_slug" required>
                                <option value="">Choose a model...</option>
                                {% for model in available_models %}
                                <option value="{{ model.canonical_slug }}" 
                                        data-apps="{{ model.total_apps or 30 }}">
                                    {{ model.model_name }}
                                    <small class="text-muted">({{ model.total_apps or 30 }} apps)</small>
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="app-select" class="font-weight-bold">Select Application</label>
                            <select class="form-control" id="app-select" name="app_number" required disabled>
                                <option value="">Choose an application...</option>
                                {% for i in range(1, 31) %}
                                <option value="{{ i }}">App {{ i }} - {{ app_types.get(i, 'Unknown') }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Analysis Type Selection -->
                    <div class="mb-3">
                        <label class="font-weight-bold mb-2">Analysis Types</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="analysis-type-selector p-3 mb-2" data-type="backend_security">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="backend-security" name="analysis_types" value="backend_security" checked>
                                        <label class="custom-control-label font-weight-bold" for="backend-security">
                                            <i class="fas fa-server text-primary"></i> Backend Security
                                        </label>
                                    </div>
                                    <p class="text-muted small mb-0 mt-1">
                                        Python security analysis, dependency scanning, and vulnerability detection
                                    </p>
                                    <div class="mt-2">
                                        <span class="tool-status-badge badge badge-success">Bandit</span>
                                        <span class="tool-status-badge badge badge-success">Safety</span>
                                        <span class="tool-status-badge badge badge-secondary">Semgrep</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="analysis-type-selector p-3 mb-2" data-type="frontend_security">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="frontend-security" name="analysis_types" value="frontend_security" checked>
                                        <label class="custom-control-label font-weight-bold" for="frontend-security">
                                            <i class="fab fa-js-square text-warning"></i> Frontend Security
                                        </label>
                                    </div>
                                    <p class="text-muted small mb-0 mt-1">
                                        JavaScript security analysis, dependency auditing, and library scanning
                                    </p>
                                    <div class="mt-2">
                                        <span class="tool-status-badge badge badge-success">ESLint</span>
                                        <span class="tool-status-badge badge badge-success">npm audit</span>
                                        <span class="tool-status-badge badge badge-warning">Retire.js</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="analysis-type-selector p-3 mb-2" data-type="backend_quality">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="backend-quality" name="analysis_types" value="backend_quality">
                                        <label class="custom-control-label font-weight-bold" for="backend-quality">
                                            <i class="fas fa-code text-info"></i> Backend Quality
                                        </label>
                                    </div>
                                    <p class="text-muted small mb-0 mt-1">
                                        Code quality analysis, complexity metrics, and style checking
                                    </p>
                                    <div class="mt-2">
                                        <span class="tool-status-badge badge badge-success">Pylint</span>
                                        <span class="tool-status-badge badge badge-success">Flake8</span>
                                        <span class="tool-status-badge badge badge-info">Radon</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="analysis-type-selector p-3 mb-2" data-type="zap_security">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="zap-security" name="analysis_types" value="zap_security">
                                        <label class="custom-control-label font-weight-bold" for="zap-security">
                                            <i class="fas fa-globe text-danger"></i> Web Security (ZAP)
                                        </label>
                                    </div>
                                    <p class="text-muted small mb-0 mt-1">
                                        OWASP ZAP dynamic security testing and vulnerability assessment
                                    </p>
                                    <div class="mt-2">
                                        <span class="tool-status-badge badge badge-danger">OWASP ZAP</span>
                                        <span class="tool-status-badge badge badge-info">Dynamic</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="card border-light mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-cog"></i> Advanced Options
                                <button class="btn btn-sm btn-link text-muted float-right" 
                                        type="button" data-toggle="collapse" 
                                        data-target="#advanced-options">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h6>
                        </div>
                        <div id="advanced-options" class="collapse">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="font-weight-bold">Analysis Depth</label>
                                            <select class="form-control" name="analysis_depth">
                                                <option value="quick">Quick Scan</option>
                                                <option value="standard" selected>Standard Analysis</option>
                                                <option value="deep">Deep Analysis</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="font-weight-bold">Severity Filter</label>
                                            <select class="form-control" name="severity_filter">
                                                <option value="all">All Severities</option>
                                                <option value="medium_and_above" selected>Medium and Above</option>
                                                <option value="high_only">High and Critical Only</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="font-weight-bold">Timeout (minutes)</label>
                                            <input type="number" class="form-control" name="timeout" 
                                                   value="10" min="1" max="60">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" 
                                                   id="use-all-tools" name="use_all_tools">
                                            <label class="custom-control-label" for="use-all-tools">
                                                Use all available tools (slower but comprehensive)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" 
                                                   id="force-rerun" name="force_rerun">
                                            <label class="custom-control-label" for="force-rerun">
                                                Force re-run (ignore cached results)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="quick-action-grid">
                            <button type="button" class="btn btn-outline-info btn-sm" 
                                    onclick="selectPreset('security')">
                                <i class="fas fa-shield-alt"></i> Security Focus
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" 
                                    onclick="selectPreset('quality')">
                                <i class="fas fa-code"></i> Quality Focus
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                    onclick="selectPreset('comprehensive')">
                                <i class="fas fa-search-plus"></i> Full Analysis
                            </button>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play"></i> Start Analysis
                            <div id="quick-analysis-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                        </button>
                    </div>
                </form>

                <!-- Quick Analysis Results -->
                <div id="quick-analysis-results" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Analysis Queue & Status -->
    <div class="col-lg-4 mb-4">
        <div class="analysis-card card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list"></i> Analysis Queue
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="analysis-queue" 
                     hx-get="/api/analysis/queue"
                     hx-trigger="load, every 10s"
                     class="results-container">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted small">Loading queue...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Analysis Results with Enhanced Filters -->
    <div class="col-12">
        <div class="analysis-card card shadow">
            <div class="card-header py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> Recent Analysis Results
                    </h6>
                    <div class="d-flex align-items-center">
                        <!-- Filter Tabs -->
                        <ul class="filter-tabs nav nav-pills nav-sm mr-3" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" 
                                   hx-get="/analysis/recent?filter=all"
                                   hx-target="#recent-results-table">All</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#"
                                   hx-get="/analysis/recent?filter=completed"
                                   hx-target="#recent-results-table">Completed</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#"
                                   hx-get="/analysis/recent?filter=running"
                                   hx-target="#recent-results-table">Running</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#"
                                   hx-get="/analysis/recent?filter=failed"
                                   hx-target="#recent-results-table">Failed</a>
                            </li>
                        </ul>
                        <!-- Export Button -->
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                hx-get="/analysis/export"
                                hx-target="#export-results">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="results-container">
                    <div id="recent-results-table"
                         hx-get="/analysis/recent"
                         hx-trigger="load, every 30s">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading recent analysis results...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Batch Analysis Modal -->
<div class="modal fade" id="batchAnalysisModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks"></i> Batch Analysis Configuration
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form hx-post="/analysis/batch/start" 
                  hx-target="#batch-analysis-result"
                  hx-indicator="#batch-loading">
                <div class="modal-body">
                    <!-- Batch analysis configuration would go here -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="font-weight-bold">Select Models</h6>
                            <!-- Model selection checkboxes -->
                        </div>
                        <div class="col-md-6">
                            <h6 class="font-weight-bold">Analysis Configuration</h6>
                            <!-- Analysis type and options -->
                        </div>
                    </div>
                    <div id="batch-analysis-result"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play"></i> Start Batch Analysis
                        <div id="batch-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="export-results"></div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced JavaScript for improved analysis interface
document.addEventListener('DOMContentLoaded', function() {
    // Analysis type selector interactions
    document.querySelectorAll('.analysis-type-selector').forEach(function(selector) {
        selector.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                this.classList.toggle('selected', checkbox.checked);
            }
        });
    });

    // Model selection handler
    document.getElementById('model-select').addEventListener('change', function() {
        const modelSlug = this.value;
        const appSelect = document.getElementById('app-select');
        
        if (modelSlug) {
            appSelect.disabled = false;
            // You could add HTMX call to get available apps for this model
        } else {
            appSelect.disabled = true;
            appSelect.value = '';
        }
    });

    // Auto-refresh logic for running analyses
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.status === 200) {
            if (event.target.id === 'running-analyses') {
                const runningCount = parseInt(event.target.textContent);
                if (runningCount > 0) {
                    // Refresh other components more frequently
                    htmx.trigger('#recent-results-table', 'refresh');
                    htmx.trigger('#analysis-queue', 'refresh');
                }
            }
        }
    });

    // Filter tabs interaction
    document.querySelectorAll('.filter-tabs .nav-link').forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.filter-tabs .nav-link').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
});

// Preset selection functions
function selectPreset(type) {
    const checkboxes = document.querySelectorAll('input[name="analysis_types"]');
    const selectors = document.querySelectorAll('.analysis-type-selector');
    
    // Clear all selections
    checkboxes.forEach(cb => cb.checked = false);
    selectors.forEach(s => s.classList.remove('selected'));
    
    switch(type) {
        case 'security':
            document.getElementById('backend-security').checked = true;
            document.getElementById('frontend-security').checked = true;
            document.getElementById('zap-security').checked = true;
            break;
        case 'quality':
            document.getElementById('backend-quality').checked = true;
            // Add frontend quality when available
            break;
        case 'comprehensive':
            checkboxes.forEach(cb => cb.checked = true);
            break;
    }
    
    // Update visual state
    checkboxes.forEach(cb => {
        const selector = cb.closest('.analysis-type-selector');
        if (selector) {
            selector.classList.toggle('selected', cb.checked);
        }
    });
}

// Real-time progress updates
function startProgressPolling(analysisId) {
    const interval = setInterval(() => {
        htmx.ajax('GET', `/api/analysis/progress/${analysisId}`, {
            target: '#quick-analysis-results',
            swap: 'innerHTML'
        }).then(response => {
            if (response.includes('completed') || response.includes('failed')) {
                clearInterval(interval);
            }
        });
    }, 2000);
}
</script>
{% endblock %}
