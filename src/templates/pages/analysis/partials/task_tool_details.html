{# Tool execution details and output logs #}
{% set summary = payload.summary or {} %}
{% set tools_used = payload.tools_used or [] %}

<div class="card">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2 py-2">
    <div class="d-flex align-items-center gap-2">
      <strong class="small text-uppercase">Tool Execution Details</strong>
      <span class="badge bg-green-lt">{{ tools_used|length }} tools executed</span>
    </div>
    <div class="small text-muted">
      Analysis Duration: {{ "%.1f"|format((payload.metadata or {}).get('analysis_duration', 0)) }}s
    </div>
  </div>
  <div class="card-body p-3">
    
    {% if tool_metrics %}
      <div class="row g-3">
        {% for tool_name, metrics in tool_metrics.items() %}
        <div class="col-md-6 col-lg-4">
          <div class="border rounded p-3 h-100">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0 text-uppercase">{{ tool_name }}</h6>
              {% set status = metrics.get('status', 'unknown') %}
              <span class="badge bg-{{ 'success' if status in ['success', 'no_issues'] else 'danger' if status == 'error' else 'warning' }}">
                {{ status }}
              </span>
            </div>
            
            <dl class="row mb-2 small">
              <dt class="col-5">Issues Found</dt>
              <dd class="col-7 mb-1">{{ metrics.get('total_issues', 0) }}</dd>
              
              {% if metrics.get('files_analyzed') %}
              <dt class="col-5">Files Analyzed</dt>
              <dd class="col-7 mb-1">{{ metrics.get('files_analyzed', 0) }}</dd>
              {% endif %}
              
              {% if metrics.get('config_used') %}
              <dt class="col-5">Configuration</dt>
              <dd class="col-7 mb-1">
                {% set config = metrics.get('config_used', {}) %}
                {% if config.get('enabled') == false %}
                  <span class="text-muted">Disabled</span>
                {% else %}
                  <span class="text-success">Custom</span>
                {% endif %}
              </dd>
              {% endif %}
              
              {% if metrics.get('metrics') %}
                {% set tool_metrics_data = metrics.get('metrics', {}) %}
                {% if tool_metrics_data.get('loc') %}
                <dt class="col-5">Lines of Code</dt>
                <dd class="col-7 mb-1">{{ tool_metrics_data.get('loc') }}</dd>
                {% endif %}
                {% if tool_metrics_data.get('nosec') %}
                <dt class="col-5">Nosec Comments</dt>
                <dd class="col-7 mb-1">{{ tool_metrics_data.get('nosec') }}</dd>
                {% endif %}
                {% if tool_metrics_data.get('skipped_tests') %}
                <dt class="col-5">Skipped Tests</dt>
                <dd class="col-7 mb-1">{{ tool_metrics_data.get('skipped_tests') }}</dd>
                {% endif %}
              {% endif %}
            </dl>
            
            {% if metrics.get('error') %}
            <div class="alert alert-danger alert-sm mb-2">
              <strong>Error:</strong> {{ metrics.get('error') }}
            </div>
            {% endif %}
            
            {% if metrics.get('config_used') and metrics.get('config_used', {}).keys()|list|length > 1 %}
            <details class="small">
              <summary class="text-muted cursor-pointer">Configuration Details</summary>
              <pre class="mt-2 mb-0 small bg-light p-2 rounded">{{ metrics.get('config_used', {}) | tojson(indent=2) }}</pre>
            </details>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      {# Fallback: derive per-tool summaries from consolidated raw_outputs.tools #}
      {% set raw_outputs = payload.raw_outputs or {} %}
      {% set consolidated_tools = {} %}
      {% for analyzer_name, block in raw_outputs.items() if block.tools %}
        {% for tname, tdata in block.tools.items() %}
          {% if tname not in consolidated_tools %}
            {% set _ = consolidated_tools.update({tname: tdata}) %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {% if consolidated_tools %}
      <div class="row g-3">
        {% for tool_name, metrics in consolidated_tools.items() %}
        <div class="col-md-6 col-lg-4">
          <div class="border rounded p-3 h-100">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0 text-uppercase">{{ tool_name }}</h6>
              {% set status = metrics.get('status','unknown') %}
              <span class="badge bg-{{ 'success' if status in ['success','no_issues'] else 'danger' if status == 'error' else 'warning' if status in ['unknown'] else 'secondary' }}">{{ status }}</span>
            </div>
            <dl class="row mb-2 small">
              <dt class="col-5">Issues</dt><dd class="col-7 mb-1">{{ metrics.get('total_issues', metrics.get('issues', [])|length) }}</dd>
              {% if metrics.get('files_analyzed') %}<dt class="col-5">Files</dt><dd class="col-7 mb-1">{{ metrics.get('files_analyzed') }}</dd>{% endif %}
            </dl>
            {% if metrics.get('issues') and metrics.get('issues')|length > 0 %}
            <details class="small">
              <summary class="text-muted cursor-pointer">Sample Issues</summary>
              <pre class="mt-2 mb-0 bg-light p-2 rounded small">{{ (metrics.get('issues')[:5]) | tojson(indent=2) }}</pre>
            </details>
            {% elif metrics.get('results') and metrics.get('results')|length > 0 %}
            <details class="small">
              <summary class="text-muted cursor-pointer">Sample Results</summary>
              <pre class="mt-2 mb-0 bg-light p-2 rounded small">{{ (metrics.get('results')[:5]) | tojson(indent=2) }}</pre>
            </details>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center text-muted py-4">
        <i class="fa-solid fa-tools fa-2x mb-2"></i>
        <p class="mb-0">No detailed tool metrics available</p>
      </div>
      {% endif %}
    {% endif %}
    
    {% if payload.structure_analysis %}
    <hr class="my-3">
    <div class="mb-3">
      <h6 class="text-uppercase mb-2">Project Structure Analysis</h6>
      {% set structure = payload.structure_analysis %}
      {% if structure.get('file_counts') %}
      <div class="row g-2">
        {% for file_type, count in structure.get('file_counts', {}).items() %}
        {% if count > 0 %}
        <div class="col-auto">
          <span class="badge bg-blue-lt">{{ file_type }}: {{ count }}</span>
        </div>
        {% endif %}
        {% endfor %}
      </div>
      {% endif %}
      
      {% if structure.get('security_files') %}
      <div class="mt-2">
        <small class="text-muted d-block mb-1">Security-relevant files detected:</small>
        <div class="d-flex flex-wrap gap-1">
          {% for file_name, exists in structure.get('security_files', {}).items() %}
          {% if exists %}
          <span class="badge bg-success-lt">{{ file_name }}</span>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}
    
    {% if summary %}
    <hr class="my-3">
    <div class="row g-3">
      <div class="col-md-6">
        <h6 class="text-uppercase mb-2">Analysis Summary</h6>
        <dl class="row small mb-0">
          <dt class="col-6">Status</dt>
          <dd class="col-6">{{ summary.get('analysis_status', 'unknown') }}</dd>
          <dt class="col-6">Tools Run</dt>
          <dd class="col-6">{{ summary.get('tools_run_successfully', 0) }}</dd>
          <dt class="col-6">Configuration</dt>
          <dd class="col-6">{{ summary.get('configuration_preset', 'default') }}</dd>
        </dl>
      </div>
      
      {% if summary.get('severity_breakdown') %}
      <div class="col-md-6">
        <h6 class="text-uppercase mb-2">Severity Breakdown</h6>
        <div class="d-flex flex-wrap gap-1">
          {% for severity, count in summary.get('severity_breakdown', {}).items() %}
          {% if count > 0 %}
          <span class="badge bg-{{ 'danger' if severity in ['error', 'critical'] else 'warning' if severity in ['warning', 'high'] else 'info' }}">
            {{ severity }}: {{ count }}
          </span>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}
    
  </div>
</div>