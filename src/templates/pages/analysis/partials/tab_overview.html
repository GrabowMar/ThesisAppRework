{# Overview Tab - Task Summary and Key Metrics #}

<div class="row g-3 mb-4">
  <!-- Task Status Overview -->
  <div class="col-lg-8">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="fas fa-info-circle text-info"></i>
        <strong>Task Summary</strong>
        <div class="ms-auto">
          {% set st = (task.derived_status or task.status)|lower %}
          {% if st == 'running' %}
            <span class="badge bg-warning-lt text-uppercase"><i class="fas fa-spinner fa-spin me-1"></i>{{ st }}</span>
          {% elif st in ['completed','success'] %}
            <span class="badge bg-success-lt text-uppercase"><i class="fas fa-check me-1"></i>{{ st }}</span>
          {% elif st == 'failed' %}
            <span class="badge bg-danger-lt text-uppercase"><i class="fas fa-times me-1"></i>{{ st }}</span>
          {% elif st == 'pending' %}
            <span class="badge bg-secondary-lt text-uppercase"><i class="fas fa-clock me-1"></i>{{ st }}</span>
          {% elif st == 'cancelled' %}
            <span class="badge bg-muted-lt text-uppercase"><i class="fas fa-ban me-1"></i>{{ st }}</span>
          {% else %}
            <span class="badge bg-secondary text-uppercase">{{ task.status }}</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-sm-6 col-lg-4">
            <div class="text-muted text-uppercase tiny">Analysis Type</div>
            <div class="h5 mb-0">{{ task.analysis_type|title }}</div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="text-muted text-uppercase tiny">Target Model</div>
            <div class="h5 mb-0">{{ task.target_model }}</div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="text-muted text-uppercase tiny">Application</div>
            <div class="h5 mb-0">#{{ task.target_app_number }}</div>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-sm-6 col-lg-3">
            <div class="text-muted text-uppercase tiny">Progress</div>
            <div class="d-flex align-items-center gap-2">
              <div class="progress flex-grow-1">
                <div class="progress-bar"></div>
              </div>
              <span class="fw-semibold">{{ '%.0f'|format(task.progress_percentage or 0) }}%</span>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="text-muted text-uppercase tiny">Issues Found</div>
            <div class="h5 mb-0 text-{{ 'danger' if (task.issues_found or 0) > 10 else 'warning' if (task.issues_found or 0) > 0 else 'success' }}">
              {{ task.issues_found or 0 }}
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="text-muted text-uppercase tiny">Priority</div>
            <span class="badge bg-info text-dark">{{ task.priority }}</span>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="text-muted text-uppercase tiny">Duration</div>
            <div class="h6 mb-0">{{ '%.1f'|format(task.elapsed_seconds) if task.elapsed_seconds is defined else '-' }}s</div>
          </div>
        </div>

        {% if task.error_message %}
        <div class="alert alert-danger py-2 px-3 mb-0">
          <strong><i class="fas fa-exclamation-triangle me-1"></i>Error:</strong> 
          {{ task.error_message }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Timeline -->
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="fas fa-clock text-info"></i>
        <strong>Timeline</strong>
      </div>
      <div class="card-body">
        <div class="timeline timeline-simple">
          {% if task.created_at %}
          <div class="timeline-item">
            <div class="timeline-item-marker bg-primary"></div>
            <div class="timeline-item-content">
              <div class="timeline-item-title">Created</div>
              <div class="timeline-item-time">{{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') if task.created_at else '-' }}</div>
            </div>
          </div>
          {% endif %}
          
          {% if task.started_at %}
          <div class="timeline-item">
            <div class="timeline-item-marker bg-info"></div>
            <div class="timeline-item-content">
              <div class="timeline-item-title">Started</div>
              <div class="timeline-item-time">{{ task.started_at.strftime('%Y-%m-%d %H:%M:%S') if task.started_at else '-' }}</div>
            </div>
          </div>
          {% endif %}
          
          {% if task.completed_at %}
          <div class="timeline-item">
            <div class="timeline-item-marker bg-success"></div>
            <div class="timeline-item-content">
              <div class="timeline-item-title">Completed</div>
              <div class="timeline-item-time">{{ task.completed_at.strftime('%Y-%m-%d %H:%M:%S') if task.completed_at else '-' }}</div>
            </div>
          </div>
          {% elif st == 'running' %}
          <div class="timeline-item">
            <div class="timeline-item-marker bg-warning pulse"></div>
            <div class="timeline-item-content">
              <div class="timeline-item-title">Running...</div>
              <div class="timeline-item-time">In progress</div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Analysis Summary Cards -->
<div class="row g-3" id="analysis-summary">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted text-uppercase tiny">Security Issues</div>
        <div class="h2 mb-0 text-danger" id="security-count">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div class="text-muted small">Critical & High severity</div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted text-uppercase tiny">Quality Issues</div>
        <div class="h2 mb-0 text-warning" id="quality-count">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div class="text-muted small">Code quality & types</div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted text-uppercase tiny">Performance</div>
        <div class="h2 mb-0 text-info" id="performance-score">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div class="text-muted small">Avg response time (ms)</div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted text-uppercase tiny">Requirements</div>
        <div class="h2 mb-0 text-success" id="requirements-score">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div class="text-muted small">Compliance %</div>
      </div>
    </div>
  </div>
</div>

<script>
// Load summary statistics
document.addEventListener('DOMContentLoaded', function() {
  fetch('/analysis/api/tasks/{{ task.task_id }}/results.json')
    .then(response => response.json())
    .then(data => {
      updateOverviewMetrics(data);
    })
    .catch(error => {
      console.error('Error loading task results:', error);
      document.querySelectorAll('#analysis-summary .spinner-border').forEach(el => {
        el.innerHTML = '-';
        el.className = '';
      });
    });
});

function updateOverviewMetrics(data) {
  // Security issues count (high + medium severity)
  let securityCount = 0;
  if (data.results && data.results.findings) {
    securityCount = data.results.findings.filter(f => 
      f.category === 'security' && ['high', 'medium', 'critical'].includes(f.severity?.toLowerCase())
    ).length;
  }
  document.getElementById('security-count').innerHTML = securityCount;
  
  // Quality issues count
  let qualityCount = 0;
  if (data.results && data.results.findings) {
    qualityCount = data.results.findings.filter(f => 
      ['quality', 'code_quality', 'type_error'].includes(f.category)
    ).length;
  }
  document.getElementById('quality-count').innerHTML = qualityCount;
  
  // Performance metrics (avg response time from ab tool)
  let avgResponseTime = '-';
  if (data.results && data.results.services && data.results.services['performance-tester']) {
    const perfData = data.results.services['performance-tester'];
    // Extract average response time from AB tool results
    if (perfData.raw_outputs && perfData.raw_outputs.performance) {
      const results = perfData.raw_outputs.performance.analysis.results;
      for (const url in results) {
        if (results[url].ab && results[url].ab.avg_response_time) {
          avgResponseTime = Math.round(results[url].ab.avg_response_time * 1000); // Convert to ms
          break;
        }
      }
    }
  }
  document.getElementById('performance-score').innerHTML = avgResponseTime;
  
  // Requirements compliance
  let complianceScore = 0;
  if (data.results && data.results.services && data.results.services['ai-analyzer']) {
    const aiData = data.results.services['ai-analyzer'];
    if (aiData.raw_outputs && aiData.raw_outputs.analysis && aiData.raw_outputs.analysis.results) {
      const summary = aiData.raw_outputs.analysis.results.summary;
      if (summary && summary.compliance_percentage !== undefined) {
        complianceScore = Math.round(summary.compliance_percentage);
      }
    }
  }
  document.getElementById('requirements-score').innerHTML = complianceScore + '%';
}
</script>

