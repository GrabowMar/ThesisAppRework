{# Static Analysis Tab #}
{% set static_service = payload.results.services.static if payload.results.services and payload.results.services.static else none %}

{% if static_service %}
  {# Service Header #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-1">
        <i class="fa-solid fa-code me-2"></i>Static Code Analysis
      </h4>
      <p class="text-muted small mb-0">{{ static_service.service|default('static-analyzer') }}</p>
    </div>
    <span class="badge badge-outline {% if static_service.status in ['completed', 'ok', 'success'] %}text-success{% elif static_service.status in ['failed', 'error'] %}text-danger{% else %}text-secondary{% endif %}">
      <i class="fa-solid fa-circle-dot me-1"></i>
      {{ static_service.status|default('unknown')|replace('_', ' ')|title }}
    </span>
  </div>

  {# Tools Grid #}
  {% set tools_results = static_service.analysis.results if static_service.analysis and static_service.analysis.results else {} %}
  {% if tools_results %}
    <div class="row row-cards">
      {% for lang, lang_tools in tools_results.items() %}
        {% for tool_name, tool_data in lang_tools.items() %}
          <div class="col-12 col-md-6 col-xl-4">
            <div class="card card-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h5 class="mb-0">{{ tool_name|capitalize }}</h5>
                    <small class="text-muted">{{ lang }}</small>
                  </div>
                  {% if tool_data.executed %}
                    <span class="badge badge-outline {% if tool_data.status in ['success', 'ok', 'completed'] %}text-success{% elif tool_data.status in ['failed', 'error'] %}text-danger{% else %}text-secondary{% endif %}">
                      {{ tool_data.status|default('unknown') }}
                    </span>
                  {% else %}
                    <span class="badge badge-outline text-muted">Not Executed</span>
                  {% endif %}
                </div>
                
                {% if tool_data.issues %}
                  {# Issue Summary #}
                  <div class="mb-2">
                    <span class="text-muted small me-2">
                      <i class="fa-solid fa-bug me-1"></i>{{ tool_data.issues|length }} issue{{ tool_data.issues|length == 1 and '' or 's' }}
                    </span>
                    {% if tool_data.issues %}
                      {# Count severities #}
                      {% set high_count = tool_data.issues|selectattr('issue_severity', 'equalto', 'HIGH')|list|length %}
                      {% set medium_count = tool_data.issues|selectattr('issue_severity', 'equalto', 'MEDIUM')|list|length %}
                      {% set low_count = tool_data.issues|selectattr('issue_severity', 'equalto', 'LOW')|list|length %}
                      {% if high_count > 0 %}
                        <span class="badge bg-danger-lt text-danger">H:{{ high_count }}</span>
                      {% endif %}
                      {% if medium_count > 0 %}
                        <span class="badge bg-warning-lt text-warning">M:{{ medium_count }}</span>
                      {% endif %}
                      {% if low_count > 0 %}
                        <span class="badge bg-info-lt text-info">L:{{ low_count }}</span>
                      {% endif %}
                    {% endif %}
                  </div>

                  {# Issues Table #}
                  <div class="accordion" id="accordion-{{ tool_name }}-{{ lang }}">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ tool_name }}-{{ lang }}">
                          View Issues
                        </button>
                      </h2>
                      <div id="collapse-{{ tool_name }}-{{ lang }}" class="accordion-collapse collapse" data-bs-parent="#accordion-{{ tool_name }}-{{ lang }}">
                        <div class="accordion-body p-0">
                          <div class="table-responsive">
                            <table class="table table-sm table-vcenter mb-0">
                              <thead>
                                <tr>
                                  <th class="w-1">Severity</th>
                                  <th>Issue</th>
                                  <th>Location</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for issue in tool_data.issues[:10] %}
                                  <tr>
                                    <td>
                                      {% set severity = issue.issue_severity|default(issue.severity)|default('UNKNOWN') %}
                                      <span class="badge {% if severity == 'HIGH' %}bg-danger-lt text-danger{% elif severity == 'MEDIUM' %}bg-warning-lt text-warning{% elif severity == 'LOW' %}bg-info-lt text-info{% else %}bg-secondary-lt{% endif %}">
                                        {{ severity[0] }}
                                      </span>
                                    </td>
                                    <td class="text-wrap small">
                                      {{ issue.issue_text|default(issue.message)|default('No description') }}
                                      {% if issue.test_id %}
                                        <code class="text-muted small">({{ issue.test_id }})</code>
                                      {% endif %}
                                    </td>
                                    <td class="text-nowrap small text-muted">
                                      {% if issue.filename %}
                                        <span class="font-monospace">{{ issue.filename|basename }}</span>
                                        {% if issue.line_number %}
                                          :{{ issue.line_number }}
                                        {% endif %}
                                      {% else %}
                                        â€”
                                      {% endif %}
                                    </td>
                                  </tr>
                                {% endfor %}
                                {% if tool_data.issues|length > 10 %}
                                  <tr>
                                    <td colspan="3" class="text-center text-muted small">
                                      ...and {{ tool_data.issues|length - 10 }} more
                                    </td>
                                  </tr>
                                {% endif %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <div class="text-muted small">
                    <i class="fa-solid fa-check-circle text-success me-1"></i>No issues found
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      <div class="empty-icon">
        <i class="fa-solid fa-question-circle" style="font-size: 2rem;"></i>
      </div>
      <p class="empty-title">No tool results</p>
      <p class="empty-subtitle text-muted">No static analysis tool results were found in this service.</p>
    </div>
  {% endif %}
{% else %}
  <div class="empty">
    <div class="empty-icon">
      <i class="fa-solid fa-minus-circle text-muted" style="font-size: 2rem;"></i>
    </div>
    <p class="empty-title">Static analysis not available</p>
    <p class="empty-subtitle text-muted">This analysis did not include static code analysis.</p>
  </div>
{% endif %}
