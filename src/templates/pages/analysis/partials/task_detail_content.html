{# Table-Based Analysis Results Viewer #}
<div class="container-xl">
  <div class="row">
    <div class="col-12">
      
      {# Results Summary Table #}
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">Analysis Summary</h3>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table">
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="summary-table-body">
              <tr>
                <td><strong>Total Findings</strong></td>
                <td><span class="badge bg-primary" id="total-findings">-</span></td>
                <td><span class="text-muted" id="findings-breakdown">Loading...</span></td>
              </tr>
              <tr>
                <td><strong>Security Issues</strong></td>
                <td><span class="badge bg-danger" id="security-count">-</span></td>
                <td><span class="text-muted" id="security-severity">-</span></td>
              </tr>
              <tr>
                <td><strong>Quality Issues</strong></td>
                <td><span class="badge bg-warning" id="quality-count">-</span></td>
                <td><span class="text-muted" id="quality-breakdown">-</span></td>
              </tr>
              <tr>
                <td><strong>Performance</strong></td>
                <td><span class="badge bg-info" id="performance-count">-</span></td>
                <td><span class="text-muted" id="performance-metrics">-</span></td>
              </tr>
              <tr>
                <td><strong>Tools Executed</strong></td>
                <td><span class="badge bg-success" id="tools-executed">-</span></td>
                <td><span class="text-muted" id="tools-status">-</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      {# All Findings Table #}
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">All Findings</h3>
          <div class="card-actions">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" onclick="filterFindings('all')">All</button>
              <button class="btn btn-outline-danger" onclick="filterFindings('security')">Security</button>
              <button class="btn btn-outline-warning" onclick="filterFindings('quality')">Quality</button>
              <button class="btn btn-outline-info" onclick="filterFindings('performance')">Performance</button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter table-hover card-table" id="findings-table">
            <thead>
              <tr>
                <th style="width: 5%">#</th>
                <th style="width: 10%">Severity</th>
                <th style="width: 15%">Category</th>
                <th style="width: 15%">Tool</th>
                <th style="width: 35%">Message</th>
                <th style="width: 15%">Location</th>
                <th style="width: 5%">Actions</th>
              </tr>
            </thead>
            <tbody id="findings-table-body">
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                  <div class="spinner-border spinner-border-sm me-2"></div>
                  Loading findings...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer d-flex align-items-center">
          <p class="m-0 text-muted">Showing <span id="showing-count">0</span> of <span id="total-count">0</span> findings</p>
          <ul class="pagination m-0 ms-auto" id="findings-pagination">
            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

{# Finding Detail Modal #}
<div class="modal modal-blur fade" id="finding-detail-modal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Finding Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-vcenter">
            <tbody id="finding-detail-body">
              <tr>
                <td colspan="2" class="text-center text-muted">Select a finding to view details</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const taskId = '{{ task.task_id }}';
  let allFindings = [];
  let filteredFindings = [];
  let currentFilter = 'all';
  let currentPage = 1;
  const perPage = 20;

  // Load analysis data
  fetch(`/analysis/api/tasks/${taskId}/results.json`)
    .then(res => res.json())
    .then(data => {
      console.log('Analysis data loaded:', data);
      
      // Extract summary - could be at root or in results
      const summary = data.summary || data.results?.summary || {};
      
      // Extract findings - they're in the unified format at root level
      const findings = data.findings || [];
      
      allFindings = findings;
      filteredFindings = findings;
      
      // Count findings by category
      const securityCount = findings.filter(f => (f.category || '').toLowerCase().includes('security')).length;
      const qualityCount = findings.filter(f => (f.category || '').toLowerCase().includes('quality')).length;
      const performanceCount = findings.filter(f => (f.category || '').toLowerCase().includes('performance')).length;
      
      // Update summary table
      document.getElementById('total-findings').textContent = summary.total_findings || findings.length || 0;
      document.getElementById('security-count').textContent = securityCount;
      document.getElementById('quality-count').textContent = qualityCount;
      document.getElementById('performance-count').textContent = performanceCount;
      document.getElementById('tools-executed').textContent = (summary.tools_used || []).length || 0;
      
      // Update breakdown details
      const sev = summary.severity_breakdown || {};
      document.getElementById('findings-breakdown').textContent = 
        `Critical: ${sev.critical || 0}, High: ${sev.high || 0}, Medium: ${sev.medium || 0}, Low: ${sev.low || 0}`;
      
      document.getElementById('security-severity').textContent = 
        `Critical: ${sev.critical || 0}, High: ${sev.high || 0}`;
      
      const toolsFailed = (summary.tools_failed || []).length;
      const toolsUsed = (summary.tools_used || []).length;
      document.getElementById('tools-status').textContent = 
        `${toolsUsed - toolsFailed} successful, ${toolsFailed} failed`;
      
      // Render findings table
      renderFindings();
    })
    .catch(err => {
      console.error('Failed to load analysis data:', err);
      document.getElementById('findings-table-body').innerHTML = 
        '<tr><td colspan="7" class="text-center py-4 text-danger">Failed to load findings</td></tr>';
    });

  function renderFindings() {
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    const pageFindings = filteredFindings.slice(start, end);
    
    if (pageFindings.length === 0) {
      document.getElementById('findings-table-body').innerHTML = 
        '<tr><td colspan="7" class="text-center py-4 text-muted">No findings to display</td></tr>';
      return;
    }
    
    const tbody = document.getElementById('findings-table-body');
    tbody.innerHTML = pageFindings.map((f, idx) => {
      const severityClass = {
        critical: 'danger',
        high: 'warning',
        medium: 'info',
        low: 'secondary'
      }[f.severity?.toLowerCase()] || 'secondary';
      
      const location = f.file ? 
        `${f.file.path}:${f.file.line_start || '?'}` : 
        'N/A';
      
      const message = (f.message?.title || f.message?.description || f.message || 'No message').substring(0, 80);
      
      return `
        <tr style="cursor: pointer;" onclick="showFindingDetail(${start + idx})">
          <td>${start + idx + 1}</td>
          <td><span class="badge bg-${severityClass}">${f.severity || 'N/A'}</span></td>
          <td>${f.category || 'N/A'}</td>
          <td><code class="small">${f.tool || 'N/A'}</code></td>
          <td>${message}${message.length >= 80 ? '...' : ''}</td>
          <td class="text-muted small">${location}</td>
          <td>
            <button class="btn btn-sm btn-icon btn-ghost-secondary" onclick="event.stopPropagation(); showFindingDetail(${start + idx})">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    // Update counts
    document.getElementById('showing-count').textContent = pageFindings.length;
    document.getElementById('total-count').textContent = filteredFindings.length;
    
    // Update pagination
    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredFindings.length / perPage);
    const pagination = document.getElementById('findings-pagination');
    
    let html = `
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
      </li>
    `;
    
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
      html += `
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
        </li>
      `;
    }
    
    html += `
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
      </li>
    `;
    
    pagination.innerHTML = html;
  }

  window.filterFindings = function(category) {
    currentFilter = category;
    currentPage = 1;
    
    if (category === 'all') {
      filteredFindings = allFindings;
    } else {
      filteredFindings = allFindings.filter(f => 
        (f.category || '').toLowerCase().includes(category.toLowerCase())
      );
    }
    
    renderFindings();
  };

  window.changePage = function(page) {
    const totalPages = Math.ceil(filteredFindings.length / perPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderFindings();
  };

  window.showFindingDetail = function(index) {
    const finding = filteredFindings[index];
    if (!finding) return;
    
    const tbody = document.getElementById('finding-detail-body');
    tbody.innerHTML = `
      <tr><td class="w-25"><strong>Tool</strong></td><td>${finding.tool || 'N/A'}</td></tr>
      <tr><td><strong>Category</strong></td><td>${finding.category || 'N/A'}</td></tr>
      <tr><td><strong>Severity</strong></td><td><span class="badge bg-${
        {critical: 'danger', high: 'warning', medium: 'info', low: 'secondary'}[finding.severity?.toLowerCase()] || 'secondary'
      }">${finding.severity || 'N/A'}</span></td></tr>
      <tr><td><strong>Type</strong></td><td>${finding.type || 'N/A'}</td></tr>
      <tr><td><strong>Message</strong></td><td>${finding.message?.title || finding.message?.description || finding.message || 'N/A'}</td></tr>
      <tr><td><strong>File</strong></td><td><code>${finding.file?.path || 'N/A'}</code></td></tr>
      <tr><td><strong>Line</strong></td><td>${finding.file?.line_start || 'N/A'} - ${finding.file?.line_end || 'N/A'}</td></tr>
      <tr><td><strong>Rule ID</strong></td><td><code>${finding.rule_id || finding.symbol || 'N/A'}</code></td></tr>
      ${finding.metadata?.cwe_id ? `<tr><td><strong>CWE</strong></td><td>${finding.metadata.cwe_id}</td></tr>` : ''}
      ${finding.metadata?.cvss_score ? `<tr><td><strong>CVSS Score</strong></td><td>${finding.metadata.cvss_score}</td></tr>` : ''}
    `;
    
    new bootstrap.Modal(document.getElementById('finding-detail-modal')).show();
  };
})();
</script>
