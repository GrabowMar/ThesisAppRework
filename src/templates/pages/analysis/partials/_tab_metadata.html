{# Metadata Tab - Enhanced Report Layout #}

{# Service Header #}
<div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
  <div>
    <h4 class="mb-1 d-flex align-items-center gap-2">
      <i class="fa-solid fa-info-circle text-secondary"></i>
      <span>Analysis Metadata</span>
    </h4>
    <p class="text-muted small mb-0">Configuration, execution details, and raw data</p>
  </div>
  <span class="badge bg-secondary-lt">
    <i class="fa-solid fa-file-code me-1"></i>
    {{ descriptor.identifier[:12] }}...
  </span>
</div>

<div class="row g-3">
  {# Analysis Information Card #}
  <div class="col-12 col-lg-6">
    <div class="card card-table-compact">
      <div class="card-header d-flex align-items-center gap-2 bg-primary-lt">
        <h5 class="card-title d-flex align-items-center gap-2 mb-0">
          <i class="fa-solid fa-clipboard-list text-primary"></i>
          <span>Analysis Information</span>
        </h5>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-vcenter mb-0">
          <tbody>
            <tr>
              <td class="text-muted" style="width: 35%;">Model</td>
              <td><span class="badge bg-azure-lt text-azure">{{ descriptor.model_slug }}</span></td>
            </tr>
            <tr>
              <td class="text-muted">Application</td>
              <td><span class="badge bg-secondary-lt">#{{ descriptor.app_number }}</span></td>
            </tr>
            <tr>
              <td class="text-muted">Analysis Type</td>
              <td><code>{{ descriptor.task_name|default('unknown') }}</code></td>
            </tr>
            <tr>
              <td class="text-muted">Status</td>
              <td>
                <span class="badge {% if descriptor.status in ['completed', 'ok', 'success'] %}bg-success-lt text-success{% elif descriptor.status in ['failed', 'error'] %}bg-danger-lt text-danger{% elif descriptor.status == 'partial_success' %}bg-warning-lt text-warning{% else %}bg-secondary-lt{% endif %}">
                  <i class="fa-solid fa-circle-dot me-1"></i>
                  {{ descriptor.status|default('unknown')|replace('_', ' ')|title }}
                </span>
              </td>
            </tr>
            <tr>
              <td class="text-muted">Timestamp</td>
              <td class="small">{{ descriptor.display_timestamp() if descriptor.display_timestamp else descriptor.timestamp|default('â€”') }}</td>
            </tr>
            <tr>
              <td class="text-muted">Task ID</td>
              <td><code class="small">{{ descriptor.identifier }}</code></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Execution Summary Card #}
  <div class="col-12 col-lg-6">
    <div class="card card-table-compact">
      <div class="card-header d-flex align-items-center gap-2 bg-info-lt">
        <h5 class="card-title d-flex align-items-center gap-2 mb-0">
          <i class="fa-solid fa-chart-bar text-info"></i>
          <span>Execution Summary</span>
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-6">
            <div class="text-muted small text-uppercase mb-1">Total Findings</div>
            <div class="h3 mb-0 {% if descriptor.total_findings > 20 %}text-danger{% elif descriptor.total_findings > 10 %}text-warning{% elif descriptor.total_findings > 0 %}text-info{% else %}text-success{% endif %}">
              {{ descriptor.total_findings|default(summary.total_findings)|default(0) }}
            </div>
          </div>
          <div class="col-6">
            <div class="text-muted small text-uppercase mb-1">Services Run</div>
            <div class="h3 mb-0 text-primary">
              {{ services|length if services else summary.services_executed|default(0) }}
            </div>
          </div>
        </div>
        
        {% if descriptor.severity_breakdown %}
        <div class="mb-3">
          <div class="text-muted small text-uppercase mb-2">Severity Distribution</div>
          <div class="d-flex flex-wrap gap-1">
            {% for severity, count in descriptor.severity_breakdown.items() %}
              {% if count > 0 %}
              <span class="badge {% if severity|lower == 'critical' %}bg-danger{% elif severity|lower == 'high' %}bg-danger-lt text-danger{% elif severity|lower == 'medium' %}bg-warning-lt text-warning{% elif severity|lower == 'low' %}bg-info-lt text-info{% else %}bg-secondary-lt{% endif %}">
                {{ severity|capitalize }}: {{ count }}
              </span>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if descriptor.tools_used %}
        <div>
          <div class="text-muted small text-uppercase mb-2">Tools Used ({{ descriptor.tools_used|length }})</div>
          <div class="d-flex flex-wrap gap-1">
            {% for tool in descriptor.tools_used[:12] %}
              <span class="badge bg-secondary-lt">{{ tool }}</span>
            {% endfor %}
            {% if descriptor.tools_used|length > 12 %}
              <span class="badge bg-secondary-lt text-muted">+{{ descriptor.tools_used|length - 12 }} more</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Analysis Metadata Card (from payload.metadata) #}
  {% if metadata %}
  <div class="col-12 col-lg-6">
    <div class="card card-table-compact">
      <div class="card-header d-flex align-items-center gap-2 bg-secondary-lt">
        <h5 class="card-title d-flex align-items-center gap-2 mb-0">
          <i class="fa-solid fa-tags text-secondary"></i>
          <span>Orchestrator Details</span>
        </h5>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-vcenter mb-0">
          <tbody>
            {% if metadata.orchestrator_version %}
            <tr>
              <td class="text-muted" style="width: 40%;">Orchestrator Version</td>
              <td><code class="small">{{ metadata.orchestrator_version }}</code></td>
            </tr>
            {% endif %}
            {% if metadata.executor %}
            <tr>
              <td class="text-muted">Executor</td>
              <td>{{ metadata.executor }}</td>
            </tr>
            {% endif %}
            {% if metadata.analyzer_version %}
            <tr>
              <td class="text-muted">Analyzer Version</td>
              <td><code class="small">{{ metadata.analyzer_version }}</code></td>
            </tr>
            {% endif %}
            {% if metadata.generated_at %}
            <tr>
              <td class="text-muted">Generated At</td>
              <td class="small">{{ metadata.generated_at }}</td>
            </tr>
            {% endif %}
            {% if metadata.unified_analysis is defined %}
            <tr>
              <td class="text-muted">Unified Analysis</td>
              <td>
                {% if metadata.unified_analysis %}
                  <span class="badge bg-success-lt text-success">Yes</span>
                {% else %}
                  <span class="badge bg-secondary-lt">No</span>
                {% endif %}
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {# Services Status Card #}
  {% if services and services|length > 0 %}
  <div class="col-12 col-lg-6">
    <div class="card card-table-compact">
      <div class="card-header d-flex align-items-center gap-2 bg-success-lt">
        <h5 class="card-title d-flex align-items-center gap-2 mb-0">
          <i class="fa-solid fa-server text-success"></i>
          <span>Services Status</span>
        </h5>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm table-vcenter mb-0">
          <thead>
            <tr>
              <th>Service</th>
              <th class="text-center">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for service_name, service_data in services.items() %}
            <tr>
              <td>
                <div class="fw-bold">{{ service_name|replace('-', ' ')|title }}</div>
                {% if service_data.service %}
                <div class="text-muted small">{{ service_data.service }}</div>
                {% endif %}
              </td>
              <td class="text-center">
                {% set svc_status = service_data.status|default('unknown') %}
                <span class="badge {% if svc_status in ['success', 'ok', 'completed'] %}bg-success-lt text-success{% elif svc_status in ['failed', 'error'] %}bg-danger-lt text-danger{% elif svc_status == 'timeout' %}bg-warning-lt text-warning{% else %}bg-secondary-lt{% endif %}">
                  {{ svc_status|replace('_', ' ')|title }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {# Raw JSON Payload #}
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-dark text-white d-flex align-items-center justify-content-between">
        <h6 class="card-title mb-0 d-flex align-items-center gap-2">
          <i class="fa-solid fa-code"></i>
          <span>Raw JSON Payload</span>
        </h6>
        <span class="badge bg-secondary-lt text-muted small">
          {{ (payload | tojson | length / 1024) | round(1) }} KB
        </span>
      </div>
      <div class="card-body p-0">
        <details class="p-3">
          <summary class="text-muted cursor-pointer">
            <i class="fa-solid fa-chevron-right me-1"></i>Click to expand full JSON
          </summary>
          <pre class="bg-dark text-white rounded p-3 mt-3 small overflow-auto" style="max-height: 600px;"><code>{{ payload | tojson(indent=2) }}</code></pre>
        </details>
      </div>
    </div>
  </div>
</div>
