{# Structured task results summary (first 50 findings) #}
{% set summary = payload.summary or {} %}
{% set severities = payload.findings_by_severity or {} %}
{% set tools = payload.findings_by_tool or {} %}

<div class="card mb-4">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2 py-2">
    <div class="d-flex align-items-center gap-2">
      <strong class="small text-uppercase">Results Summary</strong>
      <span class="badge bg-blue-lt">{{ payload.findings_total or findings|length }} issues</span>
    </div>
    <div class="d-flex gap-2 small">
  {% for tool, count in tools.items() %}<span class="badge bg-secondary" title="{{ tool }} findings">{{ tool }}: {{ count }}</span>{% endfor %}
      {% if not tools %}
        <span class="text-muted">No tool findings</span>
      {% endif %}
      <a href="/analysis/api/tasks/{{ task_id }}/results.json" target="_blank" class="btn btn-outline-info btn-xs"><i class="fa fa-code me-1"></i> JSON</a>
    </div>
  </div>
  <div class="card-body p-3 small">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="border rounded p-2 h-100">
          <div class="fw-semibold mb-1 small text-uppercase">Severity Breakdown</div>
          {% if severities %}
            <ul class="list-unstyled mb-0 d-flex flex-wrap gap-2"><!--
              -->{% for sev, count in severities.items() %}<li><span class="badge bg-{{ 'danger' if sev in ['high','error'] else 'warning' if sev in ['medium','warning'] else 'info' }}">{{ sev }}: {{ count }}</span></li>{% endfor %}<!--
            --></ul>
          {% else %}<div class="text-muted">No severities</div>{% endif %}
        </div>
      </div>
      <div class="col-md-8">
        <div class="border rounded p-2 h-100">
          <div class="fw-semibold mb-1 small text-uppercase">Analyzer Metadata</div>
          <dl class="row mb-0 small">
            <dt class="col-sm-4">Type</dt><dd class="col-sm-8">{{ payload.analysis_type }}</dd>
            <dt class="col-sm-4">Model</dt><dd class="col-sm-8">{{ payload.model_slug or '-' }}</dd>
            <dt class="col-sm-4">App #</dt><dd class="col-sm-8">{{ payload.app_number or '-' }}</dd>
            <dt class="col-sm-4">Analysis Time</dt><dd class="col-sm-8">{{ payload.analysis_time or '-' }}</dd>
            <dt class="col-sm-4">Tools Used</dt><dd class="col-sm-8">{{ (payload.tools_used or [])|join(', ') }}</dd>
            <dt class="col-sm-4">Config Applied</dt><dd class="col-sm-8">{{ 'Yes' if payload.configuration_applied else 'No' }}</dd>
          </dl>
        </div>
      </div>
    </div>

    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold small text-uppercase">Findings ({{ findings|length }})</div>
        <div class="small text-muted">Showing first 50</div>
      </div>
      {% if findings %}
      <div class="table-responsive findings-table-wrapper">
  <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="col-tool">Tool</th>
              <th class="col-sev">Severity</th>
              <th>Title / Message</th>
              <th class="col-line">Line</th>
              <th class="col-file">File</th>
            </tr>
          </thead>
          <tbody>
            {% for f in findings %}
            <tr>
              <td><span class="badge bg-dark text-uppercase">{{ f.tool }}</span></td>
              <td>
                {% set sev = f.severity|lower %}
                <span class="badge bg-{{ 'danger' if sev in ['error','high','critical'] else 'warning' if sev in ['medium','warning'] else 'info' if sev in ['low','info'] else 'secondary' }}">{{ f.severity }}</span>
              </td>
              <td class="small">
                <div class="fw-semibold">{{ f.title or f.message|truncate(120) }}</div>
                <div class="text-muted">{{ f.message|truncate(180) }}</div>
                <div class="text-muted mt-1 d-flex flex-wrap gap-2 tiny">
                  {% if f.category %}<span title="Category" class="badge bg-secondary">{{ f.category }}</span>{% endif %}
                  {% if f.rule_id %}<span class="badge bg-blue-lt">{{ f.rule_id }}</span>{% endif %}
                  {% if f.cwe %}<span class="badge bg-purple-lt" title="CWE">CWE-{{ f.cwe }}</span>{% endif %}
                  {% if f.confidence %}<span class="badge bg-teal-lt" title="Confidence">{{ f.confidence }}</span>{% endif %}
                </div>
              </td>
              <td class="text-nowrap">{{ f.line_number or '-' }}</td>
              <td class="text-truncate col-file-cell" title="{{ f.file_path }}">{{ f.file_path.split('/')[-1] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-muted">No findings captured.</div>
      {% endif %}
    </div>

    {# Future analyzer stubs (expand later) #}
    <div class="mt-4 small text-muted">
      <em>Planned analyzer panels:</em> performance metrics, licensing compliance, quality scores.
    </div>
  </div>
</div>