{# Code Quality Tab - Static analysis code quality findings #}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">
    <i class="fas fa-code text-primary me-2"></i>Code Quality Analysis
  </h5>
  <div class="d-flex gap-2">
    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-filter me-1"></i>Filter by Tool
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" onclick="filterByTool('all')">All Tools</a></li>
        <li><a class="dropdown-item" href="#" onclick="filterByTool('pylint')">PyLint</a></li>
        <li><a class="dropdown-item" href="#" onclick="filterByTool('mypy')">MyPy</a></li>
        <li><a class="dropdown-item" href="#" onclick="filterByTool('vulture')">Vulture</a></li>
        <li><a class="dropdown-item" href="#" onclick="filterByTool('eslint')">ESLint</a></li>
      </ul>
    </div>
    <button class="btn btn-outline-info btn-sm" onclick="exportQualityReport()">
      <i class="fas fa-download me-1"></i>Export Report
    </button>
  </div>
</div>

<!-- Code Quality Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="h3 mb-0 text-danger" id="error-count">-</div>
        <div class="text-muted small">Errors</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="h3 mb-0 text-warning" id="warning-count">-</div>
        <div class="text-muted small">Warnings</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="h3 mb-0 text-info" id="info-count">-</div>
        <div class="text-muted small">Info</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="h3 mb-0 text-muted" id="type-errors">-</div>
        <div class="text-muted small">Type Errors</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="h3 mb-0 text-secondary" id="dead-code">-</div>
        <div class="text-muted small">Dead Code</div>
      </div>
    </div>
  </div>
</div>

<!-- Quality Tools Status -->
<div class="row g-3 mb-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="fas fa-tools text-primary"></i>
        <strong>Quality Tools Execution Status</strong>
      </div>
      <div class="card-body">
        <div class="row g-3" id="tools-status">
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="badge bg-secondary" id="pylint-badge">?</div>
              <span class="small">PyLint</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="badge bg-secondary" id="mypy-badge">?</div>
              <span class="small">MyPy</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="badge bg-secondary" id="vulture-badge">?</div>
              <span class="small">Vulture</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="badge bg-secondary" id="eslint-badge">?</div>
              <span class="small">ESLint</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="badge bg-secondary" id="jshint-badge">?</div>
              <span class="small">JSHint</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="badge bg-secondary" id="safety-badge">?</div>
              <span class="small">Safety</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Code Quality Issues -->
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <strong>Code Quality Issues</strong>
      <span class="badge bg-primary-lt" id="quality-count">Loading...</span>
    </div>
    <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-secondary" onclick="groupByFile()">Group by File</button>
      <button class="btn btn-outline-secondary" onclick="groupByTool()">Group by Tool</button>
      <button class="btn btn-outline-secondary" onclick="groupByType()">Group by Type</button>
    </div>
  </div>
  <div class="card-body p-0">
    <div id="quality-issues">
      <div class="d-flex justify-content-center p-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading quality issues...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Code Quality Insights -->
<div class="card mt-4">
  <div class="card-header d-flex align-items-center gap-2">
    <i class="fas fa-chart-bar text-success"></i>
    <strong>Code Quality Insights</strong>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="alert alert-info py-2">
          <h6 class="alert-heading mb-1">
            <i class="fas fa-import me-1"></i>Import Issues
          </h6>
          <div id="import-issues-summary">Loading...</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="alert alert-warning py-2">
          <h6 class="alert-heading mb-1">
            <i class="fas fa-bug me-1"></i>Type Safety
          </h6>
          <div id="type-safety-summary">Loading...</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="alert alert-success py-2">
          <h6 class="alert-heading mb-1">
            <i class="fas fa-broom me-1"></i>Code Cleanliness
          </h6>
          <div id="cleanliness-summary">Loading...</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="alert alert-secondary py-2">
          <h6 class="alert-heading mb-1">
            <i class="fas fa-cogs me-1"></i>Recommendations
          </h6>
          <div id="quality-recommendations">
            <small>Install missing dependencies, add type annotations, remove unused code.</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let allQualityFindings = [];
let currentQualityFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
  loadQualityFindings();
});

async function loadQualityFindings() {
  try {
    const response = await fetch('/analysis/api/tasks/{{ task.task_id }}/results.json');
    const data = await response.json();
    
    if (data.results && data.results.findings) {
      // Filter quality-related findings
      allQualityFindings = data.results.findings.filter(f => 
        ['quality', 'code_quality', 'type_error', 'code_smell'].includes(f.category) ||
        f.type === 'type_error' || 
        f.type === 'code_quality' ||
        ['pylint', 'mypy', 'vulture', 'eslint', 'jshint'].includes(f.tool)
      );
      
      updateQualitySummary(allQualityFindings);
      updateToolsStatus(data);
      renderQualityIssues(allQualityFindings);
      updateQualityInsights(allQualityFindings);
    } else {
      showNoQualityData();
    }
  } catch (error) {
    console.error('Error loading quality findings:', error);
    showQualityError();
  }
}

function updateQualitySummary(findings) {
  const counts = {
    errors: 0,
    warnings: 0,
    info: 0,
    typeErrors: 0,
    deadCode: 0
  };
  
  findings.forEach(f => {
    const severity = f.severity?.toLowerCase();
    
    if (severity === 'error' || severity === 'high') {
      counts.errors++;
    } else if (severity === 'warning' || severity === 'medium') {
      counts.warnings++;
    } else if (severity === 'info' || severity === 'low') {
      counts.info++;
    }
    
    if (f.type === 'type_error' || f.tool === 'mypy') {
      counts.typeErrors++;
    }
    
    if (f.tool === 'vulture' || f.message?.title?.includes('unused')) {
      counts.deadCode++;
    }
  });
  
  document.getElementById('error-count').textContent = counts.errors;
  document.getElementById('warning-count').textContent = counts.warnings;
  document.getElementById('info-count').textContent = counts.info;
  document.getElementById('type-errors').textContent = counts.typeErrors;
  document.getElementById('dead-code').textContent = counts.deadCode;
  document.getElementById('quality-count').textContent = findings.length;
}

function updateToolsStatus(data) {
  const tools = ['pylint', 'mypy', 'vulture', 'eslint', 'jshint', 'safety'];
  
  // Initialize all as not run
  tools.forEach(tool => {
    const badge = document.getElementById(tool + '-badge');
    if (badge) {
      badge.textContent = '✗';
      badge.className = 'badge bg-secondary';
    }
  });
  
  // Check static analyzer results
  if (data.results && data.results.services && data.results.services['static-analyzer']) {
    const staticData = data.results.services['static-analyzer'];
    
    if (staticData.raw_outputs && staticData.raw_outputs.static) {
      const toolResults = staticData.raw_outputs.static.tools;
      
      tools.forEach(tool => {
        const badge = document.getElementById(tool + '-badge');
        if (badge && toolResults[tool]) {
          const toolData = toolResults[tool];
          if (toolData.executed) {
            if (toolData.status === 'success' || toolData.status === 'no_issues') {
              badge.textContent = '✓';
              badge.className = 'badge bg-success';
            } else if (toolData.status === 'error') {
              badge.textContent = '!';
              badge.className = 'badge bg-danger';
            } else {
              badge.textContent = '?';
              badge.className = 'badge bg-warning';
            }
          }
        }
      });
    }
  }
}

function renderQualityIssues(findings) {
  if (findings.length === 0) {
    document.getElementById('quality-issues').innerHTML = 
      '<div class="text-center p-4 text-success"><i class="fas fa-check-circle me-2"></i>No code quality issues found!</div>';
    return;
  }
  
  let html = '<div class="table-responsive"><table class="table table-sm table-striped table-vcenter card-table mb-0">';
  html += '<thead class="table-light">';
  html += '<tr><th>Tool</th><th>Severity</th><th>Issue</th><th>File</th><th>Line</th><th>Type</th></tr>';
  html += '</thead><tbody>';
  
  findings.forEach((f, idx) => {
    const severityClass = getQualitySeverityClass(f.severity);
    
    html += `<tr class="quality-row" data-tool="${f.tool}" data-severity="${f.severity?.toLowerCase()}">`;
    html += `<td><span class="badge bg-primary text-uppercase">${f.tool}</span></td>`;
    html += `<td><span class="badge ${severityClass}">${f.severity || 'Unknown'}</span></td>`;
    html += `<td>`;
    html += `  <div class="fw-semibold">${f.message?.title || f.message?.description || 'Code Quality Issue'}</div>`;
    if (f.message?.description && f.message?.description !== f.message?.title) {
      html += `  <div class="text-muted small">${f.message.description}</div>`;
    }
    if (f.rule_id || f.metadata?.symbol) {
      const ruleId = f.rule_id || f.metadata?.symbol;
      html += `  <div class="mt-1"><span class="badge bg-blue-lt">${ruleId}</span></div>`;
    }
    html += `</td>`;
    html += `<td class="text-truncate" title="${f.file?.path || 'Unknown'}">${getFileName(f.file?.path)}</td>`;
    html += `<td>${f.file?.line_start || f.line_number || '-'}</td>`;
    html += `<td><span class="badge bg-secondary-lt">${getQualityType(f)}</span></td>`;
    html += `</tr>`;
  });
  
  html += '</tbody></table></div>';
  document.getElementById('quality-issues').innerHTML = html;
}

function getQualitySeverityClass(severity) {
  const sev = severity?.toLowerCase();
  if (sev === 'error' || sev === 'high') return 'bg-danger';
  if (sev === 'warning' || sev === 'medium') return 'bg-warning';
  if (sev === 'info' || sev === 'low') return 'bg-info';
  return 'bg-secondary';
}

function getQualityType(finding) {
  if (finding.type === 'type_error' || finding.tool === 'mypy') return 'Type';
  if (finding.tool === 'pylint') return 'Lint';
  if (finding.tool === 'vulture') return 'Dead Code';
  if (finding.tool === 'eslint') return 'JS Lint';
  if (finding.tool === 'jshint') return 'JS Hint';
  if (finding.tool === 'safety') return 'Security';
  return 'Other';
}

function getFileName(filePath) {
  if (!filePath) return 'Unknown';
  return filePath.split('/').pop() || filePath;
}

function updateQualityInsights(findings) {
  // Import issues
  const importIssues = findings.filter(f => 
    f.message?.description?.includes('import') || 
    f.message?.title?.includes('import') ||
    f.rule_id === 'E0401'
  );
  
  document.getElementById('import-issues-summary').innerHTML = 
    importIssues.length > 0 ? 
    `<small>${importIssues.length} import issue(s) found. Consider installing missing dependencies.</small>` :
    '<small>No import issues detected.</small>';
  
  // Type safety
  const typeIssues = findings.filter(f => 
    f.type === 'type_error' || f.tool === 'mypy'
  );
  
  document.getElementById('type-safety-summary').innerHTML = 
    typeIssues.length > 0 ? 
    `<small>${typeIssues.length} type issue(s) found. Add type annotations for better type safety.</small>` :
    '<small>Good type safety coverage.</small>';
  
  // Code cleanliness
  const cleanlinessIssues = findings.filter(f => 
    f.tool === 'vulture' || f.message?.title?.includes('unused')
  );
  
  document.getElementById('cleanliness-summary').innerHTML = 
    cleanlinessIssues.length > 0 ? 
    `<small>${cleanlinessIssues.length} cleanliness issue(s) found. Remove unused code.</small>` :
    '<small>Code appears clean with minimal unused elements.</small>';
}

function filterByTool(tool) {
  currentQualityFilter = tool;
  let filteredFindings = allQualityFindings;
  
  if (tool !== 'all') {
    filteredFindings = allQualityFindings.filter(f => f.tool === tool);
  }
  
  renderQualityIssues(filteredFindings);
}

function groupByFile() {
  console.log('Group by file functionality - to be implemented');
}

function groupByTool() {
  console.log('Group by tool functionality - to be implemented');
}

function groupByType() {
  console.log('Group by type functionality - to be implemented');
}

function exportQualityReport() {
  const report = {
    summary: {
      total_issues: allQualityFindings.length,
      by_tool: {},
      by_severity: {}
    },
    findings: allQualityFindings
  };
  
  // Count by tool and severity
  allQualityFindings.forEach(f => {
    report.summary.by_tool[f.tool] = (report.summary.by_tool[f.tool] || 0) + 1;
    const sev = f.severity?.toLowerCase() || 'unknown';
    report.summary.by_severity[sev] = (report.summary.by_severity[sev] || 0) + 1;
  });
  
  const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `quality-report-{{ task.task_id }}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function showNoQualityData() {
  document.getElementById('quality-issues').innerHTML = 
    '<div class="text-center p-4 text-muted">No code quality data available</div>';
  
  ['error-count', 'warning-count', 'info-count', 'type-errors', 'dead-code'].forEach(id => {
    document.getElementById(id).textContent = '0';
  });
}

function showQualityError() {
  document.getElementById('quality-issues').innerHTML = 
    '<div class="text-center p-4 text-danger">Error loading code quality data</div>';
  
  ['error-count', 'warning-count', 'info-count', 'type-errors', 'dead-code'].forEach(id => {
    document.getElementById(id).textContent = 'Error';
  });
}
</script>