{# Performance Analysis Tab #}
{% set performance_service = payload.results.services.performance if payload.results.services and payload.results.services.performance else none %}

{% if performance_service %}
  {# Service Header #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-1">
        <i class="fa-solid fa-gauge-high me-2"></i>Performance Testing
      </h4>
      <p class="text-muted small mb-0">{{ performance_service.service|default('performance-tester') }}</p>
    </div>
    <span class="badge {% if performance_service.status in ['completed', 'ok', 'success'] %}bg-success-lt text-success{% elif performance_service.status in ['failed', 'error'] %}bg-danger-lt text-danger{% else %}bg-secondary-lt text-secondary{% endif %}">
      <i class="fa-solid fa-circle-dot me-1"></i>
      {{ performance_service.status|default('unknown')|replace('_', ' ')|title }}
    </span>
  </div>

  {# Performance Metrics #}
  {% set test_results = performance_service.analysis.results if performance_service.analysis and performance_service.analysis.results else {} %}
  {% if test_results %}
    <div class="row row-cards">
      {% for test_name, test_data in test_results.items() %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card card-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="mb-0">{{ test_name|replace('_', ' ')|title }}</h5>
                {% if test_data.executed %}
                  <span class="badge {% if test_data.status in ['success', 'ok', 'completed'] %}bg-success-lt text-success{% elif test_data.status in ['failed', 'error'] %}bg-danger-lt text-danger{% else %}bg-secondary-lt text-secondary{% endif %}">
                    {{ test_data.status|default('unknown') }}
                  </span>
                {% else %}
                  <span class="badge bg-secondary-lt text-secondary">Not Executed</span>
                {% endif %}
              </div>

              {% if test_data.metrics %}
                <div class="row g-2 mb-2">
                  {% if test_data.metrics.response_time %}
                    <div class="col-6">
                      <div class="text-muted small text-uppercase">Response Time</div>
                      <div class="fw-medium">{{ test_data.metrics.response_time }}ms</div>
                    </div>
                  {% endif %}
                  {% if test_data.metrics.throughput %}
                    <div class="col-6">
                      <div class="text-muted small text-uppercase">Throughput</div>
                      <div class="fw-medium">{{ test_data.metrics.throughput }} req/s</div>
                    </div>
                  {% endif %}
                  {% if test_data.metrics.success_rate is defined %}
                    <div class="col-6">
                      <div class="text-muted small text-uppercase">Success Rate</div>
                      <div class="fw-medium">{{ test_data.metrics.success_rate }}%</div>
                    </div>
                  {% endif %}
                  {% if test_data.metrics.error_rate is defined %}
                    <div class="col-6">
                      <div class="text-muted small text-uppercase">Error Rate</div>
                      <div class="fw-medium">{{ test_data.metrics.error_rate }}%</div>
                    </div>
                  {% endif %}
                  {% if test_data.metrics.total_requests %}
                    <div class="col-6">
                      <div class="text-muted small text-uppercase">Total Requests</div>
                      <div class="fw-medium">{{ test_data.metrics.total_requests }}</div>
                    </div>
                  {% endif %}
                  {% if test_data.metrics.failed_requests %}
                    <div class="col-6">
                      <div class="text-muted small text-uppercase">Failed Requests</div>
                      <div class="fw-medium">{{ test_data.metrics.failed_requests }}</div>
                    </div>
                  {% endif %}
                </div>

                {# Additional Metrics Accordion #}
                {% if test_data.metrics|length > 6 %}
                  <div class="accordion" id="accordion-{{ test_name }}">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ test_name }}">
                          View All Metrics ({{ test_data.metrics|length }})
                        </button>
                      </h2>
                      <div id="collapse-{{ test_name }}" class="accordion-collapse collapse" data-bs-parent="#accordion-{{ test_name }}">
                        <div class="accordion-body">
                          <dl class="row mb-0 g-2 small">
                            {% for key, value in test_data.metrics.items() %}
                              <dt class="col-6 text-muted">{{ key|replace('_', ' ')|title }}</dt>
                              <dd class="col-6">{{ value }}</dd>
                            {% endfor %}
                          </dl>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endif %}
              {% else %}
                <div class="text-muted small">No metrics available</div>
              {% endif %}

              {# Issues/Bottlenecks #}
              {% if test_data.issues %}
                <div class="mt-2">
                  <div class="text-muted small mb-1">
                    <i class="fa-solid fa-exclamation-triangle text-warning me-1"></i>{{ test_data.issues|length }} issue{{ test_data.issues|length == 1 and '' or 's' }}
                  </div>
                  <ul class="list-unstyled mb-0 small">
                    {% for issue in test_data.issues[:3] %}
                      <li class="text-wrap">â€¢ {{ issue }}</li>
                    {% endfor %}
                    {% if test_data.issues|length > 3 %}
                      <li class="text-muted">...and {{ test_data.issues|length - 3 }} more</li>
                    {% endif %}
                  </ul>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      <div class="empty-icon">
        <i class="fa-solid fa-question-circle" style="font-size: 2rem;"></i>
      </div>
      <p class="empty-title">No test results</p>
      <p class="empty-subtitle text-muted">No performance test results were found in this service.</p>
    </div>
  {% endif %}
{% else %}
  <div class="empty">
    <div class="empty-icon">
      <i class="fa-solid fa-minus-circle text-muted" style="font-size: 2rem;"></i>
    </div>
    <p class="empty-title">Performance testing not available</p>
    <p class="empty-subtitle text-muted">This analysis did not include performance testing.</p>
  </div>
{% endif %}
