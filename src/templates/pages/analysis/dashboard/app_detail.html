{# Comprehensive Analysis Dashboard with Comparisons #}
{% extends 'layouts/base.html' %}

{% set page_title = model_slug + ' App #' + app_number|string %}
{% set page_icon = 'fa-solid fa-chart-line' %}

{% block title %}Analysis Dashboard - {{ model_slug }} #{{ app_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  
  <!-- Header with Navigation -->
  <div class="page-header mb-4">
    <div class="row align-items-center">
      <div class="col">
        <div class="page-pretitle text-muted">Comprehensive Analysis Dashboard</div>
        <h2 class="page-title d-flex align-items-center gap-2">
          <i class="fas fa-chart-line text-primary"></i>
          <span>{{ model_slug }}</span>
          <span class="badge bg-blue-lt">App #{{ app_number }}</span>
        </h2>
      </div>
      <div class="col-auto">
        <div class="btn-list">
          <a href="{{ url_for('analysis.task_detail_page', task_id=task.task_id) }}" 
             class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Task Detail
          </a>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="exportData('csv')">
              <i class="fas fa-download me-1"></i>Export
            </button>
            <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                <i class="fas fa-file-csv me-2"></i>CSV Report
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="exportData('json')">
                <i class="fas fa-file-code me-2"></i>JSON Data
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="exportData('sarif')">
                <i class="fas fa-file-alt me-2"></i>SARIF Format
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Metrics Row -->
  <div class="row row-cards mb-4">
    <div class="col-sm-6 col-xl-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Total Findings</div>
            <div class="ms-auto">
              <div class="chart-sparkline chart-sparkline-sm" id="spark-findings"></div>
            </div>
          </div>
          <div class="h1 mb-0 mt-1" id="metric-total">-</div>
          <div class="text-muted mt-1" id="metric-total-change">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-xl-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Security</div>
            <div class="ms-auto lh-1">
              <span class="badge bg-danger">Critical</span>
            </div>
          </div>
          <div class="d-flex align-items-baseline gap-2 mt-1">
            <div class="h1 mb-0" id="metric-security">-</div>
            <div class="text-danger small" id="metric-security-critical">-</div>
          </div>
          <div class="text-muted mt-1" id="metric-security-breakdown">-</div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-xl-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Code Quality</div>
            <div class="ms-auto lh-1">
              <span class="badge bg-warning">Issues</span>
            </div>
          </div>
          <div class="h1 mb-0 mt-1" id="metric-quality">-</div>
          <div class="text-muted mt-1" id="metric-quality-breakdown">-</div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-xl-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Tools Executed</div>
            <div class="ms-auto">
              <span class="badge bg-success" id="tools-success-badge">-</span>
            </div>
          </div>
          <div class="h1 mb-0 mt-1" id="metric-tools">-</div>
          <div class="progress progress-sm mt-2">
            <div class="progress-bar bg-success" id="tools-progress" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Tabbed Interface -->
  <div class="card">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a href="#tab-overview" class="nav-link active" data-bs-toggle="tab" role="tab">
            <i class="fas fa-chart-pie me-1"></i>Overview
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-tools" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fas fa-tools me-1"></i>Tools Analysis
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-findings" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fas fa-list me-1"></i>All Findings
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-compare-models" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fas fa-code-compare me-1"></i>Compare Models
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-compare-apps" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fas fa-layer-group me-1"></i>Compare Apps
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-timeline" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fas fa-clock me-1"></i>Timeline
          </a>
        </li>
      </ul>
    </div>
    
    <div class="card-body">
      <div class="tab-content">
        
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
          <div class="row g-3">
            <!-- Severity Distribution Chart -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Severity Distribution</h3>
                </div>
                <div class="card-body">
                  <div id="chart-severity" style="height: 300px"></div>
                </div>
              </div>
            </div>
            
            <!-- Category Breakdown Chart -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Findings by Category</h3>
                </div>
                <div class="card-body">
                  <div id="chart-categories" style="height: 300px"></div>
                </div>
              </div>
            </div>
            
            <!-- Top Issues Table -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Top 10 Critical Issues</h3>
                  <div class="card-actions">
                    <a href="#tab-findings" class="btn btn-sm btn-primary" data-bs-toggle="tab">
                      View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-vcenter card-table">
                    <thead>
                      <tr>
                        <th>Severity</th>
                        <th>Tool</th>
                        <th>Category</th>
                        <th>Message</th>
                        <th>Location</th>
                      </tr>
                    </thead>
                    <tbody id="top-issues-tbody">
                      <tr><td colspan="5" class="text-center text-muted py-3">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tools Analysis Tab -->
        <div class="tab-pane fade" id="tab-tools" role="tabpanel">
          <div class="row g-3">
            <!-- Tool Performance Comparison -->
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Tool Performance Comparison</h3>
                </div>
                <div class="card-body">
                  <div id="chart-tools-comparison" style="height: 350px"></div>
                </div>
              </div>
            </div>
            
            <!-- Tool Execution Summary -->
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Execution Status</h3>
                </div>
                <div class="card-body">
                  <div id="tools-status-list" class="divide-y">
                    <div class="text-center text-muted py-3">Loading...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Detailed Tool Results -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Detailed Tool Results</h3>
                  <div class="card-actions">
                    <div class="input-icon">
                      <input type="text" class="form-control form-control-sm" placeholder="Search tools..." id="tools-search">
                      <span class="input-icon-addon"><i class="fas fa-search"></i></span>
                    </div>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-vcenter card-table table-hover">
                    <thead>
                      <tr>
                        <th>Tool</th>
                        <th>Status</th>
                        <th>Findings</th>
                        <th>Critical</th>
                        <th>High</th>
                        <th>Medium</th>
                        <th>Low</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="tools-detail-tbody">
                      <tr><td colspan="8" class="text-center text-muted py-3">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- All Findings Tab -->
        <div class="tab-pane fade" id="tab-findings" role="tabpanel">
          <div class="row g-3 mb-3">
            <div class="col-lg-3">
              <select class="form-select" id="filter-severity">
                <option value="">All Severities</option>
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div class="col-lg-3">
              <select class="form-select" id="filter-category">
                <option value="">All Categories</option>
                <option value="security">Security</option>
                <option value="quality">Quality</option>
                <option value="performance">Performance</option>
              </select>
            </div>
            <div class="col-lg-3">
              <select class="form-select" id="filter-tool">
                <option value="">All Tools</option>
              </select>
            </div>
            <div class="col-lg-3">
              <div class="input-icon">
                <input type="text" class="form-control" placeholder="Search findings..." id="findings-search">
                <span class="input-icon-addon"><i class="fas fa-search"></i></span>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="table-responsive">
              <table class="table table-vcenter table-hover card-table">
                <thead>
                  <tr>
                    <th style="width: 5%">#</th>
                    <th style="width: 10%">Severity</th>
                    <th style="width: 12%">Category</th>
                    <th style="width: 10%">Tool</th>
                    <th style="width: 35%">Message</th>
                    <th style="width: 18%">Location</th>
                    <th style="width: 10%">Actions</th>
                  </tr>
                </thead>
                <tbody id="findings-tbody">
                  <tr><td colspan="7" class="text-center text-muted py-4">Loading findings...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="card-footer d-flex align-items-center">
              <p class="m-0 text-muted">
                Showing <span id="findings-showing">0</span> of <span id="findings-total">0</span> findings
              </p>
              <ul class="pagination m-0 ms-auto" id="findings-pagination">
                <li class="page-item disabled"><a class="page-link" href="#">‹</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item disabled"><a class="page-link" href="#">›</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Compare Models Tab -->
        <div class="tab-pane fade" id="tab-compare-models" role="tabpanel">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Compare this model's performance against other models for the same application type.
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-lg-6">
              <label class="form-label">Select Models to Compare</label>
              <select class="form-select" id="compare-models-select" multiple size="5">
                <option value="{{ model_slug }}" selected>{{ model_slug }} (Current)</option>
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label">Comparison Metrics</label>
              <div class="form-selectgroup">
                <label class="form-selectgroup-item">
                  <input type="checkbox" class="form-selectgroup-input" checked value="findings">
                  <span class="form-selectgroup-label">Total Findings</span>
                </label>
                <label class="form-selectgroup-item">
                  <input type="checkbox" class="form-selectgroup-input" checked value="security">
                  <span class="form-selectgroup-label">Security Issues</span>
                </label>
                <label class="form-selectgroup-item">
                  <input type="checkbox" class="form-selectgroup-input" checked value="quality">
                  <span class="form-selectgroup-label">Quality Score</span>
                </label>
                <label class="form-selectgroup-item">
                  <input type="checkbox" class="form-selectgroup-input" value="performance">
                  <span class="form-selectgroup-label">Performance</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="row g-3">
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Model Comparison Chart</h3>
                </div>
                <div class="card-body">
                  <div id="chart-models-compare" style="height: 400px"></div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Comparison Summary</h3>
                </div>
                <div class="card-body" id="models-comparison-summary">
                  <div class="text-center text-muted py-4">
                    Select models to compare
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Detailed Comparison Table</h3>
                </div>
                <div class="table-responsive">
                  <table class="table table-vcenter card-table">
                    <thead>
                      <tr>
                        <th>Model</th>
                        <th>Total Issues</th>
                        <th>Security</th>
                        <th>Quality</th>
                        <th>Performance</th>
                        <th>Tools Success Rate</th>
                        <th>Overall Score</th>
                      </tr>
                    </thead>
                    <tbody id="models-compare-tbody">
                      <tr><td colspan="7" class="text-center text-muted py-3">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Compare Apps Tab -->
        <div class="tab-pane fade" id="tab-compare-apps" role="tabpanel">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Compare different applications generated by the same model.
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-lg-6">
              <label class="form-label">Select Apps to Compare</label>
              <select class="form-select" id="compare-apps-select" multiple size="5">
                <option value="{{ app_number }}" selected>App #{{ app_number }} (Current)</option>
              </select>
            </div>
            <div class="col-lg-6">
              <label class="form-label">View Mode</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="apps-view" id="apps-view-chart" checked>
                <label class="btn" for="apps-view-chart">
                  <i class="fas fa-chart-bar me-1"></i>Chart View
                </label>
                <input type="radio" class="btn-check" name="apps-view" id="apps-view-table">
                <label class="btn" for="apps-view-table">
                  <i class="fas fa-table me-1"></i>Table View
                </label>
              </div>
            </div>
          </div>
          
          <div class="row g-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Apps Comparison</h3>
                </div>
                <div class="card-body">
                  <div id="chart-apps-compare" style="height: 400px"></div>
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Side-by-Side Comparison</h3>
                </div>
                <div class="table-responsive">
                  <table class="table table-vcenter card-table">
                    <thead>
                      <tr>
                        <th>App</th>
                        <th>Total Findings</th>
                        <th>Critical</th>
                        <th>High</th>
                        <th>Medium</th>
                        <th>Low</th>
                        <th>Tools Executed</th>
                        <th>Analysis Date</th>
                      </tr>
                    </thead>
                    <tbody id="apps-compare-tbody">
                      <tr><td colspan="8" class="text-center text-muted py-3">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Timeline Tab -->
        <div class="tab-pane fade" id="tab-timeline" role="tabpanel">
          <div class="row g-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Analysis Timeline</h3>
                  <div class="card-actions">
                    <div class="btn-group btn-group-sm">
                      <button class="btn active" data-timeline="all">All</button>
                      <button class="btn" data-timeline="7d">7 Days</button>
                      <button class="btn" data-timeline="30d">30 Days</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div id="chart-timeline" style="height: 300px"></div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Trend Analysis</h3>
                </div>
                <div class="card-body" id="trend-analysis">
                  <div class="text-center text-muted py-4">Loading trend data...</div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Recent Changes</h3>
                </div>
                <div class="list-group list-group-flush" id="recent-changes">
                  <div class="list-group-item text-center text-muted">Loading changes...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Finding Detail Modal -->
<div class="modal modal-blur fade" id="finding-modal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Finding Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="finding-modal-body">
        <div class="text-center text-muted py-4">Select a finding to view details</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="exportFinding()">
          <i class="fas fa-download me-1"></i>Export Finding
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Dashboard Data Management
const DashboardData = {
  taskId: '{{ task.task_id }}',
  modelSlug: '{{ model_slug }}',
  appNumber: {{ app_number }},
  rawData: null,
  allFindings: [],
  filteredFindings: [],
  currentPage: 1,
  perPage: 20,
  filters: {
    severity: '',
    category: '',
    tool: '',
    search: ''
  },
  
  async init() {
    await this.loadData();
    this.setupEventListeners();
    this.render();
  },
  
  async loadData() {
    try {
      const response = await fetch(`/analysis/api/tasks/${this.taskId}/results.json`);
      this.rawData = await response.json();
      console.log('Dashboard data loaded:', this.rawData);
      
      this.allFindings = this.rawData.findings || [];
      this.filteredFindings = [...this.allFindings];
      
      return this.rawData;
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
      throw error;
    }
  },
  
  setupEventListeners() {
    // Filter handlers
    document.getElementById('filter-severity')?.addEventListener('change', (e) => {
      this.filters.severity = e.target.value;
      this.applyFilters();
    });
    
    document.getElementById('filter-category')?.addEventListener('change', (e) => {
      this.filters.category = e.target.value;
      this.applyFilters();
    });
    
    document.getElementById('filter-tool')?.addEventListener('change', (e) => {
      this.filters.tool = e.target.value;
      this.applyFilters();
    });
    
    document.getElementById('findings-search')?.addEventListener('input', (e) => {
      this.filters.search = e.target.value.toLowerCase();
      this.applyFilters();
    });
    
    // Tab change handlers
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
      tab.addEventListener('shown.bs.tab', (e) => {
        const targetId = e.target.getAttribute('href').substring(1);
        this.onTabChange(targetId);
      });
    });
  },
  
  applyFilters() {
    this.filteredFindings = this.allFindings.filter(f => {
      if (this.filters.severity && f.severity?.toLowerCase() !== this.filters.severity) return false;
      if (this.filters.category && !f.category?.toLowerCase().includes(this.filters.category)) return false;
      if (this.filters.tool && f.tool !== this.filters.tool) return false;
      if (this.filters.search) {
        const searchIn = `${f.message || ''} ${f.file?.path || ''} ${f.category || ''}`.toLowerCase();
        if (!searchIn.includes(this.filters.search)) return false;
      }
      return true;
    });
    
    this.currentPage = 1;
    this.renderFindings();
  },
  
  render() {
    this.renderMetrics();
    this.renderOverview();
    this.renderTools();
    this.renderFindings();
  },
  
  renderMetrics() {
    const summary = this.rawData.summary || {};
    const findings = this.allFindings;
    
    const securityCount = findings.filter(f => f.category?.toLowerCase().includes('security')).length;
    const qualityCount = findings.filter(f => f.category?.toLowerCase().includes('quality')).length;
    
    document.getElementById('metric-total').textContent = findings.length;
    document.getElementById('metric-total-change').textContent = `Across ${(summary.tools_used || []).length} tools`;
    
    document.getElementById('metric-security').textContent = securityCount;
    const criticalSec = findings.filter(f => 
      f.category?.toLowerCase().includes('security') && f.severity?.toLowerCase() === 'critical'
    ).length;
    document.getElementById('metric-security-critical').textContent = criticalSec > 0 ? `${criticalSec} critical` : '';
    document.getElementById('metric-security-breakdown').textContent = 
      `High: ${findings.filter(f => f.category?.toLowerCase().includes('security') && f.severity?.toLowerCase() === 'high').length}`;
    
    document.getElementById('metric-quality').textContent = qualityCount;
    document.getElementById('metric-quality-breakdown').textContent = 
      `Issues affecting code maintainability`;
    
    const toolsUsed = (summary.tools_used || []).length;
    const toolsFailed = (summary.tools_failed || []).length;
    document.getElementById('metric-tools').textContent = `${toolsUsed - toolsFailed}/${toolsUsed}`;
    document.getElementById('tools-success-badge').textContent = `${Math.round((toolsUsed - toolsFailed) / toolsUsed * 100)}%`;
    document.getElementById('tools-progress').style.width = `${(toolsUsed - toolsFailed) / toolsUsed * 100}%`;
  },
  
  renderOverview() {
    // Render charts (placeholder - would use ApexCharts or similar)
    const severityCounts = {
      critical: this.allFindings.filter(f => f.severity?.toLowerCase() === 'critical').length,
      high: this.allFindings.filter(f => f.severity?.toLowerCase() === 'high').length,
      medium: this.allFindings.filter(f => f.severity?.toLowerCase() === 'medium').length,
      low: this.allFindings.filter(f => f.severity?.toLowerCase() === 'low').length
    };
    
    document.getElementById('chart-severity').innerHTML = `
      <div class="text-center py-5">
        <div class="mb-3"><strong>Severity Distribution</strong></div>
        <div class="d-flex justify-content-around">
          <div><span class="badge bg-danger">Critical: ${severityCounts.critical}</span></div>
          <div><span class="badge bg-warning">High: ${severityCounts.high}</span></div>
          <div><span class="badge bg-info">Medium: ${severityCounts.medium}</span></div>
          <div><span class="badge bg-secondary">Low: ${severityCounts.low}</span></div>
        </div>
      </div>
    `;
    
    // Top issues
    const topIssues = [...this.allFindings]
      .filter(f => f.severity?.toLowerCase() === 'critical' || f.severity?.toLowerCase() === 'high')
      .slice(0, 10);
    
    document.getElementById('top-issues-tbody').innerHTML = topIssues.length > 0 ? 
      topIssues.map(f => this.renderFindingRow(f)).join('') :
      '<tr><td colspan="5" class="text-center text-muted py-3">No critical issues found</td></tr>';
  },
  
  renderTools() {
    const summary = this.rawData.summary || {};
    const toolsUsed = summary.tools_used || [];
    
    // Populate tool filter dropdown
    const toolSelect = document.getElementById('filter-tool');
    if (toolSelect) {
      toolSelect.innerHTML = '<option value="">All Tools</option>' + 
        toolsUsed.map(tool => `<option value="${tool}">${tool}</option>`).join('');
    }
    
    // Tool status list
    const statusHtml = toolsUsed.map(tool => {
      const toolFindings = this.allFindings.filter(f => f.tool === tool);
      return `
        <div class="py-2">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-success-lt">✓</span>
            <strong>${tool}</strong>
            <span class="ms-auto badge bg-blue-lt">${toolFindings.length} findings</span>
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('tools-status-list').innerHTML = statusHtml || 
      '<div class="text-center text-muted py-3">No tools executed</div>';
  },
  
  renderFindings() {
    const start = (this.currentPage - 1) * this.perPage;
    const end = start + this.perPage;
    const pageFindings = this.filteredFindings.slice(start, end);
    
    const tbody = document.getElementById('findings-tbody');
    tbody.innerHTML = pageFindings.length > 0 ?
      pageFindings.map((f, idx) => this.renderFindingRow(f, start + idx + 1)).join('') :
      '<tr><td colspan="7" class="text-center text-muted py-4">No findings match the current filters</td></tr>';
    
    document.getElementById('findings-showing').textContent = pageFindings.length;
    document.getElementById('findings-total').textContent = this.filteredFindings.length;
    
    this.renderPagination();
  },
  
  renderFindingRow(finding, index = '') {
    const severityClass = {
      critical: 'danger',
      high: 'warning',
      medium: 'info',
      low: 'secondary'
    }[finding.severity?.toLowerCase()] || 'secondary';
    
    const location = finding.file?.path ? 
      `${finding.file.path}:${finding.file.line_start || '?'}` : 'N/A';
    
    const message = (finding.message?.title || finding.message?.description || finding.message || 'No message')
      .substring(0, 80);
    
    return `
      <tr onclick="DashboardData.showFindingDetail(${JSON.stringify(finding).replace(/"/g, '&quot;')})">
        ${index ? `<td>${index}</td>` : ''}
        <td><span class="badge bg-${severityClass}">${finding.severity || 'N/A'}</span></td>
        <td>${finding.category || 'N/A'}</td>
        <td><code class="small">${finding.tool || 'N/A'}</code></td>
        <td>${message}${message.length >= 80 ? '...' : ''}</td>
        <td class="text-muted small">${location}</td>
        <td>
          <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); DashboardData.showFindingDetail(${JSON.stringify(finding).replace(/"/g, '&quot;')})">
            <i class="fas fa-eye"></i>
          </button>
        </td>
      </tr>
    `;
  },
  
  renderPagination() {
    const totalPages = Math.ceil(this.filteredFindings.length / this.perPage);
    const pagination = document.getElementById('findings-pagination');
    
    let html = `
      <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="DashboardData.changePage(${this.currentPage - 1}); return false;">‹</a>
      </li>
    `;
    
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
      html += `
        <li class="page-item ${i === this.currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="DashboardData.changePage(${i}); return false;">${i}</a>
        </li>
      `;
    }
    
    html += `
      <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="DashboardData.changePage(${this.currentPage + 1}); return false;">›</a>
      </li>
    `;
    
    pagination.innerHTML = html;
  },
  
  changePage(page) {
    const totalPages = Math.ceil(this.filteredFindings.length / this.perPage);
    if (page < 1 || page > totalPages) return;
    this.currentPage = page;
    this.renderFindings();
  },
  
  showFindingDetail(finding) {
    const modalBody = document.getElementById('finding-modal-body');
    const severityClass = {
      critical: 'danger',
      high: 'warning',
      medium: 'info',
      low: 'secondary'
    }[finding.severity?.toLowerCase()] || 'secondary';
    
    modalBody.innerHTML = `
      <table class="table table-borderless">
        <tr><td class="w-25"><strong>Tool</strong></td><td>${finding.tool || 'N/A'}</td></tr>
        <tr><td><strong>Category</strong></td><td>${finding.category || 'N/A'}</td></tr>
        <tr><td><strong>Severity</strong></td><td><span class="badge bg-${severityClass}">${finding.severity || 'N/A'}</span></td></tr>
        <tr><td><strong>Type</strong></td><td>${finding.type || 'N/A'}</td></tr>
        <tr><td><strong>Message</strong></td><td>${finding.message?.title || finding.message?.description || finding.message || 'N/A'}</td></tr>
        <tr><td><strong>File</strong></td><td><code>${finding.file?.path || 'N/A'}</code></td></tr>
        <tr><td><strong>Line</strong></td><td>${finding.file?.line_start || 'N/A'} - ${finding.file?.line_end || 'N/A'}</td></tr>
        <tr><td><strong>Rule ID</strong></td><td><code>${finding.rule_id || finding.symbol || 'N/A'}</code></td></tr>
        ${finding.metadata?.cwe_id ? `<tr><td><strong>CWE</strong></td><td>${finding.metadata.cwe_id}</td></tr>` : ''}
        ${finding.metadata?.cvss_score ? `<tr><td><strong>CVSS</strong></td><td>${finding.metadata.cvss_score}</td></tr>` : ''}
      </table>
    `;
    
    new bootstrap.Modal(document.getElementById('finding-modal')).show();
  },
  
  onTabChange(tabId) {
    console.log('Tab changed to:', tabId);
    // Load data for specific tabs on demand
    if (tabId === 'tab-compare-models') {
      this.loadModelComparison();
    } else if (tabId === 'tab-compare-apps') {
      this.loadAppComparison();
    } else if (tabId === 'tab-timeline') {
      this.loadTimeline();
    }
  },
  
  async loadModelComparison() {
    // Placeholder - would fetch other models' data
    document.getElementById('models-compare-tbody').innerHTML = 
      '<tr><td colspan="7" class="text-center text-muted py-3">Model comparison data loading...</td></tr>';
  },
  
  async loadAppComparison() {
    // Placeholder - would fetch other apps' data
    document.getElementById('apps-compare-tbody').innerHTML = 
      '<tr><td colspan="8" class="text-center text-muted py-3">App comparison data loading...</td></tr>';
  },
  
  async loadTimeline() {
    // Placeholder - would fetch historical data
    document.getElementById('trend-analysis').innerHTML = 
      '<div class="text-center text-muted py-4">Timeline data loading...</div>';
  }
};

// Export functions
function exportData(format) {
  const url = {
    csv: `/analysis/dashboard/export/${DashboardData.modelSlug}/${DashboardData.appNumber}/csv`,
    json: `/analysis/api/tasks/${DashboardData.taskId}/results.json`,
    sarif: `/analysis/api/tasks/${DashboardData.taskId}/export/sarif`
  }[format];
  
  if (url) window.open(url, '_blank');
}

function exportFinding() {
  showToast('Finding export feature coming soon', 'info');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  DashboardData.init().catch(err => {
    console.error('Dashboard initialization failed:', err);
    showToast('Failed to load dashboard data', 'error');
  });
});
</script>
{% endblock %}
