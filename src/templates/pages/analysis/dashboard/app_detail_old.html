{# Table-Based Dashboard for Single App Analysis #}
{% extends 'layouts/base.html' %}

{% set page_title = model_slug + ' App #' + app_number|string %}
{% set page_icon = 'fa-solid fa-chart-line' %}
{% set page_subtitle = 'Analysis Dashboard' %}

{% block title %}App Dashboard - {{ model_slug }} #{{ app_number }}{% endblock %}

{% block content %}
<div class="container-xl">
  
  <!-- Page Header -->
  <div class="page-header d-print-none mb-3">
    <div class="row align-items-center">
      <div class="col">
        <div class="page-pretitle">Analysis Dashboard</div>
        <h2 class="page-title">
          <i class="fas fa-chart-line me-2 text-primary"></i>
          {{ model_slug }} - App #{{ app_number }}
        </h2>
      </div>
      <div class="col-auto ms-auto">
        <div class="btn-list">
          <a href="{{ url_for('analysis.task_detail_page', task_id=task.task_id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Task Detail
          </a>
          <a href="{{ url_for('dashboard.export_app_csv', model_slug=model_slug, app_number=app_number) }}" 
             class="btn btn-primary">
            <i class="fas fa-download me-1"></i>Export CSV
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats Cards -->
  <div class="row row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <span class="bg-primary text-white avatar"><i class="fas fa-bug"></i></span>
            </div>
            <div class="col">
              <div class="font-weight-medium" id="stat-total-findings">-</div>
              <div class="text-muted">Total Findings</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <span class="bg-danger text-white avatar"><i class="fas fa-shield-alt"></i></span>
            </div>
            <div class="col">
              <div class="font-weight-medium" id="stat-security">-</div>
              <div class="text-muted">Security Issues</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <span class="bg-warning text-white avatar"><i class="fas fa-code"></i></span>
            </div>
            <div class="col">
              <div class="font-weight-medium" id="stat-quality">-</div>
              <div class="text-muted">Quality Issues</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <span class="bg-success text-white avatar"><i class="fas fa-tools"></i></span>
            </div>
            <div class="col">
              <div class="font-weight-medium" id="stat-tools">-</div>
              <div class="text-muted">Tools Executed</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Findings Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">All Findings</h3>
      <div class="card-actions">
        <select class="form-select form-select-sm me-2" id="filter-category">
          <option value="all">All Categories</option>
          <option value="security">Security</option>
          <option value="quality">Quality</option>
          <option value="performance">Performance</option>
        </select>
        <select class="form-select form-select-sm me-2" id="filter-severity">
          <option value="all">All Severities</option>
          <option value="high">High+</option>
          <option value="medium">Medium+</option>
          <option value="low">Low+</option>
        </select>
        <select class="form-select form-select-sm" id="filter-tool">
          <option value="all">All Tools</option>
        </select>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-vcenter table-hover card-table">
        <thead>
          <tr>
            <th>Tool</th>
            <th>Category</th>
            <th>Severity</th>
            <th>Message</th>
            <th>File</th>
            <th>Line</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="findings-tbody">
          <tr>
            <td colspan="7" class="text-center py-4 text-muted">
              <div class="spinner-border spinner-border-sm me-2"></div>
              Loading findings...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="card-footer d-flex align-items-center">
      <p class="m-0 text-muted">
        Showing <span id="visible-count">0</span> of <span id="total-count">0</span> findings
      </p>
      <ul class="pagination m-0 ms-auto" id="pagination"></ul>
    </div>
  </div>

</div>

<!-- Finding Detail Modal -->
<div class="modal modal-blur fade" id="finding-modal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Finding Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="finding-detail-content">
        <!-- Details loaded dynamically -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Page data from Flask
const MODEL_SLUG = "{{ model_slug }}";
const APP_NUMBER = {{ app_number }};
const TASK_ID = "{{ task.task_id }}";

let allFindings = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
  loadAnalysisData();
});

async function loadAnalysisData() {
  try {
    const response = await fetch(`/analysis/api/tasks/${TASK_ID}/results.json`);
    const data = await response.json();
    
    console.log('Dashboard data loaded:', data);
    
    // Extract summary - could be at root or in results
    const summary = data.summary || data.results?.summary || {};
    
    // Extract findings - they're in the unified format at root level
    allFindings = data.findings || [];
    
    // Count findings by category
    const securityCount = allFindings.filter(f => (f.category || '').toLowerCase().includes('security')).length;
    const qualityCount = allFindings.filter(f => (f.category || '').toLowerCase().includes('quality')).length;
    
    // Update summary cards
    document.getElementById('stat-total-findings').textContent = summary.total_findings || allFindings.length || 0;
    document.getElementById('stat-security').textContent = securityCount;
    document.getElementById('stat-quality').textContent = qualityCount;
    document.getElementById('stat-tools').textContent = (summary.tools_used || []).length;
    
    // Populate filters
    populateFilters();
    
    // Render findings
    renderFindings(allFindings);
    
  } catch (error) {
    console.error('Error loading analysis data:', error);
    showError();
  }
}

function populateFilters() {
  const tools = [...new Set(allFindings.map(f => f.tool))].filter(Boolean).sort();
  const toolFilter = document.getElementById('filter-tool');
  tools.forEach(tool => {
    const opt = document.createElement('option');
    opt.value = tool;
    opt.textContent = tool.toUpperCase();
    toolFilter.appendChild(opt);
  });
  
  // Add event listeners
  ['filter-category', 'filter-severity', 'filter-tool'].forEach(id => {
    document.getElementById(id).addEventListener('change', filterFindings);
  });
}

function renderFindings(findings) {
  const tbody = document.getElementById('findings-tbody');
  
  if (findings.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No findings match the current filters</td></tr>';
    document.getElementById('visible-count').textContent = '0';
    document.getElementById('total-count').textContent = allFindings.length;
    return;
  }
  
  tbody.innerHTML = findings.map((f, idx) => {
    const severityBadge = getSeverityBadge(f.severity);
    const categoryBadge = getCategoryBadge(f.category);
    const fileName = (f.file?.path || '').split('/').pop() || 'Unknown';
    
    return `
      <tr data-index="${idx}" style="cursor: pointer;" onclick="showFindingDetails(${idx})">
        <td><span class="badge bg-dark-lt">${f.tool || '-'}</span></td>
        <td>${categoryBadge}</td>
        <td>${severityBadge}</td>
        <td class="text-truncate" style="max-width: 300px;">${escapeHtml((f.message?.title || f.message?.description || f.message || 'Issue').substring(0, 80))}</td>
        <td class="text-truncate" style="max-width: 150px;" title="${f.file?.path || ''}">${fileName}</td>
        <td class="text-center">${f.file?.line_start || f.line_number || '-'}</td>
        <td class="text-center">
          <button class="btn btn-sm btn-ghost-secondary" onclick="event.stopPropagation(); showFindingDetails(${idx});">
            <i class="fas fa-info-circle"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('visible-count').textContent = findings.length;
  document.getElementById('total-count').textContent = allFindings.length;
}

function filterFindings() {
  const category = document.getElementById('filter-category').value;
  const severity = document.getElementById('filter-severity').value;
  const tool = document.getElementById('filter-tool').value;
  
  let filtered = allFindings;
  
  if (category !== 'all') {
    filtered = filtered.filter(f => (f.category || '').toLowerCase().includes(category));
  }
  
  if (severity !== 'all') {
    const severityMap = {
      'high': ['critical', 'high'],
      'medium': ['critical', 'high', 'medium'],
      'low': ['critical', 'high', 'medium', 'low']
    };
    filtered = filtered.filter(f => severityMap[severity].includes((f.severity || '').toLowerCase()));
  }
  
  if (tool !== 'all') {
    filtered = filtered.filter(f => f.tool === tool);
  }
  
  renderFindings(filtered);
}

function showFindingDetails(index) {
  const finding = allFindings[index];
  if (!finding) return;
  
  const content = `
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <strong>Tool:</strong> ${finding.tool || '-'}<br>
        <strong>Category:</strong> ${finding.category || '-'}<br>
        <strong>Severity:</strong> ${getSeverityBadge(finding.severity)}
      </div>
      <div class="col-md-6">
        <strong>File:</strong> <code>${finding.file?.path || '-'}</code><br>
        <strong>Line:</strong> ${finding.file?.line_start || '-'}<br>
        <strong>Rule:</strong> ${finding.rule_id || finding.symbol || '-'}
      </div>
    </div>
    <hr>
    <h6>Description:</h6>
    <p>${escapeHtml(finding.message?.description || finding.message?.title || finding.message || 'No description')}</p>
    
    ${finding.evidence?.code_snippet ? `
      <h6>Code Snippet:</h6>
      <pre class="bg-light p-3 rounded"><code>${escapeHtml(finding.evidence.code_snippet)}</code></pre>
    ` : ''}
    
    ${finding.message?.solution ? `
      <h6>Recommended Solution:</h6>
      <div class="alert alert-success">${escapeHtml(finding.message.solution)}</div>
    ` : ''}
  `;
  
  document.getElementById('finding-detail-content').innerHTML = content;
  new bootstrap.Modal(document.getElementById('finding-modal')).show();
}

function getSeverityBadge(severity) {
  const sev = (severity || '').toLowerCase();
  if (sev === 'critical' || sev === 'high') return `<span class="badge bg-danger">${severity}</span>`;
  if (sev === 'medium') return `<span class="badge bg-warning">${severity}</span>`;
  if (sev === 'low') return `<span class="badge bg-info">${severity}</span>`;
  return `<span class="badge bg-secondary">${severity || 'Unknown'}</span>`;
}

function getCategoryBadge(category) {
  if (category === 'security') return '<span class="badge bg-danger-lt">Security</span>';
  if (category === 'quality' || category === 'code_quality') return '<span class="badge bg-primary-lt">Quality</span>';
  if (category === 'performance') return '<span class="badge bg-success-lt">Performance</span>';
  return `<span class="badge bg-secondary-lt">${category || 'Other'}</span>`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function showError() {
  document.getElementById('findings-tbody').innerHTML = 
    '<tr><td colspan="7" class="text-center text-danger py-4">Error loading analysis data</td></tr>';
}
</script>
{% endblock %}
