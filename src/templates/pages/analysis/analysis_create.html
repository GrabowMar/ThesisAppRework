{# Analysis Creation Wizard Page #}
{% extends 'layouts/base_smart.html' %}
{% set active_page = 'analysis' %}
{% set page_title = 'Create Analysis' %}
{% set page_icon = 'fa-solid fa-flask' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<form id="analysis-wizard-form" method="POST" action="/analysis/create">
  <input type="hidden" name="model_slug" id="input-model-slug" />
  <input type="hidden" name="app_number" id="input-app-number" />
  <input type="hidden" name="analysis_mode" id="input-analysis-mode" value="custom" />
  <div id="batch-model-inputs" class="d-none"></div>
  <div id="batch-app-inputs" class="d-none"></div>
  <div id="selected-tools-inputs" class="d-none"></div>

  <div class="row row-cards g-2">
    <div class="col-xxl-8 col-xl-7 col-lg-7">
      <div class="row row-cards g-2">
        <!-- Step 1: Model Selection -->
        <div class="col-12 wizard-panel active" data-panel="1">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 1</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fas fa-brain text-primary"></i>
                    <span>Select AI Model</span>
                  </h3>
                  <div class="text-muted small">Choose the AI model you want to analyze</div>
                </div>
              </div>
            </div>
            <div class="card-body border-top p-0">
              <div class="p-3 border-bottom">
                <div class="row g-2 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label" for="provider-filter">Provider</label>
                    <select class="form-select" id="provider-filter" _="on change call filterModels()" hx-get="/analysis/api/models/providers" hx-trigger="load" hx-swap="innerHTML">
                      <option value="">Loading providers...</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="capability-filter">Capability</label>
                    <select class="form-select" id="capability-filter" _="on change call filterModels()">
                      <option value="">All Capabilities</option>
                      <option value="coding">Coding</option>
                      <option value="analysis">Analysis</option>
                      <option value="reasoning">Reasoning</option>
                      <option value="multimodal">Multimodal</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="price-filter">Price Range</label>
                    <select class="form-select" id="price-filter" _="on change call filterModels()">
                      <option value="">All Price Tiers</option>
                      <option value="low">Low (under $0.01/token)</option>
                      <option value="medium">Medium ($0.01-$0.05/token)</option>
                      <option value="high">High (above $0.05/token)</option>
                    </select>
                  </div>
                </div>
              </div>

              <div id="model-selection-grid" class="table-responsive w-100" hx-get="/analysis/api/models/grid?selectable=true" hx-trigger="load">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="text-muted small mb-0 mt-2">Loading available models…</p>
                </div>
              </div>

              <div id="step1-error" class="alert alert-danger d-none m-3">
                <div class="d-flex align-items-center">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <div>Please select a model to continue.</div>
                </div>
              </div>
            </div>
        </div>
      </div>

      <!-- Step 2: Application Selection -->
      <div class="col-12 wizard-panel" data-panel="2">
        <div class="card card-table-compact">
          <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 2</span>
              <div>
                <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                  <i class="fas fa-rocket text-primary"></i>
                  <span>Choose Application</span>
                </h3>
                <div class="text-muted small">Select which application generated by your chosen model you want to analyze.</div>
              </div>
            </div>
          </div>
          <div class="card-body border-top p-0">
            <!-- Single model application list -->
            <div id="application-selection-list" class="table-responsive w-100">
              <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p class="fw-bold mb-1">Select a model first</p>
                <p class="small mb-0">Please select a model in Step 1 to see available applications.</p>
              </div>
            </div>

            <!-- Batch application selection (shown when in batch mode with multiple models) -->
            <div id="batch-app-aggregate" class="p-3" style="display: none;">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                  <h5 class="mb-1">
                    <i class="fas fa-layer-group text-primary me-2"></i>
                    Batch Application Selection
                  </h5>
                  <p class="text-muted small mb-0">
                    Select applications across <span id="batch-selected-model-count" class="fw-bold">0</span> selected models
                    <span id="batch-total-apps-label" class="ms-2" style="display: none;">
                      — <span id="batch-total-apps" class="fw-bold">0</span> total applications available
                    </span>
                  </p>
                </div>
                <div class="d-flex gap-2">
                  <input type="text" id="batch-app-search" class="form-control form-control-sm" placeholder="Search apps..." style="width: 200px;">
                </div>
              </div>
              
              <!-- Selected Models Grid -->
              <div class="row g-2 mb-3" id="batch-selected-models-grid"></div>
              
              <!-- All Apps List -->
              <div class="border rounded p-2 bg-body-secondary" style="max-height: 400px; overflow-y: auto;">
                <div class="row g-2" id="batch-all-apps-list"></div>
                <div id="batch-apps-empty" class="text-center text-muted py-4" style="display: none;">
                  <i class="fas fa-folder-open fa-2x mb-2"></i>
                  <p class="mb-0">No applications found for the selected models.</p>
                </div>
              </div>
            </div>

            <div id="step2-error" class="alert alert-danger d-none m-3">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>Please select an application to continue.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Analysis Configuration -->
      <div class="col-12 wizard-panel" data-panel="3">
        <div class="card card-table-compact">
          <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 3</span>
              <div>
                <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                  <i class="fas fa-cogs text-primary"></i>
                  <span>Configure Analysis</span>
                </h3>
                <div class="text-muted small">Choose analysis tools and configure parameters</div>
              </div>
            </div>
          </div>
          <div class="card-body border-top p-0">
            <!-- Analysis Tool Selection -->
            <div class="p-3 border-bottom">
              <div class="d-flex align-items-center justify-content-between">
                <label class="form-label fw-bold mb-0">Analysis Tools <span class="text-danger">*</span></label>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-ghost-success btn-sm" id="select-all-tools-btn">
                    <i class="fas fa-check-all me-1"></i>Select All
                  </button>
                  <button type="button" class="btn btn-ghost-danger btn-sm" id="clear-all-tools-btn">
                    <i class="fas fa-times me-1"></i>Clear All
                  </button>
                  <button type="button" class="btn btn-ghost-secondary btn-sm" id="refresh-availability-btn" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>

              <div id="step3-inline-error" class="alert alert-danger py-2 d-none mt-3" role="alert"></div>

              <div class="alert alert-info mt-3 mb-0" role="alert">
                <i class="fas fa-hand-pointer me-2"></i>
                Select the analysis tools you want to run from the categories below.
              </div>

              <!-- Tool Containers -->
              <div class="row g-3 mt-0 pt-3">
                <!-- Static Analyzer -->
                <div class="col-lg-6">
                  <div class="card card-table-compact h-100 shadow-none border">
                    <div class="card-header border-0 pb-1">
                      <div class="d-flex align-items-start justify-content-between gap-3">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-search text-primary mt-1"></i>
                          <div>
                            <div class="text-uppercase text-muted small fw-bold">Static Analyzer</div>
                            <h3 class="card-title mb-0">Static Analysis</h3>
                          </div>
                        </div>
                        <div class="text-end small">
                          <span class="badge bg-secondary-lt text-secondary fw-bold" id="static-container-status">Pending</span>
                          <div class="text-muted" id="static-tool-count">0 tools</div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-0">
                      <!-- Static Analyzer Info Banner -->
                      <div class="px-3 py-2 bg-primary-lt border-bottom">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-shield-alt text-primary mt-1"></i>
                          <div class="small">
                            <strong>Security & Quality Scanning</strong>
                            <p class="mb-0 text-muted">Analyzes source code without execution to find vulnerabilities, bugs, and code smells.</p>
                          </div>
                        </div>
                      </div>
                      <div class="table-responsive" id="static-tools">
                        <div class="text-center py-4">
                          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                          <p class="mb-0 small text-muted mt-2">Loading tools…</p>
                        </div>
                      </div>
                      <!-- Static Analyzer Capabilities Summary -->
                      <div class="px-3 py-2 bg-light-subtle border-top">
                        <div class="row g-2 small">
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-bug text-danger"></i>
                              <span class="text-muted">Vulnerability Detection</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-broom text-info"></i>
                              <span class="text-muted">Code Quality Linting</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-check-double text-success"></i>
                              <span class="text-muted">Type Checking</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-skull-crossbones text-secondary"></i>
                              <span class="text-muted">Dead Code Detection</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dynamic Analyzer -->
                <div class="col-lg-6">
                  <div class="card card-table-compact h-100 shadow-none border">
                    <div class="card-header border-0 pb-1">
                      <div class="d-flex align-items-start justify-content-between gap-3">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-play text-success mt-1"></i>
                          <div>
                            <div class="text-uppercase text-muted small fw-bold">Dynamic Analyzer</div>
                            <h3 class="card-title mb-0">Dynamic Analysis</h3>
                          </div>
                        </div>
                        <div class="text-end small">
                          <span class="badge bg-secondary-lt text-secondary fw-bold" id="dynamic-container-status">Pending</span>
                          <div class="text-muted" id="dynamic-tool-count">0 tools</div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-0">
                      <!-- Dynamic Analyzer Info Banner -->
                      <div class="px-3 py-2 bg-success-lt border-bottom">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-bolt text-success mt-1"></i>
                          <div class="small">
                            <strong>Runtime Security Testing</strong>
                            <p class="mb-0 text-muted">Tests running applications to find vulnerabilities through active probing and scanning.</p>
                          </div>
                        </div>
                      </div>
                      <div class="table-responsive" id="dynamic-tools">
                        <div class="text-center py-4">
                          <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                          <p class="mb-0 small text-muted mt-2">Loading tools…</p>
                        </div>
                      </div>
                      <!-- Dynamic Analyzer Capabilities Summary -->
                      <div class="px-3 py-2 bg-light-subtle border-top">
                        <div class="row g-2 small">
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-spider text-danger"></i>
                              <span class="text-muted">Web App Scanning</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-network-wired text-info"></i>
                              <span class="text-muted">Network Discovery</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-exchange-alt text-primary"></i>
                              <span class="text-muted">HTTP/API Testing</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-key text-warning"></i>
                              <span class="text-muted">Auth & Session Tests</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Performance Testing -->
                <div class="col-lg-6">
                  <div class="card card-table-compact h-100 shadow-none border">
                    <div class="card-header border-0 pb-1">
                      <div class="d-flex align-items-start justify-content-between gap-3">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-tachometer-alt text-info mt-1"></i>
                          <div>
                            <div class="text-uppercase text-muted small fw-bold">Performance Tester</div>
                            <h3 class="card-title mb-0">Performance Testing</h3>
                          </div>
                        </div>
                        <div class="text-end small">
                          <span class="badge bg-secondary-lt text-secondary fw-bold" id="performance-container-status">Pending</span>
                          <div class="text-muted" id="performance-tool-count">0 tools</div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-0">
                      <!-- Performance Tester Info Banner -->
                      <div class="px-3 py-2 bg-info-lt border-bottom">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-chart-line text-info mt-1"></i>
                          <div class="small">
                            <strong>Load & Stress Testing</strong>
                            <p class="mb-0 text-muted">Measures application performance under various load conditions and user scenarios.</p>
                          </div>
                        </div>
                      </div>
                      <div class="table-responsive" id="performance-tools">
                        <div class="text-center py-4">
                          <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                          <p class="mb-0 small text-muted mt-2">Loading tools…</p>
                        </div>
                      </div>
                      <!-- Performance Tester Capabilities Summary -->
                      <div class="px-3 py-2 bg-light-subtle border-top">
                        <div class="row g-2 small">
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-users text-primary"></i>
                              <span class="text-muted">Load Testing</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-bolt text-warning"></i>
                              <span class="text-muted">Stress Testing</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-stopwatch text-success"></i>
                              <span class="text-muted">Response Time</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-server text-danger"></i>
                              <span class="text-muted">Throughput Analysis</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AI Analysis -->
                <div class="col-lg-6">
                  <div class="card card-table-compact h-100 shadow-none border">
                    <div class="card-header border-0 pb-1">
                      <div class="d-flex align-items-start justify-content-between gap-3">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-brain text-warning mt-1"></i>
                          <div>
                            <div class="text-uppercase text-muted small fw-bold">AI Analyzer</div>
                            <h3 class="card-title mb-0">AI Analysis</h3>
                          </div>
                        </div>
                        <div class="text-end small">
                          <span class="badge bg-secondary-lt text-secondary fw-bold" id="ai-container-status">Pending</span>
                          <div class="text-muted" id="ai-tool-count">0 tools</div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-0">
                      <!-- AI Analyzer Info Banner -->
                      <div class="px-3 py-2 bg-warning-lt border-bottom">
                        <div class="d-flex align-items-start gap-2">
                          <i class="fas fa-robot text-warning mt-1"></i>
                          <div class="small">
                            <strong>LLM-Powered Analysis</strong>
                            <p class="mb-0 text-muted">Uses Claude 3.5 Haiku via OpenRouter to analyze code against requirements and quality metrics.</p>
                          </div>
                        </div>
                      </div>
                      <div class="table-responsive" id="ai-tools">
                        <div class="text-center py-4">
                          <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                          <p class="mb-0 small text-muted mt-2">Loading tools…</p>
                        </div>
                      </div>
                      <!-- AI Analyzer Capabilities Summary -->
                      <div class="px-3 py-2 bg-light-subtle border-top">
                        <div class="row g-2 small">
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-clipboard-check text-success"></i>
                              <span class="text-muted">Requirements Compliance</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-code text-primary"></i>
                              <span class="text-muted">Code Quality Metrics</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-layer-group text-info"></i>
                              <span class="text-muted">Backend/Frontend/Admin</span>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="d-flex align-items-center gap-1">
                              <i class="fas fa-bug text-danger"></i>
                              <span class="text-muted">Anti-Pattern Detection</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Analysis Configuration Options -->
            <div id="analysis-config-options" class="p-3">
              <div class="row g-3 mb-0">
                <div class="col-md-6">
                  <label class="form-label fw-medium" for="priority-level">Priority Level</label>
                  <select class="form-select" name="priority" id="priority-level">
                    <option value="normal">Normal</option>
                    <option value="high">High (faster execution)</option>
                    <option value="low">Low (cost optimized)</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-medium" for="notification-preference">Email Notification</label>
                  <select class="form-select" name="notification" id="notification-preference">
                    <option value="completion">On completion</option>
                    <option value="failure">On failure only</option>
                    <option value="none">No notifications</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="advanced-options-toggle">
                  <label class="form-check-label" for="advanced-options-toggle">
                    Show advanced configuration options
                  </label>
                </div>
              </div>

              <div id="advanced-options" class="collapse">
                <div class="card card-sm bg-body-secondary">
                  <div class="card-header py-2">
                    <h6 class="card-title mb-0">Advanced Configuration</h6>
                  </div>
                  <div class="card-body py-2">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label fw-medium" for="analysis-timeout">Timeout (minutes)</label>
                        <input type="number" class="form-control" id="analysis-timeout" name="timeout" value="30" min="5" max="120">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-medium" for="analysis-workers">Concurrent Workers</label>
                        <input type="number" class="form-control" id="analysis-workers" name="workers" value="2" min="1" max="8">
                      </div>
                    </div>
                    <div class="mt-3">
                      <label class="form-label fw-medium" for="analysis-custom-params">Custom Parameters (JSON)</label>
                      <textarea class="form-control" id="analysis-custom-params" name="custom_params" rows="3" placeholder="{}"></textarea>
                    </div>
                  </div>
                </div>
                
                <!-- Container Management Options -->
                <div class="card card-sm bg-light mt-3">
                  <div class="card-header py-2">
                    <div class="d-flex align-items-center justify-content-between">
                      <h6 class="card-title mb-0">
                        <i class="fab fa-docker text-primary me-2"></i>Container Management
                      </h6>
                      <span class="badge bg-info-lt text-info">Optional</span>
                    </div>
                  </div>
                  <div class="card-body py-2">
                    <p class="text-muted small mb-3">
                      Enable smart container lifecycle management to automatically start or build application containers 
                      before analysis and optionally stop them afterward. Useful for dynamic and performance testing.
                    </p>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="container-auto-start" name="container_auto_start">
                          <label class="form-check-label" for="container-auto-start">
                            <span class="fw-medium">Auto-start containers</span>
                            <div class="text-muted small">Start containers before analysis begins</div>
                          </label>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="container-build-if-missing" name="container_build_if_missing">
                          <label class="form-check-label" for="container-build-if-missing">
                            <span class="fw-medium">Build if missing</span>
                            <div class="text-muted small">Build containers if images don't exist</div>
                          </label>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="container-stop-after" name="container_stop_after">
                          <label class="form-check-label" for="container-stop-after">
                            <span class="fw-medium">Stop after analysis</span>
                            <div class="text-muted small">Stop containers when analysis completes</div>
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="alert alert-info py-2 mt-3 mb-0 small">
                      <i class="fas fa-info-circle me-2"></i>
                      <strong>Note:</strong> Container management adds ~30-120 seconds for startup (longer for builds). 
                      Static analysis can proceed without running containers.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Live Estimate -->
            <div id="live-estimate" class="border-top bg-light-subtle p-3">
              <div class="d-flex align-items-center">
                <i class="fas fa-calculator me-3 text-primary"></i>
                <div>
                  <div class="fw-bold">Estimated Analysis</div>
                  <div class="text-muted small">
                    Time: <span id="estimate-time" class="fw-medium">-</span> •
                    Cost: <span id="estimate-cost" class="fw-medium">-</span>
                  </div>
                </div>
              </div>
            </div>

            <div id="selected-tools-summary" class="border-top bg-light-subtle p-3 d-none">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="small text-muted fw-medium">Selected Tools</span>
                <span class="badge bg-secondary-lt" id="selected-tools-count">0</span>
              </div>
              <div class="small" id="selected-tools-list"></div>
            </div>

            <div id="step3-error" class="alert alert-danger d-none mt-3">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>Please select at least one analysis tool to continue.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Review & Launch -->
      <div class="col-12 wizard-panel" data-panel="4">
        <div class="card card-table-compact">
          <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 4</span>
              <div>
                <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                  <i class="fas fa-check-circle text-primary"></i>
                  <span>Review &amp; Launch</span>
                </h3>
                <div class="text-muted small">Review your configuration before launching</div>
              </div>
            </div>
          </div>
          <div class="card-body border-top p-0">
            <div id="analysis-summary" class="p-3">
              <div class="row g-3">
                <div class="col-md-8">
                  <div class="card card-sm">
                    <div class="card-header py-2">
                      <h6 class="card-title mb-0">Analysis Summary</h6>
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-vcenter table-striped table-sm mb-0">
                          <tbody>
                            <tr>
                              <th scope="row" class="w-25 text-muted fw-medium">Model</th>
                              <td id="summary-model">-</td>
                            </tr>
                            <tr>
                              <th scope="row" class="text-muted fw-medium">Application</th>
                              <td id="summary-app">-</td>
                            </tr>
                            <tr>
                              <th scope="row" class="text-muted fw-medium">Analysis Type</th>
                              <td id="summary-type">-</td>
                            </tr>
                            <tr>
                              <th scope="row" class="text-muted fw-medium">Priority</th>
                              <td id="summary-priority">-</td>
                            </tr>
                            <tr>
                              <th scope="row" class="text-muted fw-medium">Estimated Time</th>
                              <td id="summary-time">-</td>
                            </tr>
                            <tr>
                              <th scope="row" class="text-muted fw-medium">Estimated Cost</th>
                              <td id="summary-cost">-</td>
                            </tr>
                            <tr id="summary-container-row" class="d-none">
                              <th scope="row" class="text-muted fw-medium">
                                <i class="fab fa-docker text-primary me-1"></i>Container Management
                              </th>
                              <td id="summary-containers">-</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card card-sm bg-success-lt text-center">
                    <div class="card-body py-3">
                      <div class="analysis-status-icon mb-3">
                        <i class="fas fa-rocket fa-3x text-success"></i>
                      </div>
                      <h6 class="card-title text-success mb-2">Ready to Launch</h6>
                      <p class="card-text small text-muted mb-0">
                        Your analysis will be queued and executed automatically. You'll receive notifications based on your preferences.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xxl-4 col-xl-5 col-lg-5">
      <div class="analysis-sidebar right-sticky-sidebar sticky-top">
        <div class="card card-sm mb-3">
          <div class="card-header py-2">
            <h6 class="card-title mb-0">
              <i class="fa-solid fa-route me-2 text-primary"></i>Progress
            </h6>
          </div>
          <div class="progress progress-sm card-progress">
            <div class="progress-bar bg-primary" role="progressbar" id="wizard-progress-bar" aria-label="Analysis progress" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="card-body py-2">
            <div class="wizard-progress">
              <div class="steps steps-counter steps-xs">
                <div class="step-item active" data-step="1" _="on click call goToStep(1)" role="button" tabindex="0">
                  <div class="step-icon">
                    <i class="fa-solid fa-brain"></i>
                  </div>
                  <div class="step-title">Model</div>
                </div>
                <div class="step-item" data-step="2" _="on click call goToStep(2)" role="button" tabindex="0">
                  <div class="step-icon">
                    <i class="fa-solid fa-rocket"></i>
                  </div>
                  <div class="step-title">App</div>
                </div>
                <div class="step-item" data-step="3" _="on click call goToStep(3)" role="button" tabindex="0">
                  <div class="step-icon">
                    <i class="fa-solid fa-cogs"></i>
                  </div>
                  <div class="step-title">Config</div>
                </div>
                <div class="step-item" data-step="4" _="on click call goToStep(4)" role="button" tabindex="0">
                  <div class="step-icon">
                    <i class="fa-solid fa-check"></i>
                  </div>
                  <div class="step-title">Review</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wizard Navigation -->
        <div class="card card-sm mb-3" id="wizard-nav-card">
          <div class="card-header py-2">
            <h6 class="card-title mb-0">
              <i class="fa-solid fa-gamepad me-2 text-primary"></i>Navigation
            </h6>
          </div>
          <div class="card-body py-2">
            <div class="d-flex flex-column gap-2">
              <div class="d-flex justify-content-between align-items-center small text-muted">
                <span>Step <span id="current-step" class="fw-bold text-primary">1</span> of <span class="fw-bold">4</span></span>
              </div>
              <div class="d-flex justify-content-between align-items-center gap-2">
                <button type="button" class="btn btn-ghost-secondary btn-sm" id="prev-btn" _="on click call previousStep()" disabled>
                  <i class="fa-solid fa-chevron-left me-1"></i>Previous
                </button>
                <div class="d-flex gap-2 flex-grow-1">
                  <button type="button" class="btn btn-primary btn-sm flex-grow-1" id="next-btn" _="on click call nextStep()" disabled>
                    Complete this step to continue
                  </button>
                  <button type="submit" class="btn btn-success btn-sm flex-grow-1 d-none" id="launch-btn">
                    <i class="fa-solid fa-rocket me-1"></i>Launch Analysis
                  </button>
                  <button type="button" class="btn btn-success btn-sm flex-grow-1 d-none" id="launch-btn-loading" disabled>
                    <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>Launching...
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-sm mb-3">
          <div class="card-header py-2">
            <h6 class="card-title mb-0">
              <i class="fa-solid fa-list-check me-2 text-primary"></i>Selections
            </h6>
          </div>
          <div class="card-body p-2">
            <!-- Models Section -->
            <div class="mb-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="small text-muted fw-medium">Models</span>
                <div class="d-flex align-items-center gap-2">
                  <button type="button" class="btn btn-link p-0 small text-danger d-none" id="clear-models-btn" aria-label="Clear all models">clear</button>
                  <span class="badge bg-secondary-lt" id="sidebar-model-count">0</span>
                </div>
              </div>
              <!-- Model Selection Mode Toggle - Inline -->
              <div class="btn-group btn-group-sm w-100 mb-2" role="group" aria-label="Model selection mode">
                <input type="radio" class="btn-check" name="model-mode" id="model-mode-single" checked onchange="if(this.checked && window.setModelSelectionMode) window.setModelSelectionMode('single')">
                <label class="btn btn-outline-secondary" for="model-mode-single">
                  <i class="fa-solid fa-user me-1"></i>Single
                </label>
                <input type="radio" class="btn-check" name="model-mode" id="model-mode-batch" onchange="if(this.checked && window.setModelSelectionMode) window.setModelSelectionMode('batch')">
                <label class="btn btn-outline-secondary" for="model-mode-batch">
                  <i class="fa-solid fa-users me-1"></i>Batch
                </label>
              </div>
              <ul class="list-unstyled mb-0 small" id="sidebar-model-list"></ul>
            </div>
            <!-- Apps Section -->
            <div class="border-top pt-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="small text-muted fw-medium">Applications</span>
                <div class="d-flex align-items-center gap-2">
                  <button type="button" class="btn btn-link p-0 small text-danger d-none" id="clear-apps-btn" aria-label="Clear all apps">clear</button>
                  <span class="badge bg-secondary-lt" id="sidebar-app-count">0</span>
                </div>
              </div>
              <!-- App Selection Mode Toggle - Inline -->
              <div class="btn-group btn-group-sm w-100 mb-2" role="group" aria-label="App selection mode">
                <input type="radio" class="btn-check" name="app-mode" id="app-mode-single" checked onchange="if(this.checked && window.setAppSelectionMode) window.setAppSelectionMode('single')">
                <label class="btn btn-outline-secondary" for="app-mode-single">
                  <i class="fa-solid fa-window-maximize me-1"></i>Single
                </label>
                <input type="radio" class="btn-check" name="app-mode" id="app-mode-batch" onchange="if(this.checked && window.setAppSelectionMode) window.setAppSelectionMode('batch')">
                <label class="btn btn-outline-secondary" for="app-mode-batch">
                  <i class="fa-solid fa-layer-group me-1"></i>Batch
                </label>
              </div>
              <ul class="list-unstyled mb-0 small" id="sidebar-app-list"></ul>
            </div>
          </div>
        </div>

        <!-- Tool Configuration Sidebar -->
        <div class="card card-sm" id="guide-card">
          <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#guide-collapse" role="button" aria-expanded="false" aria-controls="guide-collapse">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2 text-primary"></i>Analysis Guide
              </h6>
              <span class="collapse-indicator text-muted small" id="guide-collapse-indicator">Show</span>
            </div>
          </div>
          <div id="guide-collapse" class="collapse">
            <div class="card-body py-2">
              <div id="step-help" class="step-help">
                <div class="help-content active" data-help="1">
                  <h6 class="mb-2">Choosing the Right Model</h6>
                  <ul class="small mb-3">
                    <li><strong>Coding Focus:</strong> Choose models optimized for code generation</li>
                    <li><strong>Provider Reliability:</strong> Consider uptime and support</li>
                    <li><strong>Cost vs Quality:</strong> Balance analysis depth with budget</li>
                    <li><strong>Capabilities:</strong> Match model strengths to your needs</li>
                  </ul>
                  <div class="alert alert-info alert-sm">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>Tip:</strong> Models with better coding capabilities typically generate more analyzable applications.
                  </div>
                </div>

                <div class="help-content" data-help="2">
                  <h6 class="mb-2">Application Selection</h6>
                  <ul class="small mb-3">
                    <li><strong>Status:</strong> Only active applications can be analyzed</li>
                    <li><strong>Complexity:</strong> More complex apps provide richer analysis</li>
                    <li><strong>Age:</strong> Newer applications may have more recent patterns</li>
                    <li><strong>Size:</strong> Larger applications take longer to analyze</li>
                  </ul>
                  <div class="alert alert-warning alert-sm">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>Note:</strong> Applications must be running for dynamic analysis.
                  </div>
                </div>

                <div class="help-content" data-help="3">
                  <h6 class="mb-2">Analysis Configuration</h6>
                  <ul class="small mb-3">
                    <li><strong>Static Analysis:</strong> Bandit, Semgrep, ESLint, Pylint - code linting and security</li>
                    <li><strong>Dynamic Analysis:</strong> OWASP ZAP, nmap - runtime security scanning</li>
                    <li><strong>Performance:</strong> Locust, aiohttp - load testing and benchmarks</li>
                    <li><strong>AI Analysis:</strong> LLM-powered requirements and quality checks</li>
                  </ul>
                  <div class="alert alert-warning alert-sm mb-2">
                    <i class="fas fa-brain me-1"></i>
                    <strong>AI Analysis Tools:</strong>
                    <ul class="mb-0 mt-1 ps-3 small">
                      <li><strong>Requirements Scanner:</strong> Checks backend, frontend, and admin requirements compliance</li>
                      <li><strong>Code Quality Analyzer:</strong> Evaluates error handling, types, and anti-patterns</li>
                    </ul>
                  </div>
                  <div class="alert alert-success alert-sm">
                    <i class="fas fa-check me-1"></i>
                    <strong>Tip:</strong> Use "Select All" for comprehensive analysis or pick specific tools.
                  </div>
                </div>

                <div class="help-content" data-help="4">
                  <h6 class="mb-2">Before You Launch</h6>
                  <ul class="small mb-3">
                    <li><strong>Double-check:</strong> Verify model and app selection</li>
                    <li><strong>Resources:</strong> Ensure sufficient system resources</li>
                    <li><strong>Timing:</strong> Consider system load and peak hours</li>
                    <li><strong>Notifications:</strong> Set up appropriate alerts</li>
                  </ul>
                  <div class="alert alert-primary alert-sm">
                    <i class="fas fa-clock me-1"></i>
                    <strong>Scheduling:</strong> Analysis will start immediately upon launch.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
{# Tool Selection Confirmation Modal - Tabler Standard #}
<div class="modal modal-blur fade" id="confirmation-modal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">
          <i class="fas fa-check-circle text-primary me-2"></i>Confirm Analysis Configuration
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmation-modal-body">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="proceedWithFormSubmission()" data-bs-dismiss="modal">
          <i class="fas fa-play me-1"></i>Start Analysis
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  
  <script>
// Analysis Wizard JavaScript - HTMX-safe version
(function() {
'use strict';

// HTMX safety guard - prevent duplicate initialization and variable re-declaration
if (window._analysisWizardLoaded) {
  if (document.getElementById('wizard-progress-bar')) {
    window.AnalysisWizard.init();
  }
  return;
}
window._analysisWizardLoaded = true;

// Module-scoped state variables
var currentStep = 1;
var selectedModel = null;
var selectedApp = null;
var selectedTools = []; // Array of tool names for analysis
// Batch selection support
var modelSelectionMode = 'single'; // 'single' | 'batch'
var selectedModels = []; // array of {slug,name}
var selectedApps = []; // array of {number, info, modelSlug}
var appSelectionMode = 'single'; // 'single' | 'batch'
// Cache of modelSlug -> array of app objects {number, name, modelSlug}
var modelAppsCache = {};
// Tool registry cache
var allTools = [];
var toolsLoadPromise = null;

// Wizard navigation functions
function nextStep() {
    if (validateCurrentStep() && currentStep < 4) {
        // Mark current step as completed
        var currentStepEl = document.querySelector('.step-item[data-step="'+currentStep+'"]');
        if (currentStepEl) {
            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('completed');
        }
        
    currentStep++;
    updateWizardStep();
    } else if (!validateCurrentStep()) {
        showValidationFeedback(currentStep, false, getValidationMessage(currentStep));
    }
}

function previousStep() {
    if (currentStep > 1) {
        // Mark current step as not active
        var currentStepEl = document.querySelector('.step-item[data-step="'+currentStep+'"]');
        if (currentStepEl) {
            currentStepEl.classList.remove('active');
        }
        
        currentStep--;
        
        // Mark previous step as active again (remove completed status)
        var prevStepEl = document.querySelector('.step-item[data-step="'+currentStep+'"]');
        if (prevStepEl) {
            prevStepEl.classList.remove('completed');
            prevStepEl.classList.add('active');
        }
        
        updateWizardStep();
        hideValidationFeedback();
    }
}

function goToStep(stepNumber) {
    if (stepNumber >= 1 && stepNumber <= 4) {
        // Validate all previous steps
        var canProceed = true;
        for (var i = 1; i < stepNumber; i++) {
            if (!isStepValid(i)) {
                canProceed = false;
                break;
            }
        }
        
        if (canProceed || stepNumber <= currentStep) {
            // Update step classes for new Tabler.io structure
            document.querySelectorAll('.step-item').forEach(function(step, index) {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            currentStep = stepNumber;
            updateWizardStep();
            hideValidationFeedback();
        }
    }
}

function updateWizardStep() {
    // Update progress bar with smooth animation
    var progressPercent = (currentStep / 4) * 100;
    var progressBar = document.getElementById('wizard-progress-bar');
    if(progressBar) progressBar.style.width = progressPercent + '%';
    
    // Hide all panels first
    document.querySelectorAll('.wizard-panel').forEach(function(panel) {
        panel.classList.remove('active');
    });
    
  // Show current panel (no fade complexity to avoid timing issues)
  const currentPanel = document.querySelector(`[data-panel="${currentStep}"]`);
  if (currentPanel) {
    currentPanel.classList.add('active');
  }
    
    // Update help content
    document.querySelectorAll('.help-content').forEach(help => help.classList.remove('active'));
    const currentHelp = document.querySelector(`[data-help="${currentStep}"]`);
    if (currentHelp) {
        currentHelp.classList.add('active');
    }
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Update step counter
    document.getElementById('current-step').textContent = currentStep;
    
    // Special handling for final step
    if (currentStep === 4) {
        updateAnalysisSummary();

        // Collapsible guide indicator update
        const guideCollapse = document.getElementById('guide-collapse');
        const guideIndicator = document.getElementById('guide-collapse-indicator');
        if (guideCollapse && guideIndicator) {
          guideCollapse.addEventListener('shown.bs.collapse', () => { guideIndicator.textContent = 'Hide'; });
          guideCollapse.addEventListener('hidden.bs.collapse', () => { guideIndicator.textContent = 'Show'; });
        }
    }

  // If entering Step 2, refresh batch aggregate if needed
  if (currentStep === 2) {
    refreshBatchApplicationsAggregate();
  }
}

function updateNavigationButtons() {
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const launchBtn = document.getElementById('launch-btn');
  if (!prevBtn || !nextBtn || !launchBtn) return;

  const show = (el) => { if (el) el.classList.remove('d-none'); };
  const hide = (el) => { if (el) el.classList.add('d-none'); };

  // Previous button availability
  prevBtn.disabled = currentStep === 1;

  if (currentStep === 4) {
    hide(nextBtn);
    show(launchBtn);
  } else {
    show(nextBtn);
    hide(launchBtn);
    nextBtn.disabled = !canProceedFromStep(currentStep);
    if (canProceedFromStep(currentStep)) {
      nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ms-1"></i>';
      nextBtn.classList.remove('btn-outline-primary');
      nextBtn.classList.add('btn-primary');
    } else {
      nextBtn.innerHTML = 'Complete this step to continue';
      nextBtn.classList.remove('btn-primary');
      nextBtn.classList.add('btn-outline-primary');
    }
  }
}

// Selection mode handling
function setModelSelectionMode(mode) {
  if (mode !== 'single' && mode !== 'batch') return;
  modelSelectionMode = mode;
  const singleBtn = document.getElementById('model-mode-single');
  const batchBtn = document.getElementById('model-mode-batch');
  if (singleBtn && batchBtn) {
    // For Bootstrap btn-check, set the checked property
    singleBtn.checked = (mode === 'single');
    batchBtn.checked = (mode === 'batch');
  }
  // Reset selections when switching modes to avoid ambiguity
  if (mode === 'single') {
    if (selectedModels.length > 0) {
      selectedModel = selectedModels[0];
    }
    selectedModels = selectedModel ? [selectedModel] : [];
  } else {
    if (selectedModel) {
      // Move current single selection into batch list if not present
      if (!selectedModels.find(m => m.slug === selectedModel.slug)) {
        selectedModels.push(selectedModel);
      }
    }
  }
  refreshModelSelectionsUI();
  updateNavigationButtons();
}

// Application selection mode handling
function setAppSelectionMode(mode) {
  console.log('[setAppSelectionMode] Called with mode:', mode, 'Current mode:', appSelectionMode);
  if (mode !== 'single' && mode !== 'batch') return;
  appSelectionMode = mode;
  console.log('[setAppSelectionMode] Mode set to:', appSelectionMode);
  const singleBtn = document.getElementById('app-mode-single');
  const batchBtn = document.getElementById('app-mode-batch');
  if (singleBtn && batchBtn) {
    // For Bootstrap btn-check, set the checked property
    singleBtn.checked = (mode === 'single');
    batchBtn.checked = (mode === 'batch');
  }
  if (mode === 'single') {
    if (selectedApps.length) {
      selectedApp = selectedApps[0];
      selectedApps = [selectedApp];
    } else {
      selectedApp = null;
    }
  } else { // switching to batch
    if (selectedApp) {
      if (!selectedApps.find(a => String(a.number) === String(selectedApp.number) && a.modelSlug === selectedApp.modelSlug)) {
        selectedApps.push(selectedApp);
      }
    }
  }
  refreshAppSelectionsUI();
  updateNavigationButtons();
  if (currentStep === 2) refreshBatchApplicationsAggregate();
}

function refreshModelSelectionsUI() {
  // Highlight selected models for batch mode
  // Support legacy card layout and new table row layout
  document.querySelectorAll('.model-card, tr.model-row').forEach(card => {
    const slug = card.getAttribute('data-model-slug');
    const isSelected = modelSelectionMode === 'single'
      ? (selectedModel && selectedModel.slug === slug)
      : selectedModels.some(m => m.slug === slug);
    card.classList.toggle('selected', !!isSelected);
    if (card.classList.contains('model-card')) {
      card.classList.toggle('border-primary', !!isSelected);
    }
  });
  // Sidebar list & indicators
  const list = document.getElementById('sidebar-model-list');
  const countEl = document.getElementById('sidebar-model-count');
  const clearBtn = document.getElementById('clear-models-btn');
  const modeIndicator = document.getElementById('model-mode-indicator');
  if (modeIndicator) modeIndicator.textContent = modelSelectionMode;
  if (list && countEl) {
    list.innerHTML = selectedModels.map(m => `<li class='d-flex align-items-center justify-content-between'>
        <span class='text-truncate me-2'>${escapeHtml(m.name)}</span>
        <button type='button' class='btn btn-link p-0 text-danger small' data-remove-model='${m.slug}' aria-label='Remove model'>&times;</button>
      </li>`).join('');
    countEl.textContent = selectedModels.length;
  }
  if (clearBtn) clearBtn.classList.toggle('d-none', selectedModels.length === 0);

  // Update batch aggregate section if on step 2
  if (currentStep === 2) {
    refreshBatchApplicationsAggregate();
  }
}

function validateCurrentStep() {
    return isStepValid(currentStep);
}

function isStepValid(step) {
    switch (step) {
        case 1:
            return modelSelectionMode === 'single' ? !!selectedModel : selectedModels.length > 0;
        case 2:
            return appSelectionMode === 'single' ? !!selectedApp : selectedApps.length > 0;
        case 3:
            return selectedTools.length > 0;
        case 4:
            return true; // Review step is always valid
        default:
            return false;
    }
}

function getValidationMessage(step) {
    switch (step) {
        case 1:
            return 'Please select an AI model to continue.';
        case 2:
            return 'Please select an application to analyze.';
        case 3:
            return 'Please select at least one analysis tool to proceed.';
        default:
            return 'Please complete this step to continue.';
    }
}

function showValidationFeedback(step, isSuccess, message) {
    if (isSuccess) {
        hideValidationFeedback();
        return;
    }

    hideValidationFeedback();

    const panel = document.querySelector(`[data-panel="${step}"]`);
    if (!panel) return;

  const alertDiv = document.createElement('div');
  alertDiv.setAttribute('data-feedback-alert', 'true');
    alertDiv.className = 'alert alert-danger alert-dismissible mt-3';
    alertDiv.innerHTML = `
    <div class="d-flex align-items-start">
      <i class="fas fa-triangle-exclamation text-danger me-2 mt-1"></i>
      <div class="text-secondary">${message}</div>
    </div>
    <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
  `;

    const cardBody = panel.querySelector('.card-body');
    if (cardBody) {
        cardBody.appendChild(alertDiv);
    }
}

function hideValidationFeedback() {
  document.querySelectorAll('[data-feedback-alert="true"]').forEach(el => el.remove());
}

function canProceedFromStep(step) {
    return isStepValid(step);
}

// Model selection (single or batch)
function selectModel(slug, name) {
  if (modelSelectionMode === 'single') {
    selectedModel = { slug, name };
    selectedModels = [selectedModel];
    try { sessionStorage.setItem('analysis_selected_model', JSON.stringify(selectedModel)); } catch (e) {}
    try { sessionStorage.removeItem('analysis_selected_model_batch'); } catch (e) {}
    const input = document.getElementById('input-model-slug'); if (input) input.value = slug;
    try { loadApplicationsForModel(selectedModel); } catch (error) { console.error('Error calling loadApplicationsForModel:', error); }
  } else {
    const idx = selectedModels.findIndex(m => m.slug === slug);
    if (idx >= 0) {
      selectedModels.splice(idx, 1);
    } else {
      selectedModels.push({ slug, name });
    }
    selectedModel = selectedModels[0] || null;
    try { sessionStorage.setItem('analysis_selected_model_batch', JSON.stringify(selectedModels)); } catch(e) {}
    try { sessionStorage.removeItem('analysis_selected_model'); } catch (e) {}
    // For batch mode always refresh aggregate (apps fetched lazily in aggregation builder)
    if (currentStep === 2) refreshBatchApplicationsAggregate();
  }
  refreshModelSelectionsUI();
  updateNavigationButtons();
}

function loadApplicationsForModel(model) {
    const listContainer = document.getElementById('application-selection-list');
    if (!listContainer) {
        console.error('Application selection list container not found');
        return;
    }
    
    // Show loading state
    listContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading applications...</span>
            </div>
            <p class="mt-2 text-muted">Loading applications for ${escapeHtml(model.name)}...</p>
        </div>
    `;
    
  // Use HTMX to load applications (fallback to fetch if needed)
  if (window.htmx && htmx.ajax) {
    htmx.ajax('GET', `/analysis/api/models/${encodeURIComponent(model.slug)}/applications`, {
      target: '#application-selection-list',
      swap: 'innerHTML'
    }).then(() => {
      cacheAppsFromContainer(model.slug, listContainer);
      refreshAppSelectionsUI(); // Update visual state for any previously selected apps
      if (currentStep === 2) refreshBatchApplicationsAggregate();
    }).catch((error) => {
      console.error('Error loading applications via htmx:', error);
      listContainer.innerHTML = `
        <div class="alert alert-danger">
          <h4 class="alert-title">Error Loading Applications</h4>
          <div class="text-secondary">Failed to load applications for this model. Please try again or select a different model.</div>
        </div>
      `;
    });
  } else {
    console.warn('HTMX not available, falling back to fetch');
    fetch(`/analysis/api/models/${encodeURIComponent(model.slug)}/applications`)
      .then(r => r.text())
      .then(html => {
        listContainer.innerHTML = html;
        cacheAppsFromContainer(model.slug, listContainer);
        refreshAppSelectionsUI(); // Update visual state for any previously selected apps
        if (currentStep === 2) refreshBatchApplicationsAggregate();
      })
      .catch(error => {
        console.error('Error loading applications via fetch:', error);
        listContainer.innerHTML = `
          <div class="alert alert-danger">
            <h4 class="alert-title">Error Loading Applications</h4>
            <div class="text-secondary">Failed to load applications for this model. Please try again later.</div>
          </div>
        `;
      });
  }
}

function cacheAppsFromContainer(modelSlug, container) {
  try {
    const cards = Array.from(container.querySelectorAll('.app-card[data-app]'));
    if (!cards.length) return;
    modelAppsCache[modelSlug] = cards.map(card => ({
      number: card.getAttribute('data-app'),
      name: (card.querySelector('.app-name')?.textContent || `App #${card.getAttribute('data-app')}`).trim(),
      modelSlug
    }));
  } catch (e) { console.warn('Failed to cache apps for', modelSlug, e); }
}

async function ensureAppsForModel(model) {
  if (modelAppsCache[model.slug]) return;
  try {
    const resp = await fetch(`/analysis/api/models/${encodeURIComponent(model.slug)}/applications?partial=true`);
    const html = await resp.text();
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    cacheAppsFromContainer(model.slug, tmp);
  } catch (e) {
    console.error('Failed to fetch apps for model', model.slug, e);
  }
}

async function buildAggregatedAppsList() {
  const listContainer = document.getElementById('batch-all-apps-list');
  const emptyMsg = document.getElementById('batch-apps-empty');
  const totalAppsEl = document.getElementById('batch-total-apps');
  const totalAppsLabel = document.getElementById('batch-total-apps-label');
  if (!listContainer) return;

  await Promise.all(selectedModels.map(m => ensureAppsForModel(m)));
  const allApps = selectedModels.flatMap(m => (modelAppsCache[m.slug] || []).map(a => ({...a})));
  const seen = new Set();
  const deduped = [];
  for (const a of allApps) {
    const key = a.modelSlug + '::' + a.number;
    if (!seen.has(key)) { seen.add(key); deduped.push(a); }
  }

  if (totalAppsEl && totalAppsLabel) {
    totalAppsEl.textContent = deduped.length;
    totalAppsLabel.style.display = deduped.length ? 'inline' : 'none';
  }

  const searchTerm = (document.getElementById('batch-app-search')?.value || '').toLowerCase();
  const filtered = searchTerm ? deduped.filter(a => a.name.toLowerCase().includes(searchTerm) || String(a.number).includes(searchTerm)) : deduped;

  if (!filtered.length) {
    listContainer.innerHTML = '';
    if (emptyMsg) emptyMsg.style.display = 'block';
  } else {
    if (emptyMsg) emptyMsg.style.display = 'none';
    listContainer.innerHTML = filtered.map(a => {
      const isSelected = selectedApps.some(sel => String(sel.number) === String(a.number) && sel.modelSlug === a.modelSlug);
      return `<div class='col-6 col-md-4 col-lg-3'>
        <div class='app-card border rounded p-2 h-100 small ${isSelected?'selected border-success':''}' data-app='${a.number}' data-model-slug='${a.modelSlug}'>
          <div class='fw-bold tiny text-truncate app-name'>#${a.number}</div>
          <div class='text-muted tiny'>${a.modelSlug}</div>
        </div>
      </div>`;
    }).join('');
  }
  updatePerModelAppCounts();
}

function updatePerModelAppCounts() {
  const grid = document.getElementById('batch-selected-models-grid');
  if (!grid) return;
  grid.querySelectorAll('[data-batch-model-slug]').forEach(el => {
    const slug = el.getAttribute('data-batch-model-slug');
    const count = (modelAppsCache[slug] || []).length;
    const loading = el.querySelector('.batch-model-loading');
    const countEl = el.querySelector('.batch-model-app-count');
    if (loading) loading.style.display = 'none';
    if (countEl) {
      countEl.textContent = count + ' app' + (count===1?'':'s');
      countEl.classList.remove('d-none');
    }
  });
}

// Application selection (single or batch)
function selectApp(appNumber, appInfo, modelSlug) {
  const slug = modelSlug || (selectedModel && selectedModel.slug) || 'unknown';
  console.log('[selectApp] Called with appNumber:', appNumber, 'modelSlug:', slug, 'appSelectionMode:', appSelectionMode);

  if (appSelectionMode === 'single') {
    console.log('[selectApp] Single mode - setting selectedApp');
    selectedApp = { number: appNumber, info: appInfo, modelSlug: slug };
    selectedApps = [selectedApp];
    try { sessionStorage.setItem('analysis_selected_app', JSON.stringify(selectedApp)); } catch (e) {}
    try { sessionStorage.removeItem('analysis_selected_app_batch'); } catch (e) {}
    const input = document.getElementById('input-app-number');
    if (input) input.value = String(appNumber);
  } else {
    console.log('[selectApp] Batch mode - toggling app in selectedApps. Current count:', selectedApps.length);
    const idx = selectedApps.findIndex(a => String(a.number) === String(appNumber) && a.modelSlug === slug);
    if (idx >= 0) {
      console.log('[selectApp] Removing app at index:', idx);
      selectedApps.splice(idx, 1);
    } else {
      console.log('[selectApp] Adding app to batch');
      selectedApps.push({ number: appNumber, info: appInfo, modelSlug: slug });
    }
    selectedApp = selectedApps[0] || null;
    try { sessionStorage.setItem('analysis_selected_app_batch', JSON.stringify(selectedApps)); } catch (e) {}
  }
  console.log('[selectApp] After update - selectedApps:', selectedApps.length, 'items');

  refreshAppSelectionsUI();
  updateNavigationButtons();
}

function refreshAppSelectionsUI() {
  document.querySelectorAll('.app-card, tr.app-row').forEach(card => {
    const number = card.getAttribute('data-app');
    const modelSlug = card.getAttribute('data-model-slug') || (selectedModel && selectedModel.slug) || 'unknown';
    const isSelected = appSelectionMode === 'single'
      ? (selectedApp && String(selectedApp.number) === String(number) && selectedApp.modelSlug === modelSlug)
      : selectedApps.some(a => String(a.number) === String(number) && a.modelSlug === modelSlug);
    card.classList.toggle('selected', !!isSelected);
    // For cards use border, for table rows use bg class
    if (card.tagName === 'TR') {
      card.classList.toggle('table-success', !!isSelected);
    } else {
      card.classList.toggle('border-success', !!isSelected);
    }
    // Update the Select button text/style if present
    const selectBtn = card.querySelector('.select-app-btn');
    if (selectBtn) {
      if (isSelected) {
        selectBtn.classList.remove('btn-ghost-primary');
        selectBtn.classList.add('btn-success');
        selectBtn.innerHTML = '<i class="fa-solid fa-check-double me-1"></i>Selected';
      } else {
        selectBtn.classList.remove('btn-success');
        selectBtn.classList.add('btn-ghost-primary');
        selectBtn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Select';
      }
    }
  });
  const list = document.getElementById('sidebar-app-list');
  const countEl = document.getElementById('sidebar-app-count');
  const clearBtn = document.getElementById('clear-apps-btn');
  const modeIndicator = document.getElementById('app-mode-indicator');
  if (modeIndicator) modeIndicator.textContent = appSelectionMode;
  if (list && countEl) {
    list.innerHTML = selectedApps.map(a => `<li class='d-flex align-items-center justify-content-between'>
        <span class='me-2'>#${a.number}<span class='text-muted ms-1'>${a.modelSlug}</span></span>
        <button type='button' class='btn btn-link p-0 text-danger small' data-remove-app='${a.number}' data-remove-app-model='${a.modelSlug}' aria-label='Remove application'>&times;</button>
      </li>`).join('');
    countEl.textContent = selectedApps.length;
  }
  if (clearBtn) clearBtn.classList.toggle('d-none', selectedApps.length === 0);

  // Update batch aggregate section if on step 2
  if (currentStep === 2) {
    refreshBatchApplicationsAggregate();
  }
}

// Batch aggregate building (models + apps)
function refreshBatchApplicationsAggregate() {
  const aggregateWrapper = document.getElementById('batch-app-aggregate');
  const singleAppList = document.getElementById('application-selection-list');
  if (!aggregateWrapper) return;
  
  // Show batch UI when app mode is batch and we have at least one model
  const useBatchAggregate = appSelectionMode === 'batch' && selectedModels.length > 0;
  
  // Toggle visibility: show batch panel OR single app list, not both
  aggregateWrapper.style.display = useBatchAggregate ? 'block' : 'none';
  if (singleAppList) {
    singleAppList.style.display = useBatchAggregate ? 'none' : 'block';
  }
  
  if (!useBatchAggregate) return;

  const grid = document.getElementById('batch-selected-models-grid');
  const modelCountEl = document.getElementById('batch-selected-model-count');
  if (grid && modelCountEl) {
    modelCountEl.textContent = selectedModels.length;
    grid.innerHTML = selectedModels.map(m => `<div class='col-6 col-md-4'>
      <div class='p-2 border rounded bg-body h-100 d-flex flex-column justify-content-between' data-batch-model-slug='${m.slug}'>
        <div class='fw-semibold small text-truncate' title='${escapeHtml(m.name)}'>${escapeHtml(m.name)}</div>
        <div class='text-muted tiny lh-1'>
          <span class='batch-model-loading'>
            <span class='spinner-border spinner-border-sm text-secondary' role='status' aria-hidden='true'></span> loading
          </span>
          <span class='batch-model-app-count d-none'></span>
        </div>
      </div>
    </div>`).join('');
  }
  buildAggregatedAppsList();
}

// (Removed older placeholder buildAggregatedAppsList; unified async version used above)

async function loadAnalysisTools(force = false) {
  if (toolsLoadPromise && !force) {
    return toolsLoadPromise;
  }

  if (toolsLoadPromise && force) {
    try {
      await toolsLoadPromise;
    } catch (previousError) {
      console.warn('Previous tool load failed, continuing with forced refresh.', previousError);
    }
  }

  toolsLoadPromise = (async () => {
    console.log('Loading container-based analysis tools...');

    try {
      const toolsResponse = await fetch('/api/container-tools/all');
      console.log('Tools response status:', toolsResponse.status);
      if (!toolsResponse.ok) {
        throw new Error(`Failed to load tools: ${toolsResponse.status} ${toolsResponse.statusText}`);
      }

      const toolsData = await toolsResponse.json();
      console.log('Tools response data:', toolsData);
      allTools = toolsData.data || [];
      console.log('Loaded tools:', allTools.length, allTools);

      try {
        const availabilityResponse = await fetch('/api/container-tools/availability');
        if (availabilityResponse.ok) {
          const availabilityData = await availabilityResponse.json();
          const availabilityMap = availabilityData.data || {};

          allTools = allTools.map(tool => ({
            ...tool,
            available: availabilityMap[tool.name] === true,
            availability_source: 'container'
          }));
        } else {
          console.warn('Could not fetch tool availability, status:', availabilityResponse.status);
        }
      } catch (availabilityError) {
        console.warn('Error fetching tool availability:', availabilityError);
      }

      const before = [...selectedTools];
      selectedTools = selectedTools.filter(toolName => allTools.some(t => t.name === toolName));
      if (before.length !== selectedTools.length) {
        const inline = document.getElementById('step3-inline-error');
        if (inline) {
          inline.textContent = 'Some previously selected tools are no longer available and were removed from your selection.';
          inline.classList.remove('d-none');
        }
      } else {
        const inline = document.getElementById('step3-inline-error');
        if (inline) {
          inline.classList.add('d-none');
          inline.textContent = '';
        }
      }

      const toolsByContainer = {
        'static-analyzer': [],
        'dynamic-analyzer': [],
        'performance-tester': [],
        'ai-analyzer': []
      };

      allTools.forEach(tool => {
        const container = tool.container;
        console.log('Processing tool:', tool.name, 'container:', container, 'tags:', tool.tags);

        if (toolsByContainer[container]) {
          toolsByContainer[container].push(tool);
        } else {
          console.warn('Unknown container type:', container, 'for tool:', tool.name);
          toolsByContainer['static-analyzer'].push(tool);
        }
      });

      console.log('Tools by container:', toolsByContainer);

      renderContainerTools('static-analyzer', toolsByContainer['static-analyzer']);
      renderContainerTools('dynamic-analyzer', toolsByContainer['dynamic-analyzer']);
      renderContainerTools('performance-tester', toolsByContainer['performance-tester']);
      renderContainerTools('ai-analyzer', toolsByContainer['ai-analyzer']);

      updateContainerStatus('static', 'running', toolsByContainer['static-analyzer'].length);
      updateContainerStatus('dynamic', 'running', toolsByContainer['dynamic-analyzer'].length);
      updateContainerStatus('performance', 'running', toolsByContainer['performance-tester'].length);
      updateContainerStatus('ai', 'running', toolsByContainer['ai-analyzer'].length);

      console.log('Tool registry loaded:', allTools.length, 'tools');
      syncToolCheckboxesWithSelection();
      updateSelectedToolsSummary();
      updateSidebarToolDisplay();
      updateCustomAnalysisEstimate();
      updateNavigationButtons();
      return allTools;
    } catch (error) {
      console.error('Error loading analysis tools:', error);
      showToolLoadingError('Unable to load analysis tools right now. Please try again shortly.');
      throw error;
    } finally {
      toolsLoadPromise = null;
    }
  })();

  return toolsLoadPromise;
}

function showToolLoadingError(message) {
    ['static-analyzer', 'dynamic-analyzer', 'performance-tester', 'ai-analyzer'].forEach(container => {
        const containerId = container.replace('-analyzer', '').replace('-tester', '');
        const containerElement = document.getElementById(`${containerId}-tools`);
        if (containerElement) {
            containerElement.innerHTML = `<div class="text-danger small"><i class="fas fa-exclamation-triangle me-1"></i>${message}</div>`;
        }
    updateContainerStatus(containerId, 'error', 0);
    });
}

function updateContainerStatus(containerPrefix, status, toolCount) {
    const statusElement = document.getElementById(`${containerPrefix}-container-status`);
    const countElement = document.getElementById(`${containerPrefix}-tool-count`);
    
    if (statusElement) {
    let statusClass = 'badge bg-secondary-lt text-secondary fw-bold';
    let statusText = 'Pending';

    if (status === 'running') {
      statusClass = 'badge bg-success-lt text-success fw-bold';
      statusText = 'Online';
    } else if (status === 'error') {
      statusClass = 'badge bg-danger-lt text-danger fw-bold';
      statusText = 'Error';
    } else if (status === 'stopped') {
      statusClass = 'badge bg-warning-lt text-warning fw-semibold';
      statusText = 'Offline';
    }

    statusElement.className = statusClass;
    statusElement.textContent = statusText;
    statusElement.title = `Container status: ${statusText}`;
    }
    
    if (countElement) {
        countElement.textContent = `${toolCount} tool${toolCount !== 1 ? 's' : ''}`;
    }
}

// Removed renderToolsInCategory - replaced by renderContainerTools

function renderContainerTools(container, tools) {
    const containerId = container.replace('-analyzer', '').replace('-tester', '');
    const containerElement = document.getElementById(`${containerId}-tools`);
    
    if (!containerElement) {
        console.warn(`Container element not found: ${containerId}-tools`);
        return;
    }
    
    if (!tools || tools.length === 0) {
        containerElement.innerHTML = '<div class="p-3 text-center text-muted small">No tools available in this container</div>';
        return;
    }
    
    console.log('Rendering', tools.length, 'tools for container:', container);
    
    // Enhanced descriptions for AI analyzer tools
    const aiToolEnhancements = {
        'requirements-scanner': {
            icon: 'fas fa-clipboard-check',
            iconColor: 'text-success',
            badge: 'LLM-Powered',
            badgeClass: 'bg-warning-lt text-warning',
            features: ['Backend Requirements', 'Frontend Requirements', 'Admin Requirements'],
            note: 'Analyzes code against the template specification requirements'
        },
        'code-quality-analyzer': {
            icon: 'fas fa-code',
            iconColor: 'text-primary',
            badge: 'LLM-Powered',
            badgeClass: 'bg-warning-lt text-warning',
            features: ['Error Handling', 'Type Coverage', 'Anti-Patterns', 'Best Practices'],
            note: 'Evaluates code quality metrics and patterns'
        }
    };
    
    const rowsHtml = tools.map(tool => {
        const toolName = String(tool.name || tool.id || '');
        const displayName = escapeHtml(tool.display_name || toolName);
        // Show status indicator but don't disable tools - containers can be started when needed
        const isContainerOnline = tool.available !== false;
        const statusClass = isContainerOnline ? 'badge bg-success-lt text-success' : 'badge bg-secondary-lt text-secondary';
        const statusLabel = isContainerOnline ? 'Available' : 'Unavailable';
        const description = tool.description ? escapeHtml(tool.description) : '<span class="text-muted">No description provided</span>';
        const languages = Array.isArray(tool.supported_languages) && tool.supported_languages.length > 0
            ? `<div class="small text-secondary mt-1"><i class="fas fa-code me-1"></i>${escapeHtml(tool.supported_languages.join(', '))}</div>`
            : '';
        const docUrl = tool?.config_schema?.documentation_url ? escapeHtml(tool.config_schema.documentation_url) : '';
        const isChecked = selectedTools.includes(toolName);
        // Tools are always selectable - containers will be started when analysis runs
        // Only show visual indicator of current availability status
        const rowClasses = ['align-middle'];
        
        // Check if this is an AI tool with enhanced rendering
        const aiEnhancement = container === 'ai-analyzer' ? aiToolEnhancements[toolName] : null;
        
        let enhancedContent = '';
        if (aiEnhancement) {
            const featuresHtml = aiEnhancement.features.map(f => 
                `<span class="badge bg-light text-muted me-1"><i class="fas fa-check-circle text-success me-1"></i>${f}</span>`
            ).join('');
            enhancedContent = `
                <div class="mt-2">
                    <div class="d-flex flex-wrap gap-1 mb-1">${featuresHtml}</div>
                    <div class="text-muted small fst-italic"><i class="fas fa-info-circle me-1"></i>${aiEnhancement.note}</div>
                </div>
            `;
        }

        return `
          <tr class="${rowClasses.join(' ')}">
            <td class="w-1">
              <input class="form-check-input" type="checkbox" id="tool-${toolName}"
                value="${escapeHtml(toolName)}" ${isChecked ? 'checked' : ''}
                onchange="toggleTool('${escapeHtml(toolName)}', '${displayName}', '${escapeHtml(container)}')">
            </td>
            <td>
              <label class="fw-semibold d-flex flex-column" for="tool-${toolName}">
                <span class="d-flex align-items-center gap-2">
                  ${aiEnhancement ? `<i class="${aiEnhancement.icon} ${aiEnhancement.iconColor}"></i>` : ''}
                  <span>${displayName}</span>
                  <span class="${statusClass}">${statusLabel}</span>
                  ${aiEnhancement ? `<span class="${aiEnhancement.badgeClass} badge">${aiEnhancement.badge}</span>` : ''}
                </span>
                <span class="small text-muted">${description}</span>
              </label>
              ${languages}
              ${enhancedContent}
            </td>
            <td class="text-end">
              <div class="btn-list">
                ${tool.config_schema && tool.config_schema.parameters && tool.config_schema.parameters.length > 0 ?
                  `<button type="button" class="btn btn-ghost-primary btn-icon" 
                      onclick="showToolConfig('${escapeHtml(toolName)}')" title="Configure">
                    <i class="fas fa-sliders-h"></i>
                  </button>` : ''}
                ${docUrl ? 
                  `<a href="${docUrl}" target="_blank" 
                     class="btn btn-ghost-secondary btn-icon" title="Documentation">
                    <i class="fas fa-external-link-alt"></i>
                  </a>` : ''}
              </div>
            </td>
          </tr>
        `;
    }).join('');

    containerElement.innerHTML = `
      <table class="table table-vcenter table-hover table-sm mb-0">
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    `;
}

function showToolConfig(toolName) {
    console.log('Showing configuration for tool:', toolName);
    const tool = allTools.find(t => t.name === toolName);
    if (!tool || !tool.config_schema) {
        console.warn('Tool not found or not configurable:', toolName);
        return;
    }
    
    // Create and show configuration modal (Tabler standard)
    const configModal = document.createElement('div');
    configModal.className = 'modal modal-blur fade';
    configModal.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog me-2"></i>Configure ${tool.display_name}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="tool-config-form-${toolName}">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="mb-0 small text-muted mt-2">Loading configuration options...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveToolConfig('${toolName}')">Save Configuration</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(configModal);
    
    try {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = new bootstrap.Modal(configModal);
            modal.show();
            
            // Remove modal when hidden
            configModal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(configModal);
            });
        } else {
            console.error('Bootstrap Modal not available');
            alert('Configuration menu cannot be opened: Bootstrap is missing.');
            document.body.removeChild(configModal);
            return;
        }
    } catch (e) {
        console.error('Error showing modal:', e);
        alert('Error opening configuration menu.');
        if (configModal.parentNode) document.body.removeChild(configModal);
        return;
    }
    
    // Load configuration form
    loadToolConfigForm(toolName, tool.config_schema);
}

function loadToolConfigForm(toolName, configSchema) {
    const formContainer = document.getElementById(`tool-config-form-${toolName}`);
    if (!formContainer) return;
    
    const parameters = configSchema.parameters || [];
    const examples = configSchema.examples || {};
    
    let formHtml = '';
    
    if (configSchema.documentation_url) {
        formHtml += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <a href="${configSchema.documentation_url}" target="_blank" class="text-decoration-none">
                    View official documentation <i class="fas fa-external-link-alt ms-1"></i>
                </a>
            </div>
        `;
    }
    
    if (Object.keys(examples).length > 0) {
        formHtml += `
            <div class="mb-3">
                <label class="form-label fw-bold">Quick Presets</label>
                <div class="btn-group d-flex" role="group">
                    ${Object.keys(examples).map(name => `
                        <button type="button" class="btn btn-ghost-primary btn-sm" onclick="applyConfigPreset('${toolName}', '${name}')">
                            ${name}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    formHtml += '<div class="row g-3">';
    
  parameters.forEach(param => {
    const fieldId = `config-${toolName}-${param.name}`;
    const labelContent = `${param.name} ${param.required ? '<span class="text-danger">*</span>' : ''}`;
    formHtml += `<div class="col-md-6">`;

    if (param.type === 'boolean') {
      formHtml += `<span class="form-label d-block">${labelContent}</span>`;
      formHtml += `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="${fieldId}" 
               ${param.default ? 'checked' : ''}>
          <label class="form-check-label" for="${fieldId}">
            ${param.description || param.name}
          </label>
        </div>
      `;
    } else if (param.options && param.options.length > 0) {
      formHtml += `<label class="form-label" for="${fieldId}">${labelContent}</label>`;
      formHtml += `
        <select class="form-select" id="${fieldId}">
          ${param.options.map(option => `
            <option value="${option}" ${option === param.default ? 'selected' : ''}>${option}</option>
          `).join('')}
        </select>
      `;
    } else if (param.type === 'array') {
      formHtml += `<label class="form-label" for="${fieldId}">${labelContent}</label>`;
      const defaultValue = Array.isArray(param.default) ? param.default.join(', ') : '';
      formHtml += `
        <input type="text" class="form-control" id="${fieldId}" 
             placeholder="Comma-separated values" value="${defaultValue}">
      `;
    } else {
      formHtml += `<label class="form-label" for="${fieldId}">${labelContent}</label>`;
      const inputType = param.type === 'integer' || param.type === 'float' ? 'number' : 'text';
      formHtml += `
        <input type="${inputType}" class="form-control" id="${fieldId}" 
             value="${param.default || ''}" 
             ${param.min_value !== undefined ? `min="${param.min_value}"` : ''}
             ${param.max_value !== undefined ? `max="${param.max_value}"` : ''}>
      `;
    }

    if (param.description && param.type !== 'boolean') {
      formHtml += `<small class="form-text text-muted">${param.description}</small>`;
    }

    formHtml += `</div>`;
  });
    
    formHtml += '</div>';
    
    formContainer.innerHTML = formHtml;
}

function applyConfigPreset(toolName, presetName) {
    const tool = allTools.find(t => t.name === toolName);
    if (!tool || !tool.config_schema || !tool.config_schema.examples) return;
    
    const preset = tool.config_schema.examples[presetName];
    if (!preset) return;
    
    // Apply preset values to form fields
    Object.keys(preset).forEach(paramName => {
        const element = document.getElementById(`config-${toolName}-${paramName}`);
        if (element) {
            const value = preset[paramName];
            if (element.type === 'checkbox') {
                element.checked = !!value;
            } else if (Array.isArray(value)) {
                element.value = value.join(', ');
            } else {
                element.value = value;
            }
        }
    });
}

function saveToolConfig(toolName) {
    const tool = allTools.find(t => t.name === toolName);
    if (!tool || !tool.config_schema) return;
    
    const config = {};
    const parameters = tool.config_schema.parameters || [];
    
    parameters.forEach(param => {
        const element = document.getElementById(`config-${toolName}-${param.name}`);
        if (element) {
            let value;
            if (element.type === 'checkbox') {
                value = element.checked;
            } else if (param.type === 'array') {
                value = element.value.split(',').map(v => v.trim()).filter(v => v);
            } else if (param.type === 'integer') {
                value = parseInt(element.value) || param.default;
            } else if (param.type === 'float') {
                value = parseFloat(element.value) || param.default;
            } else {
                value = element.value || param.default;
            }
            config[param.name] = value;
        }
    });
    
    // Store configuration for this tool
    if (!window.toolConfigurations) {
        window.toolConfigurations = {};
    }
    window.toolConfigurations[toolName] = config;
    
    console.log('Saved configuration for', toolName, ':', config);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
    if (modal) modal.hide();
    
    // Update tool display to show it's configured
    const toolElement = document.getElementById(`tool-${toolName}`);
    if (toolElement) {
        const label = toolElement.closest('.form-check').querySelector('.form-check-label');
        if (label && !label.querySelector('.badge-warning')) {
            const configBadge = document.createElement('span');
            configBadge.className = 'badge bg-warning-subtle text-warning ms-1';
            configBadge.textContent = 'configured';
            label.querySelector('.d-flex').appendChild(configBadge);
        }
    }
}

function toggleTool(toolName, toolDisplayName, container) {
    const checkbox = document.getElementById(`tool-${toolName}`);
    if (!checkbox) return;
    
    if (checkbox.checked) {
        // Add tool to selection
        if (!selectedTools.includes(toolName)) {
            selectedTools.push(toolName);
        }
    } else {
        // Remove tool from selection
        selectedTools = selectedTools.filter(name => name !== toolName);
    }
    
    // Update UI
  updateSelectedToolsSummary();
  updateCustomAnalysisEstimate();
  updateNavigationButtons();
    
    // Hide inline error if user changes tools
    const inline = document.getElementById('step3-inline-error');
    if (inline) inline.classList.add('d-none');
    
    // Store selection
    try {
        sessionStorage.setItem('analysis_selected_tools', JSON.stringify(selectedTools));
    } catch (e) {
        console.warn('Could not store selected tools in sessionStorage:', e);
    }
}

function clearAllTools() {
    // Uncheck all tool checkboxes
    const allCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="tool-"]');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear selected tools array
    selectedTools = [];
    
    // Update UI
  updateSelectedToolsSummary();
  updateCustomAnalysisEstimate();
  updateNavigationButtons();
    
    // Store empty selection
    try {
        sessionStorage.setItem('analysis_selected_tools', JSON.stringify([]));
    } catch (e) {
        console.warn('Could not store empty selection in sessionStorage:', e);
    }
    
    console.log('Cleared all tool selections');
}

function selectAllTools() {
    // Check all available tool checkboxes
    const allCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="tool-"]:not(:disabled)');
    allCheckboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            // Trigger the change event to update selectedTools array
            const toolName = checkbox.value;
            const tool = allTools.find(t => t.name === toolName);
            if (tool && !selectedTools.includes(toolName)) {
                selectedTools.push(toolName);
            }
        }
    });
    
    // Update UI
  updateSelectedToolsSummary();
  updateCustomAnalysisEstimate();
  updateNavigationButtons();
    
    // Store selection
    try {
        sessionStorage.setItem('analysis_selected_tools', JSON.stringify(selectedTools));
    } catch (e) {
        console.warn('Could not store selected tools in sessionStorage:', e);
    }
    
    console.log('Selected all available tools:', selectedTools);
}

function showToolSelectionConfirmation() {
    // Group tools by container for confirmation display
    const toolsByContainer = {};
    let totalTasks = 0;
    
    selectedTools.forEach(toolName => {
        const tool = allTools.find(t => t.name === toolName);
        if (!tool) return;
        
        const containerName = tool.container || 'unknown';
        if (!toolsByContainer[containerName]) {
            toolsByContainer[containerName] = [];
            totalTasks++;
        }
        toolsByContainer[containerName].push(tool);
    });
    
    // Use browser confirm for simplicity (can be enhanced with modal later)
    const toolNames = selectedTools.map(toolName => {
        const tool = allTools.find(t => t.name === toolName);
        return tool ? tool.display_name || tool.name : `Tool ${toolName}`;
    }).join(', ');
    
    const confirmed = confirm(
        `Confirm Analysis:\n\n` +
        `Selected Tools (${selectedTools.length}): ${toolNames}\n\n` +
        `This will create ${totalTasks} analysis task(s).\n\n` +
        `Continue with analysis?`
    );
    
    if (confirmed) {
        proceedWithFormSubmission();
    }
}

function proceedWithFormSubmission() {
    console.log('proceedWithFormSubmission called');
    const form = document.getElementById('analysis-wizard-form');
    const launchBtn = document.getElementById('launch-btn');
    const loadingBtn = document.getElementById('launch-btn-loading');
    
    if (launchBtn) launchBtn.classList.add('d-none');
    if (loadingBtn) loadingBtn.classList.remove('d-none');
    
  if (form) {
        console.log('Serializing form state and submitting form');
        // Ensure hidden inputs mirror current wizard state before direct submit
        try {
          // Mode is always 'custom' now
          const modeInput = document.getElementById('input-analysis-mode');
          if (modeInput) modeInput.value = 'custom';

          // Tools
          const toolsInputsWrapper = document.getElementById('selected-tools-inputs');
          if (toolsInputsWrapper) {
            toolsInputsWrapper.innerHTML = '';
            if (Array.isArray(selectedTools) && selectedTools.length > 0) {
              selectedTools.forEach(toolId => {
                const inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'selected_tools[]';
                inp.value = toolId;
                toolsInputsWrapper.appendChild(inp);
              });
            }

            // Tool Configurations
            if (window.toolConfigurations && Object.keys(window.toolConfigurations).length > 0) {
                const configInp = document.createElement('input');
                configInp.type = 'hidden';
                configInp.name = 'tool_config';
                configInp.value = JSON.stringify(window.toolConfigurations);
                toolsInputsWrapper.appendChild(configInp);
            }
          }

          // Model / App selections
          const modelInput = document.getElementById('input-model-slug');
          const appInput = document.getElementById('input-app-number');
          const isBatchMode = (modelSelectionMode === 'batch' || appSelectionMode === 'batch');
          if (isBatchMode) {
            if (selectedModels.length > 0 && modelInput) {
              modelInput.value = selectedModels.map(m => m.slug).join(',');
            }
            if (selectedApps.length > 0 && appInput) {
              appInput.value = selectedApps.map(a => `${a.modelSlug}:${a.number}`).join(',');
            }
          } else {
            if (selectedModel && modelInput) modelInput.value = selectedModel.slug;
            if (selectedApp && appInput) appInput.value = selectedApp.number;
          }

          // Add a bypass flag (safe for server to ignore) to indicate confirmation was shown
          // First remove any existing bypass input to prevent duplicates
          const existingBypass = form.querySelector('input[name="_bypass_confirmation"]');
          if (existingBypass) existingBypass.remove();
          
          const bypassInput = document.createElement('input');
          bypassInput.type = 'hidden';
          bypassInput.name = '_bypass_confirmation';
          bypassInput.value = '1';
          form.appendChild(bypassInput);
          console.log('Added bypass confirmation input to form');
        } catch (serr) {
          console.warn('Error serializing form state before submit:', serr);
        }

        // Trigger a standard submit event (lets our submit handler run/validate)
        setTimeout(() => {
          try {
            if (typeof form.requestSubmit === 'function') {
              form.requestSubmit();
            } else {
              // Create a temporary hidden submit button and click it
              const tmpBtn = document.createElement('button');
              tmpBtn.type = 'submit';
              tmpBtn.style.display = 'none';
              form.appendChild(tmpBtn);
              tmpBtn.click();
              form.removeChild(tmpBtn);
            }
          } catch (err) {
            console.error('Submit dispatch failed:', err);
            // Revert loading UI so user can retry
            if (loadingBtn) loadingBtn.classList.add('d-none');
            if (launchBtn) launchBtn.classList.remove('d-none');
          }
        }, 50);

        // Watchdog: if the submit event never fires (browser quirk), fall back to fetch
        try {
          window.__analysisSubmitEventFired = false;
          setTimeout(async () => {
            if (window.__analysisSubmitEventFired) return;
            if (window.__analysisFormSubmitting) return;
            console.warn('Submit event not detected; using fetch fallback');
            window.__analysisFormSubmitting = true;
            try {
              const fd = new FormData(form);
              const resp = await fetch(form.action || '/analysis/create', {
                method: 'POST',
                body: fd,
                credentials: 'same-origin'
              });
              if (resp.redirected) {
                window.location.href = resp.url;
                return;
              }
              if (resp.ok) {
                // Assume success goes to list
                window.location.href = '/analysis/list';
                return;
              }
              const txt = await resp.text();
              console.error('Fetch fallback failed, status:', resp.status, txt);
              alert('Failed to launch analysis (' + resp.status + '). Please check selections and try again.');
            } catch (fe) {
              console.error('Fetch fallback error:', fe);
              alert('Network error launching analysis. Please try again.');
            } finally {
              window.__analysisFormSubmitting = false;
              if (loadingBtn) loadingBtn.classList.add('d-none');
              if (launchBtn) launchBtn.classList.remove('d-none');
            }
          }, 1500);
        } catch (wdErr) {
          console.warn('Submit watchdog setup failed', wdErr);
        }
    } else {
        console.error('Form not found!');
    }
}

function updateSelectedToolsSummary() {
    const summaryContainer = document.getElementById('selected-tools-summary');
    const countElement = document.getElementById('selected-tools-count');
    const listElement = document.getElementById('selected-tools-list');
    
    if (!summaryContainer || !countElement || !listElement) return;
    
    if (selectedTools.length === 0) {
      summaryContainer.classList.add('d-none');
      countElement.textContent = '0';
      listElement.innerHTML = '';
      return;
    }
    
    summaryContainer.classList.remove('d-none');
    countElement.textContent = selectedTools.length;
    
    // Group tools by container and create enhanced badges
    const toolsByContainer = {};
    selectedTools.forEach(toolName => {
        const tool = allTools.find(t => t.name === toolName);
        if (!tool) return;
        
        const containerName = tool.container || 'unknown';
        if (!toolsByContainer[containerName]) {
            toolsByContainer[containerName] = [];
        }
        toolsByContainer[containerName].push(tool);
    });
    
    let toolBadgesHtml = '';
    
    // Show container groups
    Object.keys(toolsByContainer).forEach(containerName => {
        const tools = toolsByContainer[containerName];
        const containerColor = {
            'static-analyzer': 'primary',
            'dynamic-analyzer': 'success',
            'performance-tester': 'info',
            'ai-analyzer': 'warning'
        }[containerName] || 'secondary';
        
        const containerIcon = {
            'static-analyzer': 'fas fa-search',
            'dynamic-analyzer': 'fas fa-play',
            'performance-tester': 'fas fa-tachometer-alt',
            'ai-analyzer': 'fas fa-brain'
        }[containerName] || 'fas fa-tools';
        
        const containerDisplayName = {
            'static-analyzer': 'Static Analysis',
            'dynamic-analyzer': 'Dynamic Analysis', 
            'performance-tester': 'Performance Testing',
            'ai-analyzer': 'AI Analysis'
        }[containerName] || containerName;
        
        toolBadgesHtml += `
            <div class="mb-2">
                <small class="text-muted fw-bold"><i class="${containerIcon} me-1"></i>${containerDisplayName}:</small><br>
        `;
        
        tools.forEach(tool => {
            const toolIcon = containerName === 'ai-analyzer' ? 'fas fa-robot' : 'fas fa-tools';
            toolBadgesHtml += `
                <span class="badge bg-${containerColor} me-1 mb-1">
                    <i class="${toolIcon} me-1"></i>
                    ${escapeHtml(tool.display_name || tool.name)}
                    <button type="button" class="btn-close btn-close-white ms-1" 
                            onclick="toggleTool('${escapeHtml(tool.name)}', '${escapeHtml(tool.display_name)}', '${escapeHtml(tool.container)}')"
                            title="Remove ${escapeHtml(tool.name)}"></button>
                </span>
            `;
        });
        
        toolBadgesHtml += '</div>';
    });
    
  listElement.innerHTML = toolBadgesHtml;
  updateSidebarToolDisplay();
}

function updateSidebarToolDisplay() {
    const sidebarContainer = document.getElementById('sidebar-selected-tools');
    const sidebarCount = document.getElementById('sidebar-tool-count');
    const sidebarTime = document.getElementById('sidebar-tool-time');
    
    if (!sidebarContainer || !sidebarCount || !sidebarTime) return;
    
    sidebarCount.textContent = selectedTools.length;
    
    if (selectedTools.length === 0) {
        sidebarContainer.innerHTML = `
            <div class="text-muted text-center py-3 small">
                <i class="fas fa-info-circle me-1"></i>
                No tools selected
            </div>
        `;
        sidebarTime.textContent = '0min';
        return;
    }
    
    // Calculate estimated time
    const estimatedMinutes = selectedTools.length * 5 + 2; // 5 min per tool + 2 min overhead
    sidebarTime.textContent = `${estimatedMinutes}min`;
    
    // Display selected tools as compact badges
    let toolsHtml = '';
    selectedTools.forEach(toolName => {
        const tool = allTools.find(t => t.name === toolName);
        if (!tool) return;
        
        const containerColor = {
            'static-analyzer': 'primary',
            'dynamic-analyzer': 'success',
            'performance-tester': 'info',
            'ai-analyzer': 'warning'
        }[tool.container] || 'secondary';
        
        toolsHtml += `
            <span class="badge bg-${containerColor}-subtle text-${containerColor} tool-badge me-1" 
                  title="${escapeHtml(tool.description || '')}">
                ${escapeHtml(tool.display_name || tool.name)}
                <button type="button" class="btn-close ms-1" 
                        onclick="toggleTool('${escapeHtml(tool.name)}', '${escapeHtml(tool.display_name)}', '${escapeHtml(tool.container)}')" 
                        title="Remove"></button>
            </span>
        `;
    });
    
    sidebarContainer.innerHTML = toolsHtml;
}

function syncToolCheckboxesWithSelection() {
  const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="tool-"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectedTools.includes(checkbox.value);
  });
}

function updateCustomAnalysisEstimate() {
    if (selectedTools.length === 0) {
        document.getElementById('estimate-time').textContent = '-';
        document.getElementById('estimate-cost').textContent = '-';
        return;
    }
    
    // Calculate estimates based on selected tools
    let totalTimeMinutes = 0;
    let totalCostEstimate = 0;
    
    selectedTools.forEach(toolName => {
        const tool = allTools.find(t => t.name === toolName);
        if (tool) {
            totalTimeMinutes += 5; // Default 5 minutes per tool
            totalCostEstimate += 0.02; // Default $0.02 per tool
        }
    });
    
    // Add base overhead
    totalTimeMinutes += 2; // Base 2 minutes overhead
    totalCostEstimate += 0.01; // Base $0.01 overhead
    
    const timeRange = `${Math.max(1, totalTimeMinutes - 2)}-${totalTimeMinutes + 3} minutes`;
    const costRange = `$${(totalCostEstimate * 0.8).toFixed(3)}-$${(totalCostEstimate * 1.2).toFixed(3)}`;
    
    document.getElementById('estimate-time').textContent = timeRange;
    document.getElementById('estimate-cost').textContent = costRange;
}

function updateAnalysisSummary() {
  // Models summary
  const summaryModelElement = document.getElementById('summary-model');
  if (summaryModelElement) {
    if (modelSelectionMode === 'single') {
      summaryModelElement.textContent = selectedModel ? selectedModel.name : '-';
    } else {
      summaryModelElement.innerHTML = selectedModels.length ? `${selectedModels.length} models` : '-';
    }
  }
  // Apps summary
  const summaryAppElement = document.getElementById('summary-app');
  if (summaryAppElement) {
    if (appSelectionMode === 'single') {
      summaryAppElement.textContent = selectedApp ? `Application #${selectedApp.number}` : '-';
    } else {
      summaryAppElement.innerHTML = selectedApps.length ? `${selectedApps.length} apps` : '-';
    }
  }
  
  // Analysis tools summary
  const summaryTypeElement = document.getElementById('summary-type');
  if (summaryTypeElement) {
    if (selectedTools.length > 0) {
      // Compute per-container grouping
      const toolsByContainer = {};
      selectedTools.forEach(toolName => {
        const t = allTools.find(x => x.name === toolName);
        if (!t) return;
        const container = t.container || 'unknown';
        toolsByContainer[container] = toolsByContainer[container] || [];
        toolsByContainer[container].push(t);
      });
      const containerParts = Object.keys(toolsByContainer).map(container => `${container}: ${toolsByContainer[container].length}`).join(', ');
      summaryTypeElement.textContent = `Custom (${selectedTools.length} tools; ${Object.keys(toolsByContainer).length} container(s): ${containerParts})`;
    } else {
      summaryTypeElement.textContent = '-';
    }
  }
  
  // Priority
  const priority = document.querySelector('select[name="priority"]');
  const summaryPriorityElement = document.getElementById('summary-priority');
  if (priority && summaryPriorityElement) {
    summaryPriorityElement.textContent = priority.value.charAt(0).toUpperCase() + priority.value.slice(1);
  }
  
  // Estimates
  const timeElement = document.getElementById('estimate-time');
  const costElement = document.getElementById('estimate-cost');
  const summaryTimeElement = document.getElementById('summary-time');
  const summaryCostElement = document.getElementById('summary-cost');
  if (timeElement && summaryTimeElement) {
    summaryTimeElement.textContent = timeElement.textContent || '-';
  }
  if (costElement && summaryCostElement) {
    summaryCostElement.textContent = costElement.textContent || '-';
  }
  
  // Container management summary
  const containerAutoStart = document.getElementById('container-auto-start');
  const containerBuildIfMissing = document.getElementById('container-build-if-missing');
  const containerStopAfter = document.getElementById('container-stop-after');
  const summaryContainerRow = document.getElementById('summary-container-row');
  const summaryContainersElement = document.getElementById('summary-containers');
  
  if (summaryContainerRow && summaryContainersElement) {
    const containerFeatures = [];
    if (containerAutoStart && containerAutoStart.checked) {
      containerFeatures.push('Auto-start');
    }
    if (containerBuildIfMissing && containerBuildIfMissing.checked) {
      containerFeatures.push('Build if missing');
    }
    if (containerStopAfter && containerStopAfter.checked) {
      containerFeatures.push('Stop after');
    }
    
    if (containerFeatures.length > 0) {
      summaryContainerRow.classList.remove('d-none');
      summaryContainersElement.innerHTML = `<span class="badge bg-primary-lt text-primary">${containerFeatures.join(', ')}</span>`;
    } else {
      summaryContainerRow.classList.add('d-none');
      summaryContainersElement.textContent = '-';
    }
  }
}

// Filter functions
function filterModels() {
    const provider = document.getElementById('provider-filter').value;
    const capability = document.getElementById('capability-filter').value;
    const price = document.getElementById('price-filter').value;
    
    const params = new URLSearchParams();
    if (provider) params.append('provider', provider);
    if (capability) params.append('capability', capability);
    if (price) params.append('price', price);
    params.append('selectable', 'true');
    
    // Show loading state
    const gridContainer = document.getElementById('model-selection-grid');
    gridContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Filtering models...</span>
            </div>
        </div>
    `;
    
    if (window.htmx) {
        htmx.ajax('GET', `/analysis/api/models/grid?${params.toString()}`, {
            target: '#model-selection-grid'
        });
    }
}

// Utility functions
function escapeHtml(text) {
  if (text === null || text === undefined) {
    return '';
  }
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  const str = String(text);
  return str.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Initialize wizard on page load
function initAnalysisWizard() {
  // Initialize wizard state
    currentStep = 1;
    updateWizardStep();
    
    // Make functions globally accessible for hyperscript early
    window.selectModel = selectModel;

  // Preload analysis tools so the tool panels populate automatically
  loadAnalysisTools()
    .then(() => {
      syncToolCheckboxesWithSelection();
      updateSelectedToolsSummary();
      updateSidebarToolDisplay();
      updateCustomAnalysisEstimate();
    })
    .catch(err => console.warn('Initial tool load failed', err));
    
    // Wire up tool selection buttons
    const selectAllBtn = document.getElementById('select-all-tools-btn');
    const clearAllBtn = document.getElementById('clear-all-tools-btn');
    const refreshBtn = document.getElementById('refresh-availability-btn');
    
    // Sidebar tool management buttons
    const sidebarSelectAllBtn = document.getElementById('sidebar-select-all-tools');
    const sidebarClearAllBtn = document.getElementById('sidebar-clear-all-tools');
    const sidebarRefreshBtn = document.getElementById('sidebar-refresh-tools');
    
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', selectAllTools);
    }
    
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllTools);
    }
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
            try {
        refreshBtn.disabled = true;
        await loadAnalysisTools(true);
                console.log('Availability refreshed successfully');
            } catch (e) {
                console.warn('Availability refresh failed', e);
      } finally {
        refreshBtn.disabled = false;
            }
        });
    }
    
    // Sidebar button handlers (delegate to main functions)
    if (sidebarSelectAllBtn) {
        sidebarSelectAllBtn.addEventListener('click', selectAllTools);
    }
    
    if (sidebarClearAllBtn) {
        sidebarClearAllBtn.addEventListener('click', clearAllTools);
    }
    
    if (sidebarRefreshBtn) {
        sidebarRefreshBtn.addEventListener('click', async () => {
            try {
        sidebarRefreshBtn.disabled = true;
        await loadAnalysisTools(true);
                console.log('Tools refreshed from sidebar');
            } catch (e) {
                console.warn('Tool refresh failed from sidebar', e);
      } finally {
        sidebarRefreshBtn.disabled = false;
            }
        });
    }
    
    // Advanced options toggle
    const advToggle = document.getElementById('advanced-options-toggle');
    const adv = document.getElementById('advanced-options');
    if (advToggle && adv) {
        advToggle.addEventListener('change', function() {
            if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
                const collapse = new bootstrap.Collapse(adv, {toggle: false});
                this.checked ? collapse.show() : collapse.hide();
            } else {
                // Fallback if Bootstrap JS not available
                adv.style.display = this.checked ? 'block' : 'none';
            }
        });
    }
    
    // Container management checkboxes - update summary when changed
    const containerCheckboxIds = ['container-auto-start', 'container-build-if-missing', 'container-stop-after'];
    containerCheckboxIds.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.addEventListener('change', () => {
                updateAnalysisSummary();
            });
        }
    });
    
    // Form submission handling
    const form = document.getElementById('analysis-wizard-form');
    if (form) {
        form.addEventListener('submit', (e) => {
      try { window.__analysisSubmitEventFired = true; } catch (_) {}
            console.log('Form submit event triggered!');
            console.log('selectedTools:', selectedTools);
            
            // Serialize form data first
            const modeInput = document.getElementById('input-analysis-mode');
            const toolsInputsWrapper = document.getElementById('selected-tools-inputs');
            
            if (modeInput) modeInput.value = 'custom';
            if (toolsInputsWrapper) toolsInputsWrapper.innerHTML = '';
            
            // Add selected tools as hidden inputs
            if (selectedTools.length > 0 && toolsInputsWrapper) {
                selectedTools.forEach(toolId => {
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'selected_tools[]';
                    inp.value = toolId;
                    toolsInputsWrapper.appendChild(inp);
                });
            }
            
            // Populate model/app selections for batch mode
            const modelInput = document.getElementById('input-model-slug');
            const appInput = document.getElementById('input-app-number');
            
            const isBatchMode = (modelSelectionMode === 'batch' || appSelectionMode === 'batch');
            if (isBatchMode) {
                if (selectedModels.length > 0) {
                    if (modelInput) modelInput.value = selectedModels.map(m => m.slug).join(',');
                }
                if (selectedApps.length > 0) {
                    if (appInput) appInput.value = selectedApps.map(a => `${a.modelSlug}:${a.number}`).join(',');
                }
            } else {
                if (selectedModel && modelInput) modelInput.value = selectedModel.slug;
                if (selectedApp && appInput) appInput.value = selectedApp.number;
            }
            
            // Validate all steps before submission
            try {
                for (let i = 1; i <= 3; i++) {
                    console.log(`Validating step ${i}`);
                    if (!isStepValid(i)) {
                        console.log(`Step ${i} validation failed`);
                        e.preventDefault();
                        goToStep(i);
                        showValidationFeedback(i, false, getValidationMessage(i));
                        return;
                    }
                    console.log(`Step ${i} validation passed`);
                }
                console.log('All validation passed');
            } catch (error) {
                console.error('Validation error:', error);
                e.preventDefault();
                return;
            }
            
            // Check if this is a bypass submission (after confirmation)
            // Check if confirmation was already shown (bypass flag present)
            const bypassInput = form.querySelector('input[name="_bypass_confirmation"]');
            console.log('Checking for bypass input:', bypassInput);
            console.log('All form inputs:', Array.from(form.elements).map(el => el.name).filter(n => n));
            if (bypassInput) {
                console.log('Bypass confirmation flag found - allowing form submission');
                // Clear persisted selections to avoid locking tools after a run
                try {
                    sessionStorage.removeItem('analysis_selected_model');
                    sessionStorage.removeItem('analysis_selected_app');
                    sessionStorage.removeItem('analysis_selected_tools');
                    sessionStorage.removeItem('analysis_selected_model_batch');
                    sessionStorage.removeItem('analysis_selected_app_batch');
                } catch (e) { /* no-op */ }

                // Do NOT remove the bypass input - let it be submitted
                // The server will just ignore this hidden field
                // Allow form to submit without showing confirmation again
                const launchBtn = document.getElementById('launch-btn');
                const loadingBtn = document.getElementById('launch-btn-loading');
                if (launchBtn) launchBtn.classList.add('d-none');
                if (loadingBtn) loadingBtn.classList.remove('d-none');
                return; // Let the form submit naturally
            }

      // Show confirmation dialog for tool selection
            if (selectedTools.length > 0) {
                console.log('Tools selected - showing confirmation');
                try {
                    // Ensure allTools is loaded
                    if (!allTools || allTools.length === 0) {
                        console.warn('allTools not loaded yet, allowing submission');
                        e.preventDefault();
                        alert('Tools are still loading. Please wait a moment and try again.');
                        return;
                    }
          console.log('Preventing form and showing confirmation dialog');
                    e.preventDefault();
                    showToolSelectionConfirmation();
                    return;
                } catch (error) {
                    console.error('Error in confirmation logic:', error);
                    e.preventDefault();
                    return;
                }
            }
            
            // Show loading state
            const launchBtn = document.getElementById('launch-btn');
            const loadingBtn = document.getElementById('launch-btn-loading');
            if (launchBtn) launchBtn.classList.add('d-none');
            if (loadingBtn) loadingBtn.classList.remove('d-none');
        });
    }
    
    // Restore selections from session storage if available
    try {
        const savedModel = sessionStorage.getItem('analysis_selected_model');
        const savedApp = sessionStorage.getItem('analysis_selected_app');
        const savedTools = sessionStorage.getItem('analysis_selected_tools');
        
        if (savedModel) {
            selectedModel = JSON.parse(savedModel);
            console.log('Restored model selection:', selectedModel);
        }
        if (savedApp) {
            selectedApp = JSON.parse(savedApp);
            console.log('Restored app selection:', savedApp);
        }
        if (savedTools) {
            selectedTools = JSON.parse(savedTools);
            console.log('Restored selected tools:', selectedTools);
        }
    } catch (e) {
        console.warn('Could not restore selections from sessionStorage:', e);
    }

      refreshModelSelectionsUI();
      refreshAppSelectionsUI();
      updateAnalysisSummary();
      updateNavigationButtons();
    
    // Initialize HTMX if available
    if (typeof htmx !== 'undefined') {
        console.log('HTMX initialized and ready');
    } else {
        console.warn('HTMX not found - some functionality may not work');
    }

  // Delegated click for dynamically loaded application cards & clear buttons
  // Use a flag to prevent multiple registrations
  if (!window._analysisClickHandlerRegistered) {
    window._analysisClickHandlerRegistered = true;
    
    // Debounce helper to prevent double-fires
    let lastClickTime = 0;
    let lastClickTarget = null;
    
    document.addEventListener('click', (e) => {
      // Debounce: ignore clicks within 100ms on same element type
      const now = Date.now();
      const targetKey = e.target.closest('[data-app], [data-select-app], [data-model-slug]');
      if (targetKey && targetKey === lastClickTarget && (now - lastClickTime) < 100) {
        console.log('[Click] Debounced duplicate click');
        return;
      }
      lastClickTime = now;
      lastClickTarget = targetKey;
      
      // Handle Select button click (new data attribute approach)
      const selectAppBtn = e.target.closest('button[data-select-app]');
      if (selectAppBtn) {
        e.stopPropagation();
        e.preventDefault();
        const num = selectAppBtn.getAttribute('data-select-app');
        const mSlug = selectAppBtn.getAttribute('data-select-model') || (selectedModel && selectedModel.slug) || 'unknown';
        if (num) {
          selectApp(num, {}, mSlug);
        }
        return;
      }

      // Handle app card/row click (use .app-row only to avoid double-matching)
      const appRow = e.target.closest('tr.app-row[data-app]');
      if (appRow && !e.target.closest('button')) {
        e.stopPropagation();
        const num = appRow.getAttribute('data-app');
        if (!num) return;
        const mSlug = appRow.getAttribute('data-model-slug') || (selectedModel && selectedModel.slug) || 'unknown';
        selectApp(num, {}, mSlug);
        return;
      }
      
      // Handle legacy app-card (div-based, not tr)
      const appCard = e.target.closest('div.app-card[data-app]');
      if (appCard && !e.target.closest('button')) {
        e.stopPropagation();
        const num = appCard.getAttribute('data-app');
        if (!num) return;
        const mSlug = appCard.getAttribute('data-model-slug') || (selectedModel && selectedModel.slug) || 'unknown';
        selectApp(num, {}, mSlug);
        return;
      }

      const modelCard = e.target.closest('.model-card[data-model-slug]');
      if (modelCard && modelCard.dataset.modelSlug) {
        const slug = modelCard.dataset.modelSlug;
        const name = modelCard.dataset.modelName || slug;
        selectModel(slug, name);
        return;
      }

      // Remove model from sidebar list
      const removeModelBtn = e.target.closest('button[data-remove-model]');
      if (removeModelBtn) {
        const slug = removeModelBtn.getAttribute('data-remove-model');
        if (slug) {
          selectedModels = selectedModels.filter(m => m.slug !== slug);
          if (selectedModel && selectedModel.slug === slug) {
            selectedModel = selectedModels[0] || null;
          }
          refreshModelSelectionsUI();
          updateNavigationButtons();
        }
        return; // stop further handling
      }

    // Remove application from sidebar list
    const removeAppBtn = e.target.closest('button[data-remove-app]');
    if (removeAppBtn) {
      var num = removeAppBtn.getAttribute('data-remove-app');
      var mSlug = removeAppBtn.getAttribute('data-remove-app-model');
      if (num) {
        selectedApps = selectedApps.filter(function(a) { return !(String(a.number) === String(num) && (!mSlug || a.modelSlug === mSlug)); });
        if (selectedApp && String(selectedApp.number) === String(num) && (!mSlug || selectedApp.modelSlug === mSlug)) {
          selectedApp = selectedApps[0] || null;
        }
        refreshAppSelectionsUI();
        updateNavigationButtons();
      }
      return;
    }
  });
  } // end of if (!window._analysisClickHandlerRegistered)

  // Batch aggregated search filter
  var batchSearch = document.getElementById('batch-app-search');
  if (batchSearch) {
    batchSearch.addEventListener('input', function() { buildAggregatedAppsList(); });
  }

  // Clear-all buttons (models/apps)
  var clearModelsBtn = document.getElementById('clear-models-btn');
  if (clearModelsBtn) {
    clearModelsBtn.addEventListener('click', function() {
      selectedModels = [];
      selectedModel = null;
      refreshModelSelectionsUI();
      updateNavigationButtons();
    });
  }
  var clearAppsBtn = document.getElementById('clear-apps-btn');
  if (clearAppsBtn) {
    clearAppsBtn.addEventListener('click', function() {
      selectedApps = [];
      selectedApp = null;
      refreshAppSelectionsUI();
      updateNavigationButtons();
    });
  }
}

// Export for onclick handlers and re-initialization
window.AnalysisWizard = {
  init: initAnalysisWizard,
  nextStep: nextStep,
  previousStep: previousStep,
  goToStep: goToStep
};

// Also export to global for onclick handlers
window.nextStep = nextStep;
window.previousStep = previousStep;
window.goToStep = goToStep;
window.toggleModel = typeof toggleModel !== 'undefined' ? toggleModel : function(){};
window.selectModel = typeof selectModel !== 'undefined' ? selectModel : function(){};
window.selectApp = typeof selectApp !== 'undefined' ? selectApp : function(){};
window.toggleApp = typeof toggleApp !== 'undefined' ? toggleApp : function(){};
window.toggleTool = typeof toggleTool !== 'undefined' ? toggleTool : function(){};
window.toggleToolCategory = typeof toggleToolCategory !== 'undefined' ? toggleToolCategory : function(){};
window.toggleAllTools = typeof toggleAllTools !== 'undefined' ? toggleAllTools : function(){};
window.startAnalysis = typeof startAnalysis !== 'undefined' ? startAnalysis : function(){};
window.showToolConfig = typeof showToolConfig !== 'undefined' ? showToolConfig : function(){};
window.saveToolConfig = typeof saveToolConfig !== 'undefined' ? saveToolConfig : function(){};
window.applyConfigPreset = typeof applyConfigPreset !== 'undefined' ? applyConfigPreset : function(){};
window.setModelSelectionMode = setModelSelectionMode;
window.setAppSelectionMode = setAppSelectionMode;
window.initAnalysisWizard = initAnalysisWizard;

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAnalysisWizard);
} else {
  initAnalysisWizard();
}

// Listen for HTMX swaps to re-initialize
document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (document.getElementById('wizard-progress-bar')) {
    initAnalysisWizard();
  }
});

})();
  </script>
  <style>
    /* Visual feedback for selected rows in batch mode */
    tr.app-row.selected {
      box-shadow: inset 3px 0 0 var(--tblr-success);
    }
    tr.app-row.selected td:first-child {
      border-left: 3px solid var(--tblr-success);
    }
    /* Mode toggle buttons - compact */
    .card-body .btn-group-sm .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
  </style>
{% endblock %}

