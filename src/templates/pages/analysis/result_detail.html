{% extends 'layouts/base.html' %}

{% set active_page = 'analysis' %}
{% set page_icon = 'fa-solid fa-microscope' %}
{% set page_title = descriptor.model_slug ~ ' · App #' ~ descriptor.app_number %}

{% block content %}
  {% set severity_styles = {
    'critical': 'bg-danger-lt text-danger',
    'high': 'bg-danger-lt text-danger',
    'medium': 'bg-warning-lt text-warning',
    'low': 'bg-info-lt text-info',
    'info': 'bg-secondary-lt text-secondary'
  } %}
  {% set severity_order = ['critical', 'high', 'medium', 'low', 'info'] %}

  {# Page Header #}
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col-auto">
        <span class="avatar avatar-lg rounded">
          <i class="{{ page_icon }}"></i>
        </span>
      </div>
      <div class="col">
        <div class="page-pretitle text-secondary">{{ descriptor.analysis_type.replace('_', ' ').title() }} Analysis Result</div>
        <h2 class="page-title">{{ page_title }}</h2>
        <div class="text-secondary mt-1">
          Result ID: {{ descriptor.identifier[:24] }}{% if descriptor.identifier|length > 24 %}…{% endif %} · {{ descriptor.display_timestamp() }}
        </div>
        <div class="mt-2">
          <span class="badge {% if descriptor.status in ['completed', 'success'] %}bg-success-lt text-success{% elif descriptor.status in ['failed', 'error'] %}bg-danger-lt text-danger{% else %}bg-secondary-lt text-secondary{% endif %}">
            <i class="fa-solid fa-circle-dot me-1"></i>
            {{ descriptor.status.replace('_', ' ').title() }}
          </span>
          <span class="badge bg-primary-lt text-primary">{{ descriptor.analysis_type.replace('_', ' ').title() }}</span>
          {% if descriptor.tools_used %}
            <span class="badge bg-info-lt text-info">{{ descriptor.tools_used|length }} tools</span>
          {% endif %}
        </div>
      </div>
      <div class="col-auto ms-auto">
        <div class="btn-list">
          <a class="btn btn-ghost-secondary" href="{{ url_for('analysis.analysis_list') }}">
            <i class="fa-solid fa-arrow-left me-1"></i>Back
          </a>
          <a class="btn btn-ghost-info" href="{{ url_for('analysis.analysis_result_json', result_id=descriptor.identifier) }}" target="_blank" rel="noopener">
            <i class="fa-solid fa-file-code me-1"></i>View JSON
          </a>
          <a class="btn btn-primary" href="{{ url_for('analysis.analysis_result_download', result_id=descriptor.identifier) }}">
            <i class="fa-solid fa-download me-1"></i>Download
          </a>
        </div>
      </div>
    </div>
  </div>

  {# Summary Metrics Row #}
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="text-secondary text-uppercase fw-semibold small">Total Findings</div>
          <div class="h2 mb-0">{{ summary.get('total_findings', descriptor.total_findings or 0) }}</div>
          {% if descriptor.severity_breakdown %}
            <div class="text-secondary small mt-1">
              {% for level in severity_order %}
                {% set count = descriptor.severity_breakdown.get(level) %}
                {% if count %}{{ level.title() }}: {{ count }}{% if not loop.last %}, {% endif %}{% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="text-secondary text-uppercase fw-semibold small">Tools Executed</div>
          <div class="h2 mb-0">{{ summary.get('tools_executed', descriptor.tools_executed or 0) }}</div>
          {% if descriptor.tools_failed %}
            <div class="text-danger small mt-1">{{ descriptor.tools_failed }} failed</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="text-secondary text-uppercase fw-semibold small">Services</div>
          <div class="h2 mb-0">{{ services|length }}</div>
          <div class="text-secondary small mt-1">{{ summary.get('services_executed', services|length) }} executed</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="text-secondary text-uppercase fw-semibold small">Analysis Type</div>
          <div class="h2 mb-0 text-capitalize">{{ descriptor.analysis_type.replace('_', ' ') }}</div>
          <div class="text-secondary small mt-1">{{ metadata.get('module', 'N/A') }}</div>
        </div>
      </div>
    </div>
  </div>

  {# Tabbed Analysis Results #}
  <div class="card mb-3">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a href="#tab-static" class="nav-link active" data-bs-toggle="tab" role="tab">
            <i class="fa-solid fa-code me-1"></i>Static Analysis
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-dynamic" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fa-solid fa-play-circle me-1"></i>Dynamic Analysis
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-performance" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fa-solid fa-gauge-high me-1"></i>Performance
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-ai" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fa-solid fa-robot me-1"></i>AI Requirements
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#tab-metadata" class="nav-link" data-bs-toggle="tab" role="tab">
            <i class="fa-solid fa-info-circle me-1"></i>Metadata
          </a>
        </li>
      </ul>
    </div>
    <div class="card-body">
      <div class="tab-content">
        {# Static Analysis Tab #}
        <div class="tab-pane active show" id="tab-static" role="tabpanel">
          {% include 'pages/analysis/partials/tab_static.html' %}
        </div>

        {# Dynamic Analysis Tab #}
        <div class="tab-pane" id="tab-dynamic" role="tabpanel">
          {% include 'pages/analysis/partials/tab_dynamic.html' %}
        </div>

        {# Performance Tab #}
        <div class="tab-pane" id="tab-performance" role="tabpanel">
          {% include 'pages/analysis/partials/tab_performance.html' %}
        </div>

        {# AI Requirements Tab #}
        <div class="tab-pane" id="tab-ai" role="tabpanel">
          {% include 'pages/analysis/partials/tab_ai.html' %}
        </div>

        {# Metadata Tab #}
        <div class="tab-pane" id="tab-metadata" role="tabpanel">
          {% include 'pages/analysis/partials/tab_metadata.html' %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
