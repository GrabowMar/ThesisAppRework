{# Analysis Result Detail - Research Dashboard Design #}
{% extends 'layouts/base.html' %}
{% from 'components/detail_macros.html' import research_detail_header, research_metric_grid, research_section_nav, research_scroll_spy_script %}
{% set active_page = 'analysis' %}
{% set page_title = descriptor.model_slug ~ ' · App #' ~ descriptor.app_number %}

{% block content %}
{% set severity_order = ['critical', 'high', 'medium', 'low', 'info'] %}

<div class="research-detail-shell">
  {# Build view structure for unified header #}
  {% set status_color = 'success' if descriptor.status in ['completed', 'success'] else ('danger' if descriptor.status in ['failed', 'error'] else 'secondary') %}
  {% set view = {
    'pretitle': descriptor.analysis_type.replace('_', ' ').title() + ' Analysis',
    'icon': 'fa-solid fa-microscope',
    'title': page_title,
    'subtitle': 'Result ID: ' + descriptor.identifier[:24] + ('…' if descriptor.identifier|length > 24 else '') + ' · ' + descriptor.display_timestamp(),
    'badges': [
      {'label': descriptor.status.replace('_', ' ').title(), 'variant': 'badge bg-' + status_color + '-lt text-' + status_color, 'icon': 'fa-solid fa-circle-dot'},
      {'label': descriptor.analysis_type.replace('_', ' ').title(), 'variant': 'badge bg-primary-lt text-primary'},
      {'label': (descriptor.tools_used|length|string) + ' tools', 'variant': 'badge bg-info-lt text-info'} if descriptor.tools_used else None
    ]|select|list,
    'actions': [
      {'key': 'back', 'type': 'link', 'label': 'Back', 'icon': 'fa-solid fa-arrow-left', 'href': url_for('analysis.analysis_list'), 'classes': 'btn-ghost-secondary', 'visible': True},
      {'key': 'json', 'type': 'link', 'label': 'View JSON', 'icon': 'fa-solid fa-file-code', 'href': url_for('analysis.analysis_result_json', result_id=descriptor.identifier), 'target': '_blank', 'classes': 'btn-ghost-info', 'visible': True},
      {'key': 'download', 'type': 'link', 'label': 'Download', 'icon': 'fa-solid fa-download', 'href': url_for('analysis.analysis_result_download', result_id=descriptor.identifier), 'classes': 'btn-primary', 'visible': True}
    ]
  } %}
  
  {# Build metrics for unified grid #}
  {% set metrics = [
    {
      'label': 'Total Findings',
      'value': summary.get('total_findings', descriptor.total_findings or 0),
      'hint': (descriptor.severity_breakdown.items()|map('join', ': ')|join(', ')) if descriptor.severity_breakdown else None,
      'icon': 'fa-solid fa-list-check',
      'tone': 'danger' if (descriptor.total_findings or 0) > 10 else ('warning' if (descriptor.total_findings or 0) > 0 else 'success')
    },
    {
      'label': 'Tools Executed',
      'value': summary.get('tools_executed', descriptor.tools_executed or 0),
      'hint': (descriptor.tools_failed|string + ' failed') if descriptor.tools_failed else None,
      'icon': 'fa-solid fa-wrench',
      'tone': 'danger' if descriptor.tools_failed else 'success'
    },
    {
      'label': 'Services',
      'value': services|length,
      'hint': (summary.get('services_degraded', 0)|string + ' degraded') if summary.get('services_degraded', 0) > 0 else ((summary.get('services_executed', services|length)|string) + ' executed'),
      'icon': 'fa-solid fa-server',
      'tone': 'warning' if summary.get('services_degraded', 0) > 0 else None
    },
    {
      'label': 'Analysis Type',
      'value': descriptor.analysis_type.replace('_', ' ').title(),
      'hint': metadata.get('module', 'N/A'),
      'icon': 'fa-solid fa-tag'
    },
    {
      'label': 'Duration',
      'value': metadata.get('duration', '—'),
      'icon': 'fa-solid fa-clock'
    },
    {
      'label': 'Status',
      'value': descriptor.status.replace('_', ' ').title(),
      'tone': 'success' if descriptor.status in ['completed', 'success'] else ('danger' if descriptor.status in ['failed', 'error'] else 'muted'),
      'icon': 'fa-solid fa-circle-check'
    }
  ] %}
  
  {# Build sections for unified navigation #}
  {% set sections = [
    {'id': 'static', 'label': 'Static Analysis', 'icon': 'fa-solid fa-code'},
    {'id': 'dynamic', 'label': 'Dynamic Analysis', 'icon': 'fa-solid fa-play-circle'},
    {'id': 'performance', 'label': 'Performance', 'icon': 'fa-solid fa-gauge-high'},
    {'id': 'ai', 'label': 'AI Requirements', 'icon': 'fa-solid fa-robot'},
    {'id': 'metadata', 'label': 'Metadata', 'icon': 'fa-solid fa-info-circle'}
  ] %}
  
  {# Compact header bar #}
  {{ research_detail_header(view, []) }}
  
  {# Dense metric grid #}
  {{ research_metric_grid(metrics) }}
  
  {# Degraded services warning (if any) #}
  {% if metadata.get('degraded_services') and metadata.degraded_services|length > 0 %}
  <div class="alert alert-warning d-flex align-items-start gap-3 mb-4" role="alert">
    <div class="flex-shrink-0">
      <i class="fa-solid fa-triangle-exclamation fa-2x" aria-hidden="true"></i>
    </div>
    <div class="flex-grow-1">
      <h4 class="alert-heading mb-2">
        <strong>Partial Results Available</strong>
      </h4>
      <p class="mb-2">
        {{ metadata.degraded_services|length }} service{{ 's' if metadata.degraded_services|length > 1 else '' }} 
        {{ 'were' if metadata.degraded_services|length > 1 else 'was' }} unavailable during analysis. 
        Results are shown from successfully completed services only.
      </p>
      <ul class="mb-0 small">
        {% for svc in metadata.degraded_services %}
        <li>
          <strong>{{ svc.service }}</strong>: 
          <span class="text-muted">{{ svc.status }}</span>
          {% if svc.error %}
          <span class="text-danger">— {{ svc.error[:100] }}{{ '...' if svc.error|length > 100 else '' }}</span>
          {% endif %}
          <span class="text-muted">({{ svc.tools_affected|length }} tool{{ 's' if svc.tools_affected|length > 1 else '' }} affected)</span>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
  
  {# Sticky section navigation #}
  {{ research_section_nav(sections) }}
  
  {# Vertical section layout with static content (no lazy loading for analysis) #}
  <div class="research-content">
    <section id="section-static" class="research-section" data-research-section="static">
      <div class="research-section-header">
        <h2 class="research-section-title">
          <i class="fa-solid fa-code" aria-hidden="true"></i>
          <span>Static Analysis</span>
        </h2>
      </div>
      {% include 'pages/analysis/partials/tab_static.html' %}
    </section>
    
    <section id="section-dynamic" class="research-section" data-research-section="dynamic">
      <div class="research-section-header">
        <h2 class="research-section-title">
          <i class="fa-solid fa-play-circle" aria-hidden="true"></i>
          <span>Dynamic Analysis</span>
        </h2>
      </div>
      {% include 'pages/analysis/partials/tab_dynamic.html' %}
    </section>
    
    <section id="section-performance" class="research-section" data-research-section="performance">
      <div class="research-section-header">
        <h2 class="research-section-title">
          <i class="fa-solid fa-gauge-high" aria-hidden="true"></i>
          <span>Performance</span>
        </h2>
      </div>
      {% include 'pages/analysis/partials/tab_performance.html' %}
    </section>
    
    <section id="section-ai" class="research-section" data-research-section="ai">
      <div class="research-section-header">
        <h2 class="research-section-title">
          <i class="fa-solid fa-robot" aria-hidden="true"></i>
          <span>AI Requirements</span>
        </h2>
      </div>
      {% include 'pages/analysis/partials/tab_ai.html' %}
    </section>
    
    <section id="section-metadata" class="research-section" data-research-section="metadata">
      <div class="research-section-header">
        <h2 class="research-section-title">
          <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
          <span>Metadata</span>
        </h2>
      </div>
      {% include 'pages/analysis/partials/tab_metadata.html' %}
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ research_scroll_spy_script() }}
{% endblock %}
