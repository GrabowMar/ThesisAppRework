{# Analysis Result Detail - Research Dashboard Design #}
{% extends 'layouts/base_smart.html' %}
{% from 'shared/macros/detail_macros.html' import research_detail_header, research_metric_grid, research_section_nav, research_scroll_spy_script %}
{% from 'shared/macros/nav_macros.html' import breadcrumb %}
{% set active_page = 'analysis' %}
{% set page_title = view.title if view else 'Analysis Result' %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail-pages.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis-report.css') }}">
<style>
  @media print {
    .btn, .navbar, .sidebar, footer, .research-section-nav-wrapper { display: none !important; }
    .research-detail-shell { max-width: 100% !important; margin: 0 !important; }
    .card { break-inside: avoid; page-break-inside: avoid; }
  }
</style>
{% endblock %}

{% block title %}{{ page_title }} - Analysis Results{% endblock %}

{% block content %}
<div class="research-detail-shell">
  {# Breadcrumb navigation #}
  {% if breadcrumb_items %}
  {{ breadcrumb(breadcrumb_items, 'mb-2') }}
  {% endif %}

  {# Degraded Services Warning #}
  {% if metadata.degraded_services and metadata.degraded_services|length > 0 %}
  <div class="alert alert-warning py-2 mb-3" role="alert">
    <div class="d-flex align-items-center gap-2">
      <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
      <strong>Partial Results:</strong>
      <span>{{ metadata.degraded_services|length }} service{{ 's' if metadata.degraded_services|length > 1 else '' }} unavailable</span>
      <details class="ms-2">
        <summary class="small cursor-pointer">Details</summary>
        <ul class="mb-0 mt-1 small">
          {% for svc in metadata.degraded_services %}
          <li><strong>{{ svc.service }}</strong>: {{ svc.status }} ({{ svc.tools_affected|length }} tools)</li>
          {% endfor %}
        </ul>
      </details>
    </div>
  </div>
  {% endif %}

  {# Extract status badge from metrics #}
  {% set status_metric = metrics|selectattr('label', 'equalto', 'Status')|first if metrics else None %}
  {% set status_badge = {
    'label': status_metric.value,
    'color': status_metric.status_color or 'secondary',
    'animated': status_metric.status_color == 'success'
  } if status_metric else None %}

  {# Compact header bar with inline metrics and all actions #}
  {{ research_detail_header(view, metrics[1:4] if metrics and metrics|length > 1 else [], status_badge) }}

  {# Dense metric grid #}
  {{ research_metric_grid(metrics) }}

  {# Sticky horizontal section navigation #}
  {{ research_section_nav(sections) }}

  {# Vertical section layout with lazy loading #}
  <div class="research-content">
    {% for section in sections %}
      <section id="section-{{ section.id }}"
               class="research-section"
               data-research-section="{{ section.id }}"
               hx-get="{{ section.hx }}"
               hx-trigger="{% if loop.first %}load{% else %}intersect once threshold:0.1{% endif %}"
               hx-swap="innerHTML"
               aria-labelledby="section-{{ section.id }}-title">

        <div class="research-section-header">
          <h2 class="research-section-title" id="section-{{ section.id }}-title">
            <i class="{{ section.icon }}" aria-hidden="true"></i>
            <span>{{ section.label }}</span>
          </h2>
        </div>

        {# Skeleton loader placeholder #}
        <div class="research-skeleton" aria-live="polite" aria-busy="true">
          <div class="research-skeleton-line h-lg"></div>
          <div class="research-skeleton-line w-75"></div>
          <div class="research-skeleton-line w-50"></div>
        </div>
      </section>
    {% endfor %}
  </div>
</div>

{# Tool Detail Modal (global â€” must be outside sections for JS access) #}
{% include 'pages/analysis/partials/_tool_detail_modal.html' %}

{# Copy feedback toast #}
<div class="position-fixed bottom-0 end-0 p-3 d-print-none" style="z-index: 1090;">
  <div id="copyToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-atomic="true" data-bs-delay="1500">
    <div class="d-flex">
      <div class="toast-body"><i class="fa-solid fa-check me-1"></i>Copied to clipboard</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<div id="modal-container"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Inject full analysis payload for client-side parsing
  window.ANALYSIS_DATA = {{ payload|tojson|safe }};
  if (!window.ANALYSIS_DATA.task_id) {
      window.ANALYSIS_DATA.task_id = "{{ descriptor.identifier }}";
  }
</script>
<script src="{{ url_for('static', filename='js/analysis-parsers.js') }}"></script>
<script src="{{ url_for('static', filename='js/tool-detail.js') }}"></script>
<script src="{{ url_for('static', filename='js/analysis-detail-enhancements.js') }}"></script>
{{ research_scroll_spy_script() }}
<script>
// Toast notification helper
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container') || (() => {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
    return container;
  })();
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} alert-dismissible fade show`;
  toast.role = 'alert';
  toast.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// Handle section loading states
document.addEventListener('htmx:beforeRequest', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.add('is-loading');
  }
});

document.addEventListener('htmx:afterSwap', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.remove('is-loading');
  }
});

document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.successful) {
    console.log('HTMX request successful:', evt.detail.pathInfo.requestPath);
  } else {
    console.error('HTMX request failed:', evt.detail.pathInfo.requestPath);
  }
});

document.addEventListener('htmx:responseError', evt => {
  const section = evt.detail.elt;
  if (!section || !section.matches('[data-research-section]')) {
    showToast('A server error occurred. Please try again.', 'danger');
    return;
  }
  const sectionId = section.getAttribute('data-research-section');
  const sectionTitle = section.querySelector('.research-section-title span')?.textContent || 'Section';
  section.innerHTML = `
    <div class="research-section-header">
      <h2 class="research-section-title">
        <i class="fa-solid fa-exclamation-triangle text-warning" aria-hidden="true"></i>
        <span>Failed to load ${sectionTitle}</span>
      </h2>
    </div>
    <div class="research-empty-state">
      <div class="research-empty-icon">
        <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>
      </div>
      <div class="research-empty-title">Content could not be loaded</div>
      <div class="research-empty-message">There was an error loading this section. Please try again.</div>
      <div class="research-empty-action">
        <button class="btn btn-primary" onclick="htmx.ajax('GET', '${section.getAttribute('hx-get')}', { target: '[data-research-section=\\'${sectionId}\\']', swap: 'innerHTML' })">
          <i class="fa-solid fa-refresh me-1"></i>Retry
        </button>
      </div>
    </div>
  `;
  section.classList.remove('is-loading');
});

// Copy button handler (for task ID, link, etc.)
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.copy-btn');
  if (!btn) return;
  const text = btn.getAttribute('data-copy');
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    const toast = document.getElementById('copyToast');
    if (toast) {
      const bsToast = bootstrap.Toast.getInstance(toast) || new bootstrap.Toast(toast);
      bsToast.show();
    }
  });
});
</script>
{% endblock %}

