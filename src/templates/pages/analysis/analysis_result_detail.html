{# Analysis Result Detail - Compact Report Design #}
{% extends 'layouts/base.html' %}
{% set active_page = 'analysis' %}
{% set page_title = descriptor.model_slug ~ ' · App #' ~ descriptor.app_number %}
{% set page_icon = 'fa-solid fa-chart-bar' %}

{% block title %}{{ page_title }} - Analysis Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis-report.css') }}">
<style>
  @media print {
    .btn, .navbar, .sidebar, footer { display: none !important; }
    .report-container { max-width: 100% !important; margin: 0 !important; }
    .card { break-inside: avoid; page-break-inside: avoid; }
  }
</style>
{% endblock %}

{% block content %}
{% set severity_order = ['critical', 'high', 'medium', 'low', 'info'] %}

<div class="report-container py-2">
  {# Compact Report Header #}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="{{ url_for('analysis.analysis_list') }}" class="btn btn-sm btn-ghost-secondary btn-icon" title="Back to list">
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div>
        <h1 class="h4 mb-0">{{ page_title }}</h1>
        <div class="text-muted small">
          {{ descriptor.task_name.replace('_', ' ').title() }} • <code>{{ descriptor.identifier[:20] }}…</code> • {{ descriptor.display_timestamp() }}
        </div>
      </div>
    </div>
    <div class="btn-list flex-nowrap d-print-none">
      <a href="{{ url_for('analysis.analysis_result_json', result_id=descriptor.identifier) }}" 
         target="_blank" class="btn btn-sm btn-ghost-info btn-icon" title="View JSON">
        <i class="fa-solid fa-file-code"></i>
      </a>
      <a href="{{ url_for('analysis.export_task_sarif', task_id=descriptor.identifier) }}" 
         class="btn btn-sm btn-ghost-success btn-icon" title="Download SARIF">
        <i class="fa-solid fa-file-shield"></i>
      </a>
      <button onclick="window.print()" class="btn btn-sm btn-ghost-primary btn-icon" title="Print" type="button">
        <i class="fa-solid fa-print"></i>
      </button>
      <a href="{{ url_for('analysis.analysis_result_download', result_id=descriptor.identifier) }}" 
         class="btn btn-sm btn-primary" title="Download">
        <i class="fa-solid fa-download me-1"></i>Download
      </a>
    </div>
  </div>

  {# Compact Executive Summary #}
  <div class="card card-sm mb-3">
    <div class="card-body py-2">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          {% set status_color = 'success' if descriptor.status in ['completed', 'success'] else ('warning' if descriptor.status == 'partial_success' else ('danger' if descriptor.status in ['failed', 'error'] else 'secondary')) %}
          <span class="badge bg-{{ status_color }}-lt text-{{ status_color }}">
            <i class="fa-solid fa-circle-dot me-1"></i>{{ descriptor.status.replace('_', ' ').title() }}
          </span>
        </div>
        <div class="col-auto border-start ps-3">
          <span class="text-muted small">Findings:</span>
          {% set total = summary.get('total_findings', descriptor.total_findings or 0) %}
          <strong class="{% if total > 20 %}text-danger{% elif total > 10 %}text-warning{% else %}text-success{% endif %}">{{ total }}</strong>
        </div>
        <div class="col-auto border-start ps-3">
          <span class="text-muted small">Tools:</span>
          <strong>{{ summary.get('tools_executed', descriptor.tools_executed or 0) }}/{{ (descriptor.tools_used|length) if descriptor.tools_used else '?' }}</strong>
          {% if descriptor.tools_failed %}<span class="badge bg-danger-lt text-danger ms-1">{{ descriptor.tools_failed }} failed</span>{% endif %}
        </div>
        <div class="col-auto border-start ps-3">
          <span class="text-muted small">Services:</span>
          <strong>{{ services|length }}</strong>
          {% if summary.get('services_degraded', 0) > 0 %}<span class="badge bg-warning-lt text-warning ms-1">{{ summary.get('services_degraded', 0) }} degraded</span>{% endif %}
        </div>
        {% if descriptor.severity_breakdown %}
        <div class="col-auto ms-auto d-flex gap-1">
          {% for severity in ['critical', 'high', 'medium', 'low', 'info'] %}
            {% set count = descriptor.severity_breakdown.get(severity, 0) %}
            {% if count > 0 %}
            <span class="badge {% if severity == 'critical' %}bg-danger{% elif severity == 'high' %}bg-danger-lt text-danger{% elif severity == 'medium' %}bg-warning-lt text-warning{% elif severity == 'low' %}bg-info-lt text-info{% else %}bg-secondary-lt{% endif %}">{{ severity[:1].upper() }}{{ count }}</span>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Degraded Services Warning #}
  {% if metadata.get('degraded_services') and metadata.degraded_services|length > 0 %}
  <div class="alert alert-warning py-2 mb-3" role="alert">
    <div class="d-flex align-items-center gap-2">
      <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
      <strong>Partial Results:</strong>
      <span>{{ metadata.degraded_services|length }} service{{ 's' if metadata.degraded_services|length > 1 else '' }} unavailable</span>
      <details class="ms-2">
        <summary class="small cursor-pointer">Details</summary>
        <ul class="mb-0 mt-1 small">
          {% for svc in metadata.degraded_services %}
          <li><strong>{{ svc.service }}</strong>: {{ svc.status }} ({{ svc.tools_affected|length }} tools)</li>
          {% endfor %}
        </ul>
      </details>
    </div>
  </div>
  {% endif %}

  {# Analysis Sections #}
  <div class="accordion accordion-flush border rounded" id="analysisAccordion">
    {# Static Analysis Section #}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button py-2" type="button" data-bs-toggle="collapse" 
                data-bs-target="#staticSection" aria-expanded="true" aria-controls="staticSection">
          <i class="fa-solid fa-code me-2 text-primary"></i>
          <span>Static Analysis</span>
          <span class="ms-auto me-3 badge bg-secondary-lt">
            {{ payload.results.services.static.analysis.results|length if payload.results.services.static and payload.results.services.static.analysis.results else 0 }}
          </span>
        </button>
      </h2>
      <div id="staticSection" class="accordion-collapse collapse show" data-bs-parent="#analysisAccordion">
        <div class="accordion-body py-2">
          {% include 'pages/analysis/partials/_tab_static.html' %}
        </div>
      </div>
    </div>

    {# Dynamic Analysis Section #}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" 
                data-bs-target="#dynamicSection" aria-expanded="false" aria-controls="dynamicSection">
          <i class="fa-solid fa-play-circle me-2 text-success"></i>
          <span>Dynamic Analysis</span>
          <span class="ms-auto me-3 badge bg-secondary-lt">
            {{ payload.results.services.dynamic.analysis.results|length if payload.results.services.dynamic and payload.results.services.dynamic.analysis.results else 0 }}
          </span>
        </button>
      </h2>
      <div id="dynamicSection" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
        <div class="accordion-body py-2">
          {% include 'pages/analysis/partials/_tab_dynamic.html' %}
        </div>
      </div>
    </div>

    {# Performance Section #}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" 
                data-bs-target="#performanceSection" aria-expanded="false" aria-controls="performanceSection">
          <i class="fa-solid fa-gauge-high me-2 text-info"></i>
          <span>Performance</span>
          <span class="ms-auto me-3 badge bg-secondary-lt">
            {{ payload.results.services.performance.analysis.results|length if payload.results.services.performance and payload.results.services.performance.analysis.results else 0 }}
          </span>
        </button>
      </h2>
      <div id="performanceSection" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
        <div class="accordion-body py-2">
          {% include 'pages/analysis/partials/_tab_performance.html' %}
        </div>
      </div>
    </div>

    {# AI Requirements Section #}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" 
                data-bs-target="#aiSection" aria-expanded="false" aria-controls="aiSection">
          <i class="fa-solid fa-robot me-2 text-warning"></i>
          <span>AI Requirements</span>
        </button>
      </h2>
      <div id="aiSection" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
        <div class="accordion-body py-2">
          {% include 'pages/analysis/partials/_tab_ai.html' %}
        </div>
      </div>
    </div>

    {# Metadata Section #}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" 
                data-bs-target="#metadataSection" aria-expanded="false" aria-controls="metadataSection">
          <i class="fa-solid fa-info-circle me-2 text-secondary"></i>
          <span>Metadata</span>
        </button>
      </h2>
      <div id="metadataSection" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
        <div class="accordion-body py-2">
          {% include 'pages/analysis/partials/_tab_metadata.html' %}
        </div>
      </div>
    </div>
  </div>
</div>

{# Tool Detail Modal #}
{% include 'pages/analysis/partials/_tool_detail_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
  // Inject full analysis payload for client-side parsing
  window.ANALYSIS_DATA = {{ payload|tojson|safe }};
  // Ensure task_id is available even if not in payload
  if (!window.ANALYSIS_DATA.task_id) {
      window.ANALYSIS_DATA.task_id = "{{ descriptor.identifier }}";
  }
</script>
<script src="{{ url_for('static', filename='js/analysis-parsers.js') }}"></script>
<script src="{{ url_for('static', filename='js/tool-detail.js') }}"></script>
{% endblock %}
