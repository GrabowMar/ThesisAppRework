{% extends "base.html" %}

{% block title %}
{% if error_code %}Error {{ error_code }}{% else %}Error{% endif %} - Research Platform
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- Error Card -->
            <div class="card border-0 shadow-lg mt-5">
                <div class="card-body text-center p-5">
                    <!-- Error Icon -->
                    <div class="error-icon mb-4">
                        {% if error_code == 404 %}
                            <i class="fas fa-search fa-4x text-primary"></i>
                        {% elif error_code == 500 %}
                            <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
                        {% elif error_code == 403 %}
                            <i class="fas fa-ban fa-4x text-danger"></i>
                        {% else %}
                            <i class="fas fa-bug fa-4x text-info"></i>
                        {% endif %}
                    </div>
                    
                    <!-- Error Title -->
                    <h1 class="error-title display-4 mb-3">
                        {% if error_code == 404 %}
                            Page Not Found
                        {% elif error_code == 500 %}
                            Server Error
                        {% elif error_code == 403 %}
                            Access Denied
                        {% elif error_code %}
                            Error {{ error_code }}
                        {% else %}
                            Something Went Wrong
                        {% endif %}
                    </h1>
                    
                    <!-- Error Message -->
                    <p class="error-message lead text-muted mb-4">
                        {% if error %}
                            {{ error }}
                        {% elif error_code == 404 %}
                            The page you're looking for doesn't exist or has been moved to a different location.
                        {% elif error_code == 500 %}
                            We're experiencing some technical difficulties. Our team has been notified and is working on a fix.
                        {% elif error_code == 403 %}
                            You don't have permission to access this resource. Please check your credentials.
                        {% else %}
                            An unexpected error occurred while processing your request. Please try again.
                        {% endif %}
                    </p>
                    
                    <!-- Action Buttons -->
                    <div class="error-actions d-flex flex-wrap justify-content-center gap-2 mb-4">
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-home mr-2"></i>
                            Go to Dashboard
                        </a>
                        
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Go Back
                        </button>
                        
                        {% if retry_action %}
                        <a href="{{ retry_action }}" class="btn btn-info">
                            <i class="fas fa-redo mr-2"></i>
                            Try Again
                        </a>
                        {% elif error_code in [500, 502, 503, 504] or not error_code %}
                        <button type="button" class="btn btn-info" onclick="location.reload()">
                            <i class="fas fa-redo mr-2"></i>
                            Reload Page
                        </button>
                        {% endif %}
                        
                        {% if error_code == 500 or not error_code %}
                        <button type="button" class="btn btn-outline-primary"
                                onclick="showSystemHealth()"
                                data-toggle="modal" data-target="#system-health-modal">
                            <i class="fas fa-heartbeat mr-2"></i>
                            System Health
                        </button>
                        {% endif %}
                    </div>

                    <!-- Additional Help for 404 Errors -->
                    {% if error_code == 404 %}
                    <div class="suggestions-section">
                        <h5 class="mb-3">Maybe you were looking for:</h5>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <a href="{{ url_for('main.dashboard') }}" class="suggestion-link d-block p-3 border rounded text-decoration-none">
                                    <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                    <div class="font-weight-bold">Dashboard</div>
                                    <small class="text-muted">Main overview</small>
                                </a>
                            </div>
                            <div class="col-md-4 mb-2">
                                <a href="{{ url_for('main.models_overview') }}" class="suggestion-link d-block p-3 border rounded text-decoration-none">
                                    <i class="fas fa-robot fa-2x text-success mb-2"></i>
                                    <div class="font-weight-bold">AI Models</div>
                                    <small class="text-muted">Model listing</small>
                                </a>
                            </div>
                            <div class="col-md-4 mb-2">
                                <a href="{{ url_for('batch.batch_overview') }}" class="suggestion-link d-block p-3 border rounded text-decoration-none">
                                    <i class="fas fa-tasks fa-2x text-info mb-2"></i>
                                    <div class="font-weight-bold">Batch Jobs</div>
                                    <small class="text-muted">Analysis jobs</small>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Technical Details (Collapsible) -->
                {% if error_code in [500, 503] or not error_code %}
                <div class="card-footer bg-light">
                    <div class="text-center">
                        <button class="btn btn-link btn-sm" type="button" data-toggle="collapse" 
                                data-target="#technical-details" aria-expanded="false">
                            <i class="fas fa-cog mr-1"></i>
                            Show Technical Details
                            <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                    </div>
                    
                    <div class="collapse" id="technical-details">
                        <div class="mt-3 text-left">
                            <div class="row">
                                {% if error_code %}
                                <div class="col-md-6">
                                    <strong>Error Code:</strong> {{ error_code }}
                                </div>
                                {% endif %}
                                <div class="col-md-6">
                                    <strong>Timestamp:</strong> {{ timestamp or "N/A" }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Request ID:</strong> {{ request_id or 'N/A' }}
                                </div>
                                {% if request.url %}
                                <div class="col-md-6">
                                    <strong>URL:</strong> 
                                    <code class="text-break">{{ request.url }}</code>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if error_code == 500 %}
                            <div class="mt-3">
                                <strong>What you can do:</strong>
                                <ul class="small text-muted mb-0">
                                    <li>Refresh the page after a few moments</li>
                                    <li>Check the system health status</li>
                                    <li>Try accessing a different page</li>
                                    <li>Contact support if the problem persists</li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Status Message -->
            {% if error_code >= 500 and error_code < 600 %}
            <div class="text-center mt-4">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Service Notice:</strong> We're experiencing temporary issues. 
                    The page will automatically retry in <span id="retry-countdown">10</span> seconds.
                    <button type="button" class="btn btn-sm btn-warning ml-2" onclick="cancelAutoRetry()">
                        Cancel Auto-Retry
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- System Health Modal -->
<div class="modal fade" id="system-health-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-heartbeat mr-2"></i>
                    System Health Status
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="system-health-content">
                <div class="text-center py-3">
                    <div class="spinner mb-2"></div>
                    <p class="text-muted">Checking system health...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Error Page JavaScript
class ErrorPage {
    constructor() {
        this.retryCountdown = null;
        this.retryTimeout = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupAutoRetry();
        this.setupKeyboardShortcuts();
    }

    setupEventListeners() {
        // Suggestion link hover effects
        document.querySelectorAll('.suggestion-link').forEach(link => {
            link.addEventListener('mouseenter', function() {
                this.classList.add('shadow-sm', 'border-primary');
            });
            
            link.addEventListener('mouseleave', function() {
                this.classList.remove('shadow-sm', 'border-primary');
            });
        });

        // Technical details toggle
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-target="#technical-details"]')) {
                const icon = e.target.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (icon) {
                    setTimeout(() => {
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                    }, 150);
                }
            }
        });
    }

    setupAutoRetry() {
        {% if error_code >= 500 and error_code < 600 %}
        let countdown = 10;
        const countdownElement = document.getElementById('retry-countdown');
        
        if (countdownElement) {
            this.retryCountdown = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    this.executeAutoRetry();
                }
            }, 1000);
        }
        {% endif %}
    }

    executeAutoRetry() {
        if (this.retryCountdown) {
            clearInterval(this.retryCountdown);
            this.retryCountdown = null;
        }
        
        // Show loading state
        const alertDiv = document.querySelector('.alert-warning');
        if (alertDiv) {
            alertDiv.innerHTML = `
                <i class="fas fa-spinner fa-spin mr-2"></i>
                <strong>Retrying...</strong> Attempting to reload the page.
            `;
            alertDiv.classList.remove('alert-warning');
            alertDiv.classList.add('alert-info');
        }
        
        // Reload after a short delay
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    cancelAutoRetry() {
        if (this.retryCountdown) {
            clearInterval(this.retryCountdown);
            this.retryCountdown = null;
            
            const alertDiv = document.querySelector('.alert');
            if (alertDiv) {
                alertDiv.remove();
            }
        }
    }

    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Enter or Space - Go to dashboard
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                window.location.href = "{{ url_for('main.dashboard') }}";
            }
            
            // Backspace - Go back
            if (e.key === 'Backspace') {
                e.preventDefault();
                history.back();
            }
            
            // R - Retry/Reload
            if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                window.location.reload();
            }
            
            // H - Show system health (if available)
            if ((e.key === 'h' || e.key === 'H') && document.querySelector('[data-target="#system-health-modal"]')) {
                e.preventDefault();
                $('#system-health-modal').modal('show');
            }
        });
    }

    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
}

// Global functions
window.cancelAutoRetry = function() {
    errorPage.cancelAutoRetry();
};

window.showSystemHealth = function() {
    fetch('/api/system-health')
        .then(response => response.text())
        .then(html => {
            document.getElementById('system-health-content').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('system-health-content').innerHTML = 
                '<div class="alert alert-danger">Error loading system health</div>';
        });
};

// Initialize error page
let errorPage;
document.addEventListener('DOMContentLoaded', function() {
    errorPage = new ErrorPage();
    
    // Show helpful keyboard shortcuts tooltip
    setTimeout(() => {
        errorPage.showToast(
            'Tip: Use keyboard shortcuts - Enter (Dashboard), Backspace (Go Back), R (Retry)', 
            'info'
        );
    }, 2000);
});

// Page visibility handling - pause countdown when tab is not visible
document.addEventListener('visibilitychange', function() {
    if (document.hidden && errorPage.retryCountdown) {
        // Pause countdown when tab is hidden
        clearInterval(errorPage.retryCountdown);
    } else if (!document.hidden && errorPage.retryCountdown) {
        // Resume countdown when tab becomes visible
        errorPage.setupAutoRetry();
    }
});
</script>
{% endblock %}
