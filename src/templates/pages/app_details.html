{% extends "layouts/base.html" %}

{% block title %}{{ app.app_name }} - {{ app.model_display_name }} - Thesis Research App{% endblock %}

{% set breadcrumbs = [
    {'title': 'Dashboard', 'url': url_for('main.dashboard'), 'icon': '📊'},
    {'title': app.model_display_name, 'icon': '🤖'},
    {'title': app.app_name + ' #' + app.app_num|string, 'icon': '📱'}
] %}

{% block content %}
<div class="app-details">
    <!-- App Header -->
    <div class="app-details-header">
        <div class="app-title-section">
            <h1>{{ app.app_name }} <span class="app-number">#{{ app.app_num }}</span></h1>
            <p class="app-subtitle">Generated by {{ app.model_display_name }}</p>
            
            <!-- Live status indicator -->
            <div class="app-status-live" 
                 hx-get="{{ url_for('api.get_app_status', model=app.model, app_num=app.app_num) }}"
                 hx-trigger="load, every 10s"
                 hx-target="this"
                 hx-swap="outerHTML">
                <span class="status-indicator status-{{ app.status|default('unknown') }}">
                    <span class="status-dot"></span>
                    {{ app.status_display|default('Unknown') }}
                </span>
            </div>
        </div>
        
        <div class="app-actions-header">
            <!-- Container Controls -->
            {% if app.status == 'running' %}
            <button class="btn btn-success"
                    onclick="window.open('http://localhost:{{ app.ports.frontend }}', '_blank')">
                🌐 Open Frontend
            </button>
            <button class="btn btn-success"
                    onclick="window.open('http://localhost:{{ app.ports.backend }}', '_blank')">
                🔧 Open Backend
            </button>
            <button class="btn btn-warning"
                    hx-post="{{ url_for('docker.docker_action', action='restart', model=app.model, app_num=app.app_num) }}"
                    hx-target="#flash-messages"
                    hx-confirm="Restart containers?">
                🔄 Restart
            </button>
            <button class="btn btn-danger"
                    hx-post="{{ url_for('docker.docker_action', action='stop', model=app.model, app_num=app.app_num) }}"
                    hx-target="#flash-messages"
                    hx-confirm="Stop containers?">
                ⏹️ Stop
            </button>
            {% else %}
            <button class="btn btn-primary"
                    hx-post="{{ url_for('docker.docker_action', action='start', model=app.model, app_num=app.app_num) }}"
                    hx-target="#flash-messages">
                ▶️ Start Containers
            </button>
            {% endif %}
            
            <!-- Analysis Actions -->
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" data-dropdown="analysis-actions">
                    🔍 Run Analysis
                </button>
                <div class="dropdown-menu" id="analysis-actions">
                    <button class="dropdown-item"
                            hx-post="{{ url_for('analysis.run_analysis', analysis_type='security', model=app.model, app_num=app.app_num) }}"
                            hx-target="#analysis-security">
                        🛡️ Security Analysis
                    </button>
                    <button class="dropdown-item"
                            hx-post="{{ url_for('performance.run_performance_test', model=app.model, app_num=app.app_num) }}"
                            hx-target="#analysis-performance">
                        ⚡ Performance Test
                    </button>
                    <button class="dropdown-item"
                            hx-post="{{ url_for('zap.start_zap_scan', model=app.model, app_num=app.app_num) }}"
                            hx-target="#analysis-zap">
                        🕷️ ZAP Security Scan
                    </button>
                    <button class="dropdown-item"
                            hx-post="{{ url_for('openrouter.run_openrouter_analysis', model=app.model, app_num=app.app_num) }}"
                            hx-target="#analysis-openrouter">
                        🤖 AI Code Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- App Info Cards -->
    <div class="app-info-grid">
        <div class="info-card">
            <h3>📋 Application Info</h3>
            <div class="info-content">
                <div class="info-row">
                    <span class="info-label">Type:</span>
                    <span class="info-value">{{ app.app_type|default('Unknown') }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Model:</span>
                    <span class="info-value">{{ app.model_display_name }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Created:</span>
                    <span class="info-value">{{ app.created_date|format_datetime if app.created_date else 'Unknown' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Directory:</span>
                    <span class="info-value">{{ app.directory_path }}</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <h3>🌐 Network Configuration</h3>
            <div class="info-content">
                {% if app.ports %}
                <div class="info-row">
                    <span class="info-label">Frontend Port:</span>
                    <span class="info-value">
                        <a href="http://localhost:{{ app.ports.frontend }}" target="_blank" class="port-link">
                            {{ app.ports.frontend }}
                        </a>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Backend Port:</span>
                    <span class="info-value">
                        <a href="http://localhost:{{ app.ports.backend }}" target="_blank" class="port-link">
                            {{ app.ports.backend }}
                        </a>
                    </span>
                </div>
                {% else %}
                <p class="text-muted">No port configuration available</p>
                {% endif %}
            </div>
        </div>
        
        <div class="info-card">
            <h3>🐳 Container Status</h3>
            <div class="info-content" 
                 hx-get="{{ url_for('api.get_app_status', model=app.model, app_num=app.app_num) }}"
                 hx-trigger="load, every 15s"
                 hx-target="this"
                 hx-swap="innerHTML">
                {% if app.containers %}
                    {% for container_name, container_info in app.containers.items() %}
                    <div class="container-status">
                        <div class="container-name">{{ container_name }}</div>
                        <div class="container-state status-{{ container_info.status|lower }}">
                            {{ container_info.status }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-muted">No containers running</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tabbed Content Area -->
    <div class="app-content">
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="overview" 
                    hx-get="{{ url_for('main.app_details', model=app.model, app_num=app.app_num) }}?tab=overview"
                    hx-target="#tab-content">
                📊 Overview
            </button>
            <button class="tab-btn" data-tab="analysis" 
                    hx-get="{{ url_for('main.app_details', model=app.model, app_num=app.app_num) }}?tab=analysis"
                    hx-target="#tab-content">
                🔍 Analysis Results
            </button>
            <button class="tab-btn" data-tab="logs" 
                    hx-get="{{ url_for('docker.view_logs', model=app.model, app_num=app.app_num) }}"
                    hx-target="#tab-content">
                📜 Container Logs
            </button>
            <button class="tab-btn" data-tab="files" 
                    hx-get="{{ url_for('main.app_details', model=app.model, app_num=app.app_num) }}?tab=files"
                    hx-target="#tab-content">
                📁 Source Files
            </button>
        </div>
        
        <div id="tab-content" class="tab-content">
            {% include 'partials/app_overview.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Auto-refresh status every 30 seconds
    setInterval(function() {
        htmx.trigger('.app-status-live', 'load');
        htmx.trigger('.info-card .info-content[hx-get]', 'load');
    }, 30000);
});
</script>
{% endblock %}
