{% extends "base.html" %}

{% block title %}Create Batch Job - Thesis Research App{% endblock %}

{% block head %}
<style>
.form-section {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-section h5 {
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.model-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
}

.model-checkbox-item {
    background-color: white;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    transition: all 0.2s ease;
    cursor: pointer;
}

.model-checkbox-item:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.model-checkbox-item.selected {
    border-color: #007bff;
    background-color: #e7f3ff;
}

.analysis-type-card {
    background-color: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
    cursor: pointer;
}

.analysis-type-card:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.analysis-type-card.selected {
    border-color: #007bff;
    background-color: #e7f3ff;
}

.analysis-type-icon {
    width: 24px;
    height: 24px;
    margin-right: 0.5rem;
}

.app-range-input {
    max-width: 300px;
}

.validation-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.required-indicator {
    color: #dc3545;
}

.analysis-options {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
    display: none;
}

.analysis-options.active {
    display: block;
}

.option-group {
    margin-bottom: 1rem;
}

.option-group:last-child {
    margin-bottom: 0;
}

.submit-section {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
    padding: 1.5rem;
    margin-top: 2rem;
    border-radius: 0 0 8px 8px;
}

.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    align-items: center;
    margin: 0 1rem;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 0.5rem;
}

.step.active .step-number {
    background-color: #007bff;
    color: white;
}

.step.completed .step-number {
    background-color: #28a745;
    color: white;
}

.step-divider {
    width: 40px;
    height: 2px;
    background-color: #e9ecef;
    margin: 0 1rem;
}

.step.completed + .step-divider {
    background-color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Create Batch Analysis Job</h1>
                    <p class="text-muted mb-0">Configure and run analyses across multiple applications</p>
                </div>
                <a href="/batch" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step1">
            <div class="step-number">1</div>
            <span>Basic Info</span>
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <span>Analysis Types</span>
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <span>Models & Apps</span>
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step4">
            <div class="step-number">4</div>
            <span>Review</span>
        </div>
    </div>

    <form id="batchJobForm" method="POST" action="/batch/create">
        <!-- Basic Information -->
        <div class="form-section">
            <h5>
                <i class="fas fa-info-circle mr-2"></i>Basic Information
                <span class="required-indicator">*</span>
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="jobName" class="font-weight-bold">
                            Job Name <span class="required-indicator">*</span>
                        </label>
                        <input type="text" class="form-control" id="jobName" name="name" 
                               placeholder="Enter a descriptive name for this job" required>
                        <div class="validation-error" id="jobNameError"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="jobPriority" class="font-weight-bold">Priority</label>
                        <select class="form-control" id="jobPriority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="jobDescription" class="font-weight-bold">Description</label>
                <textarea class="form-control" id="jobDescription" name="description" rows="3"
                          placeholder="Optional description of what this job will accomplish"></textarea>
            </div>
        </div>

        <!-- Analysis Types -->
        <div class="form-section">
            <h5>
                <i class="fas fa-shield-alt mr-2"></i>Analysis Types
                <span class="required-indicator">*</span>
            </h5>
            <p class="text-muted mb-3">Select one or more analysis types to run on the selected applications.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="analysis-type-card" data-type="frontend_security">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                   id="frontend_security" name="analysis_types" value="frontend_security">
                            <label class="custom-control-label" for="frontend_security">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-code analysis-type-icon text-warning"></i>
                                    <div>
                                        <strong>Frontend Security</strong>
                                        <br>
                                        <small class="text-muted">ESLint, npm audit, dependency scanning</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="analysis-options" id="frontend_security_options">
                        <h6 class="font-weight-bold mb-3">Frontend Security Options</h6>
                        <div class="option-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="eslint_enabled" 
                                       name="frontend_options" value="eslint" checked>
                                <label class="custom-control-label" for="eslint_enabled">
                                    ESLint Code Analysis
                                </label>
                            </div>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="npm_audit_enabled" 
                                       name="frontend_options" value="npm_audit" checked>
                                <label class="custom-control-label" for="npm_audit_enabled">
                                    NPM Security Audit
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="analysis-type-card" data-type="backend_security">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                   id="backend_security" name="analysis_types" value="backend_security">
                            <label class="custom-control-label" for="backend_security">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-server analysis-type-icon text-danger"></i>
                                    <div>
                                        <strong>Backend Security</strong>
                                        <br>
                                        <small class="text-muted">Bandit, Safety, dependency scanning</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="analysis-options" id="backend_security_options">
                        <h6 class="font-weight-bold mb-3">Backend Security Options</h6>
                        <div class="option-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="bandit_enabled" 
                                       name="backend_options" value="bandit" checked>
                                <label class="custom-control-label" for="bandit_enabled">
                                    Bandit Security Linter
                                </label>
                            </div>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="safety_enabled" 
                                       name="backend_options" value="safety" checked>
                                <label class="custom-control-label" for="safety_enabled">
                                    Safety Vulnerability Scanner
                                </label>
                            </div>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="pylint_enabled" 
                                       name="backend_options" value="pylint">
                                <label class="custom-control-label" for="pylint_enabled">
                                    Pylint Code Quality
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="analysis-type-card" data-type="performance">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                   id="performance" name="analysis_types" value="performance">
                            <label class="custom-control-label" for="performance">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-chart-line analysis-type-icon text-primary"></i>
                                    <div>
                                        <strong>Performance Testing</strong>
                                        <br>
                                        <small class="text-muted">Load testing, response time analysis</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="analysis-options" id="performance_options">
                        <h6 class="font-weight-bold mb-3">Performance Testing Options</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="perf_users" class="font-weight-bold">Concurrent Users</label>
                                    <input type="number" class="form-control" id="perf_users" 
                                           name="perf_users" value="10" min="1" max="100">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="perf_duration" class="font-weight-bold">Duration (seconds)</label>
                                    <input type="number" class="form-control" id="perf_duration" 
                                           name="perf_duration" value="60" min="10" max="600">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="analysis-type-card" data-type="zap">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                   id="zap" name="analysis_types" value="zap">
                            <label class="custom-control-label" for="zap">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-bug analysis-type-icon text-info"></i>
                                    <div>
                                        <strong>ZAP Security Scan</strong>
                                        <br>
                                        <small class="text-muted">OWASP ZAP automated security testing</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="analysis-options" id="zap_options">
                        <h6 class="font-weight-bold mb-3">ZAP Scanning Options</h6>
                        <div class="option-group">
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" id="zap_quick" 
                                       name="zap_scan_type" value="quick" checked>
                                <label class="custom-control-label" for="zap_quick">
                                    Quick Scan (Faster, basic vulnerabilities)
                                </label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" id="zap_full" 
                                       name="zap_scan_type" value="full">
                                <label class="custom-control-label" for="zap_full">
                                    Full Scan (Comprehensive, takes longer)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="validation-error" id="analysisTypesError"></div>
        </div>

        <!-- Model and App Selection -->
        <div class="form-section">
            <h5>
                <i class="fas fa-robot mr-2"></i>AI Models & Applications
                <span class="required-indicator">*</span>
            </h5>
            
            <!-- Model Selection -->
            <div class="mb-4">
                <h6 class="font-weight-bold mb-3">
                    Select AI Models <span class="required-indicator">*</span>
                    <button type="button" class="btn btn-link btn-sm p-0 ml-2" id="selectAllModels">Select All</button>
                    <button type="button" class="btn btn-link btn-sm p-0 ml-2" id="clearAllModels">Clear All</button>
                </h6>
                <div class="model-grid" id="modelGrid">
                    {% for model in available_models %}
                    <div class="model-checkbox-item" data-model="{{ model.canonical_slug }}">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input model-checkbox" 
                                   id="model_{{ loop.index }}" name="models" value="{{ model.canonical_slug }}">
                            <label class="custom-control-label" for="model_{{ loop.index }}">
                                <div>
                                    <strong>{{ model.model_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ model.provider }}</small>
                                    {% if model.is_free %}
                                    <span class="badge badge-success badge-sm">Free</span>
                                    {% endif %}
                                </div>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="validation-error" id="modelsError"></div>
            </div>

            <!-- App Range Selection -->
            <div class="mb-4">
                <h6 class="font-weight-bold mb-3">
                    Application Range <span class="required-indicator">*</span>
                </h6>
                <p class="text-muted mb-3">
                    Specify which applications to analyze. Each model has apps numbered 1-30.
                    You can specify ranges (e.g., "1-5") or individual numbers (e.g., "1,3,7,10-15").
                </p>
                <div class="app-range-input">
                    <input type="text" class="form-control" id="appRange" name="app_range" 
                           placeholder="e.g., 1-5,10,15-20 or all" value="1-5">
                    <small class="form-text text-muted">
                        Examples: "all" (all 30 apps), "1,5,10" (specific apps), "1-5,20-25" (ranges)
                    </small>
                    <div class="validation-error" id="appRangeError"></div>
                </div>
            </div>

            <!-- Execution Options -->
            <div class="mb-4">
                <h6 class="font-weight-bold mb-3">Execution Options</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="autoStart" 
                                   name="auto_start" value="true" checked>
                            <label class="custom-control-label" for="autoStart">
                                <strong>Auto-start job immediately</strong>
                                <br>
                                <small class="text-muted">Start execution right after creation</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="stopOnError" 
                                   name="stop_on_error" value="true">
                            <label class="custom-control-label" for="stopOnError">
                                <strong>Stop on first error</strong>
                                <br>
                                <small class="text-muted">Halt execution if any task fails</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">Ready to create batch job?</h6>
                    <small class="text-muted">
                        This will create <span id="estimatedTasks">0</span> analysis tasks across 
                        <span id="selectedModelsCount">0</span> models and <span id="selectedAppsCount">0</span> applications.
                    </small>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-secondary mr-2" onclick="history.back()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-play mr-2"></i>Create & Start Job
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('batchJobForm');
    const analysisTypeCheckboxes = document.querySelectorAll('.analysis-type-checkbox');
    const modelCheckboxes = document.querySelectorAll('.model-checkbox');
    const appRangeInput = document.getElementById('appRange');

    // Analysis type selection handling
    analysisTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const card = this.closest('.analysis-type-card');
            const options = document.getElementById(this.value + '_options');
            
            if (this.checked) {
                card.classList.add('selected');
                if (options) options.classList.add('active');
            } else {
                card.classList.remove('selected');
                if (options) options.classList.remove('active');
            }
            
            updateEstimates();
            validateAnalysisTypes();
        });
    });

    // Model selection handling
    modelCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.model-checkbox-item');
            if (this.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            
            updateEstimates();
            validateModels();
        });
    });

    // Model selection helpers
    document.getElementById('selectAllModels').addEventListener('click', function() {
        modelCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            checkbox.closest('.model-checkbox-item').classList.add('selected');
        });
        updateEstimates();
        validateModels();
    });

    document.getElementById('clearAllModels').addEventListener('click', function() {
        modelCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.model-checkbox-item').classList.remove('selected');
        });
        updateEstimates();
        validateModels();
    });

    // App range input handling
    appRangeInput.addEventListener('input', function() {
        updateEstimates();
        validateAppRange();
    });

    // Form validation
    function validateAnalysisTypes() {
        const checkedTypes = document.querySelectorAll('.analysis-type-checkbox:checked');
        const errorDiv = document.getElementById('analysisTypesError');
        
        if (checkedTypes.length === 0) {
            errorDiv.textContent = 'Please select at least one analysis type.';
            return false;
        } else {
            errorDiv.textContent = '';
            return true;
        }
    }

    function validateModels() {
        const checkedModels = document.querySelectorAll('.model-checkbox:checked');
        const errorDiv = document.getElementById('modelsError');
        
        if (checkedModels.length === 0) {
            errorDiv.textContent = 'Please select at least one AI model.';
            return false;
        } else {
            errorDiv.textContent = '';
            return true;
        }
    }

    function validateAppRange() {
        const range = appRangeInput.value.trim();
        const errorDiv = document.getElementById('appRangeError');
        
        if (!range) {
            errorDiv.textContent = 'Please specify an application range.';
            return false;
        }

        // Handle "all" keyword
        if (range.toLowerCase() === 'all') {
            errorDiv.textContent = '';
            return true;
        }

        // Validate range format
        const parts = range.split(',');
        const validPattern = /^\d+(-\d+)?$/;
        
        for (let part of parts) {
            part = part.trim();
            if (!validPattern.test(part)) {
                errorDiv.textContent = 'Invalid range format. Use numbers and ranges like "1-5,10,15-20" or "all".';
                return false;
            }
            
            // Check if range makes sense
            if (part.includes('-')) {
                const [start, end] = part.split('-').map(n => parseInt(n));
                if (start >= end) {
                    errorDiv.textContent = 'Invalid range: start must be less than end.';
                    return false;
                }
                if (start < 1 || end > 30) {
                    errorDiv.textContent = 'App numbers must be between 1 and 30.';
                    return false;
                }
            } else {
                const num = parseInt(part);
                if (num < 1 || num > 30) {
                    errorDiv.textContent = 'App numbers must be between 1 and 30.';
                    return false;
                }
            }
        }
        
        errorDiv.textContent = '';
        return true;
    }

    function validateJobName() {
        const name = document.getElementById('jobName').value.trim();
        const errorDiv = document.getElementById('jobNameError');
        
        if (!name) {
            errorDiv.textContent = 'Job name is required.';
            return false;
        } else if (name.length < 3) {
            errorDiv.textContent = 'Job name must be at least 3 characters long.';
            return false;
        } else {
            errorDiv.textContent = '';
            return true;
        }
    }

    // Update estimates
    function updateEstimates() {
        const selectedAnalysisTypes = document.querySelectorAll('.analysis-type-checkbox:checked').length;
        const selectedModels = document.querySelectorAll('.model-checkbox:checked').length;
        const appRange = parseAppRange(appRangeInput.value);
        
        const estimatedTasks = selectedAnalysisTypes * selectedModels * appRange.length;
        
        document.getElementById('estimatedTasks').textContent = estimatedTasks;
        document.getElementById('selectedModelsCount').textContent = selectedModels;
        document.getElementById('selectedAppsCount').textContent = appRange.length;
    }

    function parseAppRange(rangeStr) {
        if (!rangeStr) return [];
        
        // Handle "all" keyword
        if (rangeStr.trim().toLowerCase() === 'all') {
            const apps = [];
            for (let i = 1; i <= 30; i++) {
                apps.push(i);
            }
            return apps;
        }
        
        const apps = new Set();
        const parts = rangeStr.split(',');
        
        try {
            for (let part of parts) {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(n => parseInt(n));
                    for (let i = start; i <= end; i++) {
                        apps.add(i);
                    }
                } else {
                    apps.add(parseInt(part));
                }
            }
        } catch (e) {
            return [];
        }
        
        return Array.from(apps).sort((a, b) => a - b);
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const isValidName = validateJobName();
        const isValidTypes = validateAnalysisTypes();
        const isValidModels = validateModels();
        const isValidRange = validateAppRange();
        
        if (!isValidName || !isValidTypes || !isValidModels || !isValidRange) {
            showToast('Please fix the validation errors before submitting.', 'error');
            return;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Job...';
        
        // Submit form via fetch
        const formData = new FormData(form);
        
        fetch('/batch/create', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Batch job created successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/batch/job/' + data.job_id;
                }, 1500);
            } else {
                showToast(data.error || 'Failed to create job', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error creating job:', error);
            showToast('Failed to create job', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });

    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '9999';
        toast.style.maxWidth = '400px';
        
        toast.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // Initialize
    updateEstimates();
});
</script>
{% endblock %}
