{# Pipeline Executions - Compact List with Pagination #}

<div class="card card-table-compact" id="pipeline-executions-section">
  <div class="card-header d-flex align-items-center gap-2 py-2">
    <i class="fa-solid fa-history text-primary"></i>
    <h3 class="card-title mb-0">Pipeline Executions</h3>
    {% if recent_pipelines %}
    <span class="badge bg-primary-lt ms-1" id="pipeline-total-count">{{ recent_pipelines|length }}</span>
    <div class="ms-auto d-flex align-items-center gap-2">
      <input type="search" class="form-control form-control-sm" placeholder="Filter..." id="pipeline-filter-input"
             style="width: 140px; height: 26px; font-size: 0.75rem;" oninput="filterPipelines(this.value)">
    </div>
    {% endif %}
  </div>

  <div class="card-body border-top p-0">
    {% if recent_pipelines and recent_pipelines|length > 0 %}
    <div class="table-responsive" id="pipeline-table-scroll" style="max-height: calc(100vh - 340px); min-height: 200px; overflow-y: auto;">
      <table class="table table-sm table-vcenter table-hover card-table mb-0" id="pipeline-table">
        <thead class="sticky-top bg-body" style="z-index: 2;">
          <tr>
            <th class="w-1"></th>
            <th>Pipeline</th>
            <th>Status</th>
            <th class="d-none d-md-table-cell">Progress</th>
            <th class="d-none d-lg-table-cell">Date</th>
            <th class="w-1"></th>
          </tr>
        </thead>
        <tbody id="pipeline-tbody">
          {% for pipeline in recent_pipelines %}
          {% set status_colors = {
            'pending': 'secondary', 'running': 'primary', 'paused': 'warning',
            'completed': 'success', 'partial_success': 'warning',
            'failed': 'danger', 'cancelled': 'secondary'
          } %}
          {% set sc = status_colors.get(pipeline.status, 'secondary') %}
          {% set progress = [pipeline.overall_progress|default(0), 100]|min %}
          <tr class="pipeline-item" data-pipeline-id="{{ pipeline.id }}" data-status="{{ pipeline.status }}"
              data-name="{{ (pipeline.name or '')|lower }}" style="cursor: pointer;"
              onclick="openPipelineProgressModal('{{ pipeline.id }}')">
            <td>
              {% if pipeline.status == 'running' %}
              <span class="status-dot status-dot-animated bg-{{ sc }}"></span>
              {% else %}
              <span class="status-dot bg-{{ sc }}"></span>
              {% endif %}
            </td>
            <td>
              <div class="fw-medium text-truncate" style="max-width: 250px;">{{ pipeline.name or 'Pipeline #' ~ pipeline.id[:8] }}</div>
            </td>
            <td>
              <span class="badge bg-{{ sc }}-lt text-{{ sc }}" style="font-size: 0.7em;">
                {% if pipeline.status == 'running' %}<i class="fa-solid fa-spinner fa-spin me-1"></i>{% endif %}
                {{ pipeline.status|replace('_', ' ')|title }}
                {% if pipeline.status == 'running' and progress > 0 %}<span class="ms-1">{{ progress|int }}%</span>{% endif %}
              </span>
            </td>
            <td class="d-none d-md-table-cell" style="min-width: 100px;">
              <div class="d-flex align-items-center gap-1">
                <div class="progress flex-fill" style="height: 3px;">
                  <div class="progress-bar bg-{{ sc }}
                    {% if pipeline.status == 'running' %} progress-bar-striped progress-bar-animated{% endif %}"
                    style="width: {{ progress }}%"></div>
                </div>
                <span class="text-muted" style="font-size: 0.7em; min-width: 24px;">{{ progress|int }}%</span>
              </div>
            </td>
            <td class="d-none d-lg-table-cell text-muted pipeline-date" style="font-size: 0.75em;"
                data-ts="{{ pipeline.started_at or pipeline.created_at }}">
              {{ pipeline.started_at or pipeline.created_at }}
            </td>
            <td>
              <div class="d-flex align-items-center gap-1">
                {% if pipeline.status == 'running' %}
                <button class="btn btn-sm btn-ghost-danger py-0 px-1"
                  onclick="event.stopPropagation(); cancelPipelineById('{{ pipeline.id }}')" title="Cancel">
                  <i class="fa-solid fa-stop" style="font-size: 0.65em;"></i>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Pagination footer #}
    <div class="card-footer d-flex align-items-center justify-content-between py-1 px-3" id="pipeline-pagination">
      <span class="small text-muted" id="pipeline-page-info">Showing 1–{{ [recent_pipelines|length, 5]|min }} of {{ recent_pipelines|length }}</span>
      <div class="d-flex gap-1">
        <button class="btn btn-sm btn-ghost-secondary py-0 px-2" id="pipeline-prev-page" onclick="pipelinePrevPage()" disabled>
          <i class="fa-solid fa-chevron-left" style="font-size: 0.7em;"></i>
        </button>
        <span class="small text-muted align-self-center" id="pipeline-page-num">1</span>
        <button class="btn btn-sm btn-ghost-secondary py-0 px-2" id="pipeline-next-page" onclick="pipelineNextPage()">
          <i class="fa-solid fa-chevron-right" style="font-size: 0.7em;"></i>
        </button>
      </div>
    </div>
    {% else %}
    <div class="text-center py-3 text-muted">
      <i class="fa-solid fa-inbox mb-1 opacity-50"></i>
      <p class="small mb-0">No pipeline executions yet</p>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .pipeline-item:hover { background-color: rgba(var(--tblr-primary-rgb), 0.03); }
  #pipeline-table-scroll::-webkit-scrollbar { width: 4px; }
  #pipeline-table-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 2px; }
</style>

<script>
  // Format timestamps
  document.querySelectorAll('.pipeline-date[data-ts]').forEach(el => {
    try {
      const d = new Date(el.dataset.ts);
      if (isNaN(d)) return;
      const now = new Date(), diff = now - d;
      if (diff < 86400000) el.textContent = 'Today ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      else if (diff < 172800000) el.textContent = 'Yesterday ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      else el.textContent = d.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    } catch(e) {}
  });

  // Client-side pagination
  const PIPELINES_PER_PAGE = 5;
  let currentPipelinePage = 1;
  let filteredPipelineIds = null;

  function getAllPipelineRows() {
    return Array.from(document.querySelectorAll('#pipeline-tbody > tr.pipeline-item'));
  }

  function getVisiblePipelineRows() {
    const all = getAllPipelineRows();
    if (filteredPipelineIds === null) return all;
    return all.filter(r => filteredPipelineIds.has(r.dataset.pipelineId));
  }

  function updatePipelinePagination() {
    const rows = getVisiblePipelineRows();
    const totalPages = Math.max(1, Math.ceil(rows.length / PIPELINES_PER_PAGE));
    if (currentPipelinePage > totalPages) currentPipelinePage = totalPages;

    const start = (currentPipelinePage - 1) * PIPELINES_PER_PAGE;
    const end = start + PIPELINES_PER_PAGE;

    getAllPipelineRows().forEach(r => { r.style.display = 'none'; });
    rows.forEach((r, i) => {
      if (i >= start && i < end) r.style.display = '';
    });

    const pageInfo = document.getElementById('pipeline-page-info');
    const pageNum = document.getElementById('pipeline-page-num');
    const prevBtn = document.getElementById('pipeline-prev-page');
    const nextBtn = document.getElementById('pipeline-next-page');
    const totalBadge = document.getElementById('pipeline-total-count');

    if (pageInfo) pageInfo.textContent = `Showing ${rows.length ? start + 1 : 0}–${Math.min(end, rows.length)} of ${rows.length}`;
    if (pageNum) pageNum.textContent = `${currentPipelinePage}/${totalPages}`;
    if (prevBtn) prevBtn.disabled = currentPipelinePage <= 1;
    if (nextBtn) nextBtn.disabled = currentPipelinePage >= totalPages;
    if (totalBadge) totalBadge.textContent = rows.length;

    const pag = document.getElementById('pipeline-pagination');
    if (pag) pag.style.display = rows.length <= PIPELINES_PER_PAGE ? 'none' : '';
  }

  function pipelineNextPage() { currentPipelinePage++; updatePipelinePagination(); }
  function pipelinePrevPage() { currentPipelinePage--; updatePipelinePagination(); }

  function filterPipelines(query) {
    const q = query.trim().toLowerCase();
    if (!q) {
      filteredPipelineIds = null;
    } else {
      filteredPipelineIds = new Set();
      getAllPipelineRows().forEach(r => {
        const name = r.dataset.name || '';
        const status = r.dataset.status || '';
        const pid = r.dataset.pipelineId || '';
        if (name.includes(q) || status.includes(q) || pid.includes(q)) {
          filteredPipelineIds.add(r.dataset.pipelineId);
        }
      });
    }
    currentPipelinePage = 1;
    updatePipelinePagination();
  }

  // Initialize pagination
  document.addEventListener('DOMContentLoaded', () => {
    updatePipelinePagination();
  });

  function cancelPipelineById(pipelineId) {
    if (!confirm('Cancel this pipeline?')) return;
    fetch(`/automation/api/pipeline/${pipelineId}/cancel`, {
      method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(r => r.json())
      .then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); })
      .catch(() => alert('Error cancelling'));
  }
</script>