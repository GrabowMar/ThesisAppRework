{# Pipeline Executions - Consistent with Page Style #}
{# Uses the same card-table-compact style as Step cards #}

<div class="card card-table-compact" id="pipeline-executions-section">
  <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-secondary text-uppercase rounded-pill px-3">History</span>
      <div>
        <h3 class="card-title mb-0 d-flex align-items-center gap-2">
          <i class="fas fa-history text-primary"></i>
          <span>Pipeline Executions</span>
        </h3>
        <div class="text-muted small">Monitor running and view past pipelines</div>
      </div>
    </div>
    <div class="ms-auto">
      {% if recent_pipelines %}
      <span class="badge bg-primary-lt">{{ recent_pipelines|length }} total</span>
      {% endif %}
    </div>
  </div>

  <div class="card-body border-top p-0">
    {% if recent_pipelines and recent_pipelines|length > 0 %}
    <div class="pipeline-list">
      {% for pipeline in recent_pipelines %}
      <div class="pipeline-item border-bottom" data-pipeline-id="{{ pipeline.id }}">
        {# Pipeline Row - Compact Layout #}
        <div class="pipeline-row px-3 py-2" role="button" onclick="togglePipelineDetails('{{ pipeline.id }}')">
          <div class="row align-items-center g-2">
            {# Status & Name #}
            <div class="col-lg-4 col-md-5">
              <div class="d-flex align-items-center gap-2">
                {% if pipeline.status == 'running' %}
                <span class="status-dot status-dot-animated bg-primary"></span>
                {% elif pipeline.status == 'completed' %}
                <span class="status-dot bg-success"></span>
                {% elif pipeline.status == 'partial_success' %}
                <span class="status-dot bg-warning"></span>
                {% elif pipeline.status == 'failed' %}
                <span class="status-dot bg-danger"></span>
                {% else %}
                <span class="status-dot bg-secondary"></span>
                {% endif %}
                <div class="min-width-0">
                  <div class="fw-medium text-truncate">{{ pipeline.name or 'Pipeline #' ~ pipeline.id[:8] }}</div>
                  <code class="text-muted small">{{ pipeline.id[:12] }}...</code>
                </div>
              </div>
            </div>

            {# Status Badge #}
            <div class="col-lg-2 col-md-2 col-4">
              {% set status_colors = {
              'pending': 'bg-secondary-lt text-secondary',
              'running': 'bg-primary-lt text-primary',
              'paused': 'bg-warning-lt text-warning',
              'completed': 'bg-success-lt text-success',
              'partial_success': 'bg-warning-lt text-warning',
              'failed': 'bg-danger-lt text-danger',
              'cancelled': 'bg-secondary-lt text-secondary'
              } %}
              <span class="badge {{ status_colors.get(pipeline.status, 'bg-secondary-lt') }}">
                {% if pipeline.status == 'running' %}
                <i class="fas fa-spinner fa-spin me-1"></i>
                {% endif %}
                {{ pipeline.status|replace('_', ' ')|title }}
              </span>
            </div>

            {# Progress #}
            <div class="col-lg-3 col-md-3 col-4">
              {% set progress = [pipeline.overall_progress|default(0), 100]|min %}
              <div class="d-flex align-items-center gap-2">
                <div class="progress flex-fill" style="height: 6px;">
                  <div class="progress-bar 
                    {% if pipeline.status == 'completed' %}bg-success
                    {% elif pipeline.status == 'partial_success' %}bg-warning
                    {% elif pipeline.status == 'failed' %}bg-danger
                    {% elif pipeline.status == 'running' %}progress-bar-striped progress-bar-animated bg-primary
                    {% else %}bg-secondary{% endif %}" style="width: {{ progress }}%"></div>
                </div>
                <span class="small text-muted" style="min-width: 35px;">{{ progress|int }}%</span>
              </div>
            </div>

            {# Actions #}
            <div class="col-lg-3 col-md-2 col-4">
              <div class="d-flex align-items-center justify-content-end gap-1">
                <span class="text-muted small d-none d-md-inline me-2">
                  {% if pipeline.started_at %}{{ pipeline.started_at }}{% else %}{{ pipeline.created_at }}{% endif %}
                </span>
                <button class="btn btn-sm btn-ghost-secondary expand-toggle" data-pipeline-id="{{ pipeline.id }}"
                  onclick="event.stopPropagation(); togglePipelineDetails('{{ pipeline.id }}')" title="Toggle Details">
                  <i class="fas fa-chevron-down"></i>
                </button>
                {% if pipeline.status == 'running' %}
                <button class="btn btn-sm btn-ghost-danger"
                  onclick="event.stopPropagation(); cancelPipelineById('{{ pipeline.id }}')" title="Cancel Pipeline">
                  <i class="fas fa-stop"></i>
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {# Expandable Details Panel #}
        <div class="collapse" id="pipeline-details-{{ pipeline.id }}">
          <div class="border-top bg-light">
            {# Compact Tabs #}
            <ul class="nav nav-tabs nav-fill border-bottom" role="tablist">
              <li class="nav-item">
                <button class="nav-link active py-2 small" data-bs-toggle="tab"
                  data-bs-target="#gen-tab-{{ pipeline.id }}" type="button">
                  <i class="fas fa-code me-1 text-primary"></i>Generation
                  <span class="badge bg-secondary-lt ms-1 gen-count" data-pipeline="{{ pipeline.id }}">--</span>
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link py-2 small" data-bs-toggle="tab"
                  data-bs-target="#analysis-tab-{{ pipeline.id }}" type="button">
                  <i class="fas fa-search-plus me-1 text-success"></i>Analysis
                  <span class="badge bg-secondary-lt ms-1 analysis-count" data-pipeline="{{ pipeline.id }}">--</span>
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link py-2 small" data-bs-toggle="tab"
                  data-bs-target="#activity-tab-{{ pipeline.id }}" type="button">
                  <i class="fas fa-stream me-1 text-info"></i>Activity
                  <span class="badge bg-secondary-lt ms-1 activity-count" data-pipeline="{{ pipeline.id }}">--</span>
                </button>
              </li>
            </ul>

            {# Tab Content #}
            <div class="tab-content p-3">
              {# Generation Jobs #}
              <div class="tab-pane fade show active" id="gen-tab-{{ pipeline.id }}">
                <div class="generation-jobs-container" data-pipeline="{{ pipeline.id }}">
                  <div class="text-center py-3 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>Loading...
                  </div>
                </div>
              </div>

              {# Analysis Tasks #}
              <div class="tab-pane fade" id="analysis-tab-{{ pipeline.id }}">
                <div class="analysis-tasks-container" data-pipeline="{{ pipeline.id }}">
                  <div class="text-center py-3 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>Loading...
                  </div>
                </div>
              </div>

              {# Activity Log #}
              <div class="tab-pane fade" id="activity-tab-{{ pipeline.id }}">
                <div class="activity-container" data-pipeline="{{ pipeline.id }}"
                  style="max-height: 250px; overflow-y: auto; font-family: var(--tblr-font-monospace); font-size: 11px;">
                  <div class="text-center py-3 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>Loading...
                  </div>
                </div>
              </div>
            </div>

            {# Footer Actions #}
            <div class="border-top px-3 py-2 d-flex justify-content-between align-items-center bg-white">
              <div class="small text-muted">
                {% if pipeline.status == 'running' %}
                <span class="badge bg-primary-lt"><i class="fas fa-sync-alt fa-spin me-1"></i>Auto-updating</span>
                {% elif pipeline.completed_at %}
                Completed: {{ pipeline.completed_at }}
                {% endif %}
              </div>
              <div class="d-flex gap-2">
                {% if pipeline.status in ['completed', 'partial_success'] %}
                <a href="{{ url_for('analysis.analysis_index') }}" class="btn btn-sm btn-outline-success">
                  <i class="fas fa-chart-bar me-1"></i>Results
                </a>
                {% endif %}
                {% if pipeline.status == 'running' %}
                <button class="btn btn-sm btn-outline-primary" onclick="openPipelineProgressModal('{{ pipeline.id }}')">
                  <i class="fas fa-expand-alt me-1"></i>Full View
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4 text-muted">
      <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
      <p class="mb-1">No pipeline executions</p>
      <p class="small mb-0">Configure and run your first pipeline below</p>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .pipeline-item {
    transition: background-color 0.15s ease;
  }

  .pipeline-item:hover {
    background-color: rgba(var(--tblr-primary-rgb), 0.02);
  }

  .pipeline-row {
    cursor: pointer;
  }

  .expand-toggle {
    transition: transform 0.2s ease;
  }

  .expand-toggle.expanded {
    transform: rotate(180deg);
  }

  .min-width-0 {
    min-width: 0;
  }

  /* Task Cards - Match tool cards style */
  .task-card {
    border: 1px solid var(--tblr-border-color);
    border-radius: var(--tblr-border-radius);
    transition: all 0.15s ease;
  }

  .task-card:hover {
    border-color: var(--tblr-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
  }

  .task-card.status-completed {
    border-left: 3px solid var(--tblr-success);
  }

  .task-card.status-running {
    border-left: 3px solid var(--tblr-primary);
    background-color: rgba(var(--tblr-primary-rgb), 0.02);
  }

  .task-card.status-failed {
    border-left: 3px solid var(--tblr-danger);
    background-color: rgba(var(--tblr-danger-rgb), 0.02);
  }

  .task-card.status-pending {
    border-left: 3px solid var(--tblr-secondary);
    opacity: 0.7;
  }

  /* Activity event */
  .event-row {
    padding: 0.375rem 0.5rem;
    border-bottom: 1px solid var(--tblr-border-color-light);
  }

  .event-row:last-child {
    border-bottom: none;
  }

  .event-row.level-error {
    background-color: rgba(var(--tblr-danger-rgb), 0.05);
  }
</style>

<script>
  // Pipeline expansion state & polling
  const pipelinePollingIntervals = {};
  const expandedPipelines = new Set();

  function togglePipelineDetails(pipelineId) {
    const detailsEl = document.getElementById(`pipeline-details-${pipelineId}`);
    const toggleBtn = document.querySelector(`.expand-toggle[data-pipeline-id="${pipelineId}"]`);

    if (!detailsEl) return;

    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(detailsEl, { toggle: false });

    if (expandedPipelines.has(pipelineId)) {
      bsCollapse.hide();
      expandedPipelines.delete(pipelineId);
      toggleBtn?.classList.remove('expanded');
      stopPipelinePolling(pipelineId);
    } else {
      bsCollapse.show();
      expandedPipelines.add(pipelineId);
      toggleBtn?.classList.add('expanded');
      loadPipelineDetails(pipelineId);
    }
  }

  async function loadPipelineDetails(pipelineId) {
    try {
      const response = await fetch(`/automation/api/pipeline/${pipelineId}/detailed-status`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!response.ok) throw new Error('Failed to fetch');

      const result = await response.json();
      if (result.success) {
        renderPipelineDetails(pipelineId, result.data);
        if (result.data.status === 'running') {
          startPipelinePolling(pipelineId);
        }
      }
    } catch (error) {
      console.error('Error loading pipeline:', error);
    }
  }

  function startPipelinePolling(pipelineId) {
    stopPipelinePolling(pipelineId);
    pipelinePollingIntervals[pipelineId] = setInterval(() => {
      if (expandedPipelines.has(pipelineId)) {
        loadPipelineDetails(pipelineId);
      } else {
        stopPipelinePolling(pipelineId);
      }
    }, 2000);
  }

  function stopPipelinePolling(pipelineId) {
    if (pipelinePollingIntervals[pipelineId]) {
      clearInterval(pipelinePollingIntervals[pipelineId]);
      delete pipelinePollingIntervals[pipelineId];
    }
  }

  function renderPipelineDetails(pipelineId, data) {
    const genJobs = data.generation_jobs || [];
    const analysisTasks = data.analysis_tasks || [];
    const events = data.events || [];

    // Update counts
    document.querySelector(`.gen-count[data-pipeline="${pipelineId}"]`).textContent =
      `${genJobs.filter(j => j.success).length}/${genJobs.length}`;
    document.querySelector(`.analysis-count[data-pipeline="${pipelineId}"]`).textContent =
      `${analysisTasks.filter(t => t.status === 'completed').length}/${analysisTasks.length}`;
    document.querySelector(`.activity-count[data-pipeline="${pipelineId}"]`).textContent = events.length;

    renderGenerationJobs(pipelineId, genJobs);
    renderAnalysisTasks(pipelineId, analysisTasks);
    renderActivity(pipelineId, events);

    // Update progress in header
    const progressBar = document.querySelector(`.pipeline-item[data-pipeline-id="${pipelineId}"] .progress-bar`);
    if (progressBar) {
      const progress = Math.min(data.overall_progress || 0, 100);
      progressBar.style.width = `${progress}%`;
    }

    if (['completed', 'failed', 'cancelled', 'partial_success'].includes(data.status)) {
      stopPipelinePolling(pipelineId);
    }
  }

  function renderGenerationJobs(pipelineId, jobs) {
    const container = document.querySelector(`.generation-jobs-container[data-pipeline="${pipelineId}"]`);
    if (!container) return;

    if (!jobs || jobs.length === 0) {
      container.innerHTML = `<div class="text-center py-3 text-muted"><i class="fas fa-inbox me-1"></i>No jobs</div>`;
      return;
    }

    container.innerHTML = `<div class="row g-2">${jobs.map(job => {
      const status = job.success ? 'completed' : (job.error ? 'failed' : 'running');
      const icon = job.success ? 'fa-check text-success' : (job.error ? 'fa-times text-danger' : 'fa-spinner fa-spin text-primary');
      return `
        <div class="col-md-6 col-lg-4">
          <div class="task-card status-${status} p-2">
            <div class="d-flex align-items-start gap-2">
              <i class="fas ${icon} mt-1"></i>
              <div class="min-width-0 flex-fill">
                <div class="fw-medium text-truncate">${job.model_slug || 'Unknown'}</div>
                <div class="text-muted small text-truncate">${job.template_slug || '-'}${job.app_number ? ' â€¢ #' + job.app_number : ''}</div>
                ${job.duration ? `<span class="badge bg-secondary-lt mt-1">${job.duration.toFixed(1)}s</span>` : ''}
                ${job.error ? `<div class="text-danger small text-truncate mt-1" title="${job.error}">${job.error}</div>` : ''}
              </div>
            </div>
          </div>
        </div>`;
    }).join('')}</div>`;
  }

  function renderAnalysisTasks(pipelineId, tasks) {
    const container = document.querySelector(`.analysis-tasks-container[data-pipeline="${pipelineId}"]`);
    if (!container) return;

    if (!tasks || tasks.length === 0) {
      container.innerHTML = `<div class="text-center py-3 text-muted"><i class="fas fa-inbox me-1"></i>No tasks</div>`;
      return;
    }

    const statusIcons = {
      'pending': 'fa-clock text-muted',
      'running': 'fa-spinner fa-spin text-primary',
      'completed': 'fa-check text-success',
      'failed': 'fa-times text-danger',
      'cancelled': 'fa-ban text-warning'
    };

    container.innerHTML = `<div class="row g-2">${tasks.map(task => {
      const status = (task.status || 'pending').toLowerCase();
      const icon = statusIcons[status] || 'fa-question text-muted';
      const progress = task.progress_percentage || 0;
      return `
        <div class="col-md-6 col-lg-4">
          <div class="task-card status-${status} p-2">
            <div class="d-flex align-items-start gap-2">
              <i class="fas ${icon} mt-1"></i>
              <div class="min-width-0 flex-fill">
                <div class="fw-medium text-truncate">${task.target_model || 'Unknown'}</div>
                <div class="text-muted small">App #${task.target_app_number || '?'}</div>
                ${status === 'running' ? `
                  <div class="progress mt-1" style="height: 3px;">
                    <div class="progress-bar" style="width: ${progress}%"></div>
                  </div>
                ` : ''}
                ${task.error_message ? `<div class="text-danger small text-truncate mt-1">${task.error_message}</div>` : ''}
              </div>
            </div>
          </div>
        </div>`;
    }).join('')}</div>`;
  }

  function renderActivity(pipelineId, events) {
    const container = document.querySelector(`.activity-container[data-pipeline="${pipelineId}"]`);
    if (!container) return;

    if (!events || events.length === 0) {
      container.innerHTML = `<div class="text-center py-3 text-muted"><i class="fas fa-stream me-1"></i>No activity</div>`;
      return;
    }

    const colors = { 'info': 'text-primary', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger' };
    const icons = { 'info': 'fa-info-circle', 'success': 'fa-check-circle', 'warning': 'fa-exclamation-triangle', 'error': 'fa-times-circle' };

    container.innerHTML = events.map(e => {
      const level = e.level || 'info';
      const ts = e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : '';
      return `
        <div class="event-row level-${level} d-flex gap-2">
          <span class="text-muted" style="min-width: 55px;">${ts}</span>
          <i class="fas ${icons[level] || 'fa-circle'} ${colors[level] || 'text-muted'}"></i>
          <span class="flex-fill">${e.stage ? `<span class="badge bg-secondary-lt me-1">${e.stage}</span>` : ''}${e.message}</span>
        </div>`;
    }).join('');
  }

  function cancelPipelineById(pipelineId) {
    if (!confirm('Cancel this pipeline?')) return;
    fetch(`/automation/api/pipeline/${pipelineId}/cancel`, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(r => r.json())
      .then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); })
      .catch(() => alert('Error cancelling'));
  }

  window.addEventListener('beforeunload', () => {
    Object.keys(pipelinePollingIntervals).forEach(stopPipelinePolling);
  });
</script>