{# Pipeline Progress Detail Modal #}
<div class="modal fade" id="pipelineProgressModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex align-items-center gap-3">
          <i class="fa-solid fa-tasks text-primary fs-3"></i>
          <div>
            <h5 class="modal-title mb-0">Pipeline Progress</h5>
            <small class="text-muted" id="progress-modal-pipeline-id">--</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <span class="badge fs-6" id="progress-modal-status-badge">--</span>
          <span class="text-muted" id="progress-modal-elapsed">00:00</span>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>

      <div class="modal-body p-0">
        {# Compact Header #}
        <div class="bg-body-secondary px-3 py-2 border-bottom">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3 flex-fill">
              <div class="fw-semibold">Overall Progress</div>
              <div class="progress flex-fill" style="height: 12px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                  id="progress-modal-overall-bar" style="width: 0%"></div>
              </div>
              <div class="fw-bold" id="progress-modal-overall-pct">0%</div>
            </div>
            <div class="d-flex gap-3 ms-4 small text-muted">
              <div><span class="fw-bold text-success" id="progress-modal-completed">0</span> Completed</div>
              <div><span class="fw-bold text-primary" id="progress-modal-running">0</span> Running</div>
              <div><span class="fw-bold text-danger" id="progress-modal-failed">0</span> Failed</div>
            </div>
          </div>
        </div>

        {# Stage Tabs - Sticky #}
        <div class="bg-body sticky-top border-bottom">
          <ul class="nav nav-tabs nav-fill px-3 pt-2 mb-0 border-bottom-0" role="tablist">
            <li class="nav-item">
              <button class="nav-link active fw-bold py-2" data-bs-toggle="tab" data-bs-target="#tab-generation"
                type="button" id="btn-tab-generation">
                <i class="fa-solid fa-code me-1"></i>Generation
                <span class="badge bg-secondary-lt ms-1" id="tab-gen-count">0/0</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link fw-bold py-2" data-bs-toggle="tab" data-bs-target="#tab-analysis" type="button"
                id="btn-tab-analysis">
                <i class="fa-solid fa-search-plus me-1"></i>Analysis
                <span class="badge bg-secondary-lt ms-1" id="tab-analysis-count">0/0</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link fw-bold py-2" data-bs-toggle="tab" data-bs-target="#tab-activity" type="button"
                id="btn-tab-activity">
                <i class="fa-solid fa-stream me-1"></i>Activity
                <span class="badge bg-secondary-lt ms-1" id="tab-activity-count">0</span>
              </button>
            </li>
          </ul>
        </div>

        {# Tab Content #}
        <div class="tab-content bg-light-lt">
          {# Generation Tab #}
          <div class="tab-pane fade show active" id="tab-generation">
            <div class="p-0">
              {# Removed redundant card, focused on list #}
              <div class="px-3 py-2 bg-body border-bottom d-flex justify-content-between align-items-center">
                <div class="small text-muted">Strategy: <span class="fw-semibold text-body">Parallel Execution</span>
                </div>
                <div class="small" id="gen-stage-status-text">Pending</div>
              </div>

              {# Generation Jobs List #}
              <div class="list-group list-group-flush" id="gen-jobs-list" style="max-height: 500px; overflow-y: auto;">
                <div class="text-center py-5 text-muted">
                  <i class="fa-solid fa-spinner fa-spin me-2"></i>Loading generation jobs...
                </div>
              </div>
            </div>
          </div>

          {# Analysis Tab #}
          <div class="tab-pane fade" id="tab-analysis">
            <div class="p-0">
              <div class="px-3 py-2 bg-body border-bottom d-flex justify-content-between align-items-center">
                <div class="small text-muted">Strategy: <span class="fw-semibold text-body">Sequential/Batch</span>
                </div>
                <div class="small" id="analysis-stage-status-text">Pending</div>
              </div>

              {# Analysis Tasks List #}
              <div class="list-group list-group-flush" id="analysis-tasks-list"
                style="max-height: 500px; overflow-y: auto;">
                <div class="text-center py-5 text-muted">
                  <i class="fa-solid fa-spinner fa-spin me-2"></i>Loading analysis tasks...
                </div>
              </div>
            </div>
          </div>

          {# Activity Tab #}
          <div class="tab-pane fade" id="tab-activity">
            <div class="p-0">
              <div class="px-3 py-2 bg-body border-bottom d-flex justify-content-between align-items-center">
                <div class="small text-muted">
                  <i class="fa-solid fa-stream me-1"></i>Live activity feed — newest first
                </div>
                <div class="small" id="activity-auto-refresh-badge">
                  <span class="badge bg-info-lt">
                    <i class="fa-solid fa-sync-alt fa-spin me-1"></i>Auto-refresh
                  </span>
                </div>
              </div>
              <div class="activity-feed" id="modal-activity-feed"
                style="max-height: 500px; overflow-y: auto; font-family: var(--tblr-font-monospace); font-size: 12px;">
                <div class="text-center py-5 text-muted">
                  <i class="fa-solid fa-stream fa-2x mb-2"></i>
                  <div>Waiting for activity...</div>
                </div>
              </div>
            </div>
          </div>

        
        </div>
      </div>

      <div class="modal-footer justify-content-between bg-body-secondary">
        <div>
          <button type="button" class="btn btn-warning btn-sm" id="modal-pause-btn" onclick="pausePipelineFromModal()">
            <i class="fa-solid fa-pause me-1"></i>Pause
          </button>
          <button type="button" class="btn btn-danger btn-sm" id="modal-cancel-btn" onclick="cancelPipelineFromModal()">
            <i class="fa-solid fa-stop me-1"></i>Cancel
          </button>
        </div>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Task status styling */
  .task-status-pending {
    color: var(--tblr-secondary);
  }

  .task-status-running {
    color: var(--tblr-primary);
  }

  .task-status-completed {
    color: var(--tblr-success);
  }

  .task-status-failed {
    color: var(--tblr-danger);
  }

  .task-status-cancelled {
    color: var(--tblr-warning);
  }

  /* Task row hover */
  #all-tasks-table tr:hover {
    background-color: var(--tblr-bg-surface-secondary);
  }

  /* Progress mini bar */
  .progress-mini {
    height: 4px;
    width: 60px;
  }

  /* Job item card */
  .job-item {
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
  }

  .job-item:hover {
    background-color: var(--tblr-bg-surface-secondary);
  }

  .job-item.job-running {
    border-left-color: var(--tblr-primary);
    background-color: rgba(var(--tblr-primary-rgb), 0.05);
  }

  .job-item.job-completed {
    border-left-color: var(--tblr-success);
  }


  .job-item.job-failed {
    border-left-color: var(--tblr-danger);
  }

  /* Make active tab very prominent */
  .nav-tabs .nav-link.active {
    border-bottom-color: var(--tblr-primary);
    color: var(--tblr-primary);
    background-color: transparent;
    border-bottom-width: 3px;
  }
</style>

<script>
  // Pipeline Progress Modal Controller
  // Guard against re-declaration on HTMX content swaps
  if (typeof window.PipelineProgressModal !== 'undefined') {
    console.debug('PipelineProgressModal already defined, skipping re-initialization');
  } else {
    window.PipelineProgressModal = {
      pipelineId: null,
      pollInterval: null,
      startTime: null,
      elapsedInterval: null,
      currentStage: null,
      currentStatus: null,
      userInteractedTab: false,

      /**
       * Open modal and start tracking pipeline
       */
      open(pipelineId) {
        this.pipelineId = pipelineId;
        this.startTime = null;
        this.currentStage = null;
        this.userInteractedTab = false;

        // Show modal (use getOrCreateInstance to avoid duplicate backdrops)
        const modalEl = document.getElementById('pipelineProgressModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();

        // Track user tab clicks to disable auto-switching
        document.querySelectorAll('#pipelineProgressModal button[data-bs-toggle="tab"]').forEach(btn => {
          btn.addEventListener('click', () => {
            this.userInteractedTab = true;
          }, { once: true });
        });

        // Start polling
        this.startPolling();
        this.fetchDetailedStatus();
      },

      /**
       * Close modal and cleanup
       */
      close() {
        this.stopPolling();
        this.stopElapsedTimer();
        this.pipelineId = null;
      },

      /**
       * Start polling for updates
       */
      startPolling() {
        this.stopPolling();
        this.pollInterval = setInterval(() => this.fetchDetailedStatus(), 2000);
      },

      /**
       * Stop polling
       */
      stopPolling() {
        if (this.pollInterval) {
          clearInterval(this.pollInterval);
          this.pollInterval = null;
        }
      },

      /**
       * Start elapsed time counter
       */
      startElapsedTimer() {
        this.stopElapsedTimer();
        this.elapsedInterval = setInterval(() => this.updateElapsed(), 1000);
      },

      /**
       * Stop elapsed timer
       */
      stopElapsedTimer() {
        if (this.elapsedInterval) {
          clearInterval(this.elapsedInterval);
          this.elapsedInterval = null;
        }
      },

      /**
       * Update elapsed time display
       */
      updateElapsed() {
        if (!this.startTime) return;

        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const mins = Math.floor((elapsed % 3600) / 60);
        const secs = elapsed % 60;

        const display = hours > 0
          ? `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
          : `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        document.getElementById('progress-modal-elapsed').textContent = display;
      },

      /**
       * Fetch detailed status from server
       */
      async fetchDetailedStatus() {
        if (!this.pipelineId) return;

        try {
          const response = await fetch(`/automation/api/pipeline/${this.pipelineId}/detailed-status`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });

          if (!response.ok) throw new Error('Failed to fetch status');

          const result = await response.json();
          if (result.success) {
            this.updateUI(result.data);
          }
        } catch (error) {
          console.error('Error fetching pipeline status:', error);
        }
      },

      /**
       * Update all UI elements with new data
       */
      updateUI(data) {
        // Pipeline ID and status
        document.getElementById('progress-modal-pipeline-id').textContent = data.id || '--';

        // Auto-switch tabs based on stage (if user hasn't manually clicked)
        if (!this.userInteractedTab && data.current_stage) {
          // If stage changed or first load
          if (this.currentStage !== data.current_stage) {
            this.currentStage = data.current_stage;
            let targetTab = null;
            if (data.current_stage === 'generation') targetTab = '#tab-generation';
            else if (data.current_stage === 'analysis') targetTab = '#tab-analysis';

            if (targetTab) {
              const tabTrigger = document.querySelector(`button[data-bs-target="${targetTab}"]`);
              if (tabTrigger) bootstrap.Tab.getOrCreateInstance(tabTrigger).show();
            }
          }
        }

        // Set startTime from server's started_at
        if (!this.startTime && data.started_at) {
          this.startTime = new Date(data.started_at).getTime();
          this.startElapsedTimer();
          this.updateElapsed();
        }

        const statusBadge = document.getElementById('progress-modal-status-badge');
        const statusColors = {
          'pending': 'bg-secondary',
          'running': 'bg-primary',
          'completed': 'bg-success',
          'partial_success': 'bg-warning',
          'failed': 'bg-danger',
          'cancelled': 'bg-warning'
        };
        statusBadge.className = `badge fs-6 ${statusColors[data.status] || 'bg-secondary'}`;
        statusBadge.textContent = (data.status || 'unknown').replace('_', ' ').toUpperCase();

        // Overall progress
        const overallPct = Math.min(data.overall_progress || 0, 100);
        document.getElementById('progress-modal-overall-pct').textContent = `${Math.round(overallPct)}%`;
        document.getElementById('progress-modal-overall-bar').style.width = `${overallPct}%`;

        // Summary counts
        const taskSummary = data.task_summary || {};
        document.getElementById('progress-modal-completed').textContent = taskSummary.completed || 0;
        document.getElementById('progress-modal-running').textContent = taskSummary.running || 0;
        document.getElementById('progress-modal-failed').textContent = taskSummary.failed || 0;

        // Update stages
        this.updateGenerationStage(data.progress?.generation, data.generation_jobs);
        this.updateAnalysisStage(data.progress?.analysis, data.analysis_tasks);
        this.updateActivityFeed(data.events);

        // Tab counts
        const genProgress = data.progress?.generation || {};
        const analysisProgress = data.progress?.analysis || {};
        const events = data.events || [];
        document.getElementById('tab-gen-count').textContent =
          `${(genProgress.completed || 0) + (genProgress.failed || 0)}/${genProgress.total || 0}`;
        document.getElementById('tab-analysis-count').textContent =
          `${(analysisProgress.completed || 0) + (analysisProgress.failed || 0)}/${analysisProgress.total || 0}`;
        document.getElementById('tab-activity-count').textContent = events.length;

        // Update control buttons
        this.currentStatus = data.status;
        const isPipelineActive = ['running', 'pending', 'paused'].includes(data.status);
        const pauseBtn = document.getElementById('modal-pause-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        pauseBtn.disabled = !isPipelineActive;
        cancelBtn.disabled = !isPipelineActive;

        // Toggle Pause/Resume button
        if (data.status === 'paused') {
          pauseBtn.innerHTML = '<i class="fa-solid fa-play me-1"></i>Resume';
          pauseBtn.classList.remove('btn-warning');
          pauseBtn.classList.add('btn-success');
        } else {
          pauseBtn.innerHTML = '<i class="fa-solid fa-pause me-1"></i>Pause';
          pauseBtn.classList.remove('btn-success');
          pauseBtn.classList.add('btn-warning');
        }

        // Stop polling if complete
        if (['completed', 'failed', 'cancelled'].includes(data.status)) {
          this.stopPolling();
          this.stopElapsedTimer();
        }
      },

      /**
       * Update generation stage UI
       */
      updateGenerationStage(progress, jobs) {
        if (!progress) return;

        const statusText = (progress.status || 'Pending').toUpperCase();
        document.getElementById('gen-stage-status-text').textContent = statusText;

        // Jobs list
        const listEl = document.getElementById('gen-jobs-list');
        if (!jobs || jobs.length === 0) {
          listEl.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="fa-solid fa-inbox fa-2x mb-2"></i>
          <div>No generation jobs</div>
        </div>`;
          return;
        }

        listEl.innerHTML = jobs.map((job, idx) => this.renderJobItem(job, idx)).join('');
      },

      /**
       * Update analysis stage UI
       */
      updateAnalysisStage(progress, tasks) {
        if (!progress) return;

        const statusText = (progress.status || 'Pending').toUpperCase();
        document.getElementById('analysis-stage-status-text').textContent = statusText;

        // Tasks list
        const listEl = document.getElementById('analysis-tasks-list');
        if (!tasks || tasks.length === 0) {
          listEl.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="fa-solid fa-inbox fa-2x mb-2"></i>
          <div>No analysis tasks</div>
        </div>`;
          return;
        }

        listEl.innerHTML = tasks.map((task, idx) => this.renderTaskItem(task, idx)).join('');
      },

      /**
       * Update activity feed
       */
      updateActivityFeed(events) {
        const feedEl = document.getElementById('modal-activity-feed');
        if (!feedEl) return;

        if (!events || events.length === 0) {
          feedEl.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="fa-solid fa-stream fa-2x mb-2"></i>
          <div>No activity yet</div>
        </div>`;
          return;
        }

        const levelColors = {
          'info': 'text-primary', 'success': 'text-success',
          'warning': 'text-warning', 'error': 'text-danger'
        };
        const levelIcons = {
          'info': 'fa-info-circle', 'success': 'fa-check-circle',
          'warning': 'fa-exclamation-triangle', 'error': 'fa-times-circle'
        };

        feedEl.innerHTML = events.map(e => {
          const level = e.level || 'info';
          const ts = e.timestamp ? new Date(e.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '';
          const bgClass = level === 'error' ? 'background-color: rgba(var(--tblr-danger-rgb), 0.05);' : '';
          return `<div class="d-flex gap-2 px-3 py-1 border-bottom" style="line-height: 1.4; ${bgClass}">
            <span class="text-muted" style="min-width: 55px;">${ts}</span>
            <i class="fa-solid ${levelIcons[level] || 'fa-circle'} ${levelColors[level] || 'text-muted'}" style="font-size: 0.7em; margin-top: 4px;"></i>
            <span class="flex-fill">${e.stage ? `<span class="badge bg-secondary-lt me-1" style="font-size: 0.65em;">${e.stage}</span>` : ''}${e.message || ''}</span>
          </div>`;
        }).join('');

        // Hide auto-refresh badge if pipeline is done
        const badge = document.getElementById('activity-auto-refresh-badge');
        if (badge && ['completed', 'failed', 'cancelled'].includes(this.currentStatus)) {
          badge.style.display = 'none';
        }
      },

      /**
       * Render a job item (generation)
       */
      renderJobItem(job, idx) {
        const statusClass = job.success ? 'job-completed' : (job.error ? 'job-failed' : 'job-running');
        const statusIcon = job.success ? 'fa-check text-success' :
          (job.error ? 'fa-times text-danger' : 'fa-spinner fa-spin text-primary');

        // If not success/error/running, it's pending
        // Logic check: if not success and not error, assumption is running or pending.
        // job object usually has 'success' bool. If false, could be pending or failed.
        // We should rely on error field.

        return `
      <div class="list-group-item job-item ${statusClass} py-3">
        <div class="d-flex align-items-center gap-3">
          <div style="width: 24px" class="text-center">
             <i class="fa-solid ${statusIcon} fs-4"></i>
          </div>
          <div class="flex-fill">
            <div class="d-flex justify-content-between">
                <div class="fw-bold fs-5">${job.model_slug || 'Unknown model'}</div>
                ${job.duration ? `<span class="badge bg-secondary-lt">${job.duration.toFixed(1)}s</span>` : ''}
            </div>
            <div class="text-muted d-flex gap-2 align-items-center">
                <i class="fa-solid fa-cube small"></i> ${job.template_slug || job.app_number || '-'}
                ${job.app_number ? `<span class="badge bg-azure-lt ms-2">App #${job.app_number}</span>` : ''}
            </div>
          </div>
        </div>
        ${job.error ? `
            <div class="mt-2 text-danger bg-danger-lt p-2 rounded small">
                <i class="fa-solid fa-exclamation-triangle me-1"></i>${job.error}
            </div>
        ` : ''}
      </div>`;
      },

      /**
       * Render a task item (analysis)
       */
      renderTaskItem(task, idx) {
        const status = (task.status || 'pending').toLowerCase();
        const statusIcons = {
          'pending': 'fa-clock text-muted',
          'running': 'fa-spinner fa-spin text-primary',
          'completed': 'fa-check text-success',
          'failed': 'fa-times text-danger',
          'cancelled': 'fa-ban text-warning'
        };

        const progressPct = task.progress_percentage || 0;

        return `
      <div class="list-group-item job-item job-${status} py-3">
        <div class="d-flex align-items-center gap-3">
          <div style="width: 24px" class="text-center">
            <i class="fa-solid ${statusIcons[status] || 'fa-question'} fs-4"></i>
          </div>
          <div class="flex-fill">
            <div class="d-flex justify-content-between">
                <div class="fw-bold fs-5">${task.target_model || 'Unknown'}</div>
                <div class="badge bg-${status === 'completed' ? 'success' : status === 'failed' ? 'danger' : 'secondary'}-lt">
                    ${status.toUpperCase()}
                </div>
            </div>
            <small class="text-muted">App #${task.target_app_number || '?'} • ${task.task_id?.slice(0, 8) || '--'}</small>
          </div>
        </div>
        
        ${status === 'running' ? `
           <div class="mt-2">
              <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-primary" style="width: ${progressPct}%"></div>
              </div>
              <div class="d-flex justify-content-between small text-muted mt-1">
                 <span>Processing...</span>
                 <span>${progressPct}%</span>
              </div>
           </div>
        ` : ''}

        ${task.error_message ? `
          <div class="mt-2 small text-danger bg-danger-lt p-2 rounded">
            <i class="fa-solid fa-exclamation-triangle me-1"></i>${task.error_message}
          </div>
        ` : ''}
      </div>`;
      },
    };
  } // End guard pattern

  // Modal close event
  document.getElementById('pipelineProgressModal')?.addEventListener('hidden.bs.modal', () => {
    PipelineProgressModal.close();
  });

  // Helpers
  function pausePipelineFromModal() {
    const pid = PipelineProgressModal.pipelineId;
    const isPaused = PipelineProgressModal.currentStatus === 'paused';
    const action = isPaused ? 'resume' : 'pause';

    const btn = document.getElementById('modal-pause-btn');
    if (btn) btn.disabled = true;

    fetch(`/automation/api/pipelines/${pid}/${action}`, { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          PipelineProgressModal.fetchDetailedStatus();
        } else {
          alert('Action failed: ' + (d.message || 'Unknown error'));
          if (btn) btn.disabled = false;
        }
      })
      .catch(e => {
        console.error(e);
        if (btn) btn.disabled = false;
      });
  }
  function cancelPipelineFromModal() {
    if (!confirm('Are you sure you want to cancel?')) return;
    const pid = PipelineProgressModal.pipelineId;
    fetch(`/automation/api/pipeline/${pid}/cancel`, { method: 'POST' })
      .then(r => r.json())
      .then(d => PipelineProgressModal.fetchDetailedStatus());
  }
  function openPipelineProgressModal(pid) { PipelineProgressModal.open(pid); }
</script>