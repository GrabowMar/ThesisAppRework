{# Automation Pipeline - End-to-End Workflow Interface #}
{% extends 'layouts/base.html' %}
{% set page_title = 'Automation Pipeline' %}
{% set page_icon = 'fa-solid fa-wand-magic-sparkles' %}
{% set page_subtitle = 'End-to-end workflow: Generation → Analysis → Reports' %}
{% set active_page = 'automation' %}

{% block content %}
<div id="automation-pipeline">
  <div class="row row-cards g-3">
    {# Main Content Area #}
    <div class="col-xxl-8 col-xl-7 col-lg-7">
      <div class="row row-cards g-3">
        {# Hidden form inputs for pipeline state #}
        <input type="hidden" id="pipeline-id" value="">
        <input type="hidden" id="pipeline-status" value="idle">

        {# Step 1: Generation Configuration #}
        <div class="col-12 wizard-panel active" data-panel="1">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 1</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fas fa-code text-primary"></i>
                    <span>Sample Generation</span>
                  </h3>
                  <div class="text-muted small">Select models and templates for code generation</div>
                </div>
              </div>
              <div class="ms-auto">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable-generation" checked>
                  <label class="form-check-label small" for="enable-generation">Enabled</label>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="generation-config">
              {% include 'pages/automation/partials/_stage_generation.html' %}
            </div>
          </div>
        </div>

        {# Step 2: Analysis Configuration #}
        <div class="col-12 wizard-panel" data-panel="2">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 2</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fas fa-chart-column text-primary"></i>
                    <span>Analysis Configuration</span>
                  </h3>
                  <div class="text-muted small">Configure security, quality, and performance analysis</div>
                </div>
              </div>
              <div class="ms-auto">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable-analysis" checked>
                  <label class="form-check-label small" for="enable-analysis">Enabled</label>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="analysis-config">
              {% include 'pages/automation/partials/_stage_analysis.html' %}
            </div>
          </div>
        </div>

        {# Step 3: Reports Configuration #}
        <div class="col-12 wizard-panel" data-panel="3">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 3</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fas fa-file-lines text-primary"></i>
                    <span>Report Generation</span>
                  </h3>
                  <div class="text-muted small">Configure output reports and formats</div>
                </div>
              </div>
              <div class="ms-auto">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable-reports" checked>
                  <label class="form-check-label small" for="enable-reports">Enabled</label>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="reports-config">
              {% include 'pages/automation/partials/_stage_reports.html' %}
            </div>
          </div>
        </div>

        {# Step 4: Review & Execute #}
        <div class="col-12 wizard-panel" data-panel="4">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-uppercase rounded-pill px-3">Step 4</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fas fa-rocket text-primary"></i>
                    <span>Review &amp; Execute</span>
                  </h3>
                  <div class="text-muted small">Review configuration and start the pipeline</div>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="review-panel">
              {% include 'pages/automation/partials/_stage_review.html' %}
            </div>
          </div>
        </div>

        {# Execution Progress #}
        <div class="col-12 wizard-panel" data-panel="5">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-success text-uppercase rounded-pill px-3">Running</span>
                <div>
                  <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                    <i class="fas fa-cog fa-spin text-success"></i>
                    <span>Pipeline Execution</span>
                  </h3>
                  <div class="text-muted small">Monitor pipeline progress in real-time</div>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="execution-panel">
              {% include 'pages/automation/partials/_execution_progress.html' %}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Sidebar #}
    <div class="col-xxl-4 col-xl-5 col-lg-5">
      <div class="analysis-sidebar right-sticky-sidebar sticky-top">
        {# Pipeline Settings - Save/Load #}
        <div class="card card-sm mb-3">
          <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">
              <i class="fas fa-bookmark me-2 text-primary"></i>Pipeline Settings
            </h6>
            <a href="#" class="small text-muted" id="manage-settings-link-sidebar" title="Manage saved settings">
              <i class="fas fa-cog"></i>
            </a>
          </div>
          <div class="card-body py-2">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="save-settings-btn-sidebar">
                <i class="fas fa-save me-1"></i>Save
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary flex-fill" id="load-settings-btn-sidebar">
                <i class="fas fa-folder-open me-1"></i>Load
              </button>
            </div>
          </div>
        </div>

        {# Progress Stepper #}
        <div class="card card-sm mb-3">
          <div class="card-header py-2">
            <h6 class="card-title mb-0">
              <i class="fas fa-route me-2 text-primary"></i>Pipeline Progress
            </h6>
          </div>
          <div class="card-body py-2">
            <div class="wizard-progress">
              <div class="progress mb-3">
                <div class="progress-bar bg-primary" role="progressbar" id="wizard-progress-bar" aria-label="Pipeline progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="steps steps-counter steps-xs">
                <div class="step-item active" data-step="1" role="button" tabindex="0" onclick="goToStep(1)">
                  <div class="step-icon">
                    <i class="fas fa-code"></i>
                  </div>
                  <div class="step-title">Generate</div>
                </div>
                <div class="step-item" data-step="2" role="button" tabindex="0" onclick="goToStep(2)">
                  <div class="step-icon">
                    <i class="fas fa-chart-column"></i>
                  </div>
                  <div class="step-title">Analyze</div>
                </div>
                <div class="step-item" data-step="3" role="button" tabindex="0" onclick="goToStep(3)">
                  <div class="step-icon">
                    <i class="fas fa-file-lines"></i>
                  </div>
                  <div class="step-title">Reports</div>
                </div>
                <div class="step-item" data-step="4" role="button" tabindex="0" onclick="goToStep(4)">
                  <div class="step-icon">
                    <i class="fas fa-rocket"></i>
                  </div>
                  <div class="step-title">Execute</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# Navigation Buttons #}
        <div class="card card-sm mb-3" id="wizard-nav-card">
          <div class="card-header py-2">
            <h6 class="card-title mb-0">
              <i class="fas fa-gamepad me-2 text-primary"></i>Navigation
            </h6>
          </div>
          <div class="card-body py-2">
            <div class="d-flex flex-column gap-2">
              <div class="d-flex justify-content-between align-items-center small text-muted">
                <span>Step <span id="current-step" class="fw-bold text-primary">1</span> of <span class="fw-bold">4</span></span>
                <span id="progress-percentage" class="fw-semibold">0%</span>
              </div>
              <div class="d-flex justify-content-between align-items-center gap-2">
                <button type="button" class="btn btn-ghost-secondary btn-sm" id="prev-btn" onclick="previousStep()" disabled>
                  <i class="fas fa-chevron-left me-1"></i>Previous
                </button>
                <div class="d-flex gap-2 flex-grow-1">
                  <button type="button" class="btn btn-primary btn-sm flex-grow-1" id="next-btn" onclick="nextStep()">
                    Next <i class="fas fa-chevron-right ms-1"></i>
                  </button>
                  <button type="button" class="btn btn-success btn-sm flex-grow-1 d-none" id="start-btn" onclick="startPipeline()">
                    <i class="fas fa-play me-1"></i>Start Pipeline
                  </button>
                  <button type="button" class="btn btn-success btn-sm flex-grow-1 d-none" id="start-btn-loading" disabled>
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Starting...
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# Pipeline Summary #}
        <div class="card card-sm mb-3">
          <div class="card-header py-2">
            <h6 class="card-title mb-0">
              <i class="fas fa-clipboard-list me-2 text-primary"></i>Pipeline Summary
            </h6>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Generation</span>
                <span class="badge bg-success-lt" id="gen-status-badge">Enabled</span>
              </div>
              <div class="d-flex gap-2 small">
                <span><strong id="sidebar-model-count">0</strong> models</span>
                <span class="text-muted">×</span>
                <span><strong id="sidebar-template-count">0</strong> templates</span>
                <span class="text-muted">=</span>
                <span><strong id="sidebar-job-count">0</strong> jobs</span>
              </div>
            </div>
            <div class="border-top pt-3 mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Analysis</span>
                <span class="badge bg-success-lt" id="analysis-status-badge">Enabled</span>
              </div>
              <div class="small" id="sidebar-analysis-summary">
                Profile: <strong>Comprehensive</strong>
              </div>
            </div>
            <div class="border-top pt-3 mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Reports</span>
                <span class="badge bg-success-lt" id="reports-status-badge">Enabled</span>
              </div>
              <div class="small" id="sidebar-reports-summary">
                Format: <strong>HTML</strong>
              </div>
            </div>
            <div class="card bg-azure-lt mt-3">
              <div class="card-body py-3">
                <div class="d-flex align-items-center justify-content-between gap-3">
                  <div>
                    <div class="text-muted small">Est. Duration</div>
                    <div class="h5 mb-0" id="sidebar-est-duration">--</div>
                  </div>
                  <div class="text-end">
                    <div class="text-muted small">Total Jobs</div>
                    <div class="fw-semibold" id="sidebar-total-jobs">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# System Status #}
        <div class="card card-sm" id="status-card" hx-get="/automation/fragments/status" hx-trigger="load, every 10s" hx-swap="innerHTML">
          {% include 'pages/automation/partials/_status_metrics.html' %}
        </div>
      </div>
    </div>
  </div>
</div>

{# Load Settings Modal #}
<div class="modal fade" id="loadSettingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-folder-open me-2"></i>Load Pipeline Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="load-settings-list" class="list-group">
          <div class="text-center py-4 text-muted">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading saved settings...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

{# Save Settings Modal - Moved here so it's accessible from all wizard steps #}
<div class="modal fade" id="saveSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-save me-2"></i>Save Pipeline Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="settings-name" class="form-label">Settings Name</label>
          <input type="text" class="form-control" id="settings-name" placeholder="My Pipeline Settings" required>
        </div>
        <div class="mb-3">
          <label for="settings-description" class="form-label">Description (optional)</label>
          <textarea class="form-control" id="settings-description" rows="2" placeholder="Describe this configuration..."></textarea>
        </div>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="settings-default">
          <label class="form-check-label" for="settings-default">Set as default</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-settings-confirm">
          <i class="fas fa-save me-1"></i>Save
        </button>
      </div>
    </div>
  </div>
</div>

{# Manage Settings Modal - Moved here so it's accessible from all wizard steps #}
<div class="modal fade" id="manageSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Manage Saved Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="manage-settings-list" class="list-group">
          {# Populated by JavaScript #}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/automation_wizard.js') }}"></script>
{% endblock %}
