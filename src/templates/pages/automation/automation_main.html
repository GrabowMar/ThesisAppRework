{# Automation Pipeline - End-to-End Workflow Interface #}
{% extends 'layouts/base_smart.html' %}
{% set page_title = 'Automation Pipeline' %}
{% set page_icon = 'fa-solid fa-wand-magic-sparkles' %}
{% set page_subtitle = 'End-to-end workflow: Generation → Analysis' %}
{% set active_page = 'automation' %}

{% block content %}
<div id="automation-pipeline">
  <div class="row row-cards g-2">
    {# Main Content Area #}
    <div class="col-xxl-8 col-xl-7 col-lg-7">
      <div class="row row-cards g-2">
        {# Hidden form inputs for pipeline state #}
        <input type="hidden" id="pipeline-id" value="">
        <input type="hidden" id="pipeline-status" value="idle">

        {# Step 1: Generation Configuration #}
        <div class="col-12 wizard-panel active" data-panel="1">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-2 py-2">
              <span class="badge bg-primary text-uppercase rounded-pill px-2">1</span>
              <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                <i class="fa-solid fa-code text-primary"></i>
                <span>Sample Generation</span>
              </h3>
              <div class="ms-auto">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable-generation" checked>
                  <label class="form-check-label small" for="enable-generation">Enabled</label>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="generation-config">
              {% include 'pages/automation/partials/_stage_generation.html' %}
            </div>
          </div>
        </div>

        {# Step 2: Analysis Configuration #}
        <div class="col-12 wizard-panel" data-panel="2">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-2 py-2">
              <span class="badge bg-primary text-uppercase rounded-pill px-2">2</span>
              <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                <i class="fa-solid fa-chart-column text-primary"></i>
                <span>Analysis Configuration</span>
              </h3>
              <div class="ms-auto">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable-analysis" checked>
                  <label class="form-check-label small" for="enable-analysis">Enabled</label>
                </div>
              </div>
            </div>
            <div class="card-body border-top" id="analysis-config">
              {% include 'pages/automation/partials/_stage_analysis.html' %}
            </div>
          </div>
        </div>

        {# Step 3: Review & Execute #}
        <div class="col-12 wizard-panel" data-panel="3">
          <div class="card card-table-compact">
            <div class="card-header d-flex flex-wrap align-items-center gap-2 py-2">
              <span class="badge bg-primary text-uppercase rounded-pill px-2">3</span>
              <h3 class="card-title mb-0 d-flex align-items-center gap-2">
                <i class="fa-solid fa-rocket text-primary"></i>
                <span>Review &amp; Execute</span>
              </h3>
            </div>
            <div class="card-body border-top" id="review-panel">
              {% include 'pages/automation/partials/_stage_review.html' %}
            </div>
          </div>
        </div>

      </div>
    </div>

    {# Sidebar #}
    <div class="col-xxl-4 col-xl-5 col-lg-5">
      <div class="analysis-sidebar right-sticky-sidebar sticky-top">

        {# Wizard Navigation Card - Clean Design #}
        <div class="card card-sm mb-2" id="wizard-nav-card">
          <div class="card-body p-0">
            {# Step indicators as clickable bar #}
            <div class="d-flex border-bottom" style="font-size: 0.8rem;">
              <button class="btn flex-fill py-2 rounded-0 border-end step-nav-btn active"
                      data-step="1" onclick="goToStep(1)" style="border-top-left-radius: var(--tblr-card-border-radius) !important;">
                <i class="fa-solid fa-code me-1"></i>Generate
              </button>
              <button class="btn flex-fill py-2 rounded-0 border-end step-nav-btn"
                      data-step="2" onclick="goToStep(2)">
                <i class="fa-solid fa-chart-column me-1"></i>Analyze
              </button>
              <button class="btn flex-fill py-2 rounded-0 step-nav-btn"
                      data-step="3" onclick="goToStep(3)" style="border-top-right-radius: var(--tblr-card-border-radius) !important;">
                <i class="fa-solid fa-rocket me-1"></i>Execute
              </button>
            </div>
            {# Progress bar #}
            <div class="progress rounded-0" style="height: 3px;">
              <div class="progress-bar bg-primary" role="progressbar" id="automation-wizard-progress-bar"
                aria-label="Pipeline progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            {# Actions row #}
            <div class="d-flex align-items-center gap-2 px-3 py-2">
              <button type="button" class="btn btn-ghost-secondary btn-sm py-1 px-2" id="prev-btn" onclick="previousStep()" disabled>
                <i class="fa-solid fa-chevron-left"></i> Back
              </button>
              <div class="d-flex align-items-center gap-2 small text-muted flex-fill justify-content-center">
                <span class="badge bg-success-lt" id="gen-status-badge" style="font-size: 0.7em;">Enabled</span>
                <span><strong id="sidebar-model-count">0</strong>M × <strong id="sidebar-template-count">0</strong>T = <strong id="sidebar-job-count">0</strong></span>
                <span class="badge bg-success-lt" id="analysis-status-badge" style="font-size: 0.7em;">Enabled</span>
              </div>
              <button type="button" class="btn btn-primary btn-sm py-1 px-2" id="next-btn" onclick="nextStep()">
                Next <i class="fa-solid fa-chevron-right ms-1"></i>
              </button>
              <button type="button" class="btn btn-success btn-sm py-1 px-2 d-none" id="start-btn" onclick="startPipeline()">
                <i class="fa-solid fa-play me-1"></i>Start
              </button>
              <button type="button" class="btn btn-success btn-sm py-1 px-2 d-none" id="start-btn-loading" disabled>
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>Starting...
              </button>
            </div>
          </div>
        </div>

        {# Pipeline Tools - Compact icon row #}
        <div class="card card-sm mb-2">
          <div class="card-body py-2 px-3">
            <div class="d-flex align-items-center gap-1">
              <span class="small text-muted me-1"><i class="fa-solid fa-toolbox me-1"></i>Tools</span>
              <button type="button" class="btn btn-sm btn-icon btn-ghost-primary" id="save-settings-btn-sidebar" title="Save Settings">
                <i class="fa-solid fa-save"></i>
              </button>
              <button type="button" class="btn btn-sm btn-icon btn-ghost-secondary" id="load-settings-btn-sidebar" title="Load Settings">
                <i class="fa-solid fa-folder-open"></i>
              </button>
              <button type="button" class="btn btn-sm btn-icon btn-ghost-success" id="export-results-btn" title="Export Results">
                <i class="fa-solid fa-download"></i>
              </button>
              <button type="button" class="btn btn-sm btn-icon btn-ghost-info" id="import-results-btn" title="Import Results">
                <i class="fa-solid fa-upload"></i>
              </button>
              <a href="#" class="btn btn-sm btn-icon btn-ghost-secondary ms-auto" id="manage-settings-link-sidebar" title="Manage Settings">
                <i class="fa-solid fa-cog"></i>
              </a>
            </div>
          </div>
        </div>

        {# Pipeline Executions (moved to sidebar) #}
        <div class="col-12">
          {% include 'pages/automation/partials/_past_executions.html' %}
        </div>

        {# Hidden elements for JS compat #}
        <input type="hidden" id="current-step" value="1">
        <input type="hidden" id="progress-percentage" value="0">

      </div>
    </div>
  </div>
</div>

<style>
  .step-nav-btn { font-weight: 400; color: var(--tblr-muted) !important; transition: color 0.15s; background: transparent !important; box-shadow: none !important; border-bottom: 2px solid transparent !important; }
  .step-nav-btn.active { font-weight: 600; color: var(--tblr-primary) !important; border-bottom-color: var(--tblr-primary) !important; }
  .step-nav-btn:hover:not(.active) { color: var(--tblr-body-color) !important; }
</style>

{# Load Settings Modal #}
<div class="modal fade" id="loadSettingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-folder-open me-2"></i>Load Pipeline Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="load-settings-list" class="list-group">
          <div class="text-center py-4 text-muted">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading saved settings...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

{# Save Settings Modal - Moved here so it's accessible from all wizard steps #}
<div class="modal fade" id="saveSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-save me-2"></i>Save Pipeline Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="settings-name" class="form-label">Settings Name</label>
          <input type="text" class="form-control" id="settings-name" placeholder="My Pipeline Settings" required>
        </div>
        <div class="mb-3">
          <label for="settings-description" class="form-label">Description (optional)</label>
          <textarea class="form-control" id="settings-description" rows="2"
            placeholder="Describe this configuration..."></textarea>
        </div>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="settings-default">
          <label class="form-check-label" for="settings-default">Set as default</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-settings-confirm">
          <i class="fa-solid fa-save me-1"></i>Save
        </button>
      </div>
    </div>
  </div>
</div>

{# Manage Settings Modal - Moved here so it's accessible from all wizard steps #}
<div class="modal fade" id="manageSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-cog me-2"></i>Manage Saved Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="manage-settings-list" class="list-group">
          {# Populated by JavaScript #}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{# Pipeline Progress Detail Modal #}
{% include 'pages/automation/partials/_progress_modal.html' %}

{# Import Results Modal #}
<div class="modal fade" id="importResultsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-upload me-2"></i>Import Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fa-solid fa-info-circle me-2"></i>
          Import results from a previously exported ZIP file. Existing results will be backed up automatically.
        </div>
        <div class="mb-3">
          <label for="import-file" class="form-label">Select ZIP file</label>
          <input type="file" class="form-control" id="import-file" accept=".zip" required>
        </div>
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" id="import-overwrite">
          <label class="form-check-label" for="import-overwrite">
            Overwrite existing results
            <div class="small text-muted">If unchecked, existing files will be skipped</div>
          </label>
        </div>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="import-backup" checked>
          <label class="form-check-label" for="import-backup">
            Create backup before import
            <div class="small text-muted">Recommended to prevent data loss</div>
          </label>
        </div>
        <div id="import-progress" class="mt-3" style="display: none;">
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
            </div>
          </div>
          <div class="text-center mt-2 small text-muted">Importing results...</div>
        </div>
        <div id="import-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="import-confirm">
          <i class="fa-solid fa-upload me-1"></i>Import
        </button>
      </div>
    </div>
  </div>
</div>

{# Export Results Modal #}
<div class="modal fade" id="exportResultsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-download me-2"></i>Export Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fa-solid fa-info-circle me-2"></i>
          Export analysis results and generated app source code as a ZIP file for backup or transfer.
        </div>
        <div class="mb-3">
          <label class="form-label">What to Export</label>
          <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="export-results" checked>
            <label class="form-check-label" for="export-results">
              <strong>Analysis Results</strong>
              <div class="small text-muted">Include all analysis results, reports, and SARIF files</div>
            </label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="export-apps" checked>
            <label class="form-check-label" for="export-apps">
              <strong>Generated Apps</strong>
              <div class="small text-muted">Include source code of all generated applications</div>
            </label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Model Filter (Optional)</label>
          <div class="small text-muted mb-2">Select specific models to export (leave empty for all)</div>
          <select class="form-select" id="export-model-filter" multiple size="5">
            <option value="">All models (leave empty to export all)</option>
          </select>
        </div>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="export-metadata" checked>
          <label class="form-check-label" for="export-metadata">
            Include metadata
            <div class="small text-muted">Export timestamp, user info, and file statistics</div>
          </label>
        </div>
        <div id="export-progress" class="mt-3" style="display: none;">
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
            </div>
          </div>
          <div class="text-center mt-2 small text-muted">Creating export file...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="export-confirm">
          <i class="fa-solid fa-download me-1"></i>Export
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/automation_wizard.js') }}"></script>
<script>
  // Handle URL parameters after pipeline start redirect
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const pipelineId = urlParams.get('pipeline');
    const showProgress = urlParams.get('show_progress');

    if (pipelineId && showProgress) {
      // Expand Past Pipeline Executions section if collapsed
      const pastExecutionsCollapse = document.getElementById('pastExecutionsCollapse');
      if (pastExecutionsCollapse && !pastExecutionsCollapse.classList.contains('show')) {
        const bsCollapse = new bootstrap.Collapse(pastExecutionsCollapse, { toggle: true });
      }

      // Open progress modal for the pipeline
      setTimeout(function () {
        if (typeof openPipelineProgressModal === 'function') {
          openPipelineProgressModal(pipelineId);
        }
      }, 300);

      // Clean up URL (remove query params)
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  });
</script>
{% endblock %}