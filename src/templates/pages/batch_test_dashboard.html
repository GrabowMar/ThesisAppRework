{% extends "base.html" %}

{% block title %}Test Runner Dashboard - Batch Analysis{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-flask text-primary mr-2"></i>
                Test Runner Dashboard
            </h1>
            <p class="page-subtitle">
                Execute and manage Python test files from the backend
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm" 
                    hx-get="/api/batch/tests/files"
                    hx-target="#test-files-container"
                    hx-indicator="#loading-overlay">
                <i class="fas fa-sync-alt mr-1"></i>
                Refresh Tests
            </button>
            <button type="button" class="btn btn-success btn-sm" 
                    onclick="runAllTests()">
                <i class="fas fa-play mr-1"></i>
                Run All Tests
            </button>
            <button type="button" class="btn btn-secondary btn-sm" 
                    onclick="toggleTestOptions()">
                <i class="fas fa-cog mr-1"></i>
                Options
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-card-icon">
                    <i class="fas fa-file-code"></i>
                </div>
                <div class="stats-card-value" id="total-test-files">
                    {{ test_files|length }}
                </div>
                <div class="stats-card-label">Test Files</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-card-icon">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="stats-card-value" id="running-tests">
                    0
                </div>
                <div class="stats-card-label">Running Tests</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-card-value text-success" id="passed-tests">
                    0
                </div>
                <div class="stats-card-label">Passed</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-card-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stats-card-value text-danger" id="failed-tests">
                    0
                </div>
                <div class="stats-card-label">Failed</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Test Files Panel -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list mr-2"></i>
                        Available Test Files
                    </h5>
                    <div class="d-flex gap-2">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" class="form-control" 
                                   id="test-search" 
                                   placeholder="Search test files..."
                                   onkeyup="filterTestFiles()">
                            <div class="input-group-append">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="selectAllTests()">
                            Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                onclick="clearTestSelection()">
                            Clear
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="test-files-container">
                        {% include 'partials/test_files_list.html' %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Options & Actions Panel -->
        <div class="col-lg-4">
            <!-- Test Options -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog mr-2"></i>
                        Test Options
                    </h6>
                </div>
                <div class="card-body">
                    <form id="test-options-form">
                        <div class="form-group">
                            <label class="form-check-label font-weight-bold">
                                Test Runner
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="use_pytest" value="true" checked>
                                <label class="form-check-label">
                                    pytest (recommended)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="use_pytest" value="false">
                                <label class="form-check-label">
                                    unittest
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="verbose" name="verbose">
                                <label class="form-check-label" for="verbose">
                                    Verbose output
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tb_style">Traceback Style</label>
                            <select class="form-control form-control-sm" 
                                    id="tb_style" name="tb_style">
                                <option value="short" selected>Short</option>
                                <option value="long">Long</option>
                                <option value="auto">Auto</option>
                                <option value="line">Line</option>
                                <option value="native">Native</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="maxfail">Max Failures</label>
                            <input type="number" class="form-control form-control-sm" 
                                   id="maxfail" name="maxfail" 
                                   placeholder="No limit" min="1">
                        </div>

                        <div class="form-group">
                            <label for="timeout">Timeout (seconds)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   id="timeout" name="timeout" 
                                   value="300" min="30" max="1800">
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt mr-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-success btn-block btn-sm mb-2"
                            onclick="runSelectedTests()">
                        <i class="fas fa-play mr-1"></i>
                        Run Selected Tests
                    </button>
                    <button type="button" class="btn btn-primary btn-block btn-sm mb-2"
                            onclick="runIntegrationTests()">
                        <i class="fas fa-sitemap mr-1"></i>
                        Run Integration Tests
                    </button>
                    <button type="button" class="btn btn-info btn-block btn-sm mb-2"
                            onclick="runUnitTests()">
                        <i class="fas fa-cube mr-1"></i>
                        Run Unit Tests
                    </button>
                    <button type="button" class="btn btn-warning btn-block btn-sm"
                            onclick="discoverTests()">
                        <i class="fas fa-search mr-1"></i>
                        Discover Tests
                    </button>
                </div>
            </div>

            <!-- Recent Runs -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history mr-2"></i>
                        Recent Test Runs
                    </h6>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <div id="recent-runs-container">
                        {% if recent_runs %}
                            {% for run in recent_runs %}
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div>
                                    <small class="font-weight-bold">{{ run.name }}</small><br>
                                    <small class="text-muted">{{ run.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                                <span class="badge badge-{{ 'success' if run.status.value == 'completed' else 'secondary' }}">
                                    {{ run.status.value }}
                                </span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <small class="text-muted">No recent test runs</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card" id="test-results-panel" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-terminal mr-2"></i>
                        Test Results
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                            onclick="clearTestResults()">
                        <i class="fas fa-times mr-1"></i>
                        Clear
                    </button>
                </div>
                <div class="card-body">
                    <div id="test-results-container">
                        <!-- Results will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Test Dashboard JavaScript Functions

function filterTestFiles() {
    const searchTerm = document.getElementById('test-search').value.toLowerCase();
    const testItems = document.querySelectorAll('.test-file-item');
    
    testItems.forEach(item => {
        const fileName = item.dataset.fileName.toLowerCase();
        const isVisible = fileName.includes(searchTerm);
        item.style.display = isVisible ? 'block' : 'none';
    });
}

function selectAllTests() {
    const checkboxes = document.querySelectorAll('.test-file-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
}

function clearTestSelection() {
    const checkboxes = document.querySelectorAll('.test-file-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
}

function runSelectedTests() {
    const selected = getSelectedTestFiles();
    if (selected.length === 0) {
        alert('Please select at least one test file.');
        return;
    }
    
    if (selected.length === 1) {
        runSingleTest(selected[0]);
    } else {
        runMultipleTests(selected);
    }
}

function runAllTests() {
    const allTests = Array.from(document.querySelectorAll('.test-file-checkbox'))
        .map(cb => cb.value);
    runMultipleTests(allTests);
}

function runIntegrationTests() {
    const integrationTests = Array.from(document.querySelectorAll('.test-file-checkbox'))
        .filter(cb => cb.value.includes('integration') || cb.value.includes('test_'))
        .map(cb => cb.value);
    runMultipleTests(integrationTests);
}

function runUnitTests() {
    const unitTests = Array.from(document.querySelectorAll('.test-file-checkbox'))
        .filter(cb => cb.value.includes('unit') || cb.value.includes('test_'))
        .map(cb => cb.value);
    runMultipleTests(unitTests);
}

function runSingleTest(testFile) {
    const options = getTestOptions();
    
    showTestResults();
    
    fetch('/api/batch/tests/run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        body: JSON.stringify({
            test_file: testFile,
            ...options
        })
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('test-results-container').innerHTML = html;
    })
    .catch(error => {
        console.error('Error running test:', error);
        document.getElementById('test-results-container').innerHTML = 
            `<div class="alert alert-danger">Error running test: ${error.message}</div>`;
    });
}

function runMultipleTests(testFiles) {
    const options = getTestOptions();
    
    showTestResults();
    
    fetch('/api/batch/tests/run-multiple', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        body: JSON.stringify({
            test_files: testFiles,
            ...options
        })
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('test-results-container').innerHTML = html;
    })
    .catch(error => {
        console.error('Error running tests:', error);
        document.getElementById('test-results-container').innerHTML = 
            `<div class="alert alert-danger">Error running tests: ${error.message}</div>`;
    });
}

function discoverTests() {
    showLoadingOverlay();
    
    fetch('/api/batch/tests/discover')
    .then(response => response.json())
    .then(data => {
        hideLoadingOverlay();
        if (data.success) {
            // Refresh the test files list with discovered information
            location.reload();
        } else {
            alert('Failed to discover tests: ' + data.error);
        }
    })
    .catch(error => {
        hideLoadingOverlay();
        console.error('Error discovering tests:', error);
        alert('Error discovering tests: ' + error.message);
    });
}

function getSelectedTestFiles() {
    return Array.from(document.querySelectorAll('.test-file-checkbox:checked'))
        .map(cb => cb.value);
}

function getTestOptions() {
    const form = document.getElementById('test-options-form');
    const formData = new FormData(form);
    const options = {};
    
    for (let [key, value] of formData.entries()) {
        if (key === 'use_pytest') {
            options[key] = value === 'true';
        } else if (key === 'verbose') {
            options[key] = true;
        } else if (key === 'timeout' || key === 'maxfail') {
            options[key] = value ? parseInt(value) : null;
        } else {
            options[key] = value;
        }
    }
    
    return options;
}

function showTestResults() {
    const panel = document.getElementById('test-results-panel');
    panel.style.display = 'block';
    panel.scrollIntoView({ behavior: 'smooth' });
}

function clearTestResults() {
    const panel = document.getElementById('test-results-panel');
    panel.style.display = 'none';
    document.getElementById('test-results-container').innerHTML = '';
}

function toggleTestOptions() {
    // Toggle visibility of test options panel
    const optionsCard = document.querySelector('.card-body form').closest('.card');
    const isHidden = optionsCard.style.display === 'none';
    optionsCard.style.display = isHidden ? 'block' : 'none';
}

// Auto-refresh every 30 seconds
setInterval(() => {
    // Refresh test files list
    htmx.trigger('#test-files-container', 'htmx:trigger', {
        detail: { target: '/api/batch/tests/files' }
    });
}, 30000);
</script>
{% endblock %}
