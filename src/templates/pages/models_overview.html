{% extends "base.html" %}

{% block title %}AI Models Overview - Research Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-robot text-primary mr-2"></i>
                AI Models Overview
            </h1>
            <p class="page-subtitle">
                Comprehensive analysis of {{ summary_stats.total_models or 0 }} AI models across {{ summary_stats.total_providers or 0 }} providers
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm" 
                    hx-get="/api/models/refresh"
                    hx-target="#models-content"
                    hx-indicator="#loading-overlay">
                <i class="fas fa-sync-alt mr-1"></i>
                Refresh
            </button>
            <button type="button" class="btn btn-secondary btn-sm" 
                    data-toggle="modal" data-target="#export-modal">
                <i class="fas fa-download mr-1"></i>
                Export
            </button>
        </div>
    </div>

    <!-- Research Overview Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="card-title">
                <i class="fas fa-info-circle mr-2"></i>
                Research Project Overview
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <strong>Project Scope:</strong> 
                        Large-scale AI model analysis comparing code generation capabilities
                    </div>
                    <div class="info-item">
                        <strong>Total Applications:</strong> 
                        {{ summary_stats.total_apps or 0 }} generated applications
                    </div>
                    <div class="info-item">
                        <strong>Analysis Types:</strong> 
                        Security, Performance, and Code Quality assessments
                    </div>
                    <div class="info-item">
                        <strong>Methodology:</strong> 
                        Each model generates 30 different application types for comparative analysis
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <strong>Data Collection:</strong> 
                        Automated security scanning and performance profiling
                    </div>
                    <div class="info-item">
                        <strong>Technologies:</strong> 
                        Docker containerization, HTMX interfaces, Flask backend
                    </div>
                    <div class="info-item">
                        <strong>Research Goal:</strong> 
                        Understand AI model strengths and weaknesses in code generation
                    </div>
                    <div class="info-item">
                        <strong>Current Status:</strong> 
                        <span class="badge badge-success">Data Collection Phase</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.total_models or 0 }}</div>
            <div class="stats-card-label">AI Models</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.total_providers or 0 }}</div>
            <div class="stats-card-label">Providers</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.total_apps or 0 }}</div>
            <div class="stats-card-label">Applications</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.total_running or 0 }}</div>
            <div class="stats-card-label">Running</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-eye"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.vision_models or 0 }}</div>
            <div class="stats-card-label">Vision Capable</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.fast_models or 0 }}</div>
            <div class="stats-card-label">High Speed</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.large_context or 0 }}</div>
            <div class="stats-card-label">Large Context</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stats-card-value">{{ summary_stats.analyses_completed or 0 }}</div>
            <div class="stats-card-label">Analyses Done</div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control form-control-sm" 
                               id="models-search" placeholder="Search models...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-control form-control-sm" id="provider-filter">
                        <option value="">All Providers</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="google">Google</option>
                        <option value="meta">Meta</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-control form-control-sm" id="capability-filter">
                        <option value="">All Capabilities</option>
                        <option value="vision">Vision</option>
                        <option value="function_calling">Function Calling</option>
                        <option value="json_mode">JSON Mode</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-control form-control-sm" id="sort-by">
                        <option value="name">Sort by Name</option>
                        <option value="provider">Sort by Provider</option>
                        <option value="context_length">Sort by Context</option>
                        <option value="max_output">Sort by Output</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-block"
                            onclick="clearModelFilters()">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Models Table -->
    <div id="models-content">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="fas fa-table mr-2"></i>
                    AI Models Database
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="models-table">
                        <thead class="thead-light">
                            <tr>
                                <th>Model</th>
                                <th>Provider</th>
                                <th>Context Length</th>
                                <th>Max Output</th>
                                <th>Capabilities</th>
                                <th>Apps Generated</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in models %}
                            <tr class="model-row" data-model="{{ model.slug }}" data-provider="{{ model.provider }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon mr-2">
                                            <i class="fas fa-robot text-primary"></i>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold">{{ model.display_name }}</div>
                                            <small class="text-muted">{{ model.slug }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-primary">{{ model.provider|title }}</span>
                                </td>
                                <td>
                                    <div class="text-sm">
                                        {{ "{:,}".format(model.context_length) if model.context_length else 'N/A' }}
                                    </div>
                                    <small class="text-muted">tokens</small>
                                </td>
                                <td>
                                    <div class="text-sm">
                                        {{ "{:,}".format(model.max_output) if model.max_output else 'N/A' }}
                                    </div>
                                    <small class="text-muted">tokens</small>
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if model.supports_vision %}
                                        <span class="badge badge-info">Vision</span>
                                        {% endif %}
                                        {% if model.supports_function_calling %}
                                        <span class="badge badge-success">Functions</span>
                                        {% endif %}
                                        {% if model.supports_json_mode %}
                                        <span class="badge badge-warning">JSON</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <div class="h6 mb-0">{{ model.app_count or 30 }}</div>
                                        <small class="text-muted">applications</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="status-indicator status-{{ model.status or 'ready' }}">
                                        <span class="status-dot"></span>
                                        {{ model.status|title if model.status else 'Ready' }}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="viewModelApps('{{ model.slug }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm"
                                                onclick="showModelDetails('{{ model.slug }}')">
                                            <i class="fas fa-info"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm"
                                                onclick="startModelAnalysis('{{ model.slug }}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                {% if not models %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Models Found</h4>
                    <p class="text-muted">No models match your current filter criteria.</p>
                </div>
                {% endif %}

                <!-- Table Footer -->
                {% if models %}
                <div class="d-flex justify-content-between align-items-center p-3 bg-light border-top">
                    <div class="text-muted">
                        <i class="fas fa-info-circle mr-1"></i>
                        Showing {{ models|length }} AI models with {{ (models|length * 30) if models else 0 }} total applications
                    </div>
                    <div class="text-muted">
                        <small>Each model generates 30 different application types for analysis</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot mr-2"></i>
                    Model Details
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="model-details-content">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="export-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download mr-2"></i>
                    Export Models Data
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Choose your preferred export format:</p>
                <div class="row">
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-primary btn-block"
                                onclick="exportModels('json')">
                            <i class="fas fa-code mr-2"></i>
                            JSON
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-success btn-block"
                                onclick="exportModels('csv')">
                            <i class="fas fa-table mr-2"></i>
                            CSV
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-info btn-block"
                                onclick="exportModels('xlsx')">
                            <i class="fas fa-file-excel mr-2"></i>
                            Excel
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        Export includes model specifications, capabilities, and analysis results.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Models Overview JavaScript
class ModelsOverview {
    constructor() {
        this.filters = {
            search: '',
            provider: '',
            capability: '',
            sortBy: 'name'
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupKeyboardShortcuts();
        this.loadSavedFilters();
    }

    setupEventListeners() {
        // Filter events
        document.getElementById('models-search')?.addEventListener('input', 
            this.debounce(() => this.applyFilters(), 300));
        document.getElementById('provider-filter')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('capability-filter')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('sort-by')?.addEventListener('change', () => this.applyFilters());
    }

    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('models-search')?.focus();
            }
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                $('#export-modal').modal('show');
            }
        });
    }

    loadSavedFilters() {
        const saved = localStorage.getItem('modelsOverviewFilters');
        if (saved) {
            this.filters = { ...this.filters, ...JSON.parse(saved) };
            this.restoreFilters();
            this.applyFilters();
        }
    }

    applyFilters() {
        this.filters = {
            search: document.getElementById('models-search')?.value || '',
            provider: document.getElementById('provider-filter')?.value || '',
            capability: document.getElementById('capability-filter')?.value || '',
            sortBy: document.getElementById('sort-by')?.value || 'name'
        };

        // Save filters
        localStorage.setItem('modelsOverviewFilters', JSON.stringify(this.filters));

        // Apply filters to table
        this.filterTable();
    }

    filterTable() {
        const rows = document.querySelectorAll('.model-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const modelName = row.querySelector('td:first-child').textContent.toLowerCase();
            const provider = row.dataset.provider?.toLowerCase() || '';
            const capabilities = Array.from(row.querySelectorAll('.badge')).map(b => b.textContent.toLowerCase());

            let visible = true;

            // Search filter
            if (this.filters.search) {
                const searchTerm = this.filters.search.toLowerCase();
                visible = visible && modelName.includes(searchTerm);
            }

            // Provider filter
            if (this.filters.provider) {
                visible = visible && provider === this.filters.provider.toLowerCase();
            }

            // Capability filter
            if (this.filters.capability) {
                const capFilter = this.filters.capability.toLowerCase();
                visible = visible && capabilities.some(cap => cap.includes(capFilter));
            }

            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        // Sort visible rows
        this.sortTable();

        // Update count display
        this.updateFilterCount(visibleCount);
    }

    sortTable() {
        const tbody = document.querySelector('#models-table tbody');
        const rows = Array.from(tbody.querySelectorAll('.model-row:not([style*="display: none"])'));

        rows.sort((a, b) => {
            const aValue = this.getSortValue(a, this.filters.sortBy);
            const bValue = this.getSortValue(b, this.filters.sortBy);
            
            if (typeof aValue === 'number' && typeof bValue === 'number') {
                return bValue - aValue; // Descending for numbers
            }
            return aValue.localeCompare(bValue); // Ascending for strings
        });

        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    }

    getSortValue(row, sortBy) {
        switch (sortBy) {
            case 'name':
                return row.querySelector('td:first-child .font-weight-bold').textContent;
            case 'provider':
                return row.dataset.provider || '';
            case 'context_length':
                const contextText = row.querySelector('td:nth-child(3) .text-sm').textContent;
                return parseInt(contextText.replace(/[,\s]/g, '')) || 0;
            case 'max_output':
                const outputText = row.querySelector('td:nth-child(4) .text-sm').textContent;
                return parseInt(outputText.replace(/[,\s]/g, '')) || 0;
            default:
                return '';
        }
    }

    updateFilterCount(count) {
        // Update the footer text with filtered count
        const footer = document.querySelector('.bg-light.border-top .text-muted');
        if (footer) {
            const totalModels = document.querySelectorAll('.model-row').length;
            if (count !== totalModels) {
                footer.innerHTML = `<i class="fas fa-filter mr-1"></i>Showing ${count} of ${totalModels} models (filtered)`;
            } else {
                footer.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Showing ${count} AI models with ${count * 30} total applications`;
            }
        }
    }

    restoreFilters() {
        document.getElementById('models-search').value = this.filters.search;
        document.getElementById('provider-filter').value = this.filters.provider;
        document.getElementById('capability-filter').value = this.filters.capability;
        document.getElementById('sort-by').value = this.filters.sortBy;
    }

    clearFilters() {
        this.filters = { search: '', provider: '', capability: '', sortBy: 'name' };
        this.restoreFilters();
        localStorage.removeItem('modelsOverviewFilters');
        this.filterTable();
    }

    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Global functions
window.clearModelFilters = function() {
    modelsOverview.clearFilters();
};

window.viewModelApps = function(modelSlug) {
    window.location.href = `/app/${encodeURIComponent(modelSlug)}/1`;
};

window.showModelDetails = function(modelSlug) {
    htmx.ajax('GET', `/api/models/${encodeURIComponent(modelSlug)}/details`, {
        target: '#model-details-content'
    });
    $('#modelDetailsModal').modal('show');
};

window.startModelAnalysis = function(modelSlug) {
    if (!confirm('Start security analysis for all apps in this model?')) return;
    
    htmx.ajax('POST', `/api/models/${encodeURIComponent(modelSlug)}/analyze`, {
        swap: 'none'
    }).then(() => {
        modelsOverview.showToast('Analysis started for ' + modelSlug, 'success');
    }).catch(() => {
        modelsOverview.showToast('Failed to start analysis', 'danger');
    });
};

window.exportModels = function(format) {
    const url = `/api/models/export?format=${format}`;
    window.open(url, '_blank');
    $('#export-modal').modal('hide');
    modelsOverview.showToast(`Exporting models data as ${format.toUpperCase()}`, 'info');
};

// Initialize models overview
let modelsOverview;
document.addEventListener('DOMContentLoaded', function() {
    modelsOverview = new ModelsOverview();
});
</script>
{% endblock %}
