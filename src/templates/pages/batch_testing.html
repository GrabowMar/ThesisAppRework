{% extends "base.html" %}

{% block title %}Security Testing & Analysis Platform - AI Research Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                Security Testing & Analysis Platform
            </h1>
            <p class="page-subtitle">
                Comprehensive security analysis using containerized testing infrastructure
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm" 
                    onclick="showCreateTestModal()"
                    id="create-test-btn">
                <i class="fas fa-plus mr-1"></i>
                New Security Test
            </button>
            <button type="button" class="btn btn-primary btn-sm" 
                    hx-get="/testing/api/jobs"
                    hx-target="#test-jobs-list"
                    hx-indicator="#loading-overlay">
                <i class="fas fa-sync-alt mr-1"></i>
                Refresh
            </button>
            <button type="button" class="btn btn-info btn-sm" 
                    onclick="showInfrastructureStatus()"
                    id="infrastructure-status-btn">
                <i class="fas fa-server mr-1"></i>
                Infrastructure Status
            </button>
        </div>
    </div>

    <!-- Testing Infrastructure Status -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-docker mr-2"></i>
                        Testing Infrastructure Status
                    </h6>
                </div>
                <div class="card-body p-3" id="infrastructure-status">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-right">
                                <h4 class="mb-1 text-success" id="security-scanner-status">
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                </h4>
                                <p class="text-muted mb-0">Security Scanner</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-right">
                                <h4 class="mb-1 text-info" id="performance-tester-status">
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                </h4>
                                <p class="text-muted mb-0">Performance Tester</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-right">
                                <h4 class="mb-1 text-warning" id="zap-scanner-status">
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                </h4>
                                <p class="text-muted mb-0">ZAP Scanner</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h4 class="mb-1 text-primary" id="coordinator-status">
                                <i class="fas fa-circle-notch fa-spin"></i>
                            </h4>
                            <p class="text-muted mb-0">Test Coordinator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="stats-card-value" id="total-tests">
                {{ stats.total_jobs or 0 }}
            </div>
            <div class="stats-card-label">Security Tests</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-play-circle text-success"></i>
            </div>
            <div class="stats-card-value" id="active-tests">
                {{ stats.running_jobs or 0 }}
            </div>
            <div class="stats-card-label">Active Tests</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-exclamation-triangle text-danger"></i>
            </div>
            <div class="stats-card-value" id="total-vulnerabilities">
                {{ stats.total_issues or 0 }}
            </div>
            <div class="stats-card-label">Vulnerabilities Found</div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-shield-alt text-success"></i>
            </div>
            <div class="stats-card-value" id="analyzed-apps">
                {{ stats.analyzed_apps or 0 }}
            </div>
            <div class="stats-card-label">Apps Analyzed</div>
        </div>
    </div>

    <!-- Security Testing Management -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">
                <i class="fas fa-bug mr-2"></i>
                Security Testing Jobs
            </h6>
            <div class="d-flex gap-2">
                <select class="form-control form-control-sm" id="test-type-filter" style="width: auto;">
                    <option value="">All Test Types</option>
                    <option value="security_analysis">Security Analysis</option>
                    <option value="zap_scan">ZAP Security Scan</option>
                    <option value="performance_test">Performance Test</option>
                    <option value="ai_analysis">AI Code Analysis</option>
                </select>
                <select class="form-control form-control-sm" id="status-filter" style="width: auto;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="running">Running</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <select class="form-control form-control-sm" id="model-filter" style="width: auto;">
                    <option value="">All Models</option>
                    <!-- Models will be populated dynamically -->
                </select>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="test-jobs-list" 
                 hx-get="/testing/api/jobs"
                 hx-trigger="load, refreshJobs from:body"
                 hx-swap="innerHTML">
                
                <!-- Loading State -->
                <div class="text-center py-5">
                    <div class="spinner mb-3"></div>
                    <p class="text-muted">Loading security testing jobs...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Security Test Modal -->
<div class="modal fade" id="createTestModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Create Security Test
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="create-test-form" 
                  hx-post="/testing/api/create"
                  hx-swap="none"
                  hx-on="htmx:afterRequest: handleTestCreated(event)">
                <div class="modal-body">
                    <!-- Test Type Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Test Type</label>
                                <select class="form-control" name="test_type" required onchange="handleTestTypeChange(this.value)">
                                    <option value="">Select test type...</option>
                                    <option value="security_analysis">Security Analysis (Backend & Frontend)</option>
                                    <option value="zap_scan">ZAP Security Scan</option>
                                    <option value="performance_test">Performance Testing</option>
                                    <option value="ai_analysis">AI Code Analysis</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Test Name</label>
                                <input type="text" class="form-control" name="test_name" required
                                       placeholder="Enter descriptive test name...">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"
                                  placeholder="Optional description of this security test..."></textarea>
                    </div>

                    <!-- Target Selection -->
                    <div class="form-group">
                        <label class="form-label">Target Application</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-control" name="model" required id="model-select">
                                    <option value="">Select AI Model...</option>
                                    <!-- Models will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-control" name="app_num" required>
                                    <option value="">Select App Number...</option>
                                    {% for i in range(1, 31) %}
                                    <option value="{{ i }}">App {{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Security Analysis Configuration -->
                    <div id="security-analysis-config" class="form-group d-none">
                        <label class="form-label">Security Analysis Tools</label>
                        
                        <!-- Backend Tools -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Backend Security Tools</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="bandit" id="tool-bandit">
                                            <label class="form-check-label" for="tool-bandit">
                                                <strong>Bandit</strong><br>
                                                <small class="text-muted">Python security linter</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="bandit-options">
                                            <small>
                                                <label>Severity Level:</label>
                                                <select class="form-control form-control-sm" name="bandit_severity">
                                                    <option value="LOW">Low</option>
                                                    <option value="MEDIUM" selected>Medium</option>
                                                    <option value="HIGH">High</option>
                                                </select>
                                                <label class="mt-1">Confidence Level:</label>
                                                <select class="form-control form-control-sm" name="bandit_confidence">
                                                    <option value="LOW">Low</option>
                                                    <option value="MEDIUM" selected>Medium</option>
                                                    <option value="HIGH">High</option>
                                                </select>
                                                <label class="mt-1">Skip Tests:</label>
                                                <input type="text" class="form-control form-control-sm" name="bandit_skip" 
                                                       placeholder="e.g., B101,B102">
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="safety" id="tool-safety">
                                            <label class="form-check-label" for="tool-safety">
                                                <strong>Safety</strong><br>
                                                <small class="text-muted">Dependency vulnerability scanner</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="safety-options">
                                            <small>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="safety_apply_fixes" id="safety-apply-fixes">
                                                    <label class="form-check-label" for="safety-apply-fixes">
                                                        Apply Fixes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="safety_detailed" id="safety-detailed" checked>
                                                    <label class="form-check-label" for="safety-detailed">
                                                        Detailed Output
                                                    </label>
                                                </div>
                                                <label class="mt-1">Ignore IDs:</label>
                                                <input type="text" class="form-control form-control-sm" name="safety_ignore" 
                                                       placeholder="e.g., 25853,25854">
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="pylint" id="tool-pylint">
                                            <label class="form-check-label" for="tool-pylint">
                                                <strong>Pylint</strong><br>
                                                <small class="text-muted">Code quality analyzer</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="pylint-options">
                                            <small>
                                                <label>Message Types:</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="pylint_types" value="error" checked>
                                                    <label class="form-check-label">Errors</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="pylint_types" value="warning" checked>
                                                    <label class="form-check-label">Warnings</label>
                                                </div>
                                                <label class="mt-1">Disable Checks:</label>
                                                <input type="text" class="form-control form-control-sm" name="pylint_disable" 
                                                       placeholder="e.g., C0103,R0903">
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="semgrep" id="tool-semgrep">
                                            <label class="form-check-label" for="tool-semgrep">
                                                <strong>Semgrep</strong><br>
                                                <small class="text-muted">Static analysis with custom rules</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="semgrep-options">
                                            <small>
                                                <label>Configuration:</label>
                                                <select class="form-control form-control-sm" name="semgrep_config">
                                                    <option value="auto" selected>Auto</option>
                                                    <option value="security">Security</option>
                                                    <option value="python">Python</option>
                                                    <option value="owasp-top-10">OWASP Top 10</option>
                                                </select>
                                                <label class="mt-1">Max Memory (MB):</label>
                                                <input type="number" class="form-control form-control-sm" name="semgrep_max_memory" 
                                                       value="2000" min="500" max="8000">
                                                <label class="mt-1">Timeout (sec):</label>
                                                <input type="number" class="form-control form-control-sm" name="semgrep_timeout" 
                                                       value="30" min="5" max="300">
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Frontend Tools -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Frontend Security Tools</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="eslint" id="tool-eslint">
                                            <label class="form-check-label" for="tool-eslint">
                                                <strong>ESLint</strong><br>
                                                <small class="text-muted">JavaScript/TypeScript linter</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="eslint-options">
                                            <small>
                                                <label>Configuration:</label>
                                                <select class="form-control form-control-sm" name="eslint_config">
                                                    <option value="recommended" selected>Recommended</option>
                                                    <option value="security">Security</option>
                                                    <option value="react">React</option>
                                                    <option value="typescript">TypeScript</option>
                                                </select>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" name="eslint_fix" id="eslint-fix">
                                                    <label class="form-check-label" for="eslint-fix">
                                                        Auto-fix issues
                                                    </label>
                                                </div>
                                                <label class="mt-1">Max Warnings:</label>
                                                <input type="number" class="form-control form-control-sm" name="eslint_max_warnings" 
                                                       value="50" min="0" max="1000">
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="retire" id="tool-retire">
                                            <label class="form-check-label" for="tool-retire">
                                                <strong>Retire.js</strong><br>
                                                <small class="text-muted">JS dependency vulnerability scanner</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="retire-options">
                                            <small>
                                                <label>Min Severity:</label>
                                                <select class="form-control form-control-sm" name="retire_severity">
                                                    <option value="low">Low</option>
                                                    <option value="medium" selected>Medium</option>
                                                    <option value="high">High</option>
                                                </select>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" name="retire_include_dev" id="retire-include-dev" checked>
                                                    <label class="form-check-label" for="retire-include-dev">
                                                        Include dev dependencies
                                                    </label>
                                                </div>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="npm-audit" id="tool-npm-audit">
                                            <label class="form-check-label" for="tool-npm-audit">
                                                <strong>NPM Audit</strong><br>
                                                <small class="text-muted">Node.js package vulnerability scanner</small>
                                            </label>
                                        </div>
                                        <div class="mt-2 d-none" id="npm-audit-options">
                                            <small>
                                                <label>Audit Level:</label>
                                                <select class="form-control form-control-sm" name="npm_audit_level">
                                                    <option value="low">Low</option>
                                                    <option value="moderate" selected>Moderate</option>
                                                    <option value="high">High</option>
                                                    <option value="critical">Critical</option>
                                                </select>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" name="npm_production" id="npm-production">
                                                    <label class="form-check-label" for="npm-production">
                                                        Production only
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="npm_fix" id="npm-fix">
                                                    <label class="form-check-label" for="npm-fix">
                                                        Auto-fix vulnerabilities
                                                    </label>
                                                </div>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scan Depth -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Scan Depth</label>
                                <select class="form-control" name="scan_depth">
                                    <option value="minimal">Minimal (Quick scan)</option>
                                    <option value="standard" selected>Standard (Recommended)</option>
                                    <option value="thorough">Thorough (Deep analysis)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="include_dependencies" id="include-dependencies" checked>
                                    <label class="form-check-label" for="include-dependencies">
                                        Include dependency analysis
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ZAP Scan Configuration -->
                    <div id="zap-scan-config" class="form-group d-none">
                        <label class="form-label">ZAP Security Scan Configuration</label>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Target URL</label>
                                <input type="url" class="form-control" name="target_url" 
                                       placeholder="http://localhost:3000">
                                <small class="text-muted">The URL of the running application to scan</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Scan Type</label>
                                <select class="form-control" name="zap_scan_type" onchange="handleZapScanTypeChange(this.value)">
                                    <option value="spider">Spider Scan (Discovery)</option>
                                    <option value="baseline">Baseline Scan (Quick)</option>
                                    <option value="active">Active Scan (Comprehensive)</option>
                                    <option value="passive">Passive Scan (Safe)</option>
                                </select>
                            </div>
                        </div>

                        <!-- ZAP Scan Options -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Scan Options</h6>
                            </div>
                            <div class="card-body">
                                <div id="zap-spider-options" class="zap-options">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label>Max Depth:</label>
                                            <input type="number" class="form-control form-control-sm" name="zap_max_depth" value="5" min="1" max="20">
                                        </div>
                                        <div class="col-md-4">
                                            <label>Max Children:</label>
                                            <input type="number" class="form-control form-control-sm" name="zap_max_children" value="100" min="10" max="1000">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" name="zap_recurse" checked>
                                                <label class="form-check-label">Enable recursive crawling</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="zap-active-options" class="zap-options d-none">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label>Attack Strength:</label>
                                            <select class="form-control form-control-sm" name="zap_strength">
                                                <option value="Low">Low</option>
                                                <option value="Medium" selected>Medium</option>
                                                <option value="High">High</option>
                                                <option value="Insane">Insane</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Max Rule Duration (min):</label>
                                            <input type="number" class="form-control form-control-sm" name="zap_max_rule_duration" value="5" min="1" max="60">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" name="zap_in_scope_only" checked>
                                                <label class="form-check-label">In scope only</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="zap-baseline-options" class="zap-options d-none">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Duration (minutes):</label>
                                            <input type="number" class="form-control form-control-sm" name="zap_duration" value="10" min="1" max="120">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Scan Level:</label>
                                            <select class="form-control form-control-sm" name="zap_level">
                                                <option value="Pass">Pass</option>
                                                <option value="Warn" selected>Warn</option>
                                                <option value="Fail">Fail</option>
                                                <option value="Off">Off</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="zap-passive-options" class="zap-options d-none">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Max Alerts:</label>
                                            <input type="number" class="form-control form-control-sm" name="zap_max_alerts" value="1000" min="10" max="10000">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Context Name:</label>
                                            <input type="text" class="form-control form-control-sm" name="zap_context_name" placeholder="Default Context">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Test Configuration -->
                    <div id="performance-test-config" class="form-group d-none">
                        <label class="form-label">Performance Test Configuration</label>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Target URL</label>
                                <input type="url" class="form-control" name="performance_target_url" 
                                       placeholder="http://localhost:3000">
                                <small class="text-muted">The URL of the running application to test</small>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Load Testing Parameters</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>Virtual Users:</label>
                                        <input type="number" class="form-control" name="performance_users" 
                                               value="10" min="1" max="1000">
                                        <small class="text-muted">Number of concurrent users</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Spawn Rate:</label>
                                        <input type="number" class="form-control" name="performance_spawn_rate" 
                                               value="2" min="1" max="100">
                                        <small class="text-muted">Users spawned per second</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Duration (seconds):</label>
                                        <input type="number" class="form-control" name="performance_duration" 
                                               value="60" min="10" max="3600">
                                        <small class="text-muted">Total test duration</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Think Time (ms):</label>
                                        <input type="number" class="form-control" name="performance_think_time" 
                                               value="1000" min="0" max="10000">
                                        <small class="text-muted">Delay between requests</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Configuration -->
                    <div id="ai-analysis-config" class="form-group d-none">
                        <label class="form-label">AI Code Analysis Configuration</label>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">AI Model</label>
                                <select class="form-control" name="ai_model">
                                    <option value="mistralai/mistral-small-3.2-24b-instruct" selected>Mistral Small 3.2</option>
                                    <option value="openai/gpt-4">GPT-4</option>
                                    <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                                    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Analysis Type</label>
                                <select class="form-control" name="ai_analysis_type">
                                    <option value="requirements_check" selected>Requirements Compliance</option>
                                    <option value="security_audit">Security Audit</option>
                                    <option value="code_quality">Code Quality Assessment</option>
                                    <option value="architecture_review">Architecture Review</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Analysis Requirements</label>
                            <textarea class="form-control" name="ai_requirements" rows="4"
                                      placeholder="Enter specific requirements or questions for AI analysis...
Example:
- Check for proper error handling
- Verify input validation
- Assess security best practices
- Review code documentation"></textarea>
                            <small class="text-muted">Each line will be treated as a separate requirement</small>
                        </div>
                    </div>

                    <!-- General Test Options -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Test Timeout (seconds)</label>
                                <input type="number" class="form-control" name="timeout" value="600" min="60" max="3600">
                                <small class="text-muted">Maximum time allowed for test execution</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-control" name="priority">
                                    <option value="1">Low</option>
                                    <option value="2" selected>Normal</option>
                                    <option value="3">High</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="auto_start" id="auto-start" checked>
                            <label class="form-check-label" for="auto-start">
                                Start test automatically after creation
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fail_fast" id="fail-fast">
                            <label class="form-check-label" for="fail-fast">
                                Stop test on first critical issue
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="generate_report" id="generate-report" checked>
                            <label class="form-check-label" for="generate-report">
                                Generate detailed security report
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Create Security Test
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Infrastructure Status Modal -->
<div class="modal fade" id="infrastructureStatusModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-server mr-2"></i>
                    Testing Infrastructure Status
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="infrastructure-details-content">
                <!-- Content loaded via HTMX -->
                <div class="text-center py-5">
                    <div class="spinner mb-3"></div>
                    <p class="text-muted">Loading infrastructure details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle mr-2"></i>
                    Test Details
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="test-details-content">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Test Results & Security Report
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="test-results-content">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Security Testing Platform JavaScript
class SecurityTestingPlatform {
    constructor() {
        this.autoRefreshInterval = null;
        this.infrastructureHealthInterval = null;
        this.availableModels = [];
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupAutoRefresh();
        this.loadInfrastructureHealth();
        this.loadAvailableModels();
    }

    setupEventListeners() {
        // Filter events
        document.addEventListener('change', (e) => {
            if (e.target.matches('#test-type-filter, #status-filter, #model-filter')) {
                this.applyFilters();
            }
        });

        // Tool checkbox events for showing/hiding options
        document.addEventListener('change', (e) => {
            if (e.target.matches('input[name="tools"]')) {
                this.handleToolSelection(e.target);
            }
        });

        // HTMX events
        document.addEventListener('htmx:afterRequest', (e) => {
            if (e.detail.successful && e.target.id === 'test-jobs-list') {
                this.updateStatsFromTests();
            }
        });
    }

    setupAutoRefresh() {
        // Auto-refresh every 15 seconds for active tests
        this.autoRefreshInterval = setInterval(() => {
            if (document.visibilityState === 'visible' && this.hasActiveTests()) {
                htmx.trigger('#test-jobs-list', 'refreshJobs');
            }
        }, 15000);

        // Check infrastructure health every 30 seconds
        this.infrastructureHealthInterval = setInterval(() => {
            if (document.visibilityState === 'visible') {
                this.loadInfrastructureHealth();
            }
        }, 30000);
    }

    loadInfrastructureHealth() {
        fetch('/testing/api/health')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.updateInfrastructureStatus(data.data);
                }
            })
            .catch(error => console.warn('Failed to load infrastructure health:', error));
    }

    updateInfrastructureStatus(healthData) {
        const services = healthData.testing_infrastructure?.services || {};
        
        const statusMap = {
            'security-scanner': 'security-scanner-status',
            'performance-tester': 'performance-tester-status', 
            'zap-scanner': 'zap-scanner-status',
            'test-coordinator': 'coordinator-status'
        };

        Object.entries(statusMap).forEach(([service, elementId]) => {
            const element = document.getElementById(elementId);
            if (element) {
                const isHealthy = services[service] === true;
                element.innerHTML = isHealthy 
                    ? '<i class="fas fa-check-circle"></i>' 
                    : '<i class="fas fa-times-circle"></i>';
                element.className = `mb-1 ${isHealthy ? 'text-success' : 'text-danger'}`;
            }
        });
    }

    loadAvailableModels() {
        fetch('/testing/api/models')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.availableModels = data.data;
                    this.populateModelSelects();
                }
            })
            .catch(error => console.warn('Failed to load models:', error));
    }

    populateModelSelects() {
        const modelSelects = document.querySelectorAll('#model-select, #model-filter');
        
        modelSelects.forEach(select => {
            // Clear existing options (except first one)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add model options
            this.availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id || model.name;
                option.textContent = model.display_name || model.name;
                select.appendChild(option);
            });
        });
    }

    handleToolSelection(checkbox) {
        const toolName = checkbox.value;
        const optionsDiv = document.getElementById(`${toolName}-options`);
        
        if (optionsDiv) {
            if (checkbox.checked) {
                optionsDiv.classList.remove('d-none');
            } else {
                optionsDiv.classList.add('d-none');
            }
        }
    }

    applyFilters() {
        const testType = document.getElementById('test-type-filter')?.value || '';
        const status = document.getElementById('status-filter')?.value || '';
        const model = document.getElementById('model-filter')?.value || '';

        const params = new URLSearchParams();
        if (testType) params.set('test_type', testType);
        if (status) params.set('status', status);
        if (model) params.set('model', model);

        const url = `/testing/api/jobs?${params.toString()}`;
        htmx.ajax('GET', url, {target: '#test-jobs-list'});
    }

    hasActiveTests() {
        return document.querySelectorAll('.test-status-running, .test-status-pending').length > 0;
    }

    updateStatsFromTests() {
        try {
            const testRows = document.querySelectorAll('#test-jobs-list .test-row');
            const activeTests = document.querySelectorAll('.test-status-running').length;
            const totalVulns = Array.from(testRows).reduce((sum, row) => {
                const vulnCount = row.querySelector('.vuln-count')?.textContent || '0';
                return sum + parseInt(vulnCount.match(/\d+/)?.[0] || '0');
            }, 0);
            
            // Update displayed stats
            const totalTestsEl = document.getElementById('total-tests');
            const activeTestsEl = document.getElementById('active-tests');
            const totalVulnsEl = document.getElementById('total-vulnerabilities');
            
            if (totalTestsEl) totalTestsEl.textContent = testRows.length;
            if (activeTestsEl) activeTestsEl.textContent = activeTests;
            if (totalVulnsEl) totalVulnsEl.textContent = totalVulns;
        } catch (error) {
            console.warn('Failed to update stats from tests:', error);
        }
    }

    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 6000);
    }
}

// Global functions
window.showCreateTestModal = function() {
    $('#createTestModal').modal('show');
};

window.showInfrastructureStatus = function() {
    htmx.ajax('GET', '/testing/api/infrastructure-status', {
        target: '#infrastructure-details-content'
    });
    $('#infrastructureStatusModal').modal('show');
};

window.showTestDetails = function(testId) {
    htmx.ajax('GET', `/testing/api/test/${testId}/details`, {
        target: '#test-details-content'
    });
    $('#testDetailsModal').modal('show');
};

window.showTestResults = function(testId) {
    htmx.ajax('GET', `/testing/api/test/${testId}/results`, {
        target: '#test-results-content'
    });
    $('#testResultsModal').modal('show');
};

window.handleTestTypeChange = function(testType) {
    // Hide all config sections
    const configSections = ['security-analysis-config', 'zap-scan-config', 'performance-test-config', 'ai-analysis-config'];
    configSections.forEach(section => {
        document.getElementById(section).classList.add('d-none');
    });

    // Show relevant config section
    if (testType === 'security_analysis') {
        document.getElementById('security-analysis-config').classList.remove('d-none');
    } else if (testType === 'zap_scan') {
        document.getElementById('zap-scan-config').classList.remove('d-none');
    } else if (testType === 'performance_test') {
        document.getElementById('performance-test-config').classList.remove('d-none');
    } else if (testType === 'ai_analysis') {
        document.getElementById('ai-analysis-config').classList.remove('d-none');
    }
};

window.handleZapScanTypeChange = function(scanType) {
    // Hide all ZAP option sections
    const zapOptions = document.querySelectorAll('.zap-options');
    zapOptions.forEach(option => option.classList.add('d-none'));

    // Show relevant options
    const optionsDiv = document.getElementById(`zap-${scanType}-options`);
    if (optionsDiv) {
        optionsDiv.classList.remove('d-none');
    }
};

window.startTest = function(testId, button) {
    handleTestAction('start', testId, button);
};

window.cancelTest = function(testId, button) {
    if (confirm('Are you sure you want to cancel this security test?')) {
        handleTestAction('cancel', testId, button);
    }
};

window.deleteTest = function(testId, button) {
    if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
        handleTestAction('delete', testId, button);
    }
};

function handleTestAction(action, testId, button) {
    const originalText = button.innerHTML;
    button.innerHTML = `<div class="spinner"></div> ${action}ing...`;
    button.disabled = true;

    const method = action === 'delete' ? 'DELETE' : 'POST';
    const url = `/testing/api/test/${testId}/${action}`;

    htmx.ajax(method, url)
        .then(() => {
            securityTestingPlatform.showToast(`Test ${action} successful`, 'success');
            htmx.trigger('#test-jobs-list', 'refreshJobs');
        })
        .catch(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            securityTestingPlatform.showToast(`Test ${action} failed`, 'danger');
        });
}

window.handleTestCreated = function(event) {
    if (event.detail.successful) {
        const response = JSON.parse(event.detail.xhr.response);
        if (response.success) {
            $('#createTestModal').modal('hide');
            document.getElementById('create-test-form').reset();
            // Reset config visibility
            const configSections = ['security-analysis-config', 'zap-scan-config', 'performance-test-config', 'ai-analysis-config'];
            configSections.forEach(section => {
                document.getElementById(section).classList.add('d-none');
            });
            securityTestingPlatform.showToast(response.message || 'Security test created successfully!', 'success');
            htmx.trigger('#test-jobs-list', 'refreshJobs');
        } else {
            securityTestingPlatform.showToast(response.error || 'Failed to create test', 'danger');
        }
    }
};

// Initialize
let securityTestingPlatform;
document.addEventListener('DOMContentLoaded', function() {
    securityTestingPlatform = new SecurityTestingPlatform();
    window.securityTestingPlatform = securityTestingPlatform;
});
</script>
{% endblock %}
