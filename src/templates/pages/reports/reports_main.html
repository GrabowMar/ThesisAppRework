{% extends 'layouts/base.html' %}
{% set active_page = 'reports' %}
{% set page_title = 'Reports' %}
{% set page_icon = 'fa-solid fa-file-lines' %}
{% set has_right_sidebar = true %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="card card-table-compact" data-component="reports-index">
  <div class="card-header d-flex flex-wrap align-items-center gap-3">
    <h3 class="card-title d-flex align-items-center gap-2 mb-0">
      <i class="fa-solid fa-list"></i>
      <span>All Reports</span>
    </h3>
    <div class="card-actions ms-auto">
      <div class="btn-list">
        <select id="filter-type" class="form-select form-select-sm" style="width: auto">
          <option value="">All Types</option>
          <option value="model_analysis">Model Analysis</option>
          <option value="template_comparison">Template Comparison</option>
          <option value="tool_analysis">Tool Analysis</option>
        </select>
        <select id="filter-status" class="form-select form-select-sm" style="width: auto">
          <option value="">All Status</option>
          <option value="completed">Completed</option>
          <option value="failed">Failed</option>
          <option value="generating">Generating</option>
        </select>
        <button class="btn btn-sm btn-ghost-primary btn-icon" title="Refresh" id="refresh-btn">
          <i class="fa-solid fa-sync"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-vcenter table-hover card-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Type</th>
          <th>Status</th>
          <th>Created</th>
          <th class="w-1">Actions</th>
        </tr>
      </thead>
      <tbody id="reports-list">
        {# Initial server-rendered content, will be updated by JS #}
        {% if reports %}
          {% for r in reports %}
          <tr data-report-id="{{ r.report_id }}">
            <td>
              <div class="font-weight-medium">{{ r.title }}</div>
              {% if r.description %}
              <div class="text-muted small text-truncate" style="max-width: 300px;">{{ r.description }}</div>
              {% endif %}
            </td>
            <td>
              {% set type_labels = {
                'model_analysis': 'Model Analysis',
                'template_comparison': 'Template Comparison',
                'tool_analysis': 'Tool Analysis'
              } %}
              <span class="badge bg-blue-lt">{{ type_labels.get(r.report_type, r.report_type|replace('_', ' ')|title) }}</span>
            </td>
            <td>
              {% if r.status == 'completed' %}
              <span class="badge bg-success">Completed</span>
              {% elif r.status == 'generating' %}
              <span class="badge bg-warning text-dark">
                <span class="spinner-border spinner-border-sm me-1"></span>
                Generating...
              </span>
              {% elif r.status == 'failed' %}
              <span class="badge bg-danger" title="{{ r.error_message }}">Failed</span>
              {% else %}
              <span class="badge bg-secondary">{{ r.status|capitalize }}</span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ r.created_at if r.created_at is string else (r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else 'N/A') }}</td>
            <td>
              <div class="btn-list flex-nowrap">
                {% if r.status == 'completed' %}
                <a href="{{ url_for('reports.view_report', report_id=r.report_id) }}" class="btn btn-sm btn-ghost-primary btn-icon" title="View">
                  <i class="fa-solid fa-eye"></i>
                </a>
                {% elif r.status == 'failed' %}
                <button class="btn btn-sm btn-ghost-warning btn-icon" title="View Error" 
                        onclick="showError('{{ r.error_message|default('Unknown error', true)|e }}')">
                  <i class="fa-solid fa-exclamation-triangle"></i>
                </button>
                {% else %}
                <span class="text-muted small">-</span>
                {% endif %}
                <button class="btn btn-sm btn-ghost-danger btn-icon" title="Delete" 
                        onclick="deleteReport('{{ r.report_id }}')">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr id="empty-row">
            <td colspan="5">
              <div class="empty py-5">
                <div class="empty-icon">
                  <i class="fa-solid fa-file-lines fa-3x text-muted"></i>
                </div>
                <p class="empty-title h5">No reports yet</p>
                <p class="empty-subtitle text-muted">
                  Generate your first analysis report to get started.
                </p>
                <div class="empty-action">
                  <button class="btn btn-primary" hx-get="{{ url_for('reports.new_report_form') }}" hx-target="#modal-region">
                    <i class="fa-solid fa-plus me-2"></i>Generate Report
                  </button>
                </div>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block right_sidebar %}
<div class="d-flex flex-column gap-3">
  <div class="card">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <i class="fa-solid fa-circle-info me-2 text-primary"></i>
        <h3 class="card-title mb-0">About Reports</h3>
      </div>
      <div class="text-muted small">
        Generate comprehensive analysis summaries for models, templates, and tools. Reports provide aggregated insights from all analyses.
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Report Types</h3>
    </div>
    <div class="list-group list-group-flush">
      <div class="list-group-item">
        <div class="fw-medium">Model Analysis</div>
        <div class="text-muted small">Aggregate results for a specific AI model across all its applications</div>
      </div>
      <div class="list-group-item">
        <div class="fw-medium">Template Comparison</div>
        <div class="text-muted small">Compare different models' implementations of the same template</div>
      </div>
      <div class="list-group-item">
        <div class="fw-medium">Tool Analysis</div>
        <div class="text-muted small">Analyze effectiveness of analysis tools across all results</div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Quick Actions</h3>
    </div>
    <div class="card-body d-flex flex-column gap-2">
      <button class="btn btn-primary w-100" hx-get="{{ url_for('reports.new_report_form') }}" hx-target="#modal-region">
        <i class="fa-solid fa-plus me-2"></i>Generate Report
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Reports page JavaScript
(function() {
  const filterType = document.getElementById('filter-type');
  const filterStatus = document.getElementById('filter-status');
  const refreshBtn = document.getElementById('refresh-btn');
  const reportsList = document.getElementById('reports-list');
  
  // Type label mapping
  const typeLabels = {
    'model_analysis': 'Model Analysis',
    'template_comparison': 'Template Comparison',
    'tool_analysis': 'Tool Analysis'
  };
  
  // Format date
  function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
  
  // Build status badge
  function statusBadge(status, errorMsg) {
    switch(status) {
      case 'completed':
        return '<span class="badge bg-success">Completed</span>';
      case 'generating':
        return '<span class="badge bg-warning text-dark"><span class="spinner-border spinner-border-sm me-1"></span>Generating...</span>';
      case 'failed':
        return `<span class="badge bg-danger" title="${escapeHtml(errorMsg || '')}">Failed</span>`;
      default:
        return `<span class="badge bg-secondary">${status}</span>`;
    }
  }
  
  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  
  // Build actions
  function buildActions(r) {
    let html = '<div class="btn-list flex-nowrap">';
    if (r.status === 'completed') {
      html += `<a href="/reports/view/${r.report_id}" class="btn btn-sm btn-ghost-primary btn-icon" title="View"><i class="fa-solid fa-eye"></i></a>`;
    } else if (r.status === 'failed') {
      html += `<button class="btn btn-sm btn-ghost-warning btn-icon" title="View Error" onclick="showError('${escapeHtml(r.error_message || 'Unknown error')}')"><i class="fa-solid fa-exclamation-triangle"></i></button>`;
    } else {
      html += '<span class="text-muted small">-</span>';
    }
    html += `<button class="btn btn-sm btn-ghost-danger btn-icon" title="Delete" onclick="deleteReport('${r.report_id}')"><i class="fa-solid fa-trash"></i></button>`;
    html += '</div>';
    return html;
  }
  
  // Render reports list
  function renderReports(reports) {
    if (!reports || reports.length === 0) {
      reportsList.innerHTML = `
        <tr id="empty-row">
          <td colspan="5">
            <div class="empty py-5">
              <div class="empty-icon"><i class="fa-solid fa-file-lines fa-3x text-muted"></i></div>
              <p class="empty-title h5">No reports found</p>
              <p class="empty-subtitle text-muted">Try adjusting your filters or generate a new report.</p>
              <div class="empty-action">
                <button class="btn btn-primary" hx-get="/reports/new" hx-target="#modal-region">
                  <i class="fa-solid fa-plus me-2"></i>Generate Report
                </button>
              </div>
            </div>
          </td>
        </tr>`;
      // Re-process HTMX elements
      if (window.htmx) htmx.process(reportsList);
      return;
    }
    
    reportsList.innerHTML = reports.map(r => `
      <tr data-report-id="${r.report_id}">
        <td>
          <div class="font-weight-medium">${escapeHtml(r.title)}</div>
          ${r.description ? `<div class="text-muted small text-truncate" style="max-width: 300px;">${escapeHtml(r.description)}</div>` : ''}
        </td>
        <td><span class="badge bg-blue-lt">${typeLabels[r.report_type] || r.report_type}</span></td>
        <td>${statusBadge(r.status, r.error_message)}</td>
        <td class="text-muted small">${formatDate(r.created_at)}</td>
        <td>${buildActions(r)}</td>
      </tr>
    `).join('');
  }
  
  // Fetch reports
  async function fetchReports() {
    const params = new URLSearchParams();
    if (filterType.value) params.set('report_type', filterType.value);
    if (filterStatus.value) params.set('status', filterStatus.value);
    
    try {
      refreshBtn.disabled = true;
      refreshBtn.querySelector('i').classList.add('fa-spin');
      
      const response = await fetch('/api/reports?' + params);
      const data = await response.json();
      
      if (data.success) {
        renderReports(data.reports);
      } else {
        console.error('Failed to fetch reports:', data.error);
        if (window.showToast) showToast('Failed to load reports: ' + data.error, 'error');
      }
    } catch (e) {
      console.error('Error fetching reports:', e);
      if (window.showToast) showToast('Network error loading reports', 'error');
    } finally {
      refreshBtn.disabled = false;
      refreshBtn.querySelector('i').classList.remove('fa-spin');
    }
  }
  
  // Event listeners
  filterType.addEventListener('change', fetchReports);
  filterStatus.addEventListener('change', fetchReports);
  refreshBtn.addEventListener('click', fetchReports);
  
  // Global functions for inline handlers
  window.showError = function(msg) {
    if (window.showToast) {
      showToast(msg, 'error', 10000);
    } else {
      alert('Error: ' + msg);
    }
  };
  
  window.deleteReport = async function(reportId) {
    if (!confirm('Are you sure you want to delete this report?')) return;
    
    try {
      const response = await fetch('/api/reports/' + reportId, { method: 'DELETE' });
      const data = await response.json();
      
      if (data.success) {
        // Remove row from table
        const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
        if (row) row.remove();
        if (window.showToast) showToast('Report deleted', 'success');
        // Check if table is now empty
        if (reportsList.children.length === 0) fetchReports();
      } else {
        if (window.showToast) showToast('Failed to delete: ' + data.error, 'error');
      }
    } catch (e) {
      console.error('Delete error:', e);
      if (window.showToast) showToast('Network error', 'error');
    }
  };
})();
</script>
{% endblock %}
