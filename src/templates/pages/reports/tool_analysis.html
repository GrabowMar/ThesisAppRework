{% extends 'layouts/base.html' %}
{% set page_title = 'Tool Analysis' + (' - ' + filters.tool_name if filters.tool_name else '') %}
{% set page_icon = 'fas fa-wrench' %}

{% block content %}
<div class="container-xl">
    <!-- Header -->
    <div class="page-header d-print-none">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    Tool Performance Analysis
                    {% if filters.tool_name %}
                    <span class="text-muted">for</span> {{ filters.tool_name }}
                    {% endif %}
                </h2>
                <div class="text-muted">
                    Generated {{ timestamp[:10] }} | {{ tools_count }} tools | {{ tasks_analyzed }} tasks analyzed
                    {% if filters.filter_model %} | Model: {{ filters.filter_model }}{% endif %}
                    {% if filters.filter_app %} | App: #{{ filters.filter_app }}{% endif %}
                </div>
            </div>
            <div class="col-auto">
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="ti ti-printer me-2"></i>Print Report
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row row-cards mb-3">
        <div class="col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="subheader">Total Executions</div>
                    <div class="h1 mb-3">{{ overall_stats.total_executions }}</div>
                    <div class="text-muted">Across all tools</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="subheader">Success Rate</div>
                    <div class="h1 mb-3 text-success">{{ "%.1f"|format(overall_stats.overall_success_rate) }}%</div>
                    <div class="text-muted">Successful runs</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="subheader">Total Findings</div>
                    <div class="h1 mb-3">{{ overall_stats.total_findings }}</div>
                    <div class="text-muted">Issues detected</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="subheader">Best Tool</div>
                    <div class="h3 mb-2">{{ insights.best_success_rate_tool or 'N/A' }}</div>
                    <div class="text-muted small">Highest success rate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights -->
    <div class="row row-cards mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance Insights</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="text-muted small mb-1">Fastest Tool</div>
                        <div class="h4">{{ insights.fastest_tool or 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="text-muted small mb-1">Slowest Tool</div>
                        <div class="h4">{{ insights.slowest_tool or 'N/A' }}</div>
                    </div>
                    <div>
                        <div class="text-muted small mb-1">Most Findings</div>
                        <div class="h4">{{ insights.most_findings_tool or 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Reliability Insights</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="text-muted small mb-1">Most Reliable</div>
                        <div class="h4">{{ insights.best_success_rate_tool or 'N/A' }}</div>
                    </div>
                    <div>
                        <div class="text-muted small mb-1">Least Reliable</div>
                        <div class="h4">{{ insights.worst_success_rate_tool or 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tool Statistics Table -->
    <div class="card mb-3">
        <div class="card-header">
            <h3 class="card-title">Detailed Tool Statistics</h3>
        </div>
        <div class="table-responsive">
            <table class="table table-vcenter card-table">
                <thead>
                    <tr>
                        <th>Tool</th>
                        <th>Executions</th>
                        <th>Success Rate</th>
                        <th>Findings</th>
                        <th>Critical</th>
                        <th>High</th>
                        <th>Medium</th>
                        <th>Avg Duration</th>
                        <th>Avg Findings/Run</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tool in tools %}
                    <tr>
                        <td><strong><code>{{ tool.tool_name }}</code></strong></td>
                        <td>{{ tool.total_executions }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress me-2" style="width: 80px;">
                                    <div class="progress-bar {% if tool.success_rate >= 90 %}bg-success{% elif tool.success_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         style="width: {{ tool.success_rate }}%">
                                    </div>
                                </div>
                                <span>{{ "%.1f"|format(tool.success_rate) }}%</span>
                            </div>
                        </td>
                        <td><strong>{{ tool.total_findings }}</strong></td>
                        <td><span class="badge bg-danger">{{ tool.findings_by_severity.critical }}</span></td>
                        <td><span class="badge bg-warning">{{ tool.findings_by_severity.high }}</span></td>
                        <td><span class="badge bg-info">{{ tool.findings_by_severity.medium }}</span></td>
                        <td class="text-muted">{{ "%.2f"|format(tool.average_duration) }}s</td>
                        <td>{{ "%.1f"|format(tool.average_findings_per_execution) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Per-Tool Breakdown -->
    {% for tool in tools %}
    <div class="card mb-3">
        <div class="card-header">
            <h3 class="card-title">
                <code>{{ tool.tool_name }}</code> Detailed Analysis
            </h3>
        </div>
        <div class="card-body">
            <!-- Tool Summary -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="mb-2">
                        <div class="text-muted small">Total Executions</div>
                        <div class="h3">{{ tool.total_executions }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-2">
                        <div class="text-muted small">Success / Failure</div>
                        <div class="h3">
                            <span class="text-success">{{ tool.successful }}</span> / 
                            <span class="text-danger">{{ tool.failed }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-2">
                        <div class="text-muted small">Total Findings</div>
                        <div class="h3">{{ tool.total_findings }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-2">
                        <div class="text-muted small">Average Duration</div>
                        <div class="h3">{{ "%.2f"|format(tool.average_duration) }}s</div>
                    </div>
                </div>
            </div>

            <!-- Severity Distribution -->
            <div class="mb-3">
                <h4 class="mb-2">Severity Distribution</h4>
                <div class="progress">
                    {% set total = tool.findings_by_severity.critical + tool.findings_by_severity.high + tool.findings_by_severity.medium + tool.findings_by_severity.low %}
                    {% if total > 0 %}
                    <div class="progress-bar bg-danger" style="width: {{ (tool.findings_by_severity.critical / total * 100) }}%" 
                         title="Critical: {{ tool.findings_by_severity.critical }}">
                        {% if tool.findings_by_severity.critical > 0 %}{{ tool.findings_by_severity.critical }}{% endif %}
                    </div>
                    <div class="progress-bar bg-warning" style="width: {{ (tool.findings_by_severity.high / total * 100) }}%"
                         title="High: {{ tool.findings_by_severity.high }}">
                        {% if tool.findings_by_severity.high > 0 %}{{ tool.findings_by_severity.high }}{% endif %}
                    </div>
                    <div class="progress-bar bg-info" style="width: {{ (tool.findings_by_severity.medium / total * 100) }}%"
                         title="Medium: {{ tool.findings_by_severity.medium }}">
                        {% if tool.findings_by_severity.medium > 0 %}{{ tool.findings_by_severity.medium }}{% endif %}
                    </div>
                    <div class="progress-bar bg-secondary" style="width: {{ (tool.findings_by_severity.low / total * 100) }}%"
                         title="Low: {{ tool.findings_by_severity.low }}">
                        {% if tool.findings_by_severity.low > 0 %}{{ tool.findings_by_severity.low }}{% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Model Performance -->
            <div class="mb-3">
                <h4 class="mb-2">Performance by Model</h4>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Executions</th>
                                <th>Successful</th>
                                <th>Findings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model, count in tool.executions_by_model.items() %}
                            <tr>
                                <td>{{ model }}</td>
                                <td>{{ count }}</td>
                                <td>
                                    {% if model in tool.success_by_model %}
                                    <span class="text-success">{{ tool.success_by_model[model] }}</span>
                                    {% else %}
                                    <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if model in tool.findings_by_model %}
                                    {{ tool.findings_by_model[model] }}
                                    {% else %}
                                    0
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Execution Timeline -->
            <div class="accordion" id="accordion-{{ loop.index }}">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse-{{ loop.index }}">
                            View Execution Timeline ({{ tool.execution_timeline|length }} runs)
                        </button>
                    </h2>
                    <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Model</th>
                                            <th>App</th>
                                            <th>Status</th>
                                            <th>Findings</th>
                                            <th>Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for execution in tool.execution_timeline[:50] %}
                                        <tr>
                                            <td class="text-muted small">{{ execution.date[:10] if execution.date else 'N/A' }}</td>
                                            <td>{{ execution.model }}</td>
                                            <td>App #{{ execution.app }}</td>
                                            <td>
                                                {% if execution.success %}
                                                <span class="badge bg-success">Success</span>
                                                {% else %}
                                                <span class="badge bg-danger">Failed</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ execution.findings }}</td>
                                            <td class="text-muted">{{ "%.2f"|format(execution.duration) }}s</td>
                                        </tr>
                                        {% endfor %}
                                        {% if tool.execution_timeline|length > 50 %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                ... and {{ tool.execution_timeline|length - 50 }} more executions
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
