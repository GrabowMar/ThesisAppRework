{# Base Report Template #}
{% extends 'layouts/base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis-report.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/report-print.css') }}">
<style>
  @media print {
    .btn, .navbar, .sidebar, footer, .no-print { display: none !important; }
    .report-container { max-width: 100% !important; margin: 0 !important; }
    .card { break-inside: avoid; page-break-inside: avoid; }
  }
</style>
{% endblock %}

{% block content %}
<div class="report-container py-4">
  {# Report Header #}
  <div class="report-header mb-4 pb-3 border-bottom">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h1 class="mb-1">{{ report.title }}</h1>
        {% if report.description %}
        <p class="text-muted mb-2">{{ report.description }}</p>
        {% endif %}
        <div class="text-muted small">
          <i class="fas fa-calendar me-2"></i>Generated: {{ data.timestamp or 'N/A' }}
        </div>
      </div>
      <div class="no-print">
        <button class="btn btn-primary" onclick="window.print()">
          <i class="fas fa-print me-2"></i>Print
        </button>
        <a href="/api/reports/{{ report.report_id }}/download" class="btn btn-outline-primary">
          <i class="fas fa-download me-2"></i>Download
        </a>
      </div>
    </div>
  </div>

  {# App Analysis Summary #}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h4 mb-0">Analysis Summary</h2>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="metric-box">
            <div class="metric-label">Model</div>
            <div class="metric-value">{{ data.model_slug or 'N/A' }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-box">
            <div class="metric-label">App Number</div>
            <div class="metric-value">#{{ data.app_number or 'N/A' }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-box">
            <div class="metric-label">Task ID</div>
            <div class="metric-value text-truncate" title="{{ data.task_id }}">{{ data.task_id or 'N/A' }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-box">
            <div class="metric-label">Total Findings</div>
            <div class="metric-value text-danger">{{ data.summary.total_findings or 0 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Severity Breakdown #}
  {% if data.summary.severity_breakdown %}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Severity Distribution</h2>
    </div>
    <div class="card-body">
      <div class="row g-3">
        {% for severity, count in data.summary.severity_breakdown.items() %}
        <div class="col-md-{{ 12 // data.summary.severity_breakdown|length if data.summary.severity_breakdown|length <= 5 else 2 }}">
          <div class="severity-box severity-{{ severity }}">
            <div class="severity-label">{{ severity|capitalize }}</div>
            <div class="severity-count">{{ count }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {# Tools Execution Status #}
  {% if data.tools %}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Tools Execution Status</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Tool</th>
              <th>Status</th>
              <th>Issues Found</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody>
            {% for tool_name, tool_data in data.tools.items() %}
            <tr>
              <td><strong>{{ tool_name }}</strong></td>
              <td>
                {% if tool_data.status in ['success', 'ok', 'completed', 'no_issues'] %}
                <span class="badge bg-success" title="Tool executed successfully">
                  <i class="fa-solid fa-check"></i> Success
                </span>
                {% elif tool_data.status in ['failed', 'error'] %}
                <span class="badge bg-danger" title="Tool execution failed">
                  <i class="fa-solid fa-xmark"></i> Error
                </span>
                {% else %}
                <span class="badge bg-secondary">{{ tool_data.status|capitalize }}</span>
                {% endif %}
              </td>
              <td>
                {% set issue_count = tool_data.issue_count|default(tool_data.total_issues)|default(0) %}
                {% if issue_count > 0 %}
                  <span class="badge bg-warning">{{ issue_count }}</span>
                {% else %}
                  <span class="text-success"><i class="fa-solid fa-check"></i> 0</span>
                {% endif %}
              </td>
              <td>{{ "%.2f"|format(tool_data.duration_seconds or 0) }}s</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {# Findings Table #}
  {% if data.findings %}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Findings Detail ({{ data.findings|length }} total)</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Severity</th>
              <th>Tool</th>
              <th>Category</th>
              <th>Location</th>
              <th>Title</th>
            </tr>
          </thead>
          <tbody>
            {% for finding in data.findings[:100] %}{# Limit to first 100 for print #}
            <tr>
              <td>
                <span class="badge bg-{{ 'danger' if finding.severity in ['critical', 'high'] else 'warning' if finding.severity == 'medium' else 'info' }}">
                  {{ finding.severity|capitalize }}
                </span>
              </td>
              <td>{{ finding.tool }}</td>
              <td>{{ finding.category }}</td>
              <td class="text-truncate" style="max-width: 200px;">
                {% if finding.file %}
                {{ finding.file.path }}:{{ finding.file.line_start or '' }}
                {% else %}
                N/A
                {% endif %}
              </td>
              <td>{{ finding.message.title if finding.message else finding.id }}</td>
            </tr>
            {% endfor %}
            {% if data.findings|length > 100 %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                <em>{{ data.findings|length - 100 }} more findings not shown in print view</em>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {# Footer #}
  <div class="report-footer mt-5 pt-3 border-top text-muted small">
    <div class="row">
      <div class="col-md-6">
        <strong>Report ID:</strong> {{ report.report_id }}<br>
        <strong>Generated:</strong> {{ data.timestamp }}
      </div>
      <div class="col-md-6 text-end">
        <strong>System:</strong> ThesisApp Analysis Platform<br>
        <strong>Format:</strong> {{ report.format|upper }}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Report-specific scripts
document.addEventListener('DOMContentLoaded', function() {
  console.log('App analysis report loaded');
});
</script>
{% endblock %}
