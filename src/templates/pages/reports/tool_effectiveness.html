{# Tool Effectiveness Report Template #}
{% extends 'layouts/base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis-report.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/report-print.css') }}">
{% endblock %}

{% block content %}
<div class="report-container py-4">
  {# Report Header #}
  <div class="report-header mb-4 pb-3 border-bottom">
    <h1 class="mb-1">{{ report.title }}</h1>
    <p class="text-muted">Analysis tool performance and effectiveness metrics</p>
    <div class="text-muted small">
      <i class="fas fa-calendar me-2"></i>Generated: {{ data.timestamp or 'N/A' }}
      {% if data.date_range.start or data.date_range.end %}
      <br><i class="fas fa-filter me-2"></i>Period: 
      {{ data.date_range.start[:10] if data.date_range.start else 'Beginning' }} to 
      {{ data.date_range.end[:10] if data.date_range.end else 'Now' }}
      {% endif %}
    </div>
  </div>

  {# Summary Metrics #}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Overview</h2>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="metric-box">
            <div class="metric-label">Tools Analyzed</div>
            <div class="metric-value">{{ data.tools|length }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="metric-box">
            <div class="metric-label">Tasks Analyzed</div>
            <div class="metric-value">{{ data.total_tasks_analyzed }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="metric-box">
            <div class="metric-label">Total Findings</div>
            <div class="metric-value">
              {% set total = namespace(value=0) %}
              {% for tool, stats in data.tools.items() %}
                {% set total.value = total.value + stats.total_findings %}
              {% endfor %}
              {{ total.value }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Tool Statistics Table #}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Tool Performance Metrics</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Tool</th>
              <th class="text-center">Total Runs</th>
              <th class="text-center">Success Rate</th>
              <th class="text-center">Total Findings</th>
              <th class="text-center">Avg Findings/Run</th>
              <th class="text-center">Avg Duration</th>
            </tr>
          </thead>
          <tbody>
            {% for tool_name, stats in data.tools.items()|sort(attribute='1.total_findings', reverse=True) %}
            <tr>
              <td><strong>{{ tool_name }}</strong></td>
              <td class="text-center">{{ stats.total_runs }}</td>
              <td class="text-center">
                {% set rate = stats.success_rate %}
                <span class="badge bg-{{ 'success' if rate >= 90 else 'warning' if rate >= 70 else 'danger' }}">
                  {{ "%.1f"|format(rate) }}%
                </span>
              </td>
              <td class="text-center">{{ stats.total_findings }}</td>
              <td class="text-center">{{ "%.1f"|format(stats.avg_findings_per_run) }}</td>
              <td class="text-center">{{ "%.2f"|format(stats.avg_duration) }}s</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Severity Distribution by Tool #}
  <div class="card mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Severity Distribution by Tool</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Tool</th>
              <th class="text-center">Critical</th>
              <th class="text-center">High</th>
              <th class="text-center">Medium</th>
              <th class="text-center">Low</th>
              <th class="text-center">Info</th>
            </tr>
          </thead>
          <tbody>
            {% for tool_name, stats in data.tools.items()|sort %}
            {% set severity = stats.severity_breakdown %}
            <tr>
              <td><strong>{{ tool_name }}</strong></td>
              <td class="text-center">
                <span class="badge bg-danger">{{ severity.get('critical', 0) }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-warning">{{ severity.get('high', 0) }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-info">{{ severity.get('medium', 0) }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ severity.get('low', 0) }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-light text-dark">{{ severity.get('info', 0) }}</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Tool Rankings #}
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="h6 mb-0">Most Findings</h3>
        </div>
        <div class="card-body">
          <ol class="mb-0">
            {% for tool_name, stats in data.tools.items()|sort(attribute='1.total_findings', reverse=True)|list[:5] %}
            <li>
              <strong>{{ tool_name }}</strong>: {{ stats.total_findings }} findings
              <small class="text-muted">({{ "%.1f"|format(stats.avg_findings_per_run) }}/run)</small>
            </li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="h6 mb-0">Highest Success Rate</h3>
        </div>
        <div class="card-body">
          <ol class="mb-0">
            {% for tool_name, stats in data.tools.items()|sort(attribute='1.success_rate', reverse=True)|list[:5] %}
            <li>
              <strong>{{ tool_name }}</strong>: {{ "%.1f"|format(stats.success_rate) }}%
              <small class="text-muted">({{ stats.successful_runs }}/{{ stats.total_runs }} runs)</small>
            </li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>
  </div>

  {# Report Footer #}
  <div class="report-footer mt-5 pt-3 border-top text-muted small">
    <div class="row">
      <div class="col-md-6">
        <strong>Report ID:</strong> {{ report.report_id }}<br>
        <strong>Tools:</strong> {{ data.tools|length }}
      </div>
      <div class="col-md-6 text-end">
        <strong>Generated:</strong> {{ data.timestamp }}<br>
        <strong>Tasks:</strong> {{ data.total_tasks_analyzed }}
      </div>
    </div>
  </div>
</div>
{% endblock %}
