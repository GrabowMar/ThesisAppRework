{# Modal fragment for HTMX-loaded report generation form #}
<div class="modal modal-blur fade" id="report-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate New Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {# Loading state while fetching options #}
        <div id="modal-loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="text-muted mt-2">Loading options...</p>
        </div>
        
        {# Error state #}
        <div id="modal-error" class="d-none">
          <div class="alert alert-danger">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            <span id="modal-error-message">Failed to load options</span>
          </div>
        </div>
        
        {# Form (hidden until options loaded) #}
        <form id="report-form" class="d-none">
          {# Report Type #}
          <div class="mb-3">
            <label for="report-type" class="form-label required">Report Type</label>
            <select class="form-select" id="report-type" name="report_type" required>
              <option value="">Select report type...</option>
              <option value="model_analysis">Model Analysis - All analyses for one model</option>
              <option value="template_comparison">Template Comparison - Compare models for same template</option>
              <option value="tool_analysis">Tool Analysis - Tool performance across all analyses</option>
              <option value="generation_analytics">Generation Analytics - App generation success/failure patterns</option>
            </select>
            <div class="form-text">Choose what perspective you want to analyze</div>
          </div>

          {# Dynamic Configuration Fields #}
          <div id="config-fields">
            <div class="alert alert-info">
              <div class="d-flex">
                <div><i class="fa-solid fa-arrow-up me-2" aria-hidden="true"></i></div>
                <div>Select a report type above to configure options</div>
              </div>
            </div>
          </div>

          {# Optional Title #}
          <div class="mb-3">
            <label for="title" class="form-label">Custom Title (Optional)</label>
            <input type="text" class="form-control" id="title" name="title" placeholder="Leave blank for auto-generated title">
          </div>
          
          {# Filter Mode #}
          <div class="mb-3">
            <label for="filter-mode" class="form-label">Analyzer Filter Mode</label>
            <select class="form-select" id="filter-mode" name="filter_mode">
              <option value="all" selected>All Analyzers (Static + Dynamic + Performance + AI)</option>
              <option value="exclude_dynamic_perf">Exclude Dynamic & Performance (Static + AI only)</option>
              <option value="only_dynamic_perf">Only Dynamic & Performance</option>
            </select>
            <div class="form-text">
              <i class="fa-solid fa-info-circle me-1"></i>
              Use "Exclude Dynamic & Performance" when runtime tests don't work for all apps. This ensures methodologically consistent comparisons.
            </div>
          </div>
          
          {# Optional Description #}
          <div class="mb-3">
            <label for="description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="description" name="description" rows="2" placeholder="Brief description of this report"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary ms-auto" id="submit-report-btn" disabled>
          <i class="fa-solid fa-file-lines me-2"></i>Generate Report
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('report-modal');
  const form = document.getElementById('report-form');
  const reportTypeSelect = document.getElementById('report-type');
  const configFields = document.getElementById('config-fields');
  const submitBtn = document.getElementById('submit-report-btn');
  const loadingDiv = document.getElementById('modal-loading');
  const errorDiv = document.getElementById('modal-error');
  const errorMessage = document.getElementById('modal-error-message');
  
  // Cache for API data
  let optionsData = null;
  
  // Initialize and show modal using Bootstrap API
  const bsModal = new bootstrap.Modal(modal, { focus: true });
  bsModal.show();
  
  // Proper cleanup on ANY modal close
  modal.addEventListener('hidden.bs.modal', () => {
    bsModal.dispose();
    modal.remove();
  }, { once: true });
  
  // Fetch options from API
  async function loadOptions() {
    try {
      const response = await fetch('/api/reports/options');
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to load options');
      }
      
      optionsData = data;
      loadingDiv.classList.add('d-none');
      form.classList.remove('d-none');
      submitBtn.disabled = false;
      
    } catch (e) {
      console.error('Failed to load options:', e);
      loadingDiv.classList.add('d-none');
      errorMessage.textContent = e.message || 'Failed to load options';
      errorDiv.classList.remove('d-none');
    }
  }
  
  // Build model dropdown
  function buildModelSelect(selectedValue = '') {
    if (!optionsData?.models?.length) {
      return '<option value="">No models available</option>';
    }
    
    const options = optionsData.models.map(m => {
      const selected = m.slug === selectedValue ? 'selected' : '';
      return `<option value="${m.slug}" ${selected}>${m.name} (${m.provider})</option>`;
    }).join('');
    return `<option value="">Select model...</option>${options}`;
  }
  
  // Build template dropdown
  function buildTemplateSelect() {
    if (!optionsData?.templates?.length) {
      return '<option value="">No templates available</option>';
    }
    
    // Group by category
    const byCategory = {};
    optionsData.templates.forEach(t => {
      const cat = t.category || 'general';
      if (!byCategory[cat]) byCategory[cat] = [];
      byCategory[cat].push(t);
    });
    
    let html = '<option value="">Select template...</option>';
    Object.keys(byCategory).sort().forEach(cat => {
      html += `<optgroup label="${cat.charAt(0).toUpperCase() + cat.slice(1)}">`;
      byCategory[cat].forEach(t => {
        html += `<option value="${t.slug}">${t.name}</option>`;
      });
      html += '</optgroup>';
    });
    return html;
  }
  
  // Build tools dropdown
  function buildToolsSelect() {
    if (!optionsData?.tools?.length) {
      return '<option value="">No tools available</option>';
    }
    
    // Group by container
    const byContainer = {};
    optionsData.tools.forEach(t => {
      if (!byContainer[t.container]) byContainer[t.container] = [];
      byContainer[t.container].push(t);
    });
    
    let html = '<option value="">All tools (analyze everything)</option>';
    Object.keys(byContainer).sort().forEach(container => {
      const label = container.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase());
      html += `<optgroup label="${label}">`;
      byContainer[container].forEach(t => {
        const avail = t.available ? '' : ' (unavailable)';
        html += `<option value="${t.name}">${t.display_name}${avail}</option>`;
      });
      html += '</optgroup>';
    });
    return html;
  }
  
  // Configuration templates for each report type
  const configs = {
    model_analysis: () => `
      <div class="mb-3">
        <label class="form-label required">Model</label>
        <select class="form-select" name="model_slug" required>
          ${buildModelSelect()}
        </select>
        <div class="form-text">View all analyses for this model across all apps</div>
      </div>
    `,
    
    template_comparison: () => `
      <div class="mb-3">
        <label class="form-label required">Template</label>
        <select class="form-select" name="template_slug" required>
          ${buildTemplateSelect()}
        </select>
        <div class="form-text">Compare all models' implementations of this template</div>
      </div>
      <div class="mb-3">
        <label class="form-label">Filter by Models (Optional)</label>
        <select class="form-select" name="filter_models" multiple size="5">
          ${optionsData?.models?.map(m => 
            `<option value="${m.slug}">${m.name} (${m.provider})</option>`
          ).join('') || ''}
        </select>
        <div class="form-text">Leave empty to compare all models, or select specific ones (Ctrl+click)</div>
      </div>
    `,
    
    tool_analysis: () => `
      <div class="mb-3">
        <label class="form-label">Specific Tool (Optional)</label>
        <select class="form-select" name="tool_name">
          ${buildToolsSelect()}
        </select>
        <div class="form-text">Select a specific tool or leave blank to analyze all tools</div>
      </div>
      <div class="mb-3">
        <label class="form-label">Filter by Model (Optional)</label>
        <select class="form-select" name="filter_model">
          <option value="">All models</option>
          ${optionsData?.models?.map(m =>
            `<option value="${m.slug}">${m.name} (${m.provider})</option>`
          ).join('') || ''}
        </select>
      </div>
    `,

    generation_analytics: () => `
      <div class="mb-3">
        <label class="form-label">Filter by Model (Optional)</label>
        <select class="form-select" name="model_slug">
          <option value="">All models</option>
          ${optionsData?.models?.map(m =>
            `<option value="${m.slug}">${m.name} (${m.provider})</option>`
          ).join('') || ''}
        </select>
        <div class="form-text">Analyze generation patterns for a specific model or all models</div>
      </div>
      <div class="mb-3">
        <label class="form-label">Filter by Template (Optional)</label>
        <select class="form-select" name="template_slug">
          ${buildTemplateSelect()}
        </select>
        <div class="form-text">Analyze generation patterns for a specific template or all templates</div>
      </div>
      <div class="mb-3">
        <label class="form-label">Time Period</label>
        <select class="form-select" name="days_back">
          <option value="7">Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="60">Last 60 days</option>
          <option value="90">Last 90 days</option>
          <option value="">All time</option>
        </select>
        <div class="form-text">Analyze generation attempts within this time period</div>
      </div>
    `
  };
  
  // Update config fields on type change
  reportTypeSelect.addEventListener('change', function() {
    const reportType = this.value;
    
    if (!reportType || !optionsData) {
      configFields.innerHTML = '<div class="alert alert-info"><div class="d-flex"><div><i class="fa-solid fa-arrow-up me-2" aria-hidden="true"></i></div><div>Select a report type above to configure options</div></div></div>';
      return;
    }
    
    const configFn = configs[reportType];
    if (configFn) {
      configFields.innerHTML = configFn();
    } else {
      configFields.innerHTML = '';
    }
  });
  
  // Handle form submission
  submitBtn.addEventListener('click', async function() {
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    
    try {
      const formData = new FormData(form);
      const reportType = formData.get('report_type');
      
      const payload = {
        report_type: reportType,
        title: formData.get('title') || null,
        description: formData.get('description') || null,
        filter_mode: formData.get('filter_mode') || 'all',
        config: {}
      };
      
      // Build config based on report type
      if (reportType === 'model_analysis') {
        payload.config.model_slug = formData.get('model_slug');
      } else if (reportType === 'template_comparison') {
        payload.config.template_slug = formData.get('template_slug');

        // Get selected filter models if any
        const filterModels = Array.from(form.querySelectorAll('[name="filter_models"] option:checked'))
          .map(opt => opt.value)
          .filter(v => v);
        if (filterModels.length > 0) {
          payload.config.filter_models = filterModels;
        }
      } else if (reportType === 'tool_analysis') {
        const toolName = formData.get('tool_name');
        if (toolName) payload.config.tool_name = toolName;

        const filterModel = formData.get('filter_model');
        if (filterModel) payload.config.filter_model = filterModel;
      } else if (reportType === 'generation_analytics') {
        const modelSlug = formData.get('model_slug');
        if (modelSlug) payload.config.model_slug = modelSlug;

        const templateSlug = formData.get('template_slug');
        if (templateSlug) payload.config.template_slug = templateSlug;

        const daysBack = formData.get('days_back');
        if (daysBack) payload.config.days_back = parseInt(daysBack, 10);
      }
      
      const response = await fetch('/api/reports/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      const result = await response.json();
      
      if (result.success) {
        if (window.showToast) {
          window.showToast('Report generated successfully!', 'success');
        }
        bsModal.hide();
        // Reload page to show new report
        setTimeout(() => window.location.reload(), 500);
      } else {
        throw new Error(result.error || 'Failed to generate report');
      }
      
    } catch (error) {
      console.error('Report generation error:', error);
      if (window.showToast) {
        window.showToast(error.message, 'error');
      } else {
        alert('Error: ' + error.message);
      }
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa-solid fa-file-lines me-2"></i>Generate Report';
    }
  });
  
  // Start loading options
  loadOptions();
})();
</script>
