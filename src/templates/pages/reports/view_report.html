{# Report Viewer — server-rendered accordion layout (v2 compact) #}
{% extends 'layouts/base_smart.html' %}
{% set active_page = 'reports' %}
{% set page_title = report.title or 'Report' %}
{% set page_icon = 'fa-solid fa-file-lines' %}

{% set type_meta = {
  'model_analysis':       ('Model Analysis',       'azure',  'fa-brain'),
  'template_comparison':  ('Template Comparison',   'purple', 'fa-code-compare'),
  'tool_analysis':        ('Tool Analysis',         'teal',   'fa-wrench'),
  'generation_analytics': ('Generation Analytics',  'orange', 'fa-chart-line'),
  'comprehensive':        ('Comprehensive Report',  'red',    'fa-layer-group')
} %}
{% set rt = report.report_type %}
{% set tm = type_meta.get(rt, (rt|replace('_',' ')|title, 'secondary', 'fa-file')) %}
{% set sev_colors = {'critical':'danger','high':'orange','medium':'warning','low':'success','info':'info'} %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail-pages.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis-report.css') }}">
<style>
  @media print {
    .btn, .navbar, .sidebar, footer, .no-print, .section-jump-nav { display: none !important; }
    .container-xl { max-width: 100% !important; margin: 0 !important; }
    .card { break-inside: avoid; }
    .accordion-collapse { display: block !important; }
  }
  .mc { text-align:center; padding:0.5rem 0.25rem; }
  .mc .mv { font-size:1.25rem; font-weight:700; line-height:1.2; }
  .mc .ml { font-size:0.7rem; color:var(--tblr-secondary); text-transform:uppercase; letter-spacing:0.03em; }
  .mc .mh { font-size:0.65rem; color:var(--tblr-secondary); opacity:0.7; }
  .finding-row { border-left:3px solid; padding-left:8px; }
  .finding-row.severity-critical { border-color:var(--tblr-danger); }
  .finding-row.severity-high { border-color:var(--tblr-orange); }
  .finding-row.severity-medium { border-color:var(--tblr-yellow); }
  .finding-row.severity-low { border-color:var(--tblr-success); }
  .finding-row.severity-info { border-color:var(--tblr-info); }
  .chart-box { position:relative; height:200px; }
  .sev-bar { height:6px; border-radius:3px; display:inline-block; }
  .compact-table th, .compact-table td { padding:0.25rem 0.5rem; font-size:0.8rem; }
  .accordion-button { padding:0.5rem 0.75rem; font-size:0.875rem; }
  .accordion-body { padding:0.75rem; }
</style>
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="research-detail-shell" id="report-detail-container">

  {# ── Header ── #}
  <div class="research-header no-print">
    <div class="d-flex align-items-center gap-1 me-2">
      <a href="{{ url_for('reports.reports_index') }}" class="btn btn-ghost-secondary btn-icon btn-sm" title="Back"><i class="fa-solid fa-arrow-left"></i></a>
      {% if prev_report_id %}<a href="{{ url_for('reports.view_report', report_id=prev_report_id) }}" class="btn btn-ghost-secondary btn-icon btn-sm" title="Previous"><i class="fa-solid fa-chevron-left"></i></a>{% endif %}
      {% if next_report_id %}<a href="{{ url_for('reports.view_report', report_id=next_report_id) }}" class="btn btn-ghost-secondary btn-icon btn-sm" title="Next"><i class="fa-solid fa-chevron-right"></i></a>{% endif %}
    </div>
    <div class="research-header-icon"><i class="fa-solid {{ tm[2] }}"></i></div>
    <div class="research-header-identity">
      <div class="research-header-pretitle">
        <span class="badge bg-{{ tm[1] }}-lt text-{{ tm[1] }}">{{ tm[0] }}</span>
        {% set cfg = report.config if report.config is mapping else {} %}
        {% if cfg.get('model_slug') %}<span class="badge bg-azure-lt text-azure ms-1">{{ cfg.model_slug }}</span>{% endif %}
        {% if cfg.get('template_slug') %}<span class="badge bg-purple-lt text-purple ms-1">{{ cfg.template_slug }}</span>{% endif %}
        {% if cfg.get('filter_mode') and cfg.filter_mode != 'all' %}<span class="badge bg-warning-lt text-warning ms-1"><i class="fa-solid fa-filter me-1"></i>{{ cfg.filter_mode|replace('_',' ')|title }}</span>{% endif %}
      </div>
      <h1 class="research-header-title">{{ report.title }}</h1>
      {% if report.description %}<div class="research-header-subtitle">{{ report.description }}</div>{% endif %}
      <div class="research-header-subtitle mt-1">
        {% if report.created_at %}<span><i class="fa-solid fa-calendar me-1"></i>{{ report.created_at[:16] if report.created_at is string else report.created_at }}</span>{% endif %}
      </div>
    </div>
    <div class="research-header-actions">
      <button class="btn btn-ghost-secondary btn-icon btn-sm" onclick="navigator.clipboard.writeText(location.href).then(()=>{if(window.showToast)showToast('Link copied','success')})" title="Copy Link"><i class="fa-solid fa-link"></i></button>
      <button class="btn btn-ghost-primary btn-sm" onclick="window.print()" title="Print"><i class="fa-solid fa-print"></i></button>
      <a href="/api/reports/{{ report_id }}/data" target="_blank" class="btn btn-ghost-primary btn-sm" title="JSON"><i class="fa-solid fa-download"></i></a>
      {% set regen_url = '/api/reports/' ~ report_id ~ '/regenerate' %}
      {% set list_url = url_for('reports.reports_index') %}
      <button class="btn btn-ghost-warning btn-sm" onclick="if(confirm('Regenerate?'))fetch('{{ regen_url }}',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){if(window.showToast)showToast('Queued','success');setTimeout(()=>location.href='{{ list_url }}',800)}else{if(window.showToast)showToast(d.error,'error')}})" title="Regenerate"><i class="fa-solid fa-rotate"></i></button>
    </div>
  </div>

  {# ── Section Jump Nav ── #}
  <div class="section-jump-nav no-print mb-2" id="sectionJumpNav">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      {% if rt == 'model_analysis' %}
        <a href="#s-overview" class="section-nav-link active">Overview</a>
        <a href="#s-quality" class="section-nav-link">Code Quality</a>
        <a href="#s-tools" class="section-nav-link">Tools</a>
        <a href="#s-apps" class="section-nav-link">Applications</a>
        <a href="#s-issues" class="section-nav-link">Common Issues</a>
        <a href="#s-generation" class="section-nav-link">Generation</a>
        <a href="#s-execution" class="section-nav-link">Execution</a>
        <a href="#s-docker" class="section-nav-link">Docker</a>
      {% elif rt == 'template_comparison' %}
        <a href="#s-overview" class="section-nav-link active">Overview</a>
        <a href="#s-rankings" class="section-nav-link">Rankings</a>
        <a href="#s-comparison" class="section-nav-link">Comparison</a>
        <a href="#s-issues" class="section-nav-link">Common Issues</a>
        <a href="#s-generation" class="section-nav-link">Generation</a>
      {% elif rt == 'tool_analysis' %}
        <a href="#s-overview" class="section-nav-link active">Overview</a>
        <a href="#s-tools" class="section-nav-link">Tool Details</a>
        <a href="#s-models" class="section-nav-link">By Model</a>
        <a href="#s-issues" class="section-nav-link">Common Issues</a>
      {% elif rt == 'generation_analytics' %}
        <a href="#s-overview" class="section-nav-link active">Overview</a>
        <a href="#s-models" class="section-nav-link">By Model</a>
        <a href="#s-templates" class="section-nav-link">By Template</a>
        <a href="#s-fixes" class="section-nav-link">Fixes</a>
      {% elif rt == 'comprehensive' %}
        <a href="#s-overview" class="section-nav-link active">Overview</a>
        <a href="#s-rankings" class="section-nav-link">Leaderboard</a>
        <a href="#s-codemetrics" class="section-nav-link">Code Metrics</a>
        <a href="#s-static" class="section-nav-link">Static Tools</a>
        <a href="#s-dynamic" class="section-nav-link">Dynamic Tools</a>
        <a href="#s-perf" class="section-nav-link">Performance</a>
        <a href="#s-ai" class="section-nav-link">AI Analysis</a>
        <a href="#s-heatmap" class="section-nav-link">Heatmap</a>
        <a href="#s-mcdm" class="section-nav-link">Rankings</a>
        <a href="#s-templates" class="section-nav-link">Templates</a>
        <a href="#s-generation" class="section-nav-link">Generation</a>
      {% endif %}
      <span class="ms-auto"></span>
      <button class="btn btn-sm btn-ghost-secondary py-0 px-1" onclick="toggleAll(true)" title="Expand All"><i class="fa-solid fa-expand fa-xs"></i></button>
      <button class="btn btn-sm btn-ghost-secondary py-0 px-1" onclick="toggleAll(false)" title="Collapse All"><i class="fa-solid fa-compress fa-xs"></i></button>
    </div>
  </div>

  {% set summary = report_data.get('summary', {}) %}
  {% set sev = report_data.get('findings_breakdown', summary.get('severity_breakdown', {})) %}
  {% set sci = report_data.get('scientific_metrics', {}) %}
  {% set dist = sci.get('findings_distribution', {}) %}

  {# ── ACCORDION ── #}
  <div class="accordion" id="rptAcc">

  {% if rt == 'model_analysis' %}
  {# ════════════════════════ MODEL ANALYSIS ════════════════════════ #}

    {# ── Overview ── #}
    <div class="accordion-item" id="s-overview">
      <h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#c-overview"><i class="fa-solid fa-chart-pie me-2 text-primary"></i>Overview</button></h2>
      <div id="c-overview" class="accordion-collapse collapse show" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {# Key metrics row #}
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-primary">{{ report_data.get('apps_count', 0) }}{% if total_model_apps %}<small class="text-muted fw-normal"> / {{ total_model_apps }}</small>{% endif %}</div><div class="ml">Apps Analyzed</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ summary.get('total_findings', 0) }}</div><div class="ml">Total Findings</div><div class="mh">{{ "%.1f"|format(summary.get('avg_findings_per_app', 0)) }} avg/app</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-danger">{{ sev.get('critical', 0) }}</div><div class="ml">Critical</div></div></div>
            <div class="col"><div class="card mc"><div class="mv" style="color:var(--tblr-orange)">{{ sev.get('high', 0) }}</div><div class="ml">High</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-warning">{{ sev.get('medium', 0) }}</div><div class="ml">Medium</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-success">{{ sev.get('low', 0) }}</div><div class="ml">Low</div></div></div>
          </div>
          <div class="row g-2">
            <div class="col-md-5">
              {# Severity table #}
              <table class="table table-sm compact-table mb-2">
                <thead><tr><th>Severity</th><th class="text-end">Count</th><th class="text-end">%</th><th style="width:40%">Distribution</th></tr></thead>
                <tbody>
                  {% set total_f = summary.get('total_findings', 1) %}
                  {% for sl in ['critical', 'high', 'medium', 'low', 'info'] %}
                  {% set sc = sev.get(sl, 0) %}
                  {% set pct = (sc / total_f * 100) if total_f else 0 %}
                  <tr>
                    <td><span class="badge bg-{{ sev_colors[sl] }}-lt" style="min-width:55px">{{ sl|title }}</span></td>
                    <td class="text-end fw-medium">{{ sc }}</td>
                    <td class="text-end text-muted">{{ "%.1f"|format(pct) }}%</td>
                    <td><div class="sev-bar bg-{{ sev_colors[sl] }}" style="width:{{ [pct, 100]|min }}%">&nbsp;</div></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {# Statistics #}
              <table class="table table-sm compact-table mb-0">
                <tbody>
                  <tr><td class="text-muted">Mean ± StdDev</td><td class="text-end">{{ "%.1f"|format(dist.get('mean', 0)) }} ± {{ "%.1f"|format(dist.get('std_dev', 0)) }}</td></tr>
                  <tr><td class="text-muted">Median</td><td class="text-end">{{ dist.get('median', 0) }}</td></tr>
                  <tr><td class="text-muted">Range</td><td class="text-end">{{ dist.get('min', 0) }} – {{ dist.get('max', 0) }}</td></tr>
                  <tr><td class="text-muted">CV</td><td class="text-end">{{ "%.2f"|format(sci.get('coefficient_of_variation', 0)) }}</td></tr>
                  {% set as = report_data.get('analysis_stats', {}) %}
                  <tr><td class="text-muted">Analysis Success</td><td class="text-end">{{ as.get('completed_analyses', 0) }} complete, {{ as.get('partial_analyses', 0) }} partial, {{ as.get('failed_analyses', 0) }} failed</td></tr>
                </tbody>
              </table>
            </div>
            <div class="col-md-4">
              <div class="chart-box"><canvas id="chart-sev-donut"></canvas></div>
            </div>
            <div class="col-md-3">
              {# Findings by tool #}
              <h6 class="mb-1 text-muted" style="font-size:0.75rem">FINDINGS BY TOOL</h6>
              <table class="table table-sm compact-table mb-0">
                <tbody>
                  {% for tool, count in tool_finding_counts|dictsort(by='value', reverse=true) %}
                  <tr><td><span class="badge bg-secondary-lt">{{ tool }}</span></td><td class="text-end">{{ count }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ── Code Quality & LOC ── #}
    {% set loc = report_data.get('loc_metrics', {}) %}
    {% if loc.get('counted') %}
    <div class="accordion-item" id="s-quality">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-quality"><i class="fa-solid fa-code me-2 text-primary"></i>Code Quality & Density</button></h2>
      <div id="c-quality" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-primary">{{ "{:,}".format(loc.get('total_loc', 0)) }}</div><div class="ml">Total LOC</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.1f"|format(loc.get('issues_per_100_loc', 0)) }}</div><div class="ml">Issues/100 LOC</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "{:,}".format(loc.get('backend_loc', 0)) }}</div><div class="ml">Backend LOC</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "{:,}".format(loc.get('frontend_loc', 0)) }}</div><div class="ml">Frontend LOC</div></div></div>
          </div>
          {% set per_app = loc.get('per_app', {}) %}
          {% if per_app %}
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th>App</th><th class="text-end">LOC</th><th class="text-end">Issues</th><th class="text-end">Issues/100 LOC</th><th style="width:30%">Density</th></tr></thead>
            <tbody>
              {% for app_id, am in per_app.items()|sort(attribute='1.issues_per_100_loc', reverse=true) %}
              <tr>
                <td>App {{ am.get('app_number', app_id) }}</td>
                <td class="text-end">{{ am.get('total_loc', 0) }}</td>
                <td class="text-end">{{ am.get('issues_count', 0) }}</td>
                <td class="text-end fw-medium {% if am.get('issues_per_100_loc', 0) > 15 %}text-danger{% elif am.get('issues_per_100_loc', 0) > 10 %}text-warning{% endif %}">{{ "%.1f"|format(am.get('issues_per_100_loc', 0)) }}</td>
                <td><div class="progress progress-sm"><div class="progress-bar bg-{{ 'danger' if am.get('issues_per_100_loc', 0) > 15 else ('warning' if am.get('issues_per_100_loc', 0) > 10 else 'success') }}" style="width:{{ [am.get('issues_per_100_loc', 0) * 3, 100]|min }}%"></div></div></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    {# ── Tools Performance ── #}
    {% set tools = report_data.get('tools_statistics', report_data.get('tool_summary', {})) %}
    {% if tools %}
    <div class="accordion-item" id="s-tools">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-tools"><i class="fa-solid fa-wrench me-2 text-primary"></i>Tools Performance ({{ tools|length }})</button></h2>
      <div id="c-tools" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Tool</th><th class="text-center">Runs</th><th class="text-center">Success</th><th class="text-center">Findings</th><th class="text-center">Avg/Run</th><th class="text-end">Avg Time</th></tr></thead>
            <tbody>
              {% for tn, td in tools.items()|sort(attribute='1.total_findings', reverse=true) %}
              {% set runs = td.get('executions', td.get('total_executions', td.get('total_runs', 0))) %}
              {% set tf = td.get('total_findings', 0) %}
              <tr>
                <td><span class="badge bg-secondary-lt">{{ td.get('display_name', tn) }}</span></td>
                <td class="text-center">{{ runs }}</td>
                <td class="text-center"><span class="badge bg-{{ 'success' if td.get('success_rate', 0) >= 80 else ('warning' if td.get('success_rate', 0) >= 50 else 'danger') }}-lt">{{ "%.0f"|format(td.get('success_rate', 0)) }}%</span></td>
                <td class="text-center fw-medium">{{ tf }}</td>
                <td class="text-center text-muted">{{ "%.1f"|format(td.get('findings_per_run', 0)) }}</td>
                <td class="text-end text-muted">{{ "%.1f"|format(td.get('avg_duration', 0)) }}s</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {# ── Per-App Results ── #}
    {% set apps = report_data.get('apps', []) %}
    {% if apps %}
    <div class="accordion-item" id="s-apps">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-apps"><i class="fa-solid fa-boxes-stacked me-2 text-primary"></i>Applications ({{ apps|length }}{% if total_model_apps %} of {{ total_model_apps }}{% endif %})</button></h2>
      <div id="c-apps" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>App</th><th>Template</th><th class="text-center">Status</th><th class="text-center">Build</th><th class="text-center">Findings</th><th>Severity</th><th class="text-end">Duration</th></tr></thead>
            <tbody>
              {% for app in apps %}
              <tr>
                <td class="fw-medium">{{ app.get('app_number', loop.index) }}</td>
                <td><span class="badge bg-purple-lt text-purple" style="font-size:0.7rem">{{ app.get('template_slug', '—') }}</span></td>
                <td class="text-center">
                  {% set st = app.get('status', 'unknown') %}
                  <span class="badge bg-{{ 'success' if st == 'completed' else ('warning' if st == 'partial_success' else ('danger' if st == 'failed' else 'secondary')) }}-lt" style="font-size:0.7rem">{{ st|replace('_',' ')|title }}</span>
                </td>
                <td class="text-center">
                  {% set cs = app.get('container_status', '') %}
                  {% if cs == 'running' %}<span class="badge bg-success-lt" style="font-size:0.65rem">Running</span>
                  {% elif cs == 'stopped' %}<span class="badge bg-secondary-lt" style="font-size:0.65rem">Stopped</span>
                  {% elif 'fail' in cs|lower or 'error' in cs|lower %}<span class="badge bg-danger-lt" style="font-size:0.65rem">{{ cs|replace('_',' ')|title }}</span>
                  {% elif cs %}<span class="badge bg-secondary-lt" style="font-size:0.65rem">{{ cs|replace('_',' ')|title }}</span>
                  {% else %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td class="text-center fw-medium">{{ app.get('findings_count', 0) }}</td>
                <td>
                  {% set sc = app.get('severity_counts', app.get('severity_breakdown', {})) %}
                  {% for s in ['critical', 'high', 'medium', 'low'] %}
                    {% if sc.get(s, 0) > 0 %}<span class="badge bg-{{ sev_colors[s] }}-lt me-1" style="font-size:0.65rem">{{ s[:1]|upper }}{{ sc[s] }}</span>{% endif %}
                  {% endfor %}
                </td>
                <td class="text-end text-muted" style="font-size:0.75rem">{{ "%.0f"|format(app.get('duration_seconds', 0)) }}s</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {# ── Most Common Issues ── #}
    {% if common_issues %}
    <div class="accordion-item" id="s-issues">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-issues"><i class="fa-solid fa-list-ol me-2 text-warning"></i>Most Common Issues (top {{ common_issues|length }})</button></h2>
      <div id="c-issues" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th class="text-center" style="width:50px">#</th><th>Issue</th><th>Tool</th><th>Severity</th><th class="text-center">Apps</th></tr></thead>
            <tbody>
              {% for ci in common_issues %}
              <tr>
                <td class="text-center fw-bold">{{ ci.count }}</td>
                <td class="small" style="max-width:400px"><div class="text-truncate" title="{{ ci.message }}">{{ ci.message }}</div></td>
                <td><span class="badge bg-secondary-lt" style="font-size:0.7rem">{{ ci.tool }}</span></td>
                <td><span class="badge bg-{{ sev_colors.get(ci.severity, 'secondary') }}-lt" style="font-size:0.7rem">{{ ci.severity|title }}</span></td>
                <td class="text-center text-muted">{{ ci.app_count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {# ── Generation Context ── #}
    {% set gen = report_data.get('generation_stats', {}) %}
    {% set qm = report_data.get('quantitative_metrics', {}) %}
    {% set gen_qm = qm.get('generation', {}) %}
    <div class="accordion-item" id="s-generation">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-generation"><i class="fa-solid fa-microchip me-2 text-primary"></i>Generation</button></h2>
      <div id="c-generation" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-success">{{ gen.get('successful_generations', gen_qm.get('successful_apps', 0)) }}</div><div class="ml">Successful</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-danger">{{ gen.get('failed_generations', gen_qm.get('failed_apps', 0)) }}</div><div class="ml">Failed</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.0f"|format(gen_qm.get('success_rate', 0)) }}%</div><div class="ml">Success Rate</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.1f"|format(gen_qm.get('avg_attempts_per_app', 1)) }}</div><div class="ml">Avg Attempts</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ gen.get('total_scripted_fixes', 0) + gen.get('total_llm_fixes', 0) }}</div><div class="ml">Total Fixes</div></div></div>
          </div>
          {% set fw = report_data.get('framework_distribution', {}) %}
          {% if fw %}
          <h6 class="mb-1 text-muted" style="font-size:0.75rem">FRAMEWORKS</h6>
          <div class="d-flex flex-wrap gap-1 mb-1">
            {% for category, frameworks in fw.items() %}
              {% if frameworks is mapping %}
                {% for name, count in frameworks.items() %}<span class="badge bg-secondary-lt">{{ name }}: {{ count }}</span>{% endfor %}
              {% else %}
                <span class="badge bg-secondary-lt">{{ category }}: {{ frameworks }}</span>
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── Execution Metrics ── #}
    {% set ex = report_data.get('execution_metrics', {}) %}
    {% if ex %}
    <div class="accordion-item" id="s-execution">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-execution"><i class="fa-solid fa-clock me-2 text-primary"></i>Execution Metrics</button></h2>
      <div id="c-execution" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1">
            <div class="col"><div class="card mc"><div class="mv">{{ "%.0f"|format(ex.get('total_duration_seconds', 0)) }}s</div><div class="ml">Total Duration</div><div class="mh">{{ "%.1f"|format(ex.get('total_duration_seconds', 0) / 60) }} min</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.0f"|format(ex.get('avg_duration_seconds', 0)) }}s</div><div class="ml">Avg Duration</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.0f"|format(ex.get('total_queue_time_seconds', 0)) }}s</div><div class="ml">Total Queue</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.1f"|format(ex.get('avg_queue_time_seconds', 0)) }}s</div><div class="ml">Avg Queue</div></div></div>
          </div>
          {% set dur_stats = sci.get('duration_statistics', {}) %}
          {% if dur_stats %}
          <table class="table table-sm compact-table mt-2 mb-0" style="max-width:300px">
            <tbody>
              <tr><td class="text-muted">Median duration</td><td class="text-end">{{ "%.0f"|format(dur_stats.get('median', 0)) }}s</td></tr>
              <tr><td class="text-muted">Total analysis time</td><td class="text-end">{{ "%.0f"|format(dur_stats.get('total', 0)) }}s</td></tr>
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    {# ── Docker / Build Status ── #}
    {% set docker_qm = qm.get('docker', {}) %}
    {% if docker_qm %}
    <div class="accordion-item" id="s-docker">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-docker"><i class="fa-brands fa-docker me-2 text-primary"></i>Docker & Build Status</button></h2>
      <div id="c-docker" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1">
            <div class="col"><div class="card mc"><div class="mv text-success">{{ docker_qm.get('build_success_count', 0) }}</div><div class="ml">Built OK</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ "%.0f"|format(docker_qm.get('build_success_rate', 0)) }}%</div><div class="ml">Build Rate</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-success">{{ docker_qm.get('running', 0) }}</div><div class="ml">Running</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-secondary">{{ docker_qm.get('stopped', 0) }}</div><div class="ml">Stopped</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-danger">{{ docker_qm.get('error', 0) }}</div><div class="ml">Error</div></div></div>
          </div>
          {% set sb = docker_qm.get('status_breakdown', {}) %}
          {% if sb %}
          <div class="d-flex flex-wrap gap-1 mt-2">
            {% for status, cnt in sb.items() %}<span class="badge bg-{{ 'success' if status == 'running' else ('danger' if status == 'error' else 'secondary') }}-lt">{{ status }}: {{ cnt }}</span>{% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

  {% elif rt == 'template_comparison' %}
  {# ════════════════════════ TEMPLATE COMPARISON ════════════════════════ #}

    {# Overview #}
    <div class="accordion-item" id="s-overview">
      <h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#c-overview"><i class="fa-solid fa-chart-pie me-2 text-purple"></i>Overview</button></h2>
      <div id="c-overview" class="accordion-collapse collapse show" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-purple">{{ report_data.get('models_count', 0) }}</div><div class="ml">Models</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ summary.get('total_findings', 0) }}</div><div class="ml">Findings</div></div></div>
            {% for sl in ['critical','high','medium','low'] %}
            <div class="col"><div class="card mc"><div class="mv" style="color:var(--tblr-{{ sev_colors[sl] }})">{{ sev.get(sl, 0) }}</div><div class="ml">{{ sl|title }}</div></div></div>
            {% endfor %}
          </div>
          <div class="row g-2">
            <div class="col-md-7">
              <table class="table table-sm compact-table mb-0">
                {% for sl in ['critical','high','medium','low','info'] %}
                {% set sc = sev.get(sl, 0) %}{% set pct = (sc / summary.get('total_findings', 1) * 100) if summary.get('total_findings') else 0 %}
                <tr><td><span class="badge bg-{{ sev_colors[sl] }}-lt" style="min-width:55px">{{ sl|title }}</span></td><td class="text-end">{{ sc }}</td><td class="text-end text-muted">{{ "%.1f"|format(pct) }}%</td><td style="width:35%"><div class="sev-bar bg-{{ sev_colors[sl] }}" style="width:{{ [pct,100]|min }}%">&nbsp;</div></td></tr>
                {% endfor %}
              </table>
            </div>
            <div class="col-md-5"><div class="chart-box"><canvas id="chart-sev-donut"></canvas></div></div>
          </div>
        </div>
      </div>
    </div>

    {# Rankings #}
    {% set rankings = report_data.get('rankings', {}) %}
    {% if rankings %}
    <div class="accordion-item" id="s-rankings">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-rankings"><i class="fa-solid fa-trophy me-2 text-warning"></i>Rankings</button></h2>
      <div id="c-rankings" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% for category, ranked in rankings.items() %}
          {% if ranked is iterable and ranked is not string and ranked is not mapping and ranked|length > 0 %}
          <h6 class="text-muted mb-1" style="font-size:0.75rem">{{ category|replace('_',' ')|upper }}</h6>
          <table class="table table-sm compact-table table-striped mb-2">
            <thead><tr><th style="width:30px">#</th><th>Model</th><th class="text-end">Value</th></tr></thead>
            <tbody>{% for rm in ranked|list|batch(10)|first %}<tr><td>{{ loop.index }}</td><td><span class="badge bg-azure-lt text-azure">{{ rm.get('model_slug', rm.get('model', '')) }}</span></td><td class="text-end">{{ rm.get('value', rm.get('score', rm.get('findings_count', ''))) }}</td></tr>{% endfor %}</tbody>
          </table>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    {# Comparison #}
    {% set models = report_data.get('models', []) %}
    {% if models %}
    <div class="accordion-item" id="s-comparison">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-comparison"><i class="fa-solid fa-columns me-2 text-purple"></i>Model Comparison ({{ models|length }})</button></h2>
      <div id="c-comparison" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Model</th><th class="text-center">Findings</th><th class="text-center">C</th><th class="text-center">H</th><th class="text-center">M</th><th class="text-center">L</th><th class="text-center">Status</th></tr></thead>
            <tbody>
              {% for m in models %}{% set ms = m.get('summary', m) %}{% set msev = ms.get('findings_by_severity', ms.get('severity_counts', {})) %}
              <tr><td><span class="badge bg-azure-lt text-azure">{{ m.get('model_slug', m.get('model', '')) }}</span></td><td class="text-center fw-medium">{{ ms.get('total_findings', ms.get('findings_count', 0)) }}</td><td class="text-center">{{ msev.get('critical', 0) }}</td><td class="text-center">{{ msev.get('high', 0) }}</td><td class="text-center">{{ msev.get('medium', 0) }}</td><td class="text-center">{{ msev.get('low', 0) }}</td><td class="text-center"><span class="badge bg-{{ 'success' if m.get('status','completed') == 'completed' else 'warning' }}-lt" style="font-size:0.65rem">{{ m.get('status','completed')|title }}</span></td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {# Common Issues #}
    {% if common_issues %}
    <div class="accordion-item" id="s-issues">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-issues"><i class="fa-solid fa-list-ol me-2 text-warning"></i>Most Common Issues ({{ common_issues|length }})</button></h2>
      <div id="c-issues" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th class="text-center" style="width:40px">#</th><th>Issue</th><th>Tool</th><th>Severity</th></tr></thead>
            <tbody>{% for ci in common_issues %}<tr><td class="text-center fw-bold">{{ ci.count }}</td><td class="small"><div class="text-truncate" style="max-width:400px" title="{{ ci.message }}">{{ ci.message }}</div></td><td><span class="badge bg-secondary-lt" style="font-size:0.7rem">{{ ci.tool }}</span></td><td><span class="badge bg-{{ sev_colors.get(ci.severity,'secondary') }}-lt" style="font-size:0.7rem">{{ ci.severity|title }}</span></td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {# Generation #}
    {% set gen = report_data.get('generation_stats', {}) %}
    {% if gen is mapping and gen %}
    <div class="accordion-item" id="s-generation">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-generation"><i class="fa-solid fa-microchip me-2 text-purple"></i>Generation</button></h2>
      <div id="c-generation" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table mb-0" style="max-width:400px">
            <tbody>{% for k, v in gen.items() %}<tr><td class="text-muted">{{ k|replace('_',' ')|title }}</td><td class="text-end fw-medium">{{ v }}</td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

  {% elif rt == 'tool_analysis' %}
  {# ════════════════════════ TOOL ANALYSIS ════════════════════════ #}

    <div class="accordion-item" id="s-overview">
      <h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#c-overview"><i class="fa-solid fa-chart-bar me-2 text-teal"></i>Overview</button></h2>
      <div id="c-overview" class="accordion-collapse collapse show" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-teal">{{ report_data.get('tools_count', 0) }}</div><div class="ml">Tools</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ report_data.get('total_executions', 0) }}</div><div class="ml">Executions</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ summary.get('total_findings', 0) }}</div><div class="ml">Findings</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-success">{{ summary.get('avg_success_rate', 0)|round(1) }}%</div><div class="ml">Avg Success</div></div></div>
          </div>
          {% set cats = report_data.get('categories', {}) %}
          {% if cats is mapping and cats %}
          <div class="row g-1">{% for cn, cd in cats.items() %}{% if cd is mapping %}<div class="col"><div class="card mc"><div class="mv text-teal">{{ cd.get('total_tools', cd.get('tools_count', 0)) }}</div><div class="ml">{{ cn|replace('_',' ')|title }}</div><div class="mh">{{ cd.get('total_runs', cd.get('total_executions', 0)) }} runs</div></div></div>{% endif %}{% endfor %}</div>
          {% endif %}
        </div>
      </div>
    </div>

    {% set tools = report_data.get('tools', {}) %}
    {% if tools is mapping and tools %}
    <div class="accordion-item" id="s-tools">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-tools"><i class="fa-solid fa-wrench me-2 text-teal"></i>Tool Details ({{ tools|length }})</button></h2>
      <div id="c-tools" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Tool</th><th class="text-center">Runs</th><th class="text-center">Success</th><th class="text-center">Findings</th><th class="text-end">Avg Time</th></tr></thead>
            <tbody>{% for tn, td in tools.items() %}<tr><td><span class="badge bg-teal-lt text-teal">{{ td.get('display_name', tn) }}</span></td><td class="text-center">{{ td.get('total_executions', td.get('executions', 0)) }}</td><td class="text-center"><span class="badge bg-{{ 'success' if td.get('success_rate', 0) >= 80 else ('warning' if td.get('success_rate', 0) >= 50 else 'danger') }}-lt">{{ "%.0f"|format(td.get('success_rate', 0)) }}%</span></td><td class="text-center">{{ td.get('total_findings', td.get('findings_count', 0)) }}</td><td class="text-end text-muted">{{ "%.1f"|format(td.get('avg_duration', td.get('avg_duration_seconds', 0))) }}s</td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {% set by_model = report_data.get('by_model', {}) %}
    {% if by_model is mapping and by_model %}
    <div class="accordion-item" id="s-models">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-models"><i class="fa-solid fa-brain me-2 text-teal"></i>By Model</button></h2>
      <div id="c-models" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th>Model</th><th class="text-center">Tasks</th><th class="text-center">Findings</th><th class="text-center">Avg</th></tr></thead>
            <tbody>{% for mn, md in by_model.items() %}<tr><td><span class="badge bg-azure-lt text-azure">{{ mn }}</span></td><td class="text-center">{{ md.get('total_tasks', md.get('tasks', 0)) }}</td><td class="text-center">{{ md.get('total_findings', 0) }}</td><td class="text-center">{{ "%.1f"|format(md.get('avg_findings', 0)) }}</td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {% if common_issues %}
    <div class="accordion-item" id="s-issues">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-issues"><i class="fa-solid fa-list-ol me-2 text-warning"></i>Most Common Issues ({{ common_issues|length }})</button></h2>
      <div id="c-issues" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th class="text-center" style="width:40px">#</th><th>Issue</th><th>Tool</th><th>Severity</th></tr></thead>
            <tbody>{% for ci in common_issues %}<tr><td class="text-center fw-bold">{{ ci.count }}</td><td class="small"><div class="text-truncate" style="max-width:400px" title="{{ ci.message }}">{{ ci.message }}</div></td><td><span class="badge bg-secondary-lt" style="font-size:0.7rem">{{ ci.tool }}</span></td><td><span class="badge bg-{{ sev_colors.get(ci.severity,'secondary') }}-lt" style="font-size:0.7rem">{{ ci.severity|title }}</span></td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

  {% elif rt == 'generation_analytics' %}
  {# ════════════════════════ GENERATION ANALYTICS ════════════════════════ #}

    <div class="accordion-item" id="s-overview">
      <h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#c-overview"><i class="fa-solid fa-chart-line me-2 text-orange"></i>Overview</button></h2>
      <div id="c-overview" class="accordion-collapse collapse show" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-orange">{{ summary.get('total_apps', summary.get('total_generations', 0)) }}</div><div class="ml">Total</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-success">{{ summary.get('successful_generations', summary.get('successful', 0)) }}</div><div class="ml">Success</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-danger">{{ summary.get('failed_generations', summary.get('failed', 0)) }}</div><div class="ml">Failed</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ summary.get('success_rate', 0)|round(1) }}%</div><div class="ml">Rate</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ summary.get('avg_attempts', 0)|round(1) }}</div><div class="ml">Avg Attempts</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ summary.get('total_models', 0) }}</div><div class="ml">Models</div></div></div>
          </div>
          {% set filters = report_data.get('filters_applied', {}) %}
          {% if filters %}<div class="d-flex flex-wrap gap-1">{% for fk, fv in filters.items() %}<span class="badge bg-secondary-lt">{{ fk }}: {{ fv }}</span>{% endfor %}</div>{% endif %}
        </div>
      </div>
    </div>

    {% set by_model = report_data.get('by_model', []) %}
    {% if by_model %}
    <div class="accordion-item" id="s-models">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-models"><i class="fa-solid fa-brain me-2 text-orange"></i>By Model</button></h2>
      <div id="c-models" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Model</th><th class="text-center">Total</th><th class="text-center">OK</th><th class="text-center">Fail</th><th class="text-center">Rate</th><th class="text-center">Avg Att.</th></tr></thead>
            <tbody>{% for m in by_model if m is mapping %}<tr><td><span class="badge bg-azure-lt text-azure">{{ m.get('model_slug', m.get('model', '')) }}</span></td><td class="text-center">{{ m.get('total', m.get('total_apps', 0)) }}</td><td class="text-center text-success">{{ m.get('successful', m.get('success', 0)) }}</td><td class="text-center text-danger">{{ m.get('failed', m.get('failures', 0)) }}</td><td class="text-center"><span class="badge bg-{{ 'success' if m.get('success_rate', 0) >= 80 else ('warning' if m.get('success_rate', 0) >= 50 else 'danger') }}-lt">{{ "%.0f"|format(m.get('success_rate', 0)) }}%</span></td><td class="text-center">{{ "%.1f"|format(m.get('avg_attempts', 0)) }}</td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {% set by_template = report_data.get('by_template', []) %}
    {% if by_template %}
    <div class="accordion-item" id="s-templates">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-templates"><i class="fa-solid fa-file-code me-2 text-orange"></i>By Template</button></h2>
      <div id="c-templates" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Template</th><th class="text-center">Total</th><th class="text-center">OK</th><th class="text-center">Rate</th></tr></thead>
            <tbody>{% for t in by_template if t is mapping %}<tr><td><span class="badge bg-purple-lt text-purple">{{ t.get('template_slug', t.get('template', '')) }}</span></td><td class="text-center">{{ t.get('total', 0) }}</td><td class="text-center text-success">{{ t.get('successful', t.get('success', 0)) }}</td><td class="text-center"><span class="badge bg-{{ 'success' if t.get('success_rate', 0) >= 80 else ('warning' if t.get('success_rate', 0) >= 50 else 'danger') }}-lt">{{ "%.0f"|format(t.get('success_rate', 0)) }}%</span></td></tr>{% endfor %}</tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {% set fix_stats = report_data.get('fix_effectiveness', {}) %}
    {% if fix_stats is mapping and fix_stats %}
    <div class="accordion-item" id="s-fixes">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-fixes"><i class="fa-solid fa-hammer me-2 text-orange"></i>Fix Effectiveness</button></h2>
      <div id="c-fixes" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1">{% for ft, fd in fix_stats.items() %}<div class="col-md-4"><div class="card mc">{% if fd is mapping %}<div class="mv">{{ fd.get('count', fd.get('total', 0)) }}</div><div class="ml">{{ ft|replace('_',' ')|title }}</div><div class="mh">{{ "%.0f"|format(fd.get('success_rate', 0)) }}% effective</div>{% else %}<div class="mv">{{ fd }}</div><div class="ml">{{ ft|replace('_',' ')|title }}</div>{% endif %}</div></div>{% endfor %}</div>
        </div>
      </div>
    </div>
    {% endif %}

  {% elif rt == 'comprehensive' %}
  {# ════════════════════════ COMPREHENSIVE ════════════════════════ #}
    {% set comp_summary = report_data.get('summary', {}) %}
    {% set comp_rankings = report_data.get('model_rankings', []) %}
    {% set comp_models = report_data.get('model_reports', {}) %}
    {% set comp_templates = report_data.get('template_reports', {}) %}
    {% set comp_tool = report_data.get('tool_report', {}) %}
    {% set comp_tools = comp_tool.get('tools', []) %}
    {% set comp_gen = report_data.get('generation_report', {}) %}
    {% set comp_gen_summary = comp_gen.get('summary', {}) %}
    {% set comp_gen_models = comp_gen.get('by_model', []) %}
    {% set comp_metrics = report_data.get('platform_metrics', {}) %}
    {% set ta = report_data.get('thesis_analytics', {}) %}
    {% set mn = ta.get('model_names', {}) %}

    {# ── 1. Platform Overview ── #}
    <div class="accordion-item" id="s-overview">
      <h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#c-overview"><i class="fa-solid fa-chart-pie me-2 text-red"></i>Platform Overview</button></h2>
      <div id="c-overview" class="accordion-collapse collapse show" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv text-red">{{ comp_summary.get('total_models', 0) }}</div><div class="ml">Models</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ comp_summary.get('total_templates', 0) }}</div><div class="ml">Templates</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ comp_summary.get('total_apps', 0) }}</div><div class="ml">Apps</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ comp_summary.get('total_findings', 0) }}</div><div class="ml">Findings</div></div></div>
          </div>
          <div class="row g-2">
            <div class="col-md-8">
              <table class="table table-sm compact-table mb-0">
                <thead><tr><th>Severity</th><th class="text-end">Count</th><th class="text-end">%</th><th style="width:40%">Distribution</th></tr></thead>
                <tbody>
                  {% set total_f = comp_summary.get('total_findings', 0) %}
                  {% for sl in ['critical', 'high', 'medium', 'low', 'info'] %}
                  {% set sc = sev.get(sl, 0) %}
                  {% set pct = (sc / total_f * 100) if total_f else 0 %}
                  <tr>
                    <td><span class="badge bg-{{ sev_colors[sl] }}-lt" style="min-width:55px">{{ sl|title }}</span></td>
                    <td class="text-end fw-medium">{{ sc }}</td>
                    <td class="text-end text-muted">{{ "%.1f"|format(pct) }}%</td>
                    <td><div class="sev-bar bg-{{ sev_colors[sl] }}" style="width:{{ [pct, 100]|min }}%">&nbsp;</div></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="col-md-4">
              <div class="chart-box"><canvas id="chart-sev-donut"></canvas></div>
            </div>
          </div>

          {# Service Completion #}
          {% set svc_comp = ta.get('service_completion', []) %}
          {% if svc_comp %}
          <h6 class="mt-3 mb-1"><i class="fa-solid fa-server me-1"></i>Per-Model Service Completion</h6>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th>Model</th><th class="text-center">Apps</th><th class="text-center">Static</th><th class="text-center">Dynamic</th><th class="text-center">Performance</th><th class="text-center">AI</th></tr></thead>
            <tbody>
              {% for r in svc_comp %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-center">{{ r.apps }}</td>
                <td class="text-center">{{ r.static }} / {{ r.apps }}</td>
                <td class="text-center">{{ r.dynamic }} / {{ r.apps }}</td>
                <td class="text-center">{{ r.performance }} / {{ r.apps }}</td>
                <td class="text-center">{{ r.ai }} / {{ r.apps }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── 2. Model Leaderboard ── #}
    <div class="accordion-item" id="s-rankings">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-rankings"><i class="fa-solid fa-trophy me-2 text-warning"></i>Model Leaderboard</button></h2>
      <div id="c-rankings" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% if comp_rankings %}
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th class="text-center">#</th><th>Model</th><th class="text-center">Apps</th><th class="text-center">Findings</th><th class="text-center">C/H/M/L</th><th class="text-end">Score</th></tr></thead>
            <tbody>
              {% for row in comp_rankings %}
              <tr>
                <td class="text-center fw-bold">{{ row.get('rank', loop.index) }}</td>
                <td>{{ mn.get(row.get('model_slug',''), row.get('model_slug','')) }}</td>
                <td class="text-center">{{ row.get('apps_count', 0) }}</td>
                <td class="text-center">{{ row.get('total_findings', 0) }}</td>
                <td class="text-center small">{{ row.get('critical', 0) }}/{{ row.get('high', 0) }}/{{ row.get('medium', 0) }}/{{ row.get('low', 0) }}</td>
                <td class="text-end fw-medium">{{ row.get('severity_score', 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="text-muted fst-italic">No data.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── 3. Code Metrics ── #}
    <div class="accordion-item" id="s-codemetrics">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-codemetrics"><i class="fa-solid fa-code me-2 text-cyan"></i>Code Metrics</button></h2>
      <div id="c-codemetrics" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {# Code Composition #}
          {% set cc = ta.get('code_composition', []) %}
          {% if cc %}
          <h6 class="mb-1">Code Composition by Model</h6>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-2">
            <thead><tr><th>Model</th><th class="text-end">Apps</th><th class="text-end">Total LOC</th><th class="text-end">Backend (Py)</th><th class="text-end">Frontend (JS)</th><th class="text-end">LOC/App</th><th class="text-end">I/100LOC</th></tr></thead>
            <tbody>
              {% for r in cc %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.apps }}</td>
                <td class="text-end">{{ "{:,}".format(r.total_loc) }}</td>
                <td class="text-end">{{ "{:,}".format(r.python_loc) }}</td>
                <td class="text-end">{{ "{:,}".format(r.js_loc) }}</td>
                <td class="text-end">{{ "{:,}".format(r.loc_per_app) }}</td>
                <td class="text-end">{{ "%.2f"|format(r.i_100_loc) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% endif %}

          {# Severity by Model #}
          {% set sbm = ta.get('severity_by_model', []) %}
          {% if sbm %}
          <h6 class="mt-3 mb-1">Findings by Severity per Model</h6>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th>Model</th><th class="text-end">Apps</th><th class="text-end">Total</th><th class="text-end text-danger">Crit.</th><th class="text-end" style="color:var(--tblr-orange)">High</th><th class="text-end text-warning">Med.</th><th class="text-end text-success">Low</th><th class="text-end">D/kLOC</th><th class="text-end">Avg/App</th></tr></thead>
            <tbody>
              {% for r in sbm %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.apps }}</td>
                <td class="text-end fw-medium">{{ "{:,}".format(r.total) }}</td>
                <td class="text-end text-danger">{{ r.critical }}</td>
                <td class="text-end" style="color:var(--tblr-orange)">{{ r.high }}</td>
                <td class="text-end text-warning">{{ r.medium }}</td>
                <td class="text-end text-success">{{ r.low }}</td>
                <td class="text-end">{{ "%.1f"|format(r.d_kloc) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.avg_per_app) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── 4. Static Analysis Tools ── #}
    <div class="accordion-item" id="s-static">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-static"><i class="fa-solid fa-magnifying-glass-chart me-2 text-teal"></i>Static Analysis Tools ({{ ta.get('static_tools', {})|length }})</button></h2>
      <div id="c-static" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% for tool_name, tool_data in ta.get('static_tools', {}).items() %}
          <h6 class="{% if not loop.first %}mt-3{% endif %} mb-1">
            <span class="badge bg-teal-lt text-teal me-1">{{ tool_data.display_name }}</span>
            <span class="text-muted small">{{ "{:,}".format(tool_data.total_findings) }} findings across {{ tool_data.total_runs }} runs</span>
          </h6>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">OK</th><th class="text-end">Findings</th><th class="text-end">Avg/Run</th><th class="text-end">F/kLOC</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end">{{ r.ok }}</td>
                <td class="text-end">{{ "{:,}".format(r.findings) }}</td>
                <td class="text-end">{{ "%.2f"|format(r.avg_per_run) }}</td>
                <td class="text-end">{{ "%.2f"|format(r.f_kloc) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% else %}
          <div class="text-muted fst-italic">No static tool data.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# ── 5. Dynamic Analysis Tools ── #}
    <div class="accordion-item" id="s-dynamic">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-dynamic"><i class="fa-solid fa-bolt me-2 text-orange"></i>Dynamic Analysis Tools ({{ ta.get('dynamic_tools', {})|length }})</button></h2>
      <div id="c-dynamic" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% for tool_name, tool_data in ta.get('dynamic_tools', {}).items() %}
          <h6 class="{% if not loop.first %}mt-3{% endif %} mb-1">
            <span class="badge bg-orange-lt text-orange me-1">{{ tool_data.display_name }}</span>
            <span class="text-muted small">{{ "{:,}".format(tool_data.total_findings) }} findings across {{ tool_data.total_runs }} runs</span>
          </h6>
          <div class="table-responsive">
          {% if tool_name == 'curl-endpoint-tester' %}
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">Endpoints</th><th class="text-end">Passed</th><th class="text-end">Failed</th><th class="text-end">Pass%</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end">{{ r.get('endpoints', 0) }}</td>
                <td class="text-end text-success">{{ r.get('ep_passed', 0) }}</td>
                <td class="text-end text-danger">{{ r.get('ep_failed', 0) }}</td>
                <td class="text-end"><span class="badge bg-{{ 'success' if r.get('ep_pass_rate', 0) >= 70 else ('warning' if r.get('ep_pass_rate', 0) >= 40 else 'danger') }}-lt">{{ "%.1f"|format(r.get('ep_pass_rate', 0)) }}%</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% elif tool_name == 'zap' %}
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">Findings</th><th class="text-end text-danger">High</th><th class="text-end text-warning">Med</th><th class="text-end text-success">Low</th><th class="text-end text-info">Info</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end">{{ "{:,}".format(r.findings) }}</td>
                <td class="text-end text-danger">{{ r.get('high', 0) }}</td>
                <td class="text-end text-warning">{{ r.get('medium', 0) }}</td>
                <td class="text-end text-success">{{ r.get('low', 0) }}</td>
                <td class="text-end text-info">{{ r.get('info', 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">OK</th><th class="text-end">Findings</th><th class="text-end">Avg/Run</th><th class="text-end">F/kLOC</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end">{{ r.ok }}</td>
                <td class="text-end">{{ "{:,}".format(r.findings) }}</td>
                <td class="text-end">{{ "%.2f"|format(r.avg_per_run) }}</td>
                <td class="text-end">{{ "%.2f"|format(r.f_kloc) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
          </div>
          {% else %}
          <div class="text-muted fst-italic">No dynamic tool data.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# ── 6. Performance Tools ── #}
    <div class="accordion-item" id="s-perf">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-perf"><i class="fa-solid fa-gauge-high me-2 text-indigo"></i>Performance Tools ({{ ta.get('performance_tools', {})|length }})</button></h2>
      <div id="c-perf" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% for tool_name, tool_data in ta.get('performance_tools', {}).items() %}
          {% set pm = tool_data.get('performance_metrics', {}) %}
          <h6 class="{% if not loop.first %}mt-3{% endif %} mb-1">
            <span class="badge bg-indigo-lt text-indigo me-1">{{ tool_data.display_name }}</span>
            <span class="text-muted small">{{ tool_data.total_runs }} runs |
              Avg RPS: {{ "%.1f"|format(pm.get('avg_rps', 0)) }} |
              Avg RT: {{ "%.2f"|format(pm.get('avg_response_time', 0)) }}ms |
              Errors: {{ pm.get('total_errors', 0) }}
            </span>
          </h6>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">OK</th><th class="text-end">Avg RPS</th><th class="text-end">Avg RT (ms)</th><th class="text-end">Errors</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end">{{ r.ok }}</td>
                <td class="text-end">{{ "%.1f"|format(r.get('avg_rps', 0)) }}</td>
                <td class="text-end">{{ "%.2f"|format(r.get('avg_rt', 0)) }}</td>
                <td class="text-end">{{ r.get('errors', 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% else %}
          <div class="text-muted fst-italic">No performance tool data.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# ── 7. AI Analysis Tools ── #}
    <div class="accordion-item" id="s-ai">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-ai"><i class="fa-solid fa-robot me-2 text-purple"></i>AI Analysis Tools ({{ ta.get('ai_tools', {})|length }})</button></h2>
      <div id="c-ai" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% for tool_name, tool_data in ta.get('ai_tools', {}).items() %}
          {% set am = tool_data.get('ai_metrics', {}) %}
          <h6 class="{% if not loop.first %}mt-3{% endif %} mb-1">
            <span class="badge bg-purple-lt text-purple me-1">{{ tool_data.display_name }}</span>
            <span class="text-muted small">{{ tool_data.total_runs }} runs |
              Avg Score: {{ "%.1f"|format(am.get('avg_score', 0)) }} |
              Samples: {{ am.get('samples', 0) }}
            </span>
          </h6>
          <div class="table-responsive">
          {% if tool_name == 'requirements-scanner' %}
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">Compl.%</th><th class="text-end">Reqs Met</th><th class="text-end">Reqs Total</th><th class="text-end">Func. Met</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end"><span class="badge bg-{{ 'success' if r.get('avg_compliance', 0) >= 70 else ('warning' if r.get('avg_compliance', 0) >= 40 else 'danger') }}-lt">{{ "%.1f"|format(r.get('avg_compliance', 0)) }}%</span></td>
                <td class="text-end">{{ "%.1f"|format(r.get('reqs_met', 0)) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.get('reqs_total', 0)) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.get('metrics_passed', 0)) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% elif tool_name == 'code-quality-analyzer' %}
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">Score</th><th class="text-end">Grade</th><th class="text-end">Passed</th><th class="text-end">Total</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              {% set gd = r.get('grade_dist', {}) %}
              {% set top_grade = gd.keys()|list|first if gd else '—' %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end"><span class="badge bg-{{ 'success' if r.get('avg_score', 0) >= 70 else ('warning' if r.get('avg_score', 0) >= 50 else 'danger') }}-lt">{{ "%.1f"|format(r.get('avg_score', 0)) }}</span></td>
                <td class="text-end">{% for g, c in gd.items() %}<span class="badge bg-secondary-lt me-1" style="font-size:0.65rem">{{ g }}×{{ c }}</span>{% endfor %}{% if not gd %}—{% endif %}</td>
                <td class="text-end">{{ "%.1f"|format(r.get('metrics_passed', 0)) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.get('metrics_total', 0)) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <table class="table table-sm compact-table table-striped mb-1">
            <thead><tr><th>Model</th><th class="text-end">Runs</th><th class="text-end">OK</th></tr></thead>
            <tbody>
              {% for r in tool_data.per_model %}
              <tr>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ r.runs }}</td>
                <td class="text-end">{{ r.ok }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
          </div>
          {% else %}
          <div class="text-muted fst-italic">No AI tool data.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# ── 8. Heatmap ── #}
    <div class="accordion-item" id="s-heatmap">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-heatmap"><i class="fa-solid fa-table-cells me-2 text-red"></i>Tool × Model Heatmap</button></h2>
      <div id="c-heatmap" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% set hm = ta.get('heatmap', {}) %}
          {% set hm_tools = hm.get('tools', []) %}
          {% set hm_models = hm.get('models', []) %}
          {% set hm_names = hm.get('model_names', {}) %}
          {% set hm_matrix = hm.get('matrix', []) %}
          {% if hm_tools %}
          <div class="table-responsive">
          <table class="table table-sm compact-table table-bordered mb-0" style="font-size:0.75rem">
            <thead><tr><th>Tool</th>{% for m in hm_models %}<th class="text-center" style="max-width:70px">{{ hm_names.get(m, m)[:12] }}</th>{% endfor %}</tr></thead>
            <tbody>
              {% for row in hm_matrix %}
              <tr>
                <td class="fw-medium">{{ row.tool }}</td>
                {% for m in hm_models %}
                {% set val = row.get(m, 0) %}
                {% set intensity = [val / 500 * 100, 100]|min if val > 0 else 0 %}
                <td class="text-center" style="{% if val > 0 %}background:rgba(214,57,57,{{ "%.2f"|format(intensity/100) }}){% endif %}">{{ val if val > 0 else '—' }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% else %}
          <div class="text-muted fst-italic">No heatmap data.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── 9. MCDM Rankings (TOPSIS + WSM + Correlations) ── #}
    <div class="accordion-item" id="s-mcdm">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-mcdm"><i class="fa-solid fa-ranking-star me-2 text-yellow"></i>Multi-Criteria Rankings</button></h2>
      <div id="c-mcdm" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {# TOPSIS #}
          {% set topsis = ta.get('topsis', []) %}
          {% if topsis %}
          <h6 class="mb-1">TOPSIS Multi-Criteria Decision Analysis <span class="text-muted small">(Higher Score = Better)</span></h6>
          <p class="text-muted small mb-1">Criteria: Compliance% (↑ 0.25), LOC/App (↑ 0.20), Quality Score (↑ 0.20), D/kLOC (↓ 0.20), $/Mtok (↓ 0.15)</p>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-2">
            <thead><tr><th class="text-center">#</th><th>Model</th><th class="text-end">Compl.%</th><th class="text-end">LOC/App</th><th class="text-end">Quality</th><th class="text-end">D/kLOC</th><th class="text-end">$/Mtok</th><th class="text-end">Score</th></tr></thead>
            <tbody>
              {% for r in topsis %}
              <tr class="{{ 'table-success' if loop.index <= 3 else '' }}">
                <td class="text-center fw-bold">{{ r.rank }}</td>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ "%.1f"|format(r.compliance) }}%</td>
                <td class="text-end">{{ "{:,}".format(r.loc_app|int) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.quality) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.dkloc) }}</td>
                <td class="text-end">${{ "%.2f"|format(r.out_price) }}</td>
                <td class="text-end fw-medium">{{ "%.4f"|format(r.score) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% endif %}

          {# WSM #}
          {% set wsm = ta.get('wsm', []) %}
          {% if wsm %}
          <h6 class="mt-3 mb-1">Weighted Sum Model Ranking <span class="text-muted small">(Higher Score = Better)</span></h6>
          <p class="text-muted small mb-1">Criteria: Compliance% (↑ 0.30), LOC/App (↑ 0.25), Quality Score (↑ 0.25), D/kLOC (↓ 0.20)</p>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-2">
            <thead><tr><th class="text-center">#</th><th>Model</th><th class="text-end">Compl.%</th><th class="text-end">LOC/App</th><th class="text-end">Quality</th><th class="text-end">D/kLOC</th><th class="text-end">Score</th></tr></thead>
            <tbody>
              {% for r in wsm %}
              <tr class="{{ 'table-success' if loop.index <= 3 else '' }}">
                <td class="text-center fw-bold">{{ r.rank }}</td>
                <td>{{ r.short_name }}</td>
                <td class="text-end">{{ "%.1f"|format(r.compliance) }}%</td>
                <td class="text-end">{{ "{:,}".format(r.loc_app|int) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.quality) }}</td>
                <td class="text-end">{{ "%.1f"|format(r.dkloc) }}</td>
                <td class="text-end fw-medium">{{ "%.4f"|format(r.score) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% endif %}

          {# Spearman Correlations #}
          {% set corrs = ta.get('correlations', []) %}
          {% set corr_outcomes = ta.get('correlation_outcomes', []) %}
          {% if corrs %}
          <h6 class="mt-3 mb-1">Spearman Rank Correlations <span class="text-muted small">(n = {{ comp_summary.get('total_models', 0) }})</span></h6>
          <div class="table-responsive">
          <table class="table table-sm compact-table table-striped mb-0">
            <thead><tr><th>Parameter</th>{% for o in corr_outcomes %}<th class="text-end">{{ o }}</th>{% endfor %}</tr></thead>
            <tbody>
              {% for r in corrs %}
              <tr>
                <td class="fw-medium">{{ r.parameter }}</td>
                {% for o in corr_outcomes %}
                {% set val = r.get(o, 0) %}
                <td class="text-end {% if val|abs > 0.5 %}fw-bold{% endif %}">{{ "%.2f"|format(val) }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── 10. Template Comparisons ── #}
    <div class="accordion-item" id="s-templates">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-templates"><i class="fa-solid fa-code-compare me-2 text-purple"></i>Template Comparisons</button></h2>
      <div id="c-templates" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          {% if comp_templates %}
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Template</th><th class="text-center">Models</th><th class="text-center">Findings</th><th class="text-center">Critical/High</th></tr></thead>
            <tbody>
              {% for template_slug, template_data in comp_templates.items() %}
              {% set ts = template_data.get('summary', {}) %}
              {% set tsev = template_data.get('findings_breakdown', ts.get('severity_breakdown', {})) %}
              <tr>
                <td><span class="badge bg-purple-lt text-purple">{{ template_slug }}</span></td>
                <td class="text-center">{{ ts.get('models_compared', template_data.get('models_count', 0)) }}</td>
                <td class="text-center">{{ ts.get('total_findings', 0) }}</td>
                <td class="text-center">{{ tsev.get('critical', 0) }}/{{ tsev.get('high', 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="text-muted fst-italic">No template comparisons available.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── 11. Generation Analytics ── #}
    <div class="accordion-item" id="s-generation">
      <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c-generation"><i class="fa-solid fa-chart-line me-2 text-orange"></i>Generation Analytics</button></h2>
      <div id="c-generation" class="accordion-collapse collapse" data-bs-parent="#rptAcc">
        <div class="accordion-body p-2">
          <div class="row g-1 mb-2">
            <div class="col"><div class="card mc"><div class="mv">{{ comp_gen_summary.get('total_apps', 0) }}</div><div class="ml">Total Apps</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-success">{{ comp_gen_summary.get('successful', 0) }}</div><div class="ml">Successful</div></div></div>
            <div class="col"><div class="card mc"><div class="mv text-danger">{{ comp_gen_summary.get('failed', 0) }}</div><div class="ml">Failed</div></div></div>
            <div class="col"><div class="card mc"><div class="mv">{{ comp_gen_summary.get('success_rate', 0)|round(1) }}%</div><div class="ml">Success Rate</div></div></div>
          </div>
          {% if comp_gen_models %}
          <table class="table table-sm compact-table table-striped table-hover mb-0">
            <thead><tr><th>Model</th><th class="text-center">Total</th><th class="text-center">Success</th><th class="text-center">Failed</th><th class="text-center">Rate</th></tr></thead>
            <tbody>
              {% for m in comp_gen_models if m is mapping %}
              <tr>
                <td>{{ mn.get(m.get('model', m.get('model_slug','')), m.get('model', m.get('model_slug',''))) }}</td>
                <td class="text-center">{{ m.get('total', 0) }}</td>
                <td class="text-center text-success">{{ m.get('success', m.get('successful', 0)) }}</td>
                <td class="text-center text-danger">{{ m.get('failed', 0) }}</td>
                <td class="text-center">{{ "%.1f"|format(m.get('success_rate', 0)) }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>
    </div>

  {% else %}
    <div class="accordion-item" id="s-overview">
      <h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#c-overview"><i class="fa-solid fa-file me-2"></i>Raw Data</button></h2>
      <div id="c-overview" class="accordion-collapse collapse show">
        <div class="accordion-body p-2"><pre class="bg-light p-2 rounded small mb-0" style="max-height:500px;overflow:auto">{{ report_data|tojson(indent=2) }}</pre></div>
      </div>
    </div>
  {% endif %}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
  const REPORT_DATA = {{ report_data|tojson }};
  const sev = REPORT_DATA.findings_breakdown || (REPORT_DATA.summary||{}).severity_breakdown || {};
  const canvas = document.getElementById('chart-sev-donut');
  if (canvas && window.Chart) {
    const d = [sev.critical||0, sev.high||0, sev.medium||0, sev.low||0, sev.info||0];
    if (d.some(v=>v>0)) new Chart(canvas, {
      type:'doughnut',
      data:{labels:['Critical','High','Medium','Low','Info'],datasets:[{data:d,backgroundColor:['#d63939','#f76707','#f59f00','#2fb344','#0ea5e9']}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10},padding:8}},tooltip:{callbacks:{label:ctx=>ctx.label+': '+ctx.parsed+' ('+((ctx.parsed/(d.reduce((a,b)=>a+b,0)||1))*100).toFixed(1)+'%)'}}}}
    });
  }
  window.toggleAll=function(expand){document.querySelectorAll('#rptAcc .accordion-collapse').forEach(el=>{const c=bootstrap.Collapse.getOrCreateInstance(el,{toggle:false});expand?c.show():c.hide()})};
  // Section nav tracking
  const links=document.querySelectorAll('.section-nav-link');
  if(links.length&&'IntersectionObserver' in window){
    const obs=new IntersectionObserver(es=>es.forEach(e=>{if(e.isIntersecting){links.forEach(l=>l.classList.remove('active'));const l=document.querySelector('.section-nav-link[href="#'+e.target.id+'"]');if(l)l.classList.add('active')}}),{rootMargin:'-15% 0px -65% 0px'});
    document.querySelectorAll('.accordion-item[id^="s-"]').forEach(s=>obs.observe(s));
    links.forEach(l=>l.addEventListener('click',e=>{e.preventDefault();const t=document.querySelector(l.getAttribute('href'));if(t)t.scrollIntoView({behavior:'smooth',block:'start'})}));
  }
})();
</script>
{% endblock %}
