{% extends 'layouts/base_smart.html' %}
{% set active_page = 'reports' %}
{% set page_title = report.title %}
{% set page_icon = 'fa-solid fa-file-lines' %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail-pages.css') }}">
<style>
  @media print {

    .btn,
    .navbar,
    .sidebar,
    footer,
    .no-print {
      display: none !important;
    }

    .container-xl {
      max-width: 100% !important;
      margin: 0 !important;
    }

    .card {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .research-header-actions {
      display: none !important;
    }
  }

  /* Report content styles */
  .severity-critical {
    color: var(--tblr-danger, #d63939);
  }

  .severity-high {
    color: var(--tblr-orange, #f76707);
  }

  .severity-medium {
    color: var(--tblr-yellow, #f59f00);
  }

  .severity-low {
    color: var(--tblr-success, #2fb344);
  }

  .severity-info {
    color: var(--tblr-info, #0ea5e9);
  }

  .finding-card {
    border-left: 4px solid;
    margin-bottom: 0.5rem;
  }

  .finding-card.critical {
    border-left-color: var(--tblr-danger, #d63939);
  }

  .finding-card.high {
    border-left-color: var(--tblr-orange, #f76707);
  }

  .finding-card.medium {
    border-left-color: var(--tblr-yellow, #f59f00);
  }

  .finding-card.low {
    border-left-color: var(--tblr-success, #2fb344);
  }

  .tool-status-success {
    color: var(--tblr-success, #2fb344);
  }

  .tool-status-error {
    color: var(--tblr-danger, #d63939);
  }

  .tool-status-no_issues {
    color: var(--tblr-primary, #206bc4);
  }

  .comparison-cell {
    text-align: center;
  }

  .comparison-cell.winner {
    background-color: rgba(47, 179, 68, 0.1);
  }

  /* Status badge colors */
  .status-completed {
    background-color: var(--tblr-success, #2fb344) !important;
  }

  .status-partial {
    background-color: var(--tblr-warning, #f59f00) !important;
    color: #000 !important;
  }

  .status-failed {
    background-color: var(--tblr-danger, #d63939) !important;
  }

  .status-cancelled {
    background-color: var(--tblr-secondary, #626976) !important;
  }

  .status-running {
    background-color: var(--tblr-primary, #206bc4) !important;
  }

  .status-pending {
    background-color: var(--tblr-gray-500, #868e96) !important;
  }

  /* Chart container */
  .chart-container {
    position: relative;
    height: 250px;
  }

  /* Finding details */
  .finding-item {
    border-left: 3px solid;
    padding-left: 12px;
    margin-bottom: 8px;
  }

  .finding-item.severity-critical {
    border-color: var(--tblr-danger, #d63939);
  }

  .finding-item.severity-high {
    border-color: var(--tblr-orange, #f76707);
  }

  .finding-item.severity-medium {
    border-color: var(--tblr-yellow, #f59f00);
  }

  .finding-item.severity-low {
    border-color: var(--tblr-success, #2fb344);
  }

  .finding-item.severity-info {
    border-color: var(--tblr-info, #0ea5e9);
  }

  /* Collapsible sections */
  .section-collapse {
    cursor: pointer;
  }

  .section-collapse:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }
</style>
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="research-detail-shell" id="report-detail-container" data-report-id="{{ report.id }}"
  data-report-type="{{ report.report_type }}">
  {# Header #}
  <div class="research-header no-print">
    <div class="research-header-icon">
      <i class="{{ page_icon }}"></i>
    </div>
    <div class="research-header-identity">
      <div class="research-header-pretitle">
        {% set type_badges = {
        'model_analysis': 'Model Analysis',
        'template_comparison': 'Template Comparison',
        'tool_analysis': 'Tool Analysis'
        } %}
        {{ type_badges.get(report.report_type, report.report_type) }}
      </div>
      <h1 class="research-header-title">
        {{ report.title }}
        <span class="badge bg-success-lt ms-2">Completed</span>
      </h1>
      {% if report.description %}
      <div class="research-header-subtitle">
        {{ report.description }}
      </div>
      {% endif %}
      <div class="research-header-subtitle mt-2" id="filter-mode-display">
        {# Will be populated by JavaScript from report config #}
      </div>
    </div>
    <div class="research-header-actions">
      <a href="{{ url_for('reports.reports_index') }}" class="btn btn-ghost-secondary">
        <i class="fa-solid fa-arrow-left me-2"></i>Back
      </a>
      <div class="vr"></div>
      <button class="btn btn-ghost-primary" onclick="window.print()">
        <i class="fa-solid fa-print me-2"></i>Print
      </button>
      <button class="btn btn-primary" onclick="downloadJSON()">
        <i class="fa-solid fa-download me-2"></i>Download JSON
      </button>
    </div>
  </div>

  {# Loading state #}
  <div id="loading-state" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p class="text-muted">Loading report data...</p>
  </div>

  {# Error state #}
  <div id="error-state" class="d-none">
    <div class="alert alert-danger">
      <div class="d-flex">
        <i class="fa-solid fa-exclamation-triangle me-3 fa-2x"></i>
        <div>
          <h4 class="alert-title">Failed to load report</h4>
          <p id="error-message" class="mb-0">An error occurred while loading the report data.</p>
        </div>
      </div>
    </div>
    <a href="{{ url_for('reports.reports_index') }}" class="btn btn-secondary">
      <i class="fa-solid fa-arrow-left me-2"></i>Back to Reports
    </a>
  </div>

  {# Report content (populated by JavaScript) #}
  <div id="report-content" class="d-none research-content"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/reports.js') }}"></script>
<script>
  // Initialize report logic when DOM is ready
  document.addEventListener('DOMContentLoaded', function () {
    // Pass report ID and Type to global scope as fallback
    window.REPORT_ID = "{{ report.id }}";
    window.REPORT_TYPE = "{{ report.report_type }}";

    // Initialize the report handling
    if (typeof initReport === 'function') {
      initReport();
    } else {
      console.error('initReport function not found. Is reports.js loaded?');
    }
  });
</script>
{% endblock %}