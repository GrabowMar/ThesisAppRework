{% extends 'layouts/base_smart.html' %}
{% set active_page = 'reports' %}
{% set page_title = report.title %}
{% set page_icon = 'fa-solid fa-file-lines' %}

{% block head_styles %}
<style>
  @media print {
    .btn, .navbar, .sidebar, footer, .no-print { display: none !important; }
    .container-xl { max-width: 100% !important; margin: 0 !important; }
    .card { break-inside: avoid; page-break-inside: avoid; }
  }
  
  /* Report content styles */
  .report-section { margin-bottom: 1.5rem; }
  .severity-critical { color: #d63939; }
  .severity-high { color: #f76707; }
  .severity-medium { color: #f59f00; }
  .severity-low { color: #2fb344; }
  .severity-info { color: #0ea5e9; }
  
  .finding-card { border-left: 4px solid; margin-bottom: 0.5rem; }
  .finding-card.critical { border-left-color: #d63939; }
  .finding-card.high { border-left-color: #f76707; }
  .finding-card.medium { border-left-color: #f59f00; }
  .finding-card.low { border-left-color: #2fb344; }
  
  .tool-status-success { color: #2fb344; }
  .tool-status-error { color: #d63939; }
  .tool-status-no_issues { color: #206bc4; }
  
  .comparison-cell { text-align: center; }
  .comparison-cell.winner { background-color: rgba(47, 179, 68, 0.1); }
  
  /* Status badge colors */
  .status-completed { background-color: #2fb344 !important; }
  .status-partial { background-color: #f59f00 !important; color: #000 !important; }
  .status-failed { background-color: #d63939 !important; }
  .status-cancelled { background-color: #626976 !important; }
  .status-running { background-color: #206bc4 !important; }
  .status-pending { background-color: #868e96 !important; }
  
  /* Metric card hover */
  .metric-card { transition: transform 0.2s; }
  .metric-card:hover { transform: translateY(-2px); }
  
  /* Chart container */
  .chart-container { position: relative; height: 250px; }
  
  /* Finding details */
  .finding-item { border-left: 3px solid; padding-left: 12px; margin-bottom: 8px; }
  .finding-item.severity-critical { border-color: #d63939; }
  .finding-item.severity-high { border-color: #f76707; }
  .finding-item.severity-medium { border-color: #f59f00; }
  .finding-item.severity-low { border-color: #2fb344; }
  .finding-item.severity-info { border-color: #0ea5e9; }
  
  /* Collapsible sections */
  .section-collapse { cursor: pointer; }
  .section-collapse:hover { background-color: rgba(0,0,0,0.02); }
</style>
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-xl">
  {# Header #}
  <div class="page-header mb-4 no-print">
    <div class="row align-items-center">
      <div class="col-auto">
        <a href="{{ url_for('reports.reports_index') }}" class="btn btn-ghost-secondary btn-icon">
          <i class="fa-solid fa-arrow-left"></i>
        </a>
      </div>
      <div class="col">
        <div class="d-flex align-items-center gap-2 mb-1">
          {% set type_badges = {
            'model_analysis': ('bg-primary', 'Model Analysis'),
            'template_comparison': ('bg-purple', 'Template Comparison'),
            'tool_analysis': ('bg-green', 'Tool Analysis')
          } %}
          {% set badge_class, badge_text = type_badges.get(report.report_type, ('bg-secondary', report.report_type)) %}
          <span class="badge {{ badge_class }}">{{ badge_text }}</span>
          <span class="badge bg-success">Completed</span>
        </div>
        <h1 class="page-title mb-0">{{ report.title }}</h1>
        {% if report.description %}
        <p class="text-muted mb-0 mt-1">{{ report.description }}</p>
        {% endif %}
      </div>
      <div class="col-auto d-flex gap-2">
        <button class="btn btn-ghost-primary" onclick="window.print()">
          <i class="fa-solid fa-print me-2"></i>Print
        </button>
        <button class="btn btn-primary" onclick="downloadJSON()">
          <i class="fa-solid fa-download me-2"></i>Download JSON
        </button>
      </div>
    </div>
  </div>
  
  {# Loading state #}
  <div id="loading-state" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p class="text-muted">Loading report data...</p>
  </div>
  
  {# Error state #}
  <div id="error-state" class="d-none">
    <div class="alert alert-danger">
      <div class="d-flex">
        <i class="fa-solid fa-exclamation-triangle me-3 fa-2x"></i>
        <div>
          <h4 class="alert-title">Failed to load report</h4>
          <p id="error-message" class="mb-0">An error occurred while loading the report data.</p>
        </div>
      </div>
    </div>
    <a href="{{ url_for('reports.reports_index') }}" class="btn btn-secondary">
      <i class="fa-solid fa-arrow-left me-2"></i>Back to Reports
    </a>
  </div>
  
  {# Report content (populated by JavaScript) #}
  <div id="report-content" class="d-none"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
  const reportId = '{{ report_id }}';
  const reportType = '{{ report.report_type }}';
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const errorMessage = document.getElementById('error-message');
  const reportContent = document.getElementById('report-content');
  
  let reportData = null;
  let severityChart = null;
  let toolsChart = null;
  
  // Fetch report data
  async function loadReport() {
    try {
      const response = await fetch(`/api/reports/${reportId}/data`);
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to load report');
      }
      
      reportData = result.data;
      loadingState.classList.add('d-none');
      reportContent.classList.remove('d-none');
      renderReport();
      
    } catch (e) {
      console.error('Failed to load report:', e);
      loadingState.classList.add('d-none');
      errorMessage.textContent = e.message;
      errorState.classList.remove('d-none');
    }
  }
  
  // Download JSON
  window.downloadJSON = function() {
    if (!reportData) return;
    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `report_${reportId}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };
  
  // Escape HTML
  function h(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  
  // Format number with commas
  function formatNumber(n) {
    return (n || 0).toLocaleString();
  }
  
  // Format duration
  function formatDuration(seconds) {
    if (!seconds) return 'N/A';
    if (seconds < 60) return `${seconds.toFixed(1)}s`;
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins}m ${secs}s`;
  }
  
  // Severity badge
  function severityBadge(sev) {
    const colors = {
      critical: 'bg-danger',
      high: 'bg-orange',
      medium: 'bg-yellow text-dark',
      low: 'bg-success',
      info: 'bg-info'
    };
    return `<span class="badge ${colors[sev?.toLowerCase()] || 'bg-secondary'}">${h(sev || 'Unknown')}</span>`;
  }
  
  // Task status badge with proper colors
  function statusBadge(status, taskStatus) {
    const statusMap = {
      'completed': { class: 'status-completed', icon: 'check', text: 'Completed' },
      'partial': { class: 'status-partial', icon: 'exclamation', text: 'Partial' },
      'partial_success': { class: 'status-partial', icon: 'exclamation', text: 'Partial' },
      'failed': { class: 'status-failed', icon: 'times', text: 'Failed' },
      'cancelled': { class: 'status-cancelled', icon: 'ban', text: 'Cancelled' },
      'running': { class: 'status-running', icon: 'spinner fa-spin', text: 'Running' },
      'pending': { class: 'status-pending', icon: 'clock', text: 'Pending' },
    };
    const s = statusMap[status?.toLowerCase()] || statusMap[taskStatus?.toLowerCase()] || { class: 'bg-secondary', icon: 'question', text: status || 'Unknown' };
    return `<span class="badge ${s.class}"><i class="fa-solid fa-${s.icon} me-1"></i>${s.text}</span>`;
  }
  
  // Render the report based on type
  function renderReport() {
    switch(reportType) {
      case 'model_analysis':
        renderModelAnalysis();
        break;
      case 'template_comparison':
        renderTemplateComparison();
        break;
      case 'tool_analysis':
        renderToolAnalysis();
        break;
      default:
        renderGenericReport();
    }
  }
  
  // === Model Analysis Report (Comprehensive) ===
  function renderModelAnalysis() {
    const d = reportData;
    const summary = d.summary || {};
    const apps = d.apps || [];
    const tools = d.tool_summary || {};
    const findings = d.findings_breakdown || {};
    const genStats = d.generation_stats || {};
    const analysisStats = d.analysis_stats || {};
    const execMetrics = d.execution_metrics || {};
    const frameworks = d.framework_distribution || {};
    const modelInfo = d.model_info || {};
    
    let html = `
      <!-- Model Info Banner (if available) -->
      ${Object.keys(modelInfo).length > 0 ? `
      <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-robot fa-2x me-3"></i>
          <div>
            <h4 class="mb-1">${h(modelInfo.model_name || d.model_slug)}</h4>
            <div class="text-muted">
              Provider: <strong>${h(modelInfo.provider || 'Unknown')}</strong>
              ${modelInfo.context_window ? ` | Context: <strong>${formatNumber(modelInfo.context_window)}</strong> tokens` : ''}
              ${modelInfo.supports_vision ? ' | <span class="badge bg-purple-lt">Vision</span>' : ''}
              ${modelInfo.supports_function_calling ? ' | <span class="badge bg-info-lt">Function Calling</span>' : ''}
              ${modelInfo.is_free ? ' | <span class="badge bg-success-lt">Free</span>' : ''}
            </div>
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Summary Cards Row 1 -->
      <div class="row row-deck row-cards mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="card metric-card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader text-muted">Applications</div>
              </div>
              <div class="h1 mb-0">${formatNumber(summary.total_apps)}</div>
              <div class="text-muted small">${genStats.successful_generations || 0} successful generations</div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card metric-card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader text-muted">Analyses</div>
              </div>
              <div class="h1 mb-0">${formatNumber(summary.total_analyses)}</div>
              <div class="text-muted small">${analysisStats.completed_analyses || 0} completed, ${analysisStats.failed_analyses || 0} failed</div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card metric-card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader text-muted">Total Findings</div>
              </div>
              <div class="h1 mb-0">${formatNumber(summary.total_findings)}</div>
              <div class="text-muted small">Across all tools</div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card metric-card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader text-muted">Avg Findings/App</div>
              </div>
              <div class="h1 mb-0">${(summary.avg_findings_per_app || 0).toFixed(1)}</div>
              <div class="text-muted small">Avg duration: ${formatDuration(execMetrics.avg_duration_seconds)}</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Severity Breakdown with Chart -->
      <div class="row row-deck row-cards mb-4">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-chart-pie me-2"></i>Findings by Severity</h3>
            </div>
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="chart-container">
                    <canvas id="severity-chart"></canvas>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="row g-3">
                    ${Object.entries(findings).map(([sev, count]) => `
                      <div class="col-6">
                        <div class="d-flex align-items-center">
                          <span class="badge bg-${sev === 'critical' ? 'danger' : sev === 'high' ? 'orange' : sev === 'medium' ? 'yellow text-dark' : sev === 'low' ? 'success' : 'info'} me-2" style="width: 12px; height: 12px; padding: 0;"></span>
                          <div>
                            <div class="h3 mb-0">${formatNumber(count)}</div>
                            <div class="text-muted small text-capitalize">${sev}</div>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-clock me-2"></i>Execution Metrics</h3>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                  <span class="text-muted">Total Duration</span>
                  <strong>${formatDuration(execMetrics.total_duration_seconds)}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                  <span class="text-muted">Avg Duration</span>
                  <strong>${formatDuration(execMetrics.avg_duration_seconds)}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                  <span class="text-muted">Total Queue Time</span>
                  <strong>${formatDuration(execMetrics.total_queue_time_seconds)}</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Total Retries</span>
                  <strong>${formatNumber(analysisStats.total_retries)}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Generation & Framework Stats -->
      <div class="row row-deck row-cards mb-4">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-hammer me-2"></i>Generation Statistics</h3>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-6 col-md-4">
                  <div class="text-center">
                    <div class="h2 mb-0 text-success">${formatNumber(genStats.successful_generations)}</div>
                    <div class="text-muted small">Successful</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="text-center">
                    <div class="h2 mb-0 text-danger">${formatNumber(genStats.failed_generations)}</div>
                    <div class="text-muted small">Failed</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="text-center">
                    <div class="h2 mb-0 text-info">${formatNumber(genStats.apps_with_fixes)}</div>
                    <div class="text-muted small">With Fixes</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-center">
                    <div class="h4 mb-0">${formatNumber(genStats.total_scripted_fixes)}</div>
                    <div class="text-muted small">Script Fixes</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-center">
                    <div class="h4 mb-0">${formatNumber(genStats.total_llm_fixes)}</div>
                    <div class="text-muted small">LLM Fixes</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-center">
                    <div class="h4 mb-0">${formatNumber(genStats.total_manual_fixes)}</div>
                    <div class="text-muted small">Manual Fixes</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-layer-group me-2"></i>Framework Distribution</h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <h5 class="text-muted mb-2">Backend</h5>
                  ${Object.entries(frameworks.backend || {}).length > 0 ? 
                    Object.entries(frameworks.backend).map(([fw, count]) => `
                      <div class="d-flex justify-content-between mb-1">
                        <span>${h(fw)}</span>
                        <strong>${count}</strong>
                      </div>
                    `).join('') : '<span class="text-muted">No data</span>'}
                </div>
                <div class="col-6">
                  <h5 class="text-muted mb-2">Frontend</h5>
                  ${Object.entries(frameworks.frontend || {}).length > 0 ? 
                    Object.entries(frameworks.frontend).map(([fw, count]) => `
                      <div class="d-flex justify-content-between mb-1">
                        <span>${h(fw)}</span>
                        <strong>${count}</strong>
                      </div>
                    `).join('') : '<span class="text-muted">No data</span>'}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Applications Table (Expanded) -->
      <div class="card mb-4">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#apps-section">
          <h3 class="card-title"><i class="fa-solid fa-folder me-2"></i>Applications <span class="badge bg-secondary ms-2">${apps.length}</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse show" id="apps-section">
          <div class="table-responsive">
            <table class="table table-vcenter card-table table-hover">
              <thead>
                <tr>
                  <th>App</th>
                  <th>Template</th>
                  <th>Frameworks</th>
                  <th>Status</th>
                  <th>Findings</th>
                  <th>Severity Breakdown</th>
                  <th>Duration</th>
                  <th>Fixes</th>
                </tr>
              </thead>
              <tbody>
                ${apps.map(app => `
                  <tr>
                    <td>
                      <strong>App ${app.app_number}</strong>
                      <div class="text-muted small">${h(app.task_id || '')}</div>
                    </td>
                    <td><span class="badge bg-blue-lt">${h(app.template_slug || 'N/A')}</span></td>
                    <td>
                      ${app.backend_framework ? `<span class="badge bg-purple-lt me-1">${h(app.backend_framework)}</span>` : ''}
                      ${app.frontend_framework ? `<span class="badge bg-cyan-lt">${h(app.frontend_framework)}</span>` : ''}
                      ${!app.backend_framework && !app.frontend_framework ? '<span class="text-muted">—</span>' : ''}
                    </td>
                    <td>${statusBadge(app.status, app.task_status)}</td>
                    <td><strong>${formatNumber(app.findings_count)}</strong></td>
                    <td>
                      <div class="d-flex gap-1 flex-wrap">
                        ${Object.entries(app.severity_breakdown || {}).filter(([s, c]) => c > 0).map(([s, c]) => `
                          <span class="badge bg-${s === 'critical' ? 'danger' : s === 'high' ? 'orange' : s === 'medium' ? 'yellow text-dark' : s === 'low' ? 'success' : 'info'}">${s}: ${c}</span>
                        `).join('') || '<span class="text-muted">No findings</span>'}
                      </div>
                    </td>
                    <td>${formatDuration(app.duration_seconds)}</td>
                    <td>
                      ${app.total_fixes > 0 ? `<span class="badge bg-info-lt">${app.total_fixes} fixes</span>` : '<span class="text-muted">—</span>'}
                    </td>
                  </tr>
                  ${app.subtasks && app.subtasks.length > 0 ? `
                  <tr class="bg-light">
                    <td colspan="8" class="py-2">
                      <div class="ms-4">
                        <small class="text-muted">Subtasks: </small>
                        ${app.subtasks.map(st => `
                          <span class="badge ${st.status === 'success' ? 'bg-success-lt' : st.status === 'error' ? 'bg-danger-lt' : 'bg-secondary-lt'} me-1">
                            ${h(st.service)} ${st.issues_found ? `(${st.issues_found})` : ''}
                          </span>
                        `).join('')}
                      </div>
                    </td>
                  </tr>
                  ` : ''}
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Tool Performance (Enhanced) -->
      <div class="card mb-4">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#tools-section">
          <h3 class="card-title"><i class="fa-solid fa-wrench me-2"></i>Tool Performance <span class="badge bg-secondary ms-2">${Object.keys(tools).length}</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse show" id="tools-section">
          <div class="table-responsive">
            <table class="table table-vcenter card-table table-hover">
              <thead>
                <tr>
                  <th>Tool</th>
                  <th>Runs</th>
                  <th>Success Rate</th>
                  <th>Total Findings</th>
                  <th>Avg/Run</th>
                  <th>Avg Duration</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(tools).map(([name, tool]) => `
                  <tr>
                    <td><strong>${h(tool.display_name || name)}</strong></td>
                    <td>${formatNumber(tool.total_runs || tool.executions)}</td>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <div class="progress flex-grow-1" style="height: 6px; min-width: 60px;">
                          <div class="progress-bar ${(tool.success_rate || 0) >= 80 ? 'bg-success' : (tool.success_rate || 0) >= 50 ? 'bg-warning' : 'bg-danger'}" style="width: ${tool.success_rate || 0}%"></div>
                        </div>
                        <span class="small">${tool.success_rate ? tool.success_rate.toFixed(0) + '%' : 'N/A'}</span>
                      </div>
                    </td>
                    <td>${formatNumber(tool.total_findings)}</td>
                    <td>${(tool.findings_per_run || 0).toFixed(1)}</td>
                    <td>${formatDuration(tool.avg_duration)}</td>
                    <td>
                      <span class="tool-status-${tool.overall_status}">
                        <i class="fa-solid fa-${tool.overall_status === 'success' ? 'check-circle' : tool.overall_status === 'error' ? 'times-circle' : 'minus-circle'} me-1"></i>
                        ${tool.overall_status || 'unknown'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Sample Findings (Collapsible) -->
      ${(d.findings || []).length > 0 ? `
      <div class="card">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#findings-section">
          <h3 class="card-title"><i class="fa-solid fa-bug me-2"></i>Sample Findings <span class="badge bg-secondary ms-2">${Math.min(50, d.findings.length)} of ${d.findings.length}</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse" id="findings-section">
          <div class="card-body" style="max-height: 500px; overflow-y: auto;">
            ${d.findings.slice(0, 50).map(f => `
              <div class="finding-item severity-${(f.severity || 'info').toLowerCase()} mb-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>${h(f.message || f.title || 'Finding')}</strong>
                    ${f.tool ? `<span class="badge bg-secondary-lt ms-2">${h(f.tool)}</span>` : ''}
                  </div>
                  ${severityBadge(f.severity)}
                </div>
                <div class="text-muted small mt-1">
                  ${f.file ? `<i class="fa-solid fa-file me-1"></i>${h(f.file)}${f.line ? `:${f.line}` : ''}` : ''}
                  ${f.rule_id ? ` | Rule: ${h(f.rule_id)}` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      ` : ''}
    `;
    
    reportContent.innerHTML = html;
    
    // Initialize severity chart
    setTimeout(() => {
      const ctx = document.getElementById('severity-chart');
      if (ctx && Object.keys(findings).length > 0) {
        const severityColors = {
          critical: '#d63939',
          high: '#f76707',
          medium: '#f59f00',
          low: '#2fb344',
          info: '#0ea5e9'
        };
        
        severityChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(findings).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
            datasets: [{
              data: Object.values(findings),
              backgroundColor: Object.keys(findings).map(s => severityColors[s] || '#868e96'),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            cutout: '60%'
          }
        });
      }
    }, 100);
  }
  
  // === Template Comparison Report ===
  function renderTemplateComparison() {
    const d = reportData;
    const summary = d.summary || {};
    const models = d.models || [];
    const rankings = d.rankings || {};
    const comparison = d.comparison || {};
    const frameworks = d.framework_distribution || {};
    const findingsBreakdown = d.findings_breakdown || summary.severity_breakdown || {};
    
    // Calculate additional metrics
    const totalFindings = summary.total_findings || 0;
    const avgFindingsPerModel = models.length > 0 ? (totalFindings / models.length).toFixed(1) : 0;
    const bestScore = rankings.best_overall?.score?.toFixed(1) || 'N/A';
    const worstScore = rankings.worst_overall?.score?.toFixed(1) || 'N/A';
    const scoreSpread = (rankings.worst_overall?.score && rankings.best_overall?.score) 
      ? (rankings.worst_overall.score - rankings.best_overall.score).toFixed(1) 
      : 'N/A';
    
    let html = `
      <!-- Research Header -->
      <div class="alert alert-info mb-4">
        <div class="d-flex">
          <div><i class="fa-solid fa-flask fa-2x me-3"></i></div>
          <div>
            <h4 class="alert-title">Template Comparison Analysis</h4>
            <div class="text-secondary">
              Comparing how <strong>${formatNumber(summary.models_compared || 0)} AI models</strong> implemented 
              the <strong>${h(summary.template_slug || 'N/A')}</strong> template.
              This analysis identifies patterns, common issues, and ranks models by code quality metrics.
            </div>
          </div>
        </div>
      </div>
      
      <!-- Key Metrics Summary -->
      <div class="row row-deck row-cards mb-4">
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-primary">${formatNumber(summary.models_compared || 0)}</div>
              <div class="text-muted">Models Compared</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-info">${formatNumber(summary.total_analyses || 0)}</div>
              <div class="text-muted">Total Analyses</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-warning">${formatNumber(totalFindings)}</div>
              <div class="text-muted">Total Findings</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0">${avgFindingsPerModel}</div>
              <div class="text-muted">Avg per Model</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-success">${formatNumber(summary.common_issues_count || 0)}</div>
              <div class="text-muted">Common Issues</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0">${formatDuration(summary.avg_duration_seconds || 0)}</div>
              <div class="text-muted">Avg Duration</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Severity Distribution Visual -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-chart-bar me-2"></i>Severity Distribution Across All Models</h3>
            </div>
            <div class="card-body">
              <div class="chart-container" id="severity-chart-container">
                <canvas id="severityDistributionChart"></canvas>
              </div>
              <div class="row mt-4">
                <div class="col">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-danger me-2">&nbsp;</span>
                    <span>Critical: <strong>${formatNumber(findingsBreakdown.critical || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-orange me-2">&nbsp;</span>
                    <span>High: <strong>${formatNumber(findingsBreakdown.high || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-yellow me-2">&nbsp;</span>
                    <span>Medium: <strong>${formatNumber(findingsBreakdown.medium || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">&nbsp;</span>
                    <span>Low: <strong>${formatNumber(findingsBreakdown.low || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2">&nbsp;</span>
                    <span>Info: <strong>${formatNumber(findingsBreakdown.info || 0)}</strong></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-layer-group me-2"></i>Framework Distribution</h3>
            </div>
            <div class="card-body">
              <h5 class="text-muted mb-2">Backend Frameworks</h5>
              ${Object.entries(frameworks.backend || {}).length > 0 ? 
                Object.entries(frameworks.backend).map(([fw, count]) => `
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-purple-lt">${h(fw)}</span>
                    <strong>${count} model${count > 1 ? 's' : ''}</strong>
                  </div>
                `).join('') : '<span class="text-muted">No data available</span>'}
              
              <hr class="my-3">
              
              <h5 class="text-muted mb-2">Frontend Frameworks</h5>
              ${Object.entries(frameworks.frontend || {}).length > 0 ? 
                Object.entries(frameworks.frontend).map(([fw, count]) => `
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-cyan-lt">${h(fw)}</span>
                    <strong>${count} model${count > 1 ? 's' : ''}</strong>
                  </div>
                `).join('') : '<span class="text-muted">No data available</span>'}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Rankings Section -->
      ${rankings.best_overall || rankings.worst_overall ? `
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card border-success">
            <div class="card-status-top bg-success"></div>
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-trophy text-success me-2"></i>Best Performing Model</h3>
            </div>
            <div class="card-body">
              ${rankings.best_overall ? `
                <div class="d-flex align-items-center mb-3">
                  <div class="avatar avatar-lg bg-success-lt me-3">
                    <i class="fa-solid fa-medal fa-lg text-success"></i>
                  </div>
                  <div>
                    <h2 class="mb-0">${h(rankings.best_overall.model_name || rankings.best_overall.model)}</h2>
                    <div class="text-muted">Lowest weighted score</div>
                  </div>
                </div>
                <div class="row text-center">
                  <div class="col-4">
                    <div class="h3 mb-0">${rankings.best_overall.score?.toFixed(1) || 'N/A'}</div>
                    <div class="text-muted small">Score</div>
                  </div>
                  <div class="col-4">
                    <div class="h3 mb-0">${formatNumber(rankings.best_overall.total_findings || 0)}</div>
                    <div class="text-muted small">Findings</div>
                  </div>
                  <div class="col-4">
                    <div class="h3 mb-0">#1</div>
                    <div class="text-muted small">Rank</div>
                  </div>
                </div>
              ` : '<div class="text-muted">No data available</div>'}
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-danger">
            <div class="card-status-top bg-danger"></div>
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-triangle-exclamation text-danger me-2"></i>Needs Improvement</h3>
            </div>
            <div class="card-body">
              ${rankings.worst_overall ? `
                <div class="d-flex align-items-center mb-3">
                  <div class="avatar avatar-lg bg-danger-lt me-3">
                    <i class="fa-solid fa-exclamation-circle fa-lg text-danger"></i>
                  </div>
                  <div>
                    <h2 class="mb-0">${h(rankings.worst_overall.model_name || rankings.worst_overall.model)}</h2>
                    <div class="text-muted">Highest weighted score</div>
                  </div>
                </div>
                <div class="row text-center">
                  <div class="col-4">
                    <div class="h3 mb-0">${rankings.worst_overall.score?.toFixed(1) || 'N/A'}</div>
                    <div class="text-muted small">Score</div>
                  </div>
                  <div class="col-4">
                    <div class="h3 mb-0">${formatNumber(rankings.worst_overall.total_findings || 0)}</div>
                    <div class="text-muted small">Findings</div>
                  </div>
                  <div class="col-4">
                    <div class="h3 mb-0">#${models.length || '?'}</div>
                    <div class="text-muted small">Rank</div>
                  </div>
                </div>
              ` : '<div class="text-muted">No data available</div>'}
            </div>
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Full Rankings Table -->
      ${rankings.all_ranked && rankings.all_ranked.length > 0 ? `
      <div class="card mb-4">
        <div class="card-header">
          <h3 class="card-title"><i class="fa-solid fa-ranking-star me-2"></i>Complete Model Rankings</h3>
          <div class="card-subtitle">Ranked by weighted severity score (Critical×100 + High×10 + Medium×3 + Low×1)</div>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table table-hover">
            <thead>
              <tr>
                <th style="width: 80px">Rank</th>
                <th>Model</th>
                <th class="text-center">Critical</th>
                <th class="text-center">High</th>
                <th class="text-center">Medium</th>
                <th class="text-center">Low</th>
                <th class="text-center">Total Findings</th>
                <th class="text-center">Score</th>
                <th style="width: 150px">Visual</th>
              </tr>
            </thead>
            <tbody>
              ${rankings.all_ranked.map((r, idx) => {
                const m = models.find(m => m.model_slug === r.model) || {};
                const sev = m.severity_breakdown || {};
                const maxScore = rankings.worst_overall?.score || 1;
                const scorePercent = maxScore > 0 ? ((r.score || 0) / maxScore * 100) : 0;
                return `
                  <tr class="${idx === 0 ? 'table-success' : idx === rankings.all_ranked.length - 1 ? 'table-danger' : ''}">
                    <td>
                      <div class="d-flex align-items-center">
                        ${idx === 0 ? '<i class="fa-solid fa-crown text-warning me-2"></i>' : ''}
                        <span class="badge ${idx === 0 ? 'bg-success' : idx < 3 ? 'bg-primary' : 'bg-secondary'}">#${r.rank}</span>
                      </div>
                    </td>
                    <td>
                      <strong>${h(r.model_name || r.model)}</strong>
                    </td>
                    <td class="text-center severity-critical"><strong>${formatNumber(sev.critical || 0)}</strong></td>
                    <td class="text-center severity-high"><strong>${formatNumber(sev.high || 0)}</strong></td>
                    <td class="text-center severity-medium"><strong>${formatNumber(sev.medium || 0)}</strong></td>
                    <td class="text-center severity-low"><strong>${formatNumber(sev.low || 0)}</strong></td>
                    <td class="text-center"><strong>${formatNumber(r.total_findings || 0)}</strong></td>
                    <td class="text-center"><strong>${r.score?.toFixed(1) || 'N/A'}</strong></td>
                    <td>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar ${idx === 0 ? 'bg-success' : scorePercent > 50 ? 'bg-danger' : 'bg-warning'}" style="width: ${scorePercent}%"></div>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      ` : ''}
      
      <!-- Per-Severity Best Models -->
      ${rankings.by_severity && Object.keys(rankings.by_severity).length > 0 ? `
      <div class="card mb-4">
        <div class="card-header">
          <h3 class="card-title"><i class="fa-solid fa-award me-2"></i>Best Models by Severity Category</h3>
        </div>
        <div class="card-body">
          <div class="row">
            ${Object.entries(rankings.by_severity).map(([sev, data]) => {
              const sevColors = {
                critical: { bg: 'danger', icon: 'skull-crossbones' },
                high: { bg: 'orange', icon: 'exclamation-triangle' },
                medium: { bg: 'yellow', icon: 'exclamation-circle' },
                low: { bg: 'success', icon: 'info-circle' }
              };
              const c = sevColors[sev] || { bg: 'secondary', icon: 'question' };
              return `
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card card-sm border-${c.bg}">
                    <div class="card-status-start bg-${c.bg}"></div>
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fa-solid fa-${c.icon} text-${c.bg} me-2"></i>
                        <span class="text-uppercase text-muted small">Fewest ${sev}</span>
                      </div>
                      <h4 class="mb-1">${h(data?.model_name || data?.model || 'N/A')}</h4>
                      <div class="text-muted">${formatNumber(data?.count || 0)} findings</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Common Issues Section -->
      ${comparison.common_issues && comparison.common_issues.length > 0 ? `
      <div class="card mb-4">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#common-issues-section">
          <h3 class="card-title"><i class="fa-solid fa-link me-2"></i>Common Issues Across Models <span class="badge bg-warning ms-2">${comparison.common_issues.length}</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse show" id="common-issues-section">
          <div class="card-body">
            <p class="text-muted mb-3">These issues were found across multiple models, indicating common patterns or template-inherent problems.</p>
            <div class="list-group list-group-flush">
              ${comparison.common_issues.slice(0, 20).map(issue => `
                <div class="list-group-item finding-item severity-${(issue.severity || 'info').toLowerCase()}">
                  <div class="d-flex w-100 justify-content-between align-items-start">
                    <div>
                      ${severityBadge(issue.severity)}
                      <strong class="ms-2">${h(issue.rule_id || issue.tool || 'Unknown')}</strong>
                    </div>
                    <small class="text-muted">${h(issue.tool || '')}</small>
                  </div>
                  <p class="mb-1 mt-2">${h(issue.message || 'No description')}</p>
                  ${issue.file ? `<small class="text-muted"><i class="fa-solid fa-file-code me-1"></i>${h(issue.file)}${issue.line ? ':' + issue.line : ''}</small>` : ''}
                </div>
              `).join('')}
            </div>
            ${comparison.common_issues.length > 20 ? `<div class="text-muted mt-3">Showing 20 of ${comparison.common_issues.length} common issues</div>` : ''}
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Detailed Model Data -->
      <div class="card mb-4">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#models-detail-section">
          <h3 class="card-title"><i class="fa-solid fa-robot me-2"></i>Detailed Model Analysis <span class="badge bg-secondary ms-2">${models.length}</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse show" id="models-detail-section">
          <div class="table-responsive">
            <table class="table table-vcenter card-table table-hover">
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Task Status</th>
                  <th>Frameworks</th>
                  <th class="text-center">Critical</th>
                  <th class="text-center">High</th>
                  <th class="text-center">Medium</th>
                  <th class="text-center">Low</th>
                  <th class="text-center">Total</th>
                  <th class="text-center">Score</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
                ${models.map(m => {
                  const sev = m.severity_breakdown || {};
                  const isWinner = rankings.best_overall?.model === m.model_slug;
                  const isWorst = rankings.worst_overall?.model === m.model_slug;
                  return `
                    <tr class="${isWinner ? 'table-success' : isWorst ? 'table-danger' : ''}">
                      <td>
                        <div class="d-flex align-items-center">
                          ${isWinner ? '<i class="fa-solid fa-crown text-warning me-2"></i>' : ''}
                          <div>
                            <strong>${h(m.model_name || m.model_slug)}</strong>
                            ${isWinner ? '<span class="badge bg-success ms-2">Best</span>' : ''}
                            ${isWorst ? '<span class="badge bg-danger ms-2">Most Issues</span>' : ''}
                            <div class="text-muted small">App #${m.app_number || '?'}</div>
                          </div>
                        </div>
                      </td>
                      <td>${statusBadge(m.status, m.task_status)}</td>
                      <td>
                        ${m.backend_framework ? `<span class="badge bg-purple-lt me-1">${h(m.backend_framework)}</span>` : ''}
                        ${m.frontend_framework ? `<span class="badge bg-cyan-lt">${h(m.frontend_framework)}</span>` : ''}
                        ${!m.backend_framework && !m.frontend_framework ? '<span class="text-muted">—</span>' : ''}
                      </td>
                      <td class="text-center severity-critical"><strong>${formatNumber(sev.critical || 0)}</strong></td>
                      <td class="text-center severity-high"><strong>${formatNumber(sev.high || 0)}</strong></td>
                      <td class="text-center severity-medium"><strong>${formatNumber(sev.medium || 0)}</strong></td>
                      <td class="text-center severity-low"><strong>${formatNumber(sev.low || 0)}</strong></td>
                      <td class="text-center"><strong>${formatNumber(m.total_findings || m.findings_count || 0)}</strong></td>
                      <td class="text-center"><strong>${m.score?.toFixed(1) || 'N/A'}</strong></td>
                      <td>${formatDuration(m.duration_seconds)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Research Notes -->
      <div class="card border-info">
        <div class="card-header bg-info-lt">
          <h3 class="card-title"><i class="fa-solid fa-lightbulb me-2"></i>Research Insights</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h5>Key Findings</h5>
              <ul class="mb-0">
                <li><strong>Score Spread:</strong> ${scoreSpread} points between best and worst models</li>
                <li><strong>Average Findings:</strong> ${avgFindingsPerModel} issues per model</li>
                <li><strong>Common Issues:</strong> ${formatNumber(summary.common_issues_count || 0)} issues found across multiple models</li>
                ${rankings.best_overall ? `<li><strong>Best Performer:</strong> ${h(rankings.best_overall.model_name || rankings.best_overall.model)} with ${formatNumber(rankings.best_overall.total_findings || 0)} total findings</li>` : ''}
              </ul>
            </div>
            <div class="col-md-6">
              <h5>Methodology</h5>
              <ul class="mb-0">
                <li><strong>Scoring Formula:</strong> Critical×100 + High×10 + Medium×3 + Low×1</li>
                <li><strong>Lower scores indicate better code quality</strong></li>
                <li>Analysis based on ${formatNumber(summary.total_analyses || 0)} task executions</li>
                <li>Common issues identified by rule_id matching</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    `;
    
    reportContent.innerHTML = html;
    
    // Initialize severity chart
    setTimeout(() => {
      const ctx = document.getElementById('severityDistributionChart');
      if (ctx && typeof Chart !== 'undefined') {
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
            datasets: [{
              data: [
                findingsBreakdown.critical || 0,
                findingsBreakdown.high || 0,
                findingsBreakdown.medium || 0,
                findingsBreakdown.low || 0,
                findingsBreakdown.info || 0
              ],
              backgroundColor: ['#d63939', '#f76707', '#f59f00', '#2fb344', '#0ea5e9']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }
    }, 100);
  }
  
  // === Tool Analysis Report ===
  function renderToolAnalysis() {
    const d = reportData;
    const summary = d.summary || {};
    const tools = d.tools || [];
    const categories = d.categories || {};
    const topPerformers = d.top_performers || {};
    const byModel = d.by_model || {};
    const filter = d.filter || {};
    const findingsBreakdown = d.findings_breakdown || summary.severity_breakdown || {};
    const findings = d.findings || [];
    
    // Calculate additional metrics
    const totalFindings = summary.total_findings || 0;
    const avgFindingsPerRun = tools.length > 0 
      ? (tools.reduce((acc, t) => acc + (t.total_findings || 0), 0) / summary.total_runs).toFixed(2) 
      : 0;
    const mostEffective = tools.length > 0 
      ? tools.reduce((best, t) => (t.total_findings || 0) > (best.total_findings || 0) ? t : best, tools[0]) 
      : null;
    const mostReliable = tools.length > 0 
      ? tools.reduce((best, t) => (t.success_rate || 0) > (best.success_rate || 0) ? t : best, tools[0]) 
      : null;
    
    // Calculate category stats
    const categoryStats = Object.entries(categories).map(([name, data]) => ({
      name,
      ...data,
      avgFindings: data.total_runs > 0 ? (data.total_findings / data.total_runs).toFixed(1) : 0
    }));
    
    let html = `
      <!-- Research Header -->
      <div class="alert alert-success mb-4">
        <div class="d-flex">
          <div><i class="fa-solid fa-microscope fa-2x me-3"></i></div>
          <div>
            <h4 class="alert-title">Tool Effectiveness Analysis</h4>
            <div class="text-secondary">
              Analyzing <strong>${formatNumber(summary.tools_analyzed || 0)} analysis tools</strong> across 
              <strong>${formatNumber(summary.total_runs || 0)} executions</strong>.
              This report evaluates tool performance, detection rates, and reliability metrics.
              ${filter.tool_name ? `<br>Filtered to: <strong>${h(filter.tool_name)}</strong>` : ''}
              ${filter.model ? `<br>Model filter: <strong>${h(filter.model)}</strong>` : ''}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Key Metrics Summary -->
      <div class="row row-deck row-cards mb-4">
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-primary">${formatNumber(summary.tools_analyzed || 0)}</div>
              <div class="text-muted">Tools Analyzed</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-info">${formatNumber(summary.total_runs || 0)}</div>
              <div class="text-muted">Total Executions</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 text-warning">${formatNumber(totalFindings)}</div>
              <div class="text-muted">Total Findings</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0 ${(summary.avg_success_rate || 0) >= 90 ? 'text-success' : (summary.avg_success_rate || 0) >= 70 ? 'text-warning' : 'text-danger'}">${summary.avg_success_rate ? summary.avg_success_rate.toFixed(0) + '%' : 'N/A'}</div>
              <div class="text-muted">Avg Success Rate</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0">${avgFindingsPerRun}</div>
              <div class="text-muted">Findings/Run</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card metric-card">
            <div class="card-body text-center">
              <div class="h1 mb-0">${Object.keys(categories).length}</div>
              <div class="text-muted">Tool Categories</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Severity Distribution -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="card h-100">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-chart-pie me-2"></i>Findings by Severity</h3>
            </div>
            <div class="card-body">
              <div class="chart-container" id="tool-severity-chart-container">
                <canvas id="toolSeverityChart"></canvas>
              </div>
              <div class="row mt-4">
                <div class="col">
                  <div class="d-flex align-items-center justify-content-center">
                    <span class="badge bg-danger me-2">&nbsp;</span>
                    <span>Critical: <strong>${formatNumber(findingsBreakdown.critical || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center justify-content-center">
                    <span class="badge bg-orange me-2">&nbsp;</span>
                    <span>High: <strong>${formatNumber(findingsBreakdown.high || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center justify-content-center">
                    <span class="badge bg-yellow me-2">&nbsp;</span>
                    <span>Medium: <strong>${formatNumber(findingsBreakdown.medium || 0)}</strong></span>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex align-items-center justify-content-center">
                    <span class="badge bg-success me-2">&nbsp;</span>
                    <span>Low: <strong>${formatNumber(findingsBreakdown.low || 0)}</strong></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-trophy me-2"></i>Top Performers</h3>
            </div>
            <div class="card-body">
              ${mostEffective ? `
              <div class="mb-4">
                <div class="text-muted small text-uppercase mb-1">Most Findings Detected</div>
                <div class="d-flex align-items-center">
                  <div class="avatar bg-warning-lt me-3">
                    <i class="fa-solid fa-bug text-warning"></i>
                  </div>
                  <div>
                    <h4 class="mb-0">${h(mostEffective.display_name || mostEffective.name)}</h4>
                    <div class="text-muted">${formatNumber(mostEffective.total_findings || 0)} findings</div>
                  </div>
                </div>
              </div>
              ` : ''}
              ${mostReliable ? `
              <div class="mb-4">
                <div class="text-muted small text-uppercase mb-1">Most Reliable</div>
                <div class="d-flex align-items-center">
                  <div class="avatar bg-success-lt me-3">
                    <i class="fa-solid fa-check-circle text-success"></i>
                  </div>
                  <div>
                    <h4 class="mb-0">${h(mostReliable.display_name || mostReliable.name)}</h4>
                    <div class="text-muted">${mostReliable.success_rate?.toFixed(0) || 0}% success rate</div>
                  </div>
                </div>
              </div>
              ` : ''}
              <div class="text-muted small text-uppercase mb-1">Tool Categories</div>
              <div class="d-flex flex-wrap gap-1">
                ${Object.keys(categories).map(cat => `
                  <span class="badge bg-azure-lt">${h(cat)}</span>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Category Breakdown -->
      ${Object.keys(categories).length > 0 ? `
      <div class="card mb-4">
        <div class="card-header">
          <h3 class="card-title"><i class="fa-solid fa-layer-group me-2"></i>Analysis by Container/Category</h3>
        </div>
        <div class="card-body">
          <div class="row">
            ${categoryStats.map(cat => {
              const catColors = {
                'static-analyzer': { bg: 'purple', icon: 'code' },
                'dynamic-analyzer': { bg: 'orange', icon: 'shield-halved' },
                'performance-tester': { bg: 'cyan', icon: 'gauge-high' },
                'ai-analyzer': { bg: 'pink', icon: 'brain' }
              };
              const c = catColors[cat.name] || { bg: 'secondary', icon: 'tools' };
              return `
                <div class="col-md-6 col-lg-3 mb-3">
                  <div class="card border-${c.bg} h-100">
                    <div class="card-status-top bg-${c.bg}"></div>
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-3">
                        <div class="avatar bg-${c.bg}-lt me-3">
                          <i class="fa-solid fa-${c.icon} text-${c.bg}"></i>
                        </div>
                        <h4 class="mb-0">${h(cat.name)}</h4>
                      </div>
                      <div class="row text-center">
                        <div class="col-4">
                          <div class="h4 mb-0">${formatNumber(cat.tools_count)}</div>
                          <div class="text-muted small">Tools</div>
                        </div>
                        <div class="col-4">
                          <div class="h4 mb-0">${formatNumber(cat.total_runs)}</div>
                          <div class="text-muted small">Runs</div>
                        </div>
                        <div class="col-4">
                          <div class="h4 mb-0">${formatNumber(cat.total_findings)}</div>
                          <div class="text-muted small">Findings</div>
                        </div>
                      </div>
                      <hr class="my-2">
                      <div class="text-muted small">
                        <strong>Avg per run:</strong> ${cat.avgFindings} findings
                      </div>
                      <div class="text-muted small mt-1">
                        <strong>Tools:</strong> ${(cat.tools || []).slice(0, 3).join(', ')}${(cat.tools || []).length > 3 ? '...' : ''}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Detailed Tool Performance Table -->
      <div class="card mb-4">
        <div class="card-header">
          <h3 class="card-title"><i class="fa-solid fa-table me-2"></i>Detailed Tool Performance</h3>
          <div class="card-subtitle">Sorted by execution count (most active first)</div>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table table-hover">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Category</th>
                <th class="text-center">Executions</th>
                <th class="text-center">Success Rate</th>
                <th class="text-center">Total Findings</th>
                <th class="text-center">Avg/Run</th>
                <th class="text-center">Avg Duration</th>
                <th>Severity Breakdown</th>
              </tr>
            </thead>
            <tbody>
              ${tools.map((t, idx) => {
                const sevBreak = t.findings_by_severity || {};
                const isTop = idx < 3;
                return `
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        ${isTop ? '<i class="fa-solid fa-star text-warning me-2"></i>' : ''}
                        <div>
                          <strong>${h(t.display_name || t.name || t.tool_name)}</strong>
                          <div class="text-muted small">${h(t.tool_name || t.name)}</div>
                        </div>
                      </div>
                    </td>
                    <td><span class="badge bg-azure-lt">${h(t.container || t.service || 'unknown')}</span></td>
                    <td class="text-center"><strong>${formatNumber(t.total_runs || t.executions)}</strong></td>
                    <td class="text-center">
                      <div class="d-flex align-items-center justify-content-center gap-2">
                        <div class="progress flex-grow-1" style="height: 6px; max-width: 80px;">
                          <div class="progress-bar ${(t.success_rate || 0) >= 90 ? 'bg-success' : (t.success_rate || 0) >= 70 ? 'bg-warning' : 'bg-danger'}" style="width: ${t.success_rate || 0}%"></div>
                        </div>
                        <span class="small ${(t.success_rate || 0) >= 90 ? 'text-success' : (t.success_rate || 0) >= 70 ? 'text-warning' : 'text-danger'}">${t.success_rate ? t.success_rate.toFixed(0) + '%' : 'N/A'}</span>
                      </div>
                    </td>
                    <td class="text-center"><strong>${formatNumber(t.total_findings)}</strong></td>
                    <td class="text-center">${(t.avg_findings || t.findings_per_run || 0).toFixed(1)}</td>
                    <td class="text-center">${t.avg_duration ? t.avg_duration.toFixed(1) + 's' : 'N/A'}</td>
                    <td>
                      <div class="d-flex gap-1 flex-wrap">
                        ${(sevBreak.critical || 0) > 0 ? `<span class="badge bg-danger">${sevBreak.critical} crit</span>` : ''}
                        ${(sevBreak.high || 0) > 0 ? `<span class="badge bg-orange">${sevBreak.high} high</span>` : ''}
                        ${(sevBreak.medium || 0) > 0 ? `<span class="badge bg-yellow text-dark">${sevBreak.medium} med</span>` : ''}
                        ${(sevBreak.low || 0) > 0 ? `<span class="badge bg-success">${sevBreak.low} low</span>` : ''}
                        ${!sevBreak.critical && !sevBreak.high && !sevBreak.medium && !sevBreak.low ? '<span class="text-muted">—</span>' : ''}
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Per-Model Tool Usage -->
      ${Object.keys(byModel).length > 0 ? `
      <div class="card mb-4">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#by-model-section">
          <h3 class="card-title"><i class="fa-solid fa-robot me-2"></i>Tool Usage by Model <span class="badge bg-secondary ms-2">${Object.keys(byModel).length} models</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse" id="by-model-section">
          <div class="card-body">
            <div class="accordion" id="modelAccordion">
              ${Object.entries(byModel).map(([model, modelTools], idx) => `
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#model-${idx}">
                      <strong>${h(model.replace('_', ' / ').replace('-', ' ').substring(0, 50))}</strong>
                      <span class="badge bg-secondary ms-2">${Object.keys(modelTools).length} tools</span>
                    </button>
                  </h2>
                  <div id="model-${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#modelAccordion">
                    <div class="accordion-body">
                      <div class="table-responsive">
                        <table class="table table-sm table-borderless">
                          <thead>
                            <tr>
                              <th>Tool</th>
                              <th class="text-center">Executions</th>
                              <th class="text-center">Successful</th>
                              <th class="text-center">Findings</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${Object.entries(modelTools).map(([toolName, toolData]) => `
                              <tr>
                                <td>${h(toolName)}</td>
                                <td class="text-center">${formatNumber(toolData.executions)}</td>
                                <td class="text-center">${formatNumber(toolData.successful)}</td>
                                <td class="text-center">${formatNumber(toolData.findings)}</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Sample Findings -->
      ${findings.length > 0 ? `
      <div class="card mb-4">
        <div class="card-header section-collapse" data-bs-toggle="collapse" data-bs-target="#findings-section">
          <h3 class="card-title"><i class="fa-solid fa-list me-2"></i>Sample Findings <span class="badge bg-secondary ms-2">${Math.min(findings.length, 25)} of ${findings.length}</span></h3>
          <div class="card-actions">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="collapse" id="findings-section">
          <div class="card-body">
            <div class="list-group list-group-flush">
              ${findings.slice(0, 25).map(f => `
                <div class="list-group-item finding-item severity-${(f.severity || 'info').toLowerCase()}">
                  <div class="d-flex w-100 justify-content-between align-items-start">
                    <div>
                      ${severityBadge(f.severity)}
                      <span class="badge bg-azure-lt ms-2">${h(f.tool || 'unknown')}</span>
                      <strong class="ms-2">${h(f.rule_id || f.check_id || '')}</strong>
                    </div>
                  </div>
                  <p class="mb-1 mt-2">${h(f.message || f.description || 'No description')}</p>
                  ${f.file_path || f.file ? `<small class="text-muted"><i class="fa-solid fa-file-code me-1"></i>${h(f.file_path || f.file)}${f.line ? ':' + f.line : ''}</small>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Research Summary -->
      <div class="card border-success">
        <div class="card-header bg-success-lt">
          <h3 class="card-title"><i class="fa-solid fa-chart-line me-2"></i>Research Summary</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h5>Tool Effectiveness Metrics</h5>
              <ul class="mb-0">
                <li><strong>Total Tools:</strong> ${formatNumber(summary.tools_analyzed || 0)} unique tools analyzed</li>
                <li><strong>Total Executions:</strong> ${formatNumber(summary.total_runs || 0)} runs across all tools</li>
                <li><strong>Average Success Rate:</strong> ${summary.avg_success_rate ? summary.avg_success_rate.toFixed(1) + '%' : 'N/A'}</li>
                <li><strong>Findings per Run:</strong> ${avgFindingsPerRun} average</li>
                ${mostEffective ? `<li><strong>Most Effective:</strong> ${h(mostEffective.display_name || mostEffective.name)} (${formatNumber(mostEffective.total_findings || 0)} findings)</li>` : ''}
              </ul>
            </div>
            <div class="col-md-6">
              <h5>Category Distribution</h5>
              <ul class="mb-0">
                ${categoryStats.map(cat => `
                  <li><strong>${h(cat.name)}:</strong> ${formatNumber(cat.tools_count)} tools, ${formatNumber(cat.total_findings)} findings</li>
                `).join('')}
              </ul>
              ${filter.tool_name || filter.model ? `
                <hr>
                <h5>Active Filters</h5>
                <ul class="mb-0">
                  ${filter.tool_name ? `<li>Tool: ${h(filter.tool_name)}</li>` : ''}
                  ${filter.model ? `<li>Model: ${h(filter.model)}</li>` : ''}
                </ul>
              ` : ''}
            </div>
          </div>
        </div>
      </div>
    `;
    
    reportContent.innerHTML = html;
    
    // Initialize severity chart
    setTimeout(() => {
      const ctx = document.getElementById('toolSeverityChart');
      if (ctx && typeof Chart !== 'undefined') {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
            datasets: [{
              label: 'Findings',
              data: [
                findingsBreakdown.critical || 0,
                findingsBreakdown.high || 0,
                findingsBreakdown.medium || 0,
                findingsBreakdown.low || 0,
                findingsBreakdown.info || 0
              ],
              backgroundColor: ['#d63939', '#f76707', '#f59f00', '#2fb344', '#0ea5e9']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    }, 100);
  }
  
  // === Generic Report ===
  function renderGenericReport() {
    reportContent.innerHTML = `
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Report Data</h3>
        </div>
        <div class="card-body">
          <pre class="mb-0"><code>${h(JSON.stringify(reportData, null, 2))}</code></pre>
        </div>
      </div>
    `;
  }
  
  // Load report on page load
  loadReport();
})();
</script>
{% endblock %}

