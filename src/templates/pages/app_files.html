{% extends "pages/app_base.html" %}

{% block page_content %}
<div class="row">
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-folder-tree text-primary mr-2"></i>
                    Project Structure
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="file-tree" 
                     hx-get="/api/files/{{ model }}/{{ app_num }}/tree"
                     hx-target="this"
                     hx-trigger="load">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted small">Loading files...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <!-- File Actions Bar -->
        <div class="card mb-3">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" 
                                onclick="copyFileContent()"
                                class="btn btn-outline-primary">
                            <i class="fas fa-copy mr-1"></i>Copy Content
                        </button>
                        <button type="button" 
                                onclick="downloadCurrentFile()"
                                class="btn btn-outline-secondary">
                            <i class="fas fa-download mr-1"></i>Download File
                        </button>
                        <button type="button" 
                                hx-get="/api/files/{{ model }}/{{ app_num }}/download-all"
                                class="btn btn-outline-info">
                            <i class="fas fa-file-archive mr-1"></i>Download All
                        </button>
                    </div>
                    
                    <div class="file-stats text-muted small">
                        <span id="file-count">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Content Viewer -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-file-code text-info mr-2"></i>
                        <span id="current-file-name">Select a file to view</span>
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" 
                                onclick="toggleLineNumbers()"
                                class="btn btn-outline-secondary">
                            <i class="fas fa-list-ol mr-1"></i>Line Numbers
                        </button>
                        <button type="button" 
                                onclick="toggleWordWrap()"
                                class="btn btn-outline-secondary">
                            <i class="fas fa-text-width mr-1"></i>Word Wrap
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="file-content">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <h5>Select a file to view its contents</h5>
                        <p>Click on any file in the project structure to view its code</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Code Analysis Results -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-microscope text-warning mr-2"></i>
                    Code Analysis
                </h5>
            </div>
            <div class="card-body">
                <div id="file-analysis"
                     hx-get="/api/files/{{ model }}/{{ app_num }}/analysis"
                     hx-trigger="load"
                     hx-target="this">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <div class="h4 mb-0">
                                        <i class="fas fa-file-code fa-2x"></i>
                                    </div>
                                    <div class="mt-2">
                                        <h6 class="mb-0">Total Files</h6>
                                        <div class="h5">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <div class="h4 mb-0">
                                        <i class="fas fa-code fa-2x"></i>
                                    </div>
                                    <div class="mt-2">
                                        <h6 class="mb-0">Lines of Code</h6>
                                        <div class="h5">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <div class="h4 mb-0">
                                        <i class="fas fa-layer-group fa-2x"></i>
                                    </div>
                                    <div class="mt-2">
                                        <h6 class="mb-0">Components</h6>
                                        <div class="h5">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <div class="h4 mb-0">
                                        <i class="fas fa-cube fa-2x"></i>
                                    </div>
                                    <div class="mt-2">
                                        <h6 class="mb-0">Dependencies</h6>
                                        <div class="h5">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Type Breakdown -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>File Type Distribution</h6>
                            <div class="file-types">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-muted" role="status"></div>
                                    <p class="mt-2 text-muted">Analyzing file types...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Project Structure</h6>
                            <div class="project-structure">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-folder text-warning mr-2"></i>backend/</li>
                                    <li class="ml-3"><i class="fas fa-file-code text-primary mr-2"></i>Flask application files</li>
                                    <li><i class="fas fa-folder text-warning mr-2"></i>frontend/</li>
                                    <li class="ml-3"><i class="fas fa-file-code text-success mr-2"></i>React + Vite files</li>
                                    <li><i class="fas fa-file text-info mr-2"></i>docker-compose.yml</li>
                                    <li><i class="fas fa-file text-secondary mr-2"></i>Configuration files</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.file-tree {
    max-height: 400px;
    overflow-y: auto;
}

.file-tree .list-group-item {
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.file-tree .list-group-item:hover {
    background-color: #f8f9fa;
}

.file-tree .list-group-item.active {
    background-color: #007bff;
    color: white;
}

.file-tree .file-icon {
    width: 16px;
    text-align: center;
    margin-right: 0.5rem;
}

#file-content {
    max-height: 600px;
    overflow-y: auto;
    background: #f8f9fa;
}

#file-content pre {
    margin: 0;
    padding: 1rem;
    background: transparent;
    border: none;
    font-size: 0.875rem;
    line-height: 1.4;
    font-family: 'Fira Code', 'Courier New', monospace;
}

#file-content code {
    background: transparent;
    color: inherit;
}

/* Syntax highlighting colors */
.language-javascript { color: #f1c40f; }
.language-python { color: #3776ab; }
.language-html { color: #e34c26; }
.language-css { color: #1572b6; }
.language-json { color: #000000; }
.language-dockerfile { color: #2496ed; }
.language-yaml { color: #cb171e; }

/* Line numbers */
.line-numbers {
    counter-reset: line;
}

.line-numbers .line {
    counter-increment: line;
}

.line-numbers .line:before {
    content: counter(line);
    display: inline-block;
    width: 3em;
    padding-right: 0.5em;
    text-align: right;
    color: #999;
    border-right: 1px solid #ddd;
    margin-right: 0.5em;
}

/* Word wrap toggle */
.word-wrap pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>

<script>
// File viewer functionality
function selectFile(element, filePath, fileName) {
    // Update active state
    document.querySelectorAll('.file-tree .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
    
    // Update file name
    document.getElementById('current-file-name').textContent = fileName;
    
    // Load file content
    htmx.ajax('GET', `/api/files/{{ model }}/{{ app_num }}/content?path=${encodeURIComponent(filePath)}`, {
        target: '#file-content'
    });
}

function copyFileContent() {
    const content = document.querySelector('#file-content pre');
    if (content) {
        navigator.clipboard.writeText(content.textContent).then(() => {
            showNotification('File content copied to clipboard!', 'success');
        });
    } else {
        showNotification('No file content to copy', 'warning');
    }
}

function downloadCurrentFile() {
    const fileName = document.getElementById('current-file-name').textContent;
    if (fileName !== 'Select a file to view') {
        window.location.href = `/api/files/{{ model }}/{{ app_num }}/download-file?name=${encodeURIComponent(fileName)}`;
    } else {
        showNotification('Please select a file first', 'warning');
    }
}

function toggleLineNumbers() {
    const fileContent = document.getElementById('file-content');
    fileContent.classList.toggle('line-numbers');
    
    const button = event.target.closest('button');
    if (fileContent.classList.contains('line-numbers')) {
        button.classList.add('active');
        showNotification('Line numbers enabled', 'info');
    } else {
        button.classList.remove('active');
        showNotification('Line numbers disabled', 'info');
    }
}

function toggleWordWrap() {
    const fileContent = document.getElementById('file-content');
    fileContent.classList.toggle('word-wrap');
    
    const button = event.target.closest('button');
    if (fileContent.classList.contains('word-wrap')) {
        button.classList.add('active');
        showNotification('Word wrap enabled', 'info');
    } else {
        button.classList.remove('active');
        showNotification('Word wrap disabled', 'info');
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed notification-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
