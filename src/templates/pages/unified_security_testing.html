{% extends "base.html" %}

{% block title %}Unified Security Testing - Research Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Unified Security Testing</h1>
            <p class="page-subtitle">Comprehensive security analysis across all models</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTestModal">
                <i class="fas fa-plus"></i> New Test
            </button>
            <button class="btn btn-secondary" onclick="refreshTests()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Active Tests -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title">Active Tests</h5>
                <span class="badge badge-primary" id="active-test-count">0</span>
            </div>
        </div>
        <div class="card-body">
            <div id="active-tests" 
                 hx-get="/testing/api/active-tests"
                 hx-trigger="load, every 5s">
                <div class="text-center p-4">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-2">Loading tests...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Modal -->
<div id="modal-container"></div>

{% endblock %}

{% block extra_js %}
<script>
// Modal handling for HTMX
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'modal-container') {
        const modal = evt.detail.target.querySelector('.modal');
        if (modal) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                evt.detail.target.innerHTML = '';
            });
        }
    }
});

// Update active test count
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'active-tests') {
        const activeTestRows = evt.detail.target.querySelectorAll('.test-row');
        const countBadge = document.getElementById('active-test-count');
        if (countBadge) {
            countBadge.textContent = activeTestRows.length;
        }
    }
});

function refreshTests() {
    htmx.trigger(document.getElementById('active-tests'), 'load');
}
</script>
{% endblock %}
             hx-swap="innerHTML">
            <div class="col-12">
                <div class="d-flex justify-content-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading statistics...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Tests -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle text-success me-2"></i>Active Tests
                        </h5>
                        <span class="badge bg-primary" id="active-test-count">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="active-tests"
                         hx-get="/testing/api/jobs?status=running"
                         hx-trigger="load, every 5s"
                         hx-swap="innerHTML">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading active tests...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Test History
                        </h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" 
                                    hx-get="/testing/api/jobs"
                                    hx-trigger="change"
                                    hx-target="#test-history"
                                    hx-include="[name='status'],[name='type'],[name='limit']"
                                    name="status">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="running">Running</option>
                                <option value="failed">Failed</option>
                                <option value="pending">Pending</option>
                            </select>
                            <select class="form-select form-select-sm"
                                    hx-get="/testing/api/jobs"
                                    hx-trigger="change"
                                    hx-target="#test-history"
                                    hx-include="[name='status'],[name='type'],[name='limit']"
                                    name="type">
                                <option value="">All Types</option>
                                <option value="security">Security Scan</option>
                                <option value="performance">Performance Test</option>
                                <option value="zap">ZAP Scan</option>
                                <option value="ai">AI Analysis</option>
                            </select>
                            <select class="form-select form-select-sm"
                                    hx-get="/testing/api/jobs"
                                    hx-trigger="change"
                                    hx-target="#test-history"
                                    hx-include="[name='status'],[name='type'],[name='limit']"
                                    name="limit">
                                <option value="10">Last 10</option>
                                <option value="25">Last 25</option>
                                <option value="50">Last 50</option>
                                <option value="100">Last 100</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="test-history"
                         hx-get="/testing/api/jobs"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading test history...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Container -->
<div id="test-results-container"></div>

<!-- Job Actions Feedback -->
<div id="job-actions-feedback"></div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testDetailsModalLabel">Test Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="test-details-modal">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1" aria-labelledby="testResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testResultsModalLabel">Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="test-results-modal">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Test Logs Modal -->
<div class="modal fade" id="testLogsModal" tabindex="-1" aria-labelledby="testLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testLogsModalLabel">Test Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="test-logs-modal">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Container for HTMX -->
<div id="modal-container"></div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
// Handle HTMX events for notifications
document.body.addEventListener('htmx:afterRequest', function(evt) {
    // Check for custom headers or response triggers
    if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
        const message = evt.detail.xhr.getResponseHeader('HX-Message');
        if (message) {
            showToast('success', message);
        }
    }
});

document.body.addEventListener('htmx:responseError', function(evt) {
    showToast('error', 'An error occurred. Please try again.');
});

function showToast(type, message) {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    const container = document.getElementById('toast-container');
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastEl = container.lastElementChild;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

// Handle modal cleanup
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'modal-container') {
        const modal = evt.detail.target.querySelector('.modal');
        if (modal) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                evt.detail.target.innerHTML = '';
            });
        }
    }
});

// Update active test count
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'active-tests') {
        const activeTestRows = evt.detail.target.querySelectorAll('.test-row');
        const countBadge = document.getElementById('active-test-count');
        if (countBadge) {
            countBadge.textContent = activeTestRows.length;
        }
    }
});
</script>
{% endblock %}
