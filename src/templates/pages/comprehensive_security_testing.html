{% extends "base.html" %}

{% block title %}Comprehensive Security Testing & Analysis Platform - AI Research Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 mb-2">
                    <li class="breadcrumb-item">
                        <a href="/dashboard">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Security Testing
                    </li>
                </ol>
            </nav>
            <h1 class="page-title">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                Security Testing & Analysis Platform
            </h1>
            <p class="page-subtitle">
                Comprehensive security analysis with advanced CLI tools and automated testing
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-success btn-sm" onclick="showCreateTestModal()">
                <i class="fas fa-plus mr-1"></i>
                Create New Test
            </button>
            <button type="button" class="btn btn-info btn-sm" onclick="refreshData()">
                <i class="fas fa-sync-alt mr-1"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Overview Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Active Tests</h5>
                            <span class="h2 font-weight-bold mb-0" id="active-tests-count">0</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-primary text-white rounded-circle shadow">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Total Vulnerabilities</h5>
                            <span class="h2 font-weight-bold mb-0" id="total-vulns-count">0</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Tools Available</h5>
                            <span class="h2 font-weight-bold mb-0" id="tools-count">15</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-success text-white rounded-circle shadow">
                                <i class="fas fa-tools"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Models Tested</h5>
                            <span class="h2 font-weight-bold mb-0" id="models-tested-count">0</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-info text-white rounded-circle shadow">
                                <i class="fas fa-brain"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="card">
        <div class="card-header border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs" id="mainTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="tests-tab" data-toggle="tab" href="#tests" role="tab">
                        <i class="fas fa-list mr-1"></i>Active Tests
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="results-tab" data-toggle="tab" href="#results" role="tab">
                        <i class="fas fa-chart-bar mr-1"></i>Results & Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="tools-tab" data-toggle="tab" href="#tools" role="tab">
                        <i class="fas fa-tools mr-1"></i>Available Tools
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="models-tab" data-toggle="tab" href="#models" role="tab">
                        <i class="fas fa-brain mr-1"></i>Models Status
                    </a>
                </li>
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="mainTabsContent">
                <!-- Active Tests Tab -->
                <div class="tab-pane fade show active" id="tests" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover" id="testsTable">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Models</th>
                                    <th>Tools</th>
                                    <th>Started</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                <!-- Tests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Results & Analytics Tab -->
                <div class="tab-pane fade" id="results" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Vulnerability Trends</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="vulnerabilityChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Severity Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="severityChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Tools Tab -->
                <div class="tab-pane fade" id="tools" role="tabpanel">
                    <div class="row" id="toolsGrid">
                        <!-- Tools will be loaded here -->
                    </div>
                </div>

                <!-- Models Status Tab -->
                <div class="tab-pane fade" id="models" role="tabpanel">
                    <div class="row" id="modelsGrid">
                        <!-- Models will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Create Security Test Modal -->
<div class="modal fade" id="createTestModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-alt text-primary mr-2"></i>
                    Create Comprehensive Security Test
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createTestForm">
                    <!-- Test Configuration Tabs -->
                    <ul class="nav nav-pills mb-3" id="testConfigTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="basic-config-tab" data-toggle="pill" href="#basic-config" role="tab">
                                <i class="fas fa-cog mr-1"></i>Basic Configuration
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="target-selection-tab" data-toggle="pill" href="#target-selection" role="tab">
                                <i class="fas fa-bullseye mr-1"></i>Target Selection
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tool-config-tab" data-toggle="pill" href="#tool-config" role="tab">
                                <i class="fas fa-tools mr-1"></i>Tool Configuration
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="advanced-config-tab" data-toggle="pill" href="#advanced-config" role="tab">
                                <i class="fas fa-sliders-h mr-1"></i>Advanced Options
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content" id="testConfigTabsContent">
                        <!-- Basic Configuration Tab -->
                        <div class="tab-pane fade show active" id="basic-config" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="job_name">Test Name *</label>
                                        <input type="text" class="form-control" id="job_name" name="job_name" 
                                               placeholder="Enter descriptive test name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="test_type">Test Type *</label>
                                        <select class="form-control" id="test_type" name="test_type" required onchange="handleTestTypeChange(this.value)">
                                            <option value="">Select test type</option>
                                            <option value="security_analysis">Security Analysis (SAST)</option>
                                            <option value="zap_scan">ZAP Security Scan (DAST)</option>
                                            <option value="performance_test">Performance Testing</option>
                                            <option value="ai_analysis">AI-Powered Analysis</option>
                                            <option value="comprehensive">Comprehensive Multi-Tool</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3" 
                                          placeholder="Describe the purpose and scope of this security test...">Example security test scenarios:
- Comprehensive vulnerability assessment of web applications
- Static analysis for common security issues (SQL injection, XSS, etc.)
- Dependency vulnerability scanning
- Code quality and security best practices review
- Authentication and authorization testing
- Input validation and sanitization checks</textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="priority">Priority</label>
                                        <select class="form-control" id="priority" name="priority">
                                            <option value="2">Normal</option>
                                            <option value="1">Low</option>
                                            <option value="3">High</option>
                                            <option value="4">Urgent</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="timeout">Timeout (seconds)</label>
                                        <input type="number" class="form-control" id="timeout" name="timeout" 
                                               value="1800" min="60" max="7200">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="concurrency">Concurrency</label>
                                        <input type="number" class="form-control" id="concurrency" name="concurrency" 
                                               value="1" min="1" max="8">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="auto_start" name="auto_start" checked>
                                        <label class="form-check-label" for="auto_start">
                                            Auto-start test immediately
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="generate_report" name="generate_report" checked>
                                        <label class="form-check-label" for="generate_report">
                                            Generate detailed report
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Target Selection Tab -->
                        <div class="tab-pane fade" id="target-selection" role="tabpanel">
                            <h6 class="text-muted mb-3">Select Models and Applications for Testing</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="select_all_models" onchange="toggleAllModels()">
                                        <label class="form-check-label" for="select_all_models">
                                            <strong>Select All Models</strong>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="setAppRange(1, 5)">Apps 1-5</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="setAppRange(6, 10)">Apps 6-10</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="setAppRange(11, 20)">Apps 11-20</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="setAppRange(1, 20)">All Apps</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Available Models</h6>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            <div id="modelsSelectionList">
                                                <!-- Models will be populated here -->
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading models...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <h6>Application Range</h6>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="app_start">Start App #</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           id="app_start" name="app_start" value="1" min="1" max="20">
                                                </div>
                                                <div class="col-6">
                                                    <label for="app_end">End App #</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           id="app_end" name="app_end" value="5" min="1" max="20">
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <label>Quick Selection:</label>
                                                <div id="appCheckboxes" class="mt-2">
                                                    <!-- App checkboxes will be generated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tool Configuration Tab -->
                        <div class="tab-pane fade" id="tool-config" role="tabpanel">
                            <h6 class="text-muted mb-3">Select and Configure Security Analysis Tools</h6>
                            
                            <!-- Security Analysis Tools -->
                            <div id="security-tools-section" style="display: none;">
                                <h6 class="text-primary">Static Application Security Testing (SAST) Tools</h6>
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_bandit" name="tools" value="bandit">
                                                    <label class="form-check-label" for="tool_bandit">
                                                        <strong>Bandit</strong> <span class="badge badge-secondary">Python</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Python security linter for common security issues
                                                <div class="tool-options mt-2" id="bandit-options" style="display: none;">
                                                    <div class="form-group mb-2">
                                                        <label class="small">Confidence Level</label>
                                                        <select class="form-control form-control-sm" name="bandit_confidence">
                                                            <option value="low">Low</option>
                                                            <option value="medium" selected>Medium</option>
                                                            <option value="high">High</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group mb-2">
                                                        <label class="small">Severity Level</label>
                                                        <select class="form-control form-control-sm" name="bandit_severity">
                                                            <option value="low">Low</option>
                                                            <option value="medium" selected>Medium</option>
                                                            <option value="high">High</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_safety" name="tools" value="safety">
                                                    <label class="form-check-label" for="tool_safety">
                                                        <strong>Safety</strong> <span class="badge badge-secondary">Dependencies</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Python dependency vulnerability scanner
                                                <div class="tool-options mt-2" id="safety-options" style="display: none;">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="safety_detailed_output">
                                                        <label class="form-check-label small">Detailed output</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="safety_continue_on_error" checked>
                                                        <label class="form-check-label small">Continue on error</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_semgrep" name="tools" value="semgrep">
                                                    <label class="form-check-label" for="tool_semgrep">
                                                        <strong>Semgrep</strong> <span class="badge badge-secondary">Multi-language</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Fast static analysis for 17+ languages
                                                <div class="tool-options mt-2" id="semgrep-options" style="display: none;">
                                                    <div class="form-group mb-2">
                                                        <label class="small">Config</label>
                                                        <select class="form-control form-control-sm" name="semgrep_config">
                                                            <option value="p/security-audit" selected>Security Audit</option>
                                                            <option value="p/owasp-top-10">OWASP Top 10</option>
                                                            <option value="p/cwe-top-25">CWE Top 25</option>
                                                            <option value="auto">Auto-detect</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group mb-2">
                                                        <label class="small">Severity</label>
                                                        <select class="form-control form-control-sm" name="semgrep_severity">
                                                            <option value="ERROR">Error</option>
                                                            <option value="WARNING" selected>Warning</option>
                                                            <option value="INFO">Info</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_eslint" name="tools" value="eslint">
                                                    <label class="form-check-label" for="tool_eslint">
                                                        <strong>ESLint</strong> <span class="badge badge-secondary">JavaScript</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                JavaScript/TypeScript static analysis
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_retire" name="tools" value="retire">
                                                    <label class="form-check-label" for="tool_retire">
                                                        <strong>Retire.js</strong> <span class="badge badge-secondary">JavaScript</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                JavaScript vulnerability detection
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_npm_audit" name="tools" value="npm-audit">
                                                    <label class="form-check-label" for="tool_npm_audit">
                                                        <strong>npm audit</strong> <span class="badge badge-secondary">Node.js</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Node.js dependency vulnerability scanner
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="text-primary">Additional Security Tools</h6>
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_snyk" name="tools" value="snyk">
                                                    <label class="form-check-label" for="tool_snyk">
                                                        <strong>Snyk</strong>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Developer security platform
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_trufflehog" name="tools" value="trufflehog">
                                                    <label class="form-check-label" for="tool_trufflehog">
                                                        <strong>TruffleHog</strong>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Secret scanning engine
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_codeql" name="tools" value="codeql">
                                                    <label class="form-check-label" for="tool_codeql">
                                                        <strong>CodeQL</strong>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                GitHub's semantic code analysis
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tool_sonarqube" name="tools" value="sonarqube">
                                                    <label class="form-check-label" for="tool_sonarqube">
                                                        <strong>SonarQube</strong>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body p-2 small">
                                                Code quality and security
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ZAP Scan Tools -->
                            <div id="zap-tools-section" style="display: none;">
                                <h6 class="text-primary">Dynamic Application Security Testing (DAST)</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="zap_target_url">Target URL *</label>
                                            <input type="url" class="form-control" id="zap_target_url" name="zap_target_url" 
                                                   placeholder="https://example.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="zap_scan_type">Scan Type</label>
                                            <select class="form-control" id="zap_scan_type" name="zap_scan_type">
                                                <option value="baseline">Baseline Scan</option>
                                                <option value="active">Active Scan</option>
                                                <option value="api">API Scan</option>
                                                <option value="full">Full Scan</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Test Tools -->
                            <div id="performance-tools-section" style="display: none;">
                                <h6 class="text-primary">Performance Testing Configuration</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="perf_users">Virtual Users</label>
                                            <input type="number" class="form-control" id="perf_users" name="perf_users" value="10" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="perf_duration">Duration (seconds)</label>
                                            <input type="number" class="form-control" id="perf_duration" name="perf_duration" value="60" min="10">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="perf_spawn_rate">Spawn Rate</label>
                                            <input type="number" class="form-control" id="perf_spawn_rate" name="perf_spawn_rate" value="2" step="0.1" min="0.1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Configuration Tab -->
                        <div class="tab-pane fade" id="advanced-config" role="tabpanel">
                            <h6 class="text-muted mb-3">Advanced Testing Options and Output Configuration</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="output_format">Output Format</label>
                                        <select class="form-control" id="output_format" name="output_format">
                                            <option value="json" selected>JSON</option>
                                            <option value="xml">XML</option>
                                            <option value="html">HTML</option>
                                            <option value="csv">CSV</option>
                                            <option value="text">Text</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="scan_depth">Scan Depth</label>
                                        <select class="form-control" id="scan_depth" name="scan_depth">
                                            <option value="quick">Quick</option>
                                            <option value="standard" selected>Standard</option>
                                            <option value="deep">Deep</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="fail_fast" name="fail_fast">
                                        <label class="form-check-label" for="fail_fast">
                                            Fail fast on first critical issue
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include_dependencies" name="include_dependencies" checked>
                                        <label class="form-check-label" for="include_dependencies">
                                            Include dependency scanning
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mt-3">
                                <label for="custom_config">Custom Configuration (JSON)</label>
                                <textarea class="form-control" id="custom_config" name="custom_config" rows="4" 
                                          placeholder='{"custom_option": "value", "advanced_settings": {}}'></textarea>
                                <small class="form-text text-muted">Optional: Provide custom JSON configuration for advanced tool settings</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitTestForm()">
                    <i class="fas fa-rocket mr-1"></i>Create Test
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="testDetailsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Results</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="testResultsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle mr-2"></i>
            <strong class="mr-auto">Success</strong>
            <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">
                <span>&times;</span>
            </button>
        </div>
        <div class="toast-body" id="successToastBody"></div>
    </div>
    
    <div id="errorToast" class="toast" role="alert">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <strong class="mr-auto">Error</strong>
            <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">
                <span>&times;</span>
            </button>
        </div>
        <div class="toast-body" id="errorToastBody"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Comprehensive Security Testing Platform JavaScript
class ComprehensiveSecurityTestingPlatform {
    constructor() {
        this.refreshInterval = null;
        this.autoRefreshEnabled = false;
        this.charts = {};
        this.availableModels = [];
        this.availableTools = [];
        this.tests = [];
        
        this.init();
    }
    
    init() {
        this.loadModels();
        this.loadTools();
        this.loadTests();
        this.initCharts();
        this.generateAppCheckboxes();
        this.bindToolEvents();
        this.updateStatistics();
    }
    
    async loadModels() {
        try {
            const response = await fetch('/api/testing/models');
            if (response.ok) {
                const data = await response.json();
                this.availableModels = data.models || [];
                this.renderModelsSelection();
                this.renderModelsStatus();
                this.updateStatistics();
            }
        } catch (error) {
            console.error('Error loading models:', error);
            this.showToast('Error loading models', 'error');
        }
    }
    
    async loadTools() {
        try {
            const response = await fetch('/api/testing/tools');
            if (response.ok) {
                const data = await response.json();
                this.availableTools = data.tools || [];
                this.renderToolsGrid();
            }
        } catch (error) {
            console.error('Error loading tools:', error);
        }
    }
    
    async loadTests() {
        try {
            const response = await fetch('/api/testing/jobs');
            if (response.ok) {
                const data = await response.json();
                this.tests = data.jobs || [];
                this.renderTestsTable();
                this.updateStatistics();
            }
        } catch (error) {
            console.error('Error loading tests:', error);
        }
    }
    
    renderModelsSelection() {
        const container = document.getElementById('modelsSelectionList');
        if (!container) return;
        
        if (this.availableModels.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No models available</div>';
            return;
        }
        
        container.innerHTML = this.availableModels.map(model => `
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="model_${model.slug}" 
                       name="selected_models" value="${model.slug}">
                <label class="form-check-label" for="model_${model.slug}">
                    <strong>${model.display_name}</strong>
                    <div class="small text-muted">${model.status} • ${model.apps_count} apps</div>
                </label>
            </div>
        `).join('');
    }
    
    renderModelsStatus() {
        const container = document.getElementById('modelsGrid');
        if (!container) return;
        
        container.innerHTML = this.availableModels.map(model => `
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${model.display_name}</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge badge-${model.status === 'ready' ? 'success' : 'secondary'}">${model.status}</span>
                            <small class="text-muted">${model.apps_count} apps</small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    renderToolsGrid() {
        const container = document.getElementById('toolsGrid');
        if (!container) return;
        
        const toolCategories = {
            'SAST': ['bandit', 'safety', 'semgrep', 'eslint', 'sonarqube', 'codeql'],
            'Dependency': ['npm-audit', 'retire', 'snyk', 'safety'],
            'Secrets': ['trufflehog', 'gitleaks'],
            'Quality': ['pylint', 'flake8', 'black', 'isort']
        };
        
        let html = '';
        for (const [category, tools] of Object.entries(toolCategories)) {
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">${category} Tools</h6>
                        </div>
                        <div class="card-body">
                            ${tools.map(tool => `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>${tool}</span>
                                    <span class="badge badge-success">Available</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }
    
    renderTestsTable() {
        const tbody = document.getElementById('testsTableBody');
        if (!tbody) return;
        
        if (this.tests.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-flask fa-2x mb-2"></i><br>
                        No security tests found. Create your first test to get started.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = this.tests.map(test => `
            <tr>
                <td>
                    <strong>${test.name}</strong>
                    <div class="small text-muted">${test.description || 'No description'}</div>
                </td>
                <td><span class="badge badge-info">${test.analysis_types?.[0] || 'Unknown'}</span></td>
                <td><span class="badge badge-${this.getStatusColor(test.status)}">${test.status}</span></td>
                <td>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" style="width: ${test.progress || 0}%"></div>
                    </div>
                    <small>${test.progress || 0}%</small>
                </td>
                <td><span class="badge badge-secondary">${test.models?.length || 0}</span></td>
                <td><span class="badge badge-primary">${test.tools?.length || 0}</span></td>
                <td><small>${test.created_at ? new Date(test.created_at).toLocaleString() : 'Unknown'}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="showTestDetails('${test.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="showTestResults('${test.id}')">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTest('${test.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    generateAppCheckboxes() {
        const container = document.getElementById('appCheckboxes');
        if (!container) return;
        
        const apps = Array.from({length: 20}, (_, i) => i + 1);
        container.innerHTML = apps.map(app => `
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="app_${app}" name="selected_apps" value="${app}">
                <label class="form-check-label" for="app_${app}">${app}</label>
            </div>
        `).join('');
    }
    
    bindToolEvents() {
        // Tool checkbox change events to show/hide options
        document.querySelectorAll('input[name="tools"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const toolName = e.target.value;
                const optionsDiv = document.getElementById(`${toolName}-options`);
                if (optionsDiv) {
                    optionsDiv.style.display = e.target.checked ? 'block' : 'none';
                }
            });
        });
    }
    
    initCharts() {
        // Vulnerability Trends Chart
        const vulnerabilityCtx = document.getElementById('vulnerabilityChart');
        if (vulnerabilityCtx) {
            this.charts.vulnerability = new Chart(vulnerabilityCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Vulnerabilities Found',
                        data: [12, 19, 3, 5, 2, 3],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Severity Distribution Chart
        const severityCtx = document.getElementById('severityChart');
        if (severityCtx) {
            this.charts.severity = new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [2, 8, 15, 25],
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    }
    
    updateStatistics() {
        const activeTests = this.tests.filter(test => ['running', 'queued'].includes(test.status)).length;
        const totalVulns = this.tests.reduce((sum, test) => sum + (test.vulnerabilities_count || 0), 0);
        const modelsTestedCount = new Set(this.tests.flatMap(test => test.models || [])).size;
        
        document.getElementById('active-tests-count').textContent = activeTests;
        document.getElementById('total-vulns-count').textContent = totalVulns;
        document.getElementById('models-tested-count').textContent = modelsTestedCount;
    }
    
    getStatusColor(status) {
        const statusColors = {
            'pending': 'secondary',
            'queued': 'info',
            'running': 'primary',
            'completed': 'success',
            'failed': 'danger',
            'cancelled': 'warning'
        };
        return statusColors[status] || 'secondary';
    }
    
    showToast(message, type = 'success') {
        const toastId = type === 'success' ? 'successToast' : 'errorToast';
        const bodyId = type === 'success' ? 'successToastBody' : 'errorToastBody';
        
        document.getElementById(bodyId).textContent = message;
        $(`#${toastId}`).toast('show');
    }
    
    async submitTestForm() {
        const form = document.getElementById('createTestForm');
        const formData = new FormData(form);
        
        // Convert FormData to regular object
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (data[key]) {
                if (Array.isArray(data[key])) {
                    data[key].push(value);
                } else {
                    data[key] = [data[key], value];
                }
            } else {
                data[key] = value;
            }
        }
        
        // Get selected models and apps
        data.selected_models = Array.from(document.querySelectorAll('input[name="selected_models"]:checked')).map(cb => cb.value);
        data.selected_apps = Array.from(document.querySelectorAll('input[name="selected_apps"]:checked')).map(cb => parseInt(cb.value));
        data.tools = Array.from(document.querySelectorAll('input[name="tools"]:checked')).map(cb => cb.value);
        
        try {
            const response = await fetch('/api/testing/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showToast(result.message, 'success');
                $('#createTestModal').modal('hide');
                this.loadTests();
                form.reset();
            } else {
                this.showToast(result.error || 'Failed to create test', 'error');
            }
        } catch (error) {
            console.error('Error creating test:', error);
            this.showToast('Network error occurred', 'error');
        }
    }
}

// Global functions for template compatibility
window.showCreateTestModal = function() {
    $('#createTestModal').modal('show');
};

window.toggleAllModels = function() {
    const selectAll = document.getElementById('select_all_models');
    const modelCheckboxes = document.querySelectorAll('input[name="selected_models"]');
    
    modelCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
};

window.setAppRange = function(start, end) {
    document.getElementById('app_start').value = start;
    document.getElementById('app_end').value = end;
    
    // Update checkboxes
    document.querySelectorAll('input[name="selected_apps"]').forEach(checkbox => {
        const appNum = parseInt(checkbox.value);
        checkbox.checked = appNum >= start && appNum <= end;
    });
};

window.handleTestTypeChange = function(testType) {
    // Show/hide relevant tool sections
    document.getElementById('security-tools-section').style.display = 
        testType === 'security_analysis' || testType === 'comprehensive' ? 'block' : 'none';
    document.getElementById('zap-tools-section').style.display = 
        testType === 'zap_scan' ? 'block' : 'none';
    document.getElementById('performance-tools-section').style.display = 
        testType === 'performance_test' ? 'block' : 'none';
    
    // Auto-select relevant tools based on test type
    document.querySelectorAll('input[name="tools"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    if (testType === 'security_analysis') {
        ['bandit', 'safety', 'semgrep', 'eslint'].forEach(tool => {
            const checkbox = document.getElementById(`tool_${tool}`);
            if (checkbox) checkbox.checked = true;
        });
    } else if (testType === 'comprehensive') {
        ['bandit', 'safety', 'semgrep', 'eslint', 'retire', 'npm-audit', 'snyk'].forEach(tool => {
            const checkbox = document.getElementById(`tool_${tool}`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    // Trigger tool events
    document.querySelectorAll('input[name="tools"]:checked').forEach(checkbox => {
        checkbox.dispatchEvent(new Event('change'));
    });
};

window.submitTestForm = function() {
    if (window.securityPlatform) {
        window.securityPlatform.submitTestForm();
    }
};

window.refreshData = function() {
    if (window.securityPlatform) {
        window.securityPlatform.loadTests();
        window.securityPlatform.loadModels();
    }
};

window.showTestDetails = function(testId) {
    // Implementation for showing test details
    $('#testDetailsModal').modal('show');
};

window.showTestResults = function(testId) {
    // Implementation for showing test results
    $('#testResultsModal').modal('show');
};

window.deleteTest = function(testId) {
    if (confirm('Are you sure you want to delete this test?')) {
        // Implementation for deleting test
        console.log('Delete test:', testId);
    }
};

// Initialize security testing platform
let securityPlatform;
document.addEventListener('DOMContentLoaded', function() {
    securityPlatform = new ComprehensiveSecurityTestingPlatform();
    window.securityPlatform = securityPlatform;
});
</script>
{% endblock %}
