{% extends "layouts/base_layout.html" %}

{% block title %}Security Analysis Overview{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">
            <i class="fas fa-shield-alt text-primary"></i>
            Security Analysis
        </h1>
        <p class="text-muted mb-0">Comprehensive security analysis of AI-generated applications</p>
    </div>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" 
                hx-get="/analysis/batch" 
                hx-target="#main-content"
                hx-push-url="true">
            <i class="fas fa-tasks"></i> Batch Analysis
        </button>
        <button type="button" class="btn btn-outline-secondary"
                hx-get="/analysis/history"
                hx-target="#main-content"
                hx-push-url="true">
            <i class="fas fa-history"></i> Analysis History
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Analysis Statistics -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-primary">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total Analyses
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" 
                                     id="total-analyses"
                                     hx-get="/api/analysis/stats/total"
                                     hx-trigger="load, every 30s">
                                    {{ analysis_stats.total_analyses or 0 }}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-search fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-success">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Completed Today
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     id="completed-today"
                                     hx-get="/api/analysis/stats/today"
                                     hx-trigger="load, every 30s">
                                    {{ analysis_stats.completed_today or 0 }}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-warning">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Running Analyses
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     id="running-analyses"
                                     hx-get="/api/analysis/stats/running"
                                     hx-trigger="load, every 5s">
                                    {{ analysis_stats.running_analyses or 0 }}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-cog fa-spin fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-danger">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                    Critical Issues
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     id="critical-issues"
                                     hx-get="/api/analysis/stats/critical"
                                     hx-trigger="load, every 30s">
                                    {{ analysis_stats.critical_issues or 0 }}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Tools Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-tools"></i> Analysis Tools Configuration
                </h6>
                <button type="button" class="btn btn-sm btn-outline-primary"
                        data-toggle="modal" data-target="#toolsConfigModal">
                    <i class="fas fa-cog"></i> Configure
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Backend Tools -->
                    <div class="col-md-6">
                        <h6 class="font-weight-bold text-secondary">Backend Tools</h6>
                        <div class="mb-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="bandit-switch" 
                                       {{ 'checked' if tools_config.backend.bandit else '' }}>
                                <label class="custom-control-label" for="bandit-switch">
                                    <strong>Bandit</strong>
                                    <small class="text-muted d-block">Python security linter</small>
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="safety-switch"
                                       {{ 'checked' if tools_config.backend.safety else '' }}>
                                <label class="custom-control-label" for="safety-switch">
                                    <strong>Safety</strong>
                                    <small class="text-muted d-block">Dependency vulnerability scanner</small>
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="semgrep-switch"
                                       {{ 'checked' if tools_config.backend.semgrep else '' }}>
                                <label class="custom-control-label" for="semgrep-switch">
                                    <strong>Semgrep</strong>
                                    <small class="text-muted d-block">Static analysis engine</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Frontend Tools -->
                    <div class="col-md-6">
                        <h6 class="font-weight-bold text-secondary">Frontend Tools</h6>
                        <div class="mb-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="eslint-switch"
                                       {{ 'checked' if tools_config.frontend.eslint else '' }}>
                                <label class="custom-control-label" for="eslint-switch">
                                    <strong>ESLint</strong>
                                    <small class="text-muted d-block">JavaScript linter</small>
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="npm-audit-switch"
                                       {{ 'checked' if tools_config.frontend.npm_audit else '' }}>
                                <label class="custom-control-label" for="npm-audit-switch">
                                    <strong>npm audit</strong>
                                    <small class="text-muted d-block">Dependency vulnerability scanner</small>
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="retire-switch"
                                       {{ 'checked' if tools_config.frontend.retire else '' }}>
                                <label class="custom-control-label" for="retire-switch">
                                    <strong>Retire.js</strong>
                                    <small class="text-muted d-block">JavaScript library scanner</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Analysis Panel -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-rocket"></i> Quick Analysis
                </h6>
            </div>
            <div class="card-body">
                <form hx-post="/analysis/quick" 
                      hx-target="#quick-analysis-results"
                      hx-indicator="#quick-analysis-loading">
                    
                    <div class="form-group">
                        <label for="model-select" class="font-weight-bold">Select Model</label>
                        <select class="form-control" id="model-select" name="model_slug" required>
                            <option value="">Choose a model...</option>
                            {% for model in available_models %}
                            <option value="{{ model.canonical_slug }}">{{ model.model_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="app-select" class="font-weight-bold">Select Application</label>
                        <select class="form-control" id="app-select" name="app_number" required>
                            <option value="">Choose an application...</option>
                            {% for i in range(1, 31) %}
                            <option value="{{ i }}">App {{ i }} - {{ app_types[i] }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Analysis Scope</label>
                        <div class="row">
                            <div class="col-6">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="backend-analysis" 
                                           name="scope" value="backend" checked>
                                    <label class="custom-control-label" for="backend-analysis">
                                        Backend Security
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="frontend-analysis" 
                                           name="scope" value="frontend" checked>
                                    <label class="custom-control-label" for="frontend-analysis">
                                        Frontend Security
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-play"></i> Start Analysis
                        <div id="quick-analysis-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                    </button>
                </form>

                <!-- Quick Analysis Results -->
                <div id="quick-analysis-results" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Recent Analysis Results -->
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history"></i> Recent Analysis Results
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary active" 
                            hx-get="/analysis/recent?filter=all"
                            hx-target="#recent-results-table">
                        All
                    </button>
                    <button type="button" class="btn btn-outline-secondary"
                            hx-get="/analysis/recent?filter=completed"
                            hx-target="#recent-results-table">
                        Completed
                    </button>
                    <button type="button" class="btn btn-outline-secondary"
                            hx-get="/analysis/recent?filter=running"
                            hx-target="#recent-results-table">
                        Running
                    </button>
                    <button type="button" class="btn btn-outline-secondary"
                            hx-get="/analysis/recent?filter=failed"
                            hx-target="#recent-results-table">
                        Failed
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <div id="recent-results-table"
                         hx-get="/analysis/recent"
                         hx-trigger="load, every 30s">
                        <!-- Results will be loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading recent analysis results...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tools Configuration Modal -->
<div class="modal fade" id="toolsConfigModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tools"></i> Configure Analysis Tools
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form hx-post="/analysis/tools/configure" 
                  hx-target="#tools-config-result"
                  hx-indicator="#config-loading">
                <div class="modal-body">
                    <div class="row">
                        <!-- Backend Tools Configuration -->
                        <div class="col-md-6">
                            <h6 class="font-weight-bold text-primary mb-3">Backend Analysis Tools</h6>
                            
                            <div class="card border-light mb-3">
                                <div class="card-body p-3">
                                    <div class="custom-control custom-switch mb-2">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="config-bandit" name="backend_tools" value="bandit">
                                        <label class="custom-control-label font-weight-bold" for="config-bandit">
                                            Bandit
                                        </label>
                                    </div>
                                    <p class="small text-muted mb-2">
                                        Security linter for Python code. Identifies common security issues.
                                    </p>
                                    <div class="form-group mb-0">
                                        <label class="small">Severity Level:</label>
                                        <select class="form-control form-control-sm" name="bandit_severity">
                                            <option value="low">Low and above</option>
                                            <option value="medium" selected>Medium and above</option>
                                            <option value="high">High only</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-light mb-3">
                                <div class="card-body p-3">
                                    <div class="custom-control custom-switch mb-2">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="config-safety" name="backend_tools" value="safety">
                                        <label class="custom-control-label font-weight-bold" for="config-safety">
                                            Safety
                                        </label>
                                    </div>
                                    <p class="small text-muted mb-2">
                                        Checks Python dependencies for known security vulnerabilities.
                                    </p>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="safety-full-report" name="safety_full_report">
                                        <label class="custom-control-label small" for="safety-full-report">
                                            Include full report
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Frontend Tools Configuration -->
                        <div class="col-md-6">
                            <h6 class="font-weight-bold text-primary mb-3">Frontend Analysis Tools</h6>
                            
                            <div class="card border-light mb-3">
                                <div class="card-body p-3">
                                    <div class="custom-control custom-switch mb-2">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="config-eslint" name="frontend_tools" value="eslint">
                                        <label class="custom-control-label font-weight-bold" for="config-eslint">
                                            ESLint
                                        </label>
                                    </div>
                                    <p class="small text-muted mb-2">
                                        JavaScript linter that identifies and reports patterns in code.
                                    </p>
                                    <div class="form-group mb-0">
                                        <label class="small">Rule Set:</label>
                                        <select class="form-control form-control-sm" name="eslint_rules">
                                            <option value="recommended">Recommended</option>
                                            <option value="security" selected>Security focused</option>
                                            <option value="all">All rules</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-light mb-3">
                                <div class="card-body p-3">
                                    <div class="custom-control custom-switch mb-2">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="config-npm-audit" name="frontend_tools" value="npm_audit">
                                        <label class="custom-control-label font-weight-bold" for="config-npm-audit">
                                            npm audit
                                        </label>
                                    </div>
                                    <p class="small text-muted mb-2">
                                        Scans npm dependencies for known vulnerabilities.
                                    </p>
                                    <div class="form-group mb-0">
                                        <label class="small">Audit Level:</label>
                                        <select class="form-control form-control-sm" name="npm_audit_level">
                                            <option value="moderate">Moderate and above</option>
                                            <option value="high" selected>High and above</option>
                                            <option value="critical">Critical only</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tools-config-result"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Configuration
                        <div id="config-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh running analyses
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.status === 200 && event.target.id === 'running-analyses') {
        const runningCount = parseInt(event.target.textContent);
        if (runningCount > 0) {
            // Refresh recent results more frequently if analyses are running
            htmx.trigger('#recent-results-table', 'refresh');
        }
    }
});

// Model selection handler for app filtering
document.getElementById('model-select').addEventListener('change', function() {
    const modelSlug = this.value;
    const appSelect = document.getElementById('app-select');
    
    if (modelSlug) {
        // Enable app selection
        appSelect.disabled = false;
        // Could add HTMX call to get available apps for this model
    } else {
        appSelect.disabled = true;
        appSelect.value = '';
    }
});
</script>
{% endblock %}
