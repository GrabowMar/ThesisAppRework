<script>
  // ===== State Management =====
  const statisticsState = {
    selectedGenerationRuns: new Set(),
    filters: {
      generationRuns: '',
      apps: '',
      security: '',
      securityStatus: '',
      performance: '',
      zap: '',
      ai: ''
    }
  };

  // ===== Utility Functions =====
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-dismiss after 4 seconds
    setTimeout(() => {
      notification.remove();
    }, 4000);
  }

  function exportTableToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = rows.map(row => {
      const cells = Array.from(row.querySelectorAll('th, td'));
      return cells.map(cell => {
        // Skip checkbox cells
        if (cell.querySelector('input[type="checkbox"]')) return '';
        const text = cell.textContent.trim().replace(/"/g, '""');
        return `"${text}"`;
      }).filter(Boolean).join(',');
    }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('CSV exported successfully', 'success');
  }

  function filterTable(tableId, filterValue) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr');
    const filter = filterValue.toLowerCase();
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? '' : 'none';
    });
  }

  // ===== Generation Runs Functions =====
  function selectAllGenerationRuns(checked) {
    const checkboxes = document.querySelectorAll('.generation-run-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = checked;
      const runId = cb.value;
      if (checked) {
        statisticsState.selectedGenerationRuns.add(runId);
      } else {
        statisticsState.selectedGenerationRuns.delete(runId);
      }
    });
    updateGenerationRunsSelection();
  }

  function updateGenerationRunsSelection() {
    const checkboxes = document.querySelectorAll('.generation-run-checkbox');
    statisticsState.selectedGenerationRuns.clear();
    
    checkboxes.forEach(cb => {
      if (cb.checked) {
        statisticsState.selectedGenerationRuns.add(cb.value);
      }
    });
    
    const count = statisticsState.selectedGenerationRuns.size;
    document.getElementById('generationRunsSelectedCount').textContent = `${count} selected`;
    
    // Enable/disable batch action buttons
    const hasSelection = count > 0;
    document.getElementById('btnExportGenerationRuns').disabled = !hasSelection;
    document.getElementById('btnCompareGenerationRuns').disabled = count < 2;
  }

  function exportSelectedGenerationRuns() {
    const selected = Array.from(statisticsState.selectedGenerationRuns);
    if (selected.length === 0) {
      showNotification('No generation runs selected', 'warning');
      return;
    }
    
    // Filter table to only selected rows, export, then restore
    const table = document.getElementById('generationRunsTable');
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const hiddenRows = [];
    
    rows.forEach(row => {
      const runId = row.dataset.runId;
      if (!selected.includes(runId)) {
        hiddenRows.push({ row, display: row.style.display });
        row.style.display = 'none';
      }
    });
    
    exportTableToCSV('generationRunsTable', `generation_runs_${new Date().toISOString().split('T')[0]}.csv`);
    
    // Restore hidden rows
    hiddenRows.forEach(({ row, display }) => {
      row.style.display = display;
    });
  }

  function compareSelectedGenerationRuns() {
    const selected = Array.from(statisticsState.selectedGenerationRuns);
    if (selected.length < 2) {
      showNotification('Select at least 2 generation runs to compare', 'warning');
      return;
    }
    
    // TODO: Navigate to comparison view or open modal
    showNotification(`Comparing ${selected.length} generation runs (feature coming soon)`, 'info');
  }

  function showGenerationDetails(runId) {
    // TODO: Show modal with detailed generation info
    showNotification(`Viewing details for run: ${runId} (feature coming soon)`, 'info');
  }

  // ===== Export Functions =====
  function refreshStatistics() {
    showNotification('Refreshing statistics...', 'info');
    window.location.reload();
  }

  function exportVisibleData() {
    exportTableToCSV('generationRunsTable', `all_generation_runs_${new Date().toISOString().split('T')[0]}.csv`);
  }

  function exportAppsTable() {
    exportTableToCSV('appsTable', `generated_apps_${new Date().toISOString().split('T')[0]}.csv`);
  }

  function exportSecurityTable() {
    exportTableToCSV('securityTable', `security_analyses_${new Date().toISOString().split('T')[0]}.csv`);
  }

  function exportPerformanceTable() {
    exportTableToCSV('performanceTable', `performance_tests_${new Date().toISOString().split('T')[0]}.csv`);
  }

  function exportZapTable() {
    exportTableToCSV('zapTable', `zap_analyses_${new Date().toISOString().split('T')[0]}.csv`);
  }

  function exportAiTable() {
    exportTableToCSV('aiTable', `ai_analyses_${new Date().toISOString().split('T')[0]}.csv`);
  }

  // ===== View Functions =====
  function viewAppsSummary() {
    showNotification('Opening apps summary (feature coming soon)', 'info');
  }

  function viewSecuritySummary() {
    showNotification('Opening security summary (feature coming soon)', 'info');
  }

  function viewPerformanceCharts() {
    showNotification('Opening performance charts (feature coming soon)', 'info');
  }

  function viewCostAnalysis() {
    showNotification('Opening cost analysis (feature coming soon)', 'info');
  }

  function filterSecurityTable() {
    const status = document.getElementById('filterSecurityStatus').value.toLowerCase();
    const table = document.getElementById('securityTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
      if (!status) {
        row.style.display = '';
        return;
      }
      const rowStatus = row.cells[2]?.textContent.toLowerCase() || '';
      row.style.display = rowStatus.includes(status) ? '' : 'none';
    });
  }

  // ===== Event Listeners =====
  document.addEventListener('DOMContentLoaded', function () {
    // Table hover effects
    document.querySelectorAll('[data-statistics-table]').forEach(function (table) {
      table.classList.add('table-hover');
    });

    // Code element click-to-copy
    document.querySelectorAll('.statistics-dashboard table code').forEach(function (codeEl) {
      codeEl.addEventListener('click', function () {
        const text = codeEl.textContent.trim();
        if (!text) return;
        
        navigator.clipboard?.writeText(text).then(function () {
          codeEl.classList.add('copied');
          setTimeout(function () {
            codeEl.classList.remove('copied');
          }, 1200);
          showNotification('Copied to clipboard', 'success');
        }).catch(function () {
          showNotification('Failed to copy to clipboard', 'error');
        });
      });
      codeEl.title = 'Click to copy path';
      codeEl.style.cursor = 'pointer';
    });

    // Search filters
    const filterInputs = [
      { id: 'filterGenerationRuns', tableId: 'generationRunsTable' },
      { id: 'filterApps', tableId: 'appsTable' },
      { id: 'filterSecurity', tableId: 'securityTable' },
      { id: 'filterPerformance', tableId: 'performanceTable' },
      { id: 'filterZap', tableId: 'zapTable' },
      { id: 'filterAi', tableId: 'aiTable' }
    ];

    filterInputs.forEach(({ id, tableId }) => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', (e) => {
          filterTable(tableId, e.target.value);
        });
      }
    });

    // Add sticky header styles
    const style = document.createElement('style');
    style.textContent = `
      .table-responsive {
        max-height: 600px;
        overflow-y: auto;
      }
      
      .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa;
      }
      
      .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
      }
      
      code.copied {
        background-color: #28a745 !important;
        color: white !important;
      }
      
      .cursor-pointer {
        cursor: pointer;
      }
    `;
    document.head.appendChild(style);
  });

  // ===== Statistics Wipe Functions =====
  function showWipeConfirmation() {
    const modal = new bootstrap.Modal(document.getElementById('wipeConfirmModal'));
    const confirmInput = document.getElementById('wipeConfirmInput');
    const confirmBtn = document.getElementById('wipeConfirmBtn');
    
    // Reset input and button
    confirmInput.value = '';
    confirmBtn.disabled = true;
    
    // Enable button only when correct text is entered
    confirmInput.addEventListener('input', function() {
      if (this.value === 'WIPE STATISTICS') {
        confirmBtn.disabled = false;
      } else {
        confirmBtn.disabled = true;
      }
    });
    
    modal.show();
  }

  function executeWipeStatistics() {
    const confirmInput = document.getElementById('wipeConfirmInput');
    const confirmBtn = document.getElementById('wipeConfirmBtn');
    
    // Validate confirmation text
    if (confirmInput.value !== 'WIPE STATISTICS') {
      showNotification('Please type the confirmation text exactly as shown', 'warning');
      return;
    }
    
    // Disable button and show loading state
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Wiping...';
    
    // Make API call
    fetch('/api/dashboard/statistics/wipe', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || `HTTP ${response.status}`);
        });
      }
      return response.json();
    })
    .then(data => {
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('wipeConfirmModal'));
      modal.hide();
      
      // Show success message
      showNotification(
        `Successfully wiped ${data.data.deleted_count || 0} statistics records from database!`,
        'success'
      );
      
      // Refresh the page after a short delay
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    })
    .catch(error => {
      console.error('Failed to wipe statistics:', error);
      showNotification(`Failed to wipe statistics: ${error.message}`, 'danger');
      
      // Reset button
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fa-solid fa-trash-can me-1"></i> Wipe All Statistics';
    });
  }
</script>
