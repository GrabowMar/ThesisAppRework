<div class="container-fluid py-4 statistics-dashboard">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="h3 mb-0">Statistics Dashboard</h1>
      <p class="text-muted mb-0">Live view of generated applications, analyzer runs, and on-disk artifacts.</p>
    </div>
    <div class="btn-group" role="group">
      {% if generation_download_url %}
        <a class="btn btn-primary" href="{{ generation_download_url }}" title="Download full JSON summary">
          <i class="fa-solid fa-download me-1"></i>
          Download Summary
        </a>
      {% endif %}
      <button class="btn btn-outline-primary" onclick="refreshStatistics()" title="Refresh all statistics">
        <i class="fa-solid fa-sync me-1"></i>
        Refresh
      </button>
      <button class="btn btn-outline-secondary" onclick="exportVisibleData()" title="Export visible table data">
        <i class="fa-solid fa-file-csv me-1"></i>
        Export CSV
      </button>
      <button class="btn btn-outline-danger" onclick="showWipeConfirmation()" title="Wipe all statistics from database">
        <i class="fa-solid fa-trash-can me-1"></i>
        Wipe Statistics
      </button>
    </div>
  </div>

  <!-- Wipe Confirmation Modal -->
  <div class="modal fade" id="wipeConfirmModal" tabindex="-1" aria-labelledby="wipeConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="wipeConfirmModalLabel">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            Confirm Statistics Wipe
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-3">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action cannot be undone!
          </div>
          <p class="mb-3">You are about to permanently delete all statistics records from the database:</p>
          <ul class="mb-3">
            <li><strong>Security Analyses</strong> - All security scan results</li>
            <li><strong>Performance Tests</strong> - All performance test results</li>
            <li><strong>ZAP Analyses</strong> - All OWASP ZAP scan results</li>
            <li><strong>AI Analyses</strong> - All OpenRouter analysis results</li>
            <li><strong>Analysis Tasks</strong> - All task records</li>
            <li><strong>Analysis Results</strong> - All cached analysis results</li>
          </ul>
          <p class="text-muted mb-0"><small>Note: Generated applications will NOT be deleted. Only their associated analysis records will be removed.</small></p>
          <div class="mt-3">
            <label for="wipeConfirmInput" class="form-label fw-semibold">Type <code>WIPE STATISTICS</code> to confirm:</label>
            <input type="text" class="form-control" id="wipeConfirmInput" placeholder="WIPE STATISTICS" autocomplete="off">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="wipeConfirmBtn" onclick="executeWipeStatistics()" disabled>
            <i class="fa-solid fa-trash-can me-1"></i>
            Wipe All Statistics
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Generation Runs</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.total_runs or 0 }}</p>
          <p class="mb-0 text-muted">Total runs indexed from filesystem artifacts.</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Successful Runs</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.successful_runs or 0 }}</p>
          <p class="mb-0 text-muted">{{ generation_summary.success_rate or 0 }}% success rate.</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Lines of Code</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.total_lines_generated or 0 }}</p>
          <p class="mb-0 text-muted">{{ "%.1f"|format(generation_summary.avg_lines_per_generation or 0) }} avg per generation.</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Security Issues</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.total_security_issues or 0 }}</p>
          <p class="mb-0 text-muted">High-severity findings across all apps.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Requirements Compliance</h2>
          <p class="display-5 fw-semibold mb-1">{{ "%.1f"|format(generation_summary.requirements_compliance_rate or 0) }}%</p>
          <p class="mb-0 text-muted">{{ generation_summary.requirements_met or 0 }}/{{ generation_summary.requirements_total or 0 }} requirements met.</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Total Tokens</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.total_tokens_used or 0 }}</p>
          <p class="mb-0 text-muted">{{ "%.0f"|format(generation_summary.avg_tokens_per_generation or 0) }} avg per generation.</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Avg Duration</h2>
          <p class="display-5 fw-semibold mb-1">{{ "%.2f"|format(generation_summary.avg_duration or 0) }}s</p>
          <p class="mb-0 text-muted">Average generation time per run.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- OpenRouter & Cost Metrics -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Total Cost</h2>
          <p class="display-5 fw-semibold mb-1">${{ "%.4f"|format(generation_summary.total_cost or 0) }}</p>
          <p class="mb-0 text-muted">${{ "%.4f"|format(generation_summary.avg_cost_per_generation or 0) }} avg per generation.</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Avg Generation Time</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.avg_generation_time_ms or 0 }}ms</p>
          <p class="mb-0 text-muted">Inference time (provider-side).</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Avg Native Tokens</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.avg_native_tokens_prompt or 0 }} / {{ generation_summary.avg_native_tokens_completion or 0 }}</p>
          <p class="mb-0 text-muted">Prompt / Completion (native tokenization).</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="card-title h6 text-uppercase text-muted">Providers Used</h2>
          <p class="display-5 fw-semibold mb-1">{{ generation_summary.by_provider|length or 0 }}</p>
          <p class="mb-0 text-muted">
            {% if generation_summary.by_provider %}
              {% for provider in generation_summary.by_provider.keys() %}
                <span class="badge bg-light text-dark me-1">{{ provider }}</span>
              {% endfor %}
            {% else %}
              No providers tracked yet.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Statistics -->
  {% if generation_summary.task_stats %}
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="card-title h6 mb-0">Analysis Task Statistics</h2>
          <span class="badge bg-secondary">{{ generation_summary.task_stats.total_tasks or 0 }} tasks</span>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-3">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-muted">Success Rate</h3>
                <p class="display-6 fw-semibold mb-0">{{ "%.1f"|format(generation_summary.task_stats.success_rate or 0) }}%</p>
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-muted">Avg Duration</h3>
                <p class="display-6 fw-semibold mb-0">{{ "%.2f"|format(generation_summary.task_stats.avg_duration or 0) }}s</p>
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-muted">Total Issues</h3>
                <p class="display-6 fw-semibold mb-0">{{ generation_summary.task_stats.total_issues_found or 0 }}</p>
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-muted">By Status</h3>
                <p class="small mb-0">
                  {% for status, count in generation_summary.task_stats.by_status.items() %}
                    <span class="badge bg-light text-dark me-1">{{ status }}: {{ count }}</span>
                  {% endfor %}
                </p>
              </div>
            </div>
          </div>
          {% if generation_summary.task_stats.by_type %}
          <div class="mt-3">
            <h3 class="h6 text-muted mb-2">By Analysis Type</h3>
            <div>
              {% for type, count in generation_summary.task_stats.by_type.items() %}
                <span class="badge bg-info me-1 mb-1">{{ type }}: {{ count }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="card-title h6 mb-0">Runs by Model</h2>
          <span class="badge bg-secondary">{{ generation_summary.by_model|length or 0 }} models</span>
        </div>
        <div class="card-body">
          {% if generation_summary.by_model %}
            <ul class="list-group list-group-flush">
              {% for model, count in generation_summary.by_model|dictsort %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span class="text-truncate" title="{{ model }}">{{ model }}</span>
                  <span class="badge bg-primary rounded-pill">{{ count }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No generation runs captured yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="card-title h6 mb-0">Runs by Component</h2>
          <span class="badge bg-secondary">{{ generation_summary.by_component|length or 0 }} components</span>
        </div>
        <div class="card-body">
          {% if generation_summary.by_component %}
            <ul class="list-group list-group-flush">
              {% for component, count in generation_summary.by_component|dictsort %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span class="text-truncate" title="{{ component }}">{{ component }}</span>
                  <span class="badge bg-info rounded-pill">{{ count }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No component breakdown available.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="card-title h6 mb-0">Filesystem Snapshots</h2>
        </div>
        <div class="card-body">
          <dl class="row mb-0 small">
            <dt class="col-7">Raw payload files</dt>
            <dd class="col-5 text-end">{{ filesystem_metrics.raw_payload_files or 0 }}</dd>
            <dt class="col-7">Raw response files</dt>
            <dd class="col-5 text-end">{{ filesystem_metrics.raw_response_files or 0 }}</dd>
            <dt class="col-7">Markdown summaries</dt>
            <dd class="col-5 text-end">{{ filesystem_metrics.markdown_files or 0 }}</dd>
            <dt class="col-7">App directories</dt>
            <dd class="col-5 text-end">{{ filesystem_metrics.app_directories or 0 }}</dd>
          </dl>
          {% if generation_summary_path %}
            <p class="text-muted mt-3 mb-0 small">Summary stored at <code>{{ generation_summary_path }}</code>.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="card-title h6 mb-0">Application Stats</h2>
        </div>
        <div class="card-body">
          <p class="fs-4 fw-semibold mb-1">{{ application_stats.total or 0 }}</p>
          <p class="text-muted small">Generated applications tracked in the database.</p>
          <dl class="row mb-0 small">
            <dt class="col-7">Last 7 days</dt>
            <dd class="col-5 text-end">{{ application_stats.recent_count or 0 }}</dd>
            <dt class="col-7">By status</dt>
            <dd class="col-5 text-end">
              {% if application_stats.by_status %}
                {% for status in application_stats.by_status %}
                  <span class="badge bg-light text-dark me-1 mb-1">{{ status.status or 'unknown' }}: {{ status.count }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </dd>
            <dt class="col-7">By type</dt>
            <dd class="col-5 text-end">
              {% if application_stats.by_type %}
                {% for row in application_stats.by_type %}
                  <span class="badge bg-light text-dark me-1 mb-1">{{ row.type or 'unknown' }}: {{ row.count }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="card-title h6 mb-0">Model &amp; Analysis Snapshot</h2>
        </div>
        <div class="card-body">
          <p class="fw-semibold mb-2">Models indexed: {{ model_stats.total or 0 }}</p>
          <div class="small mb-3">
            {% if model_stats.by_provider %}
              {% for row in model_stats.by_provider %}
                <span class="badge bg-secondary me-1 mb-1">{{ row.provider or 'unknown' }}: {{ row.count }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted">No model data recorded.</span>
            {% endif %}
          </div>
          <div class="border-top pt-2 small">
            <strong>Analysis</strong>
            <div class="mt-2">
              <span class="badge bg-success me-1 mb-1">Security: {{ analysis_stats.security.total or 0 }}</span>
              <span class="badge bg-light text-success me-1 mb-1">Completed {{ analysis_stats.security.success_rate or 0 }}%</span>
            </div>
            <div>
              <span class="badge bg-info me-1 mb-1">Performance: {{ analysis_stats.performance.total or 0 }}</span>
              <span class="badge bg-light text-info me-1 mb-1">Completed {{ analysis_stats.performance.success_rate or 0 }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="card-title h6 mb-0">Last 24 Hours</h2>
        </div>
        <div class="card-body">
          {% if recent_stats.last_24h %}
            <dl class="row mb-0 small">
              <dt class="col-7">Applications</dt>
              <dd class="col-5 text-end">{{ recent_stats.last_24h.applications or 0 }}</dd>
              <dt class="col-7">Security analyses</dt>
              <dd class="col-5 text-end">{{ recent_stats.last_24h.security_analyses or 0 }}</dd>
              <dt class="col-7">Performance tests</dt>
              <dd class="col-5 text-end">{{ recent_stats.last_24h.performance_tests or 0 }}</dd>
            </dl>
          {% else %}
            <p class="text-muted mb-0">No recent activity captured.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="card-title h6 mb-0">Popular Models (7 days)</h2>
        </div>
        <div class="card-body">
          {% if recent_stats.popular_models %}
            <ul class="list-group list-group-flush">
              {% for entry in recent_stats.popular_models %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span class="text-truncate" title="{{ entry.model_slug }}">{{ entry.model_slug }}</span>
                  <span class="badge bg-primary rounded-pill">{{ entry.usage_count }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No trending models identified.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <section class="mb-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h2 class="card-title h6 mb-0"><i class="fa-solid fa-table me-2"></i>Generation Runs</h2>
            <small class="text-muted">Detailed view of individual generation metadata with code metrics and analysis results.</small>
          </div>
          <span class="badge bg-secondary">{{ generation_rows|length }} records</span>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
            <input type="text" class="form-control" id="filterGenerationRuns" placeholder="Search runs...">
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-secondary" onclick="selectAllGenerationRuns(true)">
              <i class="fa-solid fa-check-square me-1"></i>Select All
            </button>
            <button class="btn btn-outline-secondary" onclick="selectAllGenerationRuns(false)">
              <i class="fa-solid fa-square me-1"></i>Clear
            </button>
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="exportSelectedGenerationRuns()" disabled id="btnExportGenerationRuns">
              <i class="fa-solid fa-file-csv me-1"></i>Export Selected
            </button>
            <button class="btn btn-outline-info" onclick="compareSelectedGenerationRuns()" disabled id="btnCompareGenerationRuns">
              <i class="fa-solid fa-code-compare me-1"></i>Compare
            </button>
          </div>
          <small class="text-muted ms-auto" id="generationRunsSelectedCount">0 selected</small>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if generation_rows %}
          <table class="table table-sm table-striped align-middle mb-0 table-hover" data-statistics-table id="generationRunsTable">
            <thead class="table-light sticky-top">
              <tr>
                <th scope="col" class="text-center" style="width: 40px;">
                  <input type="checkbox" class="form-check-input" id="selectAllGenRuns" onchange="selectAllGenerationRuns(this.checked)">
                </th>
                <th scope="col">Run ID</th>
                <th scope="col">Timestamp</th>
                <th scope="col">Model</th>
                <th scope="col">Provider</th>
                <th scope="col">Component</th>
                <th scope="col">App #</th>
                <th scope="col">Success</th>
                <th scope="col">Duration (s)</th>
                <th scope="col">Gen Time (ms)</th>
                <th scope="col">Lines</th>
                <th scope="col">Files</th>
                <th scope="col">Languages</th>
                <th scope="col">Tokens (API)</th>
                <th scope="col">Tokens (Native)</th>
                <th scope="col">Cost (USD)</th>
                <th scope="col">Security</th>
                <th scope="col">Requirements</th>
                <th scope="col">Analysis</th>
                <th scope="col">Finish</th>
              </tr>
            </thead>
            <tbody>
              {% for row in generation_rows %}
                <tr data-run-id="{{ row.run_id }}" class="generation-run-row">
                  <td class="text-center">
                    <input type="checkbox" class="form-check-input generation-run-checkbox" value="{{ row.run_id }}" onchange="updateGenerationRunsSelection()">
                  </td>
                  <td class="text-nowrap small" title="{{ row.generation_id }}">
                    <a href="#" onclick="showGenerationDetails('{{ row.run_id }}'); return false;" class="text-decoration-none">
                      {{ row.run_id[:12] }}...
                    </a>
                  </td>
                  <td class="text-nowrap">{{ row.timestamp[:19] if row.timestamp else '&mdash;' }}</td>
                  <td class="text-truncate" style="max-width: 150px;" title="{{ row.model_used or row.model }}">
                    {{ (row.model_used or row.model)[:30] }}
                  </td>
                  <td>
                    {% if row.provider_name %}
                      <span class="badge bg-light text-dark">{{ row.provider_name }}</span>
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td>{{ row.component or '&mdash;' }}</td>
                  <td>{{ row.app_num or '&mdash;' }}</td>
                  <td>
                    {% if row.success %}
                      <span class="badge bg-success">Yes</span>
                    {% elif row.success is not none %}
                      <span class="badge bg-danger">No</span>
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  </td>
                  <td>{{ "%.2f"|format(row.duration) if row.duration else '—' }}</td>
                  <td>
                    {% if row.generation_time_ms %}
                      <span class="badge bg-info">{{ row.generation_time_ms }}</span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>{{ row.total_lines or '—' }}</td>
                  <td>{{ row.total_files or '—' }}</td>
                  <td class="small text-truncate" style="max-width: 120px;" title="{{ row.lines_by_language|tojson if row.lines_by_language else '' }}">
                    {% if row.lines_by_language %}
                      {% for lang, count in row.lines_by_language.items() %}
                        <span class="badge bg-light text-dark me-1">{{ lang }}: {{ count }}</span>
                      {% endfor %}
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if row.total_tokens %}
                      <strong>{{ row.total_tokens }}</strong>
                      <div class="text-muted">p:{{ row.prompt_tokens or 0 }} c:{{ row.completion_tokens or 0 }}</div>
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if row.native_tokens_prompt and row.native_tokens_completion %}
                      <div>p:{{ row.native_tokens_prompt }}</div>
                      <div>c:{{ row.native_tokens_completion }}</div>
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if row.estimated_cost %}
                      <strong>${{ "%.4f"|format(row.estimated_cost) }}</strong>
                      <div class="text-muted">p:${{ "%.4f"|format(row.prompt_cost or 0) }}</div>
                      <div class="text-muted">c:${{ "%.4f"|format(row.completion_cost or 0) }}</div>
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td>
                    {% if row.security_issues %}
                      <span class="badge bg-danger">{{ row.security_issues }} issues</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if row.requirements_total %}
                      <div><strong>{{ row.requirements_met }}/{{ row.requirements_total }}</strong></div>
                      <div class="text-muted">{{ "%.0f"|format(100 * row.requirements_met / row.requirements_total) }}%</div>
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if row.analysis_findings %}
                      {% if row.analysis_findings.static_findings %}<div>Static: {{ row.analysis_findings.static_findings }}</div>{% endif %}
                      {% if row.analysis_findings.dynamic_findings %}<div>Dynamic: {{ row.analysis_findings.dynamic_findings }}</div>{% endif %}
                      {% if row.analysis_findings.ai_findings %}<div>AI: {{ row.analysis_findings.ai_findings }}</div>{% endif %}
                      {% if row.analysis_findings.tools_used %}
                        <div class="text-muted" title="{{ row.analysis_findings.tools_used|join(', ') }}">
                          {{ row.analysis_findings.tools_used|length }} tools
                        </div>
                      {% endif %}
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                  <td>{{ row.finish_reason or '&mdash;' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mb-0">No generation runs have been indexed yet.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h2 class="card-title h6 mb-0"><i class="fa-solid fa-cube me-2"></i>Generated Applications</h2>
            <small class="text-muted">Latest {{ generated_apps|length }} records from the database.</small>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
            <input type="text" class="form-control" id="filterApps" placeholder="Search apps...">
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="exportAppsTable()">
              <i class="fa-solid fa-file-csv me-1"></i>Export
            </button>
            <button class="btn btn-outline-info" onclick="viewAppsSummary()">
              <i class="fa-solid fa-chart-bar me-1"></i>Summary
            </button>
          </div>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if generated_apps %}
          <table class="table table-sm table-striped align-middle mb-0 table-hover" data-statistics-table id="appsTable">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>Model</th>
                <th>App #</th>
                <th>Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Updated</th>
                <th>Metadata</th>
              </tr>
            </thead>
            <tbody>
              {% for app in generated_apps %}
                <tr class="cursor-pointer" onclick="window.location='/applications/{{ app.model_slug }}/{{ app.app_number }}'" style="cursor: pointer;">
                  <td>
                    <a href="/applications/{{ app.model_slug }}/{{ app.app_number }}" class="text-decoration-none" onclick="event.stopPropagation()">
                      {{ app.id }}
                    </a>
                  </td>
                  <td>{{ app.model_slug }}</td>
                  <td>{{ app.app_number or '&mdash;' }}</td>
                  <td>{{ app.app_type or '&mdash;' }}</td>
                  <td>{{ app.generation_status or '&mdash;' }}</td>
                  <td class="text-nowrap">{{ app.created_at or '&mdash;' }}</td>
                  <td class="text-nowrap">{{ app.updated_at or '&mdash;' }}</td>
                  <td class="small text-truncate" style="max-width: 240px;" title="{{ app.metadata_preview }}">
                    {{ app.metadata_preview or '&mdash;' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mb-0">No applications found.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="card-title h6 mb-0"><i class="fa-solid fa-shield-alt me-2"></i>Security Analyses</h2>
          <span class="badge bg-secondary">{{ security_analyses|length }} records</span>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
            <input type="text" class="form-control" id="filterSecurity" placeholder="Search analyses...">
          </div>
          <select class="form-select form-select-sm" id="filterSecurityStatus" style="max-width: 150px;" onchange="filterSecurityTable()">
            <option value="">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="running">Running</option>
            <option value="failed">Failed</option>
          </select>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="exportSecurityTable()">
              <i class="fa-solid fa-file-csv me-1"></i>Export
            </button>
            <button class="btn btn-outline-danger" onclick="viewSecuritySummary()">
              <i class="fa-solid fa-chart-pie me-1"></i>Summary
            </button>
          </div>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if security_analyses %}
          <table class="table table-sm table-striped align-middle mb-0" data-statistics-table>
            <thead>
              <tr>
                <th>ID</th>
                <th>App</th>
                <th>Status</th>
                <th>Issues</th>
                <th>Tools</th>
                <th>Created</th>
                <th>Completed</th>
                <th>Metadata</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in security_analyses %}
                <tr>
                  <td>{{ entry.id }}</td>
                  <td>{{ entry.application_id }}</td>
                  <td>{{ entry.status or '&mdash;' }}</td>
                  <td>
                    <span class="badge bg-danger me-1">C {{ entry.critical or 0 }}</span>
                    <span class="badge bg-warning text-dark me-1">H {{ entry.high or 0 }}</span>
                    <span class="badge bg-secondary me-1">M {{ entry.medium or 0 }}</span>
                    <span class="badge bg-light text-dark">L {{ entry.low or 0 }}</span>
                  </td>
                  <td class="small text-truncate" style="max-width: 200px;" title="{{ entry.enabled_tools|join(', ') }}">
                    {{ entry.enabled_tools|join(', ') or '—' }}
                  </td>
                  <td class="text-nowrap">{{ entry.created_at or '&mdash;' }}</td>
                  <td class="text-nowrap">{{ entry.completed_at or '&mdash;' }}</td>
                  <td class="small text-truncate" style="max-width: 200px;" title="{{ entry.metadata_preview }}">
                    {{ entry.metadata_preview or '&mdash;' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mb-0">No security analyses have been recorded.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="card-title h6 mb-0"><i class="fa-solid fa-tachometer-alt me-2"></i>Performance Tests</h2>
          <span class="badge bg-secondary">{{ performance_tests|length }} records</span>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
            <input type="text" class="form-control" id="filterPerformance" placeholder="Search tests...">
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="exportPerformanceTable()">
              <i class="fa-solid fa-file-csv me-1"></i>Export
            </button>
            <button class="btn btn-outline-info" onclick="viewPerformanceCharts()">
              <i class="fa-solid fa-chart-line me-1"></i>Charts
            </button>
          </div>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if performance_tests %}
          <table class="table table-sm table-striped align-middle mb-0 table-hover" data-statistics-table id="performanceTable">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>App</th>
                <th>Status</th>
                <th>Users</th>
                <th>RPS</th>
                <th>Response (avg/p95)</th>
                <th>Error %</th>
                <th>Created</th>
                <th>Metadata</th>
              </tr>
            </thead>
            <tbody>
              {% for test in performance_tests %}
                <tr>
                  <td>{{ test.id }}</td>
                  <td>{{ test.application_id }}</td>
                  <td>{{ test.status or '&mdash;' }}</td>
                  <td>{{ test.users or '&mdash;' }}</td>
                  <td>{{ test.requests_per_second or '&mdash;' }}</td>
                  <td>
                    {{ test.average_response_time or '&mdash;' }} / {{ test.p95_response_time or '&mdash;' }}
                  </td>
                  <td>{{ test.error_rate or '&mdash;' }}</td>
                  <td class="text-nowrap">{{ test.created_at or '&mdash;' }}</td>
                  <td class="small text-truncate" style="max-width: 200px;" title="{{ test.metadata_preview }}">
                    {{ test.metadata_preview or '&mdash;' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mb-0">No performance tests have been recorded.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="card-title h6 mb-0"><i class="fa-solid fa-shield-virus me-2"></i>OWASP ZAP Analyses</h2>
          <span class="badge bg-secondary">{{ zap_analyses|length }} records</span>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
            <input type="text" class="form-control" id="filterZap" placeholder="Search ZAP scans...">
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="exportZapTable()">
              <i class="fa-solid fa-file-csv me-1"></i>Export
            </button>
          </div>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if zap_analyses %}
          <table class="table table-sm table-striped align-middle mb-0 table-hover" data-statistics-table id="zapTable">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>App</th>
                <th>Status</th>
                <th>Scan Type</th>
                <th>Alerts (H/M/L/I)</th>
                <th>Target</th>
                <th>Completed</th>
                <th>Metadata</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in zap_analyses %}
                <tr>
                  <td>{{ entry.id }}</td>
                  <td>{{ entry.application_id }}</td>
                  <td>{{ entry.status or '&mdash;' }}</td>
                  <td>{{ entry.scan_type or '&mdash;' }}</td>
                  <td>
                    {{ entry.high_risk_alerts or 0 }}/{{ entry.medium_risk_alerts or 0 }}/{{ entry.low_risk_alerts or 0 }}/{{ entry.informational_alerts or 0 }}
                  </td>
                  <td class="text-truncate" style="max-width: 220px;" title="{{ entry.target_url }}">{{ entry.target_url or '&mdash;' }}</td>
                  <td class="text-nowrap">{{ entry.completed_at or '&mdash;' }}</td>
                  <td class="small text-truncate" style="max-width: 200px;" title="{{ entry.metadata_preview }}">
                    {{ entry.metadata_preview or '&mdash;' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mb-0">No ZAP analyses found.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="card-title h6 mb-0"><i class="fa-solid fa-robot me-2"></i>AI Analyzer (OpenRouter)</h2>
          <span class="badge bg-secondary">{{ openrouter_analyses|length }} records</span>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
            <input type="text" class="form-control" id="filterAi" placeholder="Search AI analyses...">
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="exportAiTable()">
              <i class="fa-solid fa-file-csv me-1"></i>Export
            </button>
            <button class="btn btn-outline-success" onclick="viewCostAnalysis()">
              <i class="fa-solid fa-dollar-sign me-1"></i>Cost Analysis
            </button>
          </div>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if openrouter_analyses %}
          <table class="table table-sm table-striped align-middle mb-0" data-statistics-table>
            <thead>
              <tr>
                <th>ID</th>
                <th>App</th>
                <th>Status</th>
                <th>Model</th>
                <th>Score</th>
                <th>Tokens (in/out)</th>
                <th>Cost (USD)</th>
                <th>Completed</th>
                <th>Summary</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in openrouter_analyses %}
                <tr>
                  <td>{{ entry.id }}</td>
                  <td>{{ entry.application_id }}</td>
                  <td>{{ entry.status or '&mdash;' }}</td>
                  <td>{{ entry.analyzer_model or '&mdash;' }}</td>
                  <td>{{ entry.overall_score or '&mdash;' }}</td>
                  <td>{{ entry.input_tokens or 0 }} / {{ entry.output_tokens or 0 }}</td>
                  <td>{{ entry.cost_usd or '&mdash;' }}</td>
                  <td class="text-nowrap">{{ entry.completed_at or '&mdash;' }}</td>
                  <td class="small text-truncate" style="max-width: 220px;" title="{{ entry.summary_preview }}">
                    {{ entry.summary_preview or '&mdash;' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mb-0">No AI analyzer runs recorded.</p>
        {% endif %}
      </div>
    </div>
  </section>
</div>
