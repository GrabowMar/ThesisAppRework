{# Statistics Dashboard - Big Picture Overview #}
{# Supplements detailed reports with aggregate metrics and trends #}

  {# System Health Banner #}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card" id="healthBanner">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-auto">
              <span class="status-dot status-dot-animated bg-{{ 'success' if health.overall_status == 'healthy' else 'warning' if health.overall_status == 'degraded' else 'danger' }}"></span>
            </div>
            <div class="col">
              <div class="d-flex align-items-center">
                <span class="h4 mb-0 me-3">System Status: 
                  <strong class="text-{{ 'success' if health.overall_status == 'healthy' else 'warning' if health.overall_status == 'degraded' else 'danger' }}">
                    {{ health.overall_status|title }}
                  </strong>
                </span>
                <span class="badge bg-blue-lt me-2">{{ health.services_up }}/{{ health.services_total }} Services</span>
                {% if health.queue_depth > 0 %}
                <span class="badge bg-yellow-lt">{{ health.queue_depth }} Queued</span>
                {% endif %}
              </div>
            </div>
            <div class="col-auto">
              <span class="text-muted">Last check: <span id="lastCheck">just now</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Main KPI Cards Row #}
  <div class="row row-deck row-cards mb-4">
    {# Total Analyses Card #}
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Total Analyses</div>
            <div class="ms-auto lh-1">
              <span class="text-green d-inline-flex align-items-center lh-1">
                {{ overview.completed_count }} completed
              </span>
            </div>
          </div>
          <div class="h1 mb-3">{{ overview.total_tasks }}</div>
          <div class="d-flex mb-2">
            <div>Success Rate</div>
            <div class="ms-auto">
              <span class="text-green">{{ "%.1f"|format(overview.success_rate) }}%</span>
            </div>
          </div>
          <div class="progress progress-sm">
            <div class="progress-bar bg-green" style="width: {{ overview.success_rate }}%"></div>
          </div>
        </div>
      </div>
    </div>

    {# Apps Analyzed Card #}
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Applications</div>
            <div class="ms-auto lh-1">
              <span class="text-blue d-inline-flex align-items-center lh-1">
                {{ overview.unique_models }} models
              </span>
            </div>
          </div>
          <div class="h1 mb-3">{{ overview.unique_apps }}</div>
          <div class="d-flex mb-2">
            <div>With Results</div>
            <div class="ms-auto">
              <span class="text-blue">{{ filesystem.apps_with_results }}</span>
            </div>
          </div>
          <div class="progress progress-sm">
            <div class="progress-bar bg-blue" style="width: {{ (filesystem.apps_with_results / overview.unique_apps * 100) if overview.unique_apps > 0 else 0 }}%"></div>
          </div>
        </div>
      </div>
    </div>

    {# Findings Card #}
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Total Findings</div>
            <div class="ms-auto lh-1">
              {% if severity.critical > 0 %}
              <span class="text-red d-inline-flex align-items-center lh-1">
                {{ severity.critical }} critical
              </span>
              {% else %}
              <span class="text-green d-inline-flex align-items-center lh-1">
                No critical
              </span>
              {% endif %}
            </div>
          </div>
          <div class="h1 mb-3">{{ severity.total }}</div>
          <div class="d-flex mb-2">
            <div>High Severity</div>
            <div class="ms-auto">
              <span class="text-orange">{{ severity.high }}</span>
            </div>
          </div>
          <div class="progress progress-sm">
            <div class="progress-bar bg-red" style="width: {{ (severity.critical / severity.total * 100) if severity.total > 0 else 0 }}%"></div>
            <div class="progress-bar bg-orange" style="width: {{ (severity.high / severity.total * 100) if severity.total > 0 else 0 }}%"></div>
            <div class="progress-bar bg-yellow" style="width: {{ (severity.medium / severity.total * 100) if severity.total > 0 else 0 }}%"></div>
          </div>
        </div>
      </div>
    </div>

    {# Avg Analysis Time Card #}
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Avg Analysis Time</div>
            <div class="ms-auto lh-1">
              <span class="text-muted d-inline-flex align-items-center lh-1">
                per run
              </span>
            </div>
          </div>
          <div class="h1 mb-3">{{ "%.1f"|format(overview.avg_duration_seconds) }}s</div>
          <div class="d-flex mb-2">
            <div>Active Now</div>
            <div class="ms-auto">
              <span class="text-azure">{{ overview.running_count }}</span>
            </div>
          </div>
          <div class="progress progress-sm">
            <div class="progress-bar bg-azure progress-bar-indeterminate" style="width: {{ 100 if overview.running_count > 0 else 0 }}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Charts Row #}
  <div class="row row-deck row-cards mb-4">
    {# Trends Chart #}
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Analysis Trends (Last 30 Days)</h3>
        </div>
        <div class="card-body">
          <div id="trendsChart" style="height: 300px;"></div>
        </div>
      </div>
    </div>

    {# Severity Distribution #}
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Severity Distribution</h3>
        </div>
        <div class="card-body">
          <div id="severityChart" style="height: 300px;"></div>
        </div>
      </div>
    </div>
  </div>

  {# Model Comparison & Tool Effectiveness #}
  <div class="row row-deck row-cards mb-4">
    {# Model Comparison Table #}
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Model Comparison</h3>
          <div class="card-actions">
            <a href="{{ url_for('reports.reports_index') }}" class="btn btn-sm btn-outline-primary">
              Full Report →
            </a>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table">
            <thead>
              <tr>
                <th>Model</th>
                <th class="text-center">Apps</th>
                <th class="text-center">Analyses</th>
                <th class="text-center">Findings</th>
                <th class="text-center">Avg Score</th>
              </tr>
            </thead>
            <tbody>
              {% for model in models[:5] %}
              <tr>
                <td>
                  <div class="text-truncate" style="max-width: 150px;" title="{{ model.model }}">
                    {{ model.model }}
                  </div>
                </td>
                <td class="text-center">{{ model.app_count }}</td>
                <td class="text-center">{{ model.analysis_count }}</td>
                <td class="text-center">
                  <span class="badge bg-{{ 'red' if model.total_findings > 50 else 'orange' if model.total_findings > 20 else 'green' }}-lt">
                    {{ model.total_findings }}
                  </span>
                </td>
                <td class="text-center">
                  {% if model.avg_score %}
                  <span class="badge bg-{{ 'green' if model.avg_score >= 80 else 'yellow' if model.avg_score >= 60 else 'red' }}-lt">
                    {{ "%.0f"|format(model.avg_score) }}
                  </span>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted">No model data available</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {# Tool Effectiveness #}
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Tool Effectiveness</h3>
          <div class="card-actions">
            <a href="{{ url_for('reports.reports_index') }}" class="btn btn-sm btn-outline-primary">
              Full Report →
            </a>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table">
            <thead>
              <tr>
                <th>Tool</th>
                <th class="text-center">Runs</th>
                <th class="text-center">Findings</th>
                <th class="text-center">Avg/Run</th>
                <th class="text-center">Success</th>
              </tr>
            </thead>
            <tbody>
              {% for tool in tools[:5] %}
              <tr>
                <td>
                  <span class="badge bg-azure-lt">{{ tool.tool }}</span>
                </td>
                <td class="text-center">{{ tool.run_count }}</td>
                <td class="text-center">{{ tool.total_findings }}</td>
                <td class="text-center">{{ "%.1f"|format(tool.avg_findings) }}</td>
                <td class="text-center">
                  <span class="text-{{ 'green' if tool.success_rate >= 90 else 'yellow' if tool.success_rate >= 70 else 'red' }}">
                    {{ "%.0f"|format(tool.success_rate) }}%
                  </span>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted">No tool data available</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {# Recent Activity & Quick Stats #}
  <div class="row row-deck row-cards">
    {# Recent Activity #}
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Recent Activity</h3>
        </div>
        <div class="list-group list-group-flush" id="activityFeed">
          {% for item in activity %}
          <div class="list-group-item">
            <div class="row align-items-center">
              <div class="col-auto">
                <span class="status-dot status-dot-animated bg-{{ 'success' if item.status == 'COMPLETED' else 'danger' if item.status == 'FAILED' else 'azure' if item.status == 'RUNNING' else 'secondary' }}"></span>
              </div>
              <div class="col text-truncate">
                <a href="{{ url_for('applications.application_detail', model_slug=item.model, app_number=item.app) }}" class="text-reset d-block">
                  {{ item.model }}/app{{ item.app }}
                </a>
                <div class="d-block text-muted text-truncate mt-n1">
                  {{ item.analysis_type }} analysis
                </div>
              </div>
              <div class="col-auto">
                <span class="badge bg-{{ 'success' if item.status == 'COMPLETED' else 'danger' if item.status == 'FAILED' else 'azure' if item.status == 'RUNNING' else 'secondary' }}-lt">
                  {{ item.status }}
                </span>
              </div>
              <div class="col-auto text-muted">
                {{ item.time_ago }}
              </div>
            </div>
          </div>
          {% else %}
          <div class="list-group-item text-center text-muted">
            No recent activity
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# Quick Stats Sidebar #}
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Quick Stats</h3>
        </div>
        <div class="card-body">
          <div class="datagrid">
            <div class="datagrid-item">
              <div class="datagrid-title">Today's Analyses</div>
              <div class="datagrid-content">{{ quick.today_count }}</div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">This Week</div>
              <div class="datagrid-content">{{ quick.week_count }}</div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">Pending Tasks</div>
              <div class="datagrid-content">
                <span class="badge bg-yellow-lt">{{ quick.pending_count }}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">Failed (24h)</div>
              <div class="datagrid-content">
                <span class="badge bg-{{ 'red' if quick.failed_24h > 0 else 'green' }}-lt">
                  {{ quick.failed_24h }}
                </span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">Most Active Model</div>
              <div class="datagrid-content text-truncate" style="max-width: 150px;">
                {{ quick.most_active_model or 'N/A' }}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">Last Analysis</div>
              <div class="datagrid-content">{{ quick.last_analysis_ago or 'Never' }}</div>
            </div>
          </div>
        </div>
      </div>

      {# Storage Info #}
      <div class="card mt-3">
        <div class="card-header">
          <h3 class="card-title">Storage</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex mb-1">
              <div>Results Directory</div>
              <div class="ms-auto">{{ filesystem.total_size_mb }} MB</div>
            </div>
            <div class="progress progress-sm">
              {% set pct = (filesystem.total_size_mb / 1000 * 100) %}
              <div class="progress-bar bg-primary" style="width: {{ pct if pct <= 100 else 100 }}%"></div>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <div class="me-auto">
              <span class="text-muted">{{ filesystem.total_result_files }} result files</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>