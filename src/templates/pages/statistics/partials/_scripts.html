{# Statistics Dashboard Scripts - Client-side rendering with ApexCharts #}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>

<script>
/**
 * Statistics Dashboard - Client-side rendering module
 */
const StatsDashboard = (function() {
    'use strict';
    
    // Chart instances
    let trendsChart = null;
    let severityChart = null;
    
    // API endpoint
    const API_URL = '/api/statistics/dashboard';
    
    // Cached data
    let currentData = null;
    
    /**
     * Initialize dashboard
     */
    function init() {
        load();
    }
    
    /**
     * Load dashboard data from API
     */
    async function load() {
        showLoading();
        
        try {
            const response = await fetch(API_URL);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || 'Unknown error');
            }
            
            currentData = result.data;
            render(currentData);
            showContent();
            updateLastCheck();
            
        } catch (error) {
            console.error('Failed to load statistics:', error);
            showError(error.message);
        }
    }
    
    /**
     * Refresh dashboard data
     */
    async function refresh() {
        const btn = document.getElementById('refreshBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Refreshing...';
        btn.disabled = true;
        
        try {
            const response = await fetch(API_URL);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || 'Unknown error');
            }
            
            currentData = result.data;
            render(currentData);
            updateLastCheck();
            showToast('Dashboard refreshed', 'success');
            
        } catch (error) {
            console.error('Failed to refresh statistics:', error);
            showToast('Failed to refresh: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }
    
    /**
     * Render all dashboard sections
     */
    function render(data) {
        renderHealth(data.health);
        renderKPIs(data.overview, data.severity, data.filesystem);
        renderCharts(data.trends, data.severity);
        renderModelComparison(data.models);
        renderToolEffectiveness(data.tools);
        renderActivityFeed(data.activity);
        renderQuickStats(data.quick, data.filesystem);
    }
    
    /**
     * Render health banner
     */
    function renderHealth(health) {
        const status = health.overall_status || 'unknown';
        const colorClass = status === 'healthy' ? 'success' : 
                          status === 'degraded' ? 'warning' : 'danger';
        
        document.getElementById('healthDot').className = 
            `status-dot status-dot-animated bg-${colorClass}`;
        
        const statusEl = document.getElementById('healthStatus');
        statusEl.className = `text-${colorClass}`;
        statusEl.textContent = capitalize(status);
        
        document.getElementById('servicesUpBadge').textContent = 
            `${health.services_up || 0}/${health.services_total || 4} Services`;
        
        const queueBadge = document.getElementById('queueBadge');
        if (health.queue_depth > 0) {
            queueBadge.textContent = `${health.queue_depth} Queued`;
            queueBadge.classList.remove('d-none');
        } else {
            queueBadge.classList.add('d-none');
        }
    }
    
    /**
     * Render KPI cards
     */
    function renderKPIs(overview, severity, filesystem) {
        // Total Analyses card
        setText('kpiTotalTasks', overview.total_tasks || 0);
        setText('kpiCompletedCount', overview.completed_count || 0);
        setText('kpiSuccessRate', `${(overview.success_rate || 0).toFixed(1)}%`);
        setWidth('kpiSuccessBar', overview.success_rate || 0);
        
        // Applications card
        setText('kpiUniqueApps', overview.unique_apps || 0);
        setText('kpiUniqueModels', overview.unique_models || 0);
        setText('kpiAppsWithResults', filesystem.apps_with_results || 0);
        const appsPercent = overview.unique_apps > 0 ? 
            (filesystem.apps_with_results / overview.unique_apps * 100) : 0;
        setWidth('kpiAppsBar', appsPercent);
        
        // Findings card
        const totalFindings = severity.total || 0;
        setText('kpiTotalFindings', totalFindings);
        setText('kpiHighSeverity', severity.high || 0);
        
        const criticalIndicator = document.getElementById('kpiCriticalIndicator');
        if (severity.critical > 0) {
            criticalIndicator.innerHTML = 
                `<span class="text-red d-inline-flex align-items-center lh-1">${severity.critical} critical</span>`;
        } else {
            criticalIndicator.innerHTML = 
                `<span class="text-green d-inline-flex align-items-center lh-1">No critical</span>`;
        }
        
        if (totalFindings > 0) {
            setWidth('kpiCriticalBar', (severity.critical / totalFindings) * 100);
            setWidth('kpiHighBar', (severity.high / totalFindings) * 100);
            setWidth('kpiMediumBar', (severity.medium / totalFindings) * 100);
        }
        
        // Avg Analysis Time card
        setText('kpiAvgDuration', (overview.avg_duration_seconds || 0).toFixed(1));
        setText('kpiRunningCount', overview.running_count || 0);
        setWidth('kpiRunningBar', overview.running_count > 0 ? 100 : 0);
    }
    
    /**
     * Render ApexCharts
     */
    function renderCharts(trends, severity) {
        renderTrendsChart(trends);
        renderSeverityChart(severity);
    }
    
    /**
     * Render trends area chart
     */
    function renderTrendsChart(trends) {
        const el = document.getElementById('trendsChart');
        if (!el) return;
        
        const dates = trends.dates || [];
        const completed = sanitizeNumberArray(trends.completed);
        const failed = sanitizeNumberArray(trends.failed);
        
        if (dates.length === 0) {
            el.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">' +
                '<span>No analysis trends data available</span></div>';
            return;
        }
        
        const options = {
            chart: {
                type: 'area',
                height: 300,
                toolbar: { show: false },
                animations: { enabled: true, easing: 'easeinout', speed: 500 }
            },
            series: [
                { name: 'Completed', data: completed },
                { name: 'Failed', data: failed }
            ],
            xaxis: {
                categories: dates,
                labels: { style: { colors: '#6c757d' }, rotate: -45 }
            },
            yaxis: {
                labels: { style: { colors: '#6c757d' } },
                min: 0
            },
            colors: ['#2fb344', '#d63939'],
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.4,
                    opacityTo: 0.1,
                    stops: [0, 100]
                }
            },
            stroke: { curve: 'smooth', width: 2 },
            legend: { position: 'top', horizontalAlign: 'right' },
            tooltip: { theme: 'dark' },
            grid: { borderColor: '#e9ecef', strokeDashArray: 3 }
        };
        
        if (trendsChart) {
            trendsChart.updateOptions({ xaxis: { categories: dates } });
            trendsChart.updateSeries([
                { name: 'Completed', data: completed },
                { name: 'Failed', data: failed }
            ]);
        } else {
            trendsChart = new ApexCharts(el, options);
            trendsChart.render();
        }
    }
    
    /**
     * Render severity donut chart
     */
    function renderSeverityChart(severity) {
        const el = document.getElementById('severityChart');
        if (!el) return;
        
        const data = [
            sanitizeNumber(severity.critical),
            sanitizeNumber(severity.high),
            sanitizeNumber(severity.medium),
            sanitizeNumber(severity.low),
            sanitizeNumber(severity.info)
        ];
        const total = data.reduce((a, b) => a + b, 0);
        
        if (total === 0) {
            el.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted flex-column">' +
                '<i class="fa-solid fa-check-circle fa-2x mb-2 text-success"></i>' +
                '<span>No findings to display</span></div>';
            return;
        }
        
        const options = {
            chart: {
                type: 'donut',
                height: 300,
                animations: { enabled: true, easing: 'easeinout', speed: 500 }
            },
            series: data,
            labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
            colors: ['#d63939', '#f76707', '#f59f00', '#2fb344', '#206bc4'],
            legend: { position: 'bottom' },
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total',
                                formatter: (w) => w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                            }
                        }
                    }
                }
            },
            tooltip: { theme: 'dark' },
            dataLabels: { enabled: false }
        };
        
        if (severityChart) {
            severityChart.updateSeries(data);
        } else {
            severityChart = new ApexCharts(el, options);
            severityChart.render();
        }
    }
    
    /**
     * Render model comparison table
     */
    function renderModelComparison(models) {
        const tbody = document.getElementById('modelComparisonTable');
        if (!tbody) return;
        
        if (!models || models.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No model data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = models.slice(0, 5).map(model => `
            <tr>
                <td>
                    <div class="text-truncate" style="max-width: 150px;" title="${escapeHtml(model.model)}">
                        ${escapeHtml(model.model)}
                    </div>
                </td>
                <td class="text-center">${model.app_count || 0}</td>
                <td class="text-center">${model.analysis_count || 0}</td>
                <td class="text-center">
                    <span class="badge bg-${getFindingsBadgeColor(model.total_findings)}-lt">
                        ${model.total_findings || 0}
                    </span>
                </td>
                <td class="text-center">
                    ${model.avg_score != null ? 
                        `<span class="badge bg-${getScoreBadgeColor(model.avg_score)}-lt">${Math.round(model.avg_score)}</span>` : 
                        '<span class="text-muted">-</span>'}
                </td>
            </tr>
        `).join('');
    }
    
    /**
     * Render tool effectiveness table
     */
    function renderToolEffectiveness(tools) {
        const tbody = document.getElementById('toolEffectivenessTable');
        if (!tbody) return;
        
        if (!tools || tools.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No tool data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = tools.slice(0, 5).map(tool => `
            <tr>
                <td><span class="badge bg-azure-lt">${escapeHtml(tool.tool)}</span></td>
                <td class="text-center">${tool.run_count || 0}</td>
                <td class="text-center">${tool.total_findings || 0}</td>
                <td class="text-center">${(tool.avg_findings || 0).toFixed(1)}</td>
                <td class="text-center">
                    <span class="text-${getSuccessRateColor(tool.success_rate)}">
                        ${Math.round(tool.success_rate || 0)}%
                    </span>
                </td>
            </tr>
        `).join('');
    }
    
    /**
     * Render activity feed
     */
    function renderActivityFeed(activity) {
        const feed = document.getElementById('activityFeed');
        if (!feed) return;
        
        if (!activity || activity.length === 0) {
            feed.innerHTML = '<div class="list-group-item text-center text-muted">No recent activity</div>';
            return;
        }
        
        feed.innerHTML = activity.map(item => `
            <div class="list-group-item">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="status-dot status-dot-animated bg-${getStatusColor(item.status)}"></span>
                    </div>
                    <div class="col text-truncate">
                        <a href="/applications/${encodeURIComponent(item.model)}/${item.app}" class="text-reset d-block">
                            ${escapeHtml(item.model)}/app${item.app}
                        </a>
                        <div class="d-block text-muted text-truncate mt-n1">
                            ${escapeHtml(item.analysis_type || 'comprehensive')} analysis
                        </div>
                    </div>
                    <div class="col-auto">
                        <span class="badge bg-${getStatusColor(item.status)}-lt">${item.status}</span>
                    </div>
                    <div class="col-auto text-muted">${item.time_ago}</div>
                </div>
            </div>
        `).join('');
    }
    
    /**
     * Render quick stats sidebar
     */
    function renderQuickStats(quick, filesystem) {
        setText('quickTodayCount', quick.today_count || 0);
        setText('quickWeekCount', quick.week_count || 0);
        setText('quickPendingBadge', quick.pending_count || 0);
        
        const failedBadge = document.getElementById('quickFailedBadge');
        failedBadge.textContent = quick.failed_24h || 0;
        failedBadge.className = `badge bg-${quick.failed_24h > 0 ? 'red' : 'green'}-lt`;
        
        setText('quickMostActiveModel', quick.most_active_model || 'N/A');
        setText('quickLastAnalysis', quick.last_analysis_ago || 'Never');
        
        // Storage info
        setText('storageSizeMb', filesystem.total_size_mb || 0);
        setText('storageFileCount', filesystem.total_result_files || 0);
        const storagePct = Math.min((filesystem.total_size_mb / 1000) * 100, 100);
        setWidth('storageBar', storagePct);
    }
    
    // === UI State Helpers ===
    
    function showLoading() {
        document.getElementById('statisticsLoading').classList.remove('d-none');
        document.getElementById('statisticsContent').classList.add('d-none');
        document.getElementById('statisticsError').classList.add('d-none');
    }
    
    function showContent() {
        document.getElementById('statisticsLoading').classList.add('d-none');
        document.getElementById('statisticsContent').classList.remove('d-none');
        document.getElementById('statisticsError').classList.add('d-none');
    }
    
    function showError(message) {
        document.getElementById('statisticsLoading').classList.add('d-none');
        document.getElementById('statisticsContent').classList.add('d-none');
        document.getElementById('statisticsError').classList.remove('d-none');
        document.getElementById('statisticsErrorMessage').textContent = message || 'An error occurred';
    }
    
    function updateLastCheck() {
        document.getElementById('lastCheck').textContent = 'just now';
    }
    
    // === Utility Helpers ===
    
    function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    }
    
    function setWidth(id, percent) {
        const el = document.getElementById(id);
        if (el) el.style.width = `${Math.max(0, Math.min(100, percent))}%`;
    }
    
    function sanitizeNumber(val) {
        if (val === null || val === undefined || val === 'None') return 0;
        const num = Number(val);
        return isFinite(num) ? num : 0;
    }
    
    function sanitizeNumberArray(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(sanitizeNumber);
    }
    
    function capitalize(str) {
        return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    
    function getStatusColor(status) {
        const colors = {
            'COMPLETED': 'success',
            'FAILED': 'danger',
            'RUNNING': 'azure',
            'PENDING': 'secondary',
            'PARTIAL_SUCCESS': 'warning'
        };
        return colors[status] || 'secondary';
    }
    
    function getFindingsBadgeColor(count) {
        if (count > 50) return 'red';
        if (count > 20) return 'orange';
        return 'green';
    }
    
    function getScoreBadgeColor(score) {
        if (score >= 80) return 'green';
        if (score >= 60) return 'yellow';
        return 'red';
    }
    
    function getSuccessRateColor(rate) {
        if (rate >= 90) return 'green';
        if (rate >= 70) return 'yellow';
        return 'red';
    }
    
    function showToast(message, type = 'info') {
        // Simple console log - can enhance with actual toast component
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Public API
    return {
        load: load,
        refresh: refresh,
        getData: () => currentData
    };
})();
</script>
