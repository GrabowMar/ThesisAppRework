{# Statistics Dashboard Scripts - Client-side rendering with ApexCharts #}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>

<script>
/**
 * Statistics Dashboard - Client-side rendering module
 * HTMX-safe: Uses window namespace to prevent re-declaration errors
 */
(function() {
    'use strict';
    
    // Prevent re-initialization on HTMX navigation
    if (window.StatsDashboard && window.StatsDashboard._initialized) {
        // Already initialized, just reload the data
        window.StatsDashboard.load();
        return;
    }
    
    // Chart instances
    let trendsChart = null;
    let severityChart = null;
    
    // API endpoint
    const API_URL = '/api/statistics/dashboard';
    
    // Cached data
    let currentData = null;
    
    /**
     * Initialize dashboard
     */
    function init() {
        load();
    }
    
    /**
     * Load dashboard data from API
     */
    async function load() {
        showLoading();
        
        try {
            const response = await fetch(API_URL);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || 'Unknown error');
            }
            
            currentData = result.data;
            render(currentData);
            showContent();
            updateLastCheck();
            
        } catch (error) {
            console.error('Failed to load statistics:', error);
            showError(error.message);
        }
    }
    
    /**
     * Refresh dashboard data
     */
    async function refresh() {
        const btn = document.getElementById('refreshBtn');
        if (!btn) return;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Refreshing...';
        btn.disabled = true;
        
        try {
            const response = await fetch(API_URL);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || 'Unknown error');
            }
            
            currentData = result.data;
            render(currentData);
            updateLastCheck();
            showToast('Dashboard refreshed', 'success');
            
        } catch (error) {
            console.error('Failed to refresh statistics:', error);
            showToast('Failed to refresh: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }
    
    /**
     * Cleanup function for HTMX navigation away
     */
    function cleanup() {
        // Destroy chart instances to prevent memory leaks
        if (trendsChart) {
            trendsChart.destroy();
            trendsChart = null;
        }
        if (severityChart) {
            severityChart.destroy();
            severityChart = null;
        }
        currentData = null;
    }
    
    /**
     * Render all dashboard sections
     */
    function render(data) {
        renderHealth(data.health);
        renderKPIs(data.overview, data.severity, data.filesystem);
        renderCharts(data.trends, data.severity);
        renderModelComparison(data.models);
        renderToolEffectiveness(data.tools);
        renderCodeStats(data.code_stats);
        renderTopFindings(data.top_findings);
        renderLeaderboard(data.leaderboard);
        renderQuickStats(data.quick, data.filesystem);
    }
    
    /**
     * Render health banner
     */
    function renderHealth(health) {
        const status = health.overall_status || 'unknown';
        const colorClass = status === 'healthy' ? 'success' : 
                          status === 'degraded' ? 'warning' : 'danger';
        
        const healthDot = document.getElementById('healthDot');
        if (healthDot) {
            healthDot.className = `status-dot status-dot-animated bg-${colorClass}`;
        }
        
        const statusEl = document.getElementById('healthStatus');
        if (statusEl) {
            statusEl.className = `text-${colorClass}`;
            statusEl.textContent = capitalize(status);
        }
        
        setText('servicesUpBadge', `${health.services_up || 0}/${health.services_total || 4} Services`);
        
        const queueBadge = document.getElementById('queueBadge');
        if (queueBadge) {
            if (health.queue_depth > 0) {
                queueBadge.textContent = `${health.queue_depth} Queued`;
                queueBadge.classList.remove('d-none');
            } else {
                queueBadge.classList.add('d-none');
            }
        }
    }
    
    /**
     * Render KPI cards
     */
    function renderKPIs(overview, severity, filesystem) {
        // Total Analyses card
        setText('kpiTotalTasks', overview.total_tasks || 0);
        setText('kpiCompletedCount', overview.completed_count || 0);
        setText('kpiSuccessRate', `${(overview.success_rate || 0).toFixed(1)}%`);
        setWidth('kpiSuccessBar', overview.success_rate || 0);
        
        // Applications card
        setText('kpiTotalApps', overview.total_apps || 0);
        setText('kpiUniqueModels', overview.unique_models || 0);
        setText('kpiAppsAnalyzed', overview.unique_apps || 0);
        const appsPercent = overview.total_apps > 0 ? 
            (overview.unique_apps / overview.total_apps * 100) : 0;
        setWidth('kpiAppsBar', appsPercent);
        
        // Findings card
        const totalFindings = severity.total || 0;
        setText('kpiTotalFindings', totalFindings);
        setText('kpiHighSeverity', severity.high || 0);
        
        const criticalIndicator = document.getElementById('kpiCriticalIndicator');
        if (criticalIndicator) {
            if (severity.critical > 0) {
                criticalIndicator.innerHTML = 
                    `<span class="text-red d-inline-flex align-items-center lh-1">${severity.critical} critical</span>`;
            } else {
                criticalIndicator.innerHTML = 
                    `<span class="text-green d-inline-flex align-items-center lh-1">No critical</span>`;
            }
        }
        
        if (totalFindings > 0) {
            setWidth('kpiCriticalBar', (severity.critical / totalFindings) * 100);
            setWidth('kpiHighBar', (severity.high / totalFindings) * 100);
            setWidth('kpiMediumBar', (severity.medium / totalFindings) * 100);
        }
        
        // Avg Analysis Time card
        setText('kpiAvgDuration', (overview.avg_duration_seconds || 0).toFixed(1));
        setText('kpiRunningCount', overview.running_count || 0);
        setWidth('kpiRunningBar', overview.running_count > 0 ? 100 : 0);
    }
    
    /**
     * Render ApexCharts
     */
    function renderCharts(trends, severity) {
        renderTrendsChart(trends);
        renderSeverityChart(severity);
    }
    
    /**
     * Render trends area chart
     */
    function renderTrendsChart(trends) {
        const el = document.getElementById('trendsChart');
        if (!el) return;
        
        const dates = trends.dates || [];
        const completed = sanitizeNumberArray(trends.completed);
        const failed = sanitizeNumberArray(trends.failed);
        
        if (dates.length === 0) {
            el.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">' +
                '<span>No analysis trends data available</span></div>';
            return;
        }
        
        const options = {
            chart: {
                type: 'area',
                height: 300,
                toolbar: { show: false },
                animations: { enabled: true, easing: 'easeinout', speed: 500 }
            },
            series: [
                { name: 'Completed', data: completed },
                { name: 'Failed', data: failed }
            ],
            xaxis: {
                categories: dates,
                labels: { style: { colors: '#6c757d' }, rotate: -45 }
            },
            yaxis: {
                labels: { style: { colors: '#6c757d' } },
                min: 0
            },
            colors: ['#2fb344', '#d63939'],
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.4,
                    opacityTo: 0.1,
                    stops: [0, 100]
                }
            },
            stroke: { curve: 'smooth', width: 2 },
            legend: { position: 'top', horizontalAlign: 'right' },
            tooltip: { theme: 'dark' },
            grid: { borderColor: '#e9ecef', strokeDashArray: 3 }
        };
        
        if (trendsChart) {
            trendsChart.updateOptions({ xaxis: { categories: dates } });
            trendsChart.updateSeries([
                { name: 'Completed', data: completed },
                { name: 'Failed', data: failed }
            ]);
        } else {
            trendsChart = new ApexCharts(el, options);
            trendsChart.render();
        }
    }
    
    /**
     * Render severity donut chart
     */
    function renderSeverityChart(severity) {
        const el = document.getElementById('severityChart');
        if (!el) return;
        
        const data = [
            sanitizeNumber(severity.critical),
            sanitizeNumber(severity.high),
            sanitizeNumber(severity.medium),
            sanitizeNumber(severity.low),
            sanitizeNumber(severity.info)
        ];
        const total = data.reduce((a, b) => a + b, 0);
        
        if (total === 0) {
            el.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted flex-column">' +
                '<i class="fa-solid fa-check-circle fa-2x mb-2 text-success"></i>' +
                '<span>No findings to display</span></div>';
            return;
        }
        
        const options = {
            chart: {
                type: 'donut',
                height: 300,
                animations: { enabled: true, easing: 'easeinout', speed: 500 }
            },
            series: data,
            labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
            colors: ['#d63939', '#f76707', '#f59f00', '#2fb344', '#206bc4'],
            legend: { position: 'bottom' },
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total',
                                formatter: (w) => w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                            }
                        }
                    }
                }
            },
            tooltip: { theme: 'dark' },
            dataLabels: { enabled: false }
        };
        
        if (severityChart) {
            severityChart.updateSeries(data);
        } else {
            severityChart = new ApexCharts(el, options);
            severityChart.render();
        }
    }
    
    /**
     * Render model comparison table
     */
    function renderModelComparison(models) {
        const tbody = document.getElementById('modelComparisonTable');
        if (!tbody) return;
        
        if (!models || models.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No model data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = models.slice(0, 5).map(model => `
            <tr>
                <td>
                    <div class="text-truncate" style="max-width: 150px;" title="${escapeHtml(model.model)}">
                        ${escapeHtml(model.model)}
                    </div>
                </td>
                <td class="text-center">${model.app_count || 0}</td>
                <td class="text-center">${model.analysis_count || 0}</td>
                <td class="text-center">
                    <span class="badge bg-${getFindingsBadgeColor(model.total_findings)}-lt">
                        ${model.total_findings || 0}
                    </span>
                </td>
                <td class="text-center">
                    ${model.avg_findings != null ? 
                        `<span>${model.avg_findings}</span>` : 
                        '<span class="text-muted">-</span>'}
                </td>
            </tr>
        `).join('');
    }
    
    /**
     * Render tool effectiveness table
     */
    function renderToolEffectiveness(tools) {
        const tbody = document.getElementById('toolEffectivenessTable');
        if (!tbody) return;
        
        if (!tools || tools.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No tool data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = tools.slice(0, 5).map(tool => `
            <tr>
                <td><span class="badge bg-azure-lt">${escapeHtml(tool.tool)}</span></td>
                <td class="text-center">${tool.run_count || 0}</td>
                <td class="text-center">${tool.total_findings || 0}</td>
                <td class="text-center">${(tool.avg_findings || 0).toFixed(1)}</td>
                <td class="text-center">
                    <span class="text-${getSuccessRateColor(tool.success_rate)}">
                        ${Math.round(tool.success_rate || 0)}%
                    </span>
                </td>
            </tr>
        `).join('');
    }
    
    /**
     * Render code generation stats table
     */
    function renderCodeStats(codeStats) {
        const tbody = document.getElementById('codeStatsTable');
        if (!tbody) return;
        
        if (!codeStats || codeStats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No code data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = codeStats.map((item, i) => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-${i === 0 ? 'green' : (i === codeStats.length - 1 ? 'red' : 'azure')}-lt me-2">${i + 1}</span>
                        <div class="text-truncate" style="max-width: 140px;" title="${escapeHtml(item.model)}">
                            ${escapeHtml(item.model)}
                        </div>
                    </div>
                </td>
                <td class="text-end fw-bold">${item.total_lines.toLocaleString()}</td>
                <td class="text-end text-muted">${item.total_files}</td>
                <td class="text-end text-muted">${item.avg_lines_per_app.toLocaleString()}</td>
            </tr>
        `).join('');
    }
    
    /**
     * Render top findings table
     */
    function renderTopFindings(findings) {
        const tbody = document.getElementById('topFindingsTable');
        if (!tbody) return;
        
        if (!findings || findings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No findings data available</td></tr>';
            return;
        }
        
        const levelColors = {
            'error': 'red', 'warning': 'orange', 'note': 'blue'
        };
        
        tbody.innerHTML = findings.map(f => `
            <tr>
                <td>
                    <span class="text-truncate d-inline-block" style="max-width: 140px;" title="${escapeHtml(f.rule_id)}">
                        ${escapeHtml(f.rule_id)}
                    </span>
                </td>
                <td><span class="badge bg-azure-lt">${escapeHtml(f.tool)}</span></td>
                <td class="text-center">
                    <span class="badge bg-${levelColors[f.level] || 'secondary'}-lt">${f.level}</span>
                </td>
                <td class="text-end fw-bold">${f.count.toLocaleString()}</td>
            </tr>
        `).join('');
    }
    
    /**
     * Render model leaderboard grid
     */
    function renderLeaderboard(leaderboard) {
        const grid = document.getElementById('leaderboardGrid');
        if (!grid) return;
        
        if (!leaderboard || Object.keys(leaderboard).length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-muted">No leaderboard data available</div>';
            return;
        }
        
        const entries = {
            'most_lines':         { icon: 'fa-code',           label: 'Most Code Generated',    color: 'green' },
            'fewest_lines':       { icon: 'fa-compress',       label: 'Most Concise Code',      color: 'cyan' },
            'fewest_issues':      { icon: 'fa-shield-halved',  label: 'Fewest Issues',          color: 'green' },
            'most_issues':        { icon: 'fa-triangle-exclamation', label: 'Most Issues',      color: 'red' },
            'fastest_analysis':   { icon: 'fa-bolt',           label: 'Fastest Analysis',       color: 'azure' },
            'slowest_analysis':   { icon: 'fa-hourglass-half', label: 'Slowest Analysis',       color: 'orange' },
            'best_success_rate':  { icon: 'fa-check-circle',   label: 'Best Success Rate',      color: 'green' },
        };
        
        grid.innerHTML = Object.entries(entries).map(([key, meta]) => {
            const data = leaderboard[key];
            if (!data) return '';
            return `
                <div class="col-sm-6 col-lg-4">
                    <div class="card card-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <span class="bg-${meta.color}-lt text-${meta.color} avatar avatar-sm me-3">
                                    <i class="fa-solid ${meta.icon}"></i>
                                </span>
                                <div class="min-w-0">
                                    <div class="text-muted small">${meta.label}</div>
                                    <div class="fw-bold text-truncate" style="max-width: 160px;" title="${escapeHtml(data.model)}">
                                        ${escapeHtml(data.model)}
                                    </div>
                                    <div class="text-muted small">${escapeHtml(data.value)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    /**
     * Render quick stats sidebar
     */
    function renderQuickStats(quick, filesystem) {
        setText('quickTodayCount', quick.today_count || 0);
        setText('quickWeekCount', quick.week_count || 0);
        setText('quickPendingBadge', quick.pending_count || 0);
        
        const failedBadge = document.getElementById('quickFailedBadge');
        if (failedBadge) {
            failedBadge.textContent = quick.failed_24h || 0;
            failedBadge.className = `badge bg-${quick.failed_24h > 0 ? 'red' : 'green'}-lt`;
        }
        
        setText('quickMostActiveModel', quick.most_active_model || 'N/A');
        setText('quickLastAnalysis', quick.last_analysis_ago || 'Never');
        
        // Storage info
        setText('storageSizeMb', filesystem.total_size_mb || 0);
        setText('storageFileCount', filesystem.total_result_files || 0);
        const storagePct = Math.min((filesystem.total_size_mb / 1000) * 100, 100);
        setWidth('storageBar', storagePct);
    }
    
    // === UI State Helpers ===
    
    function showLoading() {
        const loading = document.getElementById('statisticsLoading');
        const content = document.getElementById('statisticsContent');
        const error = document.getElementById('statisticsError');
        if (loading) loading.classList.remove('d-none');
        if (content) content.classList.add('d-none');
        if (error) error.classList.add('d-none');
    }
    
    function showContent() {
        const loading = document.getElementById('statisticsLoading');
        const content = document.getElementById('statisticsContent');
        const error = document.getElementById('statisticsError');
        if (loading) loading.classList.add('d-none');
        if (content) content.classList.remove('d-none');
        if (error) error.classList.add('d-none');
    }
    
    function showError(message) {
        const loading = document.getElementById('statisticsLoading');
        const content = document.getElementById('statisticsContent');
        const error = document.getElementById('statisticsError');
        const errorMsg = document.getElementById('statisticsErrorMessage');
        if (loading) loading.classList.add('d-none');
        if (content) content.classList.add('d-none');
        if (error) error.classList.remove('d-none');
        if (errorMsg) errorMsg.textContent = message || 'An error occurred';
    }
    
    function updateLastCheck() {
        setText('lastCheck', 'just now');
    }
    
    // === Utility Helpers ===
    
    function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    }
    
    function setWidth(id, percent) {
        const el = document.getElementById(id);
        if (el) el.style.width = `${Math.max(0, Math.min(100, percent))}%`;
    }
    
    function sanitizeNumber(val) {
        if (val === null || val === undefined || val === 'None') return 0;
        const num = Number(val);
        return isFinite(num) ? num : 0;
    }
    
    function sanitizeNumberArray(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(sanitizeNumber);
    }
    
    function capitalize(str) {
        return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    
    function getFindingsBadgeColor(count) {
        if (count > 50) return 'red';
        if (count > 20) return 'orange';
        return 'green';
    }
    
    function getSuccessRateColor(rate) {
        if (rate >= 90) return 'green';
        if (rate >= 70) return 'yellow';
        return 'red';
    }
    
    function showToast(message, type = 'info') {
        // Simple console log - can enhance with actual toast component
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    // Export to window for HTMX-safe access
    window.StatsDashboard = {
        load: load,
        refresh: refresh,
        getData: () => currentData,
        cleanup: cleanup,
        _initialized: true
    };
    
    // Listen for HTMX navigation away to cleanup
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        // If navigating away from statistics page, cleanup charts
        if (!evt.detail.target.querySelector || !evt.detail.target.querySelector('#statisticsContent')) {
            cleanup();
        }
    });
    
    // Initialize
    init();
})();
</script>
