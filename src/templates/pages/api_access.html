{% extends "layouts/base.html" %}

{% block title %}API Access{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">API Access</h2>
                <div class="text-secondary mt-1">
                    Manage your API token for programmatic access
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <div class="row row-cards">
            <!-- Token Management Card -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">API Token</h3>
                    </div>
                    <div class="card-body">
                        <div id="token-status" class="mb-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2 text-muted">Checking token status...</span>
                        </div>
                        
                        <div id="token-actions" class="d-none">
                            <div id="has-token-view" class="d-none">
                                <div class="alert alert-success mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fa-solid fa-check-circle me-2"></i>
                                        <div>
                                            <strong>Active Token</strong>
                                            <div class="text-muted small" id="token-created-at"></div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-danger" onclick="revokeToken()">
                                    <i class="fa-solid fa-trash me-2"></i>Revoke Token
                                </button>
                            </div>
                            
                            <div id="no-token-view" class="d-none">
                                <div class="alert alert-info mb-3">
                                    <i class="fa-solid fa-info-circle me-2"></i>
                                    No API token generated yet.
                                </div>
                                <button class="btn btn-primary" onclick="generateToken()">
                                    <i class="fa-solid fa-key me-2"></i>Generate New Token
                                </button>
                            </div>
                        </div>
                        
                        <div id="token-display" class="d-none mt-3">
                            <div class="alert alert-warning">
                                <strong>Save this token!</strong> It will only be shown once.
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="new-token" readonly>
                                <button class="btn btn-ghost-secondary" type="button" onclick="copyToken()">
                                    <i class="fa-solid fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documentation Card -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Usage Guide</h3>
                    </div>
                    <div class="card-body">
                        <h4 class="mb-3">Using Your Token</h4>
                        
                        <p class="text-muted">Include your token in the <code>Authorization</code> header:</p>
                        
                        <pre class="bg-dark text-white p-3 rounded"><code>curl -H "Authorization: Bearer YOUR_TOKEN" \
     {{ request.url_root }}api/models</code></pre>
                        
                        <div class="alert alert-info mt-3">
                            <strong>For AI Models (like Claude):</strong>
                            <p class="mb-0">Your AI assistant can now access all API endpoints using this token. Just provide the token and base URL.</p>
                        </div>
                        
                        <h4 class="mt-4 mb-3">Available Endpoints</h4>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <code class="text-primary">GET /api/models</code><br>
                                <span class="text-muted small">List all AI models</span>
                            </li>
                            <li class="mb-2">
                                <code class="text-primary">GET /api/applications</code><br>
                                <span class="text-muted small">List generated applications</span>
                            </li>
                            <li class="mb-2">
                                <code class="text-primary">POST /api/gen/generate</code><br>
                                <span class="text-muted small">Generate new application</span>
                            </li>
                            <li class="mb-2">
                                <code class="text-primary">GET /api/dashboard/stats</code><br>
                                <span class="text-muted small">Get dashboard statistics</span>
                            </li>
                            <li class="mb-2">
                                <code class="text-primary">GET /api/health</code><br>
                                <span class="text-muted small">Check system health</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check token status on page load
checkTokenStatus();

async function checkTokenStatus() {
    try {
        const response = await fetch('/api/tokens/status');
        const data = await response.json();
        
        document.getElementById('token-status').classList.add('d-none');
        document.getElementById('token-actions').classList.remove('d-none');
        
        if (data.has_token) {
            document.getElementById('has-token-view').classList.remove('d-none');
            document.getElementById('no-token-view').classList.add('d-none');
            if (data.created_at) {
                const date = new Date(data.created_at);
                document.getElementById('token-created-at').textContent = 
                    `Created: ${date.toLocaleString()}`;
            }
        } else {
            document.getElementById('has-token-view').classList.add('d-none');
            document.getElementById('no-token-view').classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error checking token status:', error);
        document.getElementById('token-status').innerHTML = 
            '<div class="alert alert-danger">Failed to check token status</div>';
    }
}

async function generateToken() {
    if (!confirm('Generate a new API token? This will invalidate any existing token.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/tokens/generate', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('new-token').value = data.token;
            document.getElementById('token-display').classList.remove('d-none');
            checkTokenStatus();
        } else {
            alert('Failed to generate token: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error generating token:', error);
        alert('Failed to generate token');
    }
}

async function revokeToken() {
    if (!confirm('Revoke your API token? All API requests using this token will fail.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/tokens/revoke', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('token-display').classList.add('d-none');
            checkTokenStatus();
        } else {
            alert('Failed to revoke token: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error revoking token:', error);
        alert('Failed to revoke token');
    }
}

function copyToken() {
    const tokenInput = document.getElementById('new-token');
    tokenInput.select();
    document.execCommand('copy');
    
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
    setTimeout(() => {
        btn.innerHTML = originalHTML;
    }, 2000);
}
</script>
{% endblock %}
