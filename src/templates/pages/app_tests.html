{% extends "pages/app_base.html" %}

{% block page_content %}
<div class="row">
    <!-- Test Controls -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-play text-success mr-2"></i>
                    Run Tests
                </h5>
            </div>
            <div class="card-body">
                <!-- Security Analysis -->
                <div class="test-controls">
                    <h6 class="text-primary">Security Analysis</h6>
                    <p class="text-muted small mb-3">Run security vulnerability scans using Bandit, Safety, and other tools</p>
                    
                    <form id="security-test-form"
                          hx-post="/analysis/backend_security/{{ model }}/{{ app_num }}/run"
                          hx-target="#security-results"
                          hx-indicator="#security-spinner">
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tools" value="bandit" id="bandit" checked>
                                <label class="form-check-label" for="bandit">Bandit</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tools" value="safety" id="safety" checked>
                                <label class="form-check-label" for="safety">Safety</label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-shield-alt mr-2"></i>Run Security Scan
                        </button>
                    </form>
                    
                    <div id="security-spinner" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Running...</span>
                        </div>
                        <span class="ml-2 small">Running security analysis...</span>
                    </div>
                </div>

                <!-- Performance Test -->
                <div class="test-controls">
                    <h6 class="text-success">Performance Test</h6>
                    <p class="text-muted small mb-3">Load test the application endpoints</p>
                    
                    <form id="performance-test-form"
                          hx-post="/performance/{{ model }}/{{ app_num }}/run"
                          hx-target="#performance-results"
                          hx-indicator="#performance-spinner">
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="users" class="small">Users:</label>
                                    <input type="number" class="form-control form-control-sm" id="users" name="users" value="5" min="1" max="50">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="duration" class="small">Duration (s):</label>
                                    <input type="number" class="form-control form-control-sm" id="duration" name="duration" value="30" min="10" max="300">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-tachometer-alt mr-2"></i>Run Performance Test
                        </button>
                    </form>
                    
                    <div id="performance-spinner" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-success" role="status">
                            <span class="sr-only">Running...</span>
                        </div>
                        <span class="ml-2 small">Running performance test...</span>
                    </div>
                </div>

                <!-- ZAP Security Scan -->
                <div class="test-controls">
                    <h6 class="text-danger">ZAP Security Scan</h6>
                    <p class="text-muted small mb-3">Dynamic application security testing with OWASP ZAP</p>
                    
                    <form id="zap-test-form"
                          hx-post="/zap/{{ model }}/{{ app_num }}/scan"
                          hx-target="#zap-results"
                          hx-indicator="#zap-spinner">
                        <div class="form-group">
                            <label for="target_url" class="small">Target URL:</label>
                            <input type="url" 
                                   class="form-control form-control-sm" 
                                   id="target_url" 
                                   name="target_url" 
                                   value="http://localhost:{{ 9000 + (app_num * 10) }}">
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scan_type" id="quick_scan" value="quick" checked>
                                <label class="form-check-label small" for="quick_scan">Quick Scan</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scan_type" id="full_scan" value="full">
                                <label class="form-check-label small" for="full_scan">Full Scan</label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-danger btn-block">
                            <i class="fas fa-bug mr-2"></i>Start ZAP Scan
                        </button>
                    </form>
                    
                    <div id="zap-spinner" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-danger" role="status">
                            <span class="sr-only">Running...</span>
                        </div>
                        <span class="ml-2 small">Running ZAP scan...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Container Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat text-info mr-2"></i>
                    Container Status
                </h5>
            </div>
            <div class="card-body" 
                 id="container-status"
                 hx-get="/api/status/{{ model }}/{{ app_num }}"
                 hx-trigger="load, every 15s"
                 hx-target="this">
                <div class="text-center py-3">
                    <div class="spinner-border text-info" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted small">Loading status...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line text-primary mr-2"></i>
                    Test Results
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary"
                            hx-get="/api/tests/{{ model }}/{{ app_num }}/refresh"
                            hx-target="#all-results"
                            hx-indicator="#results-spinner">
                        <i class="fas fa-sync mr-1"></i>Refresh All
                    </button>
                    <button class="btn btn-outline-secondary"
                            hx-post="/api/tests/{{ model }}/{{ app_num }}/save"
                            hx-target="#save-status"
                            hx-indicator="#save-spinner">
                        <i class="fas fa-save mr-1"></i>Save Results
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="results-spinner" class="htmx-indicator text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Refreshing all results...</p>
                </div>
                
                <div id="save-spinner" class="htmx-indicator">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-save mr-2"></i>Saving test results...
                    </div>
                </div>
                
                <div id="save-status"></div>
                
                <div id="all-results">
                    <!-- Security Results -->
                    <div id="security-results" class="mb-4">
                        <h6 class="text-primary">
                            <i class="fas fa-shield-alt mr-2"></i>Security Analysis Results
                        </h6>
                        <div class="alert alert-light border text-center" role="alert">
                            <i class="fas fa-shield-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No security analysis results yet. Run a security scan to see results.</p>
                        </div>
                    </div>

                    <!-- Performance Results -->
                    <div id="performance-results" class="mb-4">
                        <h6 class="text-success">
                            <i class="fas fa-tachometer-alt mr-2"></i>Performance Test Results
                        </h6>
                        <div class="alert alert-light border text-center" role="alert">
                            <i class="fas fa-tachometer-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No performance test results yet. Run a performance test to see results.</p>
                        </div>
                    </div>

                    <!-- ZAP Results -->
                    <div id="zap-results" class="mb-4">
                        <h6 class="text-danger">
                            <i class="fas fa-bug mr-2"></i>ZAP Scan Results
                        </h6>
                        <div class="alert alert-light border text-center" role="alert">
                            <i class="fas fa-bug fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No ZAP scan results yet. Start a ZAP scan to see results.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.test-controls {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid;
}

.test-controls:first-child { border-left-color: #007bff; }
.test-controls:nth-child(2) { border-left-color: #28a745; }
.test-controls:nth-child(3) { border-left-color: #dc3545; }

.quick-action-btn {
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.analysis-card {
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
}

.analysis-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.test-results {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.75rem;
    background: #ffffff;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
}

.test-results pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.htmx-indicator {
    display: none;
}
</style>
{% endblock %}
