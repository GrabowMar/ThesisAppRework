{% extends "pages/app_base.html" %}

{% block page_content %}
<div class="row">
    <!-- Test Controls -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-play text-success mr-2"></i>
                    Run Tests
                </h5>
            </div>
            <div class="card-body">
                <!-- Security Analysis -->
                <div class="test-controls">
                    <h6 class="text-primary">CLI Security Analysis</h6>
                    <p class="text-muted small mb-3">Run comprehensive security analysis with 17 CLI tools</p>
                    
                    <form id="security-test-form"
                          hx-post="/api/analysis/{{ model }}/{{ app_num }}/security"
                          hx-target="#security-results"
                          hx-indicator="#security-spinner">
                        <div class="form-group mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="use_all_tools" id="test_use_all_tools">
                                <label class="form-check-label" for="test_use_all_tools">
                                    <strong>Use All Tools (17 tools)</strong>
                                </label>
                            </div>
                        </div>
                        
                        <div class="quick-tools mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="bandit" id="test_bandit" checked>
                                <label class="form-check-label" for="test_bandit">
                                    <span class="badge badge-primary badge-sm mr-1">Py</span>Bandit
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="safety" id="test_safety" checked>
                                <label class="form-check-label" for="test_safety">
                                    <span class="badge badge-primary badge-sm mr-1">Py</span>Safety
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="eslint" id="test_eslint" checked>
                                <label class="form-check-label" for="test_eslint">
                                    <span class="badge badge-success badge-sm mr-1">JS</span>ESLint
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_quality" id="test_include_quality">
                                <label class="form-check-label" for="test_include_quality">
                                    <small>+ Quality Analysis (9 tools)</small>
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block btn-sm">
                            <i class="fas fa-shield-alt mr-1"></i>Run CLI Analysis
                        </button>
                    </form>
                    
                    <div id="security-spinner" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Running...</span>
                        </div>
                        <span class="ml-2 small">Running CLI analysis...</span>
                    </div>
                </div>

                <!-- Performance Test -->
                <div class="test-controls">
                    <h6 class="text-success">Performance Test</h6>
                    <p class="text-muted small mb-3">Load test the application endpoints</p>
                    
                    <form id="performance-test-form"
                          hx-post="/performance/{{ model }}/{{ app_num }}/run"
                          hx-target="#performance-results"
                          hx-indicator="#performance-spinner">
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="users" class="small">Users:</label>
                                    <input type="number" class="form-control form-control-sm" id="users" name="users" value="5" min="1" max="50">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="duration" class="small">Duration (s):</label>
                                    <input type="number" class="form-control form-control-sm" id="duration" name="duration" value="30" min="10" max="300">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-tachometer-alt mr-2"></i>Run Performance Test
                        </button>
                    </form>
                    
                    <div id="performance-spinner" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-success" role="status">
                            <span class="sr-only">Running...</span>
                        </div>
                        <span class="ml-2 small">Running performance test...</span>
                    </div>
                </div>

                <!-- ZAP Security Scan -->
                <div class="test-controls">
                    <h6 class="text-danger">ZAP Security Scan</h6>
                    <p class="text-muted small mb-3">Dynamic application security testing with OWASP ZAP</p>
                    
                    <form id="zap-test-form"
                          hx-post="/zap/{{ model }}/{{ app_num }}/scan"
                          hx-target="#zap-results"
                          hx-indicator="#zap-spinner">
                        <div class="form-group">
                            <label for="target_url" class="small">Target URL:</label>
                            <input type="url" 
                                   class="form-control form-control-sm" 
                                   id="target_url" 
                                   name="target_url" 
                                   value="http://localhost:{{ 9000 + (app_num * 10) }}">
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scan_type" id="quick_scan" value="quick" checked>
                                <label class="form-check-label small" for="quick_scan">Quick Scan</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scan_type" id="full_scan" value="full">
                                <label class="form-check-label small" for="full_scan">Full Scan</label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-danger btn-block">
                            <i class="fas fa-bug mr-2"></i>Start ZAP Scan
                        </button>
                    </form>
                    
                    <div id="zap-spinner" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-danger" role="status">
                            <span class="sr-only">Running...</span>
                        </div>
                        <span class="ml-2 small">Running ZAP scan...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Container Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat text-info mr-2"></i>
                    Container Status
                </h5>
            </div>
            <div class="card-body" 
                 id="container-status"
                 hx-get="/api/status/{{ model }}/{{ app_num }}"
                 hx-trigger="load, every 15s"
                 hx-target="this">
                <div class="text-center py-3">
                    <div class="spinner-border text-info" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted small">Loading status...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line text-primary mr-2"></i>
                    Test Results
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary"
                            hx-get="/api/tests/{{ model }}/{{ app_num }}/refresh"
                            hx-target="#all-results"
                            hx-indicator="#results-spinner">
                        <i class="fas fa-sync mr-1"></i>Refresh All
                    </button>
                    <button class="btn btn-outline-secondary"
                            hx-post="/api/tests/{{ model }}/{{ app_num }}/save"
                            hx-target="#save-status"
                            hx-indicator="#save-spinner">
                        <i class="fas fa-save mr-1"></i>Save Results
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="results-spinner" class="htmx-indicator text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Refreshing all results...</p>
                </div>
                
                <div id="save-spinner" class="htmx-indicator">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-save mr-2"></i>Saving test results...
                    </div>
                </div>
                
                <div id="save-status"></div>
                
                <div id="all-results">
                    <!-- Security Results -->
                    <div id="security-results" class="mb-4">
                        <h6 class="text-primary">
                            <i class="fas fa-shield-alt mr-2"></i>Security Analysis Results
                        </h6>
                        <div class="alert alert-light border text-center" role="alert">
                            <i class="fas fa-shield-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No security analysis results yet. Run a security scan to see results.</p>
                        </div>
                    </div>

                    <!-- Performance Results -->
                    <div id="performance-results" class="mb-4">
                        <h6 class="text-success">
                            <i class="fas fa-tachometer-alt mr-2"></i>Performance Test Results
                        </h6>
                        <div class="alert alert-light border text-center" role="alert">
                            <i class="fas fa-tachometer-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No performance test results yet. Run a performance test to see results.</p>
                        </div>
                    </div>

                    <!-- ZAP Results -->
                    <div id="zap-results" class="mb-4">
                        <h6 class="text-danger">
                            <i class="fas fa-bug mr-2"></i>ZAP Scan Results
                        </h6>
                        <div class="alert alert-light border text-center" role="alert">
                            <i class="fas fa-bug fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No ZAP scan results yet. Start a ZAP scan to see results.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.test-controls {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid;
}

.test-controls:first-child { border-left-color: #007bff; }
.test-controls:nth-child(2) { border-left-color: #28a745; }
.test-controls:nth-child(3) { border-left-color: #dc3545; }

.quick-action-btn {
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.analysis-card {
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
}

.analysis-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.test-results {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.75rem;
    background: #ffffff;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
}

.test-results pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.htmx-indicator {
    display: none;
}

.badge-sm {
    font-size: 0.6rem;
    padding: 0.2rem 0.4rem;
}

.quick-tools .form-check {
    margin-bottom: 0.3rem;
}

.quick-tools .form-check-label {
    font-size: 0.9rem;
}
</style>

<script>
// Handle test form interactions
document.addEventListener('DOMContentLoaded', function() {
    // Handle "Use All Tools" toggle in test form
    const testUseAllTools = document.getElementById('test_use_all_tools');
    const testToolCheckboxes = document.querySelectorAll('#security-test-form input[type="checkbox"]:not(#test_use_all_tools):not(#test_include_quality)');
    const testIncludeQuality = document.getElementById('test_include_quality');
    
    if (testUseAllTools) {
        testUseAllTools.addEventListener('change', function() {
            testToolCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                checkbox.disabled = this.checked;
            });
            
            if (this.checked) {
                testIncludeQuality.checked = true;
                testIncludeQuality.disabled = true;
            } else {
                testIncludeQuality.disabled = false;
            }
        });
    }
    
    // Handle individual tool changes
    testToolCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked && testUseAllTools) {
                testUseAllTools.checked = false;
            }
        });
    });
});

// Auto-refresh all results
function refreshAllResults() {
    const refreshSpinner = document.getElementById('results-spinner');
    if (refreshSpinner) {
        refreshSpinner.style.display = 'block';
    }
    
    // Refresh security results
    htmx.ajax('GET', `/api/analysis/{{ model }}/{{ app_num }}/results`, {
        target: '#security-results'
    });
    
    // Refresh container status
    htmx.ajax('GET', `/api/status/{{ model }}/{{ app_num }}`, {
        target: '#container-status'
    });
    
    setTimeout(() => {
        if (refreshSpinner) {
            refreshSpinner.style.display = 'none';
        }
    }, 2000);
}

// Save all results
function saveAllResults() {
    const saveSpinner = document.getElementById('save-spinner');
    const saveStatus = document.getElementById('save-status');
    
    if (saveSpinner) {
        saveSpinner.style.display = 'block';
    }
    
    // This would trigger saving of current results to database
    // For now, show a confirmation
    setTimeout(() => {
        if (saveSpinner) {
            saveSpinner.style.display = 'none';
        }
        if (saveStatus) {
            saveStatus.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check mr-2"></i>Analysis results saved successfully!
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
        }
    }, 1500);
}
</script>
{% endblock %}
