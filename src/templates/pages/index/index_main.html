{% extends "layouts/base.html" %}
{% set active_page = 'dashboard' %}
{% set page_title = 'Dashboard' %}
{% set page_icon = 'home' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div id="dashboard-wrapper" class="w-100">
  <!-- Page content -->
    <div id="summary-region"
         hx-get="/api/dashboard/fragments/summary-cards"
         hx-trigger="load, every 60s, refresh"
         hx-target="this"
         hx-swap="outerHTML">
      <!-- Loading placeholders -->
      <div class="row row-cards g-2 mb-3">
        {% for _ in range(4) %}
        <div class="col-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="placeholder-glow">
                <div class="placeholder col-4"></div>
                <div class="placeholder col-6"></div>
                <div class="placeholder col-8"></div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="row row-cards g-2">
      <div class="col-lg-8">
        <div class="row row-cards g-2">
          <div class="col-12">
            <div class="card card-table-compact">
              <div class="card-header d-flex flex-wrap align-items-center gap-3">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <h3 class="card-title d-flex align-items-center gap-2 mb-0">
                    <i class="fas fa-server"></i>
                    <span>System Status</span>
                  </h3>
                </div>
                <div class="card-actions d-flex flex-wrap align-items-center gap-2 ms-auto">
                  <div class="btn-list">
                    <button class="btn btn-sm btn-ghost-primary btn-icon" 
                            _="on click send refresh to #system-status-region" 
                            aria-label="Refresh system status"
                            title="Refresh system status">
                      <i class="fas fa-sync" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="table-responsive" id="system-status-region"
                   hx-get="/api/dashboard/fragments/system-status"
                   hx-trigger="load, every 45s, refresh"
                   hx-target="this"
                   hx-swap="outerHTML">
                <div class="text-center text-muted py-4">Checking services…</div>
              </div>
            </div>
          </div>


        </div>
      </div>

      <div class="col-lg-4">
        <div class="row row-cards g-2">
          <div class="col-12">
            <div class="card card-table-compact">
              <div class="card-header d-flex flex-wrap align-items-center gap-3">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <h3 class="card-title d-flex align-items-center gap-2 mb-0">
                    <i class="fas fa-cogs"></i>
                    <span>System Administration</span>
                  </h3>
                </div>
                <div class="card-actions d-flex flex-wrap align-items-center gap-2 ms-auto">
                  <div class="btn-list">
                    <button class="btn btn-sm btn-ghost-primary btn-icon" 
                            onclick="refreshSystemInfo()" 
                            aria-label="Refresh system information"
                            title="Refresh system information">
                      <i class="fas fa-sync" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body p-2">
                <div class="row g-2">
                  <div class="col-6">
                    <button class="btn btn-sm w-100 btn-ghost-secondary d-flex align-items-center justify-content-start" onclick="refreshAllData()" title="Refresh All Data">
                      <i class="fas fa-sync text-info me-2"></i> Refresh
                    </button>
                  </div>
                  <div class="col-6">
                    <button class="btn btn-sm w-100 btn-ghost-secondary d-flex align-items-center justify-content-start" onclick="syncModels()" title="Sync Models">
                      <i class="fas fa-cloud-download-alt text-primary me-2"></i> Sync Models
                    </button>
                  </div>
                  <div class="col-6">
                    <button class="btn btn-sm w-100 btn-ghost-secondary d-flex align-items-center justify-content-start" onclick="clearLocalStorage()" title="Clear Cache">
                      <i class="fas fa-eraser text-warning me-2"></i> Clear Cache
                    </button>
                  </div>
                  <div class="col-6">
                    <button class="btn btn-sm w-100 btn-ghost-secondary d-flex align-items-center justify-content-start" onclick="downloadSystemInfo()" title="System Info">
                      <i class="fas fa-download text-success me-2"></i> System Info
                    </button>
                  </div>
                  <div class="col-12">
                    <button class="btn btn-sm w-100 btn-ghost-secondary d-flex align-items-center justify-content-start" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts">
                      <i class="fas fa-keyboard text-secondary me-2"></i> Keyboard Shortcuts
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Dashboard refresh functionality using hyperscript -->
<script type="text/hyperscript">
  def refreshDashboardSections()
    send refresh to #summary-region
    send refresh to #system-status-region  
  end
</script>

<!-- Dashboard action functions -->
<script>
// Analysis actions
function downloadAnalysisResults(analysisId) {
  window.open(`/api/analysis/${analysisId}/export`, '_blank');
}

function retryAnalysis(analysisId) {
  if (!confirm('Retry this analysis?')) return;
  
  fetch(`/api/analysis/${analysisId}/retry`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showDashboardNotification('Analysis retry started', 'success');
        setTimeout(() => {
          htmx.trigger('#analyses-region', 'refresh');
        }, 1000);
      } else {
        showDashboardNotification(`Retry failed: ${data.error}`, 'danger');
      }
    })
    .catch(error => {
      showDashboardNotification(`Retry failed: ${error.message}`, 'danger');
    });
}

// Application actions
function startApplication(modelSlug, appNumber) {
  const button = event.target.closest('button');
  if (!button) return;
  
  const originalHtml = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  fetch(`/api/app/${modelSlug}/${appNumber}/start`, { method: 'POST' })
    .then(resp => {
      if (resp.ok) {
        showDashboardNotification('Application started successfully', 'success');
        setTimeout(() => {
          htmx.trigger('#apps-region', 'refresh');
        }, 1000);
      } else {
        throw new Error(`HTTP ${resp.status}`);
      }
    })
    .catch(err => {
      showDashboardNotification(`Start failed: ${err.message}`, 'danger');
    })
    .finally(() => {
      button.disabled = false;
      button.innerHTML = originalHtml;
    });
}

// Simple Administration Functions (Minimal Backend Integration)

// Quick Actions
function refreshAllData() {
  showDashboardNotification('Refreshing all dashboard data...', 'info');
  // Use existing HTMX refresh functionality
  htmx.trigger('#summary-region', 'refresh');
  htmx.trigger('#system-status-region', 'refresh');
  showDashboardNotification('Dashboard data refreshed', 'success');
}

function syncModels() {
  const btn = event.target.closest('button');
  const originalHTML = btn.innerHTML;
  
  // Show loading state
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Syncing...';
  
  showDashboardNotification('Syncing models from OpenRouter...', 'info');
  
  // Use existing API endpoint
  fetch('/api/models/load-openrouter', { method: 'POST' })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || `HTTP ${response.status}`);
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success || data.upserted !== undefined) {
        const upserted = data.upserted || 0;
        const fetched = data.fetched || 0;
        showDashboardNotification(`✓ Models synced successfully: ${upserted} updated from ${fetched} fetched`, 'success');
        
        // Refresh relevant dashboard sections
        if (window.refreshAllSections) {
          setTimeout(() => refreshAllSections(), 1000);
        }
      } else {
        showDashboardNotification(`Sync failed: ${data.error || 'Unknown error'}`, 'danger');
      }
    })
    .catch(error => {
      console.error('Model sync error:', error);
      showDashboardNotification(`Sync failed: ${error.message}`, 'danger');
    })
    .finally(() => {
      // Restore button state
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    });
}

function clearLocalStorage() {
  if (confirm('Clear all browser cache and UI settings? This will reset your interface preferences.')) {
    // Clear localStorage
    try {
      localStorage.clear();
      showDashboardNotification('Browser cache cleared successfully', 'success');
      
      // Optional: Also clear sessionStorage
      sessionStorage.clear();
      
      // Refresh page to reset UI state
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (error) {
      showDashboardNotification('Failed to clear browser cache', 'warning');
    }
  }
}

function downloadSystemInfo() {
  // Collect system information that's already available
  const systemInfo = {
    timestamp: new Date().toISOString(),
    url: window.location.href,
    userAgent: navigator.userAgent,
    screen: {
      width: screen.width,
      height: screen.height,
      colorDepth: screen.colorDepth
    },
    window: {
      innerWidth: window.innerWidth,
      innerHeight: window.innerHeight
    },
    localStorage: {
      itemCount: localStorage.length,
      keys: Object.keys(localStorage)
    },
    performance: {
      timing: performance.timing,
      navigation: performance.navigation
    }
  };
  
  // Create and download JSON file
  const dataStr = JSON.stringify(systemInfo, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  
  const url = window.URL.createObjectURL(dataBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `system_info_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showDashboardNotification('System info downloaded', 'success');
}

function showKeyboardShortcuts() {
  const shortcuts = [
    { keys: 'Ctrl + /', description: 'Toggle this help' },
    { keys: 'Ctrl + R', description: 'Refresh page' },
    { keys: 'Ctrl + Shift + R', description: 'Hard refresh (clear cache)' },
    { keys: 'F5', description: 'Refresh page' },
    { keys: 'Ctrl + F', description: 'Search on page' },
    { keys: 'Ctrl + D', description: 'Bookmark page' },
    { keys: 'Ctrl + T', description: 'New tab' },
    { keys: 'Ctrl + W', description: 'Close tab' },
    { keys: 'Ctrl + Tab', description: 'Switch tabs' },
    { keys: 'F12', description: 'Developer tools' }
  ];
  
  let shortcutsHtml = '<div class="modal fade" id="keyboardShortcutsModal" tabindex="-1">';
  shortcutsHtml += '<div class="modal-dialog"><div class="modal-content">';
  shortcutsHtml += '<div class="modal-header">';
  shortcutsHtml += '<h5 class="modal-title"><i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts</h5>';
  shortcutsHtml += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';
  shortcutsHtml += '</div><div class="modal-body">';
  shortcutsHtml += '<div class="list-group list-group-flush">';
  
  shortcuts.forEach(shortcut => {
    shortcutsHtml += `
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <span>${shortcut.description}</span>
        <kbd class="bg-muted">${shortcut.keys}</kbd>
      </div>
    `;
  });
  
  shortcutsHtml += '</div></div>';
  shortcutsHtml += '<div class="modal-footer">';
  shortcutsHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>';
  shortcutsHtml += '</div></div></div></div>';
  
  // Remove existing modal if any
  const existing = document.getElementById('keyboardShortcutsModal');
  if (existing) existing.remove();
  
  // Add new modal
  document.body.insertAdjacentHTML('beforeend', shortcutsHtml);
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('keyboardShortcutsModal'));
  modal.show();
}

// Notification helper
function showDashboardNotification(message, type = 'info') {
  console.log(`[${type.toUpperCase()}] ${message}`);
  
  // Create a toast notification
  const toastContainer = document.getElementById('toast-container') || createToastContainer();
  
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} border-0`;
  toast.setAttribute('role', 'alert');
  toast.setAttribute('aria-live', 'assertive');
  toast.setAttribute('aria-atomic', 'true');
  
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  const bsToast = new bootstrap.Toast(toast, {
    autohide: true,
    delay: type === 'danger' ? 5000 : 3000
  });
  bsToast.show();
  
  // Remove from DOM after hidden
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toast-container';
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}
</script>
{% endblock %}