<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize analysis activity chart if present
  const ctx = document.getElementById('analysis-chart');
  if (ctx && window.Chart) {
    window._dashboardChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    // Load chart data (best-effort)
    fetch('/api/dashboard/chart-data').then(r => r.json()).then(data => {
      if (window._dashboardChart && data.labels) {
        window._dashboardChart.data.labels = data.labels;
        window._dashboardChart.data.datasets = data.datasets || [];
        window._dashboardChart.update();
      }
    }).catch(() => {});
  }

  // Auto-refresh dashboard stats every 30 seconds
  setInterval(() => {
    if (window.htmx) window.htmx.ajax('GET', '/api/dashboard/stats-update', '#dashboard-stats');
  }, 30000);

  // Ensure modal cleanup
  const mainModal = document.getElementById('main-modal');
  if (mainModal) mainModal.addEventListener('hidden.bs.modal', function() { this.querySelector('.modal-content').innerHTML = ''; });
});

async function reloadCoreData(btn) {
  const orig = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Reloading...';
  try {
    const resp = await fetch('/api/data/reload', { method: 'POST' });
    const data = await resp.json().catch(() => ({}));
    const ok = resp.ok && data.success !== false;
    const msg = ok ? 'Data reloaded.' : 'Reload completed with warnings.';
    const el = document.createElement('div');
    el.className = 'alert ' + (ok ? 'alert-success' : 'alert-warning');
    el.style.position = 'fixed'; el.style.top = '70px'; el.style.right = '20px'; el.style.zIndex = '1080';
    el.textContent = msg; document.body.appendChild(el); setTimeout(() => el.remove(), 2500);
    if (window.htmx) {
      window.htmx.ajax('GET', '/api/dashboard/stats-update', '#dashboard-stats');
      window.htmx.ajax('GET', '/api/dashboard/system-health-fragment', '#system-health-content');
    }
  } catch (e) {
    const el = document.createElement('div'); el.className = 'alert alert-danger'; el.style.position = 'fixed'; el.style.top = '70px'; el.style.right = '20px'; el.style.zIndex = '1080'; el.textContent = 'Error reloading data: ' + e; document.body.appendChild(el); setTimeout(() => el.remove(), 3000);
  } finally { btn.disabled = false; btn.innerHTML = orig; }
}
</script>
