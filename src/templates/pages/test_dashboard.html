{% extends "base.html" %}

{% block title %}Test Management Dashboard - Testing Platform{% endblock %}

{% block extra_css %}
<style>
/* Service status indicators */
.service-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.status-healthy { background: #28a745; }
.status-degraded { background: #ffc107; }
.status-unhealthy { background: #dc3545; }
.status-unknown { background: #6c757d; }

/* Statistics cards */
.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Active tests */
.test-progress {
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.test-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
}

/* Test history table */
.test-history-table {
    font-size: 0.9rem;
}

.test-status-badge {
    font-size: 0.75rem;
}

/* Service logs */
.service-logs {
    background: #212529;
    color: #ffffff;
    border-radius: 5px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    max-height: 400px;
    overflow-y: auto;
}

.log-entry {
    margin-bottom: 5px;
    white-space: pre-wrap;
}

.log-timestamp {
    color: #6c757d;
}

.log-level-error { color: #dc3545; }
.log-level-warning { color: #ffc107; }
.log-level-info { color: #17a2b8; }
.log-level-debug { color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-tachometer-alt text-primary me-2"></i>
                        Test Management Dashboard
                    </h1>
                    <p class="text-muted mb-0">Monitor active tests, service health, and testing statistics</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('testing.test_creation_page') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>New Test
                    </a>
                    <button class="btn btn-outline-secondary" 
                            hx-get="/testing/api/infrastructure-status"
                            hx-target="#service-status-panel"
                            hx-swap="innerHTML">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Management Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-server me-2"></i>Service Management
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" 
                                    hx-post="/testing/api/infrastructure/start"
                                    hx-target="#service-status-panel"
                                    hx-swap="innerHTML">
                                <i class="fas fa-play me-1"></i>Start All
                            </button>
                            <button class="btn btn-sm btn-warning" 
                                    hx-post="/testing/api/infrastructure/restart"
                                    hx-target="#service-status-panel"
                                    hx-swap="innerHTML">
                                <i class="fas fa-redo me-1"></i>Restart All
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    hx-post="/testing/api/infrastructure/stop"
                                    hx-target="#service-status-panel"
                                    hx-swap="innerHTML">
                                <i class="fas fa-stop me-1"></i>Stop All
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="service-status-panel"
                         hx-get="/testing/api/service-status"
                         hx-trigger="load, every 30s"
                         hx-swap="innerHTML">
                        <!-- Service Status Panel for Test Dashboard -->
                        <div class="row mb-4">
                            {% if infrastructure_health %}
                                {% for service_name, service_data in infrastructure_health.services.items() %}
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <div class="service-status mb-2">
                                                <span class="status-indicator 
                                                    {% if service_data.status == 'healthy' %}status-healthy
                                                    {% elif service_data.status == 'degraded' %}status-degraded
                                                    {% elif service_data.status == 'unhealthy' %}status-unhealthy
                                                    {% else %}status-unknown{% endif %}"></span>
                                                <span class="fw-bold">{{ service_name.replace('_', ' ').title() }}</span>
                                            </div>
                                            <p class="small mb-1 text-muted">
                                                Status: 
                                                <span class="
                                                    {% if service_data.status == 'healthy' %}text-success
                                                    {% elif service_data.status == 'degraded' %}text-warning
                                                    {% elif service_data.status == 'unhealthy' %}text-danger
                                                    {% else %}text-secondary{% endif %}">
                                                    {{ service_data.status|title }}
                                                </span>
                                            </p>
                                            {% if service_data.get('port') %}
                                            <p class="small mb-1 text-muted">Port: {{ service_data.port }}</p>
                                            {% endif %}
                                            {% if service_data.get('uptime') %}
                                            <p class="small mb-1 text-muted">Uptime: {{ service_data.uptime }}</p>
                                            {% endif %}
                                            {% if service_data.get('cpu_usage') %}
                                            <p class="small mb-1 text-muted">CPU: {{ service_data.cpu_usage }}%</p>
                                            {% endif %}
                                            {% if service_data.get('memory_usage') %}
                                            <p class="small mb-0 text-muted">Memory: {{ service_data.memory_usage }}MB</p>
                                            {% endif %}
                                        </div>
                                        <div class="card-footer">
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        hx-post="/testing/api/service/{{ service_name }}/restart"
                                                        hx-target="#service-status-{{ service_name }}"
                                                        title="Restart Service">
                                                    <i class="fas fa-redo-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info" 
                                                        onclick="showServiceLogs('{{ service_name }}')"
                                                        title="View Logs">
                                                    <i class="fas fa-file-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                        hx-get="/testing/api/service/{{ service_name }}/stats"
                                                        hx-target="#service-stats-{{ service_name }}"
                                                        title="View Stats">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-warning" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Unable to retrieve infrastructure health status. Services may be unavailable.
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Overall Health Indicator -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">Infrastructure Health</h6>
                                                <p class="mb-0 text-muted">Overall system status</p>
                                            </div>
                                            <div class="text-end">
                                                {% set health_score = infrastructure_health.overall_health if infrastructure_health else 0 %}
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <div class="progress" style="width: 100px; height: 8px;">
                                                            <div class="progress-bar 
                                                                {% if health_score >= 80 %}bg-success
                                                                {% elif health_score >= 60 %}bg-warning
                                                                {% else %}bg-danger{% endif %}" 
                                                                style="width: {{ health_score }}%"></div>
                                                        </div>
                                                    </div>
                                                    <span class="fw-bold 
                                                        {% if health_score >= 80 %}text-success
                                                        {% elif health_score >= 60 %}text-warning
                                                        {% else %}text-danger{% endif %}">
                                                        {{ health_score }}%
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ stats.total_jobs }}</div>
                <div class="metric-label">Total Tests</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ stats.running_jobs }}</div>
                <div class="metric-label">Active Tests</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ stats.completed_jobs }}</div>
                <div class="metric-label">Completed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ stats.success_rate }}%</div>
                <div class="metric-label">Success Rate</div>
            </div>
        </div>
    </div>

    <!-- Active Tests Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle text-success me-2"></i>Active Tests
                        </h5>
                        <span class="badge bg-primary">{{ active_tests|length }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="active-tests-panel"
                         hx-get="/testing/api/active-tests"
                         hx-trigger="load, every 5s"
                         hx-swap="innerHTML">
                        {% if active_tests %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Test ID</th>
                                        <th>Application</th>
                                        <th>Type</th>
                                        <th>Progress</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for test in active_tests %}
                                    <tr>
                                        <td>
                                            <code>#{{ test.id }}</code>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ test.model_slug }}</strong><br>
                                                <small class="text-muted">App {{ test.app_number }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ test.type_color }}">
                                                {{ test.test_type|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     role="progressbar" 
                                                     style="width: {{ test.progress }}%"
                                                     aria-valuenow="{{ test.progress }}"
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {{ test.progress }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <small>{{ test.duration }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary"
                                                        onclick="showTestDetails('{{ test.id }}')"
                                                        title="View Details">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <button class="btn btn-outline-danger"
                                                        onclick="cancelTest('{{ test.id }}')"
                                                        title="Cancel Test">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-info-circle fs-1 mb-3"></i>
                            <p>No active tests running</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Test History
                        </h5>
                        <div class="d-flex gap-2">
                            <!-- Filter Controls -->
                            <select class="form-select form-select-sm" 
                                    hx-get="/testing/api/test-history"
                                    hx-trigger="change"
                                    hx-target="#test-history-panel"
                                    hx-include="[name='status'],[name='type'],[name='limit']"
                                    name="status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="running">Running</option>
                                <option value="failed">Failed</option>
                                <option value="pending">Pending</option>
                            </select>
                            <select class="form-select form-select-sm"
                                    hx-get="/testing/api/test-history"
                                    hx-trigger="change"
                                    hx-target="#test-history-panel"
                                    hx-include="[name='status'],[name='type'],[name='limit']"
                                    name="type" style="width: auto;">
                                <option value="">All Types</option>
                                <option value="security">Security</option>
                                <option value="performance">Performance</option>
                                <option value="zap">ZAP Scan</option>
                                <option value="ai">AI Analysis</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary"
                                    hx-get="/testing/api/export-results"
                                    hx-include="[name='status'],[name='type']">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="test-history-panel"
                         hx-get="/testing/api/test-history"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        {% if tests %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input" onclick="toggleAllTests(this)">
                                        </th>
                                        <th>Test ID</th>
                                        <th>Application</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Started</th>
                                        <th>Duration</th>
                                        <th>Results</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for test in tests %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input" name="selected_tests" value="{{ test.id }}">
                                        </td>
                                        <td><code>#{{ test.id }}</code></td>
                                        <td>
                                            <div>
                                                <strong>{{ test.model_slug }}</strong><br>
                                                <small class="text-muted">App {{ test.app_number }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ test.type_color }}">
                                                {{ test.test_type|title }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if test.status == 'completed' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i>Completed
                                                </span>
                                            {% elif test.status == 'failed' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times-circle me-1"></i>Failed
                                                </span>
                                            {% elif test.status == 'running' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>Running
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-clock me-1"></i>{{ test.status|title }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ test.started_at.strftime('%Y-%m-%d %H:%M') if test.started_at else 'N/A' }}</small>
                                        </td>
                                        <td>
                                            <small>{{ test.duration or '-' }}</small>
                                        </td>
                                        <td>
                                            {% if test.status == 'completed' %}
                                                {% if test.test_type == 'security' %}
                                                    <span class="text-danger">
                                                        <i class="fas fa-bug"></i> {{ test.vulnerabilities_count }} issues
                                                    </span>
                                                {% elif test.test_type == 'performance' %}
                                                    <span class="text-info">
                                                        <i class="fas fa-tachometer-alt"></i> {{ test.avg_response_time }}ms
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('testing.test_results_page', test_id=test.id) }}" 
                                                   class="btn btn-outline-primary" title="View Report">
                                                    <i class="fas fa-file-alt"></i>
                                                </a>
                                                {% if test.status == 'completed' or test.status == 'failed' %}
                                                <button class="btn btn-outline-success"
                                                        onclick="restartTest('{{ test.id }}')"
                                                        title="Rerun Test">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-outline-danger"
                                                        onclick="deleteTest('{{ test.id }}')"
                                                        title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Batch Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="selectAllTests()">Select All</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllTests()">Deselect All</button>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="batchExportTests()">
                                    <i class="fas fa-download me-1"></i>Export Selected
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="batchDeleteTests()">
                                    <i class="fas fa-trash me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-history fs-1 mb-3"></i>
                            <p>No test history available</p>
                            <a href="{{ url_for('testing.test_creation_page') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Your First Test
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Logs Modal -->
    <div class="modal fade" id="serviceLogsModal" tabindex="-1" aria-labelledby="serviceLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceLogsModalLabel">Service Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="service-logs-content">
                        <!-- Logs will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    <!-- Service Logs Modal -->
    <div class="modal fade" id="serviceLogsModal" tabindex="-1" aria-labelledby="serviceLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceLogsModalLabel">Service Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="service-logs-content">
                        <!-- Logs content will be loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Details Modal -->
    <div class="modal fade" id="testDetailsModal" tabindex="-1" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testDetailsModalLabel">Test Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="test-details-content">
                        <!-- Test details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Container for HTMX -->
    <div id="modal-container"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Service logs functionality
function showServiceLogs(serviceName) {
    document.getElementById('serviceLogsModalLabel').textContent = `${serviceName} Logs`;
    
    htmx.ajax('GET', `/testing/api/service-logs/${serviceName}`, {
        target: '#service-logs-content',
        swap: 'innerHTML'
    });
    
    const modal = new bootstrap.Modal(document.getElementById('serviceLogsModal'));
    modal.show();
}

function refreshLogs() {
    const serviceName = document.getElementById('serviceLogsModalLabel').textContent.replace(' Logs', '');
    
    htmx.ajax('GET', `/testing/api/service-logs/${serviceName}`, {
        target: '#service-logs-content',
        swap: 'innerHTML'
    });
}

// Test management functions
function cancelTest(testId) {
    if (confirm('Are you sure you want to cancel this test?')) {
        htmx.ajax('POST', `/testing/api/job/${testId}/cancel`, {
            target: '#active-tests-panel',
            swap: 'innerHTML'
        });
    }
}

function restartTest(testId) {
    if (confirm('Are you sure you want to restart this test?')) {
        htmx.ajax('POST', `/testing/api/job/${testId}/restart`, {
            target: '#active-tests-panel',
            swap: 'innerHTML'
        });
    }
}

function deleteTest(testId) {
    if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
        htmx.ajax('DELETE', `/testing/api/job/${testId}`, {
            target: '#test-history-panel',
            swap: 'innerHTML'
        });
    }
}

function showTestDetails(testId) {
    htmx.ajax('GET', `/testing/api/job/${testId}/details`, {
        target: '#modal-container',
        swap: 'innerHTML'
    });
    
    // Show modal if it exists
    const modal = document.getElementById('testDetailsModal');
    if (modal) {
        new bootstrap.Modal(modal).show();
    }
}

function toggleAllTests(checkbox) {
    const testCheckboxes = document.querySelectorAll('input[name="selected_tests"]');
    testCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}

// Auto-refresh functionality
let autoRefreshInterval;

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        // Refresh active tests
        htmx.ajax('GET', '/testing/api/active-tests', {
            target: '#active-tests-panel',
            swap: 'innerHTML'
        });
        
        // Refresh service status
        htmx.ajax('GET', '/testing/api/service-status', {
            target: '#service-status-panel',
            swap: 'innerHTML'
        });
    }, 10000); // Refresh every 10 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});

// Batch operations
function selectAllTests() {
    const checkboxes = document.querySelectorAll('input[name="selected_tests"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function deselectAllTests() {
    const checkboxes = document.querySelectorAll('input[name="selected_tests"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

function batchDeleteTests() {
    const selectedTests = Array.from(document.querySelectorAll('input[name="selected_tests"]:checked'))
                              .map(checkbox => checkbox.value);
    
    if (selectedTests.length === 0) {
        alert('Please select tests to delete.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedTests.length} selected tests?`)) {
        htmx.ajax('POST', '/testing/api/batch-delete', {
            values: { test_ids: selectedTests },
            target: '#test-history-panel',
            swap: 'innerHTML'
        });
    }
}

function batchExportTests() {
    const selectedTests = Array.from(document.querySelectorAll('input[name="selected_tests"]:checked'))
                              .map(checkbox => checkbox.value);
    
    if (selectedTests.length === 0) {
        alert('Please select tests to export.');
        return;
    }
    
    // Create a form and submit for download
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/testing/api/batch-export';
    
    selectedTests.forEach(testId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'test_ids';
        input.value = testId;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}
</script>
{% endblock %}
