{% extends "pages/app_base.html" %}

{% block page_content %}
<div class="row">
    <!-- Security Analysis Controls -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt text-primary mr-2"></i>
                    Security Analysis
                </h5>
            </div>
            <div class="card-body">
                <!-- Security Analysis Form -->
                <form id="security-analysis-form" 
                      hx-post="/api/analysis/{{ model }}/{{ app_num }}/security"
                      hx-target="#security-analysis-results"
                      hx-indicator="#security-analysis-spinner"
                      class="mb-4">
                    
                    <div class="form-group mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="use_all_tools" id="use_all_tools">
                            <label class="form-check-label font-weight-bold" for="use_all_tools">
                                <i class="fas fa-rocket mr-1"></i>Use All Available Tools (17 tools)
                            </label>
                        </div>
                        <small class="text-muted">Enable comprehensive analysis with all security and quality tools</small>
                    </div>

                    <!-- Backend Security Tools -->
                    <div class="tool-category mb-3">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-server mr-1"></i>Backend Security (4 tools)
                        </h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="bandit" id="bandit" checked>
                            <label class="form-check-label" for="bandit">
                                <span class="badge badge-primary mr-1">Python</span>Bandit - Security Linter
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="safety" id="safety" checked>
                            <label class="form-check-label" for="safety">
                                <span class="badge badge-primary mr-1">Python</span>Safety - Dependency Vulnerabilities
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="pylint" id="pylint">
                            <label class="form-check-label" for="pylint">
                                <span class="badge badge-primary mr-1">Python</span>Pylint - Code Analysis
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="vulture" id="vulture">
                            <label class="form-check-label" for="vulture">
                                <span class="badge badge-primary mr-1">Python</span>Vulture - Dead Code Detection
                            </label>
                        </div>
                    </div>

                    <!-- Frontend Security Tools -->
                    <div class="tool-category mb-3">
                        <h6 class="text-success mb-2">
                            <i class="fas fa-desktop mr-1"></i>Frontend Security (4 tools)
                        </h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="eslint" id="eslint" checked>
                            <label class="form-check-label" for="eslint">
                                <span class="badge badge-success mr-1">JS/TS</span>ESLint - Security Rules
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="retire" id="retire">
                            <label class="form-check-label" for="retire">
                                <span class="badge badge-success mr-1">JS</span>Retire.js - Vulnerable Libraries
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="snyk" id="snyk">
                            <label class="form-check-label" for="snyk">
                                <span class="badge badge-success mr-1">Multi</span>Snyk - Vulnerability Scanner
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="jshint" id="jshint">
                            <label class="form-check-label" for="jshint">
                                <span class="badge badge-success mr-1">JS</span>JSHint - Code Quality
                            </label>
                        </div>
                    </div>

                    <!-- Quality Analysis Toggle -->
                    <div class="form-group mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="include_quality" id="include_quality">
                            <label class="form-check-label font-weight-bold" for="include_quality">
                                <i class="fas fa-code mr-1"></i>Include Code Quality Analysis (9 additional tools)
                            </label>
                        </div>
                        <small class="text-muted">Add backend quality (6 tools) and frontend quality (3 tools) analysis</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-play mr-2"></i>
                        Run CLI Analysis
                    </button>
                </form>
                
                <!-- Loading Indicator -->
                <div id="security-analysis-spinner" class="htmx-indicator text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Analyzing...</span>
                    </div>
                    <p class="mt-2 text-muted">Running security analysis...</p>
                </div>
                
                <!-- Security Analysis Results -->
                <div id="security-analysis-results">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- ZAP Security Scan -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bug text-danger mr-2"></i>
                    ZAP Security Scan
                </h5>
            </div>
            <div class="card-body">
                <!-- ZAP Scan Form -->
                <form id="zap-scan-form" 
                      hx-post="/api/analysis/{{ model }}/{{ app_num }}/zap"
                      hx-target="#zap-scan-results"
                      hx-indicator="#zap-scan-spinner"
                      class="mb-4">
                    <div class="form-group">
                        <label for="scan_type" class="form-label">Scan Type</label>
                        <select class="form-control" name="scan_type" id="scan_type">
                            <option value="spider">Spider Scan (Fast)</option>
                            <option value="active">Active Scan (Thorough)</option>
                            <option value="baseline">Baseline Scan (Balanced)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-danger btn-block">
                        <i class="fas fa-search mr-2"></i>
                        Start ZAP Scan
                    </button>
                </form>
                
                <!-- ZAP Loading Indicator -->
                <div id="zap-scan-spinner" class="htmx-indicator text-center py-3">
                    <div class="spinner-border text-danger" role="status">
                        <span class="sr-only">Scanning...</span>
                    </div>
                    <p class="mt-2 text-muted">Running ZAP security scan...</p>
                </div>
                
                <!-- ZAP Scan Results -->
                <div id="zap-scan-results">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line text-success mr-2"></i>
                    Analysis Results
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshResults()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportResults()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Results Overview -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light border-left-primary">
                            <div class="card-body py-3">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Security Issues
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <span id="security-issues-count">-</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-shield-alt fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card bg-light border-left-warning">
                            <div class="card-body py-3">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Vulnerabilities
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <span id="vulnerabilities-count">-</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card bg-light border-left-success">
                            <div class="card-body py-3">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Last Scan
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <span id="last-scan-time">Never</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Results -->
                <div id="detailed-results">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h5>No Analysis Results</h5>
                        <p>Run a security analysis or ZAP scan to see results here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.text-xs {
    font-size: 0.7rem;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}

.htmx-indicator {
    display: none;
}

.form-check {
    margin-bottom: 0.5rem;
}

.tool-category {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 0.75rem;
    border-left: 4px solid #007bff;
}

.tool-category:nth-child(3) {
    border-left-color: #28a745;
}

.tool-category h6 {
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.badge {
    font-size: 0.7rem;
    font-weight: 500;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.analysis-result-item {
    border-left: 4px solid #6c757d;
    background: #f8f9fa;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 0.375rem;
}

.analysis-result-item.severity-high {
    border-left-color: #dc3545;
    background: #f8d7da;
}

.analysis-result-item.severity-medium {
    border-left-color: #ffc107;
    background: #fff3cd;
}

.analysis-result-item.severity-low {
    border-left-color: #17a2b8;
    background: #d1ecf1;
}

.issue-count-badge {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
    font-weight: 600;
}
</style>

<script>
// Tool selection management
document.addEventListener('DOMContentLoaded', function() {
    const useAllTools = document.getElementById('use_all_tools');
    const includeQuality = document.getElementById('include_quality');
    const toolCheckboxes = document.querySelectorAll('input[type="checkbox"]:not(#use_all_tools):not(#include_quality)');
    
    // Handle "Use All Tools" toggle
    useAllTools.addEventListener('change', function() {
        toolCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            checkbox.disabled = this.checked;
        });
        
        if (this.checked) {
            includeQuality.checked = true;
            includeQuality.disabled = true;
        } else {
            includeQuality.disabled = false;
        }
    });
    
    // Handle individual tool changes
    toolCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked) {
                useAllTools.checked = false;
            }
        });
    });
    
    // Update tool count display
    function updateToolCount() {
        const checkedTools = document.querySelectorAll('input[type="checkbox"]:checked:not(#use_all_tools):not(#include_quality)').length;
        const qualityBonus = includeQuality.checked ? 9 : 0;
        const totalTools = useAllTools.checked ? 17 : checkedTools + qualityBonus;
        
        const button = document.querySelector('#security-analysis-form button[type="submit"]');
        button.innerHTML = `<i class="fas fa-play mr-2"></i>Run CLI Analysis (${totalTools} tools)`;
    }
    
    // Listen for changes
    document.addEventListener('change', updateToolCount);
    updateToolCount(); // Initial count
});

function refreshResults() {
    // Refresh both the main results and update counts
    htmx.ajax('GET', `/api/analysis/{{ model }}/{{ app_num }}/results`, {
        target: '#detailed-results'
    }).then(() => {
        updateResultCounts();
    });
}

function exportResults() {
    // Export the current analysis results
    window.location.href = `/api/analysis/{{ model }}/{{ app_num }}/export`;
}

// Update counts when analysis completes
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'security-analysis-results' || 
        event.detail.target.id === 'zap-scan-results') {
        setTimeout(updateResultCounts, 500); // Small delay to ensure DOM is updated
    }
});

function updateResultCounts() {
    // Try to extract counts from the results
    const resultsContainer = document.getElementById('security-analysis-results');
    
    if (resultsContainer && resultsContainer.innerHTML.trim()) {
        // Count issues from the results
        const issueElements = resultsContainer.querySelectorAll('.analysis-result-item, .issue-item');
        const securityCount = issueElements.length;
        
        // Count vulnerabilities (high and medium severity)
        const vulnerabilityElements = resultsContainer.querySelectorAll('.severity-high, .severity-medium');
        const vulnerabilityCount = vulnerabilityElements.length;
        
        // Update the counters
        document.getElementById('security-issues-count').textContent = securityCount;
        document.getElementById('vulnerabilities-count').textContent = vulnerabilityCount;
        document.getElementById('last-scan-time').textContent = new Date().toLocaleTimeString();
    }
}

// Auto-refresh functionality
let autoRefreshInterval;

function toggleAutoRefresh() {
    const refreshBtn = document.querySelector('button[onclick="refreshResults()"]');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        refreshBtn.classList.remove('btn-success');
        refreshBtn.classList.add('btn-outline-secondary');
    } else {
        autoRefreshInterval = setInterval(refreshResults, 30000); // Refresh every 30 seconds
        refreshBtn.innerHTML = '<i class="fas fa-pause"></i> Auto-Refresh';
        refreshBtn.classList.remove('btn-outline-secondary');
        refreshBtn.classList.add('btn-success');
    }
}

// Add double-click for auto-refresh toggle
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('button[onclick="refreshResults()"]');
    if (refreshBtn) {
        refreshBtn.addEventListener('dblclick', toggleAutoRefresh);
        refreshBtn.title = 'Click to refresh, double-click for auto-refresh';
    }
});
</script>
{% endblock %}
