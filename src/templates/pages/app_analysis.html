{% extends "pages/app_base.html" %}

{% block page_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt text-primary mr-2"></i>
                    Security Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Backend Analysis -->
                    <div class="col-lg-6 mb-4">
                        <div class="card border-left-primary h-100">
                            <div class="card-body">
                                <h6 class="card-title font-weight-bold text-primary">
                                    <i class="fas fa-server mr-2"></i>Backend Security
                                </h6>
                                <p class="card-text text-muted">
                                    Analyze Flask backend code for security vulnerabilities using bandit, safety, and other tools.
                                </p>
                                
                                <form hx-post="/analysis/backend_security/{{ model }}/{{ app_num }}/run"
                                      hx-target="#backend-results"
                                      hx-indicator="#backend-loading">
                                    
                                    <div class="form-group">
                                        <label class="font-weight-bold">Analysis Tools:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="bandit" id="bandit" checked>
                                            <label class="form-check-label" for="bandit">
                                                Bandit (Python security scanner)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="safety" id="safety" checked>
                                            <label class="form-check-label" for="safety">
                                                Safety (dependency vulnerability scanner)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="semgrep" id="semgrep">
                                            <label class="form-check-label" for="semgrep">
                                                Semgrep (static analysis)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-play mr-2"></i>Run Backend Analysis
                                        <div id="backend-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Frontend Analysis -->
                    <div class="col-lg-6 mb-4">
                        <div class="card border-left-success h-100">
                            <div class="card-body">
                                <h6 class="card-title font-weight-bold text-success">
                                    <i class="fas fa-code mr-2"></i>Frontend Security
                                </h6>
                                <p class="card-text text-muted">
                                    Analyze React/Vite frontend code for security issues and dependency vulnerabilities.
                                </p>
                                
                                <form hx-post="/analysis/frontend_security/{{ model }}/{{ app_num }}/run"
                                      hx-target="#frontend-results"
                                      hx-indicator="#frontend-loading">
                                    
                                    <div class="form-group">
                                        <label class="font-weight-bold">Analysis Tools:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="npm_audit" id="npm_audit" checked>
                                            <label class="form-check-label" for="npm_audit">
                                                NPM Audit (dependency vulnerabilities)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tools" value="eslint_security" id="eslint_security" checked>
                                            <label class="form-check-label" for="eslint_security">
                                                ESLint Security Plugin
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success btn-block">
                                        <i class="fas fa-play mr-2"></i>Run Frontend Analysis
                                        <div id="frontend-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Results -->
<div class="row">
    <!-- Backend Results -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0 font-weight-bold text-primary">
                    <i class="fas fa-server mr-2"></i>Backend Analysis Results
                </h6>
            </div>
            <div class="card-body">
                <div id="backend-results"
                     hx-get="/analysis/backend_security/{{ model }}/{{ app_num }}"
                     hx-trigger="load">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading backend analysis results...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Frontend Results -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0 font-weight-bold text-success">
                    <i class="fas fa-code mr-2"></i>Frontend Analysis Results
                </h6>
            </div>
            <div class="card-body">
                <div id="frontend-results"
                     hx-get="/analysis/frontend_security/{{ model }}/{{ app_num }}"
                     hx-trigger="load">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading frontend analysis results...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ZAP Security Scan -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0 font-weight-bold text-danger">
                    <i class="fas fa-bug mr-2"></i>OWASP ZAP Dynamic Analysis
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <p class="text-muted">
                            Run dynamic application security testing using OWASP ZAP to identify runtime vulnerabilities.
                        </p>
                        
                        <form hx-post="/zap/{{ model }}/{{ app_num }}/scan"
                              hx-target="#zap-results"
                              hx-indicator="#zap-loading"
                              class="mb-3">
                            
                            <div class="form-group">
                                <label for="target_url" class="font-weight-bold">Target URL:</label>
                                <input type="url" 
                                       class="form-control" 
                                       id="target_url" 
                                       name="target_url" 
                                       value="http://localhost:{{ 9000 + (app_num * 10) }}"
                                       required>
                            </div>
                            
                            <div class="form-group">
                                <label class="font-weight-bold">Scan Type:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scan_type" id="quick_scan" value="quick" checked>
                                    <label class="form-check-label" for="quick_scan">
                                        Quick Scan (Spider + Passive)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scan_type" id="full_scan" value="full">
                                    <label class="form-check-label" for="full_scan">
                                        Full Scan (Spider + Active + Passive)
                                    </label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-play mr-2"></i>Start ZAP Scan
                                <div id="zap-loading" class="htmx-indicator spinner-border spinner-border-sm ml-2"></div>
                            </button>
                        </form>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="alert alert-warning" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Note
                            </h6>
                            <small>
                                ZAP scans can take several minutes to complete. 
                                Make sure the application is running before starting the scan.
                            </small>
                        </div>
                    </div>
                </div>
                
                <div id="zap-results"
                     hx-get="/zap/{{ model }}/{{ app_num }}/results"
                     hx-trigger="load">
                    <div class="text-center py-4">
                        <div class="spinner-border text-danger" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading ZAP scan results...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.htmx-indicator {
    display: none;
}

.card-header h6 {
    margin: 0;
}
</style>
{% endblock %}
