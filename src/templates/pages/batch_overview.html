{% extends "base.html" %}

{% block title %}Batch Analysis Management - Thesis Research App{% endblock %}

{% block head %}
<style>
/* Consolidated Batch Management Styles */
.batch-tabs {
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 1.5rem;
}

.batch-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #6c757d;
    font-weight: 500;
    padding: 1rem 1.5rem;
    margin-bottom: -2px;
    transition: all 0.3s ease;
}

.batch-tabs .nav-link:hover {
    border-bottom-color: #dee2e6;
    color: #495057;
}

.batch-tabs .nav-link.active {
    border-bottom-color: #007bff;
    color: #007bff;
    background: none;
}

.tab-content {
    min-height: 400px;
}

.form-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-section h5 {
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.step-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem;
    min-width: 120px;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: #007bff;
}

.step.completed .step-number {
    background: #28a745;
}

.step-divider {
    height: 2px;
    background: #e9ecef;
    flex: 1;
    margin: 0 1rem;
    margin-top: 20px;
}

.analysis-type-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.analysis-type-card:hover {
    border-color: #007bff;
    background: #f8f9ff;
}

.analysis-type-card.selected {
    border-color: #007bff;
    background: #e7f3ff;
}

.analysis-type-icon {
    font-size: 1.5rem;
    margin-right: 0.75rem;
}

.model-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.model-checkbox-item {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.model-checkbox-item:hover {
    border-color: #007bff;
    background: #f8f9ff;
}

.model-checkbox-item.selected {
    border-color: #007bff;
    background: #e7f3ff;
}

.estimate-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.required-indicator {
    color: #dc3545;
    font-weight: bold;
}

.validation-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: none;
}

.validation-error.show {
    display: block;
}

.auto-refresh-toggle {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.auto-refresh-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #007bff;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.job-status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-running { background: #d1ecf1; color: #0c5460; }
.status-completed { background: #d4edda; color: #155724; }
.status-failed { background: #f8d7da; color: #721c24; }
.status-cancelled { background: #e2e3e5; color: #383d41; }
.status-archived { background: #f8f9fa; color: #6c757d; }

.analysis-type-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    margin: 0.1rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 500;
}

.type-frontend_security { background: #fff3cd; color: #856404; }
.type-backend_security { background: #f8d7da; color: #721c24; }
.type-performance { background: #d1ecf1; color: #0c5460; }
.type-zap { background: #e2e3e5; color: #383d41; }
.type-gpt4all { background: #d4edda; color: #155724; }
.type-code_quality { background: #f0d7fe; color: #6b1a7a; }

.progress-bar-stats {
    width: 100px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
}

.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1055;
}

.toast {
    margin-bottom: 10px;
    padding: 1rem;
    border-radius: 8px;
    color: white;
    min-width: 300px;
    animation: slideIn 0.3s ease;
}

.toast-success { background: #28a745; }
.toast-error { background: #dc3545; }
.toast-info { background: #17a2b8; }
.toast-warning { background: #ffc107; color: #212529; }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Batch Analysis Management</h1>
                    <p class="text-muted mb-0">Create, manage, and monitor analysis jobs across multiple applications</p>
                </div>
                <div class="d-flex align-items-center">
                    <!-- Auto-refresh toggle -->
                    <div class="mr-3 d-flex align-items-center">
                        <span class="text-sm mr-2">Auto-refresh:</span>
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="autoRefreshToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="text-sm ml-2" id="refreshStatus">
                            <i class="fas fa-sync-alt spinning" id="refreshIcon"></i>
                            <span id="refreshCountdown">10s</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs batch-tabs" id="batchTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab" aria-controls="overview" aria-selected="true">
                <i class="fas fa-list mr-2"></i>Job Overview
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="create-tab" data-toggle="tab" href="#create" role="tab" aria-controls="create" aria-selected="false">
                <i class="fas fa-plus mr-2"></i>Create New Job
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="batchTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <!-- Stats Cards -->
            <div class="row mb-4" id="statsCards">
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <h5 class="card-title text-muted mb-1 stat-card-title">Total Jobs</h5>
                            <h3 class="mb-0" id="totalJobs">{{ job_stats.total or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <h5 class="card-title text-warning mb-1" style="font-size: 0.875rem;">Pending</h5>
                            <h3 class="mb-0 text-warning" id="pendingJobs">{{ job_stats.pending or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <h5 class="card-title text-muted mb-1 stat-card-title">Running</h5>
                            <h3 class="mb-0 text-primary" id="runningJobs">{{ job_stats.running or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <h5 class="card-title text-success mb-1" style="font-size: 0.875rem;">Completed</h5>
                            <h3 class="mb-0 text-success" id="completedJobs">{{ job_stats.completed or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <h5 class="card-title text-muted mb-1 stat-card-title">Failed</h5>
                            <h3 class="mb-0 text-danger" id="failedJobs">{{ job_stats.failed or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <h5 class="card-title text-secondary mb-1" style="font-size: 0.875rem;">Archived</h5>
                            <h3 class="mb-0 text-secondary" id="archivedJobs">{{ job_stats.archived or 0 }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-filter mr-2"></i>Filters
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label text-sm font-weight-bold">Search</label>
                                    <input type="text" class="form-control form-control-sm" id="searchFilter" 
                                           placeholder="Search jobs by name or description...">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label text-sm font-weight-bold">Status</label>
                                    <select class="form-control form-control-sm" id="statusFilter">
                                        <option value="">All Statuses</option>
                                        <option value="pending">Pending</option>
                                        <option value="queued">Queued</option>
                                        <option value="running">Running</option>
                                        <option value="completed">Completed</option>
                                        <option value="failed">Failed</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-sm font-weight-bold">Analysis Type</label>
                                    <select class="form-control form-control-sm" id="analysisTypeFilter">
                                        <option value="">All Types</option>
                                        <option value="frontend_security">Frontend Security</option>
                                        <option value="backend_security">Backend Security</option>
                                        <option value="performance">Performance</option>
                                        <option value="zap">ZAP Security</option>
                                        <option value="gpt4all">GPT4All</option>
                                        <option value="code_quality">Code Quality</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-secondary btn-sm mr-2" id="clearFilters">
                                        <i class="fas fa-times mr-1"></i>Clear Filters
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" id="refreshJobs">
                                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-list mr-2"></i>Batch Jobs
                            </h6>
                            <span class="text-muted" id="jobsCounter">
                                Showing <span id="visibleJobsCount">{{ jobs|length }}</span> of {{ jobs|length }} jobs
                            </span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="thead-light">
                                        <tr>
                                            <th class="border-0 font-weight-bold">Job</th>
                                            <th class="border-0 font-weight-bold">Status</th>
                                            <th class="border-0 font-weight-bold">Progress</th>
                                            <th class="border-0 font-weight-bold">Analysis Types</th>
                                            <th class="border-0 font-weight-bold">Models</th>
                                            <th class="border-0 font-weight-bold">Created</th>
                                            <th class="border-0 font-weight-bold">Duration</th>
                                            <th class="border-0 font-weight-bold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jobsTableBody">
                                        {% if jobs %}
                                            {% for job in jobs %}
                                            <tr class="job-row" data-job-id="{{ job.id }}" data-status="{{ job.status }}" data-analysis-types="{{ job.analysis_types|join(',') if job.analysis_types else '' }}">
                                                <td class="py-3">
                                                    <div>
                                                        <h6 class="mb-1">{{ job.name }}</h6>
                                                        {% if job.description %}
                                                        <small class="text-muted">{{ job.description }}</small>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="py-3">
                                                    <span class="job-status-badge status-{{ job.status }}">{{ job.status }}</span>
                                                </td>
                                                <td class="py-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress-bar mr-2 progress-bar-stats">
                                                            <div class="progress-fill" style="width: {{ job.progress.completed / job.progress.total * 100 if job.progress.total > 0 else 0 }}%"></div>
                                                        </div>
                                                        <small class="text-muted">{{ job.progress.completed }}/{{ job.progress.total }}</small>
                                                    </div>
                                                </td>
                                                <td class="py-3">
                                                    <div>
                                                        {% for analysis_type in job.analysis_types %}
                                                        <span class="analysis-type-badge type-{{ analysis_type }}">{{ analysis_type.replace('_', ' ').title() }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </td>
                                                <td class="py-3">
                                                    <small class="text-muted">{{ job.models|length }} models</small>
                                                    <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ job.models|join(', ') if job.models else '' }}">
                                                        {{ job.models|join(', ') if job.models else '' }}
                                                    </div>
                                                </td>
                                                <td class="py-3">
                                                    <small class="text-muted">{{ job.created_at_formatted if job.created_at_formatted else 'Unknown' }}</small>
                                                </td>
                                                <td class="py-3">
                                                    <small class="text-muted">
                                                        {% if job.completed_at and job.started_at %}
                                                            {{ "%.1f"|format((job.completed_at|to_datetime - job.started_at|to_datetime).total_seconds()) }}s
                                                        {% elif job.started_at %}
                                                            Running...
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </small>
                                                </td>
                                                <td class="py-3">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <a href="/batch/job/{{ job.id }}" class="btn btn-outline-primary btn-sm" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        {% if job.status in ['pending', 'running'] %}
                                                        <button class="btn btn-outline-warning btn-sm" 
                                                                onclick="cancelJob('{{ job.id }}')" title="Cancel Job">
                                                            <i class="fas fa-stop"></i>
                                                        </button>
                                                        {% endif %}
                                                        {% if job.status in ['completed', 'failed', 'cancelled'] %}
                                                        <button class="btn btn-outline-secondary btn-sm" 
                                                                onclick="archiveJob('{{ job.id }}')" title="Archive Job">
                                                            <i class="fas fa-archive"></i>
                                                        </button>
                                                        {% endif %}
                                                        {% if job.status == 'archived' %}
                                                        <button class="btn btn-outline-danger btn-sm" 
                                                                onclick="deleteJob('{{ job.id }}')" title="Delete Job">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="noJobsRow">
                                                <td colspan="8" class="text-center py-5">
                                                    <div class="text-muted">
                                                        <i class="fas fa-tasks fa-3x mb-3 text-muted"></i>
                                                        <h5>No batch jobs found</h5>
                                                        <p>Create your first batch analysis job to get started.</p>
                                                        <button class="btn btn-primary" onclick="switchToCreateTab()">
                                                            <i class="fas fa-plus mr-2"></i>Create First Job
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Job Tab -->
        <div class="tab-pane fade" id="create" role="tabpanel" aria-labelledby="create-tab">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <span>Basic Info</span>
                </div>
                <div class="step-divider"></div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <span>Analysis Types</span>
                </div>
                <div class="step-divider"></div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <span>Models & Apps</span>
                </div>
                <div class="step-divider"></div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <span>Review</span>
                </div>
            </div>

            <form id="batchJobForm" method="POST" action="/batch/create">
                <!-- Basic Information -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-info-circle mr-2"></i>Basic Information
                        <span class="required-indicator">*</span>
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobName" class="font-weight-bold">
                                    Job Name <span class="required-indicator">*</span>
                                </label>
                                <input type="text" class="form-control" id="jobName" name="name" 
                                       placeholder="Enter a descriptive name for this job" required>
                                <div class="validation-error" id="jobNameError"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobPriority" class="font-weight-bold">Priority</label>
                                <select class="form-control" id="jobPriority" name="priority">
                                    <option value="normal">Normal</option>
                                    <option value="high">High</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="jobDescription" class="font-weight-bold">Description</label>
                        <textarea class="form-control" id="jobDescription" name="description" rows="3"
                                  placeholder="Optional description of what this job will accomplish"></textarea>
                    </div>
                </div>

                <!-- Analysis Types -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-shield-alt mr-2"></i>Analysis Types
                        <span class="required-indicator">*</span>
                    </h5>
                    <p class="text-muted mb-3">Select one or more analysis types to run on the selected applications.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="analysis-type-card" data-type="frontend_security">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                           id="frontend_security" name="analysis_types" value="frontend_security">
                                    <label class="custom-control-label" for="frontend_security">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-code analysis-type-icon text-warning"></i>
                                            <div>
                                                <strong>Frontend Security</strong>
                                                <br><small class="text-muted">ESLint, npm audit, dependency checks</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analysis-type-card" data-type="backend_security">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                           id="backend_security" name="analysis_types" value="backend_security">
                                    <label class="custom-control-label" for="backend_security">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-server analysis-type-icon text-danger"></i>
                                            <div>
                                                <strong>Backend Security</strong>
                                                <br><small class="text-muted">Bandit, safety, dependency checks</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analysis-type-card" data-type="performance">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                           id="performance" name="analysis_types" value="performance">
                                    <label class="custom-control-label" for="performance">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-tachometer-alt analysis-type-icon text-info"></i>
                                            <div>
                                                <strong>Performance Testing</strong>
                                                <br><small class="text-muted">Load testing, response time analysis</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analysis-type-card" data-type="zap">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                           id="zap" name="analysis_types" value="zap">
                                    <label class="custom-control-label" for="zap">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-bug analysis-type-icon text-primary"></i>
                                            <div>
                                                <strong>ZAP Security Scan</strong>
                                                <br><small class="text-muted">OWASP ZAP vulnerability scanning</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analysis-type-card" data-type="code_quality">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                           id="code_quality" name="analysis_types" value="code_quality">
                                    <label class="custom-control-label" for="code_quality">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-star analysis-type-icon text-success"></i>
                                            <div>
                                                <strong>Code Quality</strong>
                                                <br><small class="text-muted">Pylint, code complexity analysis</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analysis-type-card" data-type="gpt4all">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input analysis-type-checkbox" 
                                           id="gpt4all" name="analysis_types" value="gpt4all">
                                    <label class="custom-control-label" for="gpt4all">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-robot analysis-type-icon text-purple"></i>
                                            <div>
                                                <strong>GPT4All Analysis</strong>
                                                <br><small class="text-muted">AI-powered code analysis</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="validation-error" id="analysisTypesError"></div>
                </div>

                <!-- Model and App Selection -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-cubes mr-2"></i>Models & Applications
                        <span class="required-indicator">*</span>
                    </h5>
                    
                    <!-- Model Selection -->
                    <div class="mb-4">
                        <label class="font-weight-bold mb-2">
                            Select Models <span class="required-indicator">*</span>
                        </label>
                        <div class="mb-2">
                            <button type="button" class="btn btn-outline-primary btn-sm mr-2" id="selectAllModels">
                                <i class="fas fa-check-square mr-1"></i>Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllModels">
                                <i class="fas fa-times mr-1"></i>Clear All
                            </button>
                        </div>
                        
                        <div class="model-selection-grid">
                            {% if available_models %}
                                {% for model in available_models %}
                                <div class="model-checkbox-item" data-model="{{ model.canonical_slug }}">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input model-checkbox" 
                                               id="model_{{ model.canonical_slug }}" name="models" value="{{ model.canonical_slug }}">
                                        <label class="custom-control-label" for="model_{{ model.canonical_slug }}">
                                            <div>
                                                <strong>{{ model.model_name }}</strong>
                                                <br><small class="text-muted">{{ model.provider }} • {{ model.canonical_slug }}</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        No models available. Please ensure model capabilities are loaded in the database.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="validation-error" id="modelsError"></div>
                    </div>

                    <!-- App Range Selection -->
                    <div class="mb-4">
                        <label for="appRange" class="font-weight-bold mb-2">
                            Application Range <span class="required-indicator">*</span>
                        </label>
                        <input type="text" class="form-control" id="appRange" name="app_range" 
                               placeholder="e.g., 1-5, 10, 15-20 or 'all'" required>
                        <small class="form-text text-muted">
                            Specify which applications to analyze. Examples: "1-5" (apps 1 through 5), 
                            "1,3,5" (specific apps), "all" (all 30 apps)
                        </small>
                        <div class="validation-error" id="appRangeError"></div>
                    </div>

                    <!-- Estimates -->
                    <div class="estimate-card">
                        <h6 class="mb-3">
                            <i class="fas fa-calculator mr-2"></i>Job Estimates
                        </h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="estimatedTasks">0</h4>
                                    <small>Total Tasks</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="estimatedModels">0</h4>
                                    <small>Models</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="estimatedApps">0</h4>
                                    <small>Applications</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="estimatedDuration">~0min</h4>
                                    <small>Est. Duration</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-secondary" onclick="switchToOverviewTab()">
                            <i class="fas fa-arrow-left mr-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitJobBtn">
                            <i class="fas fa-play mr-2"></i>Create & Start Job
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let autoRefreshEnabled = true;
    let refreshInterval;
    let countdownInterval;
    const REFRESH_INTERVAL = 10000; // 10 seconds

    // Tab switching functions
    window.switchToCreateTab = function() {
        document.getElementById('create-tab').click();
    };

    window.switchToOverviewTab = function() {
        document.getElementById('overview-tab').click();
    };

    // Initialize auto-refresh
    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        if (countdownInterval) clearInterval(countdownInterval);

        let countdown = REFRESH_INTERVAL / 1000;
        
        countdownInterval = setInterval(() => {
            countdown--;
            document.getElementById('refreshCountdown').textContent = countdown + 's';
            
            if (countdown <= 0) {
                countdown = REFRESH_INTERVAL / 1000;
            }
        }, 1000);

        refreshInterval = setInterval(() => {
            if (autoRefreshEnabled && document.getElementById('overview').classList.contains('active')) {
                refreshJobsData();
            }
        }, REFRESH_INTERVAL);
    }

    // Auto-refresh toggle
    document.getElementById('autoRefreshToggle').addEventListener('change', function(e) {
        autoRefreshEnabled = e.target.checked;
        const refreshIcon = document.getElementById('refreshIcon');
        
        if (autoRefreshEnabled) {
            refreshIcon.classList.add('spinning');
            startAutoRefresh();
        } else {
            refreshIcon.classList.remove('spinning');
            if (refreshInterval) clearInterval(refreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('refreshCountdown').textContent = 'Off';
        }
    });

    // Refresh jobs data
    function refreshJobsData() {
        fetch('/batch/api/jobs')
            .then(response => response.json())
            .then(data => {
                updateJobsTable(data.jobs);
                updateStatsCards(data.stats);
                applyFilters();
            })
            .catch(error => {
                console.error('Error refreshing jobs:', error);
                showToast('Failed to refresh jobs data', 'error');
            });
    }

    // Update jobs table
    function updateJobsTable(jobs) {
        const tbody = document.getElementById('jobsTableBody');
        if (!jobs || jobs.length === 0) {
            tbody.innerHTML = `
                <tr id="noJobsRow">
                    <td colspan="8" class="text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-tasks fa-3x mb-3 text-muted"></i>
                            <h5>No batch jobs found</h5>
                            <p>Create your first batch analysis job to get started.</p>
                            <button class="btn btn-primary" onclick="switchToCreateTab()">
                                <i class="fas fa-plus mr-2"></i>Create First Job
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = jobs.map(job => `
            <tr class="job-row" data-job-id="${job.id}" data-status="${job.status}" 
                data-analysis-types="${(job.analysis_types || []).join(',')}">
                <td class="py-3">
                    <div>
                        <h6 class="mb-1">${job.name}</h6>
                        ${job.description ? `<small class="text-muted">${job.description}</small>` : ''}
                    </div>
                </td>
                <td class="py-3">
                    <span class="job-status-badge status-${job.status}">${job.status}</span>
                </td>
                <td class="py-3">
                    <div class="d-flex align-items-center">
                        <div class="progress-bar mr-2 progress-bar-stats">
                            <div class="progress-fill" style="width: ${job.progress.total > 0 ? (job.progress.completed / job.progress.total * 100) : 0}%"></div>
                        </div>
                        <small class="text-muted">${job.progress.completed}/${job.progress.total}</small>
                    </div>
                </td>
                <td class="py-3">
                    <div>
                        ${(job.analysis_types || []).map(type => 
                            `<span class="analysis-type-badge type-${type}">${type.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</span>`
                        ).join('')}
                    </div>
                </td>
                <td class="py-3">
                    <small class="text-muted">${(job.models || []).length} models</small>
                    <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                         title="${(job.models || []).join(', ')}">
                        ${(job.models || []).join(', ')}
                    </div>
                </td>
                <td class="py-3">
                    <small class="text-muted">${job.created_at_formatted || 'Unknown'}</small>
                </td>
                <td class="py-3">
                    <small class="text-muted">
                        ${job.completed_at && job.started_at ? 
                            `${((new Date(job.completed_at) - new Date(job.started_at)) / 1000).toFixed(1)}s` :
                            job.started_at ? 'Running...' : '-'
                        }
                    </small>
                </td>
                <td class="py-3">
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/batch/job/${job.id}" class="btn btn-outline-primary btn-sm" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        ${['pending', 'running'].includes(job.status) ? 
                            `<button class="btn btn-outline-warning btn-sm" 
                                    onclick="cancelJob('${job.id}')" title="Cancel Job">
                                <i class="fas fa-stop"></i>
                            </button>` : ''
                        }
                        ${['completed', 'failed', 'cancelled'].includes(job.status) ? 
                            `<button class="btn btn-outline-secondary btn-sm" 
                                    onclick="archiveJob('${job.id}')" title="Archive Job">
                                <i class="fas fa-archive"></i>
                            </button>` : ''
                        }
                        ${job.status === 'archived' ? 
                            `<button class="btn btn-outline-danger btn-sm" 
                                    onclick="deleteJob('${job.id}')" title="Delete Job">
                                <i class="fas fa-trash"></i>
                            </button>` : ''
                        }
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Update stats cards
    function updateStatsCards(stats) {
        if (stats) {
            document.getElementById('totalJobs').textContent = stats.total || 0;
            document.getElementById('pendingJobs').textContent = stats.pending || 0;
            document.getElementById('runningJobs').textContent = stats.running || 0;
            document.getElementById('completedJobs').textContent = stats.completed || 0;
            document.getElementById('failedJobs').textContent = stats.failed || 0;
            document.getElementById('archivedJobs').textContent = stats.archived || 0;
        }
    }

    // Apply filters (overview tab)
    function applyFilters() {
        const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const analysisTypeFilter = document.getElementById('analysisTypeFilter').value;
        
        const jobRows = document.querySelectorAll('.job-row');
        let visibleCount = 0;

        jobRows.forEach(row => {
            const jobName = row.querySelector('h6').textContent.toLowerCase();
            const jobDescription = row.querySelector('small')?.textContent.toLowerCase() || '';
            const jobStatus = row.dataset.status;
            const analysisTypes = row.dataset.analysisTypes;

            let matchesSearch = true;
            let matchesStatus = true;
            let matchesAnalysisType = true;

            if (searchTerm) {
                matchesSearch = jobName.includes(searchTerm) || jobDescription.includes(searchTerm);
            }

            if (statusFilter) {
                matchesStatus = jobStatus === statusFilter;
            }

            if (analysisTypeFilter) {
                matchesAnalysisType = analysisTypes.includes(analysisTypeFilter);
            }

            const isVisible = matchesSearch && matchesStatus && matchesAnalysisType;
            
            if (isVisible) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('visibleJobsCount').textContent = visibleCount;

        // Show/hide no jobs row
        const noJobsRow = document.getElementById('noJobsRow');
        if (noJobsRow) {
            noJobsRow.style.display = visibleCount === 0 && jobRows.length > 0 ? '' : 'none';
        }
    }

    // Create job form handling
    const form = document.getElementById('batchJobForm');
    const analysisTypeCheckboxes = document.querySelectorAll('.analysis-type-checkbox');
    const modelCheckboxes = document.querySelectorAll('.model-checkbox');
    const appRangeInput = document.getElementById('appRange');

    // Analysis type selection handling
    analysisTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const card = this.closest('.analysis-type-card');
            if (this.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            validateAnalysisTypes();
            updateEstimates();
        });
    });

    // Model selection handling
    modelCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.model-checkbox-item');
            if (this.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            validateModels();
            updateEstimates();
        });
    });

    // Model selection helpers
    document.getElementById('selectAllModels')?.addEventListener('click', function() {
        modelCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            checkbox.closest('.model-checkbox-item').classList.add('selected');
        });
        updateEstimates();
        validateModels();
    });

    document.getElementById('clearAllModels')?.addEventListener('click', function() {
        modelCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.model-checkbox-item').classList.remove('selected');
        });
        updateEstimates();
        validateModels();
    });

    // App range input handling
    appRangeInput?.addEventListener('input', function() {
        updateEstimates();
        validateAppRange();
    });

    // Validation functions
    function validateAnalysisTypes() {
        const checkedTypes = document.querySelectorAll('.analysis-type-checkbox:checked');
        const errorDiv = document.getElementById('analysisTypesError');
        
        if (checkedTypes.length === 0) {
            errorDiv.textContent = 'Please select at least one analysis type.';
            errorDiv.classList.add('show');
            return false;
        } else {
            errorDiv.classList.remove('show');
            return true;
        }
    }

    function validateModels() {
        const checkedModels = document.querySelectorAll('.model-checkbox:checked');
        const errorDiv = document.getElementById('modelsError');
        
        if (checkedModels.length === 0) {
            errorDiv.textContent = 'Please select at least one model.';
            errorDiv.classList.add('show');
            return false;
        } else {
            errorDiv.classList.remove('show');
            return true;
        }
    }

    function validateAppRange() {
        const range = appRangeInput?.value.trim();
        const errorDiv = document.getElementById('appRangeError');
        
        if (!range) {
            errorDiv.textContent = 'Please specify an application range.';
            errorDiv.classList.add('show');
            return false;
        }

        // Handle "all" keyword
        if (range.toLowerCase() === 'all') {
            errorDiv.classList.remove('show');
            return true;
        }

        // Validate range format
        const parts = range.split(',');
        const validPattern = /^\d+(-\d+)?$/;
        
        for (let part of parts) {
            part = part.trim();
            if (!validPattern.test(part)) {
                errorDiv.textContent = 'Invalid format. Use ranges like "1-5" or individual numbers like "1,3,5" or "all".';
                errorDiv.classList.add('show');
                return false;
            }
        }

        errorDiv.classList.remove('show');
        return true;
    }

    function validateJobName() {
        const jobName = document.getElementById('jobName')?.value.trim();
        const errorDiv = document.getElementById('jobNameError');
        
        if (!jobName) {
            errorDiv.textContent = 'Please enter a job name.';
            errorDiv.classList.add('show');
            return false;
        } else {
            errorDiv.classList.remove('show');
            return true;
        }
    }

    // Update estimates
    function updateEstimates() {
        const checkedAnalysisTypes = document.querySelectorAll('.analysis-type-checkbox:checked').length;
        const checkedModels = document.querySelectorAll('.model-checkbox:checked').length;
        const appRange = appRangeInput?.value.trim() || '';
        
        let appCount = 0;
        if (appRange.toLowerCase() === 'all') {
            appCount = 30;
        } else if (appRange) {
            appCount = parseAppRange(appRange).length;
        }

        const totalTasks = checkedAnalysisTypes * checkedModels * appCount;
        const estimatedDuration = Math.ceil(totalTasks * 2); // Rough estimate: 2 minutes per task

        document.getElementById('estimatedTasks').textContent = totalTasks;
        document.getElementById('estimatedModels').textContent = checkedModels;
        document.getElementById('estimatedApps').textContent = appCount;
        document.getElementById('estimatedDuration').textContent = `~${estimatedDuration}min`;
    }

    function parseAppRange(rangeStr) {
        const apps = new Set();
        const parts = rangeStr.split(',');
        
        for (let part of parts) {
            part = part.trim();
            if (part.includes('-')) {
                const [start, end] = part.split('-').map(num => parseInt(num.trim()));
                for (let i = start; i <= end; i++) {
                    apps.add(i);
                }
            } else {
                apps.add(parseInt(part));
            }
        }
        
        return Array.from(apps).sort((a, b) => a - b);
    }

    // Event listeners for filters (overview tab)
    document.getElementById('searchFilter')?.addEventListener('input', applyFilters);
    document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
    document.getElementById('analysisTypeFilter')?.addEventListener('change', applyFilters);

    // Clear filters
    document.getElementById('clearFilters')?.addEventListener('click', function() {
        document.getElementById('searchFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('analysisTypeFilter').value = '';
        applyFilters();
    });

    // Refresh button
    document.getElementById('refreshJobs')?.addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('spinning');
        refreshJobsData();
        setTimeout(() => icon.classList.remove('spinning'), 1000);
    });

    // Form submission
    form?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate all sections
        const isValidName = validateJobName();
        const isValidAnalysisTypes = validateAnalysisTypes();
        const isValidModels = validateModels();
        const isValidAppRange = validateAppRange();
        
        if (!isValidName || !isValidAnalysisTypes || !isValidModels || !isValidAppRange) {
            showToast('Please fix the validation errors before submitting.', 'error');
            return;
        }
        
        // If validation passes, submit the form
        this.submit();
    });

    // Job action functions
    window.cancelJob = function(jobId) {
        if (confirm('Are you sure you want to cancel this job?')) {
            fetch(`/batch/job/${jobId}/cancel`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Job cancelled successfully', 'success');
                        refreshJobsData();
                    } else {
                        showToast(data.error || 'Failed to cancel job', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error cancelling job:', error);
                    showToast('Failed to cancel job', 'error');
                });
        }
    };

    window.archiveJob = function(jobId) {
        if (confirm('Are you sure you want to archive this job?')) {
            fetch(`/batch/job/${jobId}/archive`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Job archived successfully', 'success');
                        refreshJobsData();
                    } else {
                        showToast(data.error || 'Failed to archive job', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error archiving job:', error);
                    showToast('Failed to archive job', 'error');
                });
        }
    };

    window.deleteJob = function(jobId) {
        if (confirm('Are you sure you want to permanently delete this job? This action cannot be undone.')) {
            fetch(`/batch/job/${jobId}/delete`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Job deleted successfully', 'success');
                        refreshJobsData();
                    } else {
                        showToast(data.error || 'Failed to delete job', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting job:', error);
                    showToast('Failed to delete job', 'error');
                });
        }
    };

    // Show toast notifications
    window.showToast = function(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                <span>${message}</span>
                <button type="button" class="close ml-auto" onclick="this.parentElement.parentElement.remove()">
                    <span>&times;</span>
                </button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    };

    // Initialize
    applyFilters();
    updateEstimates();
    if (autoRefreshEnabled) {
        startAutoRefresh();
    }
});
</script>
{% endblock %}
