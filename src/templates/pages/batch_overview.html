{% extends "base.html" %}

{% block title %}Batch Analysis Managem                    <h5 class="card-title text-muted mb-1 stat-card-title">Completed</h5>nt - Thesis Research App{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Batch Analysis Management</h1>
                    <p class="text-muted mb-0">Manage and monitor analysis jobs across multiple applications</p>
                </div>
                <div class="d-flex align-items-center">
                    <!-- Auto-refresh toggle -->
                    <div class="mr-3 d-flex align-items-center">
                        <span class="text-sm mr-2">Auto-refresh:</span>
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="autoRefreshToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="text-sm ml-2" id="refreshStatus">
                            <i class="fas fa-sync-alt spinning" id="refreshIcon"></i>
                            <span id="refreshCountdown">10s</span>
                        </span>
                    </div>
                    <!-- Create job button -->
                    <a href="/batch/create" class="btn btn-primary" id="createJobBtn">
                        <i class="fas fa-plus mr-2"></i>Create New Job
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4" id="statsCards">
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center p-3">
                    <h5 class="card-title text-muted mb-1 stat-card-title">Total Jobs</h5>
                    <h3 class="mb-0" id="totalJobs">{{ job_stats.total or 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center p-3">
                    <h5 class="card-title text-warning mb-1" style="font-size: 0.875rem;">Pending</h5>
                    <h3 class="mb-0 text-warning" id="pendingJobs">{{ job_stats.pending or 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center p-3">
                                        <h5 class="card-title text-muted mb-1 stat-card-title">Running</h5>
                    <h3 class="mb-0 text-primary" id="runningJobs">{{ job_stats.running or 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center p-3">
                    <h5 class="card-title text-success mb-1" style="font-size: 0.875rem;">Completed</h5>
                    <h3 class="mb-0 text-success" id="completedJobs">{{ job_stats.completed or 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center p-3">
                                        <h5 class="card-title text-muted mb-1 stat-card-title">Failed</h5>
                    <h3 class="mb-0 text-danger" id="failedJobs">{{ job_stats.failed or 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center p-3">
                    <h5 class="card-title text-secondary mb-1" style="font-size: 0.875rem;">Archived</h5>
                    <h3 class="mb-0 text-secondary" id="archivedJobs">{{ job_stats.archived or 0 }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-filter mr-2"></i>Filters
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label text-sm font-weight-bold">Search</label>
                            <input type="text" class="form-control form-control-sm" id="searchFilter" 
                                   placeholder="Search jobs by name or description...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-sm font-weight-bold">Status</label>
                            <select class="form-control form-control-sm" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="queued">Queued</option>
                                <option value="running">Running</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-sm font-weight-bold">Analysis Type</label>
                            <select class="form-control form-control-sm" id="analysisTypeFilter">
                                <option value="">All Types</option>
                                <option value="frontend_security">Frontend Security</option>
                                <option value="backend_security">Backend Security</option>
                                <option value="performance">Performance</option>
                                <option value="zap">ZAP Security</option>
                                <option value="gpt4all">GPT4All</option>
                                <option value="code_quality">Code Quality</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-secondary btn-sm mr-2" id="clearFilters">
                                <i class="fas fa-times mr-1"></i>Clear Filters
                            </button>
                            <button class="btn btn-outline-info btn-sm" id="refreshJobs">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jobs Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-list mr-2"></i>Batch Jobs
                    </h6>
                    <span class="text-muted" id="jobsCounter">
                        Showing <span id="visibleJobsCount">{{ jobs|length }}</span> of {{ jobs|length }} jobs
                    </span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th class="border-0 font-weight-bold">Job</th>
                                    <th class="border-0 font-weight-bold">Status</th>
                                    <th class="border-0 font-weight-bold">Progress</th>
                                    <th class="border-0 font-weight-bold">Analysis Types</th>
                                    <th class="border-0 font-weight-bold">Models</th>
                                    <th class="border-0 font-weight-bold">Created</th>
                                    <th class="border-0 font-weight-bold">Duration</th>
                                    <th class="border-0 font-weight-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobsTableBody">
                                {% if jobs %}
                                    {% for job in jobs %}
                                    <tr class="job-row" data-job-id="{{ job.id }}" data-status="{{ job.status }}" data-analysis-types="{{ job.analysis_types|join(',') if job.analysis_types else '' }}">
                                        <td class="py-3">
                                            <div>
                                                <h6 class="mb-1">{{ job.name }}</h6>
                                                {% if job.description %}
                                                <small class="text-muted">{{ job.description }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <span class="job-status-badge status-{{ job.status }}">{{ job.status }}</span>
                                        </td>
                                        <td class="py-3">
                                            <div class="d-flex align-items-center">
                                                <div class="progress-bar mr-2 progress-bar-stats">
                                                    <div class="progress-fill" style="width: {{ job.progress.completed / job.progress.total * 100 if job.progress.total > 0 else 0 }}%"></div>
                                                </div>
                                                <small class="text-muted">{{ job.progress.completed }}/{{ job.progress.total }}</small>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <div>
                                                {% for analysis_type in job.analysis_types %}
                                                <span class="analysis-type-badge type-{{ analysis_type }}">{{ analysis_type.replace('_', ' ').title() }}</span>
                                                {% endfor %}
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <small class="text-muted">{{ job.models|length }} models</small>
                                            <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ job.models|join(', ') if job.models else '' }}">
                                                {{ job.models|join(', ') if job.models else '' }}
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <small class="text-muted">{{ job.created_at_formatted if job.created_at_formatted else 'Unknown' }}</small>
                                        </td>
                                        <td class="py-3">
                                            <small class="text-muted">
                                                {% if job.completed_at and job.started_at %}
                                                    {{ "%.1f"|format((job.completed_at|to_datetime - job.started_at|to_datetime).total_seconds()) }}s
                                                {% elif job.started_at %}
                                                    Running...
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td class="py-3">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="/batch/job/{{ job.id }}" class="btn btn-outline-primary btn-sm" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if job.status in ['pending', 'running'] %}
                                                <button class="btn btn-outline-warning btn-sm" 
                                                        onclick="cancelJob('{{ job.id }}')" title="Cancel Job">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                                {% endif %}
                                                {% if job.status in ['completed', 'failed', 'cancelled'] %}
                                                <button class="btn btn-outline-secondary btn-sm" 
                                                        onclick="archiveJob('{{ job.id }}')" title="Archive Job">
                                                    <i class="fas fa-archive"></i>
                                                </button>
                                                {% endif %}
                                                {% if job.status == 'archived' %}
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="deleteJob('{{ job.id }}')" title="Delete Job">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr id="noJobsRow">
                                        <td colspan="8" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fas fa-tasks fa-3x mb-3 text-muted"></i>
                                                <h5>No batch jobs found</h5>
                                                <p>Create your first batch analysis job to get started.</p>
                                                <button class="btn btn-primary" onclick="createNewJob()">
                                                    <i class="fas fa-plus mr-2"></i>Create First Job
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Job Modal -->
<!-- Modal removed - now using dedicated /batch/create page -->

<!-- Toast Container -->
<div id="toastContainer"></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let autoRefreshEnabled = true;
    let refreshInterval;
    let countdownInterval;
    const REFRESH_INTERVAL = 10000; // 10 seconds

    // Initialize auto-refresh
    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        if (countdownInterval) clearInterval(countdownInterval);

        let countdown = REFRESH_INTERVAL / 1000;
        
        countdownInterval = setInterval(() => {
            countdown--;
            document.getElementById('refreshCountdown').textContent = countdown + 's';
            
            if (countdown <= 0) {
                countdown = REFRESH_INTERVAL / 1000;
            }
        }, 1000);

        refreshInterval = setInterval(() => {
            if (autoRefreshEnabled) {
                refreshJobsData();
            }
        }, REFRESH_INTERVAL);
    }

    // Auto-refresh toggle
    document.getElementById('autoRefreshToggle').addEventListener('change', function(e) {
        autoRefreshEnabled = e.target.checked;
        const refreshIcon = document.getElementById('refreshIcon');
        
        if (autoRefreshEnabled) {
            refreshIcon.classList.add('spinning');
            startAutoRefresh();
        } else {
            refreshIcon.classList.remove('spinning');
            if (refreshInterval) clearInterval(refreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('refreshCountdown').textContent = 'Off';
        }
    });

    // Refresh jobs data
    function refreshJobsData() {
        fetch('/batch/api/jobs')
            .then(response => response.json())
            .then(data => {
                updateJobsTable(data.jobs);
                updateStatsCards(data.stats);
                applyFilters();
            })
            .catch(error => {
                console.error('Error refreshing jobs:', error);
                showToast('Failed to refresh jobs data', 'error');
            });
    }

    // Update jobs table
    function updateJobsTable(jobs) {
        const tbody = document.getElementById('jobsTableBody');
        if (!jobs || jobs.length === 0) {
            tbody.innerHTML = `
                <tr id="noJobsRow">
                    <td colspan="8" class="text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-tasks fa-3x mb-3 text-muted"></i>
                            <h5>No batch jobs found</h5>
                            <p>Create your first batch analysis job to get started.</p>
                            <button class="btn btn-primary" onclick="createNewJob()">
                                <i class="fas fa-plus mr-2"></i>Create First Job
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = jobs.map(job => `
            <tr class="job-row" data-job-id="${job.id}" data-status="${job.status}" 
                data-analysis-types="${(job.analysis_types || []).join(',')}">
                <td class="py-3">
                    <div>
                        <h6 class="mb-1">${job.name}</h6>
                        ${job.description ? `<small class="text-muted">${job.description}</small>` : ''}
                    </div>
                </td>
                <td class="py-3">
                    <span class="job-status-badge status-${job.status}">${job.status}</span>
                </td>
                <td class="py-3">
                    <div class="d-flex align-items-center">
                        <div class="progress-bar mr-2 progress-bar-stats">
                            <div class="progress-fill" style="width: ${job.progress.total > 0 ? (job.progress.completed / job.progress.total * 100) : 0}%"></div>
                        </div>
                        <small class="text-muted">${job.progress.completed}/${job.progress.total}</small>
                    </div>
                </td>
                <td class="py-3">
                    <div>
                        ${(job.analysis_types || []).map(type => 
                            `<span class="analysis-type-badge type-${type}">${type.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</span>`
                        ).join('')}
                    </div>
                </td>
                <td class="py-3">
                    <small class="text-muted">${(job.models || []).length} models</small>
                    <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                         title="${(job.models || []).join(', ')}">
                        ${(job.models || []).join(', ')}
                    </div>
                </td>
                <td class="py-3">
                    <small class="text-muted">${job.created_at_formatted || 'Unknown'}</small>
                </td>
                <td class="py-3">
                    <small class="text-muted">
                        ${job.completed_at && job.started_at ? 
                            `${((new Date(job.completed_at) - new Date(job.started_at)) / 1000).toFixed(1)}s` :
                            job.started_at ? 'Running...' : '-'
                        }
                    </small>
                </td>
                <td class="py-3">
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/batch/job/${job.id}" class="btn btn-outline-primary btn-sm" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        ${['pending', 'running'].includes(job.status) ? 
                            `<button class="btn btn-outline-warning btn-sm" 
                                    onclick="cancelJob('${job.id}')" title="Cancel Job">
                                <i class="fas fa-stop"></i>
                            </button>` : ''
                        }
                        ${['completed', 'failed', 'cancelled'].includes(job.status) ? 
                            `<button class="btn btn-outline-secondary btn-sm" 
                                    onclick="archiveJob('${job.id}')" title="Archive Job">
                                <i class="fas fa-archive"></i>
                            </button>` : ''
                        }
                        ${job.status === 'archived' ? 
                            `<button class="btn btn-outline-danger btn-sm" 
                                    onclick="deleteJob('${job.id}')" title="Delete Job">
                                <i class="fas fa-trash"></i>
                            </button>` : ''
                        }
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Update stats cards
    function updateStatsCards(stats) {
        if (stats) {
            document.getElementById('totalJobs').textContent = stats.total || 0;
            document.getElementById('pendingJobs').textContent = stats.pending || 0;
            document.getElementById('runningJobs').textContent = stats.running || 0;
            document.getElementById('completedJobs').textContent = stats.completed || 0;
            document.getElementById('failedJobs').textContent = stats.failed || 0;
            document.getElementById('archivedJobs').textContent = stats.archived || 0;
        }
    }

    // Apply filters
    function applyFilters() {
        const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const analysisTypeFilter = document.getElementById('analysisTypeFilter').value;
        
        const jobRows = document.querySelectorAll('.job-row');
        let visibleCount = 0;

        jobRows.forEach(row => {
            const jobName = row.querySelector('h6').textContent.toLowerCase();
            const jobDescription = row.querySelector('small')?.textContent.toLowerCase() || '';
            const jobStatus = row.dataset.status;
            const analysisTypes = row.dataset.analysisTypes;

            let matchesSearch = true;
            let matchesStatus = true;
            let matchesAnalysisType = true;

            if (searchTerm) {
                matchesSearch = jobName.includes(searchTerm) || jobDescription.includes(searchTerm);
            }

            if (statusFilter) {
                matchesStatus = jobStatus === statusFilter;
            }

            if (analysisTypeFilter) {
                matchesAnalysisType = analysisTypes.includes(analysisTypeFilter);
            }

            const isVisible = matchesSearch && matchesStatus && matchesAnalysisType;
            
            if (isVisible) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('visibleJobsCount').textContent = visibleCount;

        // Show/hide no jobs row
        const noJobsRow = document.getElementById('noJobsRow');
        if (noJobsRow) {
            noJobsRow.style.display = visibleCount === 0 && jobRows.length > 0 ? '' : 'none';
        }
    }

    // Event listeners for filters
    document.getElementById('searchFilter').addEventListener('input', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('analysisTypeFilter').addEventListener('change', applyFilters);

    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('searchFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('analysisTypeFilter').value = '';
        applyFilters();
    });

    // Refresh button
    document.getElementById('refreshJobs').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('spinning');
        refreshJobsData();
        setTimeout(() => icon.classList.remove('spinning'), 1000);
    });

    // Create job button - now just redirects to /batch/create page
    // document.getElementById('createJobBtn').addEventListener('click', createNewJob);

    // Job actions
    window.cancelJob = function(jobId) {
        if (confirm('Are you sure you want to cancel this job?')) {
            fetch(`/batch/job/${jobId}/cancel`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Job cancelled successfully', 'success');
                        refreshJobsData();
                    } else {
                        showToast(data.error || 'Failed to cancel job', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error cancelling job:', error);
                    showToast('Failed to cancel job', 'error');
                });
        }
    };

    window.archiveJob = function(jobId) {
        if (confirm('Are you sure you want to archive this job?')) {
            fetch(`/batch/job/${jobId}/archive`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Job archived successfully', 'success');
                        refreshJobsData();
                    } else {
                        showToast(data.error || 'Failed to archive job', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error archiving job:', error);
                    showToast('Failed to archive job', 'error');
                });
        }
    };

    window.deleteJob = function(jobId) {
        if (confirm('Are you sure you want to permanently delete this job? This action cannot be undone.')) {
            fetch(`/batch/job/${jobId}/delete`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Job deleted successfully', 'success');
                        refreshJobsData();
                    } else {
                        showToast(data.error || 'Failed to delete job', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting job:', error);
                    showToast('Failed to delete job', 'error');
                });
        }
    };

    // Removed createNewJob function - now using direct link to /batch/create

    // Show toast notifications
    window.showToast = function(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                <span>${message}</span>
                <button type="button" class="close ml-auto" onclick="this.parentElement.parentElement.remove()">
                    <span>&times;</span>
                </button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    };

    // Initialize
    applyFilters();
    if (autoRefreshEnabled) {
        startAutoRefresh();
    }
});
</script>
{% endblock %}
