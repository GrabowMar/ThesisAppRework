{% extends "base.html" %}

{% block title %}Dashboard - Thesis Research App{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-tachometer-alt text-primary mr-2"></i>
                        AI Research Dashboard
                    </h1>
                    <p class="text-muted mb-0">
                        Manage {{ summary_stats.total_models|default(30) }} AI models and {{ summary_stats.total_apps|default(900) }} generated applications
                    </p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary"
                            hx-get="/api/dashboard/refresh-all"
                            hx-target="#dashboard-models"
                            hx-indicator="#refresh-spinner">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-outline-secondary" 
                            _="on click toggle .d-none on #advanced-filters">
                        <i class="fas fa-filter mr-1"></i>Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="row mb-4" 
         hx-get="/api/dashboard/stats"
         hx-trigger="load, every 60s"
         hx-swap="innerHTML"
         id="summary-stats">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card border-left-primary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label font-weight-bold text-primary text-uppercase mb-1">
                                AI Models
                            </div>
                            <div class="stat-value h5 mb-0 font-weight-bold text-gray-800">
                                {{ summary_stats.total_models|default(30) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-robot fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card border-left-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label font-weight-bold text-success text-uppercase mb-1">
                                Generated Apps
                            </div>
                            <div class="stat-value h5 mb-0 font-weight-bold text-gray-800">
                                {{ summary_stats.total_apps|default(900) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-mobile-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card border-left-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label font-weight-bold text-info text-uppercase mb-1">
                                Running Containers
                            </div>
                            <div class="stat-value h5 mb-0 font-weight-bold text-gray-800">
                                {{ summary_stats.running_containers|default(0) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-play-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card border-left-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label font-weight-bold text-warning text-uppercase mb-1">
                                Docker Status
                            </div>
                            <div class="stat-value h6 mb-0 font-weight-bold text-gray-800">
                                {{ summary_stats.docker_health|default('Unknown') }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fab fa-docker fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                                <input type="search" 
                                       class="form-control" 
                                       id="search-input"
                                       name="search"
                                       placeholder="Search models, apps, or containers..."
                                       hx-get="/api/dashboard/search"
                                       hx-trigger="keyup changed delay:500ms"
                                       hx-target="#dashboard-models"
                                       hx-include="[name='filter-provider'], [name='filter-status']">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" name="filter-provider"
                                    hx-get="/api/dashboard/search"
                                    hx-trigger="change"
                                    hx-target="#dashboard-models"
                                    hx-include="[name='search'], [name='filter-status']">
                                <option value="">All Providers</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="google">Google</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="qwen">Qwen</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" name="filter-status"
                                    hx-get="/api/dashboard/search"
                                    hx-trigger="change"
                                    hx-target="#dashboard-models"
                                    hx-include="[name='search'], [name='filter-provider']">
                                <option value="">All Status</option>
                                <option value="running">Running</option>
                                <option value="stopped">Stopped</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters (Initially Hidden) -->
                    <div id="advanced-filters" class="d-none mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="small text-muted">Container Type</label>
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="frontend" id="filter-frontend">
                                    <label class="form-check-label small" for="filter-frontend">Frontend</label>
                                </div>
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="backend" id="filter-backend">
                                    <label class="form-check-label small" for="filter-backend">Backend</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted">Analysis Status</label>
                                <select class="form-control form-control-sm">
                                    <option value="">Any</option>
                                    <option value="analyzed">Analyzed</option>
                                    <option value="pending">Pending</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted">Performance</label>
                                <select class="form-control form-control-sm">
                                    <option value="">Any</option>
                                    <option value="tested">Tested</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="refresh-spinner" class="htmx-indicator">
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Refreshing dashboard data...</p>
        </div>
    </div>

    <!-- Models Grid -->
    <div id="dashboard-models" 
         hx-get="/api/dashboard/models"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading AI models and applications...</p>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" role="dialog" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modelDetailsModalLabel">
                    <i class="fas fa-robot mr-2"></i>Model Details
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="model-details-content">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container Logs Modal -->
<div class="modal fade" id="containerLogsModal" tabindex="-1" role="dialog" aria-labelledby="containerLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="containerLogsModalLabel">
                    <i class="fas fa-terminal mr-2"></i>Container Logs
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div id="container-logs-content" style="height: 500px; overflow-y: auto;">
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global functions for modals and interactions
    window.showModelDetails = function(modelSlug) {
        htmx.ajax('GET', `/api/model/${modelSlug}/details`, {
            target: '#model-details-content',
            swap: 'innerHTML'
        });
        $('#modelDetailsModal').modal('show');
    };

    window.showContainerLogs = function(modelSlug, appNum) {
        htmx.ajax('GET', `/api/containers/${modelSlug}/${appNum}/logs`, {
            target: '#container-logs-content',
            swap: 'innerHTML'
        });
        $('#containerLogsModal').modal('show');
    };

    window.startContainer = function(modelSlug, appNum, element) {
        const originalHtml = element.innerHTML;
        element.innerHTML = '<span class="spinner-border spinner-border-sm mr-1"></span>Starting...';
        element.disabled = true;
        
        htmx.ajax('POST', `/api/containers/${modelSlug}/${appNum}/start`, {
            target: `#app-${modelSlug}-${appNum}`,
            swap: 'outerHTML'
        }).then(() => {
            element.innerHTML = originalHtml;
            element.disabled = false;
        });
    };

    window.stopContainer = function(modelSlug, appNum, element) {
        const originalHtml = element.innerHTML;
        element.innerHTML = '<span class="spinner-border spinner-border-sm mr-1"></span>Stopping...';
        element.disabled = true;
        
        htmx.ajax('POST', `/api/containers/${modelSlug}/${appNum}/stop`, {
            target: `#app-${modelSlug}-${appNum}`,
            swap: 'outerHTML'
        }).then(() => {
            element.innerHTML = originalHtml;
            element.disabled = false;
        });
    };

    window.restartContainer = function(modelSlug, appNum, element) {
        const originalHtml = element.innerHTML;
        element.innerHTML = '<span class="spinner-border spinner-border-sm mr-1"></span>Restarting...';
        element.disabled = true;
        
        htmx.ajax('POST', `/api/containers/${modelSlug}/${appNum}/restart`, {
            target: `#app-${modelSlug}-${appNum}`,
            swap: 'outerHTML'
        }).then(() => {
            element.innerHTML = originalHtml;
            element.disabled = false;
        });
    };

    // Enhanced HTMX event handling
    document.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
            // Auto-refresh stats after successful container operations
            if (evt.detail.pathInfo.xhr.responseURL.includes('/containers/')) {
                setTimeout(() => {
                    htmx.trigger('#summary-stats', 'load');
                }, 1000);
            }
        }
    });

    // Initialize tooltips after HTMX content loads
    document.addEventListener('htmx:afterSwap', function() {
        $('[data-toggle="tooltip"]').tooltip();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+F - Focus search
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            document.getElementById('search-input').focus();
        }
        
        // Ctrl+R - Refresh dashboard
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            htmx.trigger('#dashboard-models', 'load');
            htmx.trigger('#summary-stats', 'load');
        }
    });

    // Auto-refresh functionality
    let autoRefreshInterval;
    const startAutoRefresh = () => {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        
        autoRefreshInterval = setInterval(() => {
            if (!document.hidden) {
                htmx.trigger('#summary-stats', 'load');
                // Optionally refresh the models grid less frequently
                if (Math.random() < 0.3) { // 30% chance every cycle
                    htmx.trigger('#dashboard-models', 'load');
                }
            }
        }, 30000); // 30 seconds
    };

    // Start auto-refresh on page load
    document.addEventListener('DOMContentLoaded', startAutoRefresh);

    // Pause/resume auto-refresh based on page visibility
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        } else {
            startAutoRefresh();
            // Immediately refresh when page becomes visible
            htmx.trigger('#summary-stats', 'load');
        }
    });
</script>
{% endblock %}
