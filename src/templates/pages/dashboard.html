{% extends "layouts/base.html" %}

{% block title %}Dashboard - Thesis Research App{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1>📊 Dashboard</h1>
            <p class="page-subtitle">Overview of all AI-generated applications and their analysis status</p>
        </div>
        
        <div class="page-actions">
            <button class="btn btn-primary"
                    hx-get="{{ url_for('batch.create_batch_job') }}"
                    hx-target="#modal-container">
                🚀 Start Batch Analysis
            </button>
            
            <button class="btn btn-secondary"
                    hx-get="{{ url_for('api.advanced_search') }}"
                    hx-target="#modal-container">
                🔍 Advanced Search
            </button>
        </div>
    </div>
    
    <!-- Dashboard Stats -->
    <div class="dashboard-stats" 
         hx-get="{{ url_for('api.dashboard_stats') }}"
         hx-trigger="load, every 30s"
         hx-target="#stats-container">
        <div id="stats-container" class="stats-grid">
            <!-- Stats loaded via HTMX -->
            <div class="stat-card">
                <div class="stat-value">{{ total_apps|default('Loading...') }}</div>
                <div class="stat-label">Total Applications</div>
                <div class="stat-icon">📱</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ running_apps|default('Loading...') }}</div>
                <div class="stat-label">Running Containers</div>
                <div class="stat-icon">🏃‍♂️</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ completed_analyses|default('Loading...') }}</div>
                <div class="stat-label">Completed Analyses</div>
                <div class="stat-icon">✅</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ models_count|default('Loading...') }}</div>
                <div class="stat-label">AI Models</div>
                <div class="stat-icon">🤖</div>
            </div>
        </div>
    </div>
    
    <!-- Applications List -->
    <div class="dashboard-content">
        <div class="content-header">
            <h2>Applications</h2>
            
            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="grid">
                    📱 Grid
                </button>
                <button class="toggle-btn" data-view="table">
                    📋 Table
                </button>
            </div>
        </div>
        
        <!-- App List Container -->
        <div id="app-list" 
             class="app-list"
             hx-get="{{ url_for('api.search_apps') }}"
             hx-trigger="load"
             hx-target="this"
             hx-indicator="#loading-apps">
            
            <!-- Loading state -->
            <div id="loading-apps" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading applications...</p>
            </div>
        </div>
        
        <!-- Pagination will be loaded with the app list -->
        <div id="pagination-container"></div>
    </div>
</div>

<!-- Load More Button (for infinite scroll alternative) -->
<div id="load-more-container" style="display: none;">
    <button class="btn btn-secondary btn-block"
            hx-get="{{ url_for('api.search_apps') }}"
            hx-target="#app-list"
            hx-swap="beforeend"
            hx-vals='{"page": "{{ next_page }}", "append": "true"}'>
        Load More Applications
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
// View toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    const appList = document.getElementById('app-list');
    
    toggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            toggleBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update view class
            const view = this.dataset.view;
            appList.className = appList.className.replace(/view-\w+/, '') + ` view-${view}`;
        });
    });
    
    // Auto-refresh every 2 minutes
    setInterval(function() {
        htmx.trigger('#app-list', 'load');
    }, 120000);
});
</script>
{% endblock %}
