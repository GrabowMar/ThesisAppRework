{# Import Models migrated fully to pages/models #}
{% extends 'layouts/base_smart.html' %}
{% set page_title = 'Import Models' %}
{% set page_icon = 'fa-solid fa-upload' %}
{% set page_subtitle = 'Upload JSON export or ZIP archive to restore data' %}
{% set active_page = 'models' %}

{% block content %}
<div class="page-header mb-4">
  <div class="row align-items-center">
    <div class="col-auto">
      <span class="page-icon bg-primary-lt text-primary rounded-3 p-2">
        <i class="{{ page_icon }} fa-lg"></i>
      </span>
    </div>
    <div class="col">
      <h1 class="page-title mb-1">{{ page_title }}</h1>
      <p class="text-muted mb-0">{{ page_subtitle }}</p>
    </div>
    <div class="col-auto ms-auto">
      <div class="btn-list">
        <a href="/models" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left me-2"></i>Back to Models
        </a>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title"><i class="fa-solid fa-file-import me-2"></i>Import File</h3>
  </div>
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Import File</label>
      <input type="file" id="models-file" class="form-control" accept=".json,.zip,application/json,application/zip" />
      <small class="form-hint">Upload a JSON export for models, or a ZIP archive to restore full export (results, apps, metadata).</small>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" onclick="importModels()"><i class="fa-solid fa-upload me-1"></i>Import</button>
      <a href="/models" class="btn btn-outline-secondary">Cancel</a>
    </div>
    <div class="mt-3" id="import-result"></div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
async function importModels() {
    const input = document.getElementById('models-file');
    const out = document.getElementById('import-result');
    out.innerHTML = '';
    
    if (!input.files || !input.files[0]) {
        out.innerHTML = '<div class="alert alert-warning">Choose a file (.json or .zip).</div>';
        return;
    }
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading
    out.innerHTML = '<div class="d-flex align-items-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Importing... This may take a moment for large ZIP files.</div>';
    
    try {
        const res = await fetch('/api/models/import', {
            method: 'POST',
            body: formData
        });
        
        let data;
        try {
            data = await res.json();
        } catch (err) {
            throw new Error(`Invalid response from server (${res.status})`);
        }
        
        if (!res.ok || data.success === false) {
             const msg = (data.error && data.error.message) || data.error || data.message || res.statusText;
             out.innerHTML = `<div class="alert alert-danger">Import failed: ${msg}</div>`;
        } else {
             if (data.restored) {
                 // ZIP result
                 out.innerHTML = `<div class="alert alert-success">
                    <h4 class="alert-title">Import Successful</h4>
                    <div class="text-secondary">
                        Restored: <strong>${data.restored.generated || 0}</strong> apps/files, <strong>${data.restored.results || 0}</strong> results.<br>
                        Sync: ${data.sync_result ? data.sync_result.created_apps + ' apps created' : 'Done'}
                    </div>
                 </div>`;
             } else {
                 // JSON result
                 out.innerHTML = `<div class="alert alert-success">Imported. ${data.message}</div>`;
             }
        }
    } catch (e) {
        out.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`;
    }
}
</script>
{% endblock %}

