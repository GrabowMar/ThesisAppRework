{# Usage Analytics Section - Compact #}
{% set running_count = stats.get('running_apps', 0) %}
{% set total_apps = stats.get('applications', 0) %}
{% set security_tests = stats.get('security_tests', 0) %}
{% set performance_tests = stats.get('performance_tests', 0) %}
{% set total_issues = stats.get('total_issues') %}

<div class="row g-2">
  {# Compact Stat Row #}
  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-{{ 'success' if running_count > 0 else 'secondary' }}-lt text-{{ 'success' if running_count > 0 else 'secondary' }} avatar avatar-sm me-2"><i class="fa-solid fa-play"></i></span>
          <div>
            <div class="text-muted small">Running</div>
            <div class="fw-bold">{{ running_count }}<span class="text-muted small fw-normal"> / {{ total_apps }}</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-{{ 'primary' if security_tests > 0 else 'secondary' }}-lt text-{{ 'primary' if security_tests > 0 else 'secondary' }} avatar avatar-sm me-2"><i class="fa-solid fa-shield-alt"></i></span>
          <div>
            <div class="text-muted small">Security</div>
            <div class="fw-bold">{{ security_tests }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-{{ 'info' if performance_tests > 0 else 'secondary' }}-lt text-{{ 'info' if performance_tests > 0 else 'secondary' }} avatar avatar-sm me-2"><i class="fa-solid fa-tachometer-alt"></i></span>
          <div>
            <div class="text-muted small">Performance</div>
            <div class="fw-bold">{{ performance_tests }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-{{ 'danger' if total_issues and total_issues > 20 else 'warning' if total_issues and total_issues > 0 else 'success' if total_issues is not none else 'secondary' }}-lt text-{{ 'danger' if total_issues and total_issues > 20 else 'warning' if total_issues and total_issues > 0 else 'success' if total_issues is not none else 'secondary' }} avatar avatar-sm me-2"><i class="fa-solid fa-bug"></i></span>
          <div>
            <div class="text-muted small">Issues Found</div>
            <div class="fw-bold">{% if total_issues is not none %}{{ total_issues }}{% else %}—{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# Application Timeline Table (only if apps exist) #}
{% if applications and applications|length > 0 %}
<div class="row g-2 mt-0">
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-history text-primary me-2"></i>
          <span class="fw-bold small">Recent Applications</span>
        </div>
        {% if applications|length > 5 %}
        <a href="/applications?model={{ model_slug }}" class="btn btn-sm btn-ghost-primary py-0">All {{ applications|length }}</a>
        {% endif %}
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-vcenter table-hover card-table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Status</th>
                <th>Framework</th>
                <th>Created</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for app in recent_apps[:5] %}
              <tr>
                <td><a href="/applications/{{ app.model_slug }}/{{ app.app_number }}" class="fw-medium">{{ app.app_number }}</a></td>
                <td>
                  {% if app.container_status == 'running' %}<span class="badge bg-success-lt text-success">Running</span>
                  {% elif app.container_status == 'stopped' %}<span class="badge bg-warning-lt text-warning">Stopped</span>
                  {% else %}<span class="badge bg-secondary-lt">{{ app.container_status or 'Unknown' }}</span>{% endif %}
                </td>
                <td>
                  {% if app.backend_framework %}<span class="badge bg-info-lt">{{ app.backend_framework }}</span>{% endif %}
                  {% if not app.backend_framework %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td class="text-muted small">{{ app.created_at.strftime('%m/%d %H:%M') if app.created_at else '—' }}</td>
                <td class="text-end"><a href="/applications/{{ app.model_slug }}/{{ app.app_number }}" class="btn btn-sm btn-ghost-primary py-0"><i class="fa-solid fa-arrow-right"></i></a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {# Status Distribution & Insights - Compact Side by Side #}
  <div class="col-md-6">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-chart-pie text-info me-2" aria-hidden="true"></i>
          <span class="text-muted small text-uppercase fw-bold">Distribution</span>
        </div>
        {% set stopped_count = applications|selectattr('container_status', 'equalto', 'stopped')|list|length %}
        {% set other_count = total_apps - running_count - stopped_count %}
        <div class="d-flex gap-3 small">
          <div><span class="badge bg-success me-1"></span>Running: <strong>{{ running_count }}</strong></div>
          <div><span class="badge bg-warning me-1"></span>Stopped: <strong>{{ stopped_count }}</strong></div>
          {% if other_count > 0 %}<div><span class="badge bg-secondary me-1"></span>Other: <strong>{{ other_count }}</strong></div>{% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-info-circle text-secondary me-2" aria-hidden="true"></i>
          <span class="text-muted small text-uppercase fw-bold">Insights</span>
        </div>
        <div class="small">
          <div class="d-flex justify-content-between"><span class="text-muted">Total Apps</span><strong>{{ total_apps }}</strong></div>
          <div class="d-flex justify-content-between"><span class="text-muted">Analysis Coverage</span><strong>{% set total_analyses = security_tests + performance_tests %}{% if total_apps > 0 %}{{ ((total_analyses / (total_apps * 2) * 100)|round(1)) }}%{% else %}0%{% endif %}</strong></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="row g-2 mt-0">
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-body py-3 text-center">
        <i class="fa-solid fa-chart-line text-muted me-2" aria-hidden="true"></i>
        <span class="text-muted">No applications generated yet.</span>
        <button class="btn btn-sm btn-primary ms-2" onclick="generateApplication()"><i class="fa-solid fa-plus me-1"></i>Generate</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
