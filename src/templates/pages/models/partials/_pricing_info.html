{% set nested_pricing = enriched_data.get('capabilities', {}).get('pricing', {}) %}
{% set prompt_price = nested_pricing.get('prompt') %}
{% if prompt_price %}{% set prompt_price = prompt_price | float %}{% else %}{% set prompt_price = enriched_data.get('openrouter_prompt_price') %}{% endif %}

{% set completion_price = nested_pricing.get('completion') %}
{% if completion_price %}{% set completion_price = completion_price | float %}{% else %}{% set completion_price = enriched_data.get('openrouter_completion_price') %}{% endif %}

{% set additional_pricing = [
  ('Per request', nested_pricing.get('request') or enriched_data.get('openrouter_pricing_request')),
  ('Per image', nested_pricing.get('image') or enriched_data.get('openrouter_pricing_image')),
  ('Web search', nested_pricing.get('web_search') or enriched_data.get('openrouter_pricing_web_search')),
  ('Internal reasoning', nested_pricing.get('internal_reasoning') or enriched_data.get('openrouter_pricing_internal_reasoning')),
  ('Cache read', enriched_data.get('openrouter_pricing_input_cache_read')),
  ('Cache write', enriched_data.get('openrouter_pricing_input_cache_write'))
] %}

<div class="row g-2">
  {# Main Pricing Stats - Compact horizontal row #}
  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-success-lt text-success avatar avatar-sm me-2"><i class="fa-solid fa-arrow-down"></i></span>
          <div>
            <div class="text-muted small">Input</div>
            <div class="fw-bold">{% if prompt_price %}${{ '%.6f'|format(prompt_price) }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-primary-lt text-primary avatar avatar-sm me-2"><i class="fa-solid fa-arrow-up"></i></span>
          <div>
            <div class="text-muted small">Output</div>
            <div class="fw-bold">{% if completion_price %}${{ '%.6f'|format(completion_price) }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="bg-info-lt text-info avatar avatar-sm me-2"><i class="fa-solid fa-balance-scale"></i></span>
          <div>
            <div class="text-muted small">Efficiency</div>
            <div class="fw-bold">{% if model.get('cost_efficiency') %}{{ '%.2f'|format(model.get('cost_efficiency')) }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-3">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="{% if model.get('is_free') %}bg-success-lt text-success{% else %}bg-secondary-lt text-secondary{% endif %} avatar avatar-sm me-2"><i class="fa-solid fa-{% if model.get('is_free') %}gift{% else %}dollar-sign{% endif %}"></i></span>
          <div>
            <div class="text-muted small">Tier</div>
            <div class="fw-bold">{% if model.get('is_free') %}Free{% else %}Paid{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Additional Pricing & Price Comparison - Always side by side #}
  <div class="col-md-6">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-file-invoice-dollar text-warning me-2" aria-hidden="true"></i>
          <span class="text-muted small text-uppercase fw-bold">Additional Pricing</span>
        </div>
        {% set addon_ns = namespace(has_addons=false) %}
        <div class="small">
          {% for pair in additional_pricing %}
            {% set label = pair[0] %}
            {% set raw_value = pair[1] %}
            {% if raw_value is not none and raw_value != '' %}
              {% set numeric = raw_value | float %}
              {% if numeric %}
                {% set addon_ns.has_addons = true %}
                <div class="d-flex justify-content-between"><span class="text-muted">{{ label }}</span><span>${{ '%.6f'|format(numeric) }}</span></div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
        {% if not addon_ns.has_addons %}
          <span class="text-muted small">No additional fees published</span>
        {% endif %}
      </div>
    </div>
  </div>

  {# Price Comparison Chart - Always show #}
  <div class="col-md-6">
    <div class="card card-sm h-100">
      <div class="card-body py-2">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-chart-bar text-info me-2" aria-hidden="true"></i>
          <span class="text-muted small text-uppercase fw-bold">vs Average</span>
        </div>
        {% if stats and (stats.get('avg_prompt_price') or stats.get('avg_completion_price')) %}
        <div class="row">
          <div class="col-6"><canvas id="promptPriceChart" style="max-height: 100px;"></canvas></div>
          <div class="col-6"><canvas id="completionPriceChart" style="max-height: 100px;"></canvas></div>
        </div>
        {% else %}
        <span class="text-muted small">No comparison data available</span>
        {% endif %}
      </div>
    </div>
  </div>

  {# Pricing Notes - Inline #}
  <div class="col-12">
    <div class="text-muted small text-center">
      <i class="fa-solid fa-info-circle me-1"></i>Prices from OpenRouter catalog; confirm with provider before cost-sensitive deployments.
    </div>
  </div>
</div>

{% if stats and (stats.get('avg_prompt_price') or stats.get('avg_completion_price')) %}
<script>
(function() {
  // Wait for Chart.js to be available
  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded yet, retrying...');
    setTimeout(arguments.callee, 100);
    return;
  }

  const modelPromptPrice = {{ prompt_price|default(0) }};
  const avgPromptPrice = {{ stats.get('avg_prompt_price', 0)|default(0) }};
  const modelCompletionPrice = {{ completion_price|default(0) }};
  const avgCompletionPrice = {{ stats.get('avg_completion_price', 0)|default(0) }};

  const chartConfig = {
    type: 'bar',
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return '$' + context.parsed.y.toFixed(6) + ' per 1K tokens';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(6);
            }
          }
        }
      }
    }
  };

  // Prompt Price Chart
  if (modelPromptPrice || avgPromptPrice) {
    new Chart(document.getElementById('promptPriceChart'), {
      ...chartConfig,
      data: {
        labels: ['This Model', 'DB Average'],
        datasets: [{
          label: 'Prompt Price',
          data: [modelPromptPrice, avgPromptPrice],
          backgroundColor: [
            modelPromptPrice < avgPromptPrice ? 'rgba(32, 201, 151, 0.7)' : 'rgba(251, 99, 71, 0.7)',
            'rgba(102, 126, 234, 0.5)'
          ],
          borderColor: [
            modelPromptPrice < avgPromptPrice ? 'rgb(32, 201, 151)' : 'rgb(251, 99, 71)',
            'rgb(102, 126, 234)'
          ],
          borderWidth: 1
        }]
      }
    });
  }

  // Completion Price Chart
  if (modelCompletionPrice || avgCompletionPrice) {
    new Chart(document.getElementById('completionPriceChart'), {
      ...chartConfig,
      data: {
        labels: ['This Model', 'DB Average'],
        datasets: [{
          label: 'Completion Price',
          data: [modelCompletionPrice, avgCompletionPrice],
          backgroundColor: [
            modelCompletionPrice < avgCompletionPrice ? 'rgba(32, 201, 151, 0.7)' : 'rgba(251, 99, 71, 0.7)',
            'rgba(102, 126, 234, 0.5)'
          ],
          borderColor: [
            modelCompletionPrice < avgCompletionPrice ? 'rgb(32, 201, 151)' : 'rgb(251, 99, 71)',
            'rgb(102, 126, 234)'
          ],
          borderWidth: 1
        }]
      }
    });
  }
})();
</script>
{% endif %}
