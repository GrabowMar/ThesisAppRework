{% set nested_caps = enriched_data.get('capabilities', {}) %}

<div class="row g-2">
  {# Quick Reference - Compact inline #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-body py-2">
        <div class="d-flex flex-wrap align-items-center gap-3 small">
          <div class="d-flex align-items-center"><span class="text-muted me-1">Model ID:</span> <code>{{ model.model_id or model_slug }}</code></div>
          <div class="d-flex align-items-center"><span class="text-muted me-1">DB ID:</span> <strong>#{{ model.id }}</strong></div>
          <div class="d-flex align-items-center"><span class="text-muted me-1">Provider:</span> <span class="badge bg-primary-lt text-primary">{{ model.provider }}</span></div>
          {% if model.canonical_slug %}<div class="d-flex align-items-center"><span class="text-muted me-1">Canonical:</span> <code>{{ model.canonical_slug }}</code></div>{% endif %}
          <div class="ms-auto d-flex gap-1">
            <a href="/models/{{ model_slug }}/export.json" class="btn btn-sm btn-ghost-primary py-0 px-2"><i class="fas fa-code me-1"></i>JSON</a>
            <button class="btn btn-sm btn-ghost-secondary py-0 px-2" onclick="copyModelData(event)"><i class="fas fa-copy me-1"></i>Copy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# OpenRouter Metadata - Compact Table #}
  {% if nested_caps %}
  <div class="col-lg-6">
    <div class="card card-sm h-100">
      <div class="card-header py-2">
        <div class="d-flex align-items-center">
          <i class="fas fa-cloud text-purple me-2" aria-hidden="true"></i>
          <span class="fw-bold small">OpenRouter Metadata</span>
          <span class="badge bg-secondary-lt ms-2">{{ nested_caps|length }} keys</span>
        </div>
      </div>
      <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0">
          <tbody>
            {% for key, value in nested_caps.items() if value is not none and value != '' %}
            <tr>
              <td class="text-muted small" style="width: 40%;"><code>{{ key }}</code></td>
              <td class="small">
                {% if value is mapping %}
                  <details><summary class="text-primary" style="cursor:pointer;">{{ value | length }} keys</summary><pre class="mt-1 bg-light p-2 rounded small mb-0">{{ value | tojson(indent=2) }}</pre></details>
                {% elif value is iterable and value is not string %}
                  {% if value | length > 3 %}{{ value[:3] | join(', ') }} <span class="text-muted">(+{{ value | length - 3 }})</span>{% else %}{{ value | join(', ') }}{% endif %}
                {% elif value is number %}
                  {% if value > 1000 %}{{ '{:,}'.format(value) }}{% else %}{{ value }}{% endif %}
                {% else %}
                  {% set sv = value | string %}{% if sv | length > 80 %}{{ sv[:77] }}...{% else %}{{ sv }}{% endif %}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {# Enriched Dataset - Compact Table #}
  <div class="col-lg-6">
    <div class="card card-sm h-100">
      <div class="card-header py-2">
        <div class="d-flex align-items-center">
          <i class="fas fa-database text-success me-2" aria-hidden="true"></i>
          <span class="fw-bold small">Enriched Dataset</span>
          <span class="badge bg-secondary-lt ms-2">{{ enriched_data|length }} keys</span>
        </div>
      </div>
      <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0">
          <tbody>
            {% for key, value in enriched_data.items() if value is not none and value != '' %}
            <tr>
              <td class="text-muted small" style="width: 40%;"><code>{{ key }}</code></td>
              <td class="small">
                {% if value is mapping %}
                  <details><summary class="text-primary" style="cursor:pointer;">{{ value | length }} keys</summary><pre class="mt-1 bg-light p-2 rounded small mb-0">{{ value | tojson(indent=2) }}</pre></details>
                {% elif value is iterable and value is not string %}
                  {% if value | length > 3 %}{{ value[:3] | join(', ') }} <span class="text-muted">(+{{ value | length - 3 }})</span>{% else %}{{ value | join(', ') }}{% endif %}
                {% elif value is number %}
                  {% if value > 1000 %}{{ '{:,}'.format(value) }}{% else %}{{ value }}{% endif %}
                {% else %}
                  {% set sv = value | string %}{% if sv | length > 80 %}{{ sv[:77] }}...{% else %}{{ sv }}{% endif %}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Raw JSON Payload - Collapsed by default #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-body py-2">
        <details>
          <summary class="d-flex align-items-center" style="cursor: pointer;">
            <i class="fas fa-code text-secondary me-2" aria-hidden="true"></i>
            <span class="fw-bold small">Raw JSON Payload</span>
            <button class="btn btn-sm btn-ghost-secondary ms-auto py-0" onclick="event.stopPropagation(); copyAdjacentPre(this.parentElement.nextElementSibling.querySelector('pre'))">
              <i class="fas fa-copy me-1"></i>Copy
            </button>
          </summary>
          <pre class="bg-dark text-white rounded p-3 small mt-2 mb-0" id="raw-json-data" style="max-height: 300px; overflow: auto;">{{ enriched_data | tojson(indent=2) }}</pre>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
function copyModelData(evt) {
  const data = document.getElementById('raw-json-data').textContent;
  navigator.clipboard.writeText(data).then(() => {
    const btn = evt.target.closest('button');
    if (!btn) return;
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
    setTimeout(() => { btn.innerHTML = original; }, 2000);
  }).catch(err => console.error('Failed to copy', err));
}
</script>
