{# Model Detail - Research Dashboard Design #}
{% extends 'layouts/base_smart.html' %}
{% from 'shared/macros/detail_macros.html' import research_detail_header, research_metric_grid, research_section_nav, research_scroll_spy_script %}
{% set active_page = 'models' %}
{% set page_title = view.title if view else 'Model Detail' %}

{% block content %}
<div class="research-detail-shell">
  {# Extract status badge from metrics if available #}
  {% set status_metric = metrics|selectattr('label', 'equalto', 'Status')|first if metrics else None %}
  {% set status_badge = {
    'label': status_metric.value,
    'color': status_metric.status_color or 'secondary',
    'animated': status_metric.status_color == 'success'
  } if status_metric else None %}
  
  {# Compact header bar with inline metrics and actions #}
  {{ research_detail_header(view, metrics[:3] if metrics and metrics|length > 3 else [], status_badge) }}
  
  {# Dense metric grid (4-6 per row) #}
  {{ research_metric_grid(metrics) }}
  
  {# Sticky horizontal section navigation #}
  {{ research_section_nav(sections) }}
  
  {# Vertical section layout with lazy loading #}
  <div class="research-content">
    {% for section in sections %}
      <section id="section-{{ section.id }}" 
               class="research-section" 
               data-research-section="{{ section.id }}"
               hx-get="{{ section.hx }}"
               hx-trigger="{% if loop.first %}load{% else %}intersect once threshold:0.1{% endif %}"
               hx-swap="innerHTML"
               aria-labelledby="section-{{ section.id }}-title">
        
        <div class="research-section-header">
          <h2 class="research-section-title" id="section-{{ section.id }}-title">
            <i class="{{ section.icon }}" aria-hidden="true"></i>
            <span>{{ section.label }}</span>
          </h2>
        </div>
        
        {# Skeleton loader placeholder #}
        <div class="research-skeleton" aria-live="polite" aria-busy="true">
          <div class="research-skeleton-line h-lg"></div>
          <div class="research-skeleton-line w-75"></div>
          <div class="research-skeleton-line w-50"></div>
        </div>
      </section>
    {% endfor %}
  </div>
</div>

<div id="modal-container"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{{ research_scroll_spy_script() }}
<script>
// Toast notification helper
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container') || (() => {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
    return container;
  })();
  
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} alert-dismissible fade show`;
  toast.role = 'alert';
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function copyAdjacentPre(btn) {
  const pre = btn.closest('.card')?.querySelector('pre');
  if (!pre) {
    showToast('Nothing to copy', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(pre.innerText).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-primary');
    setTimeout(() => {
      btn.innerHTML = orig;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 1200);
  }).catch(() => {
    showToast('Failed to copy to clipboard', 'danger');
  });
}

async function generateApplication() {
  try {
    // Show generating message immediately
    showToast('Starting application generation...', 'info');
    
    // Don't pre-fetch app number - let the service auto-allocate atomically
    // This prevents race conditions when multiple generations happen simultaneously
    htmx.ajax('POST', '/models/applications/generate', {
      target: '#section-applications',
      swap: 'innerHTML',
      values: {
        model_slug: '{{ model_slug }}',
        // app_number intentionally omitted - service will auto-allocate
        template_slug: 'crud_todo_list'  // Default template
      }
    }).then(() => {
      showToast('Application generation completed!', 'success');
    }).catch(() => {
      showToast('Failed to generate application', 'error');
    });
  } catch (error) {
    console.error('Error generating application:', error);
    showToast('Failed to start generation', 'error');
  }
}

async function regenerateApplication(modelSlug, appNumber) {
  if (!confirm(`Are you sure you want to regenerate application #${appNumber}? This will create a new version.`)) {
    return;
  }

  try {
    showToast('Starting regeneration...', 'info');
    
    const response = await fetch(`/api/models/${modelSlug}/apps/${appNumber}/regenerate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Regeneration failed');
    }
    
    const result = await response.json();
    showToast(`Application #${appNumber} v${result.version} regeneration started`, 'success');
    
    // Refresh the applications section after a short delay
    setTimeout(() => {
      htmx.ajax('GET', `/models/detail/${modelSlug}/section/applications`, {
        target: '#section-applications',
        swap: 'innerHTML'
      });
    }, 1500);
    
  } catch (error) {
    console.error('Error regenerating application:', error);
    showToast(error.message || 'Failed to regenerate application', 'error');
  }
}

function openModelComparison() {
  window.open('/models/comparison?models={{ model_slug }}', '_blank');
}

function refreshModelData() {
  showToast('Refreshing model data from OpenRouter...', 'info');
  fetch('/models/{{ model_slug }}/refresh', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('Model data refreshed successfully', 'success');
      // Reload the page to show fresh data
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to refresh model data', 'error');
    }
  })
  .catch(error => {
    console.error('Refresh error:', error);
    showToast('Failed to refresh model data', 'error');
  });
}

// Handle section loading states
document.addEventListener('htmx:beforeRequest', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.add('is-loading');
  }
});

document.addEventListener('htmx:afterSwap', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.remove('is-loading');
  }
});

// Listen for HTMX events
document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.successful) {
    console.log('HTMX request successful:', evt.detail.pathInfo.requestPath);
  } else {
    console.error('HTMX request failed:', evt.detail.pathInfo.requestPath);
  }
});

document.addEventListener('htmx:responseError', evt => {
  const section = evt.detail.elt;
  if (!section || !section.matches('[data-research-section]')) {
    showToast('A server error occurred. Please try again.', 'danger');
    return;
  }
  const sectionId = section.getAttribute('data-research-section');
  const sectionTitle = section.querySelector('.research-section-title span')?.textContent || 'Section';
  section.innerHTML = `
    <div class="research-section-header">
      <h2 class="research-section-title">
        <i class="fas fa-exclamation-triangle text-warning" aria-hidden="true"></i>
        <span>Failed to load ${sectionTitle}</span>
      </h2>
    </div>
    <div class="research-empty-state">
      <div class="research-empty-icon">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
      </div>
      <div class="research-empty-title">Content could not be loaded</div>
      <div class="research-empty-message">There was an error loading this section. Please try again.</div>
      <div class="research-empty-action">
        <button class="btn btn-primary" onclick="htmx.ajax('GET', '${section.getAttribute('hx-get')}', { target: '[data-research-section=\\'${sectionId}\\']', swap: 'innerHTML' })">
          <i class="fas fa-refresh me-1"></i>Retry
        </button>
      </div>
    </div>
  `;
  section.classList.remove('is-loading');
});
</script>
{% endblock %}
