{# Model Detail - Research Dashboard Design #}
{% extends 'layouts/base.html' %}
{% from 'components/detail_macros.html' import research_detail_header, research_metric_grid, research_section_nav, research_scroll_spy_script %}
{% set active_page = 'models' %}
{% set page_title = view.title if view else 'Model Detail' %}

{% block content %}
<div class="research-detail-shell">
  {# Compact header bar with inline metrics and actions #}
  {{ research_detail_header(view, metrics[:3] if metrics and metrics|length > 3 else []) }}
  
  {# Dense metric grid (4-6 per row) #}
  {{ research_metric_grid(metrics) }}
  
  {# Sticky horizontal section navigation #}
  {{ research_section_nav(sections) }}
  
  {# Vertical section layout with lazy loading #}
  <div class="research-content">
    {% for section in sections %}
      <section id="section-{{ section.id }}" 
               class="research-section" 
               data-research-section="{{ section.id }}"
               hx-get="{{ section.hx }}"
               hx-trigger="{% if loop.first %}load{% else %}intersect once threshold:0.1{% endif %}"
               hx-swap="innerHTML"
               aria-labelledby="section-{{ section.id }}-title">
        
        <div class="research-section-header">
          <h2 class="research-section-title" id="section-{{ section.id }}-title">
            <i class="{{ section.icon }}" aria-hidden="true"></i>
            <span>{{ section.label }}</span>
          </h2>
        </div>
        
        {# Skeleton loader placeholder #}
        <div class="research-skeleton" aria-live="polite" aria-busy="true">
          <div class="research-skeleton-line h-lg"></div>
          <div class="research-skeleton-line w-75"></div>
          <div class="research-skeleton-line w-50"></div>
        </div>
      </section>
    {% endfor %}
  </div>
  
  <div id="modal-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{{ research_scroll_spy_script() }}
<script>
function generateApplication() {
  const appNumber = Math.floor(Math.random() * 1000) + 1;
  htmx.ajax('POST', '/models/applications/generate', {
    target: '#section-applications',
    swap: 'innerHTML',
    values: {
      model_slug: '{{ model_slug }}',
      app_number: appNumber,
      app_type: 'web_app'
    }
  }).then(() => {
    showToast('Application generation started', 'success');
  }).catch(() => {
    showToast('Failed to start generation', 'error');
  });
}

function openModelComparison() {
  window.open('/models/comparison?models={{ model_slug }}', '_blank');
}

function refreshModelData() {
  showToast('Refreshing model data from OpenRouter...', 'info');
  fetch('/models/{{ model_slug }}/refresh', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('Model data refreshed successfully', 'success');
      // Reload the page to show fresh data
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to refresh model data', 'error');
    }
  })
  .catch(error => {
    console.error('Refresh error:', error);
    showToast('Failed to refresh model data', 'error');
  });
}

// Handle section loading states
document.addEventListener('htmx:beforeRequest', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.add('is-loading');
  }
});

document.addEventListener('htmx:afterSwap', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.remove('is-loading');
  }
});

document.addEventListener('htmx:responseError', evt => {
  const section = evt.detail.elt;
  if (!section || !section.matches('[data-research-section]')) {
    return;
  }
  const sectionId = section.getAttribute('data-research-section');
  const sectionTitle = section.querySelector('.research-section-title span')?.textContent || 'Section';
  section.innerHTML = `
    <div class="research-section-header">
      <h2 class="research-section-title">
        <i class="fas fa-exclamation-triangle text-warning" aria-hidden="true"></i>
        <span>Failed to load ${sectionTitle}</span>
      </h2>
    </div>
    <div class="research-empty-state">
      <div class="research-empty-icon">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
      </div>
      <div class="research-empty-title">Content could not be loaded</div>
      <div class="research-empty-message">There was an error loading this section. Please try again.</div>
      <div class="research-empty-action">
        <button class="btn btn-primary" onclick="htmx.ajax('GET', '${section.getAttribute('hx-get')}', { target: '[data-research-section=\\'${sectionId}\\']', swap: 'innerHTML' })">
          <i class="fas fa-refresh me-1"></i>Retry
        </button>
      </div>
    </div>
  `;
  section.classList.remove('is-loading');
});
</script>
{% endblock %}