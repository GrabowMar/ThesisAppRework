{# Application Detail - Clean Tabler Implementation #}
{% extends 'layouts/base.html' %}
{% set active_page = 'applications' %}
{% set page_title = view.title if view else 'Application Detail' %}

{% block content %}
{# Compact Research-Oriented Header - Table-like Flexbox Layout #}
<div class="page-header mb-0">
  <div class="d-flex align-items-center gap-3 p-3 border rounded bg-light">
    {# App Icon & Status Badge #}
    <div class="d-flex align-items-center gap-2">
      <div class="avatar avatar-md rounded" style="background-color: var(--tblr-primary-lt);">
        <i class="{{ view.icon if view else 'fas fa-cube' }}" style="color: var(--tblr-primary);"></i>
      </div>
      {% if metrics and metrics|length > 0 %}
        {% set container_metric = metrics|selectattr('label', 'equalto', 'Container')|first %}
        {% if container_metric %}
          <span class="badge bg-{{ container_metric.status_color or 'secondary' }}-lt text-{{ container_metric.status_color or 'secondary' }}">
            <span class="status-indicator {% if container_metric.status_color == 'success' %}status-indicator-animated{% endif %} bg-{{ container_metric.status_color or 'secondary' }} me-1"></span>
            {{ container_metric.value }}
          </span>
        {% endif %}
      {% endif %}
    </div>
    
    {# Application Identity & Metadata (Flex-fill for responsive growth) #}
    <div class="flex-fill">
      <div class="d-flex align-items-baseline gap-2">
        <h3 class="mb-0">{{ view.title if view else 'Application' }}</h3>
        {% if view and view.badges %}
          {% for badge in view.badges[:2] %}
            <span class="{{ badge.variant }} badge-sm">
              {% if badge.icon %}<i class="{{ badge.icon }} me-1"></i>{% endif %}
              {{ badge.label }}
            </span>
          {% endfor %}
        {% endif %}
      </div>
      <div class="text-secondary small mt-1 d-flex flex-wrap gap-2">
        {% if view and view.subtitle %}
          <span class="me-2">{{ view.subtitle }}</span>
        {% endif %}
        {% if metrics and metrics|length > 1 %}
          {% for metric in metrics[1:4] %}
            <span class="me-2">
              <i class="{{ metric.icon or 'fas fa-info-circle' }} me-1"></i>
              <strong>{{ metric.label }}:</strong> {{ metric.value }}
            </span>
          {% endfor %}
        {% endif %}
      </div>
    </div>
    
    {# Compact Action Buttons #}
    <div class="btn-list">
      {% if view and view.actions %}
        {% for action in view.actions %}
          {% if action.visible %}
            {% if action.type == 'link' %}
              <a href="{{ action.href }}" 
                 class="btn btn-sm {{ action.classes }}" 
                 {% if action.target %}target="{{ action.target }}"{% endif %}
                 title="{{ action.label }}"
                 aria-label="{{ action.label }}">
                <i class="{{ action.icon }}" aria-hidden="true"></i>
                <span class="d-none d-xl-inline ms-1">{{ action.label }}</span>
              </a>
            {% else %}
              <button class="btn btn-sm {{ action.classes }}" 
                      {% if action.onclick %}onclick="{{ action.onclick }}"{% endif %}
                      title="{{ action.label }}"
                      aria-label="{{ action.label }}">
                <i class="{{ action.icon }}" aria-hidden="true"></i>
                <span class="d-none d-xl-inline ms-1">{{ action.label }}</span>
              </button>
            {% endif %}
            {% if loop.index == 3 or loop.index == 5 %}
              <div class="vr d-none d-xl-inline"></div>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" role="tablist">
      {% for section in sections %}
      <li class="nav-item" role="presentation">
        <a href="#tab-{{ section.id }}" class="nav-link{% if loop.first %} active{% endif %}" data-bs-toggle="tab" role="tab" aria-controls="tab-{{ section.id }}">
          <i class="{{ section.icon }} me-1"></i>{{ section.label }}
        </a>
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">
      {% for section in sections %}
      <div class="tab-pane{% if loop.first %} active show{% endif %}" id="tab-{{ section.id }}" role="tabpanel"
           hx-get="{{ section.hx }}"
           hx-trigger="load once"
           hx-swap="innerHTML"
           hx-indicator="#tab-{{ section.id }}-spinner">
        <div class="text-center py-5" id="tab-{{ section.id }}-spinner">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="text-secondary">Loading {{ section.label|lower }}...</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div id="modal-container"></div>

{# Include container logs modal #}
{% include 'pages/applications/partials/modals/container_logs_modal.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/container_manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/container_logs.js') }}"></script>
<script>
// Toast notification helper
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container') || (() => {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
    return container;
  })();
  
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} alert-dismissible fade show`;
  toast.role = 'alert';
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function copyAdjacentPre(btn) {
  const pre = btn.closest('.card')?.querySelector('pre');
  if (!pre) {
    showToast('Nothing to copy', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(pre.innerText).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-primary');
    setTimeout(() => {
      btn.innerHTML = orig;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 1200);
  }).catch(() => {
    showToast('Failed to copy to clipboard', 'danger');
  });
}

function startApplication() {
  showToast('Starting application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/start', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application started successfully', 'success');
  }).catch(() => {
    showToast('Failed to start application', 'danger');
  });
}

function stopApplication() {
  showToast('Stopping application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/stop', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application stopped successfully', 'success');
  }).catch(() => {
    showToast('Failed to stop application', 'danger');
  });
}

function restartApplication() {
  showToast('Restarting application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/restart', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application restarted successfully', 'success');
  }).catch(() => {
    showToast('Failed to restart application', 'danger');
  });
}

function buildApplication() {
  showToast('Building application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/build', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Build completed successfully', 'success');
  }).catch(() => {
    showToast('Build failed', 'danger');
  });
}

function analyzeApplication(type) {
  showToast(`Starting ${type} analysis...`, 'info');
  htmx.ajax('POST', `/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/analyze/${type}`, {
    target: '#tab-analyses',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Analysis started', 'success');
  }).catch(() => {
    showToast('Failed to start analysis', 'danger');
  });
}

function openPromptsModal() {
  htmx.ajax('GET', '/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/prompts/modal', {
    target: '#modal-container',
    swap: 'innerHTML'
  }).catch(() => {
    showToast('Failed to load prompts', 'danger');
  });
}

// Listen for HTMX events
document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.successful) {
    console.log('HTMX request successful:', evt.detail.pathInfo.requestPath);
  } else {
    console.error('HTMX request failed:', evt.detail.pathInfo.requestPath);
  }
});

document.body.addEventListener('htmx:responseError', function(evt) {
  showToast('A server error occurred. Please try again.', 'danger');
});
</script>
{% endblock %}
