{# Application Detail - Research Dashboard Design #}
{% extends 'layouts/base.html' %}
{% from 'components/detail_macros.html' import research_detail_header, research_metric_grid, research_section_nav, research_section, research_scroll_spy_script %}
{% set active_page = 'applications' %}
{% set page_title = view.title if view else 'Application Detail' %}

{% block content %}
<div class="research-detail-shell">
  {# Compact header bar with inline metrics and all actions #}
  {% set container_metric = metrics|selectattr('label', 'equalto', 'Container')|first if metrics else None %}
  {% set status_badge = {
    'label': container_metric.value,
    'color': container_metric.status_color or 'secondary',
    'animated': container_metric.status_color == 'success'
  } if container_metric else None %}
  
  {{ research_detail_header(view, metrics[1:4] if metrics and metrics|length > 1 else [], status_badge) }}
  
  {# Dense metric grid (4-6 per row) #}
  {{ research_metric_grid(metrics) }}
  
  {# Sticky horizontal section navigation #}
  {{ research_section_nav(sections) }}
  
  {# Vertical section layout with lazy loading #}
  <div class="research-content">
    {% for section in sections %}
      <section id="section-{{ section.id }}" 
               class="research-section" 
               data-research-section="{{ section.id }}"
               hx-get="{{ section.hx }}"
               hx-trigger="{% if loop.first %}load{% else %}intersect once threshold:0.1{% endif %}"
               hx-swap="innerHTML"
               aria-labelledby="section-{{ section.id }}-title">
        
        <div class="research-section-header">
          <h2 class="research-section-title" id="section-{{ section.id }}-title">
            <i class="{{ section.icon }}" aria-hidden="true"></i>
            <span>{{ section.label }}</span>
          </h2>
        </div>
        
        {# Skeleton loader placeholder #}
        <div class="research-skeleton" aria-live="polite" aria-busy="true">
          <div class="research-skeleton-line h-lg"></div>
          <div class="research-skeleton-line w-75"></div>
          <div class="research-skeleton-line w-50"></div>
        </div>
      </section>
    {% endfor %}
  </div>
</div>

<div id="modal-container"></div>

{# Include container logs modal #}
{% include 'pages/applications/partials/modals/container_logs_modal.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/container_manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/container_logs.js') }}"></script>
{{ research_scroll_spy_script() }}
<script>
// Toast notification helper
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container') || (() => {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
    return container;
  })();
  
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} alert-dismissible fade show`;
  toast.role = 'alert';
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function copyAdjacentPre(btn) {
  const pre = btn.closest('.card')?.querySelector('pre');
  if (!pre) {
    showToast('Nothing to copy', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(pre.innerText).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-primary');
    setTimeout(() => {
      btn.innerHTML = orig;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 1200);
  }).catch(() => {
    showToast('Failed to copy to clipboard', 'danger');
  });
}

function startApplication() {
  showToast('Starting application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/start', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application started successfully', 'success');
  }).catch(() => {
    showToast('Failed to start application', 'danger');
  });
}

function stopApplication() {
  showToast('Stopping application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/stop', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application stopped successfully', 'success');
  }).catch(() => {
    showToast('Failed to stop application', 'danger');
  });
}

function restartApplication() {
  showToast('Restarting application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/restart', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application restarted successfully', 'success');
  }).catch(() => {
    showToast('Failed to restart application', 'danger');
  });
}

function buildApplication() {
  showToast('Building application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/build', {
    target: '#tab-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Build completed successfully', 'success');
  }).catch(() => {
    showToast('Build failed', 'danger');
  });
}

function analyzeApplication(type) {
  showToast(`Starting ${type} analysis...`, 'info');
  htmx.ajax('POST', `/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/analyze/${type}`, {
    target: '#tab-analyses',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Analysis started', 'success');
  }).catch(() => {
    showToast('Failed to start analysis', 'danger');
  });
}

function openPromptsModal() {
  htmx.ajax('GET', '/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/prompts/modal', {
    target: '#modal-container',
    swap: 'innerHTML'
  }).catch(() => {
    showToast('Failed to load prompts', 'danger');
  });
}

// Listen for HTMX events
document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.successful) {
    console.log('HTMX request successful:', evt.detail.pathInfo.requestPath);
  } else {
    console.error('HTMX request failed:', evt.detail.pathInfo.requestPath);
  }
});

document.body.addEventListener('htmx:responseError', function(evt) {
  showToast('A server error occurred. Please try again.', 'danger');
});
</script>
{% endblock %}
