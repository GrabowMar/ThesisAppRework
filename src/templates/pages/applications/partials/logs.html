{# Application logs partial #}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title mb-0">
      <i class="fas fa-file-lines me-2"></i>Application Logs
    </h3>
    <div class="card-actions">
      <div class="btn-group" role="group">
        <button class="btn btn-ghost-secondary btn-sm" 
                hx-get="/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/section/logs"
                hx-target="#section-logs"
                hx-swap="innerHTML"
                title="Refresh logs">
          <i class="fas fa-sync"></i>
        </button>
        <button class="btn btn-ghost-primary btn-sm" onclick="toggleAutoRefresh()" id="auto-refresh-btn" title="Toggle auto-refresh">
          <i class="fas fa-pause"></i>
        </button>
        <button class="btn btn-ghost-info btn-sm" onclick="clearLogs()" title="Clear logs">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    {% if logs %}
      <!-- Log Controls -->
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <label class="form-label small">Log Level</label>
          <select class="form-select form-select-sm" id="log-level-filter" onchange="filterLogs()">
            <option value="">All Levels</option>
            <option value="ERROR">Error</option>
            <option value="WARN">Warning</option>
            <option value="INFO">Info</option>
            <option value="DEBUG">Debug</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Source</label>
          <select class="form-select form-select-sm" id="log-source-filter" onchange="filterLogs()">
            <option value="">All Sources</option>
            <option value="container">Container</option>
            <option value="build">Build</option>
            <option value="system">System</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Lines</label>
          <select class="form-select form-select-sm" id="log-lines" onchange="changeLinesCount()">
            <option value="50">50 lines</option>
            <option value="100" selected>100 lines</option>
            <option value="250">250 lines</option>
            <option value="500">500 lines</option>
            <option value="1000">1000 lines</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Search</label>
          <input type="text" class="form-control form-control-sm" id="log-search" placeholder="Search logs..." onkeyup="filterLogs()">
        </div>
      </div>
      
      <!-- Log Display -->
      <div class="card card-sm">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Live Logs</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-ghost-secondary" onclick="scrollToTop()" title="Scroll to top">
              <i class="fas fa-arrow-up"></i>
            </button>
            <button class="btn btn-ghost-secondary" onclick="scrollToBottom()" title="Scroll to bottom">
              <i class="fas fa-arrow-down"></i>
            </button>
            <button class="btn btn-ghost-secondary" onclick="copyLogs()" title="Copy logs">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="log-container" class="log-container">
            <pre id="log-content" class="log-content mb-0">{{ logs }}</pre>
          </div>
        </div>
      </div>
      
      <!-- Log Statistics -->
      <div class="row g-2 mt-3">
        <div class="col-md-3">
          <div class="card card-sm bg-danger-lt">
            <div class="card-body text-center">
              <div class="h4 m-0 text-danger" id="error-count">{{ log_stats.error_count|default(0) }}</div>
              <div class="text-muted small">Errors</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card card-sm bg-warning-lt">
            <div class="card-body text-center">
              <div class="h4 m-0 text-warning" id="warning-count">{{ log_stats.warning_count|default(0) }}</div>
              <div class="text-muted small">Warnings</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card card-sm bg-info-lt">
            <div class="card-body text-center">
              <div class="h4 m-0 text-info" id="info-count">{{ log_stats.info_count|default(0) }}</div>
              <div class="text-muted small">Info</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card card-sm bg-secondary-lt">
            <div class="card-body text-center">
              <div class="h4 m-0 text-secondary" id="total-lines">{{ log_stats.total_lines|default(0) }}</div>
              <div class="text-muted small">Total Lines</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Download Options -->
      <div class="mt-3">
        <h5>Download Logs</h5>
        <div class="btn-list">
          <a href="/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/logs/download?format=txt" 
             class="btn btn-ghost-primary">
            <i class="fas fa-file-alt me-1"></i>Download as TXT
          </a>
          <a href="/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/logs/download?format=json" 
             class="btn btn-ghost-info">
            <i class="fas fa-file-code me-1"></i>Download as JSON
          </a>
          <a href="/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/logs/download?format=csv" 
             class="btn btn-ghost-success">
            <i class="fas fa-file-csv me-1"></i>Download as CSV
          </a>
        </div>
      </div>
      
    {% else %}
      <div class="text-center text-muted py-4">
        <i class="fas fa-file-lines fa-3x mb-3"></i>
        <h4>No Logs Available</h4>
        <p>The application container is not running or has not generated any logs yet.</p>
        {% if app_data.container_status != 'running' %}
        <button class="btn btn-primary" 
                hx-post="/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/start"
                hx-target="#section-container"
                hx-swap="innerHTML">
          <i class="fas fa-play me-1"></i>Start Application
        </button>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<script>
let autoRefreshInterval;
let isAutoRefreshing = true;

// Initialize auto-refresh
document.addEventListener('DOMContentLoaded', function() {
  startAutoRefresh();
});

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  
  autoRefreshInterval = setInterval(function() {
    if (isAutoRefreshing) {
      refreshLogs();
    }
  }, 5000); // Refresh every 5 seconds
}

function toggleAutoRefresh() {
  const btn = document.getElementById('auto-refresh-btn');
  const icon = btn.querySelector('i');
  
  isAutoRefreshing = !isAutoRefreshing;
  
  if (isAutoRefreshing) {
    icon.className = 'fas fa-pause';
    btn.title = 'Pause auto-refresh';
    btn.classList.remove('btn-ghost-danger');
    btn.classList.add('btn-ghost-primary');
  } else {
    icon.className = 'fas fa-play';
    btn.title = 'Resume auto-refresh';
    btn.classList.remove('btn-ghost-primary');
    btn.classList.add('btn-ghost-danger');
  }
}

function refreshLogs() {
  const lines = document.getElementById('log-lines').value;
  
  fetch(`/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/logs/stream?lines=${lines}`)
    .then(response => response.text())
    .then(data => {
      document.getElementById('log-content').textContent = data;
      
      // Auto-scroll to bottom if user is at bottom
      const container = document.getElementById('log-container');
      const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
      
      if (isAtBottom) {
        scrollToBottom();
      }
      
      // Update statistics
      updateLogStats(data);
    })
    .catch(error => {
      console.error('Failed to refresh logs:', error);
    });
}

function filterLogs() {
  const level = document.getElementById('log-level-filter').value;
  const source = document.getElementById('log-source-filter').value;
  const search = document.getElementById('log-search').value;
  
  const params = new URLSearchParams();
  if (level) params.append('level', level);
  if (source) params.append('source', source);
  if (search) params.append('search', search);
  
  fetch(`/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/logs/filter?${params.toString()}`)
    .then(response => response.text())
    .then(data => {
      document.getElementById('log-content').textContent = data;
      updateLogStats(data);
    });
}

function changeLinesCount() {
  refreshLogs();
}

function scrollToTop() {
  document.getElementById('log-container').scrollTop = 0;
}

function scrollToBottom() {
  const container = document.getElementById('log-container');
  container.scrollTop = container.scrollHeight;
}

function copyLogs() {
  const logContent = document.getElementById('log-content').textContent;
  navigator.clipboard.writeText(logContent).then(() => {
    showLogNotification('Logs copied to clipboard', 'success');
  }).catch(() => {
    // Fallback for browsers that don't support clipboard API
    const textarea = document.createElement('textarea');
    textarea.value = logContent;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showLogNotification('Logs copied to clipboard', 'success');
  });
}

function clearLogs() {
  if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
    fetch(`/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/logs/clear`, {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('log-content').textContent = '';
        updateLogStats('');
        showLogNotification('Logs cleared successfully', 'success');
      } else {
        showLogNotification('Failed to clear logs', 'danger');
      }
    });
  }
}

function updateLogStats(logContent) {
  const lines = logContent.split('\n').filter(line => line.trim());
  const errorCount = lines.filter(line => line.includes('ERROR')).length;
  const warningCount = lines.filter(line => line.includes('WARN')).length;
  const infoCount = lines.filter(line => line.includes('INFO')).length;
  
  document.getElementById('error-count').textContent = errorCount;
  document.getElementById('warning-count').textContent = warningCount;
  document.getElementById('info-count').textContent = infoCount;
  document.getElementById('total-lines').textContent = lines.length;
}

function showLogNotification(message, type = 'info') {
  // Simple notification system
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 3000);
}

// Cleanup interval on page unload
window.addEventListener('beforeunload', function() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
});
</script>

