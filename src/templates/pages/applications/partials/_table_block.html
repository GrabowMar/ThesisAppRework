<div id="applications-table-section">
{# Applications table content using Tabler defaults #}
{% set models_selected_raw = request.args.get('model','') if request else '' %}
{% set selected_models = models_selected_raw.split(',') if models_selected_raw else [] %}
{% set selected_models = selected_models|select|list %}
{% set statuses_selected_raw = request.args.get('status','') if request else '' %}
{% set selected_statuses = statuses_selected_raw.split(',') if statuses_selected_raw else [] %}
{% set selected_statuses = selected_statuses|select|list %}
{% set template_val = request.args.get('template','') if request else '' %}
{% set per_page_val = request.args.get('per_page','25') if request else '25' %}
{% set search_term = request.args.get('search','') if request else '' %}
<div class="card card-table-compact mb-3">
  <div class="card-header d-flex flex-wrap align-items-center gap-3">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <h3 class="card-title d-flex align-items-center gap-2 mb-0">
        <i class="fas fa-laptop-code"></i>
        <span>Applications</span>
      </h3>
      <div class="d-flex flex-wrap align-items-center gap-2 status-indicators">
        <span class="badge bg-primary-lt d-inline-flex align-items-center gap-2"><i class="fas fa-laptop-code"></i><span id="total-applications">{{ applications_stats.total_applications if applications_stats is defined else applications|length }}</span></span>
        <span class="badge bg-success-lt d-inline-flex align-items-center gap-2"><i class="fas fa-check-circle"></i><span id="running-applications">{{ applications_stats.running_applications if applications_stats is defined else 0 }}</span></span>
        <span class="badge bg-info-lt d-inline-flex align-items-center gap-2"><i class="fas fa-chart-line"></i><span id="analyzed-applications">{{ applications_stats.analyzed_applications if applications_stats is defined else 0 }}</span></span>
        <span class="badge bg-warning-lt d-inline-flex align-items-center gap-2 text-dark"><i class="fas fa-brain"></i><span id="unique-models">{{ applications_stats.unique_models if applications_stats is defined else 0 }}</span></span>
      </div>
    </div>
    <div class="card-actions d-flex flex-wrap align-items-center gap-2 ms-auto">
      <label class="d-flex align-items-center gap-2 mb-0">
        <span class="text-muted small">Limit:</span>
        <select id="apps-per-page" class="form-select form-select-sm" style="width: auto;" onchange="changeApplicationsPerPage(this.value)">
          <option value="10" {% if per_page_val|string == '10' %}selected{% endif %}>10</option>
          <option value="25" {% if per_page_val|string == '25' %}selected{% endif %}>25</option>
          <option value="50" {% if per_page_val|string == '50' %}selected{% endif %}>50</option>
          <option value="100" {% if per_page_val|string == '100' %}selected{% endif %}>100</option>
        </select>
      </label>
      <span class="text-muted small" id="applications-source-indicator"></span>
      <div class="btn-list">
        <button class="btn btn-sm btn-primary" onclick="refreshApplications()" title="Refresh applications" type="button"><i class="fas fa-sync me-1" aria-hidden="true"></i>Refresh</button>
        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-download me-1"></i>Export
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportApplications('json'); return false;"><i class="fas fa-file-code me-2"></i>JSON</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportApplications('csv'); return false;"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
          </ul>
        </div>
        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#batchApplicationsModal" title="Batch operations" onclick="updateBatchSelectionCount()" type="button"><i class="fas fa-layer-group me-1" aria-hidden="true"></i>Batch Ops</button>
      </div>
      <span class="text-primary small fw-bold" id="applications-selection-indicator"></span>
    </div>
  </div>
  <div class="card-body border-top py-3">
    <div class="row g-2 mb-3">
      <div class="col-12">
        <div class="input-group input-group-flat">
          <span class="input-group-text"><i class="fas fa-search" aria-hidden="true"></i></span>
          <input type="text" id="application-search" class="form-control" placeholder="Search by model, app number, or template..." value="{{ search_term }}" onkeyup="debounceApplicationSearch()" aria-label="Search applications" />
          <button class="btn btn-outline-secondary" onclick="clearApplicationSearch()" type="button" title="Clear search" aria-label="Clear search"><i class="fas fa-xmark" aria-hidden="true"></i></button>
          <button class="btn btn-outline-primary" onclick="toggleApplicationsAdvancedFilters()" type="button" title="Advanced filters" aria-label="Toggle advanced filters">
            <i class="fas fa-filter me-1" aria-hidden="true"></i>
            <span class="d-none d-md-inline">Advanced</span>
            <span class="badge bg-primary ms-1" id="applications-active-filters-count" style="display: none;">0</span>
          </button>
        </div>
      </div>
    </div>

    {# Advanced Filters Panel #}
    <div id="applications-advanced-filters" class="advanced-filters-panel" style="display: none;">
      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Status Filters</label>
              <div class="d-flex flex-wrap gap-2">
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" id="filter-status-running" value="running" onchange="updateApplicationsAdvancedFilters()">
                  <span class="form-check-label">Running</span>
                </label>
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" id="filter-status-stopped" value="stopped" onchange="updateApplicationsAdvancedFilters()">
                  <span class="form-check-label">Stopped</span>
                </label>
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" id="filter-status-error" value="error" onchange="updateApplicationsAdvancedFilters()">
                  <span class="form-check-label">Error</span>
                </label>
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" id="filter-status-pending" value="pending" onchange="updateApplicationsAdvancedFilters()">
                  <span class="form-check-label">Pending</span>
                </label>
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" id="filter-status-not-created" value="not_created" onchange="updateApplicationsAdvancedFilters()">
                  <span class="form-check-label">Not Created</span>
                </label>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Date Range</label>
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="date" class="form-control" id="filter-date-from" onchange="updateApplicationsAdvancedFilters()" placeholder="From">
                </div>
                <div class="col-md-6">
                  <input type="date" class="form-control" id="filter-date-to" onchange="updateApplicationsAdvancedFilters()" placeholder="To">
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="applyApplicationsAdvancedFilters()">
                  <i class="fas fa-check me-1"></i>Apply Filters
                </button>
                <button class="btn btn-outline-secondary" onclick="clearApplicationsAdvancedFilters()">
                  <i class="fas fa-xmark me-1"></i>Clear All
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="d-flex align-items-center gap-2 mb-0" for="model-filter">
          <span class="text-muted d-flex align-items-center gap-1">
            <i class="fas fa-brain" aria-hidden="true"></i>
            <span>Model</span>
          </span>
          <select class="form-select form-select-sm" style="min-width: 140px;" id="model-filter" onchange="applyApplicationFilters()" aria-label="Filter by model">
            <option value="">All Models</option>
            {% if available_models is defined %}
              {% for model in available_models %}
              <option value="{{ model.slug }}" {% if model.slug in selected_models %}selected{% endif %}>{{ model.display_name }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </label>
      </div>
      <div class="col-auto">
        <label class="d-flex align-items-center gap-2 mb-0" for="status-filter">
          <span class="text-muted d-flex align-items-center gap-1">
            <i class="fas fa-toggle-on" aria-hidden="true"></i>
            <span>Status</span>
          </span>
          <select class="form-select form-select-sm" style="min-width: 120px;" id="status-filter" onchange="applyApplicationFilters()" aria-label="Filter by status">
            <option value="">All Statuses</option>
            {% set status_options = ['running','stopped','error','pending','not_created'] %}
            {% for status in status_options %}
            <option value="{{ status }}" {% if status in selected_statuses %}selected{% endif %}>{{ status.replace('_',' ')|title }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="col-auto">
        <label class="d-flex align-items-center gap-2 mb-0" for="template-filter">
          <span class="text-muted d-flex align-items-center gap-1">
            <i class="fas fa-file-code" aria-hidden="true"></i>
            <span>Template</span>
          </span>
          <select class="form-select form-select-sm" style="min-width: 160px;" id="template-filter" onchange="applyApplicationFilters()" aria-label="Filter by template">
            <option value="">All Templates</option>
            {% if available_templates is defined %}
              {% for tpl in available_templates %}
              <option value="{{ tpl.slug }}" {% if tpl.slug == template_val %}selected{% endif %}>{{ tpl.name }}{% if tpl.category %} ({{ tpl.category }}){% endif %}</option>
              {% endfor %}
            {% endif %}
          </select>
        </label>
      </div>
      <div class="col-auto ms-auto">
        <button class="btn btn-sm btn-outline-secondary" onclick="clearAllApplicationFilters()" type="button" aria-label="Clear all filters">
          <i class="fas fa-times-circle me-1" aria-hidden="true"></i>Clear Filters
        </button>
      </div>
    </div>
  </div>
  <div class="table-responsive" id="applications-table-scroll">
		<table class="table table-striped table-vcenter table-hover table-sm card-table mb-0" id="applications-table">
			<thead>
				<tr>
					<th scope="col" class="w-1"><input type="checkbox" id="select-all-apps" class="form-check-input m-0" onchange="toggleSelectAllApplications()" aria-label="Select all applications"></th>
					<th scope="col" class="sortable" data-column="model_slug">Model</th>
					<th scope="col" class="sortable" data-column="provider">Provider</th>
					<th scope="col" class="text-center sortable" data-column="app_number">App</th>
					<th scope="col" class="text-center sortable" data-column="created_at">Generated</th>
					<th scope="col" class="sortable" data-column="template_slug">Template</th>
					<th scope="col" class="text-center sortable" data-column="generation_mode">Mode</th>
					<th scope="col" class="text-center sortable" data-column="container_status">Status</th>
					<th scope="col">Ports</th>
					<th scope="col" class="text-end sortable" data-column="container_size">Size</th>
					<th scope="col" class="text-center">Analysis</th>
					<th scope="col" class="w-1"><span class="visually-hidden">Actions</span></th>
				</tr>
			</thead>
			<tbody id="applications-table-body">
				{% for app in applications %}
				<tr data-model="{{ app.model_slug }}" data-app="{{ app.app_number }}" {% if app.id %}data-app-id="{{ app.id }}"{% endif %}>
					<td><input type="checkbox" class="form-check-input m-0 app-checkbox" value="{{ app.model_slug }}-{{ app.app_number }}" aria-label="Select {{ app.model_display_name }} App {{ app.app_number }}"></td>
					<td>
						<div class="text-truncate">{{ app.model_display_name }}</div>
					</td>
					<td>
						<span class="badge bg-primary-lt text-primary">{{ app.model_provider }}</span>
					</td>
					<td class="text-center">
						<strong>{{ app.app_number }}</strong>
					</td>
					<td class="text-center text-muted small">
						{% if app.created_at %}
							{{ app.created_at.strftime('%d %b %H:%M') }} UTC
						{% else %}
							—
						{% endif %}
					</td>
					<td>
						{% if app.template_slug %}
							<span class="badge bg-indigo-lt" title="{{ app.template_slug }}">{{ app.template_name or app.template_slug }}</span>
							{% if app.template_category %}
							<span class="text-muted small d-block">{{ app.template_category }}</span>
							{% endif %}
						{% else %}
							<span class="text-muted small">—</span>
						{% endif %}
					</td>
					<td class="text-center">
						{% set mode = app.generation_mode|default('guarded') %}
						{% if mode == 'unguarded' %}
							<span class="badge bg-warning-lt text-warning" title="Model-driven architecture (research mode)">
								<i class="fas fa-unlock-alt me-1"></i>Unguarded
							</span>
						{% else %}
							<span class="badge bg-success-lt text-success" title="Pre-defined architecture (4-query system)">
								<i class="fas fa-shield-alt me-1"></i>Guarded
							</span>
						{% endif %}
					</td>
					<td class="text-center">
						{% set status_lower = app.status|lower|replace('_', ' ')|replace('?', '')|trim %}
            {% if status_lower == 'running' %}
              <span class="badge bg-success-lt text-success" data-role="status-badge"><i class="fas fa-play me-1" aria-hidden="true"></i>Running</span>
            {% elif status_lower == 'stopped' %}
              <span class="badge bg-secondary-lt text-secondary" data-role="status-badge"><i class="fas fa-stop me-1" aria-hidden="true"></i>Stopped</span>
            {% elif status_lower == 'error' or status_lower == 'failed' %}
              <span class="badge bg-danger-lt text-danger" data-role="status-badge"><i class="fas fa-exclamation-circle me-1" aria-hidden="true"></i>Error</span>
            {% elif status_lower == 'building' %}
              <span class="badge bg-warning-lt text-warning" data-role="status-badge"><i class="fas fa-hammer me-1" aria-hidden="true"></i>Building</span>
            {% elif 'no compose' in status_lower or status_lower == 'not created' %}
              <span class="badge bg-secondary-lt text-secondary" data-role="status-badge"><i class="fas fa-plus me-1" aria-hidden="true"></i>Not Created</span>
            {% else %}
              <span class="badge bg-secondary-lt text-secondary" data-role="status-badge">{{ status_lower|title }}</span>
            {% endif %}
					</td>
					<td class="text-muted small">
						{% if app.ports %}
							{{ app.ports[0].host_port }}{% if app.ports|length > 1 %}, {{ app.ports[1].host_port }}{% endif %}{% if app.ports|length > 2 %}, +{{ app.ports|length - 2 }}{% endif %}
						{% else %}
							—
						{% endif %}
					</td>
					<td class="text-end text-muted small">
						{{ app.container_size if app.container_size else '—' }}
					</td>
					<td class="text-center">
						{% if app.analysis_status == 'completed' %}
							<span class="badge bg-success-lt text-success">Done</span>
						{% elif app.analysis_status == 'running' %}
							<span class="badge bg-warning-lt text-warning">Running</span>
						{% elif app.analysis_status == 'failed' %}
							<span class="badge bg-danger-lt text-danger">Failed</span>
						{% else %}
							<span class="text-muted small">—</span>
						{% endif %}
					</td>
					<td>
						<div class="btn-group btn-group-sm" role="group" aria-label="Application actions">
							{# View Details Button #}
							<button class="btn btn-ghost-primary" 
								onclick="window.location.href='/applications/{{ app.model_slug }}/{{ app.app_number }}'" 
								aria-label="View details for {{ app.model_display_name }} App {{ app.app_number }}">
								<i class="fas fa-eye"></i>
							</button>
							
							{# Container Control Buttons #}
							{% if app.container_status == 'running' %}
								{# Visit App Button - shown when running with ports #}
								{% if app.ports %}
								<a href="http://localhost:{{ app.ports[0].host_port }}" 
									target="_blank" 
									rel="noopener" 
									class="btn btn-ghost-success" 
									title="Visit application (port {{ app.ports[0].host_port }})">
									<i class="fas fa-external-link-alt"></i>
								</a>
								{% endif %}
								
								{# Stop Button - shown when running #}
								<button class="btn btn-ghost-danger" 
									hx-post="/api/app/{{ app.model_slug }}/{{ app.app_number }}/stop"
									hx-trigger="click"
									hx-swap="none"
									hx-indicator=".htmx-indicator"
									title="Stop containers">
									<i class="fas fa-stop"></i>
								</button>
							{% else %}
								{# Start Button - shown when not running (auto-builds if needed) #}
								<button class="btn btn-ghost-success" 
									hx-post="/api/app/{{ app.model_slug }}/{{ app.app_number }}/start"
									hx-trigger="click"
									hx-swap="none"
									hx-indicator=".htmx-indicator"
									title="Start containers (builds if needed)">
									<i class="fas fa-play"></i>
								</button>
							{% endif %}
							
							{# Rebuild Button - always available #}
							<button class="btn btn-ghost-warning" 
								hx-post="/api/app/{{ app.model_slug }}/{{ app.app_number }}/build"
								hx-trigger="click"
								hx-swap="none"
								hx-vals='{"no_cache": true, "start_after": false}'
								hx-indicator=".htmx-indicator"
								title="Rebuild containers (no cache)">
								<i class="fas fa-sync"></i>
							</button>
						</div>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<div class="card-footer d-flex align-items-center gap-2 justify-content-between" id="applications-pagination-bar">
		<div id="applications-page-summary" class="text-muted">
			Showing {{ applications|length }} of {{ total_applications }} applications
		</div>
		<nav aria-label="Applications pagination">
			{% if pagination is defined and pagination %}
			<ul class="pagination pagination-sm mb-0" id="applications-pagination">
				{% if pagination.has_prev %}
				<li class="page-item">
					<button class="page-link" onclick="changeApplicationsPage('{{ pagination.prev_num }}')">Previous</button>
				</li>
				{% endif %}
				{% for page_num in pagination.iter_pages() %}
					{% if page_num %}
						{% if page_num != pagination.page %}
						<li class="page-item">
							<button class="page-link" onclick="changeApplicationsPage('{{ page_num }}')">{{ page_num }}</button>
						</li>
						{% else %}
						<li class="page-item active">
							<span class="page-link">{{ page_num }}</span>
						</li>
						{% endif %}
					{% else %}
					<li class="page-item disabled">
						<span class="page-link">…</span>
					</li>
					{% endif %}
				{% endfor %}
				{% if pagination.has_next %}
				<li class="page-item">
					<button class="page-link" onclick="changeApplicationsPage('{{ pagination.next_num }}')">Next</button>
				</li>
				{% endif %}
			</ul>
			{% endif %}
		</nav>
	</div>
  </div>
</div>

<script>
// ---- HTMX Response Handlers ----
document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.failed) {
    // HTTP error (4xx, 5xx)
    const xhr = evt.detail.xhr;
    let message = 'Operation failed';
    
    try {
      const response = JSON.parse(xhr.responseText);
      message = response.message || response.error || message;
      
      // Special handling for "images not built" error
      if (response.details && response.details.action_required === 'build') {
        message = `⚠️ ${message}\n\nHint: ${response.details.hint}`;
        // Auto-scroll to container tab if on detail page
        const containerTab = document.querySelector('a[href="#container"]');
        if (containerTab && !containerTab.classList.contains('active')) {
          showNotification('Please build the container images first', 'warning');
        }
      }
    } catch (e) {
      // Not JSON, use default message
    }
    
    showNotification(message, 'danger');
  } else if (evt.detail.successful) {
    // Success response
    try {
      const response = JSON.parse(evt.detail.xhr.responseText);
      if (response.message) {
        showNotification(response.message, 'success');
      }
      // Refresh table after successful operation
      setTimeout(() => {
        if (typeof refreshApplications === 'function') {
          refreshApplications();
        }
      }, 1000);
    } catch (_err) {
      // Non-JSON response; skip toast to avoid redundant alerts.
    }
  }
});

// ---- Fixed Status Polling (Prevents false "Running" status) ----
function pollApplicationStatuses() {
  const rows = Array.from(document.querySelectorAll('#applications-table-body tr[data-model][data-app]'));
  if (!rows.length) return;
  
  // Only check uncertain statuses or stale ones
  const batch = rows.slice(0, 15).filter(row => {
    const statusBadge = row.querySelector('[data-role="status-badge"]');
    if (!statusBadge) return false;
    const statusText = statusBadge.textContent.trim().toLowerCase();
    
    // Always check uncertain statuses
    if (statusText.includes('unknown') || statusText.includes('pending') || statusText.includes('not created')) {
      return true;
    }
    
    // Check fresh statuses less frequently (every 5th poll cycle)
    if (!row.dataset.pollCount) row.dataset.pollCount = '0';
    const pollCount = parseInt(row.dataset.pollCount) + 1;
    row.dataset.pollCount = pollCount.toString();
    
    // Check every 5th cycle for definitive statuses (running/stopped)
    return pollCount % 5 === 0;
  });
  
  batch.forEach(row => {
    const model = row.getAttribute('data-model');
    const app = row.getAttribute('data-app');
    if (!model || !app) return;
    
    fetch(`/api/app/${model}/${app}/status`)
      .then(resp => resp.ok ? resp.json() : Promise.reject('API Error'))
      .then(data => {
        if (!data?.success) return;
        
        const statusBadge = row.querySelector('[data-role="status-badge"]');
        if (!statusBadge) return;
        
        const statusData = data.data || {};
        
        // Use Docker status from API response (which now updates DB)
        const dockerStatus = statusData.docker_status || 'unknown';
        const isRunning = statusData.running === true;
        const hasContainers = statusData.states?.length > 0;
        const composeExists = statusData.compose_file_exists === true;
        
        // Update status badge based on Docker status
        let badgeClass = 'badge bg-muted-lt';
        let badgeContent = '<i class="fas fa-question me-1"></i>Unknown';
        
        if (dockerStatus === 'running' && isRunning) {
          badgeClass = 'badge bg-success-lt';
          badgeContent = '<i class="fas fa-play me-1"></i>Running';
        } else if (dockerStatus === 'stopped' && hasContainers) {
          badgeClass = 'badge bg-secondary-lt';
          badgeContent = '<i class="fas fa-stop me-1"></i>Stopped';
        } else if (dockerStatus === 'not_created' && composeExists) {
          badgeClass = 'badge bg-warning-lt';
          badgeContent = '<i class="fas fa-plus me-1"></i>Not Created';
        } else if (dockerStatus === 'no_compose') {
          badgeClass = 'badge bg-danger-lt';
          badgeContent = '<i class="fas fa-exclamation me-1"></i>No Compose';
        }
        
        statusBadge.className = badgeClass;
        statusBadge.innerHTML = badgeContent;
        
        // Add diagnostic tooltip with timing info
        const tips = [];
        if (!statusData.docker_connected) tips.push('Docker disconnected');
        if (statusData.status_age_minutes !== null) {
          tips.push(`Last checked: ${Math.round(statusData.status_age_minutes)}m ago`);
        }
        if (statusData.status_is_fresh) tips.push('Status is fresh');
        if (statusData.states?.length) tips.push(`Containers: ${statusData.states.join(', ')}`);
        if (tips.length) statusBadge.setAttribute('title', tips.join(' | '));
      })
      .catch(() => {
        // Silently handle errors - don't spam console
      });
  });
}

// Run polling and rebind handlers
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(pollApplicationStatuses, 500);
  });
} else {
  setTimeout(pollApplicationStatuses, 500);
}

document.body.addEventListener('htmx:afterSwap', (e) => {
  if (e.target?.id === 'applications-table-section') {
    setTimeout(() => {
      pollApplicationStatuses();
    }, 100);
  }
});

// Single interval for polling (only when page visible)
if (!window.__appsStatusInterval) {
  window.__appsStatusInterval = setInterval(() => {
    if (document.visibilityState === 'visible') {
      pollApplicationStatuses();
    }
  }, 60000); // Check every 60 seconds instead of 45 (less aggressive since we use DB cache)
}

// ---- Application Management Functions (Consolidated) ----
function getSelectedApplications() {
  return Array.from(document.querySelectorAll('.app-checkbox:checked')).map(cb => cb.value);
}

function performAppAction(modelSlug, appNumber, action) {
  const button = event.target.closest('button, a');
  if (!button) return;
  
  const originalHtml = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  const apiAction = action === 'rebuild' ? 'build' : action;
  const url = `/api/app/${modelSlug}/${appNumber}/${apiAction}`;
  
  fetch(url, { method: 'POST', headers: { 'HX-Request': 'true' } })
    .then(resp => {
      if (resp.ok) {
        showNotification(`${action} completed successfully`, 'success');
        // Refresh table to show updated status
        setTimeout(() => {
          if (typeof refreshApplications === 'function') {
            refreshApplications();
          } else {
            htmx.trigger('body', 'refresh-applications-table');
          }
        }, 1000);
      } else {
        throw new Error(`HTTP ${resp.status}`);
      }
    })
    .catch(err => {
      showNotification(`${action} failed: ${err.message}`, 'danger');
    })
    .finally(() => {
      button.disabled = false;
      button.innerHTML = originalHtml;
    });
}

function runAnalysis(modelSlug, appNumber, analysisType) {
  const button = event.target.closest('button');
  if (!button) return;
  
  const originalHtml = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running...';
  
  const row = button.closest('tr');
  const appId = row ? row.getAttribute('data-app-id') : null;
  const url = appId ? `/api/applications/${appId}/analyze` : `/api/applications/${modelSlug}/${appNumber}/analyze`;
  
  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ analysis_type: analysisType })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(`${analysisType} analysis started`, 'success');
      setTimeout(() => {
        if (typeof refreshApplications === 'function') {
          refreshApplications();
        }
      }, 1000);
    } else {
      showNotification(`Analysis failed: ${data.error}`, 'danger');
    }
  })
  .catch(error => {
    showNotification(`Analysis failed: ${error.message}`, 'danger');
  })
  .finally(() => {
    button.disabled = false;
    button.innerHTML = originalHtml;
  });
}

function viewAppLogs(modelSlug, appNumber) {
  window.open(`/applications/${modelSlug}/${appNumber}/logs`, '_blank');
}

function cloneApplication(modelSlug, appNumber) {
  const newAppNumber = prompt('Enter new application number (1-30):');
  if (!newAppNumber || isNaN(newAppNumber) || newAppNumber < 1 || newAppNumber > 30) {
    return;
  }
  
  fetch(`/api/applications/${modelSlug}/${appNumber}/clone`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ new_app_number: parseInt(newAppNumber) })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Application cloned successfully', 'success');
      if (typeof refreshApplications === 'function') refreshApplications();
    } else {
      showNotification(`Clone failed: ${data.error}`, 'danger');
    }
  })
  .catch(error => {
    showNotification(`Clone failed: ${error.message}`, 'danger');
  });
}

function shareApplication(modelSlug, appNumber) {
  const url = `${window.location.origin}/applications/${modelSlug}/${appNumber}`;
  navigator.clipboard.writeText(url).then(() => {
    showNotification('Application URL copied to clipboard', 'success');
  }).catch(() => {
    prompt('Copy this URL:', url);
  });
}

function deleteApplication(modelSlug, appNumber) {
  if (!confirm(`Are you sure you want to delete ${modelSlug} App ${appNumber}? This action cannot be undone.`)) {
    return;
  }
  
  fetch(`/api/applications/${modelSlug}/${appNumber}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Application deleted successfully', 'success');
        if (typeof refreshApplications === 'function') refreshApplications();
      } else {
        showNotification(`Delete failed: ${data.error}`, 'danger');
      }
    })
    .catch(error => {
      showNotification(`Delete failed: ${error.message}`, 'danger');
    });
}

// ---- Selection Management ----
function toggleSelectAllApplications() {
  const selectAll = document.getElementById('select-all-apps');
  const checkboxes = document.querySelectorAll('.app-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });
  
  updateSelectionIndicator();
}

function updateSelectionIndicator() {
  const selected = getSelectedApplications();
  const indicator = document.getElementById('applications-selection-indicator');
  
  if (indicator) {
    indicator.textContent = selected.length > 0 ? `${selected.length} selected` : '';
  }
}

// ---- Pagination Functions ----
function changeApplicationsPage(page) { 
  if (window.applyApplicationFilters) { 
    applyApplicationFilters({page}); 
  } 
}

function changeApplicationsPerPage(perPage) { 
  if (window.applyApplicationFilters) { 
    applyApplicationFilters({per_page: perPage}); 
  } 
}

// ---- Notification System ----
function showNotification(message, type = 'info') {
  const statusArea = document.getElementById('applications-selection-indicator');
  if (statusArea) {
    statusArea.innerHTML = `<span class="text-${type}">${message}</span>`;
    setTimeout(() => {
      updateSelectionIndicator();
    }, 3000);
  } else {
    console.log(`[${type.toUpperCase()}] ${message}`);
  }
}

// ---- Event Listeners ----
document.addEventListener('change', function(evt) {
  if (evt.target.classList.contains('app-checkbox')) {
    updateSelectionIndicator();
    // Update batch selection count if function exists
    if (typeof updateBatchSelectionCount === 'function') {
      updateBatchSelectionCount();
    }
  }
});

// Event delegation for data-action buttons
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-action]');
  if (!btn) return;
  
  const row = btn.closest('tr');
  const modelSlug = row?.getAttribute('data-model');
  const appNumber = row?.getAttribute('data-app');
  const action = btn.getAttribute('data-action');
  
  if (modelSlug && appNumber && action) {
    e.preventDefault();
    performAppAction(modelSlug, appNumber, action);
  }
});

</script>
</div>
