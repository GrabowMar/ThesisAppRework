{% set status = app_data.container_status|default('unknown') %}
{% set status_label = status|replace('_', ' ')|title %}
{% set status_color = 'success' if status == 'running' else ('warning' if status in ['building', 'starting'] else 'secondary') %}

{# Container management - Compact layout #}
<div id="container-management-section" 
     data-model-slug="{{ app_data.model_slug }}" 
     data-app-number="{{ app_data.app_number }}"
     class="row g-2">
  
  {# Status & Runtime - Combined #}
  <div class="col-lg-6">
    <div class="card card-sm h-100 shadow-sm">
      <div class="card-status-top bg-{{ status_color }}"></div>
      <div class="card-body py-2">
        <div class="row g-3">
          {# Status Column #}
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <i class="fa-solid fa-heartbeat text-{{ status_color }} me-2"></i>
              <span class="text-muted small text-uppercase fw-bold">Status</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <span class="status-dot {% if status == 'running' %}status-dot-animated{% endif %} status-{{ status_color }}"></span>
              <span class="h4 mb-0">{{ status_label }}</span>
            </div>
            <div class="row row-cols-2 g-1 small">
              <div class="col">
                <span class="text-muted">Updated:</span>
                <span class="fw-medium">{{ app_data.updated_at.strftime('%m/%d %H:%M') if app_data.updated_at else 'â€”' }}</span>
              </div>
              <div class="col">
                <span class="text-muted">ID:</span>
                <code class="small">{{ (app_data.container_id[:8]) if app_data.container_id else 'n/a' }}</code>
              </div>
            </div>
          </div>
          {# Runtime Column #}
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <i class="fa-solid fa-info-circle text-info me-2"></i>
              <span class="text-muted small text-uppercase fw-bold">Runtime</span>
            </div>
            <div class="row row-cols-2 g-1 small">
              <div class="col"><span class="text-muted">Compose:</span></div>
              <div class="col text-end">
                {% if app_data.has_docker_compose %}<span class="badge bg-success-lt">Yes</span>
                {% else %}<span class="badge bg-secondary-lt">No</span>{% endif %}
              </div>
              <div class="col"><span class="text-muted">Ports:</span></div>
              <div class="col text-end fw-medium">{{ app_data.ports|length }}</div>
            </div>
            {% if app_data.ports %}
            <div class="d-flex flex-wrap gap-1 mt-2">
              {% for port in app_data.ports[:3] %}
                <span class="badge bg-primary-lt text-primary small">{{ port }}</span>
              {% endfor %}
              {% if app_data.ports|length > 3 %}<span class="badge bg-secondary-lt small">+{{ app_data.ports|length - 3 }}</span>{% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Controls - Redesigned #}
  <div class="col-lg-6">
    <div class="card card-sm h-100 shadow-sm">
      <div class="card-body py-2">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-gamepad text-purple me-2"></i>
          <span class="text-muted small text-uppercase fw-bold">Controls</span>
        </div>
        <div class="row g-2">
          {# Primary Actions #}
          <div class="col-12">
            <div class="btn-group w-100" role="group">
              {% if status == 'running' %}
                <button type="button" id="btn-container-restart" class="btn btn-warning">
                  <i class="fa-solid fa-rotate me-1"></i>Restart
                </button>
                <button type="button" id="btn-container-stop" class="btn btn-danger">
                  <i class="fa-solid fa-stop me-1"></i>Stop
                </button>
              {% else %}
                <button type="button" id="btn-container-start" class="btn btn-success">
                  <i class="fa-solid fa-play me-1"></i>Start
                </button>
                {% if app_data.has_docker_compose %}
                  <button type="button" id="btn-container-build" class="btn btn-primary">
                    <i class="fa-solid fa-hammer me-1"></i>Build
                  </button>
                {% endif %}
              {% endif %}
            </div>
          </div>
          {# Secondary Actions #}
          <div class="col-12">
            <div class="btn-group w-100" role="group">
              <button type="button" id="btn-diagnostics-refresh" class="btn btn-ghost-secondary">
                <i class="fa-solid fa-sync me-1"></i>Refresh
              </button>
              <button type="button" id="btn-logs-refresh" class="btn btn-ghost-secondary">
                <i class="fa-solid fa-file-lines me-1"></i>Logs
              </button>
              <button type="button" id="btn-logs-download" class="btn btn-ghost-secondary" title="Download Logs">
                <i class="fa-solid fa-download me-1"></i>Download
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Ports & Networking (merged from ports section) #}
  {% if ports %}
  <div class="col-12">
    <div class="card card-sm shadow-sm">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-network-wired text-primary me-2"></i>
          <span class="fw-bold">Ports</span>
          <span class="badge bg-secondary-lt ms-2">{{ ports|length }}</span>
        </div>
        <div class="btn-list gap-1">
          <button type="button" class="btn btn-sm btn-ghost-primary py-0" data-port-action="test-all"><i class="fa-solid fa-vial me-1"></i>Test</button>
          <button type="button" class="btn btn-sm btn-ghost-secondary py-0" data-port-action="refresh"><i class="fa-solid fa-sync"></i></button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-vcenter table-hover card-table mb-0">
            <thead><tr><th>Container</th><th>Host</th><th>Proto</th><th>Status</th><th class="text-end">Actions</th></tr></thead>
            <tbody>
              {% for port in ports %}
              <tr>
                <td><code class="small">{{ port.container_port }}</code></td>
                <td><code class="small">{{ port.host_port }}</code></td>
                <td><span class="badge bg-secondary-lt small">{{ port.protocol|upper }}</span></td>
                <td>
                  {% if port.accessible %}<span class="badge bg-success-lt text-success"><i class="fa-solid fa-check"></i></span>
                  {% else %}<span class="badge bg-warning-lt text-warning"><i class="fa-solid fa-times"></i></span>{% endif %}
                </td>
                <td class="text-end">
                  <div class="btn-list justify-content-end gap-1">
                    <button class="btn btn-sm btn-icon btn-ghost-primary py-0" data-port-action="copy" data-port="{{ port.host_port }}" title="Copy"><i class="fa-solid fa-copy"></i></button>
                    <a href="http://{{ request.host.split(':')[0] }}:{{ port.host_port }}" target="_blank" class="btn btn-sm btn-icon btn-ghost-info py-0" title="Open"><i class="fa-solid fa-external-link-alt"></i></a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
(function(){
  const section = document.querySelector('[data-research-section="container"]');
  if (!section) return;
  const hostName = window.location.hostname;
  section.addEventListener('click', evt => {
    const btn = evt.target.closest('[data-port-action]');
    if (!btn) return;
    const action = btn.dataset.portAction;
    const port = btn.dataset.port;
    if (action === 'copy' && port) {
      navigator.clipboard.writeText(`http://${hostName}:${port}`).then(() => showToast('Copied', 'success'));
    }
    if (action === 'refresh') {
      htmx.ajax('GET', '/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/section/container', { target: '#section-container', swap: 'innerHTML' });
    }
  });
})();
</script>
