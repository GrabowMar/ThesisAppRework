{# Prompts & Responses - Explorer Layout (2-Prompt System) #}
{# 2-prompt keys #}
{% set has_backend_prompt = prompts.backend if prompts is defined else false %}
{% set has_frontend_prompt = prompts.frontend if prompts is defined else false %}
{% set has_backend_response = responses.backend if responses is defined else false %}
{% set has_frontend_response = responses.frontend if responses is defined else false %}
{# Determine if we have any content at all #}
{% set has_any_content = has_backend_prompt or has_frontend_prompt or has_backend_response or has_frontend_response %}

<div class="row g-2">
  {# Source Legend #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-body py-2">
        <div class="d-flex align-items-center flex-wrap gap-2">
          <span class="text-muted small fw-bold">Sources:</span>
          <span class="badge prompt-source-template badge-xs"><i class="fas fa-file-code"></i> Template</span>
          <span class="badge prompt-source-requirements badge-xs"><i class="fas fa-list-check"></i> Requirements</span>
          <span class="badge prompt-source-scaffolding badge-xs"><i class="fas fa-cubes"></i> Scaffolding</span>
          <span class="badge prompt-source-metadata badge-xs"><i class="fas fa-info-circle"></i> Metadata</span>
        </div>
      </div>
    </div>
  </div>

  {# Explorer Window #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <i class="fas fa-file-lines text-primary me-2"></i>
          <span class="fw-bold">Explorer</span>
        </div>
        <button class="btn btn-ghost-primary btn-sm py-0 d-none" id="prompt-copy-btn" onclick="copyCurrentPrompt()"><i class="fas fa-copy me-1"></i>Copy</button>
      </div>
      <div class="card-body p-0">
        <div class="row g-0">
          {# Left: File List #}
          <div class="col-md-4 border-end prompt-file-tree">
            <div class="list-group list-group-flush" id="prompt-file-tree">
              {# === BACKEND SECTION === #}
              <div class="list-group-item py-1 px-2 bg-light-lt small fw-bold text-muted">
                <i class="fas fa-server me-1"></i>Backend
              </div>
              {% if has_backend_prompt %}
              <button type="button" class="list-group-item list-group-item-action py-1 px-2 d-flex justify-content-between align-items-center small active" data-prompt-id="backend-prompt" data-prompt-content="{{ prompts.backend|e }}">
                <span><i class="fas fa-file-lines me-1 text-success"></i>Prompt</span>
                <span class="badge bg-success-lt badge-xxs">Q1</span>
              </button>
              {% endif %}
              {% if has_backend_response %}
              <button type="button" class="list-group-item list-group-item-action py-1 px-2 d-flex justify-content-between align-items-center small" data-prompt-id="backend-response" data-prompt-content="{{ responses.backend|e }}">
                <span><i class="fas fa-reply me-1 text-success"></i>Response</span>
                <span class="badge bg-success-lt badge-xxs">R1</span>
              </button>
              {% endif %}

              {# === FRONTEND SECTION === #}
              <div class="list-group-item py-1 px-2 bg-light-lt small fw-bold text-muted">
                <i class="fas fa-desktop me-1"></i>Frontend
              </div>
              {% if has_frontend_prompt %}
              <button type="button" class="list-group-item list-group-item-action py-1 px-2 d-flex justify-content-between align-items-center small" data-prompt-id="frontend-prompt" data-prompt-content="{{ prompts.frontend|e }}">
                <span><i class="fas fa-file-lines me-1 text-info"></i>Prompt</span>
                <span class="badge bg-info-lt badge-xxs">Q2</span>
              </button>
              {% endif %}
              {% if has_frontend_response %}
              <button type="button" class="list-group-item list-group-item-action py-1 px-2 d-flex justify-content-between align-items-center small" data-prompt-id="frontend-response" data-prompt-content="{{ responses.frontend|e }}">
                <span><i class="fas fa-reply me-1 text-info"></i>Response</span>
                <span class="badge bg-info-lt badge-xxs">R2</span>
              </button>
              {% endif %}
              {% if not has_any_content %}
              <div class="list-group-item py-2 text-muted small text-center">
                <i class="fas fa-file-circle-question me-1"></i>No prompts recorded
              </div>
              {% endif %}
            </div>
          </div>
          {# Right: Content Preview #}
          <div class="col-md-8">
            <div id="prompt-preview" class="prompt-preview-container">
              {% if has_backend_prompt %}
              <div class="prompt-preview-header"><span>Backend Prompt</span></div>
              <div class="prompt-initial-content" data-content="{{ prompts.backend|e }}"></div>
              {% elif not has_any_content %}
              {# Empty state with explanation #}
              <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted py-4 px-3">
                <i class="fas fa-file-circle-xmark fa-3x mb-3 text-warning"></i>
                <h6 class="mb-2">Prompt Exchange Not Recorded</h6>
                <p class="small text-center mb-3 prompt-empty-text">
                  The prompts and responses for this application were not saved during generation.
                  This typically happens for apps generated before the prompt logging feature was enabled.
                </p>
                <div class="small text-center">
                  <p class="mb-1"><strong>To capture prompts:</strong></p>
                  <p class="mb-0 text-muted">Regenerate this app, and the new prompts will be saved automatically.</p>
                </div>
              </div>
              {% else %}
              <div class="text-center text-muted py-5"><i class="fas fa-mouse-pointer fa-2x mb-2"></i><p class="mb-0 small">Select a prompt to preview</p></div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.prompt-source-template { background-color: rgba(66, 153, 225, 0.15); color: #3182ce; border: 1px solid rgba(66, 153, 225, 0.3); }
.prompt-source-requirements { background-color: rgba(72, 187, 120, 0.15); color: #38a169; border: 1px solid rgba(72, 187, 120, 0.3); }
.prompt-source-scaffolding { background-color: rgba(237, 137, 54, 0.15); color: #dd6b20; border: 1px solid rgba(237, 137, 54, 0.3); }
.prompt-source-metadata { background-color: rgba(159, 122, 234, 0.15); color: #805ad5; border: 1px solid rgba(159, 122, 234, 0.3); }
.badge-xs { font-size: 0.65rem; }
.badge-xxs { font-size: 0.6rem; }
.prompt-file-tree { max-height: 450px; overflow-y: auto; }
.prompt-empty-text { max-width: 350px; }
[data-bs-theme='dark'] .prompt-source-template { background-color: rgba(66, 153, 225, 0.2); color: #63b3ed; }
[data-bs-theme='dark'] .prompt-source-requirements { background-color: rgba(72, 187, 120, 0.2); color: #68d391; }
[data-bs-theme='dark'] .prompt-source-scaffolding { background-color: rgba(237, 137, 54, 0.2); color: #f6ad55; }
[data-bs-theme='dark'] .prompt-source-metadata { background-color: rgba(159, 122, 234, 0.2); color: #b794f4; }
.prompt-preview-container { height: 350px; overflow: auto; background: #1e1e2e; }
.prompt-preview-header { padding: 0.25rem 0.5rem; background: #2d2d3a; border-bottom: 1px solid #3d3d4a; color: #a0a0b0; font-size: 0.7rem; }
.prompt-preview-content { margin: 0; padding: 0.5rem; font-family: 'Consolas', monospace; font-size: 0.75rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; color: #cdd6f4; background: transparent; border: none; }
.prompt-preview-container .text-muted { color: #6c7a8a !important; }
/* Section colors for parsed prompts */
.prompt-section { border-left: 3px solid; margin: 0; padding: 0.4rem 0.6rem; }
.prompt-section-header { display: inline-flex; align-items: center; gap: 0.25rem; margin-bottom: 0.15rem; font-weight: 600; font-size: 0.6rem; text-transform: uppercase; padding: 0.1rem 0.3rem; border-radius: 2px; }
.prompt-section-content { white-space: pre-wrap; word-wrap: break-word; font-family: 'Consolas', monospace; font-size: 0.75rem; line-height: 1.4; }
.prompt-section.section-metadata { border-color: #805ad5; color: #d4c4f0; }
.prompt-section.section-metadata .prompt-section-header { background: rgba(159, 122, 234, 0.3); color: #d4c4f0; }
.prompt-section.section-template { border-color: #3182ce; color: #90cdf4; }
.prompt-section.section-template .prompt-section-header { background: rgba(66, 153, 225, 0.3); color: #90cdf4; }
.prompt-section.section-requirements { border-color: #38a169; color: #9ae6b4; }
.prompt-section.section-requirements .prompt-section-header { background: rgba(72, 187, 120, 0.3); color: #9ae6b4; }
.prompt-section.section-scaffolding { border-color: #dd6b20; color: #fbd38d; }
.prompt-section.section-scaffolding .prompt-section-header { background: rgba(237, 137, 54, 0.3); color: #fbd38d; }
</style>

<script>
(function(){
  const tree = document.getElementById('prompt-file-tree');
  const preview = document.getElementById('prompt-preview');
  const copyBtn = document.getElementById('prompt-copy-btn');
  let currentContent = '';
  if (!tree) return;
  
  // Define these first before they're used
  const sectionTypes = {
    metadata: { icon: 'fas fa-info-circle', name: 'Meta' },
    template: { icon: 'fas fa-file-code', name: 'Tmpl' },
    requirements: { icon: 'fas fa-list-check', name: 'Reqs' },
    scaffolding: { icon: 'fas fa-cubes', name: 'Scaf' }
  };
  
  function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
  
  function parsePromptSections(content) {
    if (!content) return [];
    const sections = [], lines = content.split('\n');
    let currentSection = { type: 'template' }, currentContent = [];
    // Priority-ordered patterns: metadata > requirements > scaffolding > template
    const patterns = [
      // METADATA - UI-added synthetic sections (purple)
      { pattern: /^=== (REQUEST METADATA|SYSTEM|USER|RESPONSE METADATA|USAGE|COMPLETION|ASSISTANT) ===$/, type: 'metadata' },
      // REQUIREMENTS - From misc/requirements/*.json (green)
      { pattern: /^## (Functional Requirements|User Requirements|Backend Requirements|Frontend Requirements|Admin Requirements|Admin Panel Requirements)\s*$/i, type: 'requirements' },
      { pattern: /^## (Suggested )?API Endpoints/i, type: 'requirements' },
      { pattern: /^## Backend API Available/i, type: 'requirements' },
      // SCAFFOLDING - From misc/scaffolding/ context files (orange)
      { pattern: /^## (Reference|Technical Reference)\s*$/, type: 'scaffolding' },
      { pattern: /^# (Backend|Frontend) Context/, type: 'scaffolding' },
      { pattern: /^## (Environment|Stack|Authentication \(PRE-BUILT\)|Rules|Patterns|Gotchas|Pre-built Components)/i, type: 'scaffolding' },
      // TEMPLATE - From misc/templates/*.md.jinja2 (blue)
      { pattern: /^# .+ - (Backend|Frontend) Application/i, type: 'template' },
      { pattern: /^# Generate .+ - (Backend|Frontend)/i, type: 'template' },
      { pattern: /^## (YOUR MISSION|Your Task|Technical Constraints|What You Decide|Output Format|Quality Expectations|File Structure)\s*$/i, type: 'template' },
      { pattern: /^### (Architecture|Implementation|Dependencies|Required Files|Recommended Structure)/i, type: 'template' },
      { pattern: /^## MUST FOLLOW/i, type: 'template' },
    ];
    function flush() { if (currentContent.length) sections.push({ type: currentSection.type, content: currentContent.join('\n') }); currentContent = []; }
    for (const line of lines) {
      let matched = false;
      for (const p of patterns) {
        if (p.pattern.test(line)) { flush(); currentSection = { type: p.type }; currentContent.push(line); matched = true; break; }
      }
      if (!matched) currentContent.push(line);
    }
    flush();
    return sections;
  }
  
  function renderPreview(label, content, parseColors) {
    if (parseColors) {
      const sections = parsePromptSections(content);
      if (sections.length > 0) {
        let html = `<div class="prompt-preview-header"><span>${escapeHtml(label)}</span></div>`;
        for (const s of sections) {
          const t = sectionTypes[s.type] || sectionTypes.metadata;
          html += `<div class="prompt-section section-${s.type}"><div class="prompt-section-header"><i class="${t.icon}"></i>${t.name}</div><div class="prompt-section-content">${escapeHtml(s.content)}</div></div>`;
        }
        preview.innerHTML = html;
        return;
      }
    }
    preview.innerHTML = `<div class="prompt-preview-header"><span>${escapeHtml(label)}</span></div><pre class="prompt-preview-content">${escapeHtml(content)}</pre>`;
  }
  
  // Show copy button if content exists
  if (tree.querySelector('.list-group-item-action')) copyBtn.classList.remove('d-none');
  
  // Render initial content if there's a placeholder div
  const initialDiv = preview.querySelector('.prompt-initial-content');
  if (initialDiv) {
    const ta = document.createElement('textarea'); ta.innerHTML = initialDiv.dataset.content;
    currentContent = ta.value;
    const headerSpan = preview.querySelector('.prompt-preview-header span');
    const initialLabel = headerSpan ? headerSpan.textContent : 'Backend Prompt';
    renderPreview(initialLabel, currentContent, true);
  }
  
  tree.addEventListener('click', evt => {
    const node = evt.target.closest('.list-group-item-action');
    if (!node) return;
    tree.querySelectorAll('.list-group-item.active').forEach(el => el.classList.remove('active'));
    node.classList.add('active');
    const ta = document.createElement('textarea'); ta.innerHTML = node.dataset.promptContent;
    currentContent = ta.value;
    const label = node.querySelector('span').textContent.trim();
    const isPrompt = label.toLowerCase().includes('prompt');
    renderPreview(label, currentContent, isPrompt);
  });
  
  window.copyCurrentPrompt = function() {
    if (!currentContent) return;
    navigator.clipboard.writeText(currentContent).then(() => { if (typeof showToast === 'function') showToast('Copied', 'success'); });
  };
})();
</script>
