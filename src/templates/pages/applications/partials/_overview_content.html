{# Applications Overview Content - Clean and minimal #}
<div id="applications-table-wrapper" class="w-100">
  <div id="applications-table-refresher"
       hx-get="/applications/table"
       hx-target="#applications-table-section"
       hx-trigger="load, refresh-applications-table from:body"
       hx-swap="outerHTML"></div>
  {% include 'pages/applications/partials/_table_block.html' %}
</div>

<!-- Application Details Modal (for quick view) -->
<div class="modal modal-blur fade" id="applicationDetailsModal" tabindex="-1" aria-labelledby="applicationDetailsLabel">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="application-details-modal-content">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- Container Action Progress Modal -->
<div class="modal modal-blur fade" id="containerActionModal" tabindex="-1" aria-labelledby="containerActionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="containerActionLabel">
          <i class="fas fa-cog fa-spin me-2" id="containerActionSpinner"></i>
          <span id="containerActionTitle">Container Operation</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="containerActionInfo" class="mb-3">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge bg-primary" id="containerActionType">BUILD</span>
            <span class="text-muted" id="containerActionTarget">openai_gpt-4 / App 1</span>
            <span class="badge ms-auto" id="containerActionStatus">Running</span>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="containerActionProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div class="text-muted small" id="containerActionStep">Initializing...</div>
        </div>
        <div class="card">
          <div class="card-header d-flex align-items-center">
            <span><i class="fas fa-terminal me-2"></i>Output</span>
            <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="copyContainerActionOutput()" title="Copy output">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <div class="card-body p-0">
            <pre id="containerActionOutput" class="bg-dark text-light p-3 mb-0" style="max-height: 300px; overflow-y: auto; font-size: 0.8rem;"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="containerActionCancelBtn" onclick="cancelContainerAction()">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Container Action History Modal -->
<div class="modal modal-blur fade" id="containerHistoryModal" tabindex="-1" aria-labelledby="containerHistoryLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="containerHistoryLabel">
          <i class="fas fa-history me-2"></i>Action History
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="containerHistoryContent">
        <div class="text-center py-4">
          <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
          <p class="text-muted mt-2">Loading history...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Batch Operations Modal - Compact Design -->
<div class="modal modal-blur fade" id="batchApplicationsModal" tabindex="-1" aria-labelledby="batchOperationsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title d-flex align-items-center gap-2" id="batchOperationsLabel">
          <i class="fas fa-layer-group text-primary"></i>
          <span>Batch Operations</span>
          <span class="badge bg-primary" id="selected-applications-count">0</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-2" id="batchOperationsBody">
        <!-- Default: Operation buttons -->
        <div id="batchOperationsButtons">
          <div class="btn-group-vertical w-100 gap-1" role="group">
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-success flex-fill" onclick="batchOperation('start')" title="Start all selected">
                <i class="fas fa-play me-1"></i>Start
              </button>
              <button class="btn btn-outline-danger flex-fill" onclick="batchOperation('stop')" title="Stop all selected">
                <i class="fas fa-stop me-1"></i>Stop
              </button>
              <button class="btn btn-outline-warning flex-fill" onclick="batchOperation('restart')" title="Restart all selected">
                <i class="fas fa-sync me-1"></i>Restart
              </button>
              <button class="btn btn-outline-primary flex-fill" onclick="batchOperation('build')" title="Build all selected">
                <i class="fas fa-hammer me-1"></i>Build
              </button>
            </div>
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-secondary flex-fill" onclick="batchOperation('export')" title="Export selected">
                <i class="fas fa-download me-1"></i>Export
              </button>
              <button class="btn btn-outline-danger flex-fill" onclick="confirmBatchDelete()" title="Delete selected">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
        </div>
        <!-- Progress view (shown during operations) -->
        <div id="batchOperationsProgress" style="display: none;">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="text-muted small" id="batchProgressLabel">Processing...</span>
            <span class="badge bg-primary" id="batchProgressCount">0/0</span>
          </div>
          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="batchProgressBar" role="progressbar" style="width: 0%"></div>
          </div>
          <div class="small" style="max-height: 150px; overflow-y: auto;" id="batchProgressLog"></div>
        </div>
        <!-- Results (shown after completion) -->
        <div id="batchOperationResult"></div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm" data-bs-dismiss="modal" id="batchCloseBtn">Close</button>
        <button type="button" class="btn btn-sm btn-danger" onclick="cancelBatchOperation()" id="batchCancelBtn" style="display: none;">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Prevent HTMX from blanking the applications table on empty/erroneous responses
document.body.addEventListener('htmx:beforeSwap', function(evt) {
  if (evt.detail.target && evt.detail.target.id === 'applications-table-section') {
    const status = evt.detail.xhr ? evt.detail.xhr.status : 0;
    if (!evt.detail.xhr.response || evt.detail.xhr.response.trim() === '' || status === 204) {
      evt.preventDefault();
      return;
    }
    const txt = evt.detail.xhr.response.trim().toLowerCase();
    if (txt.startsWith('<!doctype') || txt.startsWith('<html')) {
      console.warn('[HTMX Guard] Full document response blocked from swapping into applications-table-section');
      evt.preventDefault();
      showApplicationsErrorBanner('Received unexpected full-page response (possibly an error). Table preserved.');
      return;
    }
  }
});

// Global htmx error handler
document.body.addEventListener('htmx:sendError', function(e){
  showApplicationsErrorBanner('Network error while loading applications table.');
});
document.body.addEventListener('htmx:responseError', function(e){
  const xhr = e.detail.xhr;
  showApplicationsErrorBanner('Failed to load table (' + xhr.status + ').');
});

function showApplicationsErrorBanner(msg){
  let banner = document.getElementById('applications-table-error');
  if(!banner){
    banner = document.createElement('div');
    banner.id = 'applications-table-error';
    banner.className = 'alert alert-warning alert-dismissible fade show my-2 py-2 px-3';
    banner.innerHTML = '<strong>Applications:</strong> <span class="msg"></span>' +
      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
    const wrapper = document.getElementById('applications-table-wrapper') || document.body;
    wrapper.prepend(banner);
  }
  const span = banner.querySelector('.msg');
  if(span) span.textContent = msg;
}

// Get selected applications helper
function getSelectedApplications() {
  return Array.from(document.querySelectorAll('.app-checkbox:checked')).map(cb => cb.value);
}

// Update batch selection count
function updateBatchSelectionCount() {
  const count = getSelectedApplications().length;
  const element = document.getElementById('selected-applications-count');
  if (element) element.textContent = count;
}

// Batch operation state
var batchOperationState = {
  inProgress: false,
  cancelled: false,
  completed: 0,
  failed: 0,
  total: 0,
  operation: '',
  results: []
};

// Consolidated batch operation function with progress tracking
function batchOperation(operation) {
  const selected = getSelectedApplications();
  if (selected.length === 0) {
    showBatchToast('Please select at least one application.', 'warning');
    return;
  }
  
  if (batchOperationState.inProgress) {
    showBatchToast('A batch operation is already in progress.', 'warning');
    return;
  }

  // Reset state
  batchOperationState = {
    inProgress: true,
    cancelled: false,
    completed: 0,
    failed: 0,
    total: selected.length,
    operation: operation,
    results: []
  };

  // Show progress UI
  document.getElementById('batchOperationsButtons').style.display = 'none';
  document.getElementById('batchOperationsProgress').style.display = 'block';
  document.getElementById('batchOperationResult').innerHTML = '';
  document.getElementById('batchCancelBtn').style.display = 'inline-block';
  document.getElementById('batchCloseBtn').disabled = true;
  
  updateBatchProgress(`Starting ${operation}...`, 0);
  document.getElementById('batchProgressLog').innerHTML = '';

  // Process sequentially for better UX
  processBatchSequentially(selected, operation, 0);
}

async function processBatchSequentially(apps, operation, index) {
  if (batchOperationState.cancelled || index >= apps.length) {
    finishBatchOperation();
    return;
  }
  
  const appKey = apps[index];
  const lastDashIndex = appKey.lastIndexOf('-');
  const modelSlug = appKey.substring(0, lastDashIndex);
  const appNumber = appKey.substring(lastDashIndex + 1);
  const appLabel = `${modelSlug.split('_').pop()} #${appNumber}`;
  
  updateBatchProgress(`${operation}: ${appLabel}`, index);
  addBatchLogEntry(`<i class="fas fa-spinner fa-spin me-1"></i>${appLabel}...`, 'text-muted');
  
  try {
    let result = { ok: false, success: false };
    
    switch(operation) {
      case 'start':
      case 'stop':
      case 'restart':
      case 'build':
        const response = await fetch(`/api/app/${modelSlug}/${appNumber}/${operation}`, { method: 'POST' });
        const data = await response.json().catch(() => ({}));
        result = { ok: response.ok && data.success !== false, error: data.error };
        break;
      case 'export':
        window.open(`/applications/${modelSlug}/${appNumber}/export.csv`, '_blank');
        result = { ok: true };
        break;
      case 'delete':
        const delResp = await fetch(`/api/applications/${modelSlug}/${appNumber}`, { method: 'DELETE' });
        result = { ok: delResp.ok };
        break;
    }
    
    if (result.ok) {
      batchOperationState.completed++;
      updateBatchLogEntry(index, `<i class="fas fa-check text-success me-1"></i>${appLabel}`, 'text-success');
    } else {
      batchOperationState.failed++;
      const errMsg = result.error ? `: ${result.error.substring(0, 30)}` : '';
      updateBatchLogEntry(index, `<i class="fas fa-times text-danger me-1"></i>${appLabel}${errMsg}`, 'text-danger');
    }
    
    batchOperationState.results.push({ appKey, success: result.ok, error: result.error });
    
  } catch (error) {
    batchOperationState.failed++;
    updateBatchLogEntry(index, `<i class="fas fa-times text-danger me-1"></i>${appLabel}: ${error.message}`, 'text-danger');
    batchOperationState.results.push({ appKey, success: false, error: error.message });
  }
  
  // Small delay between operations
  setTimeout(() => processBatchSequentially(apps, operation, index + 1), 100);
}

function updateBatchProgress(label, currentIndex) {
  const total = batchOperationState.total;
  const percent = total > 0 ? Math.round(((currentIndex + 1) / total) * 100) : 0;
  
  document.getElementById('batchProgressLabel').textContent = label;
  document.getElementById('batchProgressCount').textContent = `${currentIndex + 1}/${total}`;
  document.getElementById('batchProgressBar').style.width = `${percent}%`;
}

function addBatchLogEntry(html, className) {
  const log = document.getElementById('batchProgressLog');
  const entry = document.createElement('div');
  entry.className = className || '';
  entry.innerHTML = html;
  entry.dataset.index = batchOperationState.completed + batchOperationState.failed;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
}

function updateBatchLogEntry(index, html, className) {
  const log = document.getElementById('batchProgressLog');
  const entry = log.querySelector(`[data-index="${index}"]`);
  if (entry) {
    entry.className = className || '';
    entry.innerHTML = html;
  }
}

function finishBatchOperation() {
  batchOperationState.inProgress = false;
  
  document.getElementById('batchCancelBtn').style.display = 'none';
  document.getElementById('batchCloseBtn').disabled = false;
  
  const { completed, failed, cancelled, operation } = batchOperationState;
  
  let alertClass = 'success';
  let icon = 'check-circle';
  let message = `${operation} completed: ${completed} successful`;
  
  if (failed > 0) {
    alertClass = 'warning';
    icon = 'exclamation-triangle';
    message += `, ${failed} failed`;
  }
  if (cancelled) {
    alertClass = 'secondary';
    icon = 'ban';
    message = `${operation} cancelled: ${completed} completed, ${batchOperationState.total - completed} remaining`;
  }
  
  document.getElementById('batchOperationResult').innerHTML = `
    <div class="alert alert-${alertClass} py-2 mb-0 mt-2 d-flex align-items-center gap-2">
      <i class="fas fa-${icon}"></i>
      <span>${message}</span>
      <button class="btn btn-sm btn-link ms-auto p-0" onclick="resetBatchUI()">
        <i class="fas fa-redo"></i> New
      </button>
    </div>
  `;
  
  // Refresh table
  if (completed > 0) {
    setTimeout(() => htmx.trigger('body', 'refresh-applications-table'), 500);
  }
}

function cancelBatchOperation() {
  batchOperationState.cancelled = true;
  document.getElementById('batchProgressLabel').textContent = 'Cancelling...';
}

function confirmBatchDelete() {
  const count = getSelectedApplications().length;
  if (confirm(`Are you sure you want to delete ${count} application(s)? This cannot be undone.`)) {
    batchOperation('delete');
  }
}

function resetBatchUI() {
  document.getElementById('batchOperationsButtons').style.display = 'block';
  document.getElementById('batchOperationsProgress').style.display = 'none';
  document.getElementById('batchOperationResult').innerHTML = '';
  document.getElementById('batchCancelBtn').style.display = 'none';
  document.getElementById('batchCloseBtn').disabled = false;
}

function showBatchToast(message, type = 'info') {
  const resultDiv = document.getElementById('batchOperationResult');
  if (resultDiv) {
    resultDiv.innerHTML = `<div class="alert alert-${type} py-2 mb-0 mt-2"><i class="fas fa-info-circle me-1"></i>${message}</div>`;
    setTimeout(() => { resultDiv.innerHTML = ''; }, 3000);
  }
}

// Reset batch UI when modal is closed
document.getElementById('batchApplicationsModal')?.addEventListener('hidden.bs.modal', resetBatchUI);

// ---- Container Operations Tracker ----
// Tracks all ongoing container operations (individual and batch)
var containerOperationsTracker = {
  operations: new Map(), // action_id -> operation info
  element: null,
  pollInterval: null
};

function initContainerTracker() {
  if (containerOperationsTracker.element) return;
  
  const tracker = document.createElement('div');
  tracker.id = 'container-ops-tracker';
  tracker.className = 'position-fixed bottom-0 end-0 p-3';
  tracker.style.cssText = 'z-index: 1090; max-width: 320px; pointer-events: none;';
  tracker.innerHTML = `
    <div id="container-ops-list" class="d-flex flex-column gap-2" style="pointer-events: auto;"></div>
  `;
  document.body.appendChild(tracker);
  containerOperationsTracker.element = tracker;
  
  // Start global polling for active operations
  if (!containerOperationsTracker.pollInterval) {
    containerOperationsTracker.pollInterval = setInterval(pollAllContainerOperations, 1500);
  }
}

function addContainerOperation(actionId, modelSlug, appNumber, actionType) {
  initContainerTracker();
  
  const opKey = actionId;
  const appLabel = `${modelSlug.split('_').pop()} #${appNumber}`;
  
  containerOperationsTracker.operations.set(opKey, {
    actionId, modelSlug, appNumber, actionType, appLabel,
    status: 'running', progress: 0, step: 'Starting...'
  });
  
  renderContainerOperations();
}

function renderContainerOperations() {
  const list = document.getElementById('container-ops-list');
  if (!list) return;
  
  const ops = Array.from(containerOperationsTracker.operations.values());
  
  if (ops.length === 0) {
    list.innerHTML = '';
    return;
  }
  
  list.innerHTML = ops.map(op => {
    const isRunning = op.status === 'running' || op.status === 'pending';
    const isFailed = op.status === 'failed';
    const isComplete = op.status === 'completed';
    
    let statusIcon = '<i class="fas fa-spinner fa-spin text-info"></i>';
    let bgClass = 'bg-white';
    let progressClass = 'bg-primary';
    
    if (isFailed) {
      statusIcon = '<i class="fas fa-times-circle text-danger"></i>';
      bgClass = 'bg-danger-lt';
      progressClass = 'bg-danger';
    } else if (isComplete) {
      statusIcon = '<i class="fas fa-check-circle text-success"></i>';
      bgClass = 'bg-success-lt';
      progressClass = 'bg-success';
    }
    
    return `
      <div class="card shadow-sm ${bgClass}" data-op-id="${op.actionId}" style="font-size: 0.85rem;">
        <div class="card-body p-2">
          <div class="d-flex align-items-center gap-2 mb-1">
            ${statusIcon}
            <span class="fw-medium text-truncate flex-grow-1" title="${op.modelSlug} App ${op.appNumber}">
              ${op.actionType.toUpperCase()}: ${op.appLabel}
            </span>
            ${!isRunning ? `<button class="btn btn-sm p-0 border-0" onclick="dismissContainerOperation('${op.actionId}')" title="Dismiss"><i class="fas fa-times text-muted"></i></button>` : ''}
          </div>
          <div class="progress mb-1" style="height: 4px;">
            <div class="progress-bar ${progressClass} ${isRunning ? 'progress-bar-striped progress-bar-animated' : ''}" style="width: ${op.progress}%"></div>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted text-truncate" style="max-width: 200px;" title="${op.step || ''}">${op.step || 'Processing...'}</small>
            ${isFailed ? `<button class="btn btn-sm btn-link p-0 text-danger" onclick="showOperationDetails('${op.actionId}')" title="View error"><i class="fas fa-eye"></i></button>` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function pollAllContainerOperations() {
  const ops = containerOperationsTracker.operations;
  if (ops.size === 0) return;
  
  ops.forEach((op, actionId) => {
    if (op.status !== 'running' && op.status !== 'pending') return;
    
    fetch(`/api/container-actions/${actionId}`)
      .then(r => r.json())
      .then(data => {
        if (!data.success || !data.action) return;
        
        const action = data.action;
        op.status = action.status;
        op.progress = action.progress_percentage || 0;
        op.step = action.current_step || action.error_message || '';
        
        // Update table row status
        updateTableRowStatus(action);
        
        if (action.status === 'completed') {
          op.progress = 100;
          op.step = 'Completed';
          showContainerToast(`${op.actionType} completed: ${op.appLabel}`, 'success', 3000);
          setTimeout(() => refreshApplications?.(), 500);
          // Auto-dismiss after 3 seconds
          setTimeout(() => dismissContainerOperation(actionId), 3000);
        } else if (action.status === 'failed') {
          op.step = action.error_message || 'Failed';
        }
        
        renderContainerOperations();
      })
      .catch(() => {});
  });
}

function dismissContainerOperation(actionId) {
  containerOperationsTracker.operations.delete(actionId);
  renderContainerOperations();
}

function showOperationDetails(actionId) {
  // Set up the modal with this action's details
  currentContainerAction = actionId;
  containerOutputOffset = 0;
  containerActionModalShown = true;
  
  const modal = new bootstrap.Modal(document.getElementById('containerActionModal'));
  modal.show();
  
  // Initialize modal with current state
  fetch(`/api/container-actions/${actionId}`)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.action) {
        const action = data.action;
        document.getElementById('containerActionTitle').textContent = `${action.action_type.charAt(0).toUpperCase() + action.action_type.slice(1)} Details`;
        document.getElementById('containerActionType').textContent = action.action_type.toUpperCase();
        document.getElementById('containerActionTarget').textContent = `${action.target_model} / App ${action.target_app_number}`;
        document.getElementById('containerActionSpinner').style.display = action.status === 'running' ? 'inline-block' : 'none';
        document.getElementById('containerActionCancelBtn').disabled = action.status !== 'running';
        
        // Update progress
        const progressEl = document.getElementById('containerActionProgress');
        progressEl.style.width = `${action.progress_percentage || 0}%`;
        progressEl.textContent = `${action.progress_percentage || 0}%`;
        
        // Status badge
        const statusBadge = document.getElementById('containerActionStatus');
        if (action.status === 'completed') {
          statusBadge.className = 'badge bg-success';
          statusBadge.textContent = 'Completed';
        } else if (action.status === 'failed') {
          statusBadge.className = 'badge bg-danger';
          statusBadge.textContent = 'Failed';
          progressEl.classList.add('bg-danger');
        } else {
          statusBadge.className = 'badge bg-info';
          statusBadge.textContent = 'Running';
        }
        
        document.getElementById('containerActionStep').textContent = action.current_step || action.error_message || '';
        
        // Load full output
        return fetch(`/api/container-actions/${actionId}/output?offset=0`);
      }
    })
    .then(r => r ? r.json() : null)
    .then(data => {
      if (data && data.success) {
        document.getElementById('containerActionOutput').textContent = data.output || '(no output)';
      }
    });
}

// Update selection count when checkboxes change
document.addEventListener('change', function(evt) {
  if (evt.target.classList.contains('app-checkbox')) {
    updateBatchSelectionCount();
  }
});

// Quick view application details
function viewApplicationDetails(modelSlug, appNumber) {
  htmx.ajax('GET', `/applications/${modelSlug}/${appNumber}/quick-view`, {
    target: '#application-details-modal-content',
    swap: 'innerHTML'
  });
  
  var modal = new bootstrap.Modal(document.getElementById('applicationDetailsModal'));
  modal.show();
}

// ---- Container Action Tracking ----
// Use var for HTMX-safety (allows re-declaration on page re-navigation)
var currentContainerAction = window._containerAction_current || null;
var containerActionPollInterval = window._containerAction_poll || null;
var containerOutputOffset = window._containerAction_offset || 0;
var containerActionModalShown = false;

function startContainerAction(modelSlug, appNumber, actionType, options = {}) {
  // Reset modal state
  currentContainerAction = null;
  containerOutputOffset = 0;
  containerActionModalShown = false;
  
  // Show inline status indicator first (non-intrusive)
  const row = document.querySelector(`tr[data-model="${modelSlug}"][data-app="${appNumber}"]`);
  const statusBadge = row?.querySelector('[data-role="status-badge"]');
  if (statusBadge) {
    statusBadge.className = 'badge bg-info-lt text-info';
    statusBadge.innerHTML = `<i class="fas fa-spinner fa-spin fa-xs me-1"></i>${actionType}ing...`;
  }
  
  // Build request body
  const body = {};
  if (actionType === 'build') {
    body.no_cache = options.no_cache || false;
    body.start_after = options.start_after || false;
  }
  
  // Start async action
  fetch(`/api/app/${modelSlug}/${appNumber}/action/${actionType}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.action_id) {
      currentContainerAction = data.action_id;
      // Add to tracker for progress display
      addContainerOperation(data.action_id, modelSlug, appNumber, actionType);
    } else {
      // Show error toast
      showContainerToast(data.error || `Failed to ${actionType}`, 'danger');
      if (statusBadge) {
        statusBadge.className = 'badge bg-danger-lt text-danger';
        statusBadge.innerHTML = `<i class="fas fa-times fa-xs me-1"></i>Error`;
      }
    }
  })
  .catch(error => {
    showContainerToast(`Error: ${error.message}`, 'danger');
    if (statusBadge) {
      statusBadge.className = 'badge bg-danger-lt text-danger';
      statusBadge.innerHTML = `<i class="fas fa-times fa-xs me-1"></i>Error`;
    }
  });
}

// Show modal only when user explicitly requests it or for long operations
function showContainerActionModal() {
  if (containerActionModalShown) return;
  containerActionModalShown = true;
  
  const modal = new bootstrap.Modal(document.getElementById('containerActionModal'));
  modal.show();
  
  // Start output polling for modal
  startModalOutputPolling();
  
  // Initialize modal with current state
  if (currentContainerAction) {
    fetch(`/api/container-actions/${currentContainerAction}`)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.action) {
          const action = data.action;
          document.getElementById('containerActionTitle').textContent = `${action.action_type.charAt(0).toUpperCase() + action.action_type.slice(1)} Operation`;
          document.getElementById('containerActionType').textContent = action.action_type.toUpperCase();
          document.getElementById('containerActionTarget').textContent = `${action.target_model} / App ${action.target_app_number}`;
          updateContainerActionUI(action);
        }
      });
    
    // Load full output
    fetch(`/api/container-actions/${currentContainerAction}/output?offset=0`)
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          document.getElementById('containerActionOutput').textContent = data.output || '(no output yet)';
          containerOutputOffset = data.next_offset || 0;
        }
      });
  }
}

// Poll output while modal is shown
var modalOutputPollInterval = null;

function startModalOutputPolling() {
  if (modalOutputPollInterval) clearInterval(modalOutputPollInterval);
  
  modalOutputPollInterval = setInterval(() => {
    if (!containerActionModalShown || !currentContainerAction) {
      clearInterval(modalOutputPollInterval);
      return;
    }
    
    // Poll output
    fetch(`/api/container-actions/${currentContainerAction}/output?offset=${containerOutputOffset}`)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.output) {
          const outputEl = document.getElementById('containerActionOutput');
          if (outputEl) {
            outputEl.textContent += data.output;
            outputEl.scrollTop = outputEl.scrollHeight;
          }
          containerOutputOffset = data.next_offset || (containerOutputOffset + data.output.length);
        }
      });
    
    // Also update modal UI
    fetch(`/api/container-actions/${currentContainerAction}`)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.action) {
          updateContainerActionUI(data.action);
        }
      });
  }, 1500);
}

// Stop modal polling when modal closes
document.getElementById('containerActionModal')?.addEventListener('hidden.bs.modal', () => {
  containerActionModalShown = false;
  if (modalOutputPollInterval) {
    clearInterval(modalOutputPollInterval);
    modalOutputPollInterval = null;
  }
});

// Toast notification for container operations
function showContainerToast(message, type = 'info', duration = 4000) {
  // Create toast container if it doesn't exist
  let container = document.getElementById('container-toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'container-toast-container';
    container.className = 'position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
  }
  
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0 show`;
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  container.appendChild(toast);
  
  // Auto-remove after duration
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, duration);
  
  // Manual dismiss
  toast.querySelector('.btn-close').addEventListener('click', () => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  });
}

function startContainerActionPolling() {
  // Polling is now handled by the centralized tracker (pollAllContainerOperations)
  // This function is kept for compatibility but is a no-op
}

// Update table row status based on action state
function updateTableRowStatus(action) {
  const row = document.querySelector(`tr[data-model="${action.target_model}"][data-app="${action.target_app_number}"]`);
  if (!row) return;
  
  const statusBadge = row.querySelector('[data-role="status-badge"]');
  if (!statusBadge) return;
  
  if (action.status === 'running') {
    statusBadge.className = 'badge bg-info-lt text-info';
    statusBadge.innerHTML = `<i class="fas fa-spinner fa-spin fa-xs me-1"></i>${action.action_type}ing...`;
  } else if (action.status === 'completed') {
    // Success - will be updated by table refresh
    statusBadge.className = 'badge bg-success-lt text-success';
    if (action.action_type === 'stop') {
      statusBadge.innerHTML = '<i class="fas fa-stop fa-xs me-1"></i>Stopped';
    } else {
      statusBadge.innerHTML = '<i class="fas fa-play fa-xs me-1"></i>Running';
    }
  } else if (action.status === 'failed') {
    // Failed - mark as build_failed
    statusBadge.className = 'badge bg-orange text-white';
    statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle fa-xs me-1"></i>Build Failed';
    row.classList.add('table-warning', 'opacity-85');
  }
}

function updateContainerActionUI(action) {
  // Only update modal UI if it's shown
  if (!containerActionModalShown) return;
  
  const progressEl = document.getElementById('containerActionProgress');
  const statusBadge = document.getElementById('containerActionStatus');
  const stepEl = document.getElementById('containerActionStep');
  const spinnerEl = document.getElementById('containerActionSpinner');
  const cancelBtn = document.getElementById('containerActionCancelBtn');
  
  if (progressEl) {
    const progress = action.progress_percentage || 0;
    progressEl.style.width = `${progress}%`;
    progressEl.textContent = `${progress}%`;
  }
  
  if (stepEl && action.current_step) {
    stepEl.textContent = action.current_step;
  }
  
  if (action.status === 'completed') {
    if (statusBadge) {
      statusBadge.className = 'badge bg-success';
      statusBadge.textContent = 'Completed';
    }
    if (progressEl) {
      progressEl.classList.remove('progress-bar-animated');
      progressEl.style.width = '100%';
      progressEl.textContent = '100%';
    }
    if (spinnerEl) spinnerEl.style.display = 'none';
    if (cancelBtn) cancelBtn.disabled = true;
  } else if (action.status === 'failed') {
    if (statusBadge) {
      statusBadge.className = 'badge bg-danger';
      statusBadge.textContent = 'Failed';
    }
    if (progressEl) {
      progressEl.classList.remove('progress-bar-animated');
      progressEl.classList.add('bg-danger');
    }
    if (spinnerEl) spinnerEl.style.display = 'none';
    if (cancelBtn) cancelBtn.disabled = true;
    if (stepEl && action.error_message) {
      stepEl.textContent = action.error_message;
    }
  } else if (action.status === 'cancelled') {
    if (statusBadge) {
      statusBadge.className = 'badge bg-warning';
      statusBadge.textContent = 'Cancelled';
    }
    if (progressEl) progressEl.classList.remove('progress-bar-animated');
    if (spinnerEl) spinnerEl.style.display = 'none';
    if (cancelBtn) cancelBtn.disabled = true;
  } else if (action.status === 'running') {
    if (statusBadge) {
      statusBadge.className = 'badge bg-info';
      statusBadge.textContent = 'Running';
    }
    if (spinnerEl) spinnerEl.style.display = 'inline-block';
    if (cancelBtn) cancelBtn.disabled = false;
  }
}

// Special toast for build failures with "View Details" option
function showContainerFailureToast(action) {
  let container = document.getElementById('container-toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'container-toast-container';
    container.className = 'position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
  }
  
  const errorMsg = action.error_message ? action.error_message.substring(0, 60) : 'Unknown error';
  const toast = document.createElement('div');
  toast.className = 'toast align-items-center border-0 show bg-danger text-white';
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="toast-body">
      <div class="d-flex align-items-center gap-2">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="flex-grow-1">
          <strong>${action.action_type} failed</strong>
          <div class="small opacity-75">${errorMsg}${action.error_message && action.error_message.length > 60 ? '...' : ''}</div>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="showContainerActionModal();this.closest('.toast').remove();" title="View full output">
          <i class="fas fa-eye"></i>
        </button>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  container.appendChild(toast);
  
  // Auto-remove after longer duration for errors
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 8000);
  
  toast.querySelector('.btn-close').addEventListener('click', () => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  });
}

function stopContainerActionPolling() {
  if (containerActionPollInterval) {
    clearInterval(containerActionPollInterval);
    containerActionPollInterval = null;
  }
}

function cancelContainerAction() {
  if (!currentContainerAction) return;
  
  fetch(`/api/container-actions/${currentContainerAction}/cancel`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('containerActionStatus').className = 'badge bg-warning';
        document.getElementById('containerActionStatus').textContent = 'Cancelling...';
      }
    });
}

function copyContainerActionOutput() {
  const output = document.getElementById('containerActionOutput').textContent;
  navigator.clipboard.writeText(output).then(() => {
    showNotification('Output copied to clipboard', 'success');
  });
}

// Action history
function showActionHistory(modelSlug, appNumber) {
  const modal = new bootstrap.Modal(document.getElementById('containerHistoryModal'));
  modal.show();
  
  document.getElementById('containerHistoryContent').innerHTML = `
    <div class="text-center py-4">
      <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
      <p class="text-muted mt-2">Loading history...</p>
    </div>
  `;
  
  fetch(`/api/app/${modelSlug}/${appNumber}/actions?limit=20`)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.actions) {
        renderActionHistory(data.actions);
      } else {
        document.getElementById('containerHistoryContent').innerHTML = `
          <div class="alert alert-warning">No action history found.</div>
        `;
      }
    })
    .catch(error => {
      document.getElementById('containerHistoryContent').innerHTML = `
        <div class="alert alert-danger">Failed to load history: ${error.message}</div>
      `;
    });
}

function renderActionHistory(actions) {
  if (!actions.length) {
    document.getElementById('containerHistoryContent').innerHTML = `
      <div class="alert alert-info">No container actions recorded yet.</div>
    `;
    return;
  }
  
  const rows = actions.map(action => {
    const statusClass = {
      'completed': 'bg-success',
      'failed': 'bg-danger',
      'running': 'bg-info',
      'pending': 'bg-secondary',
      'cancelled': 'bg-warning'
    }[action.status] || 'bg-secondary';
    
    const typeIcon = {
      'build': 'fa-hammer',
      'start': 'fa-play',
      'stop': 'fa-stop',
      'restart': 'fa-sync'
    }[action.action_type] || 'fa-cog';
    
    const duration = action.completed_at && action.started_at
      ? Math.round((new Date(action.completed_at) - new Date(action.started_at)) / 1000) + 's'
      : action.started_at ? 'In progress' : 'Pending';
    
    return `
      <tr>
        <td><i class="fas ${typeIcon} me-1"></i>${action.action_type.toUpperCase()}</td>
        <td><span class="badge ${statusClass}">${action.status}</span></td>
        <td>${action.progress_percentage || 0}%</td>
        <td class="text-muted small">${new Date(action.created_at).toLocaleString()}</td>
        <td>${duration}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" onclick="viewActionDetails('${action.action_id}')" title="View details">
            <i class="fas fa-eye"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('containerHistoryContent').innerHTML = `
    <table class="table table-sm table-hover">
      <thead>
        <tr>
          <th>Type</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Started</th>
          <th>Duration</th>
          <th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function viewActionDetails(actionId) {
  // Close history modal, open action modal with details
  const historyModal = bootstrap.Modal.getInstance(document.getElementById('containerHistoryModal'));
  if (historyModal) historyModal.hide();
  
  currentContainerAction = actionId;
  containerOutputOffset = 0;
  
  const modal = new bootstrap.Modal(document.getElementById('containerActionModal'));
  modal.show();
  
  // Load action details
  fetch(`/api/container-actions/${actionId}`)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.action) {
        const action = data.action;
        document.getElementById('containerActionTitle').textContent = `${action.action_type.toUpperCase()} Details`;
        document.getElementById('containerActionType').textContent = action.action_type.toUpperCase();
        document.getElementById('containerActionTarget').textContent = `${action.target_model} / App ${action.target_app_number}`;
        document.getElementById('containerActionSpinner').style.display = action.status === 'running' ? 'inline-block' : 'none';
        document.getElementById('containerActionCancelBtn').disabled = action.status !== 'running';
        updateContainerActionUI(action);
        
        // Load full output
        return fetch(`/api/container-actions/${actionId}/output?offset=0`);
      }
    })
    .then(r => r ? r.json() : null)
    .then(data => {
      if (data && data.success) {
        document.getElementById('containerActionOutput').textContent = data.output || '(no output)';
      }
    });
}
</script>
