{# Applications Overview Content - Clean and minimal #}
<div id="applications-table-wrapper" class="w-100">
  <div id="applications-table-refresher"
       hx-get="/applications/table"
       hx-target="#applications-table-section"
       hx-trigger="load, refresh-applications-table from:body"
       hx-swap="outerHTML"></div>
  {% include 'pages/applications/partials/_table_block.html' %}
</div>

<!-- Application Details Modal (for quick view) -->
<div class="modal modal-blur fade" id="applicationDetailsModal" tabindex="-1" aria-labelledby="applicationDetailsLabel">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="application-details-modal-content">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- Container Action Progress Modal -->
<div class="modal modal-blur fade" id="containerActionModal" tabindex="-1" aria-labelledby="containerActionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="containerActionLabel">
          <i class="fas fa-cog fa-spin me-2" id="containerActionSpinner"></i>
          <span id="containerActionTitle">Container Operation</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="containerActionInfo" class="mb-3">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge bg-primary" id="containerActionType">BUILD</span>
            <span class="text-muted" id="containerActionTarget">openai_gpt-4 / App 1</span>
            <span class="badge ms-auto" id="containerActionStatus">Running</span>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="containerActionProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div class="text-muted small" id="containerActionStep">Initializing...</div>
        </div>
        <div class="card">
          <div class="card-header d-flex align-items-center">
            <span><i class="fas fa-terminal me-2"></i>Output</span>
            <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="copyContainerActionOutput()" title="Copy output">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <div class="card-body p-0">
            <pre id="containerActionOutput" class="bg-dark text-light p-3 mb-0" style="max-height: 300px; overflow-y: auto; font-size: 0.8rem;"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="containerActionCancelBtn" onclick="cancelContainerAction()">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Container Action History Modal -->
<div class="modal modal-blur fade" id="containerHistoryModal" tabindex="-1" aria-labelledby="containerHistoryLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="containerHistoryLabel">
          <i class="fas fa-history me-2"></i>Action History
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="containerHistoryContent">
        <div class="text-center py-4">
          <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
          <p class="text-muted mt-2">Loading history...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Batch Operations Modal -->
<div class="modal modal-blur fade" id="batchApplicationsModal" tabindex="-1" aria-labelledby="batchOperationsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="batchOperationsLabel">
          <i class="fas fa-layer-group me-2"></i>Batch Operations
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">
          Perform operations on <span id="selected-applications-count">0</span> selected applications.
        </p>
        <div class="row g-3">
          <div class="col-md-6">
            <h6>Container Operations</h6>
            <div class="list-group">
              <button class="list-group-item list-group-item-action" onclick="batchOperation('start')">
                <i class="fas fa-play me-2 text-success"></i>Start All
              </button>
              <button class="list-group-item list-group-item-action" onclick="batchOperation('stop')">
                <i class="fas fa-stop me-2 text-danger"></i>Stop All
              </button>
              <button class="list-group-item list-group-item-action" onclick="batchOperation('restart')">
                <i class="fas fa-rotate me-2 text-warning"></i>Restart All
              </button>
              <button class="list-group-item list-group-item-action" onclick="batchOperation('build')">
                <i class="fas fa-hammer me-2 text-primary"></i>Build All
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <h6>Export & Management</h6>
            <div class="list-group">
              <button class="list-group-item list-group-item-action" onclick="batchOperation('export')">
                <i class="fas fa-download me-2 text-secondary"></i>Export Selected
              </button>
              <button class="list-group-item list-group-item-action text-danger" onclick="batchOperation('delete')">
                <i class="fas fa-trash me-2"></i>Delete Selected
              </button>
            </div>
          </div>
        </div>
        <div id="batchOperationResult" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Prevent HTMX from blanking the applications table on empty/erroneous responses
document.body.addEventListener('htmx:beforeSwap', function(evt) {
  if (evt.detail.target && evt.detail.target.id === 'applications-table-section') {
    const status = evt.detail.xhr ? evt.detail.xhr.status : 0;
    if (!evt.detail.xhr.response || evt.detail.xhr.response.trim() === '' || status === 204) {
      evt.preventDefault();
      return;
    }
    const txt = evt.detail.xhr.response.trim().toLowerCase();
    if (txt.startsWith('<!doctype') || txt.startsWith('<html')) {
      console.warn('[HTMX Guard] Full document response blocked from swapping into applications-table-section');
      evt.preventDefault();
      showApplicationsErrorBanner('Received unexpected full-page response (possibly an error). Table preserved.');
      return;
    }
  }
});

// Global htmx error handler
document.body.addEventListener('htmx:sendError', function(e){
  showApplicationsErrorBanner('Network error while loading applications table.');
});
document.body.addEventListener('htmx:responseError', function(e){
  const xhr = e.detail.xhr;
  showApplicationsErrorBanner('Failed to load table (' + xhr.status + ').');
});

function showApplicationsErrorBanner(msg){
  let banner = document.getElementById('applications-table-error');
  if(!banner){
    banner = document.createElement('div');
    banner.id = 'applications-table-error';
    banner.className = 'alert alert-warning alert-dismissible fade show my-2 py-2 px-3';
    banner.innerHTML = '<strong>Applications:</strong> <span class="msg"></span>' +
      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
    const wrapper = document.getElementById('applications-table-wrapper') || document.body;
    wrapper.prepend(banner);
  }
  const span = banner.querySelector('.msg');
  if(span) span.textContent = msg;
}

// Get selected applications helper
function getSelectedApplications() {
  return Array.from(document.querySelectorAll('.app-checkbox:checked')).map(cb => cb.value);
}

// Update batch selection count
function updateBatchSelectionCount() {
  const count = getSelectedApplications().length;
  const element = document.getElementById('selected-applications-count');
  if (element) element.textContent = count;
}

// Consolidated batch operation function
function batchOperation(operation) {
  const selected = getSelectedApplications();
  if (selected.length === 0) {
    alert('Please select at least one application.');
    return;
  }

  const resultDiv = document.getElementById('batchOperationResult');
  if (resultDiv) {
    resultDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Processing ${operation} for ${selected.length} applications...</div>`;
  }

  const promises = selected.map(appKey => {
    // Split at last dash since model slugs can contain dashes (e.g., anthropic_claude-4.5-haiku-20251001-1)
    const lastDashIndex = appKey.lastIndexOf('-');
    const modelSlug = appKey.substring(0, lastDashIndex);
    const appNumber = appKey.substring(lastDashIndex + 1);
    
    switch(operation) {
      case 'start':
      case 'stop':
      case 'restart':
      case 'build':
        return fetch(`/api/app/${modelSlug}/${appNumber}/${operation}`, { method: 'POST' });
      case 'export':
        window.open(`/applications/${modelSlug}/${appNumber}/export.csv`, '_blank');
        return Promise.resolve({ ok: true });
      case 'delete':
        return fetch(`/api/applications/${modelSlug}/${appNumber}`, { method: 'DELETE' });
      default:
        return Promise.reject(new Error(`Unknown operation: ${operation}`));
    }
  });

  Promise.allSettled(promises).then(results => {
    const successful = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
    const failed = results.length - successful;
    
    let message = `Operation completed: ${successful} successful`;
    if (failed > 0) message += `, ${failed} failed`;
    
    if (resultDiv) {
      resultDiv.innerHTML = `<div class="alert alert-${failed > 0 ? 'warning' : 'success'}">${message}</div>`;
    }
    
    // Refresh table if any operation succeeded
    if (successful > 0) {
      setTimeout(() => {
        htmx.trigger('body', 'refresh-applications-table');
      }, 1000);
    }
  }).catch(error => {
    if (resultDiv) {
      resultDiv.innerHTML = `<div class="alert alert-danger">Batch operation failed: ${error.message}</div>`;
    }
  });
}

// Update selection count when checkboxes change
document.addEventListener('change', function(evt) {
  if (evt.target.classList.contains('app-checkbox')) {
    updateBatchSelectionCount();
  }
});

// Quick view application details
function viewApplicationDetails(modelSlug, appNumber) {
  htmx.ajax('GET', `/applications/${modelSlug}/${appNumber}/quick-view`, {
    target: '#application-details-modal-content',
    swap: 'innerHTML'
  });
  
  const modal = new bootstrap.Modal(document.getElementById('applicationDetailsModal'));
  modal.show();
}

// ---- Container Action Tracking ----
let currentContainerAction = null;
let containerActionPollInterval = null;
let containerOutputOffset = 0;

function startContainerAction(modelSlug, appNumber, actionType, options = {}) {
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('containerActionModal'));
  modal.show();
  
  // Reset state
  currentContainerAction = null;
  containerOutputOffset = 0;
  
  // Update UI
  document.getElementById('containerActionTitle').textContent = `${actionType.charAt(0).toUpperCase() + actionType.slice(1)} Operation`;
  document.getElementById('containerActionType').textContent = actionType.toUpperCase();
  document.getElementById('containerActionTarget').textContent = `${modelSlug} / App ${appNumber}`;
  document.getElementById('containerActionStatus').className = 'badge bg-info';
  document.getElementById('containerActionStatus').textContent = 'Starting...';
  document.getElementById('containerActionProgress').style.width = '0%';
  document.getElementById('containerActionProgress').textContent = '0%';
  document.getElementById('containerActionStep').textContent = 'Initializing...';
  document.getElementById('containerActionOutput').textContent = '';
  document.getElementById('containerActionSpinner').style.display = 'inline-block';
  document.getElementById('containerActionCancelBtn').disabled = false;
  
  // Build request body
  const body = {};
  if (actionType === 'build') {
    body.no_cache = options.no_cache || false;
    body.start_after = options.start_after || false;
  }
  
  // Start async action
  fetch(`/api/app/${modelSlug}/${appNumber}/action/${actionType}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.action_id) {
      currentContainerAction = data.action_id;
      document.getElementById('containerActionStatus').textContent = 'Running';
      startContainerActionPolling();
    } else {
      document.getElementById('containerActionStatus').className = 'badge bg-danger';
      document.getElementById('containerActionStatus').textContent = 'Failed';
      document.getElementById('containerActionStep').textContent = data.error || 'Failed to start action';
      document.getElementById('containerActionSpinner').style.display = 'none';
    }
  })
  .catch(error => {
    document.getElementById('containerActionStatus').className = 'badge bg-danger';
    document.getElementById('containerActionStatus').textContent = 'Error';
    document.getElementById('containerActionStep').textContent = error.message;
    document.getElementById('containerActionSpinner').style.display = 'none';
  });
}

function startContainerActionPolling() {
  if (containerActionPollInterval) {
    clearInterval(containerActionPollInterval);
  }
  
  containerActionPollInterval = setInterval(() => {
    if (!currentContainerAction) {
      clearInterval(containerActionPollInterval);
      return;
    }
    
    // Poll status
    fetch(`/api/container-actions/${currentContainerAction}`)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.action) {
          updateContainerActionUI(data.action);
        }
      });
    
    // Poll output
    fetch(`/api/container-actions/${currentContainerAction}/output?offset=${containerOutputOffset}`)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.output) {
          const outputEl = document.getElementById('containerActionOutput');
          outputEl.textContent += data.output;
          outputEl.scrollTop = outputEl.scrollHeight;
          containerOutputOffset = data.next_offset || (containerOutputOffset + data.output.length);
        }
      });
  }, 1000);
}

function updateContainerActionUI(action) {
  const progress = action.progress_percentage || 0;
  const progressBar = document.getElementById('containerActionProgress');
  progressBar.style.width = `${progress}%`;
  progressBar.textContent = `${progress}%`;
  
  if (action.current_step) {
    document.getElementById('containerActionStep').textContent = action.current_step;
  }
  
  const statusBadge = document.getElementById('containerActionStatus');
  
  if (action.status === 'completed') {
    statusBadge.className = 'badge bg-success';
    statusBadge.textContent = 'Completed';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.style.width = '100%';
    progressBar.textContent = '100%';
    document.getElementById('containerActionSpinner').style.display = 'none';
    document.getElementById('containerActionCancelBtn').disabled = true;
    stopContainerActionPolling();
    // Refresh table after success
    setTimeout(() => { if (typeof refreshApplications === 'function') refreshApplications(); }, 1000);
  } else if (action.status === 'failed') {
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = 'Failed';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-danger');
    document.getElementById('containerActionSpinner').style.display = 'none';
    document.getElementById('containerActionCancelBtn').disabled = true;
    if (action.error_message) {
      document.getElementById('containerActionStep').textContent = action.error_message;
    }
    stopContainerActionPolling();
  } else if (action.status === 'cancelled') {
    statusBadge.className = 'badge bg-warning';
    statusBadge.textContent = 'Cancelled';
    progressBar.classList.remove('progress-bar-animated');
    document.getElementById('containerActionSpinner').style.display = 'none';
    document.getElementById('containerActionCancelBtn').disabled = true;
    stopContainerActionPolling();
  }
}

function stopContainerActionPolling() {
  if (containerActionPollInterval) {
    clearInterval(containerActionPollInterval);
    containerActionPollInterval = null;
  }
}

function cancelContainerAction() {
  if (!currentContainerAction) return;
  
  fetch(`/api/container-actions/${currentContainerAction}/cancel`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('containerActionStatus').className = 'badge bg-warning';
        document.getElementById('containerActionStatus').textContent = 'Cancelling...';
      }
    });
}

function copyContainerActionOutput() {
  const output = document.getElementById('containerActionOutput').textContent;
  navigator.clipboard.writeText(output).then(() => {
    showNotification('Output copied to clipboard', 'success');
  });
}

// Action history
function showActionHistory(modelSlug, appNumber) {
  const modal = new bootstrap.Modal(document.getElementById('containerHistoryModal'));
  modal.show();
  
  document.getElementById('containerHistoryContent').innerHTML = `
    <div class="text-center py-4">
      <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
      <p class="text-muted mt-2">Loading history...</p>
    </div>
  `;
  
  fetch(`/api/app/${modelSlug}/${appNumber}/actions?limit=20`)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.actions) {
        renderActionHistory(data.actions);
      } else {
        document.getElementById('containerHistoryContent').innerHTML = `
          <div class="alert alert-warning">No action history found.</div>
        `;
      }
    })
    .catch(error => {
      document.getElementById('containerHistoryContent').innerHTML = `
        <div class="alert alert-danger">Failed to load history: ${error.message}</div>
      `;
    });
}

function renderActionHistory(actions) {
  if (!actions.length) {
    document.getElementById('containerHistoryContent').innerHTML = `
      <div class="alert alert-info">No container actions recorded yet.</div>
    `;
    return;
  }
  
  const rows = actions.map(action => {
    const statusClass = {
      'completed': 'bg-success',
      'failed': 'bg-danger',
      'running': 'bg-info',
      'pending': 'bg-secondary',
      'cancelled': 'bg-warning'
    }[action.status] || 'bg-secondary';
    
    const typeIcon = {
      'build': 'fa-hammer',
      'start': 'fa-play',
      'stop': 'fa-stop',
      'restart': 'fa-sync'
    }[action.action_type] || 'fa-cog';
    
    const duration = action.completed_at && action.started_at
      ? Math.round((new Date(action.completed_at) - new Date(action.started_at)) / 1000) + 's'
      : action.started_at ? 'In progress' : 'Pending';
    
    return `
      <tr>
        <td><i class="fas ${typeIcon} me-1"></i>${action.action_type.toUpperCase()}</td>
        <td><span class="badge ${statusClass}">${action.status}</span></td>
        <td>${action.progress_percentage || 0}%</td>
        <td class="text-muted small">${new Date(action.created_at).toLocaleString()}</td>
        <td>${duration}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" onclick="viewActionDetails('${action.action_id}')" title="View details">
            <i class="fas fa-eye"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('containerHistoryContent').innerHTML = `
    <table class="table table-sm table-hover">
      <thead>
        <tr>
          <th>Type</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Started</th>
          <th>Duration</th>
          <th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function viewActionDetails(actionId) {
  // Close history modal, open action modal with details
  const historyModal = bootstrap.Modal.getInstance(document.getElementById('containerHistoryModal'));
  if (historyModal) historyModal.hide();
  
  currentContainerAction = actionId;
  containerOutputOffset = 0;
  
  const modal = new bootstrap.Modal(document.getElementById('containerActionModal'));
  modal.show();
  
  // Load action details
  fetch(`/api/container-actions/${actionId}`)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.action) {
        const action = data.action;
        document.getElementById('containerActionTitle').textContent = `${action.action_type.toUpperCase()} Details`;
        document.getElementById('containerActionType').textContent = action.action_type.toUpperCase();
        document.getElementById('containerActionTarget').textContent = `${action.target_model} / App ${action.target_app_number}`;
        document.getElementById('containerActionSpinner').style.display = action.status === 'running' ? 'inline-block' : 'none';
        document.getElementById('containerActionCancelBtn').disabled = action.status !== 'running';
        updateContainerActionUI(action);
        
        // Load full output
        return fetch(`/api/container-actions/${actionId}/output?offset=0`);
      }
    })
    .then(r => r ? r.json() : null)
    .then(data => {
      if (data && data.success) {
        document.getElementById('containerActionOutput').textContent = data.output || '(no output)';
      }
    });
}
</script>
