{# Applications Overview Content - Clean and minimal #}
{# Container management is handled by inline script in applications_main.html #}

<div id="applications-table-wrapper" class="w-100">
  <div id="applications-table-refresher"
       hx-get="/applications/table"
       hx-target="#applications-table-swap-target"
       hx-trigger="load, refresh-applications-table from:body"
       hx-swap="innerHTML"></div>
  <div id="applications-table-swap-target">
    {% include 'pages/applications/partials/_table_block.html' %}
  </div>
</div>

<!-- Application Details Modal (for quick view) -->
<div class="modal modal-blur fade" id="applicationDetailsModal" tabindex="-1" aria-labelledby="applicationDetailsLabel">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="application-details-modal-content">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- Container Action History Modal -->
<div class="modal modal-blur fade" id="containerHistoryModal" tabindex="-1" aria-labelledby="containerHistoryLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="containerHistoryLabel">
          <i class="fa-solid fa-history me-2"></i>Action History
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="containerHistoryContent">
        <div class="text-center py-4">
          <i class="fa-solid fa-spinner fa-spin fa-2x text-muted"></i>
          <p class="text-muted mt-2">Loading history...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Batch Operations Modal - Compact Design -->
<div class="modal modal-blur fade" id="batchApplicationsModal" tabindex="-1" aria-labelledby="batchOperationsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title d-flex align-items-center gap-2" id="batchOperationsLabel">
          <i class="fa-solid fa-layer-group text-primary"></i>
          <span>Batch Operations</span>
          <span class="badge bg-primary" id="selected-applications-count">0</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-2" id="batchOperationsBody">
        <!-- Default: Operation buttons -->
        <div id="batchOperationsButtons">
          <div class="btn-group-vertical w-100 gap-1" role="group">
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-success flex-fill" onclick="batchOperation('start')" title="Start all selected">
                <i class="fa-solid fa-play me-1"></i>Start
              </button>
              <button class="btn btn-outline-danger flex-fill" onclick="batchOperation('stop')" title="Stop all selected">
                <i class="fa-solid fa-stop me-1"></i>Stop
              </button>
              <button class="btn btn-outline-warning flex-fill" onclick="batchOperation('restart')" title="Restart all selected">
                <i class="fa-solid fa-sync me-1"></i>Restart
              </button>
              <button class="btn btn-outline-primary flex-fill" onclick="batchOperation('build')" title="Build all selected">
                <i class="fa-solid fa-hammer me-1"></i>Build
              </button>
            </div>
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-secondary flex-fill" onclick="batchOperation('export')" title="Export selected">
                <i class="fa-solid fa-download me-1"></i>Export
              </button>
              <button class="btn btn-outline-danger flex-fill" onclick="confirmBatchDelete()" title="Delete selected">
                <i class="fa-solid fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
        </div>
        <!-- Progress view (shown during operations) -->
        <div id="batchOperationsProgress" style="display: none;">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="text-muted small" id="batchProgressLabel">Processing...</span>
            <span class="badge bg-primary" id="batchProgressCount">0/0</span>
          </div>
          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="batchProgressBar" role="progressbar" style="width: 0%"></div>
          </div>
          <div class="small" style="max-height: 150px; overflow-y: auto;" id="batchProgressLog"></div>
        </div>
        <!-- Results (shown after completion) -->
        <div id="batchOperationResult"></div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm" data-bs-dismiss="modal" id="batchCloseBtn">Close</button>
        <button type="button" class="btn btn-sm btn-danger" onclick="cancelBatchOperation()" id="batchCancelBtn" style="display: none;">
          <i class="fa-solid fa-times me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
'use strict';

// ============================================================================
// HTMX Response Handlers - prevent blank responses from wiping table
// ============================================================================

document.body.addEventListener('htmx:beforeSwap', function(evt) {
  if (evt.detail.target && (evt.detail.target.id === 'applications-table-swap-target' || evt.detail.target.id === 'applications-table-section')) {
    const status = evt.detail.xhr ? evt.detail.xhr.status : 0;
    if (!evt.detail.xhr.response || evt.detail.xhr.response.trim() === '' || status === 204) {
      evt.preventDefault();
      return;
    }
    const txt = evt.detail.xhr.response.trim().toLowerCase();
    if (txt.startsWith('<!doctype') || txt.startsWith('<html')) {
      console.warn('[HTMX Guard] Full document response blocked');
      evt.preventDefault();
      showApplicationsErrorBanner('Received unexpected full-page response. Table preserved.');
      return;
    }
  }
});

document.body.addEventListener('htmx:sendError', function(e){
  showApplicationsErrorBanner('Network error while loading applications table.');
});

document.body.addEventListener('htmx:responseError', function(e){
  showApplicationsErrorBanner('Failed to load table (' + e.detail.xhr.status + ').');
});

function showApplicationsErrorBanner(msg){
  let banner = document.getElementById('applications-table-error');
  if(!banner){
    banner = document.createElement('div');
    banner.id = 'applications-table-error';
    banner.className = 'alert alert-warning alert-dismissible fade show my-2 py-2 px-3';
    banner.innerHTML = '<strong>Applications:</strong> <span class="msg"></span>' +
      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    (document.getElementById('applications-table-wrapper') || document.body).prepend(banner);
  }
  banner.querySelector('.msg').textContent = msg;
}

// ============================================================================
// Quick view application details
// ============================================================================

window.viewApplicationDetails = function(modelSlug, appNumber) {
  htmx.ajax('GET', `/applications/${modelSlug}/${appNumber}/quick-view`, {
    target: '#application-details-modal-content',
    swap: 'innerHTML'
  });
  new bootstrap.Modal(document.getElementById('applicationDetailsModal')).show();
};

})();
</script>
