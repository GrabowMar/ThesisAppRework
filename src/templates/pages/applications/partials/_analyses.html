{# Analyses section - Analysis tasks linked to database records #}
<div class="row g-3">
  {# Summary Card #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <div class="me-2">
              <i class="fas fa-flask text-info"></i>
            </div>
            <h3 class="card-title mb-0">Analysis Summary</h3>
          </div>
          <a href="{{ url_for('analysis.analysis_create') }}?model={{ app_data.model_slug }}&app={{ app_data.app_number }}" 
             class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i>New Analysis
          </a>
        </div>
        
        <div class="row g-2">
          <div class="col-6 col-md-3">
            <div class="text-center p-2 bg-light rounded">
              <div class="h3 mb-0 text-primary">{{ analysis_tasks|length|default(0) }}</div>
              <div class="small text-muted">Total Tasks</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-center p-2 bg-light rounded">
              {% set completed_count = 0 %}
              {% if analysis_tasks %}
                {% for t in analysis_tasks %}
                  {% if t.status and t.status.value == 'COMPLETED' %}{% set completed_count = completed_count + 1 %}{% endif %}
                {% endfor %}
              {% endif %}
              <div class="h3 mb-0 text-success">{{ completed_count }}</div>
              <div class="small text-muted">Completed</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-center p-2 bg-light rounded">
              {% set running_count = 0 %}
              {% if analysis_tasks %}
                {% for t in analysis_tasks %}
                  {% if t.status and t.status.value == 'RUNNING' %}{% set running_count = running_count + 1 %}{% endif %}
                {% endfor %}
              {% endif %}
              <div class="h3 mb-0 text-warning">{{ running_count }}</div>
              <div class="small text-muted">Running</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-center p-2 bg-light rounded">
              {% set failed_count = 0 %}
              {% if analysis_tasks %}
                {% for t in analysis_tasks %}
                  {% if t.status and t.status.value == 'FAILED' %}{% set failed_count = failed_count + 1 %}{% endif %}
                {% endfor %}
              {% endif %}
              <div class="h3 mb-0 text-danger">{{ failed_count }}</div>
              <div class="small text-muted">Failed</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Analysis Tasks Table #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-header">
        <div class="d-flex align-items-center">
          <i class="fas fa-tasks text-primary me-2"></i>
          <h3 class="card-title mb-0">Analysis Tasks</h3>
        </div>
        <div class="card-actions">
          <button class="btn btn-sm btn-ghost-secondary" 
                  hx-get="{{ url_for('applications.application_section_analyses', model_slug=app_data.model_slug, app_number=app_data.app_number) }}"
                  hx-target="#section-analyses"
                  hx-swap="innerHTML">
            <i class="fas fa-sync me-1"></i>Refresh
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        {% if analysis_tasks and analysis_tasks|length > 0 %}
        <div class="table-responsive">
          <table class="table table-vcenter table-hover card-table">
            <thead>
              <tr>
                <th>Task ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Findings</th>
                <th>Created</th>
                <th>Duration</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for task in analysis_tasks %}
              <tr>
                <td>
                  <a href="{{ url_for('analysis.analysis_result_detail', result_id=task.task_id) }}" 
                     class="text-decoration-none">
                    <code class="small">{{ task.task_id[:12] }}...</code>
                  </a>
                  {% if task.is_main_task %}
                  <span class="badge bg-primary-lt ms-1" title="Main task with subtasks">Main</span>
                  {% endif %}
                </td>
                <td>
                  <div class="fw-medium">{{ task.task_name or 'Unnamed Task' }}</div>
                  {% if task.service_name %}
                  <div class="small text-muted">{{ task.service_name }}</div>
                  {% endif %}
                </td>
                <td>
                  {% set status_str = task.status.value if task.status else 'unknown' %}
                  {% set status_color = {
                    'COMPLETED': 'success',
                    'RUNNING': 'warning',
                    'PENDING': 'secondary',
                    'FAILED': 'danger',
                    'CANCELLED': 'secondary'
                  }.get(status_str, 'secondary') %}
                  <span class="badge bg-{{ status_color }}-lt text-{{ status_color }}">
                    {% if status_str == 'RUNNING' %}<span class="spinner-border spinner-border-sm me-1"></span>{% endif %}
                    {{ status_str|replace('_', ' ')|title }}
                  </span>
                  {% if task.progress_percentage and status_str == 'RUNNING' %}
                  <div class="progress progress-sm mt-1" style="width: 80px;">
                    <div class="progress-bar bg-{{ status_color }}" style="width: {{ task.progress_percentage }}%"></div>
                  </div>
                  {% endif %}
                </td>
                <td>
                  {% if task.issues_found is not none %}
                  <span class="{% if task.issues_found > 10 %}text-danger{% elif task.issues_found > 0 %}text-warning{% else %}text-success{% endif %}">
                    {{ task.issues_found }}
                  </span>
                  {% if task.severity_breakdown %}
                    {% set breakdown = task.get_severity_breakdown() if task.get_severity_breakdown else {} %}
                    {% if breakdown.critical or breakdown.high %}
                    <span class="badge bg-danger-lt text-danger ms-1" title="Critical/High severity">!</span>
                    {% endif %}
                  {% endif %}
                  {% else %}
                  <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td>
                  <span title="{{ task.created_at.isoformat() if task.created_at else '' }}">
                    {{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at else '—' }}
                  </span>
                </td>
                <td>
                  {% if task.actual_duration %}
                  <span class="text-muted">{{ '%.1f'|format(task.actual_duration) }}s</span>
                  {% elif task.started_at and not task.completed_at %}
                  <span class="text-warning">In progress...</span>
                  {% else %}
                  <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="btn-list flex-nowrap justify-content-end">
                    {% if status_str == 'COMPLETED' %}
                    <a href="{{ url_for('analysis.analysis_result_detail', result_id=task.task_id) }}" 
                       class="btn btn-sm btn-ghost-primary" title="View Results">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a href="{{ url_for('analysis.analysis_result_json', result_id=task.task_id) }}" 
                       class="btn btn-sm btn-ghost-info" title="View JSON" target="_blank">
                      <i class="fas fa-code"></i>
                    </a>
                    <a href="{{ url_for('analysis.export_task_sarif', task_id=task.task_id) }}" 
                       class="btn btn-sm btn-ghost-success" title="Download SARIF">
                      <i class="fas fa-download"></i>
                    </a>
                    {% elif status_str == 'FAILED' %}
                    <button class="btn btn-sm btn-ghost-warning" title="View Error" 
                            onclick="showTaskError('{{ task.task_id }}', '{{ task.error_message|default('Unknown error')|e }}')">
                      <i class="fas fa-exclamation-triangle"></i>
                    </button>
                    {% elif status_str == 'RUNNING' %}
                    <span class="text-muted small">Processing...</span>
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty py-5">
          <div class="empty-icon">
            <i class="fas fa-flask fa-3x text-muted"></i>
          </div>
          <p class="empty-title">No Analysis Tasks</p>
          <p class="empty-subtitle text-muted">
            No analysis has been run on this application yet.
          </p>
          <div class="empty-action">
            <a href="{{ url_for('analysis.analysis_create') }}?model={{ app_data.model_slug }}&app={{ app_data.app_number }}" 
               class="btn btn-primary">
              <i class="fas fa-plus me-1"></i>Create Analysis
            </a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Legacy Analyses (if any exist from old system) #}
  {% if analysis_entries and analysis_entries|length > 0 %}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-header">
        <div class="d-flex align-items-center">
          <i class="fas fa-history text-secondary me-2"></i>
          <h3 class="card-title mb-0">Legacy Analysis Records</h3>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          These are older analysis records stored in the legacy format. New analyses use the task-based system above.
        </div>
        <div class="list-group list-group-flush">
          {% for entry in analysis_entries[:10] %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-medium">{{ entry.analysis_label or entry.analysis_type or 'Analysis' }}</div>
              <div class="small text-muted">
                {{ entry.created_at.strftime('%Y-%m-%d %H:%M') if entry.created_at else '—' }}
                {% if entry.raw_type %}
                <span class="badge bg-secondary-lt ms-1">{{ entry.raw_type }}</span>
                {% endif %}
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% set entry_status = entry.status|default('unknown') %}
              <span class="badge {% if entry_status in ['completed', 'success'] %}bg-success-lt text-success{% elif entry_status == 'failed' %}bg-danger-lt text-danger{% else %}bg-secondary-lt{% endif %}">
                {{ entry_status|replace('_', ' ')|title }}
              </span>
              {% if entry.id %}
              <a href="{{ url_for('analysis.analysis_result_detail', result_id=entry.id) }}" 
                 class="btn btn-sm btn-ghost-primary">
                <i class="fas fa-eye"></i>
              </a>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% if analysis_entries|length > 10 %}
        <div class="text-center mt-2">
          <span class="text-muted small">Showing 10 of {{ analysis_entries|length }} legacy records</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
function showTaskError(taskId, errorMessage) {
  const modal = document.createElement('div');
  modal.className = 'modal fade';
  modal.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Task Error</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><strong>Task ID:</strong> <code>${taskId}</code></div>
          <div class="alert alert-danger mb-0">
            <pre class="mb-0 small" style="white-space: pre-wrap;">${errorMessage}</pre>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
  modal.addEventListener('hidden.bs.modal', () => {
    bsModal.dispose();
    modal.remove();
  });
}
</script>
