{# Analyses section - Compact Layout #}
<div class="row g-2">
  {# Summary - Inline #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-body py-2">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div class="d-flex align-items-center gap-3">
            <span class="text-muted small"><i class="fa-solid fa-flask text-info me-1"></i>Analysis Summary:</span>
            <span class="badge bg-primary-lt"><i class="fa-solid fa-list me-1"></i>{{ analysis_tasks|length|default(0) }} Total</span>
            {% set completed_count = 0 %}{% set running_count = 0 %}{% set failed_count = 0 %}
            {% if analysis_tasks %}{% for t in analysis_tasks %}
              {% if t.status and t.status.value == 'COMPLETED' %}{% set completed_count = completed_count + 1 %}
              {% elif t.status and t.status.value == 'RUNNING' %}{% set running_count = running_count + 1 %}
              {% elif t.status and t.status.value == 'FAILED' %}{% set failed_count = failed_count + 1 %}{% endif %}
            {% endfor %}{% endif %}
            <span class="badge bg-success-lt"><i class="fa-solid fa-check me-1"></i>{{ completed_count }} Done</span>
            {% if running_count > 0 %}<span class="badge bg-warning-lt"><i class="fa-solid fa-spinner fa-spin me-1"></i>{{ running_count }} Running</span>{% endif %}
            {% if failed_count > 0 %}<span class="badge bg-danger-lt"><i class="fa-solid fa-times me-1"></i>{{ failed_count }} Failed</span>{% endif %}
          </div>
          <a href="{{ url_for('analysis.analysis_create') }}?model={{ app_data.model_slug }}&app={{ app_data.app_number }}" 
             class="btn btn-primary btn-sm py-1">
            <i class="fa-solid fa-plus me-1"></i>New
          </a>
        </div>
      </div>
    </div>
  </div>

  {# Analysis Tasks Table - Compact #}
  <div class="col-12">
    <div class="card card-sm">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-tasks text-primary me-2"></i>
          <span class="fw-bold">Tasks</span>
        </div>
        <button class="btn btn-sm btn-ghost-secondary py-0" 
                hx-get="{{ url_for('applications.application_section_analyses', model_slug=app_data.model_slug, app_number=app_data.app_number) }}"
                hx-target="#section-analyses" hx-swap="innerHTML">
          <i class="fa-solid fa-sync"></i>
        </button>
      </div>
      <div class="card-body p-0">
        {% if analysis_tasks and analysis_tasks|length > 0 %}
        <div class="table-responsive">
          <table class="table table-vcenter table-hover card-table table-sm">
            <thead>
              <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Findings</th>
                <th>Time</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for task in analysis_tasks %}
              {% if task.is_main_task %}
              <tr>
                <td>
                  <a href="{{ url_for('analysis.analysis_result_detail', result_id=task.task_id) }}" class="text-decoration-none">
                    <code class="small">{{ task.task_id[:8] }}...</code>
                  </a>
                  <span class="badge bg-primary-lt ms-1">Main</span>
                  {% if task.task_name %}<div class="small text-muted">{{ task.task_name|truncate(25) }}</div>{% endif %}
                </td>
                <td>
                  {% set status_str = task.status.value if task.status else 'unknown' %}
                  {% set status_color = {'COMPLETED': 'success', 'RUNNING': 'warning', 'PENDING': 'secondary', 'FAILED': 'danger', 'CANCELLED': 'secondary'}.get(status_str, 'secondary') %}
                  <span class="badge bg-{{ status_color }}-lt text-{{ status_color }}">
                    {% if status_str == 'RUNNING' %}<span class="spinner-border spinner-border-sm me-1"></span>{% endif %}
                    {{ status_str[:4] }}
                  </span>
                </td>
                <td>
                  {% if task.issues_found is not none %}
                  <span class="{% if task.issues_found > 10 %}text-danger{% elif task.issues_found > 0 %}text-warning{% else %}text-success{% endif %} fw-medium">{{ task.issues_found }}</span>
                  {% else %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td class="text-muted small">
                  {% if task.actual_duration %}{{ '%.0f'|format(task.actual_duration) }}s
                  {% elif task.created_at %}{{ task.created_at.strftime('%m/%d') }}{% else %}—{% endif %}
                </td>
                <td class="text-end">
                  <div class="btn-list flex-nowrap justify-content-end gap-1">
                    {% if status_str == 'COMPLETED' %}
                    <a href="{{ url_for('analysis.analysis_result_detail', result_id=task.task_id) }}" class="btn btn-sm btn-ghost-primary py-0" title="View"><i class="fa-solid fa-eye"></i></a>
                    <a href="{{ url_for('analysis.export_task_sarif', task_id=task.task_id) }}" class="btn btn-sm btn-ghost-success py-0" title="SARIF"><i class="fa-solid fa-download"></i></a>
                    {% elif status_str == 'FAILED' %}
                    <button class="btn btn-sm btn-ghost-warning py-0" title="Error" onclick="showTaskError('{{ task.task_id }}', '{{ task.error_message|default('Error')|e }}')"><i class="fa-solid fa-exclamation-triangle"></i></button>
                    {% else %}<span class="text-muted">—</span>{% endif %}
                  </div>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fa-solid fa-flask text-muted fa-2x mb-2"></i>
          <p class="mb-2 text-muted">No analysis tasks yet</p>
          <a href="{{ url_for('analysis.analysis_create') }}?model={{ app_data.model_slug }}&app={{ app_data.app_number }}" class="btn btn-primary btn-sm">
            <i class="fa-solid fa-plus me-1"></i>Create Analysis
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function showTaskError(taskId, errorMessage) {
  const modal = document.createElement('div');
  modal.className = 'modal fade';
  modal.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title"><i class="fa-solid fa-exclamation-triangle text-danger me-2"></i>Task Error</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small"><strong>Task:</strong> <code>${taskId}</code></div>
          <div class="alert alert-danger mb-0 small"><pre class="mb-0" style="white-space: pre-wrap;">${errorMessage}</pre></div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
  modal.addEventListener('hidden.bs.modal', () => { bsModal.dispose(); modal.remove(); });
}
</script>
