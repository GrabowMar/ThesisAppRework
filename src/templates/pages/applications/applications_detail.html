{# Application Detail - Research Dashboard Design #}
{% extends 'layouts/base_smart.html' %}
{% from 'shared/macros/detail_macros.html' import research_detail_header, research_metric_grid, research_section_nav, research_section, research_scroll_spy_script %}
{% from 'shared/macros/nav_macros.html' import breadcrumb %}
{% set active_page = 'applications' %}
{% set page_title = view.title if view else 'Application Detail' %}

{% block content %}
<div class="research-detail-shell">
  {# Breadcrumb navigation #}
  {% if breadcrumb_items %}
  {{ breadcrumb(breadcrumb_items, 'mb-2') }}
  {% endif %}

  {# Warning banner for container build failures #}
  {% set container_status_lower = (app_data.container_status|default(''))|lower %}
  {% set is_container_unhealthy = app_data.is_container_unhealthy|default(false) %}
  {% if container_status_lower in ['error', 'failed', 'exited'] or is_container_unhealthy %}
  <div class="alert alert-warning py-2 mb-3" role="alert">
    <div class="d-flex align-items-center">
      <i class="fa-solid fa-exclamation-triangle text-orange me-2"></i>
      <div>
        <strong>Container Issue Detected</strong> â€” This application's containers may have failed to build, start, or are unhealthy. 
        Try rebuilding with <button class="btn btn-sm btn-warning ms-2" onclick="buildApplication()"><i class="fa-solid fa-hammer me-1"></i>Rebuild</button>
      </div>
    </div>
  </div>
  {% endif %}

  {# Compact header bar with inline metrics and all actions #}
  {% set container_metric = metrics|selectattr('label', 'equalto', 'Container')|first if metrics else None %}
  {% set status_badge = {
    'label': container_metric.value,
    'color': container_metric.status_color or 'secondary',
    'animated': container_metric.status_color == 'success'
  } if container_metric else None %}
  
  {{ research_detail_header(view, metrics[1:4] if metrics and metrics|length > 1 else [], status_badge) }}
  
  {# Dense metric grid (4-6 per row) #}
  {{ research_metric_grid(metrics) }}
  
  {# Sticky horizontal section navigation #}
  {{ research_section_nav(sections) }}
  
  {# Vertical section layout with lazy loading #}
  <div class="research-content">
    {% for section in sections %}
      <section id="section-{{ section.id }}" 
               class="research-section" 
               data-research-section="{{ section.id }}"
               hx-get="{{ section.hx }}"
               hx-trigger="{% if loop.first %}load{% else %}intersect once threshold:0.1{% endif %}"
               hx-swap="innerHTML"
               aria-labelledby="section-{{ section.id }}-title">
        
        <div class="research-section-header">
          <h2 class="research-section-title" id="section-{{ section.id }}-title">
            <i class="{{ section.icon }}" aria-hidden="true"></i>
            <span>{{ section.label }}</span>
          </h2>
        </div>
        
        {# Skeleton loader placeholder #}
        <div class="research-skeleton" aria-live="polite" aria-busy="true">
          <div class="research-skeleton-line h-lg"></div>
          <div class="research-skeleton-line w-75"></div>
          <div class="research-skeleton-line w-50"></div>
        </div>
      </section>
    {% endfor %}
  </div>
</div>

<div id="modal-container"></div>

{# Include container logs modal #}
{% include 'pages/applications/partials/modals/_container_logs_modal.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/container_manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/container_logs.js') }}"></script>
{{ research_scroll_spy_script() }}
<script>
// Toast notification helper
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container') || (() => {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1100';
    document.body.appendChild(container);
    return container;
  })();
  
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} alert-dismissible fade show`;
  toast.role = 'alert';
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function copyAdjacentPre(btn) {
  const pre = btn.closest('.card')?.querySelector('pre');
  if (!pre) {
    showToast('Nothing to copy', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(pre.innerText).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Copied';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-primary');
    setTimeout(() => {
      btn.innerHTML = orig;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 1200);
  }).catch(() => {
    showToast('Failed to copy to clipboard', 'danger');
  });
}

function startApplication() {
  showToast('Starting application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/start', {
    target: '#section-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application started successfully', 'success');
  }).catch(() => {
    showToast('Failed to start application', 'danger');
  });
}

function stopApplication() {
  showToast('Stopping application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/stop', {
    target: '#section-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application stopped successfully', 'success');
  }).catch(() => {
    showToast('Failed to stop application', 'danger');
  });
}

function restartApplication() {
  showToast('Restarting application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/restart', {
    target: '#section-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Application restarted successfully', 'success');
  }).catch(() => {
    showToast('Failed to restart application', 'danger');
  });
}

function buildApplication() {
  showToast('Building application...', 'info');
  htmx.ajax('POST', '/api/app/{{ app_data.model_slug }}/{{ app_data.app_number }}/build', {
    target: '#section-container',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Build completed successfully', 'success');
  }).catch(() => {
    showToast('Build failed', 'danger');
  });
}

function analyzeApplication(type) {
  showToast(`Starting ${type} analysis...`, 'info');
  htmx.ajax('POST', `/applications/{{ app_data.model_slug }}/{{ app_data.app_number }}/analyze/${type}`, {
    target: '#section-analyses',
    swap: 'innerHTML'
  }).then(() => {
    showToast('Analysis started', 'success');
  }).catch(() => {
    showToast('Failed to start analysis', 'danger');
  });
}

// Handle section loading states
document.addEventListener('htmx:beforeRequest', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.add('is-loading');
  }
});

document.addEventListener('htmx:afterSwap', evt => {
  const section = evt.detail.elt;
  if (section && section.matches('[data-research-section]')) {
    section.classList.remove('is-loading');
  }
});

// Listen for HTMX events
document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.successful) {
    console.log('HTMX request successful:', evt.detail.pathInfo.requestPath);
  } else {
    console.error('HTMX request failed:', evt.detail.pathInfo.requestPath);
  }
});

document.addEventListener('htmx:responseError', evt => {
  const section = evt.detail.elt;
  if (!section || !section.matches('[data-research-section]')) {
    showToast('A server error occurred. Please try again.', 'danger');
    return;
  }
  const sectionId = section.getAttribute('data-research-section');
  const sectionTitle = section.querySelector('.research-section-title span')?.textContent || 'Section';
  section.innerHTML = `
    <div class="research-section-header">
      <h2 class="research-section-title">
        <i class="fa-solid fa-exclamation-triangle text-warning" aria-hidden="true"></i>
        <span>Failed to load ${sectionTitle}</span>
      </h2>
    </div>
    <div class="research-empty-state">
      <div class="research-empty-icon">
        <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>
      </div>
      <div class="research-empty-title">Content could not be loaded</div>
      <div class="research-empty-message">There was an error loading this section. Please try again.</div>
      <div class="research-empty-action">
        <button class="btn btn-primary" onclick="htmx.ajax('GET', '${section.getAttribute('hx-get')}', { target: '[data-research-section=\\'${sectionId}\\']', swap: 'innerHTML' })">
          <i class="fa-solid fa-refresh me-1"></i>Retry
        </button>
      </div>
    </div>
  `;
  section.classList.remove('is-loading');
});
</script>
{% endblock %}

