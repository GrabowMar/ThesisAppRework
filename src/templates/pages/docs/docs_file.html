{% extends "layouts/base_smart.html" %}
{% set active_page = 'docs' %}
{% set page_title = title %}
{% set page_icon = 'fa-solid fa-file-lines' %}

{% block title %}{{ title }} - Documentation{% endblock %}

{% block content %}
<div class="page-body mt-0">
    <div class="container-fluid">
        <!-- Compact Header Bar -->
        <div class="card card-sm mb-3 bg-primary text-white">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <a href="{{ url_for('docs.docs_index') }}" class="btn btn-ghost-light btn-sm">
                            <i class="fa-solid fa-arrow-left me-1"></i>
                            Docs
                        </a>
                    </div>
                    <div class="col">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb breadcrumb-dots mb-0" style="--tblr-breadcrumb-divider-color: rgba(255,255,255,0.5);">
                                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}" class="text-white-50">Home</a></li>
                                <li class="breadcrumb-item"><a href="{{ url_for('docs.docs_index') }}" class="text-white-50">Documentation</a></li>
                                <li class="breadcrumb-item text-white active" aria-current="page">{{ title }}</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small me-2">
                            <i class="fa-solid fa-file-code me-1"></i>
                            {{ filepath }}
                        </span>
                        <button class="btn btn-ghost-light btn-sm btn-icon" onclick="window.print()" title="Print">
                            <i class="fa-solid fa-print"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="sticky-top" role="complementary" aria-label="Table of contents">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fa-solid fa-list me-2 text-muted"></i>
                                Contents
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <div id="table-of-contents-nav" class="docs-toc">
                                <div class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    Loading…
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-body docs-content-wrapper">
                        <!-- Document Title -->
                        <div class="docs-header mb-4 pb-3 border-bottom">
                            <h1 class="docs-title mb-2">{{ title }}</h1>
                            <div class="docs-meta text-muted small">
                                <span class="me-3"><i class="fa-solid fa-folder me-1"></i>Documentation</span>
                                <span><i class="fa-solid fa-file-lines me-1"></i>{{ filepath }}</span>
                            </div>
                        </div>
                        
                        <div class="docs-content" id="markdown-content" role="main">
                            {{ content|safe }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_styles %}
<!-- Mermaid.js for diagram rendering -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
    /* ===== Pygments Monokai Theme ===== */
    .codehilite .hll { background-color: #49483e }
    .codehilite { background: #272822; color: #F8F8F2 }
    .codehilite .c, .codehilite .ch, .codehilite .cm, .codehilite .cp,
    .codehilite .cpf, .codehilite .c1, .codehilite .cs { color: #959077 }
    .codehilite .gd { color: #FF4689 }
    .codehilite .gi { color: #A6E22E }
    .codehilite .go { color: #66D9EF }
    .codehilite .gp { color: #FF4689; font-weight: bold }
    .codehilite .gs { font-weight: bold }
    .codehilite .ge { font-style: italic }
    .codehilite .gu { color: #959077 }
    .codehilite .k, .codehilite .kc, .codehilite .kd, .codehilite .kp,
    .codehilite .kr, .codehilite .kt { color: #66D9EF }
    .codehilite .kn { color: #FF4689 }
    .codehilite .l, .codehilite .m, .codehilite .mb, .codehilite .mf,
    .codehilite .mh, .codehilite .mi, .codehilite .mo, .codehilite .il { color: #AE81FF }
    .codehilite .s, .codehilite .sa, .codehilite .sb, .codehilite .sc,
    .codehilite .dl, .codehilite .sd, .codehilite .s2, .codehilite .sh,
    .codehilite .si, .codehilite .sx, .codehilite .sr, .codehilite .s1,
    .codehilite .ss, .codehilite .ld { color: #E6DB74 }
    .codehilite .se { color: #AE81FF }
    .codehilite .na { color: #A6E22E }
    .codehilite .nc, .codehilite .nd, .codehilite .ne, .codehilite .nf,
    .codehilite .nx, .codehilite .fm { color: #A6E22E }
    .codehilite .no { color: #66D9EF }
    .codehilite .nt { color: #FF4689 }
    .codehilite .o { color: #FF4689 }
    .codehilite .ow { color: #FF4689 }
    .codehilite .err { color: #F8F8F2; background-color: transparent }
    .codehilite .w, .codehilite .n, .codehilite .p, .codehilite .nb,
    .codehilite .bp, .codehilite .nl, .codehilite .nn, .codehilite .py,
    .codehilite .nv, .codehilite .vc, .codehilite .vg, .codehilite .vi,
    .codehilite .vm, .codehilite .x, .codehilite .esc, .codehilite .g,
    .codehilite .gr, .codehilite .gh, .codehilite .gt, .codehilite .pm,
    .codehilite .ge, .codehilite .ges, .codehilite .ni { color: #F8F8F2 }

    /* ===== Table of Contents ===== */
    .docs-toc {
        max-height: calc(100vh - 220px);
        overflow-y: auto;
        font-size: 0.8125rem;
    }
    .toc-link {
        display: block;
        padding: 0.3rem 1rem;
        color: var(--tblr-secondary);
        text-decoration: none;
        border-left: 2px solid transparent;
        transition: all 0.15s ease;
    }
    .toc-link:hover {
        color: var(--tblr-primary);
        background-color: rgba(32, 107, 196, 0.04);
        text-decoration: none;
    }
    .toc-link.active {
        color: var(--tblr-primary);
        border-left-color: var(--tblr-primary);
        background-color: rgba(32, 107, 196, 0.08);
        font-weight: 600;
    }
    .toc-link.level-1 { padding-left: 1rem; font-weight: 600; color: var(--tblr-body-color); }
    .toc-link.level-2 { padding-left: 1.5rem; }
    .toc-link.level-3 { padding-left: 2rem; font-size: 0.75rem; }
    .toc-link.level-4 { padding-left: 2.5rem; font-size: 0.75rem; }

    /* ===== Document Header ===== */
    .docs-header { border-bottom: 2px solid var(--tblr-primary) !important; }
    .docs-title { font-size: 1.75rem; font-weight: 700; margin: 0; }
    .docs-content-wrapper { padding: 1.75rem 2rem; }

    /* ===== Markdown Content ===== */
    .docs-content {
        font-size: 0.9375rem;
        line-height: 1.75;
        color: var(--tblr-body-color);
        max-width: 100%;
    }
    .docs-content h1 {
        font-size: 1.6rem; font-weight: 700;
        margin: 2.5rem 0 0.75rem 0;
        padding-bottom: 0.4rem;
        border-bottom: 2px solid var(--tblr-primary);
    }
    .docs-content h1:first-child { display: none; }
    .docs-content h2 {
        font-size: 1.35rem; font-weight: 600;
        margin: 2rem 0 0.75rem 0;
        padding-bottom: 0.3rem;
        border-bottom: 1px solid var(--tblr-border-color);
    }
    .docs-content h3 {
        font-size: 1.15rem; font-weight: 600;
        margin: 1.5rem 0 0.5rem 0;
    }
    .docs-content h4 {
        font-size: 1rem; font-weight: 600;
        margin: 1.25rem 0 0.4rem 0;
        color: var(--tblr-secondary);
    }
    .docs-content p { margin-bottom: 0.875rem; }
    .docs-content a {
        color: var(--tblr-primary);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.15s ease;
    }
    .docs-content a:hover { border-bottom-color: var(--tblr-primary); }

    /* ===== Summary Blockquote (first blockquote = doc summary) ===== */
    .docs-content > blockquote:first-of-type {
        margin: 0 0 1.5rem 0;
        padding: 0.875rem 1.25rem;
        background: linear-gradient(135deg, rgba(32, 107, 196, 0.06) 0%, rgba(32, 107, 196, 0.02) 100%);
        border-left: 4px solid var(--tblr-primary);
        border-radius: 0 8px 8px 0;
        font-size: 0.875rem;
        line-height: 1.6;
    }
    .docs-content > blockquote:first-of-type strong {
        color: var(--tblr-primary);
    }
    .docs-content > blockquote:first-of-type code {
        font-size: 0.8em;
        background-color: rgba(32, 107, 196, 0.1);
        color: var(--tblr-body-color);
    }

    /* ===== Regular Blockquotes ===== */
    .docs-content blockquote {
        margin: 1rem 0;
        padding: 0.75rem 1rem;
        background-color: var(--tblr-bg-surface-secondary, rgba(0,0,0,0.02));
        border-left: 3px solid var(--tblr-border-color);
        border-radius: 0 6px 6px 0;
        color: var(--tblr-secondary);
    }
    .docs-content blockquote p:last-child { margin-bottom: 0; }

    /* ===== Inline Code ===== */
    .docs-content code {
        font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
        font-size: 0.8em;
        background-color: var(--tblr-bg-surface-secondary, #f1f5f9);
        color: var(--tblr-code-color, #d63384);
        padding: 0.15em 0.4em;
        border-radius: 4px;
        font-weight: 500;
        word-break: break-word;
    }

    /* ===== Code Blocks (Pygments) ===== */
    .docs-content .codehilite,
    .docs-content pre {
        background-color: #272822;
        border: 1px solid #3e3d32;
        border-radius: 8px;
        padding: 1rem 1.25rem;
        margin: 1rem 0;
        overflow-x: auto;
        position: relative;
        font-size: 0.8125rem;
        line-height: 1.65;
    }
    .docs-content .codehilite pre {
        background: transparent;
        border: none;
        padding: 0;
        margin: 0;
        overflow: visible;
    }
    .docs-content .codehilite code,
    .docs-content pre code {
        background-color: transparent;
        color: #F8F8F2;
        padding: 0;
        font-size: inherit;
        line-height: inherit;
        border-radius: 0;
        word-break: normal;
    }
    /* Accent bar on code blocks */
    .docs-content .codehilite::before,
    .docs-content pre:not(.codehilite pre)::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #3b82f6, #8b5cf6);
        border-radius: 8px 0 0 8px;
    }

    /* ===== Tables ===== */
    .docs-content table {
        width: 100%;
        margin: 1rem 0;
        border-collapse: collapse;
        font-size: 0.85rem;
        border: 1px solid var(--tblr-border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    .docs-content th {
        background-color: var(--tblr-bg-surface-secondary);
        font-weight: 600;
        text-align: left;
        padding: 0.6rem 0.875rem;
        border-bottom: 2px solid var(--tblr-border-color);
    }
    .docs-content td {
        padding: 0.5rem 0.875rem;
        border-bottom: 1px solid var(--tblr-border-color);
        vertical-align: top;
    }
    .docs-content tr:last-child td { border-bottom: none; }
    .docs-content tr:hover td { background-color: rgba(32, 107, 196, 0.03); }

    /* ===== Lists ===== */
    .docs-content ul, .docs-content ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
    }
    .docs-content li { margin-bottom: 0.3rem; }
    .docs-content li > ul, .docs-content li > ol { margin: 0.25rem 0; }

    /* ===== Misc ===== */
    .docs-content hr {
        margin: 1.75rem 0;
        border: none;
        border-top: 1px solid var(--tblr-border-color);
    }
    .docs-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1rem 0;
        border: 1px solid var(--tblr-border-color);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }
    .docs-content strong { font-weight: 600; }

    /* ===== Mermaid Diagrams ===== */
    .mermaid-container { position: relative; margin: 1.25rem 0; }
    .docs-content .mermaid {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid var(--tblr-border-color);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        overflow-x: auto;
    }
    [data-bs-theme="dark"] .docs-content .mermaid {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    .docs-content .mermaid svg { max-width: 100%; height: auto; }
    .docs-content pre.mermaid-source,
    .docs-content div.mermaid-source { display: none !important; }
    .mermaid-container::before {
        content: 'Diagram';
        position: absolute;
        top: -0.5rem; left: 1rem;
        background: var(--tblr-card-bg, #fff);
        padding: 0 0.5rem;
        font-size: 0.625rem; font-weight: 700;
        color: var(--tblr-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        z-index: 1;
    }

    /* ===== Copy Button ===== */
    .code-copy-btn {
        position: absolute;
        top: 0.4rem; right: 0.4rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #94a3b8;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.15s ease;
    }
    .docs-content .codehilite:hover .code-copy-btn,
    .docs-content pre:hover .code-copy-btn { opacity: 1; }
    .code-copy-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
    }

    /* ===== Layout ===== */
    .sticky-top { top: 1rem; z-index: 100; }

    @media print {
        .docs-toc, .btn, nav { display: none !important; }
        .docs-content pre { white-space: pre-wrap; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
// Initialize Mermaid with theme detection
function initMermaid() {
    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' ||
                       window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    mermaid.initialize({
        startOnLoad: false,
        theme: isDarkMode ? 'dark' : 'default',
        securityLevel: 'loose',
        flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis'
        },
        sequence: {
            useMaxWidth: true,
            diagramMarginX: 20,
            diagramMarginY: 20
        },
        er: {
            useMaxWidth: true
        },
        themeVariables: isDarkMode ? {
            primaryColor: '#206bc4',
            primaryTextColor: '#fff',
            primaryBorderColor: '#206bc4',
            lineColor: '#a0aec0',
            secondaryColor: '#2d3748',
            tertiaryColor: '#1a1f2e'
        } : {}
    });

    // Find all code blocks — handles both <pre><code> and <div.codehilite><pre>
    const preBlocks = document.querySelectorAll('.docs-content pre');
    let mermaidCount = 0;

    preBlocks.forEach((pre) => {
        const text = pre.textContent.trim();
        const mermaidKeywords = ['flowchart', 'graph', 'sequenceDiagram', 'classDiagram',
            'stateDiagram', 'erDiagram', 'gantt', 'pie', 'gitGraph'];
        if (!mermaidKeywords.some(kw => text.startsWith(kw))) return;

        // Hide the source — could be <pre> or parent <div.codehilite>
        const hideEl = pre.closest('.codehilite') || pre;
        hideEl.classList.add('mermaid-source');
        hideEl.style.display = 'none';

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.id = 'mermaid-' + mermaidCount++;
        mermaidDiv.textContent = text;
        container.appendChild(mermaidDiv);
        hideEl.insertAdjacentElement('afterend', container);
    });

    // Run mermaid on all .mermaid divs
    if (mermaidCount > 0) {
        mermaid.run().catch(err => {
            console.warn('Mermaid rendering error:', err);
            // Show source code as fallback for failed diagrams
            document.querySelectorAll('.mermaid-source').forEach(el => {
                el.style.display = '';
                el.classList.remove('mermaid-source');
            });
            document.querySelectorAll('.mermaid-container').forEach(el => el.remove());
        });
    }
}

function initializeDocsPage() {
    initMermaid();
    generateTableOfContents();
    setupScrollSpy();
    setupKeyboardNavigation();
    enhanceExternalLinks();
    setupCodeBlockCopy();
    setupImageLightbox();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDocsPage);
} else {
    initializeDocsPage();
}

function generateTableOfContents() {
    const content = document.getElementById('markdown-content');
    const tocContainer = document.getElementById('table-of-contents-nav');

    if (!content || !tocContainer) return;

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');

    if (headings.length === 0) {
        // Hide ToC card if no headings
        const tocCard = tocContainer.closest('.card');
        if (tocCard) tocCard.style.display = 'none';
        return;
    }

    // Clear existing content
    tocContainer.innerHTML = '';

    headings.forEach((heading, index) => {
        // Create an ID if none exists
        if (!heading.id) {
            heading.id = 'heading-' + index;
        }

        const level = parseInt(heading.tagName.charAt(1));
        const text = heading.textContent.trim();
        const displayText = text.length > 50 ? text.substring(0, 47) + '...' : text;

        const tocItem = document.createElement('a');
        tocItem.className = `toc-link level-${level}`;
        tocItem.href = '#' + heading.id;
        tocItem.textContent = displayText;
        tocItem.setAttribute('title', text);
        tocItem.setAttribute('data-heading-id', heading.id);

        tocItem.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.getElementById(heading.id);
            if (target) {
                const headerHeight = 150;
                const targetPosition = target.offsetTop - headerHeight;

                window.scrollTo({
                    top: Math.max(0, targetPosition),
                    behavior: 'smooth'
                });

                history.replaceState(null, null, '#' + heading.id);
                updateActiveTocItem(tocItem);
            }
        });

        tocContainer.appendChild(tocItem);
    });
}

function setupScrollSpy() {
    const tocLinks = document.querySelectorAll('.toc-link');
    if (tocLinks.length === 0) return;

    let ticking = false;

    function handleScroll() {
        if (!ticking) {
            requestAnimationFrame(() => {
                const scrollY = window.scrollY + 160;
                let activeHeading = null;

                tocLinks.forEach(link => {
                    const targetId = link.getAttribute('data-heading-id');
                    const target = document.getElementById(targetId);

                    if (target && target.offsetTop <= scrollY) {
                        activeHeading = link;
                    }
                });

                updateActiveTocItem(activeHeading);
                ticking = false;
            });
            ticking = true;
        }
    }

    window.addEventListener('scroll', handleScroll);
    handleScroll();
}

function updateActiveTocItem(activeItem) {
    const tocLinks = document.querySelectorAll('.toc-link');
    tocLinks.forEach(link => link.classList.remove('active'));
    if (activeItem) {
        activeItem.classList.add('active');

        // Scroll active item into view in sidebar
        const tocContainer = document.querySelector('.docs-toc');
        if (tocContainer && activeItem) {
            const linkRect = activeItem.getBoundingClientRect();
            const containerRect = tocContainer.getBoundingClientRect();

            if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
                const scrollTop = tocContainer.scrollTop + (linkRect.top - containerRect.top) - (containerRect.height / 2) + (linkRect.height / 2);
                tocContainer.scrollTo({
                    top: Math.max(0, scrollTop),
                    behavior: 'smooth'
                });
            }
        }
    }
}

function setupKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        // Alt + Left Arrow: Back to docs
        if (e.altKey && e.key === 'ArrowLeft') {
            e.preventDefault();
            window.location.href = '{{ url_for("docs.docs_index") }}';
        }

        // Alt + Home: Go to dashboard
        if (e.altKey && e.key === 'Home') {
            e.preventDefault();
            window.location.href = '{{ url_for("main.dashboard") }}';
        }

        // Ctrl + P: Print
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
    });
}

function enhanceExternalLinks() {
    const contentLinks = document.querySelectorAll('.docs-content a[href^="http"]');
    contentLinks.forEach(link => {
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');

        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-arrow-up-right-from-square ms-1';
        icon.style.fontSize = '0.75em';
        icon.style.opacity = '0.7';
        link.appendChild(icon);
    });
}

function setupCodeBlockCopy() {
    // Add copy button to both codehilite divs and standalone pre blocks
    const codeBlocks = document.querySelectorAll('.docs-content .codehilite, .docs-content pre:not(.codehilite pre):not(.mermaid-source)');

    codeBlocks.forEach(block => {
        if (block.classList.contains('mermaid-source')) return;
        if (block.querySelector('.code-copy-btn')) return;

        const copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.innerHTML = '<i class="fa-solid fa-copy me-1"></i>Copy';
        copyBtn.setAttribute('title', 'Copy to clipboard');

        copyBtn.addEventListener('click', function() {
            const text = (block.querySelector('pre') || block).textContent.trim();
            navigator.clipboard.writeText(text).then(() => {
                copyBtn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Copied!';
                copyBtn.style.color = '#4ade80';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fa-solid fa-copy me-1"></i>Copy';
                    copyBtn.style.color = '';
                }, 2000);
            }).catch(() => {
                copyBtn.innerHTML = '<i class="fa-solid fa-xmark me-1"></i>Failed';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fa-solid fa-copy me-1"></i>Copy';
                }, 2000);
            });
        });

        block.style.position = 'relative';
        block.appendChild(copyBtn);
    });
}

function setupImageLightbox() {
    const images = document.querySelectorAll('.docs-content img');

    images.forEach(img => {
        img.style.cursor = 'pointer';
        img.setAttribute('role', 'button');
        img.setAttribute('tabindex', '0');
        img.setAttribute('aria-label', 'Click to enlarge image');

        const openLightbox = function() {
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
            `;
            lightbox.setAttribute('role', 'dialog');
            lightbox.setAttribute('aria-label', 'Image lightbox');

            const lightboxImg = img.cloneNode();
            lightboxImg.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: var(--tblr-border-radius);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            `;

            lightbox.appendChild(lightboxImg);

            const closeLightbox = function() {
                document.body.removeChild(lightbox);
            };

            lightbox.addEventListener('click', closeLightbox);
            document.addEventListener('keydown', function handler(e) {
                if (e.key === 'Escape') {
                    closeLightbox();
                    document.removeEventListener('keydown', handler);
                }
            });

            document.body.appendChild(lightbox);
        };

        img.addEventListener('click', openLightbox);
        img.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openLightbox();
            }
        });
    });
}
</script>
{% endblock %}