{# Unified Base Layout: self-contained (no longer extends main.html) #}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>{% block title %}Thesis Platform{% endblock %}</title>
  <script>
  (function(){
    try {
      var stored = localStorage.getItem('app_theme');
      var prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      var t = stored || (prefers ? 'dark':'light');
      document.documentElement.setAttribute('data-bs-theme', t);
      document.documentElement.setAttribute('data-theme', t);
      if(localStorage.getItem('sidebarPref')==='collapsed'){
        document.documentElement.classList.add('sidebar-init');
        document.body && document.body.classList.add('sidebar-collapsed');
      }
    } catch(_){}
  })();
  </script>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://rsms.me">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@2.47.0/iconfont/tabler-icons.min.css">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/detail-pages.css') }}">
  {% block head_styles %}{% endblock %}
</head>
<body id="app-body">
  <div class="page">
    {% include 'shared/ui/_sidebar.html' %}
    <div class="sidebar-backdrop d-lg-none" id="sidebar-backdrop" aria-hidden="true"></div>
    {% include 'shared/ui/_header.html' %}
    {% set has_right_sidebar = has_right_sidebar|default(false) %}
    <div class="page-wrapper{% if has_right_sidebar %} has-right-sidebar{% endif %}{% if active_page %} page-{{ active_page }}{% endif %}">
      <div class="page-body py-3">
        <div class="container-xl page-body-container">
          <div id="global-spinner" class="htmx-indicator text-center mb-3" aria-live="polite">
            <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
            <span class="small text-muted">Loadingâ€¦</span>
          </div>
          <div id="main-content" class="row gx-4 gy-4 align-items-start">
            <div class="col-12{% if has_right_sidebar %} col-lg-9 col-xl-9{% endif %}">
              {% block main %}{% block content %}{% endblock %}{% endblock %}
            </div>
            {% if has_right_sidebar %}
            <div class="col-12 col-lg-3 col-xl-3">
              {% block right_sidebar %}{% endblock %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'shared/ui/_footer.html' %}

  <!-- Modals / global components -->
  <div class="modal modal-blur fade" id="search-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Search</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><input type="text" class="form-control" placeholder="Search..." autofocus></div></div></div>
  </div>

  <!-- Dynamic modal region for HTMX content -->
  <div id="modal-region"></div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/js/tabler.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
  <script>
  // HTMX Global Configuration for proper boost navigation
  document.body.addEventListener('htmx:configRequest', function(evt) {
    // Add header to identify HTMX requests for partial rendering
    evt.detail.headers['X-HTMX-Request'] = 'true';
  });
  
  // Configure boosted links to target main content area
  htmx.config.defaultSwapStyle = 'innerHTML';
  htmx.config.globalViewTransitions = true;
  htmx.config.historyCacheSize = 10;
  
  // Override boost behavior to target #main-content
  document.body.addEventListener('htmx:beforeRequest', function(evt) {
    var elt = evt.detail.elt;
    // Check if this is a boosted navigation link (has hx-boost but no explicit hx-target)
    if (elt.hasAttribute('hx-boost') && !elt.hasAttribute('hx-target')) {
      var mainContent = document.getElementById('main-content');
      if (mainContent) {
        // Set target to main-content for boosted nav links
        evt.detail.target = mainContent;
      }
    }
  });
  
  // Page reinitialization event - fires after HTMX navigation completes
  document.body.addEventListener('htmx:afterSettle', function(evt) {
    // Only fire for main content swaps (navigation) not small HTMX updates
    var target = evt.detail.target;
    if (target && (target.id === 'main-content' || target.closest('#main-content'))) {
      // Update page title and active nav from partial response metadata
      var meta = target.querySelector('#page-meta');
      if (meta) {
        var newTitle = meta.getAttribute('data-title');
        if (newTitle) document.title = newTitle;
        
        var activePage = meta.getAttribute('data-active-page');
        if (activePage) {
          document.querySelectorAll('[data-nav-target]').forEach(function(el) {
            var isActive = el.getAttribute('data-nav-target') === activePage;
            el.classList.toggle('active', isActive);
            el.classList.toggle('bg-primary', isActive);
            el.classList.toggle('text-white', isActive);
            el.classList.toggle('shadow-sm', isActive);
            el.classList.toggle('hover-bg-white-10', !isActive);
            if (isActive) {
              el.setAttribute('aria-current', 'page');
            } else {
              el.removeAttribute('aria-current');
            }
          });
        }
        meta.remove(); // Clean up the template element
      }
      
      // Dispatch custom event for page-specific scripts to listen to
      document.dispatchEvent(new CustomEvent('thesis:pageInit', {
        detail: { target: target, htmxEvent: evt }
      }));
      
      // Re-run any inline scripts in the new content (for page-specific init)
      var scripts = target.querySelectorAll('script[data-reinit]');
      scripts.forEach(function(script) {
        var newScript = document.createElement('script');
        if (script.src) {
          newScript.src = script.src;
        } else {
          newScript.textContent = script.textContent;
        }
        script.parentNode.replaceChild(newScript, script);
      });
    }
  });
  
  // Handle browser back/forward buttons
  document.body.addEventListener('htmx:historyRestore', function(evt) {
    document.dispatchEvent(new CustomEvent('thesis:pageInit', {
      detail: { target: document.getElementById('main-content'), historyRestore: true }
    }));
  });
  </script>
  <script src="{{ url_for('static', filename='js/table-utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script>
  // Highlight active nav via data-nav-target matching active_page, fallback to path heuristic
  (function(){
    try {
  var active = '{{ active_page|default("") }}';
      if(!active){
        var p = window.location.pathname;
        if(p.startsWith('/applications')) active='applications';
        else if(p.startsWith('/models')) active='models';
        else if(p.startsWith('/analysis')) active='analysis';
        else if(p.startsWith('/reports')) active='reports';
        else if(p.startsWith('/statistics')) active='statistics';
        else active='dashboard';
      }
      document.querySelectorAll('[data-nav-target]')
        .forEach(el=> el.classList.toggle('active', el.getAttribute('data-nav-target')===active));
    } catch(_) {}
  })();

  // Global HTMX error handler - show user-friendly notifications
  document.body.addEventListener('htmx:responseError', function(evt) {
    var detail = evt.detail;
    var xhr = detail.xhr;
    var status = xhr.status;
    var message = 'Operation failed';
    
    // Try to parse error response
    try {
      var json = JSON.parse(xhr.responseText);
      message = json.message || json.error || message;
    } catch(e) {
      // Fallback to status-based messages
      if (status === 400) message = 'Invalid request';
      else if (status === 404) message = 'Resource not found';
      else if (status === 500) message = 'Server error - please try again';
    }
    
    showToast(message, 'error');
    console.error('HTMX Error:', status, message, evt);
  });

  // Toast notification system
  function showToast(message, type) {
    if (!message) return;
    type = type || 'info';
    var bgClass = type === 'error' ? 'bg-danger' : type === 'success' ? 'bg-success' : 'bg-info';
    var icon = type === 'error' ? 'fa-circle-exclamation' : type === 'success' ? 'fa-circle-check' : 'fa-circle-info';
    
    var container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'position-fixed top-0 end-0 p-3';
      container.style.zIndex = '9999';
      container.setAttribute('aria-live', 'polite');
      container.setAttribute('aria-atomic', 'true');
      document.body.appendChild(container);
    }
    
    var toast = document.createElement('div');
    toast.className = 'alert ' + bgClass + ' text-white d-flex align-items-center mb-2';
    toast.style.cssText = 'box-shadow:0 4px 12px rgba(0,0,0,0.15);animation:slideIn 0.3s ease;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = '<i class="fas ' + icon + ' me-2" aria-hidden="true"></i><span>' + message + '</span>';
    
    container.appendChild(toast);
    
    setTimeout(function() {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(function() { toast.remove(); }, 300);
    }, 4000);
  }

  // Simple CSS animations for toasts
  if (!document.getElementById('toast-styles')) {
    var style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = '@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }';
    document.head.appendChild(style);
  }

  // Expose globally for manual use
  window.showToast = showToast;
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>