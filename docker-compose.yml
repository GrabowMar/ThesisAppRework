# Docker Compose for ThesisApp Complete Stack
# Includes Flask app and analyzer services

services:
  # Flask web application
  web:
    build:
      context: .
      dockerfile: Dockerfile
    # Grant access to Docker socket (socket is owned by root:root on most hosts)
    group_add:
      - "0" # root group for Docker socket access
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - HOST=0.0.0.0
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/src/data/thesis_app.db}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENROUTER_ALLOW_ALL_PROVIDERS=${OPENROUTER_ALLOW_ALL_PROVIDERS:-true}
      - PYTHONUNBUFFERED=1
      # Docker environment flag for inter-container communication
      - IN_DOCKER=true
      # Load balancing configuration
      - STATIC_ANALYZER_URLS=ws://static-analyzer:2001,ws://static-analyzer-2:2001,ws://static-analyzer-3:2001
      - DYNAMIC_ANALYZER_URLS=ws://dynamic-analyzer:2002,ws://dynamic-analyzer-2:2002
      - PERF_TESTER_URLS=ws://performance-tester:2003,ws://performance-tester-2:2003
      - AI_ANALYZER_URLS=ws://ai-analyzer:2004,ws://ai-analyzer-2:2004
      # Celery configuration for Docker environment
      - USE_CELERY_ANALYSIS=true
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # Disable pipeline service in web container - celery-worker handles pipelines
      # This prevents race conditions from two processes polling the same pipeline
      - ENABLE_PIPELINE_SERVICE=false
      # Authentication & Security
      - REGISTRATION_ENABLED=${REGISTRATION_ENABLED:-false}
      - SESSION_COOKIE_SECURE=${SESSION_COOKIE_SECURE:-false}
      - SESSION_LIFETIME=${SESSION_LIFETIME:-86400}
    volumes:
      - ./generated/apps:/app/generated/apps
      - ./generated/raw:/app/generated/raw
      - ./generated/metadata:/app/generated/metadata
      - ./results:/app/results
      - ./logs:/app/logs
      - ./src/data:/app/src/data
      # Docker socket for managing generated app containers (rw required for container operations)
      - /var/run/docker.sock:/var/run/docker.sock:rw
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Redis for Celery
  redis:
    image: redis:7.2-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - thesis-network

  # Celery Worker
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    # Grant access to Docker socket (socket is owned by root:root on most hosts)
    group_add:
      - "0" # root group for Docker socket access
    command: >
      bash -c "
        echo 'Waiting for database initialization...';
        for i in {1..30}; do
          if [ -f /app/src/data/thesis_app.db ]; then
            echo 'Database found, starting Celery worker...';
            break;
          fi;
          echo 'Waiting for DB file... ($$i/30)';
          sleep 2;
        done;
        exec celery -A app.celery_worker.celery worker --loglevel=info
      "
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/src/data/thesis_app.db}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - PYTHONUNBUFFERED=1
      # Docker environment flag for inter-container communication
      - IN_DOCKER=true
      # Load balancing configuration
      - STATIC_ANALYZER_URLS=ws://static-analyzer:2001,ws://static-analyzer-2:2001,ws://static-analyzer-3:2001
      - DYNAMIC_ANALYZER_URLS=ws://dynamic-analyzer:2002,ws://dynamic-analyzer-2:2002
      - PERF_TESTER_URLS=ws://performance-tester:2003,ws://performance-tester-2:2003
      - AI_ANALYZER_URLS=ws://ai-analyzer:2004,ws://ai-analyzer-2:2004
      # Enable pipeline service in celery-worker - this is the ONLY container that should process pipelines
      - ENABLE_PIPELINE_SERVICE=true
    volumes:
      - ./generated/apps:/app/generated/apps
      - ./generated/raw:/app/generated/raw
      - ./generated/metadata:/app/generated/metadata
      - ./results:/app/results
      - ./logs:/app/logs
      - ./src/data:/app/src/data
      # Docker socket for celery worker (rw required for analysis tasks)
      - /var/run/docker.sock:/var/run/docker.sock:rw
    depends_on:
      redis:
        condition: service_healthy
      web:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "celery -A app.celery_worker.celery inspect ping --timeout 10 | grep -q 'pong'" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  # Analyzer services (WebSocket Gateway)
  analyzer-gateway:
    build:
      context: .
      dockerfile: analyzer/Dockerfile
    ports:
      - "8765:8765"
    environment:
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8765
      - LOG_LEVEL=INFO
      - STATIC_ANALYZER_URL=ws://static-analyzer:2001
      - DYNAMIC_ANALYZER_URL=ws://dynamic-analyzer:2002
      - PERF_TESTER_URL=ws://performance-tester:2003
      - AI_ANALYZER_URL=ws://ai-analyzer:2004
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    depends_on:
      - static-analyzer
      - dynamic-analyzer
      - performance-tester
      - ai-analyzer
    healthcheck:
      test: [ "CMD", "python", "-c", "import asyncio, websockets; asyncio.run(websockets.connect('ws://localhost:8765').__aenter__())" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.2'

  # Static Security & Quality Analyzer
  static-analyzer:
    build:
      context: .
      dockerfile: analyzer/services/static-analyzer/Dockerfile
    ports:
      - "2001:2001"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2001
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    volumes:
      - ./generated/apps:/app/sources:ro
      - ./results:/app/results
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # Dynamic Security Analyzer
  dynamic-analyzer:
    build:
      context: .
      dockerfile: analyzer/services/dynamic-analyzer/Dockerfile
    ports:
      - "2002:2002"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2002
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./results:/app/results
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - thesis-network
      - thesis-apps-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # Performance Tester
  performance-tester:
    build:
      context: .
      dockerfile: analyzer/services/performance-tester/Dockerfile
    ports:
      - "2003:2003"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2003
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./results:/app/reports
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - thesis-network
      - thesis-apps-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'

  # AI-Powered Analyzer
  ai-analyzer:
    build:
      context: .
      dockerfile: analyzer/services/ai-analyzer/Dockerfile
    ports:
      - "2004:2004"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2004
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    volumes:
      - ./generated/apps:/app/sources:ro
      - ./generated/apps:/app/sources:ro
      - ./results:/app/results
      - ./analyzer/services/ai-analyzer/main.py:/app/main.py
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'

  # ===== REPLICAS FOR CONCURRENCY =====

  static-analyzer-2:
    build:
      context: .
      dockerfile: analyzer/services/static-analyzer/Dockerfile
    ports:
      - "2051:2001"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2001
      - PYTHONPATH=/app
    volumes:
      - ./generated/apps:/app/sources:ro
      - ./results:/app/results
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  static-analyzer-3:
    build:
      context: .
      dockerfile: analyzer/services/static-analyzer/Dockerfile
    ports:
      - "2052:2001"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2001
      - PYTHONPATH=/app
    volumes:
      - ./generated/apps:/app/sources:ro
      - ./results:/app/results
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  dynamic-analyzer-2:
    build:
      context: .
      dockerfile: analyzer/services/dynamic-analyzer/Dockerfile
    ports:
      - "2053:2002"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2002
      - PYTHONPATH=/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./results:/app/results
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - thesis-network
      - thesis-apps-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  performance-tester-2:
    build:
      context: .
      dockerfile: analyzer/services/performance-tester/Dockerfile
    ports:
      - "2054:2003"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2003
      - PYTHONPATH=/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./results:/app/reports
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - thesis-network
      - thesis-apps-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'

  ai-analyzer-2:
    build:
      context: .
      dockerfile: analyzer/services/ai-analyzer/Dockerfile
    ports:
      - "2055:2004"
    environment:
      - LOG_LEVEL=INFO
      - WEBSOCKET_HOST=0.0.0.0
      - WEBSOCKET_PORT=2004
      - PYTHONPATH=/app
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    volumes:
      - ./generated/apps:/app/sources:ro
      - ./generated/apps:/app/sources:ro
      - ./results:/app/results
      - ./analyzer/services/ai-analyzer/main.py:/app/main.py
    healthcheck:
      test: [ "CMD", "python", "health_check.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - thesis-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'

networks:
  thesis-network:
    driver: bridge
  thesis-apps-network:
    external: true
    name: thesis-apps-network
