{% extends "layouts/dashboard_layout.html" %}

{% block title %}Applications Overview - Research Platform{% endblock %}

{% block page_title %}Applications Overview{% endblock %}
{% block page_subtitle %}All AI-generated applications across models{% endblock %}

{% block page_actions %}
<button class="btn btn-success" onclick="startAllApps()">
    <i class="fas fa-play"></i> Start All
</button>
<button class="btn btn-secondary" onclick="AppManager.refreshData()">
    <i class="fas fa-sync-alt"></i> Refresh
</button>
{% endblock %}

{% block dashboard_content %}
<!-- Application Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-icon"><i class="fas fa-cube"></i></div>
            <div class="stats-card-value">{{ total_apps|default(0) }}</div>
            <div class="stats-card-label">Total Apps</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-icon text-success"><i class="fas fa-play-circle"></i></div>
            <div class="stats-card-value text-success">{{ running_apps|default(0) }}</div>
            <div class="stats-card-label">Running</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-icon text-warning"><i class="fas fa-pause-circle"></i></div>
            <div class="stats-card-value text-warning">{{ stopped_apps|default(0) }}</div>
            <div class="stats-card-label">Stopped</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-icon text-danger"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stats-card-value text-danger">{{ error_apps|default(0) }}</div>
            <div class="stats-card-label">Errors</div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <input type="search" id="apps-search" class="form-control" placeholder="Search applications...">
            </div>
            <div class="col-md-2">
                <select id="model-filter" class="form-select">
                    <option value="">All Models</option>
                    {% for model in models %}
                        <option value="{{ model.slug }}">{{ model.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select id="status-filter" class="form-select">
                    <option value="">All Status</option>
                    <option value="running">Running</option>
                    <option value="stopped">Stopped</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="sort-by" class="form-select">
                    <option value="app_number">App Number</option>
                    <option value="model">Model</option>
                    <option value="status">Status</option>
                    <option value="last_activity">Last Activity</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-secondary" onclick="toggleView('grid')">
                        <i class="fas fa-th"></i> Grid
                    </button>
                    <button class="btn btn-outline-secondary active" onclick="toggleView('table')">
                        <i class="fas fa-list"></i> Table
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Applications Content -->
<div class="card">
    <div class="card-body">
        <!-- Table View -->
        <div id="table-view" class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="8%">App #</th>
                        <th width="20%">Model</th>
                        <th width="15%">Name</th>
                        <th width="12%">Status</th>
                        <th width="15%">Containers</th>
                        <th width="10%">Ports</th>
                        <th width="10%">Analysis</th>
                        <th width="10%">Actions</th>
                    </tr>
                </thead>
                <tbody id="apps-table-body" 
                       hx-get="/api/apps"
                       hx-trigger="load"
                       hx-swap="innerHTML">
                    <tr>
                        <td colspan="8" class="text-center p-4">
                            <div class="loading-spinner"></div>
                            <p class="text-muted mt-2">Loading applications...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Grid View (initially hidden) -->
        <div id="grid-view" style="display: none;">
            <div id="apps-grid" class="row">
                <!-- Grid content loaded by HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-4">
    <div class="pagination-info">
        <span class="text-muted">Showing <span id="showing-start">1</span>-<span id="showing-end">50</span> of <span id="total-count">{{ total_apps|default(0) }}</span> applications</span>
    </div>
    <nav aria-label="Applications pagination">
        <ul class="pagination pagination-sm mb-0" id="pagination-controls">
            <!-- Pagination buttons populated by JavaScript -->
        </ul>
    </nav>
</div>
{% endblock %}

{% block extra_js %}
<script>
class AppsOverview {
    constructor() {
        this.currentView = 'table';
        this.currentPage = 1;
        this.itemsPerPage = 50;
        this.totalItems = 0;
        this.filters = {
            search: '',
            model: '',
            status: '',
            sortBy: 'app_number'
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupKeyboardShortcuts();
        this.loadApps();
    }

    setupEventListeners() {
        document.getElementById('apps-search')?.addEventListener('input', () => {
            this.debounce(() => this.applyFilters(), 300)();
        });
        
        document.getElementById('model-filter')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('status-filter')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('sort-by')?.addEventListener('change', () => this.applyFilters());
    }

    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'f':
                        e.preventDefault();
                        document.getElementById('apps-search')?.focus();
                        break;
                    case 'g':
                        e.preventDefault();
                        this.toggleView('grid');
                        break;
                    case 't':
                        e.preventDefault();
                        this.toggleView('table');
                        break;
                }
            }
        });
    }

    async loadApps() {
        try {
            const params = new URLSearchParams({
                page: this.currentPage,
                limit: this.itemsPerPage,
                ...this.filters
            });

            const response = await fetch(`/api/apps?${params}`);
            const data = await response.json();

            if (data.success) {
                this.totalItems = data.total;
                this.renderApps(data.apps);
                this.updatePagination();
            } else {
                this.showError('Failed to load applications');
            }
        } catch (error) {
            console.error('Error loading apps:', error);
            this.showError('Error loading applications');
        }
    }

    renderApps(apps) {
        if (this.currentView === 'table') {
            this.renderTableView(apps);
        } else {
            this.renderGridView(apps);
        }
    }

    renderTableView(apps) {
        const tbody = document.getElementById('apps-table-body');
        
        if (apps.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center p-4">
                        <i class="fas fa-cube fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Applications Found</h5>
                        <p class="text-muted">No applications match your current filters.</p>
                    </td>
                </tr>
            `;
            return;
        }

        const rowsHtml = apps.map(app => this.createAppRow(app)).join('');
        tbody.innerHTML = rowsHtml;
    }

    renderGridView(apps) {
        const grid = document.getElementById('apps-grid');
        
        if (apps.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center p-4">
                    <i class="fas fa-cube fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Applications Found</h5>
                    <p class="text-muted">No applications match your current filters.</p>
                </div>
            `;
            return;
        }

        const cardsHtml = apps.map(app => this.createAppCard(app)).join('');
        grid.innerHTML = cardsHtml;
    }

    createAppRow(app) {
        const statusClass = app.status === 'running' ? 'success' : 
                           app.status === 'stopped' ? 'warning' : 'danger';

        return `
            <tr class="app-row" data-app-id="${app.id}" data-model="${app.model_slug}" data-status="${app.status}">
                <td>
                    <span class="badge badge-outline-primary">${app.app_number}</span>
                </td>
                <td>
                    <div>
                        <strong>${app.model_name}</strong>
                        <br><small class="text-muted">${app.provider}</small>
                    </div>
                </td>
                <td>
                    <div class="app-name" title="${app.description || 'No description'}">
                        ${app.name || 'Unnamed App'}
                    </div>
                </td>
                <td>
                    <span class="badge badge-${statusClass}">
                        <i class="fas fa-circle me-1"></i>${app.status}
                    </span>
                </td>
                <td>
                    <div class="d-flex gap-1">
                        <span class="container-indicator ${app.frontend_status === 'running' ? 'running' : 'stopped'}" 
                              title="Frontend: ${app.frontend_status}">
                            <i class="fas fa-globe-americas"></i>
                        </span>
                        <span class="container-indicator ${app.backend_status === 'running' ? 'running' : 'stopped'}" 
                              title="Backend: ${app.backend_status}">
                            <i class="fas fa-cogs"></i>
                        </span>
                        ${app.database_status ? `
                            <span class="container-indicator ${app.database_status === 'running' ? 'running' : 'stopped'}" 
                                  title="Database: ${app.database_status}">
                                <i class="fas fa-database"></i>
                            </span>
                        ` : ''}
                    </div>
                </td>
                <td>
                    <small>
                        ${app.frontend_port ? `<div>:${app.frontend_port}</div>` : ''}
                        ${app.backend_port ? `<div>:${app.backend_port}</div>` : ''}
                    </small>
                </td>
                <td>
                    ${app.analysis_summary ? `
                        <div class="d-flex gap-1">
                            <span class="badge badge-danger badge-sm">${app.analysis_summary.high || 0}</span>
                            <span class="badge badge-warning badge-sm">${app.analysis_summary.medium || 0}</span>
                            <span class="badge badge-info badge-sm">${app.analysis_summary.low || 0}</span>
                        </div>
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        ${this.createAppActions(app)}
                    </div>
                </td>
            </tr>
        `;
    }

    createAppCard(app) {
        const statusClass = app.status === 'running' ? 'success' : 
                           app.status === 'stopped' ? 'warning' : 'danger';

        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card app-card" data-app-id="${app.id}" data-model="${app.model_slug}" data-status="${app.status}">
                    <div class="card-header d-flex justify-content-between">
                        <span class="badge badge-outline-primary">App ${app.app_number}</span>
                        <span class="badge badge-${statusClass}">${app.status}</span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${app.name || 'Unnamed App'}</h6>
                        <p class="card-text text-muted small">${app.model_name}</p>
                        
                        <div class="container-status mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="container-indicator ${app.frontend_status === 'running' ? 'running' : 'stopped'}">
                                    <i class="fas fa-globe-americas"></i> Frontend
                                </span>
                                <span class="container-indicator ${app.backend_status === 'running' ? 'running' : 'stopped'}">
                                    <i class="fas fa-cogs"></i> Backend
                                </span>
                            </div>
                        </div>
                        
                        <div class="btn-group w-100">
                            ${this.createAppActions(app)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    createAppActions(app) {
        let actions = '';
        
        if (app.status === 'stopped') {
            actions += `<button class="btn btn-success btn-sm" onclick="startApp('${app.model_slug}', ${app.app_number})">
                <i class="fas fa-play"></i>
            </button>`;
        } else if (app.status === 'running') {
            actions += `<button class="btn btn-warning btn-sm" onclick="restartApp('${app.model_slug}', ${app.app_number})">
                <i class="fas fa-redo"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="stopApp('${app.model_slug}', ${app.app_number})">
                <i class="fas fa-stop"></i>
            </button>`;
        }
        
        if (app.status === 'running' && app.frontend_port) {
            actions += `<button class="btn btn-info btn-sm" onclick="openApp(${app.frontend_port})">
                <i class="fas fa-external-link-alt"></i>
            </button>`;
        }
        
        actions += `<button class="btn btn-secondary btn-sm" onclick="viewAppDetails('${app.model_slug}', ${app.app_number})">
            <i class="fas fa-info"></i>
        </button>`;
        
        return actions;
    }

    toggleView(view) {
        this.currentView = view;
        
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Show/hide views
        if (view === 'table') {
            document.getElementById('table-view').style.display = 'block';
            document.getElementById('grid-view').style.display = 'none';
        } else {
            document.getElementById('table-view').style.display = 'none';
            document.getElementById('grid-view').style.display = 'block';
        }
        
        // Re-render apps in new view
        this.loadApps();
    }

    applyFilters() {
        this.filters.search = document.getElementById('apps-search')?.value || '';
        this.filters.model = document.getElementById('model-filter')?.value || '';
        this.filters.status = document.getElementById('status-filter')?.value || '';
        this.filters.sortBy = document.getElementById('sort-by')?.value || 'app_number';
        
        this.currentPage = 1; // Reset to first page
        this.loadApps();
    }

    updatePagination() {
        const totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
        const start = (this.currentPage - 1) * this.itemsPerPage + 1;
        const end = Math.min(this.currentPage * this.itemsPerPage, this.totalItems);
        
        document.getElementById('showing-start').textContent = start;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-count').textContent = this.totalItems;
        
        this.renderPagination(totalPages);
    }

    renderPagination(totalPages) {
        const pagination = document.getElementById('pagination-controls');
        let html = '';
        
        // Previous button
        html += `<li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="appsOverview.goToPage(${this.currentPage - 1})">Previous</a>
        </li>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                html += `<li class="page-item ${i === this.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="appsOverview.goToPage(${i})">${i}</a>
                </li>`;
            } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        // Next button
        html += `<li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="appsOverview.goToPage(${this.currentPage + 1})">Next</a>
        </li>`;
        
        pagination.innerHTML = html;
    }

    goToPage(page) {
        if (page >= 1 && page <= Math.ceil(this.totalItems / this.itemsPerPage)) {
            this.currentPage = page;
            this.loadApps();
        }
    }

    showError(message) {
        const container = this.currentView === 'table' ? 
            document.getElementById('apps-table-body') : 
            document.getElementById('apps-grid');
            
        container.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">Error</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="appsOverview.loadApps()">
                    <i class="fas fa-retry"></i> Retry
                </button>
            </div>
        `;
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Global functions
window.toggleView = function(view) {
    appsOverview.toggleView(view);
};

window.startApp = function(modelSlug, appNumber) {
    appAction('start', modelSlug, appNumber);
};

window.stopApp = function(modelSlug, appNumber) {
    appAction('stop', modelSlug, appNumber);
};

window.restartApp = function(modelSlug, appNumber) {
    appAction('restart', modelSlug, appNumber);
};

window.openApp = function(port) {
    window.open(`http://localhost:${port}`, '_blank');
};

window.viewAppDetails = function(modelSlug, appNumber) {
    window.location.href = `/app/${encodeURIComponent(modelSlug)}/${appNumber}`;
};

window.startAllApps = function() {
    if (confirm('Start all applications? This may take several minutes.')) {
        fetch('/api/apps/start-all', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    AppManager.showToast('Started all applications', 'success');
                    setTimeout(() => appsOverview.loadApps(), 5000);
                } else {
                    throw new Error(data.error || 'Operation failed');
                }
            })
            .catch(error => {
                console.error('Error starting all apps:', error);
                AppManager.showToast(`Failed to start all apps: ${error.message}`, 'error');
            });
    }
};

function appAction(action, modelSlug, appNumber) {
    fetch(`/api/models/${encodeURIComponent(modelSlug)}/apps/${appNumber}/${action}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            AppManager.showToast(`App ${action} successful`, 'success');
            appsOverview.loadApps();
        } else {
            throw new Error(data.error || 'Operation failed');
        }
    })
    .catch(error => {
        console.error(`Error ${action}ing app:`, error);
        AppManager.showToast(`App ${action} failed: ${error.message}`, 'error');
    });
}

// Initialize
let appsOverview;
document.addEventListener('DOMContentLoaded', () => {
    appsOverview = new AppsOverview();
});
</script>

<style>
.container-indicator {
    font-size: 0.8rem;
    padding: 0.2rem;
    border-radius: 3px;
}

.container-indicator.running {
    color: var(--success);
    background-color: var(--success-light);
}

.container-indicator.stopped {
    color: var(--text-muted);
    background-color: var(--gray-100);
}

.app-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.app-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.pagination .page-link {
    border: none;
    color: var(--primary-600);
}

.pagination .page-item.active .page-link {
    background-color: var(--primary-600);
    border-color: var(--primary-600);
}
</style>
{% endblock %}